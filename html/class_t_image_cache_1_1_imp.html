<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>opentoonz: TImageCache::Imp Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">opentoonz
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="class_t_image_cache.html">TImageCache</a></li><li class="navelem"><a class="el" href="class_t_image_cache_1_1_imp.html">Imp</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="class_t_image_cache_1_1_imp-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">TImageCache::Imp Class Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ac2e7f24487c3fabee451ac72c0ffb157"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#ac2e7f24487c3fabee451ac72c0ffb157">notEnoughMemory</a> ()</td></tr>
<tr class="separator:ac2e7f24487c3fabee451ac72c0ffb157"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a971de7a8f3f8211a8c092a61270b584c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a971de7a8f3f8211a8c092a61270b584c">doCompress</a> ()</td></tr>
<tr class="separator:a971de7a8f3f8211a8c092a61270b584c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af0dff4fe661dba446d9b9dcc21ef90c5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#af0dff4fe661dba446d9b9dcc21ef90c5">doCompress</a> (std::string id)</td></tr>
<tr class="separator:af0dff4fe661dba446d9b9dcc21ef90c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e29c56b6f2a4bc1bf42d505c315be6a"><td class="memItemLeft" align="right" valign="top">UCHAR *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a2e29c56b6f2a4bc1bf42d505c315be6a">compressAndMalloc</a> (TUINT32 requestedSize)</td></tr>
<tr class="separator:a2e29c56b6f2a4bc1bf42d505c315be6a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09735a976f21638d124236b548a11a7e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a09735a976f21638d124236b548a11a7e">outputMap</a> (UINT chunkRequested, std::string filename)</td></tr>
<tr class="separator:a09735a976f21638d124236b548a11a7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2751841b45fca7b4fdb512965d7570bd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a2751841b45fca7b4fdb512965d7570bd">remove</a> (const std::string &amp;id)</td></tr>
<tr class="separator:a2751841b45fca7b4fdb512965d7570bd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7409dc4b3c1f7f143716f654609de8c6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a7409dc4b3c1f7f143716f654609de8c6">remap</a> (const std::string &amp;dstId, const std::string &amp;srcId)</td></tr>
<tr class="separator:a7409dc4b3c1f7f143716f654609de8c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a520d0a1180043af2e8f7bdb9b2946780"><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_t_smart_pointer_t.html">TImageP</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a520d0a1180043af2e8f7bdb9b2946780">get</a> (const std::string &amp;id, bool toBeModified)</td></tr>
<tr class="separator:a520d0a1180043af2e8f7bdb9b2946780"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa527dc2eb7da57579110efa7f9aadc2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#afa527dc2eb7da57579110efa7f9aadc2">add</a> (const std::string &amp;id, const <a class="el" href="class_t_smart_pointer_t.html">TImageP</a> &amp;img, bool overwrite)</td></tr>
<tr class="separator:afa527dc2eb7da57579110efa7f9aadc2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-attribs" name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:aa4b3bcb0ddede7224b899757fc5bc164"><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_t_file_path.html">TFilePath</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#aa4b3bcb0ddede7224b899757fc5bc164">m_rootDir</a></td></tr>
<tr class="separator:aa4b3bcb0ddede7224b899757fc5bc164"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7246fac918c6fc87078b8c4e451e0ac6"><td class="memItemLeft" align="right" valign="top">QThreadStorage&lt; bool * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a7246fac918c6fc87078b8c4e451e0ac6">m_isEnabled</a></td></tr>
<tr class="separator:a7246fac918c6fc87078b8c4e451e0ac6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7560e31deb10434dfae0c7d929727db5"><td class="memItemLeft" align="right" valign="top">std::map&lt; std::string, <a class="el" href="class_t_smart_pointer_t.html">CacheItemP</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a7560e31deb10434dfae0c7d929727db5">m_uncompressedItems</a></td></tr>
<tr class="separator:a7560e31deb10434dfae0c7d929727db5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa0b50ab48536920dd150c53557fd344f"><td class="memItemLeft" align="right" valign="top">std::map&lt; TUINT32, std::string &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#aa0b50ab48536920dd150c53557fd344f">m_itemHistory</a></td></tr>
<tr class="separator:aa0b50ab48536920dd150c53557fd344f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adcbf5b5cd4f6a95aeea8511c831a41e4"><td class="memItemLeft" align="right" valign="top">std::map&lt; std::string, <a class="el" href="class_t_smart_pointer_t.html">CacheItemP</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#adcbf5b5cd4f6a95aeea8511c831a41e4">m_compressedItems</a></td></tr>
<tr class="separator:adcbf5b5cd4f6a95aeea8511c831a41e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3ff9cb73078ade9741c3fa00e33609d8"><td class="memItemLeft" align="right" valign="top">std::map&lt; void *, std::string &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a3ff9cb73078ade9741c3fa00e33609d8">m_itemsByImagePointer</a></td></tr>
<tr class="separator:a3ff9cb73078ade9741c3fa00e33609d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4d1c713f1a74fb81d225473f3398ca94"><td class="memItemLeft" align="right" valign="top">std::map&lt; std::string, std::string &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a4d1c713f1a74fb81d225473f3398ca94">m_duplicatedItems</a></td></tr>
<tr class="separator:a4d1c713f1a74fb81d225473f3398ca94"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5115a2ad58307fa8ea5402bf89d9988a"><td class="memItemLeft" align="right" valign="top">TINT64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a5115a2ad58307fa8ea5402bf89d9988a">m_reservedMemory</a></td></tr>
<tr class="separator:a5115a2ad58307fa8ea5402bf89d9988a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa648b74327aa7241496e9a2a2ea2f6a5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_t_thread_1_1_mutex.html">TThread::Mutex</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#aa648b74327aa7241496e9a2a2ea2f6a5">m_mutex</a></td></tr>
<tr class="separator:aa648b74327aa7241496e9a2a2ea2f6a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-static-attribs" name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr class="memitem:a8a10d42f12f41afa489395e7b9597ff9"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_t_image_cache_1_1_imp.html#a8a10d42f12f41afa489395e7b9597ff9">m_fileid</a></td></tr>
<tr class="separator:a8a10d42f12f41afa489395e7b9597ff9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"></div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a846d5b539c36641977e16cf0d7cf14d3" name="a846d5b539c36641977e16cf0d7cf14d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a846d5b539c36641977e16cf0d7cf14d3">&#9670;&nbsp;</a></span>Imp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TImageCache::Imp::Imp </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  687</span>        : m_rootDir() {</div>
<div class="line"><span class="lineno">  688</span>    <span class="comment">// ATTENZIONE: e&#39; molto piu&#39; veloce se si usa memoria fisica</span></div>
<div class="line"><span class="lineno">  689</span>    <span class="comment">// invece che virtuale: la virtuale e&#39; tanta, non c&#39;e&#39; quindi bisogno</span></div>
<div class="line"><span class="lineno">  690</span>    <span class="comment">// di comprimere le immagini, che grandi come sono vengono swappate su disco</span></div>
<div class="line"><span class="lineno">  691</span>    <span class="keywordflow">if</span> (TBigMemoryManager::instance()-&gt;isActive()) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  692</span> </div>
<div class="line"><span class="lineno">  693</span>    m_reservedMemory = (TINT64)(TSystem::getMemorySize(<span class="keyword">true</span>) * 0.10);</div>
<div class="line"><span class="lineno">  694</span>    <span class="keywordflow">if</span> (m_reservedMemory &lt; 64 * 1024) m_reservedMemory = 64 * 1024;</div>
<div class="line"><span class="lineno">  695</span>  }</div>
</div><!-- fragment -->
</div>
</div>
<a id="af8dff661a606a628cd69dd27af064abe" name="af8dff661a606a628cd69dd27af064abe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af8dff661a606a628cd69dd27af064abe">&#9670;&nbsp;</a></span>~Imp()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">TImageCache::Imp::~Imp </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  697</span>         {</div>
<div class="line"><span class="lineno">  698</span>    <span class="keywordflow">if</span> (m_rootDir != <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>()) TSystem::rmDirTree(m_rootDir);</div>
<div class="line"><span class="lineno">  699</span>  }</div>
<div class="ttc" id="aclass_t_file_path_html"><div class="ttname"><a href="class_t_file_path.html">TFilePath</a></div><div class="ttdef"><b>Definition:</b> tfilepath.h:134</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="afa527dc2eb7da57579110efa7f9aadc2" name="afa527dc2eb7da57579110efa7f9aadc2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa527dc2eb7da57579110efa7f9aadc2">&#9670;&nbsp;</a></span>add()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TImageCache::Imp::add </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_smart_pointer_t.html">TImageP</a> &amp;&#160;</td>
          <td class="paramname"><em>img</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>overwrite</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1162</span>                                           {</div>
<div class="line"><span class="lineno"> 1163</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno"> 1164</span> </div>
<div class="line"><span class="lineno"> 1165</span><span class="preprocessor">#ifdef LEVO</span></div>
<div class="line"><span class="lineno"> 1166</span>  std::map&lt;std::string, CacheItemP&gt;::iterator it1 = m_uncompressedItems.begin();</div>
<div class="line"><span class="lineno"> 1167</span> </div>
<div class="line"><span class="lineno"> 1168</span>  <span class="keywordflow">for</span> (; it1 != m_uncompressedItems.end(); ++it1) {</div>
<div class="line"><span class="lineno"> 1169</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a> item =</div>
<div class="line"><span class="lineno"> 1170</span>        (<a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a>)it1-&gt;second;</div>
<div class="line"><span class="lineno"> 1171</span>    <span class="comment">// m_memUsage -= item-&gt;getSize();</span></div>
<div class="line"><span class="lineno"> 1172</span>    assert(item);</div>
<div class="line"><span class="lineno"> 1173</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">TImageP</a> refImg = item-&gt;getImage();</div>
<div class="line"><span class="lineno"> 1174</span>    <span class="keywordflow">if</span> (refImg.getPointer() == img.getPointer() &amp;&amp; it1-&gt;first != id)</div>
<div class="line"><span class="lineno"> 1175</span>      assert(!<span class="stringliteral">&quot;opps gia&#39; esiste in cache!&quot;</span>);</div>
<div class="line"><span class="lineno"> 1176</span>  }</div>
<div class="line"><span class="lineno"> 1177</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1178</span> </div>
<div class="line"><span class="lineno"> 1179</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itUncompr =</div>
<div class="line"><span class="lineno"> 1180</span>      m_uncompressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1181</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itCompr =</div>
<div class="line"><span class="lineno"> 1182</span>      m_compressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1183</span> </div>
<div class="line"><span class="lineno"> 1184</span><span class="preprocessor">#ifdef _DEBUGTOONZ</span></div>
<div class="line"><span class="lineno"> 1185</span>  <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg = (<a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>)img;</div>
<div class="line"><span class="lineno"> 1186</span>  <a class="code hl_class" href="class_t_toonz_image_p.html">TToonzImageP</a> timg  = (<a class="code hl_class" href="class_t_toonz_image_p.html">TToonzImageP</a>)img;</div>
<div class="line"><span class="lineno"> 1187</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1188</span> </div>
<div class="line"><span class="lineno"> 1189</span>  <span class="keywordflow">if</span> (itUncompr != m_uncompressedItems.end() ||</div>
<div class="line"><span class="lineno"> 1190</span>      itCompr !=</div>
<div class="line"><span class="lineno"> 1191</span>          m_compressedItems.end())  <span class="comment">// already present in cache with same id...</span></div>
<div class="line"><span class="lineno"> 1192</span>  {</div>
<div class="line"><span class="lineno"> 1193</span>    <span class="keywordflow">if</span> (overwrite) {</div>
<div class="line"><span class="lineno"> 1194</span><span class="preprocessor">#ifdef _DEBUGTOONZ</span></div>
<div class="line"><span class="lineno"> 1195</span>      <span class="keywordflow">if</span> (rimg)</div>
<div class="line"><span class="lineno"> 1196</span>        rimg-&gt;getRaster()-&gt;m_cashed = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1197</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (timg)</div>
<div class="line"><span class="lineno"> 1198</span>        timg-&gt;getRaster()-&gt;m_cashed = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1199</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1200</span>      std::map&lt;std::string, CacheItemP&gt;::iterator it;</div>
<div class="line"><span class="lineno"> 1201</span> </div>
<div class="line"><span class="lineno"> 1202</span>      <span class="keywordflow">if</span> (itUncompr != m_uncompressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1203</span>        assert(m_itemHistory.find(itUncompr-&gt;second-&gt;m_historyCount) !=</div>
<div class="line"><span class="lineno"> 1204</span>               m_itemHistory.end());</div>
<div class="line"><span class="lineno"> 1205</span>        m_itemHistory.erase(itUncompr-&gt;second-&gt;m_historyCount);</div>
<div class="line"><span class="lineno"> 1206</span>        m_itemsByImagePointer.erase(getPointer(itUncompr-&gt;second-&gt;getImage()));</div>
<div class="line"><span class="lineno"> 1207</span>        m_uncompressedItems.erase(itUncompr);</div>
<div class="line"><span class="lineno"> 1208</span>      }</div>
<div class="line"><span class="lineno"> 1209</span>      <span class="keywordflow">if</span> (itCompr != m_compressedItems.end()) m_compressedItems.erase(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1210</span>    } <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1211</span>      <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1212</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1213</span>    std::map&lt;std::string, std::string&gt;::iterator dt =</div>
<div class="line"><span class="lineno"> 1214</span>        m_duplicatedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1215</span>    <span class="keywordflow">if</span> ((dt != m_duplicatedItems.end()) &amp;&amp; !overwrite) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1216</span> </div>
<div class="line"><span class="lineno"> 1217</span>    std::map&lt;void *, std::string&gt;::iterator it;</div>
<div class="line"><span class="lineno"> 1218</span>    <span class="keywordflow">if</span> ((it = m_itemsByImagePointer.find(getPointer(img))) !=</div>
<div class="line"><span class="lineno"> 1219</span>        m_itemsByImagePointer</div>
<div class="line"><span class="lineno"> 1220</span>            .end())  <span class="comment">// already present in cache with another id...</span></div>
<div class="line"><span class="lineno"> 1221</span>    {</div>
<div class="line"><span class="lineno"> 1222</span>      m_duplicatedItems[id] = it-&gt;second;</div>
<div class="line"><span class="lineno"> 1223</span>      <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1224</span>    }</div>
<div class="line"><span class="lineno"> 1225</span> </div>
<div class="line"><span class="lineno"> 1226</span>    <span class="keywordflow">if</span> (dt != m_duplicatedItems.end()) m_duplicatedItems.erase(dt);</div>
<div class="line"><span class="lineno"> 1227</span>  }</div>
<div class="line"><span class="lineno"> 1228</span> </div>
<div class="line"><span class="lineno"> 1229</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> item;</div>
<div class="line"><span class="lineno"> 1230</span> </div>
<div class="line"><span class="lineno"> 1231</span><span class="preprocessor">#ifdef _DEBUGTOONZ</span></div>
<div class="line"><span class="lineno"> 1232</span>  <span class="keywordflow">if</span> (rimg)</div>
<div class="line"><span class="lineno"> 1233</span>    rimg-&gt;getRaster()-&gt;m_cashed = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1234</span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (timg)</div>
<div class="line"><span class="lineno"> 1235</span>    timg-&gt;getRaster()-&gt;m_cashed = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1236</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1237</span> </div>
<div class="line"><span class="lineno"> 1238</span>  item = <span class="keyword">new</span> <a class="code hl_class" href="class_uncompressed_on_memory_cache_item.html">UncompressedOnMemoryCacheItem</a>(img);</div>
<div class="line"><span class="lineno"> 1239</span><span class="preprocessor">#ifdef TNZCORE_LIGHT</span></div>
<div class="line"><span class="lineno"> 1240</span>  item-&gt;m_cantCompress = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1241</span><span class="preprocessor">#else</span></div>
<div class="line"><span class="lineno"> 1242</span>  item-&gt;m_cantCompress = (<a class="code hl_class" href="class_t_vector_image_p.html">TVectorImageP</a>(img) ? true : <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno"> 1243</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1244</span>  item-&gt;m_id                             = id;</div>
<div class="line"><span class="lineno"> 1245</span>  m_uncompressedItems[id]                = item;</div>
<div class="line"><span class="lineno"> 1246</span>  m_itemsByImagePointer[getPointer(img)] = id;</div>
<div class="line"><span class="lineno"> 1247</span>  item-&gt;m_historyCount                   = HistoryCount;</div>
<div class="line"><span class="lineno"> 1248</span>  m_itemHistory[HistoryCount]            = id;</div>
<div class="line"><span class="lineno"> 1249</span>  HistoryCount++;</div>
<div class="line"><span class="lineno"> 1250</span> </div>
<div class="line"><span class="lineno"> 1251</span>  <a class="code hl_function" href="class_t_image_cache_1_1_imp.html#a971de7a8f3f8211a8c092a61270b584c">doCompress</a>();</div>
<div class="line"><span class="lineno"> 1252</span> </div>
<div class="line"><span class="lineno"> 1253</span><span class="preprocessor">#ifdef _DEBUGTOONZ</span></div>
<div class="line"><span class="lineno"> 1254</span><span class="comment">// int itemCount =</span></div>
<div class="line"><span class="lineno"> 1255</span><span class="comment">// m_imp-&gt;m_uncompressedItems.size()+m_imp-&gt;m_compressedItems.size();</span></div>
<div class="line"><span class="lineno"> 1256</span><span class="comment">// m_imp-&gt;outputDebug();</span></div>
<div class="line"><span class="lineno"> 1257</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1258</span>}</div>
<div class="ttc" id="aclass_t_derived_smart_pointer_t_html"><div class="ttname"><a href="class_t_derived_smart_pointer_t.html">TDerivedSmartPointerT</a></div><div class="ttdef"><b>Definition:</b> tsmartpointer.h:170</div></div>
<div class="ttc" id="aclass_t_image_cache_1_1_imp_html_a971de7a8f3f8211a8c092a61270b584c"><div class="ttname"><a href="class_t_image_cache_1_1_imp.html#a971de7a8f3f8211a8c092a61270b584c">TImageCache::Imp::doCompress</a></div><div class="ttdeci">void doCompress()</div><div class="ttdef"><b>Definition:</b> timagecache.cpp:784</div></div>
<div class="ttc" id="aclass_t_raster_image_p_html"><div class="ttname"><a href="class_t_raster_image_p.html">TRasterImageP</a></div><div class="ttdef"><b>Definition:</b> trasterimage.h:148</div></div>
<div class="ttc" id="aclass_t_smart_pointer_t_html"><div class="ttname"><a href="class_t_smart_pointer_t.html">TSmartPointerT&lt; TImage &gt;</a></div></div>
<div class="ttc" id="aclass_t_toonz_image_p_html"><div class="ttname"><a href="class_t_toonz_image_p.html">TToonzImageP</a></div><div class="ttdef"><b>Definition:</b> ttoonzimage.h:126</div></div>
<div class="ttc" id="aclass_t_vector_image_p_html"><div class="ttname"><a href="class_t_vector_image_p.html">TVectorImageP</a></div><div class="ttdef"><b>Definition:</b> tvectorimage.h:417</div></div>
<div class="ttc" id="aclass_uncompressed_on_memory_cache_item_html"><div class="ttname"><a href="class_uncompressed_on_memory_cache_item.html">UncompressedOnMemoryCacheItem</a></div><div class="ttdef"><b>Definition:</b> timagecache.cpp:308</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2e29c56b6f2a4bc1bf42d505c315be6a" name="a2e29c56b6f2a4bc1bf42d505c315be6a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e29c56b6f2a4bc1bf42d505c315be6a">&#9670;&nbsp;</a></span>compressAndMalloc()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">UCHAR * TImageCache::Imp::compressAndMalloc </td>
          <td>(</td>
          <td class="paramtype">TUINT32&#160;</td>
          <td class="paramname"><em>requestedSize</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  968</span>                                                     {</div>
<div class="line"><span class="lineno">  969</span>  UCHAR *buf = 0;</div>
<div class="line"><span class="lineno">  970</span> </div>
<div class="line"><span class="lineno">  971</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno">  972</span> </div>
<div class="line"><span class="lineno">  973</span>  TheCodec::instance()-&gt;reset();</div>
<div class="line"><span class="lineno">  974</span> </div>
<div class="line"><span class="lineno">  975</span>  <span class="comment">// if (size!=0)</span></div>
<div class="line"><span class="lineno">  976</span>  <span class="comment">//  size = size&gt;&gt;10;</span></div>
<div class="line"><span class="lineno">  977</span> </div>
<div class="line"><span class="lineno">  978</span>  <span class="comment">// assert(size==0 || TBigMemoryManager::instance()-&gt;isActive());</span></div>
<div class="line"><span class="lineno">  979</span> </div>
<div class="line"><span class="lineno">  980</span>  std::map&lt;TUINT32, std::string&gt;::iterator itu = m_itemHistory.begin();</div>
<div class="line"><span class="lineno">  981</span>  <span class="keywordflow">while</span> (</div>
<div class="line"><span class="lineno">  982</span>      (buf = TBigMemoryManager::instance()-&gt;getBuffer(size)) == 0 &amp;&amp;</div>
<div class="line"><span class="lineno">  983</span>      itu !=</div>
<div class="line"><span class="lineno">  984</span>          m_itemHistory</div>
<div class="line"><span class="lineno">  985</span>              .end())  <span class="comment">//&gt;TBigMemoryManager::instance()-&gt;getAvailableMemoryinKb()))</span></div>
<div class="line"><span class="lineno">  986</span>  {</div>
<div class="line"><span class="lineno">  987</span>    std::map&lt;std::string, CacheItemP&gt;::iterator it =</div>
<div class="line"><span class="lineno">  988</span>        m_uncompressedItems.find(itu-&gt;second);</div>
<div class="line"><span class="lineno">  989</span>    assert(it != m_uncompressedItems.end());</div>
<div class="line"><span class="lineno">  990</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> item = it-&gt;second;</div>
<div class="line"><span class="lineno">  991</span> </div>
<div class="line"><span class="lineno">  992</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a> uitem = item;</div>
<div class="line"><span class="lineno">  993</span>    <span class="keywordflow">if</span> (item-&gt;m_cantCompress ||</div>
<div class="line"><span class="lineno">  994</span>        (uitem &amp;&amp; (!uitem-&gt;m_image || hasExternalReferences(uitem-&gt;m_image)))) {</div>
<div class="line"><span class="lineno">  995</span>      ++itu;</div>
<div class="line"><span class="lineno">  996</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  997</span>    }</div>
<div class="line"><span class="lineno">  998</span> </div>
<div class="line"><span class="lineno">  999</span>    <span class="keywordflow">if</span> (m_compressedItems.find(it-&gt;first) == m_compressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1000</span>      assert(uitem);</div>
<div class="line"><span class="lineno"> 1001</span>      <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> newItem;</div>
<div class="line"><span class="lineno"> 1002</span>      <span class="comment">// newItem = new CompressedOnMemoryCacheItem(item-&gt;getImage());</span></div>
<div class="line"><span class="lineno"> 1003</span>      <span class="comment">// if (newItem-&gt;getSize()==0)</span></div>
<div class="line"><span class="lineno"> 1004</span>      <span class="comment">//  {</span></div>
<div class="line"><span class="lineno"> 1005</span>      assert(m_rootDir != <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>());</div>
<div class="line"><span class="lineno"> 1006</span>      <a class="code hl_class" href="class_t_file_path.html">TFilePath</a> fp =</div>
<div class="line"><span class="lineno"> 1007</span>          m_rootDir + <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>(std::to_string(TImageCache::Imp::m_fileid++));</div>
<div class="line"><span class="lineno"> 1008</span>      newItem = <span class="keyword">new</span> <a class="code hl_class" href="class_uncompressed_on_disk_cache_item.html">UncompressedOnDiskCacheItem</a>(fp, item-&gt;getImage());</div>
<div class="line"><span class="lineno"> 1009</span>      <span class="comment">//  }</span></div>
<div class="line"><span class="lineno"> 1010</span> </div>
<div class="line"><span class="lineno"> 1011</span>      m_compressedItems[it-&gt;first] = newItem;</div>
<div class="line"><span class="lineno"> 1012</span>    }</div>
<div class="line"><span class="lineno"> 1013</span> </div>
<div class="line"><span class="lineno"> 1014</span><span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"><span class="lineno"> 1015</span>    assert(itu-&gt;first == it-&gt;second-&gt;m_historyCount);</div>
<div class="line"><span class="lineno"> 1016</span>    itu = m_itemHistory.erase(itu);</div>
<div class="line"><span class="lineno"> 1017</span>    m_itemsByImagePointer.erase(getPointer(item-&gt;getImage()));</div>
<div class="line"><span class="lineno"> 1018</span>    m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno"> 1019</span><span class="preprocessor">#else</span></div>
<div class="line"><span class="lineno"> 1020</span>    std::map&lt;TUINT32, std::string&gt;::iterator itu2 = itu;</div>
<div class="line"><span class="lineno"> 1021</span>    itu++;</div>
<div class="line"><span class="lineno"> 1022</span>    m_itemHistory.erase(itu2);</div>
<div class="line"><span class="lineno"> 1023</span>    m_itemsByImagePointer.erase(item-&gt;getImage().getPointer());</div>
<div class="line"><span class="lineno"> 1024</span>    m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno"> 1025</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1026</span>  }</div>
<div class="line"><span class="lineno"> 1027</span> </div>
<div class="line"><span class="lineno"> 1028</span>  <span class="keywordflow">if</span> (buf != 0) <span class="keywordflow">return</span> buf;</div>
<div class="line"><span class="lineno"> 1029</span> </div>
<div class="line"><span class="lineno"> 1030</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itc = m_compressedItems.begin();</div>
<div class="line"><span class="lineno"> 1031</span>  <span class="keywordflow">for</span> (; itc != m_compressedItems.end() &amp;&amp;</div>
<div class="line"><span class="lineno"> 1032</span>         (buf = TBigMemoryManager::instance()-&gt;getBuffer(size)) == 0;</div>
<div class="line"><span class="lineno"> 1033</span>       ++itc) {</div>
<div class="line"><span class="lineno"> 1034</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> item = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1035</span>    <span class="keywordflow">if</span> (item-&gt;m_cantCompress) <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno"> 1036</span> </div>
<div class="line"><span class="lineno"> 1037</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">CompressedOnMemoryCacheItemP</a> citem = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1038</span>    <span class="keywordflow">if</span> (citem) {</div>
<div class="line"><span class="lineno"> 1039</span>      assert(m_rootDir != <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>());</div>
<div class="line"><span class="lineno"> 1040</span>      <a class="code hl_class" href="class_t_file_path.html">TFilePath</a> fp =</div>
<div class="line"><span class="lineno"> 1041</span>          m_rootDir + <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>(std::to_string(TImageCache::Imp::m_fileid++));</div>
<div class="line"><span class="lineno"> 1042</span> </div>
<div class="line"><span class="lineno"> 1043</span>      <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> newItem = <span class="keyword">new</span> <a class="code hl_class" href="class_compressed_on_disk_cache_item.html">CompressedOnDiskCacheItem</a>(</div>
<div class="line"><span class="lineno"> 1044</span>          fp, citem-&gt;m_compressedRas, citem-&gt;m_builder-&gt;clone(),</div>
<div class="line"><span class="lineno"> 1045</span>          citem-&gt;m_imageInfo-&gt;clone());</div>
<div class="line"><span class="lineno"> 1046</span> </div>
<div class="line"><span class="lineno"> 1047</span>      itc-&gt;second                   = 0;</div>
<div class="line"><span class="lineno"> 1048</span>      m_compressedItems[itc-&gt;first] = newItem;</div>
<div class="line"><span class="lineno"> 1049</span>    }</div>
<div class="line"><span class="lineno"> 1050</span>  }</div>
<div class="line"><span class="lineno"> 1051</span> </div>
<div class="line"><span class="lineno"> 1052</span>  <span class="keywordflow">return</span> buf;</div>
<div class="line"><span class="lineno"> 1053</span>}</div>
<div class="ttc" id="aclass_compressed_on_disk_cache_item_html"><div class="ttname"><a href="class_compressed_on_disk_cache_item.html">CompressedOnDiskCacheItem</a></div><div class="ttdef"><b>Definition:</b> timagecache.cpp:469</div></div>
<div class="ttc" id="aclass_uncompressed_on_disk_cache_item_html"><div class="ttname"><a href="class_uncompressed_on_disk_cache_item.html">UncompressedOnDiskCacheItem</a></div><div class="ttdef"><b>Definition:</b> timagecache.cpp:533</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a971de7a8f3f8211a8c092a61270b584c" name="a971de7a8f3f8211a8c092a61270b584c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a971de7a8f3f8211a8c092a61270b584c">&#9670;&nbsp;</a></span>doCompress() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TImageCache::Imp::doCompress </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >non c'era memoria sufficiente per il buffer compresso....</p>
<div class="fragment"><div class="line"><span class="lineno">  784</span>                                {</div>
<div class="line"><span class="lineno">  785</span>  <span class="comment">// se la memoria usata per mantenere le immagini decompresse e&#39; superiore</span></div>
<div class="line"><span class="lineno">  786</span>  <span class="comment">// a un dato valore, comprimo alcune immagini non compresse non checked-out</span></div>
<div class="line"><span class="lineno">  787</span>  <span class="comment">// in modo da liberare memoria</span></div>
<div class="line"><span class="lineno">  788</span> </div>
<div class="line"><span class="lineno">  789</span>  <span class="comment">// per il momento scorre tutte le immagini alla ricerca di immagini</span></div>
<div class="line"><span class="lineno">  790</span>  <span class="comment">// non compresse non checked-out</span></div>
<div class="line"><span class="lineno">  791</span> </div>
<div class="line"><span class="lineno">  792</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno">  793</span> </div>
<div class="line"><span class="lineno">  794</span>  std::map&lt;TUINT32, std::string&gt;::iterator itu = m_itemHistory.begin();</div>
<div class="line"><span class="lineno">  795</span> </div>
<div class="line"><span class="lineno">  796</span>  <span class="keywordflow">for</span> (; itu != m_itemHistory.end() &amp;&amp; notEnoughMemory();) {</div>
<div class="line"><span class="lineno">  797</span>    std::map&lt;std::string, CacheItemP&gt;::iterator it =</div>
<div class="line"><span class="lineno">  798</span>        m_uncompressedItems.find(itu-&gt;second);</div>
<div class="line"><span class="lineno">  799</span>    assert(it != m_uncompressedItems.end());</div>
<div class="line"><span class="lineno">  800</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> item = it-&gt;second;</div>
<div class="line"><span class="lineno">  801</span> </div>
<div class="line"><span class="lineno">  802</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a> uitem = item;</div>
<div class="line"><span class="lineno">  803</span>    <span class="keywordflow">if</span> (item-&gt;m_cantCompress ||</div>
<div class="line"><span class="lineno">  804</span>        (uitem &amp;&amp; (!uitem-&gt;m_image || hasExternalReferences(uitem-&gt;m_image)))) {</div>
<div class="line"><span class="lineno">  805</span>      ++itu;</div>
<div class="line"><span class="lineno">  806</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  807</span>    }</div>
<div class="line"><span class="lineno">  808</span>    std::string <span class="keywordtype">id</span> = it-&gt;first;</div>
<div class="line"><span class="lineno">  809</span> </div>
<div class="line"><span class="lineno">  810</span><span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"><span class="lineno">  811</span>    assert(itu-&gt;first == it-&gt;second-&gt;m_historyCount);</div>
<div class="line"><span class="lineno">  812</span>    itu = m_itemHistory.erase(itu);</div>
<div class="line"><span class="lineno">  813</span>    m_itemsByImagePointer.erase(getPointer(item-&gt;getImage()));</div>
<div class="line"><span class="lineno">  814</span>    m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno">  815</span><span class="preprocessor">#else</span></div>
<div class="line"><span class="lineno">  816</span>    std::map&lt;TUINT32, std::string&gt;::iterator itu2 = itu;</div>
<div class="line"><span class="lineno">  817</span>    itu++;</div>
<div class="line"><span class="lineno">  818</span>    m_itemHistory.erase(itu2);</div>
<div class="line"><span class="lineno">  819</span>    m_itemsByImagePointer.erase(item-&gt;getImage().getPointer());</div>
<div class="line"><span class="lineno">  820</span>    m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno">  821</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  822</span> </div>
<div class="line"><span class="lineno">  823</span>    <span class="keywordflow">if</span> (m_compressedItems.find(<span class="keywordtype">id</span>) == m_compressedItems.end()) {</div>
<div class="line"><span class="lineno">  824</span>      assert(uitem);</div>
<div class="line"><span class="lineno">  825</span>      item-&gt;m_cantCompress = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  826</span>      <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> newItem   = <span class="keyword">new</span> <a class="code hl_class" href="class_compressed_on_memory_cache_item.html">CompressedOnMemoryCacheItem</a>(</div>
<div class="line"><span class="lineno">  827</span>          item-&gt;getImage());  <span class="comment">// WARNING the codec buffer allocation can CHANGE</span></div>
<div class="line"><span class="lineno">  828</span>                              <span class="comment">// the cache.</span></div>
<div class="line"><span class="lineno">  829</span>      item-&gt;m_cantCompress = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  830</span>      <span class="keywordflow">if</span> (newItem-&gt;getSize() ==</div>
<div class="line"><span class="lineno">  831</span>          0)  </div>
<div class="line"><span class="lineno">  832</span>      {</div>
<div class="line"><span class="lineno">  833</span>        assert(m_rootDir != <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>());</div>
<div class="line"><span class="lineno">  834</span>        <a class="code hl_class" href="class_t_file_path.html">TFilePath</a> fp =</div>
<div class="line"><span class="lineno">  835</span>            m_rootDir + <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>(std::to_string(TImageCache::Imp::m_fileid++));</div>
<div class="line"><span class="lineno">  836</span>        newItem = <span class="keyword">new</span> <a class="code hl_class" href="class_uncompressed_on_disk_cache_item.html">UncompressedOnDiskCacheItem</a>(fp, item-&gt;getImage());</div>
<div class="line"><span class="lineno">  837</span>      }</div>
<div class="line"><span class="lineno">  838</span>      m_compressedItems[id] = newItem;</div>
<div class="line"><span class="lineno">  839</span>      item                  = <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a>();</div>
<div class="line"><span class="lineno">  840</span>      uitem                 = <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a>();</div>
<div class="line"><span class="lineno">  841</span>      <span class="comment">// doCompress();//restart, since iterators could have been changed (see</span></div>
<div class="line"><span class="lineno">  842</span>      <span class="comment">// comment above)</span></div>
<div class="line"><span class="lineno">  843</span>      <span class="comment">// return;</span></div>
<div class="line"><span class="lineno">  844</span>      itu = m_itemHistory.begin();</div>
<div class="line"><span class="lineno">  845</span>    }</div>
<div class="line"><span class="lineno">  846</span>  }</div>
<div class="line"><span class="lineno">  847</span> </div>
<div class="line"><span class="lineno">  848</span>  <span class="comment">// se il quantitativo di memoria utilizzata e&#39; superiore a un dato valore,</span></div>
<div class="line"><span class="lineno">  849</span>  <span class="comment">// sposto</span></div>
<div class="line"><span class="lineno">  850</span>  <span class="comment">// su disco alcune immagini compresse in modo da liberare memoria</span></div>
<div class="line"><span class="lineno">  851</span> </div>
<div class="line"><span class="lineno">  852</span>  <span class="keywordflow">if</span> (itu != m_itemHistory.end())  <span class="comment">// memory is enough!</span></div>
<div class="line"><span class="lineno">  853</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  854</span> </div>
<div class="line"><span class="lineno">  855</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itc = m_compressedItems.begin();</div>
<div class="line"><span class="lineno">  856</span>  <span class="keywordflow">for</span> (; itc != m_compressedItems.end() &amp;&amp; notEnoughMemory(); ++itc) {</div>
<div class="line"><span class="lineno">  857</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> item = itc-&gt;second;</div>
<div class="line"><span class="lineno">  858</span>    <span class="keywordflow">if</span> (item-&gt;m_cantCompress) <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  859</span> </div>
<div class="line"><span class="lineno">  860</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">CompressedOnMemoryCacheItemP</a> citem = itc-&gt;second;</div>
<div class="line"><span class="lineno">  861</span>    <span class="keywordflow">if</span> (citem) {</div>
<div class="line"><span class="lineno">  862</span>      assert(m_rootDir != <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>());</div>
<div class="line"><span class="lineno">  863</span>      <a class="code hl_class" href="class_t_file_path.html">TFilePath</a> fp =</div>
<div class="line"><span class="lineno">  864</span>          m_rootDir + <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>(std::to_string(TImageCache::Imp::m_fileid++));</div>
<div class="line"><span class="lineno">  865</span> </div>
<div class="line"><span class="lineno">  866</span>      <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> newItem = <span class="keyword">new</span> <a class="code hl_class" href="class_compressed_on_disk_cache_item.html">CompressedOnDiskCacheItem</a>(</div>
<div class="line"><span class="lineno">  867</span>          fp, citem-&gt;m_compressedRas, citem-&gt;m_builder-&gt;clone(),</div>
<div class="line"><span class="lineno">  868</span>          citem-&gt;m_imageInfo-&gt;clone());</div>
<div class="line"><span class="lineno">  869</span> </div>
<div class="line"><span class="lineno">  870</span>      itc-&gt;second                   = 0;</div>
<div class="line"><span class="lineno">  871</span>      m_compressedItems[itc-&gt;first] = newItem;</div>
<div class="line"><span class="lineno">  872</span>    }</div>
<div class="line"><span class="lineno">  873</span>  }</div>
<div class="line"><span class="lineno">  874</span>}</div>
<div class="ttc" id="aclass_compressed_on_memory_cache_item_html"><div class="ttname"><a href="class_compressed_on_memory_cache_item.html">CompressedOnMemoryCacheItem</a></div><div class="ttdef"><b>Definition:</b> timagecache.cpp:371</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af0dff4fe661dba446d9b9dcc21ef90c5" name="af0dff4fe661dba446d9b9dcc21ef90c5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af0dff4fe661dba446d9b9dcc21ef90c5">&#9670;&nbsp;</a></span>doCompress() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TImageCache::Imp::doCompress </td>
          <td>(</td>
          <td class="paramtype">std::string&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >non c'era memoria sufficiente per il buffer compresso....</p>
<div class="fragment"><div class="line"><span class="lineno">  878</span>                                            {</div>
<div class="line"><span class="lineno">  879</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno">  880</span> </div>
<div class="line"><span class="lineno">  881</span>  <span class="comment">// search id in m_uncompressedItems</span></div>
<div class="line"><span class="lineno">  882</span>  std::map&lt;std::string, CacheItemP&gt;::iterator it = m_uncompressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno">  883</span>  <span class="keywordflow">if</span> (it == m_uncompressedItems.end()) <span class="keywordflow">return</span>;  <span class="comment">// id not found: return</span></div>
<div class="line"><span class="lineno">  884</span> </div>
<div class="line"><span class="lineno">  885</span>  <span class="comment">// is item suitable for compression ?</span></div>
<div class="line"><span class="lineno">  886</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> item                      = it-&gt;second;</div>
<div class="line"><span class="lineno">  887</span>  <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a> uitem = item;</div>
<div class="line"><span class="lineno">  888</span>  <span class="keywordflow">if</span> (item-&gt;m_cantCompress ||</div>
<div class="line"><span class="lineno">  889</span>      (uitem &amp;&amp; (!uitem-&gt;m_image || hasExternalReferences(uitem-&gt;m_image))))</div>
<div class="line"><span class="lineno">  890</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  891</span> </div>
<div class="line"><span class="lineno">  892</span>  <span class="comment">// search id in m_itemHistory</span></div>
<div class="line"><span class="lineno">  893</span>  std::map&lt;TUINT32, std::string&gt;::iterator itu = m_itemHistory.begin();</div>
<div class="line"><span class="lineno">  894</span>  <span class="keywordflow">while</span> (itu != m_itemHistory.end() &amp;&amp; itu-&gt;second != <span class="keywordtype">id</span>) ++itu;</div>
<div class="line"><span class="lineno">  895</span>  <span class="keywordflow">if</span> (itu == m_itemHistory.end()) <span class="keywordflow">return</span>;  <span class="comment">// id not found: return</span></div>
<div class="line"><span class="lineno">  896</span> </div>
<div class="line"><span class="lineno">  897</span><span class="comment">// delete itu from m_itemHistory</span></div>
<div class="line"><span class="lineno">  898</span><span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"><span class="lineno">  899</span>  assert(itu-&gt;first == it-&gt;second-&gt;m_historyCount);</div>
<div class="line"><span class="lineno">  900</span>  itu = m_itemHistory.erase(itu);</div>
<div class="line"><span class="lineno">  901</span>  m_itemsByImagePointer.erase(getPointer(item-&gt;getImage()));</div>
<div class="line"><span class="lineno">  902</span><span class="preprocessor">#else</span></div>
<div class="line"><span class="lineno">  903</span>  std::map&lt;TUINT32, std::string&gt;::iterator itu2 = itu;</div>
<div class="line"><span class="lineno">  904</span>  itu++;</div>
<div class="line"><span class="lineno">  905</span>  m_itemHistory.erase(itu2);</div>
<div class="line"><span class="lineno">  906</span>  m_itemsByImagePointer.erase(item-&gt;getImage().getPointer());</div>
<div class="line"><span class="lineno">  907</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  908</span> </div>
<div class="line"><span class="lineno">  909</span>  <span class="comment">// delete item from m_uncompressedItems</span></div>
<div class="line"><span class="lineno">  910</span>  m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno">  911</span> </div>
<div class="line"><span class="lineno">  912</span>  <span class="comment">// check if item has been already compressed. this should never happen</span></div>
<div class="line"><span class="lineno">  913</span>  <span class="keywordflow">if</span> (m_compressedItems.find(<span class="keywordtype">id</span>) != m_compressedItems.end()) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  914</span> </div>
<div class="line"><span class="lineno">  915</span>  assert(uitem);</div>
<div class="line"><span class="lineno">  916</span>  item-&gt;m_cantCompress = <span class="keyword">true</span>;  <span class="comment">// ??</span></div>
<div class="line"><span class="lineno">  917</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> newItem   = <span class="keyword">new</span> <a class="code hl_class" href="class_compressed_on_memory_cache_item.html">CompressedOnMemoryCacheItem</a>(</div>
<div class="line"><span class="lineno">  918</span>      item-&gt;getImage());  <span class="comment">// WARNING the codec buffer  allocation can CHANGE the</span></div>
<div class="line"><span class="lineno">  919</span>                          <span class="comment">// cache.</span></div>
<div class="line"><span class="lineno">  920</span>  item-&gt;m_cantCompress = <span class="keyword">false</span>;  <span class="comment">// ??</span></div>
<div class="line"><span class="lineno">  921</span>  <span class="keywordflow">if</span> (newItem-&gt;getSize() ==</div>
<div class="line"><span class="lineno">  922</span>      0)  </div>
<div class="line"><span class="lineno">  923</span>  {</div>
<div class="line"><span class="lineno">  924</span>    assert(m_rootDir != <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>());</div>
<div class="line"><span class="lineno">  925</span>    <a class="code hl_class" href="class_t_file_path.html">TFilePath</a> fp =</div>
<div class="line"><span class="lineno">  926</span>        m_rootDir + <a class="code hl_class" href="class_t_file_path.html">TFilePath</a>(std::to_string(TImageCache::Imp::m_fileid++));</div>
<div class="line"><span class="lineno">  927</span>    newItem = <span class="keyword">new</span> <a class="code hl_class" href="class_uncompressed_on_disk_cache_item.html">UncompressedOnDiskCacheItem</a>(fp, item-&gt;getImage());</div>
<div class="line"><span class="lineno">  928</span>  }</div>
<div class="line"><span class="lineno">  929</span>  m_compressedItems[id] = newItem;</div>
<div class="line"><span class="lineno">  930</span>  item                  = <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a>();</div>
<div class="line"><span class="lineno">  931</span>  uitem                 = <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a>();</div>
<div class="line"><span class="lineno">  932</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a520d0a1180043af2e8f7bdb9b2946780" name="a520d0a1180043af2e8f7bdb9b2946780"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a520d0a1180043af2e8f7bdb9b2946780">&#9670;&nbsp;</a></span>get()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_t_smart_pointer_t.html">TImageP</a> TImageCache::Imp::get </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>toBeModified</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1678</span>                                                                  {</div>
<div class="line"><span class="lineno"> 1679</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno"> 1680</span> </div>
<div class="line"><span class="lineno"> 1681</span>  std::map&lt;std::string, std::string&gt;::const_iterator it;</div>
<div class="line"><span class="lineno"> 1682</span>  <span class="keywordflow">if</span> ((it = m_duplicatedItems.find(<span class="keywordtype">id</span>)) != m_duplicatedItems.end()) {</div>
<div class="line"><span class="lineno"> 1683</span>    assert(m_duplicatedItems.find(it-&gt;second) == m_duplicatedItems.end());</div>
<div class="line"><span class="lineno"> 1684</span>    <span class="keywordflow">return</span> get(it-&gt;second, toBeModified);</div>
<div class="line"><span class="lineno"> 1685</span>  }</div>
<div class="line"><span class="lineno"> 1686</span> </div>
<div class="line"><span class="lineno"> 1687</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TImageP</a> img;</div>
<div class="line"><span class="lineno"> 1688</span> </div>
<div class="line"><span class="lineno"> 1689</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itu =</div>
<div class="line"><span class="lineno"> 1690</span>      m_uncompressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1691</span>  <span class="keywordflow">if</span> (itu != m_uncompressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1692</span>    img = itu-&gt;second-&gt;getImage();</div>
<div class="line"><span class="lineno"> 1693</span>    <span class="keywordflow">if</span> (itu-&gt;second-&gt;m_historyCount !=</div>
<div class="line"><span class="lineno"> 1694</span>        HistoryCount - 1)  <span class="comment">// significa che l&#39;ultimo get non era sulla stessa</span></div>
<div class="line"><span class="lineno"> 1695</span>                           <span class="comment">// immagine, quindi  serve aggiornare l&#39;history!</span></div>
<div class="line"><span class="lineno"> 1696</span>    {</div>
<div class="line"><span class="lineno"> 1697</span>      assert(m_itemHistory.find(itu-&gt;second-&gt;m_historyCount) !=</div>
<div class="line"><span class="lineno"> 1698</span>             m_itemHistory.end());</div>
<div class="line"><span class="lineno"> 1699</span>      m_itemHistory.erase(itu-&gt;second-&gt;m_historyCount);</div>
<div class="line"><span class="lineno"> 1700</span>      m_itemHistory[HistoryCount] = id;</div>
<div class="line"><span class="lineno"> 1701</span>      itu-&gt;second-&gt;m_historyCount = HistoryCount;</div>
<div class="line"><span class="lineno"> 1702</span>      HistoryCount++;</div>
<div class="line"><span class="lineno"> 1703</span>    }</div>
<div class="line"><span class="lineno"> 1704</span>    <span class="keywordflow">if</span> (toBeModified) {</div>
<div class="line"><span class="lineno"> 1705</span>      itu-&gt;second-&gt;m_modified = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1706</span>      std::map&lt;std::string, CacheItemP&gt;::iterator itc =</div>
<div class="line"><span class="lineno"> 1707</span>          m_compressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1708</span>      <span class="keywordflow">if</span> (itc != m_compressedItems.end()) m_compressedItems.erase(itc);</div>
<div class="line"><span class="lineno"> 1709</span>    }</div>
<div class="line"><span class="lineno"> 1710</span>    <span class="keywordflow">return</span> img;</div>
<div class="line"><span class="lineno"> 1711</span>  }</div>
<div class="line"><span class="lineno"> 1712</span> </div>
<div class="line"><span class="lineno"> 1713</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itc = m_compressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1714</span>  <span class="keywordflow">if</span> (itc == m_compressedItems.end()) <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno"> 1715</span> </div>
<div class="line"><span class="lineno"> 1716</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> cacheItem = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1717</span> </div>
<div class="line"><span class="lineno"> 1718</span>  img = cacheItem-&gt;getImage();</div>
<div class="line"><span class="lineno"> 1719</span> </div>
<div class="line"><span class="lineno"> 1720</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> uncompressed;</div>
<div class="line"><span class="lineno"> 1721</span>  uncompressed                    = <span class="keyword">new</span> <a class="code hl_class" href="class_uncompressed_on_memory_cache_item.html">UncompressedOnMemoryCacheItem</a>(img);</div>
<div class="line"><span class="lineno"> 1722</span>  m_uncompressedItems[itc-&gt;first] = uncompressed;</div>
<div class="line"><span class="lineno"> 1723</span>  m_itemsByImagePointer[getPointer(img)] = itc-&gt;first;</div>
<div class="line"><span class="lineno"> 1724</span> </div>
<div class="line"><span class="lineno"> 1725</span>  m_itemHistory[HistoryCount]  = itc-&gt;first;</div>
<div class="line"><span class="lineno"> 1726</span>  uncompressed-&gt;m_historyCount = HistoryCount;</div>
<div class="line"><span class="lineno"> 1727</span>  HistoryCount++;</div>
<div class="line"><span class="lineno"> 1728</span> </div>
<div class="line"><span class="lineno"> 1729</span>  <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_derived_smart_pointer_t.html">CompressedOnMemoryCacheItemP</a>(cacheItem))</div>
<div class="line"><span class="lineno"> 1730</span>  <span class="comment">// l&#39;immagine compressa non la tengo insieme alla</span></div>
<div class="line"><span class="lineno"> 1731</span>  <span class="comment">// uncompressa se e&#39; troppo grande</span></div>
<div class="line"><span class="lineno"> 1732</span>  {</div>
<div class="line"><span class="lineno"> 1733</span>    <span class="keywordflow">if</span> (10 * cacheItem-&gt;getSize() &gt; uncompressed-&gt;getSize()) {</div>
<div class="line"><span class="lineno"> 1734</span>      m_compressedItems.erase(itc);</div>
<div class="line"><span class="lineno"> 1735</span>      itc = m_compressedItems.end();</div>
<div class="line"><span class="lineno"> 1736</span>    }</div>
<div class="line"><span class="lineno"> 1737</span>  } <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1738</span>    assert((<a class="code hl_class" href="class_t_derived_smart_pointer_t.html">CompressedOnDiskCacheItemP</a>)cacheItem ||</div>
<div class="line"><span class="lineno"> 1739</span>           (<a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnDiskCacheItemP</a>)cacheItem);  <span class="comment">// deve essere compressa!</span></div>
<div class="line"><span class="lineno"> 1740</span> </div>
<div class="line"><span class="lineno"> 1741</span>  <span class="keywordflow">if</span> (toBeModified &amp;&amp; itc != m_compressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1742</span>    uncompressed-&gt;m_modified = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1743</span>    m_compressedItems.erase(itc);</div>
<div class="line"><span class="lineno"> 1744</span>  }</div>
<div class="line"><span class="lineno"> 1745</span> </div>
<div class="line"><span class="lineno"> 1746</span>  uncompressed-&gt;m_cantCompress = toBeModified;</div>
<div class="line"><span class="lineno"> 1747</span>  <span class="comment">// se la memoria utilizzata e&#39; superiore al massimo consentito, comprime</span></div>
<div class="line"><span class="lineno"> 1748</span>  <a class="code hl_function" href="class_t_image_cache_1_1_imp.html#a971de7a8f3f8211a8c092a61270b584c">doCompress</a>();</div>
<div class="line"><span class="lineno"> 1749</span> </div>
<div class="line"><span class="lineno"> 1750</span>  uncompressed-&gt;m_cantCompress = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1751</span> </div>
<div class="line"><span class="lineno"> 1752</span><span class="comment">//#define DO_MEMCHECK</span></div>
<div class="line"><span class="lineno"> 1753</span><span class="preprocessor">#ifdef DO_MEMCHECK</span></div>
<div class="line"><span class="lineno"> 1754</span>  assert(_CrtCheckMemory());</div>
<div class="line"><span class="lineno"> 1755</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1756</span> </div>
<div class="line"><span class="lineno"> 1757</span>  <span class="keywordflow">return</span> img;</div>
<div class="line"><span class="lineno"> 1758</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ac2e7f24487c3fabee451ac72c0ffb157" name="ac2e7f24487c3fabee451ac72c0ffb157"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac2e7f24487c3fabee451ac72c0ffb157">&#9670;&nbsp;</a></span>notEnoughMemory()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool TImageCache::Imp::notEnoughMemory </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  701</span>                                {</div>
<div class="line"><span class="lineno">  702</span>    <span class="keywordflow">if</span> (TBigMemoryManager::instance()-&gt;isActive())</div>
<div class="line"><span class="lineno">  703</span>      <span class="keywordflow">return</span> TBigMemoryManager::instance()-&gt;getAvailableMemoryinKb() &lt;</div>
<div class="line"><span class="lineno">  704</span>             50 * 1024;</div>
<div class="line"><span class="lineno">  705</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  706</span>      <span class="keywordflow">return</span> TSystem::memoryShortage();</div>
<div class="line"><span class="lineno">  707</span>  }</div>
</div><!-- fragment -->
</div>
</div>
<a id="a09735a976f21638d124236b548a11a7e" name="a09735a976f21638d124236b548a11a7e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a09735a976f21638d124236b548a11a7e">&#9670;&nbsp;</a></span>outputMap()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TImageCache::Imp::outputMap </td>
          <td>(</td>
          <td class="paramtype">UINT&#160;</td>
          <td class="paramname"><em>chunkRequested</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::string&#160;</td>
          <td class="paramname"><em>filename</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1846</span>                                                                      {</div>
<div class="line"><span class="lineno"> 1847</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno"> 1848</span>  <span class="comment">//#ifdef _DEBUG</span></div>
<div class="line"><span class="lineno"> 1849</span>  <span class="comment">// static int Count = 0;</span></div>
<div class="line"><span class="lineno"> 1850</span> </div>
<div class="line"><span class="lineno"> 1851</span>  std::string st = filename <span class="comment">/*+toString(Count++)*/</span> + <span class="stringliteral">&quot;.txt&quot;</span>;</div>
<div class="line"><span class="lineno"> 1852</span>  <a class="code hl_class" href="class_t_file_path.html">TFilePath</a> fp(st);</div>
<div class="line"><span class="lineno"> 1853</span>  <a class="code hl_class" href="class_tofstream.html">Tofstream</a> os(fp);</div>
<div class="line"><span class="lineno"> 1854</span> </div>
<div class="line"><span class="lineno"> 1855</span>  <span class="keywordtype">int</span> umcount1 = 0;</div>
<div class="line"><span class="lineno"> 1856</span>  <span class="keywordtype">int</span> umcount2 = 0;</div>
<div class="line"><span class="lineno"> 1857</span>  <span class="keywordtype">int</span> umcount3 = 0;</div>
<div class="line"><span class="lineno"> 1858</span>  <span class="keywordtype">int</span> cmcount  = 0;</div>
<div class="line"><span class="lineno"> 1859</span>  <span class="keywordtype">int</span> cdcount  = 0;</div>
<div class="line"><span class="lineno"> 1860</span>  <span class="keywordtype">int</span> umcount  = 0;</div>
<div class="line"><span class="lineno"> 1861</span>  <span class="keywordtype">int</span> udcount  = 0;</div>
<div class="line"><span class="lineno"> 1862</span> </div>
<div class="line"><span class="lineno"> 1863</span>  TUINT64 umsize1 = 0;</div>
<div class="line"><span class="lineno"> 1864</span>  TUINT64 umsize2 = 0;</div>
<div class="line"><span class="lineno"> 1865</span>  TUINT64 umsize3 = 0;</div>
<div class="line"><span class="lineno"> 1866</span>  TUINT64 cmsize  = 0;</div>
<div class="line"><span class="lineno"> 1867</span>  TUINT64 cdsize  = 0;</div>
<div class="line"><span class="lineno"> 1868</span>  TUINT64 umsize  = 0;</div>
<div class="line"><span class="lineno"> 1869</span>  TUINT64 udsize  = 0;</div>
<div class="line"><span class="lineno"> 1870</span> </div>
<div class="line"><span class="lineno"> 1871</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itu = m_uncompressedItems.begin();</div>
<div class="line"><span class="lineno"> 1872</span> </div>
<div class="line"><span class="lineno"> 1873</span>  <span class="keywordflow">for</span> (; itu != m_uncompressedItems.end(); ++itu) {</div>
<div class="line"><span class="lineno"> 1874</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a> uitem = itu-&gt;second;</div>
<div class="line"><span class="lineno"> 1875</span>    <span class="keywordflow">if</span> (uitem-&gt;m_image &amp;&amp; hasExternalReferences(uitem-&gt;m_image)) {</div>
<div class="line"><span class="lineno"> 1876</span>      umcount1++;</div>
<div class="line"><span class="lineno"> 1877</span>      umsize1 += (TUINT64)(itu-&gt;second-&gt;getSize() / 1024.0);</div>
<div class="line"><span class="lineno"> 1878</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uitem-&gt;m_cantCompress) {</div>
<div class="line"><span class="lineno"> 1879</span>      umcount2++;</div>
<div class="line"><span class="lineno"> 1880</span>      umsize2 += (TUINT64)(itu-&gt;second-&gt;getSize() / 1024.0);</div>
<div class="line"><span class="lineno"> 1881</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1882</span>      umcount3++;</div>
<div class="line"><span class="lineno"> 1883</span>      umsize3 += (TUINT64)(itu-&gt;second-&gt;getSize() / 1024.0);</div>
<div class="line"><span class="lineno"> 1884</span>    }</div>
<div class="line"><span class="lineno"> 1885</span>  }</div>
<div class="line"><span class="lineno"> 1886</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itc = m_compressedItems.begin();</div>
<div class="line"><span class="lineno"> 1887</span>  <span class="keywordflow">for</span> (; itc != m_compressedItems.end(); ++itc) {</div>
<div class="line"><span class="lineno"> 1888</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> boh                      = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1889</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">CompressedOnMemoryCacheItemP</a> cmitem = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1890</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">CompressedOnDiskCacheItemP</a> cditem   = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1891</span>    <a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnDiskCacheItemP</a> uditem = itc-&gt;second;</div>
<div class="line"><span class="lineno"> 1892</span>    <span class="keywordflow">if</span> (cmitem) {</div>
<div class="line"><span class="lineno"> 1893</span>      cmcount++;</div>
<div class="line"><span class="lineno"> 1894</span>      cmsize += cmitem-&gt;getSize();</div>
<div class="line"><span class="lineno"> 1895</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cditem) {</div>
<div class="line"><span class="lineno"> 1896</span>      cdcount++;</div>
<div class="line"><span class="lineno"> 1897</span>      cdsize += cditem-&gt;getSize();</div>
<div class="line"><span class="lineno"> 1898</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1899</span>      assert(uditem);</div>
<div class="line"><span class="lineno"> 1900</span>      udcount++;</div>
<div class="line"><span class="lineno"> 1901</span>      udsize += uditem-&gt;getSize();</div>
<div class="line"><span class="lineno"> 1902</span>    }</div>
<div class="line"><span class="lineno"> 1903</span>  }</div>
<div class="line"><span class="lineno"> 1904</span> </div>
<div class="line"><span class="lineno"> 1905</span>  TUINT64 currPhisMemoryAvail =</div>
<div class="line"><span class="lineno"> 1906</span>      (TUINT64)(TSystem::getFreeMemorySize(<span class="keyword">true</span>) / 1024.0);</div>
<div class="line"><span class="lineno"> 1907</span>  <span class="comment">// TUINT64 currVirtualMemoryAvail = TSystem::getFreeMemorySize(false)/1024.0;</span></div>
<div class="line"><span class="lineno"> 1908</span> </div>
<div class="line"><span class="lineno"> 1909</span>  os &lt;&lt; <span class="stringliteral">&quot;************************************************************\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1910</span> </div>
<div class="line"><span class="lineno"> 1911</span>  os &lt;&lt; <span class="stringliteral">&quot;***requested memory: &quot;</span> +</div>
<div class="line"><span class="lineno"> 1912</span>            std::to_string((<span class="keywordtype">int</span>)chunkRequested / 1048576.0) + <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1913</span>  <span class="comment">// os&lt;&lt;&quot;*** memory in rasters: &quot; +</span></div>
<div class="line"><span class="lineno"> 1914</span>  <span class="comment">// std::to_string((int)TRaster::getTotalMemoryInKB()/1024.0) + &quot; MB\n&quot;;</span></div>
<div class="line"><span class="lineno"> 1915</span>  <span class="comment">// os&lt;&lt;&quot;***virtualmem &quot; + std::to_string((int)currVirtualMemoryAvail) + &quot;</span></div>
<div class="line"><span class="lineno"> 1916</span>  <span class="comment">// MB\n&quot;;</span></div>
<div class="line"><span class="lineno"> 1917</span>  os &lt;&lt; <span class="stringliteral">&quot;***phismem &quot;</span> + std::to_string((<span class="keywordtype">int</span>)currPhisMemoryAvail) +</div>
<div class="line"><span class="lineno"> 1918</span>            <span class="stringliteral">&quot; MB; percent of tot:&quot;</span> +</div>
<div class="line"><span class="lineno"> 1919</span>            std::to_string(</div>
<div class="line"><span class="lineno"> 1920</span>                (<span class="keywordtype">int</span>)((currPhisMemoryAvail * 100) / m_reservedMemory)) +</div>
<div class="line"><span class="lineno"> 1921</span>            <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1922</span>  <span class="comment">// os&lt;&lt;&quot;***bigmem available&quot; +</span></div>
<div class="line"><span class="lineno"> 1923</span>  <span class="comment">// std::to_string((int)TBigMemoryManager::instance()-&gt;getAvailableMemoryinKb());</span></div>
<div class="line"><span class="lineno"> 1924</span>  os &lt;&lt; <span class="stringliteral">&quot;***uncompressed NOT compressible(refcount&gt;1)   &quot;</span> +</div>
<div class="line"><span class="lineno"> 1925</span>            std::to_string(umcount1) + <span class="stringliteral">&quot; &quot;</span> + std::to_string(umsize1 / 1024.0) +</div>
<div class="line"><span class="lineno"> 1926</span>            <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1927</span>  os &lt;&lt; <span class="stringliteral">&quot;***uncompressed NOT compressible(cantCompress)   &quot;</span> +</div>
<div class="line"><span class="lineno"> 1928</span>            std::to_string(umcount2) + <span class="stringliteral">&quot; &quot;</span> + std::to_string(umsize2 / 1024.0) +</div>
<div class="line"><span class="lineno"> 1929</span>            <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1930</span>  os &lt;&lt; <span class="stringliteral">&quot;***uncompressed compressible   &quot;</span> + std::to_string(umcount3) + <span class="stringliteral">&quot; &quot;</span> +</div>
<div class="line"><span class="lineno"> 1931</span>            std::to_string(umsize3 / 1024.0) + <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1932</span>  os &lt;&lt; <span class="stringliteral">&quot;***compressed on mem  &quot;</span> + std::to_string(cmcount) + <span class="stringliteral">&quot; &quot;</span> +</div>
<div class="line"><span class="lineno"> 1933</span>            std::to_string((<span class="keywordtype">int</span>)cmsize / 1048576.0) + <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1934</span>  os &lt;&lt; <span class="stringliteral">&quot;***compressed on disk &quot;</span> + std::to_string(cdcount) + <span class="stringliteral">&quot; &quot;</span> +</div>
<div class="line"><span class="lineno"> 1935</span>            std::to_string((<span class="keywordtype">int</span>)cdsize / 1048576.0) + <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1936</span>  os &lt;&lt; <span class="stringliteral">&quot;***uncompressed on disk &quot;</span> + std::to_string(udcount) + <span class="stringliteral">&quot; &quot;</span> +</div>
<div class="line"><span class="lineno"> 1937</span>            std::to_string((<span class="keywordtype">int</span>)udsize / 1048576.0) + <span class="stringliteral">&quot; MB\n&quot;</span>;</div>
<div class="line"><span class="lineno"> 1938</span> </div>
<div class="line"><span class="lineno"> 1939</span>  <span class="comment">// TBigMemoryManager::instance()-&gt;printMap();</span></div>
<div class="line"><span class="lineno"> 1940</span> </div>
<div class="line"><span class="lineno"> 1941</span>  <span class="comment">//#endif</span></div>
<div class="line"><span class="lineno"> 1942</span>}</div>
<div class="ttc" id="aclass_tofstream_html"><div class="ttname"><a href="class_tofstream.html">Tofstream</a></div><div class="ttdef"><b>Definition:</b> tfilepath_io.h:72</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a7409dc4b3c1f7f143716f654609de8c6" name="a7409dc4b3c1f7f143716f654609de8c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7409dc4b3c1f7f143716f654609de8c6">&#9670;&nbsp;</a></span>remap()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TImageCache::Imp::remap </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>dstId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>srcId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1322</span>                                                     {</div>
<div class="line"><span class="lineno"> 1323</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno"> 1324</span>  std::map&lt;std::string, CacheItemP&gt;::iterator it =</div>
<div class="line"><span class="lineno"> 1325</span>      m_uncompressedItems.find(srcId);</div>
<div class="line"><span class="lineno"> 1326</span>  <span class="keywordflow">if</span> (it != m_uncompressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1327</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> citem = it-&gt;second;</div>
<div class="line"><span class="lineno"> 1328</span>    assert(m_itemHistory.find(citem-&gt;m_historyCount) != m_itemHistory.end());</div>
<div class="line"><span class="lineno"> 1329</span>    m_itemHistory.erase(citem-&gt;m_historyCount);</div>
<div class="line"><span class="lineno"> 1330</span>    m_itemsByImagePointer.erase(getPointer(citem-&gt;getImage()));</div>
<div class="line"><span class="lineno"> 1331</span>    m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno"> 1332</span> </div>
<div class="line"><span class="lineno"> 1333</span>    m_uncompressedItems[dstId]                           = citem;</div>
<div class="line"><span class="lineno"> 1334</span>    m_itemHistory[citem-&gt;m_historyCount]                 = dstId;</div>
<div class="line"><span class="lineno"> 1335</span>    m_itemsByImagePointer[getPointer(citem-&gt;getImage())] = dstId;</div>
<div class="line"><span class="lineno"> 1336</span>  }</div>
<div class="line"><span class="lineno"> 1337</span>  it = m_compressedItems.find(srcId);</div>
<div class="line"><span class="lineno"> 1338</span>  <span class="keywordflow">if</span> (it != m_compressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1339</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> citem = it-&gt;second;</div>
<div class="line"><span class="lineno"> 1340</span>    m_compressedItems.erase(it);</div>
<div class="line"><span class="lineno"> 1341</span>    m_compressedItems[dstId] = citem;</div>
<div class="line"><span class="lineno"> 1342</span>  }</div>
<div class="line"><span class="lineno"> 1343</span>  std::map&lt;std::string, std::string&gt;::iterator it2 =</div>
<div class="line"><span class="lineno"> 1344</span>      m_duplicatedItems.find(srcId);</div>
<div class="line"><span class="lineno"> 1345</span>  <span class="keywordflow">if</span> (it2 != m_duplicatedItems.end()) {</div>
<div class="line"><span class="lineno"> 1346</span>    std::string <span class="keywordtype">id</span> = it2-&gt;second;</div>
<div class="line"><span class="lineno"> 1347</span>    m_duplicatedItems.erase(it2);</div>
<div class="line"><span class="lineno"> 1348</span>    m_duplicatedItems[dstId] = id;</div>
<div class="line"><span class="lineno"> 1349</span>  }</div>
<div class="line"><span class="lineno"> 1350</span>  <span class="keywordflow">for</span> (it2 = m_duplicatedItems.begin(); it2 != m_duplicatedItems.end(); ++it2)</div>
<div class="line"><span class="lineno"> 1351</span>    <span class="keywordflow">if</span> (it2-&gt;second == srcId) it2-&gt;second = dstId;</div>
<div class="line"><span class="lineno"> 1352</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a2751841b45fca7b4fdb512965d7570bd" name="a2751841b45fca7b4fdb512965d7570bd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2751841b45fca7b4fdb512965d7570bd">&#9670;&nbsp;</a></span>remove()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TImageCache::Imp::remove </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1264</span>                                               {</div>
<div class="line"><span class="lineno"> 1265</span>  <span class="keywordflow">if</span> (CacheInstance == 0)</div>
<div class="line"><span class="lineno"> 1266</span>    <span class="keywordflow">return</span>;  <span class="comment">// the remove can be called when exiting from toonz...after the</span></div>
<div class="line"><span class="lineno"> 1267</span>             <span class="comment">// imagecache was already freed!</span></div>
<div class="line"><span class="lineno"> 1268</span> </div>
<div class="line"><span class="lineno"> 1269</span>  assert(check == magic);</div>
<div class="line"><span class="lineno"> 1270</span>  TThread::MutexLocker sl(&amp;m_mutex);</div>
<div class="line"><span class="lineno"> 1271</span> </div>
<div class="line"><span class="lineno"> 1272</span>  std::map&lt;std::string, std::string&gt;::iterator it1;</div>
<div class="line"><span class="lineno"> 1273</span>  <span class="keywordflow">if</span> ((it1 = m_duplicatedItems.find(<span class="keywordtype">id</span>)) !=</div>
<div class="line"><span class="lineno"> 1274</span>      m_duplicatedItems.end())  <span class="comment">// it&#39;s a duplicated id...</span></div>
<div class="line"><span class="lineno"> 1275</span>  {</div>
<div class="line"><span class="lineno"> 1276</span>    m_duplicatedItems.erase(it1);</div>
<div class="line"><span class="lineno"> 1277</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1278</span>  }</div>
<div class="line"><span class="lineno"> 1279</span> </div>
<div class="line"><span class="lineno"> 1280</span>  <span class="keywordflow">for</span> (it1 = m_duplicatedItems.begin(); it1 != m_duplicatedItems.end(); ++it1)</div>
<div class="line"><span class="lineno"> 1281</span>    <span class="keywordflow">if</span> (it1-&gt;second == <span class="keywordtype">id</span>) <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno"> 1282</span> </div>
<div class="line"><span class="lineno"> 1283</span>  <span class="keywordflow">if</span> (it1 != m_duplicatedItems.end())  <span class="comment">// it has duplicated, so cannot erase it;</span></div>
<div class="line"><span class="lineno"> 1284</span>                                       <span class="comment">// I erase the duplicate, and assign its</span></div>
<div class="line"><span class="lineno"> 1285</span>                                       <span class="comment">// id has the main id</span></div>
<div class="line"><span class="lineno"> 1286</span>  {</div>
<div class="line"><span class="lineno"> 1287</span>    std::string sonId = it1-&gt;first;</div>
<div class="line"><span class="lineno"> 1288</span>    m_duplicatedItems.erase(it1);</div>
<div class="line"><span class="lineno"> 1289</span>    remap(sonId, <span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1290</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1291</span>  }</div>
<div class="line"><span class="lineno"> 1292</span> </div>
<div class="line"><span class="lineno"> 1293</span>  std::map&lt;std::string, CacheItemP&gt;::iterator it = m_uncompressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1294</span>  std::map&lt;std::string, CacheItemP&gt;::iterator itc = m_compressedItems.find(<span class="keywordtype">id</span>);</div>
<div class="line"><span class="lineno"> 1295</span>  <span class="keywordflow">if</span> (it != m_uncompressedItems.end()) {</div>
<div class="line"><span class="lineno"> 1296</span>    <span class="keyword">const</span> <a class="code hl_class" href="class_t_smart_pointer_t.html">CacheItemP</a> &amp;item = it-&gt;second;</div>
<div class="line"><span class="lineno"> 1297</span>    assert((<a class="code hl_class" href="class_t_derived_smart_pointer_t.html">UncompressedOnMemoryCacheItemP</a>)item);</div>
<div class="line"><span class="lineno"> 1298</span>    assert(m_itemHistory.find(it-&gt;second-&gt;m_historyCount) !=</div>
<div class="line"><span class="lineno"> 1299</span>           m_itemHistory.end());</div>
<div class="line"><span class="lineno"> 1300</span>    m_itemHistory.erase(it-&gt;second-&gt;m_historyCount);</div>
<div class="line"><span class="lineno"> 1301</span>    m_itemsByImagePointer.erase(getPointer(it-&gt;second-&gt;getImage()));</div>
<div class="line"><span class="lineno"> 1302</span> </div>
<div class="line"><span class="lineno"> 1303</span><span class="preprocessor">#ifdef _DEBUGTOONZ</span></div>
<div class="line"><span class="lineno"> 1304</span>    <span class="keywordflow">if</span> ((<a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>)it-&gt;second-&gt;getImage())</div>
<div class="line"><span class="lineno"> 1305</span>      ((<a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>)it-&gt;second-&gt;getImage())-&gt;getRaster()-&gt;m_cashed = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1306</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code hl_class" href="class_t_toonz_image_p.html">TToonzImageP</a>)it-&gt;second-&gt;getImage())</div>
<div class="line"><span class="lineno"> 1307</span>      ((<a class="code hl_class" href="class_t_toonz_image_p.html">TToonzImageP</a>)it-&gt;second-&gt;getImage())-&gt;getRaster()-&gt;m_cashed = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1308</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno"> 1309</span> </div>
<div class="line"><span class="lineno"> 1310</span>    m_uncompressedItems.erase(it);</div>
<div class="line"><span class="lineno"> 1311</span>  }</div>
<div class="line"><span class="lineno"> 1312</span>  <span class="keywordflow">if</span> (itc != m_compressedItems.end()) m_compressedItems.erase(itc);</div>
<div class="line"><span class="lineno"> 1313</span>}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="adcbf5b5cd4f6a95aeea8511c831a41e4" name="adcbf5b5cd4f6a95aeea8511c831a41e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adcbf5b5cd4f6a95aeea8511c831a41e4">&#9670;&nbsp;</a></span>m_compressedItems</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::map&lt;std::string, <a class="el" href="class_t_smart_pointer_t.html">CacheItemP</a>&gt; TImageCache::Imp::m_compressedItems</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a4d1c713f1a74fb81d225473f3398ca94" name="a4d1c713f1a74fb81d225473f3398ca94"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4d1c713f1a74fb81d225473f3398ca94">&#9670;&nbsp;</a></span>m_duplicatedItems</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::map&lt;std::string, std::string&gt; TImageCache::Imp::m_duplicatedItems</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a8a10d42f12f41afa489395e7b9597ff9" name="a8a10d42f12f41afa489395e7b9597ff9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8a10d42f12f41afa489395e7b9597ff9">&#9670;&nbsp;</a></span>m_fileid</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int TImageCache::Imp::m_fileid</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a7246fac918c6fc87078b8c4e451e0ac6" name="a7246fac918c6fc87078b8c4e451e0ac6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7246fac918c6fc87078b8c4e451e0ac6">&#9670;&nbsp;</a></span>m_isEnabled</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">QThreadStorage&lt;bool *&gt; TImageCache::Imp::m_isEnabled</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aa0b50ab48536920dd150c53557fd344f" name="aa0b50ab48536920dd150c53557fd344f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa0b50ab48536920dd150c53557fd344f">&#9670;&nbsp;</a></span>m_itemHistory</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::map&lt;TUINT32, std::string&gt; TImageCache::Imp::m_itemHistory</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a3ff9cb73078ade9741c3fa00e33609d8" name="a3ff9cb73078ade9741c3fa00e33609d8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3ff9cb73078ade9741c3fa00e33609d8">&#9670;&nbsp;</a></span>m_itemsByImagePointer</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::map&lt;void *, std::string&gt; TImageCache::Imp::m_itemsByImagePointer</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aa648b74327aa7241496e9a2a2ea2f6a5" name="aa648b74327aa7241496e9a2a2ea2f6a5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa648b74327aa7241496e9a2a2ea2f6a5">&#9670;&nbsp;</a></span>m_mutex</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_t_thread_1_1_mutex.html">TThread::Mutex</a> TImageCache::Imp::m_mutex</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a5115a2ad58307fa8ea5402bf89d9988a" name="a5115a2ad58307fa8ea5402bf89d9988a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5115a2ad58307fa8ea5402bf89d9988a">&#9670;&nbsp;</a></span>m_reservedMemory</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">TINT64 TImageCache::Imp::m_reservedMemory</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aa4b3bcb0ddede7224b899757fc5bc164" name="aa4b3bcb0ddede7224b899757fc5bc164"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa4b3bcb0ddede7224b899757fc5bc164">&#9670;&nbsp;</a></span>m_rootDir</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_t_file_path.html">TFilePath</a> TImageCache::Imp::m_rootDir</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a7560e31deb10434dfae0c7d929727db5" name="a7560e31deb10434dfae0c7d929727db5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7560e31deb10434dfae0c7d929727db5">&#9670;&nbsp;</a></span>m_uncompressedItems</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::map&lt;std::string, <a class="el" href="class_t_smart_pointer_t.html">CacheItemP</a>&gt; TImageCache::Imp::m_uncompressedItems</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>E:/opentoonz/toonz/sources/common/tcache/<a class="el" href="">timagecache.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
