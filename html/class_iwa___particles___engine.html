<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>opentoonz: Iwa_Particles_Engine Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">opentoonz
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="class_iwa___particles___engine-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">Iwa_Particles_Engine Class Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ad9c08a302d0c763aaf6680e45d723443"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#ad9c08a302d0c763aaf6680e45d723443">Iwa_Particles_Engine</a> (<a class="el" href="class_iwa___tiled_particles_fx.html">Iwa_TiledParticlesFx</a> *parent, double frame)</td></tr>
<tr class="separator:ad9c08a302d0c763aaf6680e45d723443"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b6044568dbb679cc678f303e3d74972"><td class="memItemLeft" align="right" valign="top"><a id="a0b6044568dbb679cc678f303e3d74972" name="a0b6044568dbb679cc678f303e3d74972"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>scramble_particles</b> (void)</td></tr>
<tr class="separator:a0b6044568dbb679cc678f303e3d74972"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e6efcd77d68706c45f3540d6347eb47"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a3e6efcd77d68706c45f3540d6347eb47">fill_range_struct</a> (struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, struct <a class="el" href="structparticles__ranges.html">particles_ranges</a> &amp;ranges)</td></tr>
<tr class="separator:a3e6efcd77d68706c45f3540d6347eb47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a30ef592c2470d1c4937337494bc9ed47"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a30ef592c2470d1c4937337494bc9ed47">fill_value_struct</a> (struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;value, double frame)</td></tr>
<tr class="separator:a30ef592c2470d1c4937337494bc9ed47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a818ccc2106caa5fec43413520e272883"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a818ccc2106caa5fec43413520e272883">roll_particles</a> (<a class="el" href="class_t_tile.html">TTile</a> *tile, std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt; porttiles, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, std::list&lt; <a class="el" href="class_iwa___particle.html">Iwa_Particle</a> &gt; &amp;myParticles, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, float cx, float cy, int frame, int curr_frame, int level_n, bool *random_level, float dpi, std::vector&lt; int &gt; lastframe, int &amp;totalparticles, QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;particleOrigin, int genPartNum)</td></tr>
<tr class="separator:a818ccc2106caa5fec43413520e272883"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0dc44ec341ee6f217096797da28dc886"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a0dc44ec341ee6f217096797da28dc886">normalize_values</a> (struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri)</td></tr>
<tr class="separator:a0dc44ec341ee6f217096797da28dc886"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a27146e0ff733de70623ab1aebbb6bee0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a27146e0ff733de70623ab1aebbb6bee0">render_particles</a> (<a class="el" href="class_t_tile.html">TTile</a> *tile, std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; part_ports, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, <a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;p_size, <a class="el" href="class_t_point_t.html">TPointD</a> &amp;p_offset, std::map&lt; int, <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; ctrl_ports, std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt; partLevel, float dpi, int curr_frame, int shrink, double startx, double starty, double endx, double endy, std::vector&lt; int &gt; lastframe, unsigned long fxId)</td></tr>
<tr class="separator:a27146e0ff733de70623ab1aebbb6bee0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2924ee9a714c52f031b8dd467458a8a0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a2924ee9a714c52f031b8dd467458a8a0">do_render</a> (<a class="el" href="class_iwa___particle.html">Iwa_Particle</a> *part, <a class="el" href="class_t_tile.html">TTile</a> *tile, std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; part_ports, std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt; porttiles, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, <a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;p_size, <a class="el" href="class_t_point_t.html">TPointD</a> &amp;p_offset, int lastframe, std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt; partLevel, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, float opacity_range, int curr_frame, std::map&lt; std::pair&lt; int, int &gt;, float &gt; &amp;partScales, <a class="el" href="class_t_tile.html">TTile</a> *baseImgTile)</td></tr>
<tr class="separator:a2924ee9a714c52f031b8dd467458a8a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a207029f17f0782312898b862b3457830"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a207029f17f0782312898b862b3457830">port_is_used</a> (int i, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values)</td></tr>
<tr class="separator:a207029f17f0782312898b862b3457830"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7838ef3ad00e160065f8a1c379985c3e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a7838ef3ad00e160065f8a1c379985c3e">fill_single_region</a> (std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &amp;myregions, <a class="el" href="class_t_tile.html">TTile</a> *ctrl1, int thres, bool do_source_gradation, QList&lt; QList&lt; int &gt; &gt; &amp;myHistogram, QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;particleOrigins)</td></tr>
<tr class="separator:a7838ef3ad00e160065f8a1c379985c3e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9347cf024c68197dc31ae7b941c43d69"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a9347cf024c68197dc31ae7b941c43d69">fill_subregions</a> (int cont_index, std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, <a class="el" href="class_t_tile.html">TTile</a> *ctrl1, int thres)</td></tr>
<tr class="separator:a9347cf024c68197dc31ae7b941c43d69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0e9c35ba4d075060740ab334393d8e7d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a0e9c35ba4d075060740ab334393d8e7d">normalize_array</a> (std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, <a class="el" href="class_t_point_t.html">TPointD</a> pos, int lx, int ly, int regioncounter, std::vector&lt; int &gt; &amp;myarray, std::vector&lt; int &gt; &amp;lista, std::vector&lt; int &gt; &amp;listb, std::vector&lt; int &gt; &amp;final)</td></tr>
<tr class="separator:a0e9c35ba4d075060740ab334393d8e7d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0701cb754e053a291ed9dc168c517b1b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a0701cb754e053a291ed9dc168c517b1b">fill_array</a> (<a class="el" href="class_t_tile.html">TTile</a> *ctrl1, int &amp;regioncount, std::vector&lt; int &gt; &amp;myarray, std::vector&lt; int &gt; &amp;lista, std::vector&lt; int &gt; &amp;listb, int thres)</td></tr>
<tr class="separator:a0701cb754e053a291ed9dc168c517b1b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1fa9cc79320c7b8c6e5cb60f45caeea0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a1fa9cc79320c7b8c6e5cb60f45caeea0">initParticleOrigins</a> (<a class="el" href="class_t_rect_t.html">TRectD</a> &amp;outTileBBox, QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;particleOrigins, const double frame, const <a class="el" href="class_t_affine.html">TAffine</a> affine, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, int level_n, std::vector&lt; int &gt; &amp;lastframe, double pixelMargin)</td></tr>
<tr class="separator:a1fa9cc79320c7b8c6e5cb60f45caeea0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af14be8ae622e83cbf950d60b9030317a"><td class="memItemLeft" align="right" valign="top">unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#af14be8ae622e83cbf950d60b9030317a">getInitSourceFrame</a> (const <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, int first, int last)</td></tr>
<tr class="separator:af14be8ae622e83cbf950d60b9030317a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f655c139bcd2b581b560d2f2ce396d6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a4f655c139bcd2b581b560d2f2ce396d6">renderBackground</a> (<a class="el" href="class_t_tile.html">TTile</a> *tile, QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;origins, std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; part_ports, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt; partLevel, std::map&lt; std::pair&lt; int, int &gt;, float &gt; &amp;partScales, <a class="el" href="class_t_tile.html">TTile</a> *baseImgTile)</td></tr>
<tr class="separator:a4f655c139bcd2b581b560d2f2ce396d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-attribs" name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:a18b67b6aae45192dd848f999166db708"><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_iwa___tiled_particles_fx.html">Iwa_TiledParticlesFx</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a18b67b6aae45192dd848f999166db708">m_parent</a></td></tr>
<tr class="separator:a18b67b6aae45192dd848f999166db708"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a43b7302085e3306caab8549957a40227"><td class="memItemLeft" align="right" valign="top">double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_iwa___particles___engine.html#a43b7302085e3306caab8549957a40227">m_frame</a></td></tr>
<tr class="separator:a43b7302085e3306caab8549957a40227"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"></div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="ad9c08a302d0c763aaf6680e45d723443" name="ad9c08a302d0c763aaf6680e45d723443"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9c08a302d0c763aaf6680e45d723443">&#9670;&nbsp;</a></span>Iwa_Particles_Engine()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Iwa_Particles_Engine::Iwa_Particles_Engine </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_iwa___tiled_particles_fx.html">Iwa_TiledParticlesFx</a> *&#160;</td>
          <td class="paramname"><em>parent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frame</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   48</span>    : m_parent(parent), m_frame(frame) {}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acbba862d0f70c0f6e74368c42a41207e" name="acbba862d0f70c0f6e74368c42a41207e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acbba862d0f70c0f6e74368c42a41207e">&#9670;&nbsp;</a></span>~Iwa_Particles_Engine()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Iwa_Particles_Engine::~Iwa_Particles_Engine </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   59</span>{};</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a2924ee9a714c52f031b8dd467458a8a0" name="a2924ee9a714c52f031b8dd467458a8a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2924ee9a714c52f031b8dd467458a8a0">&#9670;&nbsp;</a></span>do_render()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::do_render </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_iwa___particle.html">Iwa_Particle</a> *&#160;</td>
          <td class="paramname"><em>part</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>part_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt;&#160;</td>
          <td class="paramname"><em>porttiles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;&#160;</td>
          <td class="paramname"><em>p_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a> &amp;&#160;</td>
          <td class="paramname"><em>p_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt;&#160;</td>
          <td class="paramname"><em>partLevel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>opacity_range</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>curr_frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; std::pair&lt; int, int &gt;, float &gt; &amp;&#160;</td>
          <td class="paramname"><em>partScales</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>baseImgTile</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  877</span>                                                                      {</div>
<div class="line"><span class="lineno">  878</span>  <span class="comment">/*- カメラに対してタテになっている粒子を描かずに飛ばす -*/</span></div>
<div class="line"><span class="lineno">  879</span>  <span class="keywordflow">if</span> (std::abs(cosf(part-&gt;flap_phi * 3.14159f / 180.0f)) &lt; 0.03f) {</div>
<div class="line"><span class="lineno">  880</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  881</span>  }</div>
<div class="line"><span class="lineno">  882</span>  <span class="comment">// Retrieve the particle frame - that is, the *column frame* from which we are</span></div>
<div class="line"><span class="lineno">  883</span>  <span class="comment">// picking</span></div>
<div class="line"><span class="lineno">  884</span>  <span class="comment">// the particle to be rendered.</span></div>
<div class="line"><span class="lineno">  885</span>  <span class="keywordtype">int</span> ndx = part-&gt;frame % lastframe;</div>
<div class="line"><span class="lineno">  886</span> </div>
<div class="line"><span class="lineno">  887</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> tileRas(tile-&gt;getRaster());</div>
<div class="line"><span class="lineno">  888</span> </div>
<div class="line"><span class="lineno">  889</span>  std::string levelid;</div>
<div class="line"><span class="lineno">  890</span>  <span class="keywordtype">double</span> aim_angle = 0;</div>
<div class="line"><span class="lineno">  891</span>  <span class="keywordflow">if</span> (values.pathaim_val) {</div>
<div class="line"><span class="lineno">  892</span>    <span class="keywordtype">float</span> arctan = atan2f(part-&gt;vy, part-&gt;vx);</div>
<div class="line"><span class="lineno">  893</span>    aim_angle    = arctan * M_180_PI;</div>
<div class="line"><span class="lineno">  894</span>  }</div>
<div class="line"><span class="lineno">  895</span> </div>
<div class="line"><span class="lineno">  896</span>  <span class="comment">/*- 粒子の回転、スケールをアフィン行列に入れる -*/</span></div>
<div class="line"><span class="lineno">  897</span>  <span class="comment">// Calculate the rotational and scale components we have to apply on the</span></div>
<div class="line"><span class="lineno">  898</span>  <span class="comment">// particle</span></div>
<div class="line"><span class="lineno">  899</span>  <a class="code hl_class" href="class_t_rotation.html">TRotation</a> rotM(part-&gt;angle + aim_angle);</div>
<div class="line"><span class="lineno">  900</span>  <a class="code hl_class" href="class_t_scale.html">TScale</a> scaleM(part-&gt;scale);</div>
<div class="line"><span class="lineno">  901</span> </div>
<div class="line"><span class="lineno">  902</span>  <span class="comment">/*- ひらひら -*/</span></div>
<div class="line"><span class="lineno">  903</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> testAff;</div>
<div class="line"><span class="lineno">  904</span>  <span class="keywordtype">float</span> illuminant;</div>
<div class="line"><span class="lineno">  905</span>  {</div>
<div class="line"><span class="lineno">  906</span>    <span class="keywordtype">float</span> theta = part-&gt;flap_theta * 3.14159f / 180.0f;</div>
<div class="line"><span class="lineno">  907</span>    <span class="keywordtype">float</span> phi   = part-&gt;flap_phi * 3.14159f / 180.0f;</div>
<div class="line"><span class="lineno">  908</span>    <span class="keywordtype">float</span> cosT  = cosf(theta);</div>
<div class="line"><span class="lineno">  909</span>    <span class="keywordtype">float</span> sinT  = sinf(theta);</div>
<div class="line"><span class="lineno">  910</span>    <span class="keywordtype">float</span> k     = 1.0f - cosf(phi);</div>
<div class="line"><span class="lineno">  911</span> </div>
<div class="line"><span class="lineno">  912</span>    testAff.a11 = 1.0f - k * cosT * cosT;</div>
<div class="line"><span class="lineno">  913</span>    testAff.a21 = -k * cosT * sinT;</div>
<div class="line"><span class="lineno">  914</span>    testAff.a12 = -k * cosT * sinT;</div>
<div class="line"><span class="lineno">  915</span>    testAff.a22 = 1.0f - k * sinT * sinT;</div>
<div class="line"><span class="lineno">  916</span> </div>
<div class="line"><span class="lineno">  917</span>    <span class="comment">/*- ここで、照明モードのとき、その明るさを計算する -*/</span></div>
<div class="line"><span class="lineno">  918</span>    <span class="keywordflow">if</span> (values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_ILLUMINATED) {</div>
<div class="line"><span class="lineno">  919</span>      <span class="keywordtype">float</span> liTheta  = values.iw_light_theta_val;</div>
<div class="line"><span class="lineno">  920</span>      <span class="keywordtype">float</span> liPhi    = values.iw_light_phi_val;</div>
<div class="line"><span class="lineno">  921</span>      <a class="code hl_struct" href="structfloat3.html">float3</a> normVec = {sinf(theta) * sinf(phi), cosf(theta) * sinf(phi),</div>
<div class="line"><span class="lineno">  922</span>                        cosf(phi)};</div>
<div class="line"><span class="lineno">  923</span>      <a class="code hl_struct" href="structfloat3.html">float3</a> lightVec = {sinf(liTheta) * sinf(liPhi),</div>
<div class="line"><span class="lineno">  924</span>                         cosf(liTheta) * sinf(liPhi), cosf(liPhi)};</div>
<div class="line"><span class="lineno">  925</span>      <span class="comment">/*- 法線ベクトルと光源ベクトルの内積の絶対値 -*/</span></div>
<div class="line"><span class="lineno">  926</span>      illuminant = std::abs(normVec.x * lightVec.x + normVec.y * lightVec.y +</div>
<div class="line"><span class="lineno">  927</span>                            normVec.z * lightVec.z);</div>
<div class="line"><span class="lineno">  928</span>    }</div>
<div class="line"><span class="lineno">  929</span>  }</div>
<div class="line"><span class="lineno">  930</span> </div>
<div class="line"><span class="lineno">  931</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> M(rotM * scaleM * testAff);</div>
<div class="line"><span class="lineno">  932</span> </div>
<div class="line"><span class="lineno">  933</span>  <span class="comment">// Particles deal with dpi affines on their own</span></div>
<div class="line"><span class="lineno">  934</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> scaleAff(m_parent-&gt;handledAffine(ri, m_frame));</div>
<div class="line"><span class="lineno">  935</span>  <span class="keywordtype">float</span> partScale =</div>
<div class="line"><span class="lineno">  936</span>      scaleAff.a11 * partScales[std::pair&lt;int, int&gt;(part-&gt;level, ndx)];</div>
<div class="line"><span class="lineno">  937</span>  <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a> partResolution(0, 0);</div>
<div class="line"><span class="lineno">  938</span>  <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riNew(ri);</div>
<div class="line"><span class="lineno">  939</span> </div>
<div class="line"><span class="lineno">  940</span>  <span class="comment">// Retrieve the bounding box in the standard reference</span></div>
<div class="line"><span class="lineno">  941</span>  <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> bbox(-5.0, -5.0, 5.0, 5.0), standardRefBBox;</div>
<div class="line"><span class="lineno">  942</span>  <span class="keywordflow">if</span> (part-&gt;level &lt;</div>
<div class="line"><span class="lineno">  943</span>          (<span class="keywordtype">int</span>)part_ports.size() &amp;&amp;  <span class="comment">// Not the default levelless cases</span></div>
<div class="line"><span class="lineno">  944</span>      part_ports[part-&gt;level]-&gt;isConnected()) {</div>
<div class="line"><span class="lineno">  945</span>    <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riIdentity(ri);</div>
<div class="line"><span class="lineno">  946</span>    riIdentity.m_affine = <a class="code hl_class" href="class_t_affine.html">TAffine</a>();</div>
<div class="line"><span class="lineno">  947</span> </div>
<div class="line"><span class="lineno">  948</span>    (*part_ports[part-&gt;level])-&gt;getBBox(ndx, bbox, riIdentity);</div>
<div class="line"><span class="lineno">  949</span> </div>
<div class="line"><span class="lineno">  950</span>    <span class="comment">// A particle&#39;s bbox MUST be finite. Gradients and such which have an</span></div>
<div class="line"><span class="lineno">  951</span>    <span class="comment">// infinite bbox</span></div>
<div class="line"><span class="lineno">  952</span>    <span class="comment">// are just NOT rendered.</span></div>
<div class="line"><span class="lineno">  953</span> </div>
<div class="line"><span class="lineno">  954</span>    <span class="comment">// NOTE: No fx returns half-planes or similar (ie if any coordinate is</span></div>
<div class="line"><span class="lineno">  955</span>    <span class="comment">// either</span></div>
<div class="line"><span class="lineno">  956</span>    <span class="comment">// (std::numeric_limits&lt;double&gt;::max)() or its opposite, then the rect IS</span></div>
<div class="line"><span class="lineno">  957</span>    <span class="comment">// THE infiniteRectD)</span></div>
<div class="line"><span class="lineno">  958</span>    <span class="keywordflow">if</span> (bbox == TConsts::infiniteRectD) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  959</span>  }</div>
<div class="line"><span class="lineno">  960</span> </div>
<div class="line"><span class="lineno">  961</span>  <span class="comment">// Now, these are the particle rendering specifications</span></div>
<div class="line"><span class="lineno">  962</span>  bbox            = bbox.enlarge(3);</div>
<div class="line"><span class="lineno">  963</span>  standardRefBBox = bbox;</div>
<div class="line"><span class="lineno">  964</span>  riNew.m_affine  = <a class="code hl_class" href="class_t_scale.html">TScale</a>(partScale);</div>
<div class="line"><span class="lineno">  965</span>  bbox            = riNew.m_affine * bbox;</div>
<div class="line"><span class="lineno">  966</span>  <span class="comment">/*- 縮小済みのParticleのサイズ -*/</span></div>
<div class="line"><span class="lineno">  967</span>  partResolution = <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(tceil(bbox.getLx()), tceil(bbox.getLy()));</div>
<div class="line"><span class="lineno">  968</span> </div>
<div class="line"><span class="lineno">  969</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> ras;</div>
<div class="line"><span class="lineno">  970</span> </div>
<div class="line"><span class="lineno">  971</span>  std::string alias;</div>
<div class="line"><span class="lineno">  972</span>  <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg;</div>
<div class="line"><span class="lineno">  973</span>  rimg = partLevel[part-&gt;level]-&gt;frame(ndx);</div>
<div class="line"><span class="lineno">  974</span>  <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  975</span>    ras = rimg-&gt;getRaster();</div>
<div class="line"><span class="lineno">  976</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  977</span>    alias = <span class="stringliteral">&quot;PART: &quot;</span> + (*part_ports[part-&gt;level])-&gt;getAlias(ndx, riNew);</div>
<div class="line"><span class="lineno">  978</span>    rimg  = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  979</span>    <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  980</span>      ras = rimg-&gt;getRaster();</div>
<div class="line"><span class="lineno">  981</span> </div>
<div class="line"><span class="lineno">  982</span>      <span class="comment">// Check that the raster resolution is sufficient for our purposes</span></div>
<div class="line"><span class="lineno">  983</span>      <span class="keywordflow">if</span> (ras-&gt;getLx() &lt; partResolution.lx || ras-&gt;getLy() &lt; partResolution.ly)</div>
<div class="line"><span class="lineno">  984</span>        ras = 0;</div>
<div class="line"><span class="lineno">  985</span>      <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  986</span>        partResolution = <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(ras-&gt;getLx(), ras-&gt;getLy());</div>
<div class="line"><span class="lineno">  987</span>    }</div>
<div class="line"><span class="lineno">  988</span>  }</div>
<div class="line"><span class="lineno">  989</span> </div>
<div class="line"><span class="lineno">  990</span>  <span class="comment">// We are interested in making the relation between scale and (integer)</span></div>
<div class="line"><span class="lineno">  991</span>  <span class="comment">// resolution</span></div>
<div class="line"><span class="lineno">  992</span>  <span class="comment">// bijective - since we shall cache by using resolution as a partial</span></div>
<div class="line"><span class="lineno">  993</span>  <span class="comment">// identification parameter.</span></div>
<div class="line"><span class="lineno">  994</span>  <span class="comment">// Therefore, we find the current bbox Lx and take a unique scale out of it.</span></div>
<div class="line"><span class="lineno">  995</span>  partScale      = partResolution.lx / standardRefBBox.getLx();</div>
<div class="line"><span class="lineno">  996</span>  riNew.m_affine = <a class="code hl_class" href="class_t_scale.html">TScale</a>(partScale);</div>
<div class="line"><span class="lineno">  997</span>  bbox           = riNew.m_affine * standardRefBBox;</div>
<div class="line"><span class="lineno">  998</span> </div>
<div class="line"><span class="lineno">  999</span>  <span class="comment">// If no image was retrieved from the cache (or it was not scaled enough),</span></div>
<div class="line"><span class="lineno"> 1000</span>  <span class="comment">// calculate it</span></div>
<div class="line"><span class="lineno"> 1001</span>  <span class="keywordflow">if</span> (!ras) {</div>
<div class="line"><span class="lineno"> 1002</span>    <a class="code hl_class" href="class_t_tile.html">TTile</a> auxTile;</div>
<div class="line"><span class="lineno"> 1003</span>    (*part_ports[part-&gt;level])</div>
<div class="line"><span class="lineno"> 1004</span>        -&gt;allocateAndCompute(auxTile, bbox.getP00(),</div>
<div class="line"><span class="lineno"> 1005</span>                             <a class="code hl_class" href="class_t_dimension_t.html">TDimension</a>(partResolution.lx, partResolution.ly),</div>
<div class="line"><span class="lineno"> 1006</span>                             tile-&gt;getRaster(), ndx, riNew);</div>
<div class="line"><span class="lineno"> 1007</span>    ras = auxTile.getRaster();</div>
<div class="line"><span class="lineno"> 1008</span> </div>
<div class="line"><span class="lineno"> 1009</span>    <span class="comment">// Finally, cache the particle</span></div>
<div class="line"><span class="lineno"> 1010</span>    addRenderCache(alias, <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>(ras));</div>
<div class="line"><span class="lineno"> 1011</span>  }</div>
<div class="line"><span class="lineno"> 1012</span> </div>
<div class="line"><span class="lineno"> 1013</span>  <span class="keywordflow">if</span> (!ras) <span class="keywordflow">return</span>;  <span class="comment">// At this point, it should never happen anyway...</span></div>
<div class="line"><span class="lineno"> 1014</span> </div>
<div class="line"><span class="lineno"> 1015</span>  <span class="comment">// Deal with particle colors/opacity</span></div>
<div class="line"><span class="lineno"> 1016</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> rfinalpart;</div>
<div class="line"><span class="lineno"> 1017</span>  <span class="comment">// TRaster32P rfinalpart;</span></div>
<div class="line"><span class="lineno"> 1018</span>  <span class="keywordtype">double</span> curr_opacity =</div>
<div class="line"><span class="lineno"> 1019</span>      part-&gt;set_Opacity(porttiles, values, opacity_range, dist_frame);</div>
<div class="line"><span class="lineno"> 1020</span>  <span class="keywordflow">if</span> (curr_opacity != 1.0 || part-&gt;gencol.fadecol || part-&gt;fincol.fadecol ||</div>
<div class="line"><span class="lineno"> 1021</span>      part-&gt;foutcol.fadecol) {</div>
<div class="line"><span class="lineno"> 1022</span>    <span class="keywordflow">if</span> (values.pick_color_for_every_frame_val &amp;&amp; values.gencol_ctrl_val &amp;&amp;</div>
<div class="line"><span class="lineno"> 1023</span>        (porttiles.find(values.gencol_ctrl_val) != porttiles.end()))</div>
<div class="line"><span class="lineno"> 1024</span>      part-&gt;get_image_reference(porttiles[values.gencol_ctrl_val], values,</div>
<div class="line"><span class="lineno"> 1025</span>                                part-&gt;gencol.col);</div>
<div class="line"><span class="lineno"> 1026</span> </div>
<div class="line"><span class="lineno"> 1027</span>    rfinalpart = ras-&gt;clone();</div>
<div class="line"><span class="lineno"> 1028</span>    part-&gt;modify_colors_and_opacity(values, curr_opacity, dist_frame,</div>
<div class="line"><span class="lineno"> 1029</span>                                    rfinalpart);</div>
<div class="line"><span class="lineno"> 1030</span>  } <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1031</span>    rfinalpart = ras;</div>
<div class="line"><span class="lineno"> 1032</span> </div>
<div class="line"><span class="lineno"> 1033</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> rfinalpart2;</div>
<div class="line"><span class="lineno"> 1034</span>  <span class="comment">/*- 照明モードのとき、その明るさを色に格納 -*/</span></div>
<div class="line"><span class="lineno"> 1035</span>  <span class="keywordflow">if</span> (values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_ILLUMINATED) {</div>
<div class="line"><span class="lineno"> 1036</span>    rfinalpart2 = rfinalpart-&gt;clone();</div>
<div class="line"><span class="lineno"> 1037</span>    part-&gt;set_illuminated_colors(illuminant, rfinalpart2);</div>
<div class="line"><span class="lineno"> 1038</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (baseImgTile-&gt;getRaster() &amp;&amp; !baseImgTile-&gt;getRaster()-&gt;isEmpty()) {</div>
<div class="line"><span class="lineno"> 1039</span>    rfinalpart2 = rfinalpart-&gt;clone();</div>
<div class="line"><span class="lineno"> 1040</span>    <span class="comment">/*- サイズが小さい場合は、単に色を拾う -*/</span></div>
<div class="line"><span class="lineno"> 1041</span>    <span class="keywordflow">if</span> (partResolution.lx &lt;= 4.0 &amp;&amp; partResolution.ly &lt;= 4.0)</div>
<div class="line"><span class="lineno"> 1042</span>      part-&gt;get_base_image_color(baseImgTile, values, rfinalpart2, bbox, ri);</div>
<div class="line"><span class="lineno"> 1043</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1044</span>      part-&gt;get_base_image_texture(baseImgTile, values, rfinalpart2, bbox, ri);</div>
<div class="line"><span class="lineno"> 1045</span>  } <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1046</span>    rfinalpart2 = rfinalpart;</div>
<div class="line"><span class="lineno"> 1047</span> </div>
<div class="line"><span class="lineno"> 1048</span>  <span class="comment">// Now, let&#39;s build the particle transform before it is overed on the output</span></div>
<div class="line"><span class="lineno"> 1049</span>  <span class="comment">// tile</span></div>
<div class="line"><span class="lineno"> 1050</span> </div>
<div class="line"><span class="lineno"> 1051</span>  <span class="comment">// First, complete the transform by adding the rotational and scale</span></div>
<div class="line"><span class="lineno"> 1052</span>  <span class="comment">// components from</span></div>
<div class="line"><span class="lineno"> 1053</span>  <span class="comment">// Particles parameters</span></div>
<div class="line"><span class="lineno"> 1054</span>  M = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a> * M * <a class="code hl_class" href="class_t_scale.html">TScale</a>(1.0 / partScale);</div>
<div class="line"><span class="lineno"> 1055</span> </div>
<div class="line"><span class="lineno"> 1056</span>  <span class="comment">// Then, retrieve the particle position in current reference.</span></div>
<div class="line"><span class="lineno"> 1057</span>  <a class="code hl_class" href="class_t_point_t.html">TPointD</a> pos(part-&gt;x, part-&gt;y);</div>
<div class="line"><span class="lineno"> 1058</span>  pos = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a> * pos;</div>
<div class="line"><span class="lineno"> 1059</span> </div>
<div class="line"><span class="lineno"> 1060</span>  <span class="comment">// Finally, add the translational component to the particle</span></div>
<div class="line"><span class="lineno"> 1061</span>  <span class="comment">// NOTE: p_offset is added to account for the particle relative position</span></div>
<div class="line"><span class="lineno"> 1062</span>  <span class="comment">// inside its level&#39;s bbox</span></div>
<div class="line"><span class="lineno"> 1063</span>  M = <a class="code hl_class" href="class_t_translation.html">TTranslation</a>(pos - tile-&gt;m_pos) * M * <a class="code hl_class" href="class_t_translation.html">TTranslation</a>(bbox.getP00());</div>
<div class="line"><span class="lineno"> 1064</span> </div>
<div class="line"><span class="lineno"> 1065</span>  <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> myras32 = tile-&gt;getRaster())</div>
<div class="line"><span class="lineno"> 1066</span>    <a class="code hl_function" href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a>(tileRas, rfinalpart2, M);</div>
<div class="line"><span class="lineno"> 1067</span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster64P</a> myras64 = tile-&gt;getRaster())</div>
<div class="line"><span class="lineno"> 1068</span>    <a class="code hl_function" href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a>(tileRas, rfinalpart2, M);</div>
<div class="line"><span class="lineno"> 1069</span>  <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1070</span>    <span class="keywordflow">throw</span> <a class="code hl_class" href="class_t_exception.html">TException</a>(<span class="stringliteral">&quot;ParticlesFx: unsupported Pixel Type&quot;</span>);</div>
<div class="line"><span class="lineno"> 1071</span>  }</div>
<div class="line"><span class="lineno"> 1072</span>}</div>
<div class="ttc" id="aclass_t_affine_html"><div class="ttname"><a href="class_t_affine.html">TAffine</a></div><div class="ttdoc">This is the base class for the affine transformations.</div><div class="ttdef"><b>Definition:</b> tgeometry.h:864</div></div>
<div class="ttc" id="aclass_t_dimension_t_html"><div class="ttname"><a href="class_t_dimension_t.html">TDimensionT&lt; double &gt;</a></div></div>
<div class="ttc" id="aclass_t_exception_html"><div class="ttname"><a href="class_t_exception.html">TException</a></div><div class="ttdef"><b>Definition:</b> texception.h:18</div></div>
<div class="ttc" id="aclass_t_image_cache_html_aea3ac2752efd6fa9689f5a7c1e895e41"><div class="ttname"><a href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">TImageCache::get</a></div><div class="ttdeci">TImageP get(const std::string &amp;id, bool toBeModified) const</div><div class="ttdef"><b>Definition:</b> timagecache.cpp:1672</div></div>
<div class="ttc" id="aclass_t_point_t_html"><div class="ttname"><a href="class_t_point_t.html">TPointT&lt; double &gt;</a></div></div>
<div class="ttc" id="aclass_t_raster_image_p_html"><div class="ttname"><a href="class_t_raster_image_p.html">TRasterImageP</a></div><div class="ttdef"><b>Definition:</b> trasterimage.h:148</div></div>
<div class="ttc" id="aclass_t_raster_p_t_html"><div class="ttname"><a href="class_t_raster_p_t.html">TRasterPT&lt; TPixel32 &gt;</a></div></div>
<div class="ttc" id="aclass_t_rect_t_html"><div class="ttname"><a href="class_t_rect_t.html">TRectT&lt; double &gt;</a></div></div>
<div class="ttc" id="aclass_t_render_settings_html"><div class="ttname"><a href="class_t_render_settings.html">TRenderSettings</a></div><div class="ttdoc">Data class containing the relevant additional information needed in a render process.</div><div class="ttdef"><b>Definition:</b> trasterfx.h:61</div></div>
<div class="ttc" id="aclass_t_render_settings_html_a1250181bf3fe8e05db005d5faa76b3ea"><div class="ttname"><a href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">TRenderSettings::m_affine</a></div><div class="ttdeci">TAffine m_affine</div><div class="ttdef"><b>Definition:</b> trasterfx.h:97</div></div>
<div class="ttc" id="aclass_t_rotation_html"><div class="ttname"><a href="class_t_rotation.html">TRotation</a></div><div class="ttdef"><b>Definition:</b> tgeometry.h:1083</div></div>
<div class="ttc" id="aclass_t_scale_html"><div class="ttname"><a href="class_t_scale.html">TScale</a></div><div class="ttdef"><b>Definition:</b> tgeometry.h:1133</div></div>
<div class="ttc" id="aclass_t_smart_pointer_t_html"><div class="ttname"><a href="class_t_smart_pointer_t.html">TSmartPointerT&lt; TRaster &gt;</a></div></div>
<div class="ttc" id="aclass_t_tile_html"><div class="ttname"><a href="class_t_tile.html">TTile</a></div><div class="ttdef"><b>Definition:</b> ttile.h:20</div></div>
<div class="ttc" id="aclass_t_translation_html"><div class="ttname"><a href="class_t_translation.html">TTranslation</a></div><div class="ttdef"><b>Definition:</b> tgeometry.h:1074</div></div>
<div class="ttc" id="anamespace_t_rop_html_ae5fd1fb0c2f625e1da14fe92ae0e5122"><div class="ttname"><a href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a></div><div class="ttdeci">DVAPI void over(const TRasterP &amp;out, const TRasterP &amp;dn, const TRasterP &amp;up)</div><div class="ttdef"><b>Definition:</b> tover.cpp:285</div></div>
<div class="ttc" id="astructfloat3_html"><div class="ttname"><a href="structfloat3.html">float3</a></div><div class="ttdef"><b>Definition:</b> iwa_motionblurfx.h:22</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a0701cb754e053a291ed9dc168c517b1b" name="a0701cb754e053a291ed9dc168c517b1b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0701cb754e053a291ed9dc168c517b1b">&#9670;&nbsp;</a></span>fill_array()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::fill_array </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int &amp;&#160;</td>
          <td class="paramname"><em>regioncount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>myarray</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>lista</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>listb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1082</span>                                          {</div>
<div class="line"><span class="lineno"> 1083</span>  <span class="keywordtype">int</span> pr = 0;</div>
<div class="line"><span class="lineno"> 1084</span>  <span class="keywordtype">int</span> i, j;</div>
<div class="line"><span class="lineno"> 1085</span>  <span class="keywordtype">int</span> lx, ly;</div>
<div class="line"><span class="lineno"> 1086</span>  lx = ctrl1-&gt;getRaster()-&gt;getLx();</div>
<div class="line"><span class="lineno"> 1087</span>  ly = ctrl1-&gt;getRaster()-&gt;getLy();</div>
<div class="line"><span class="lineno"> 1088</span> </div>
<div class="line"><span class="lineno"> 1089</span>  <span class="comment">/*prima riga*/</span></div>
<div class="line"><span class="lineno"> 1090</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> raster32 = ctrl1-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1091</span>  raster32-&gt;lock();</div>
<div class="line"><span class="lineno"> 1092</span>  TPixel32 *pix = raster32-&gt;pixels(0);</div>
<div class="line"><span class="lineno"> 1093</span>  <span class="keywordflow">for</span> (i = 0; i &lt; lx; i++) {</div>
<div class="line"><span class="lineno"> 1094</span>    <span class="keywordflow">if</span> (pix-&gt;m &gt; threshold) {</div>
<div class="line"><span class="lineno"> 1095</span>      pr++;</div>
<div class="line"><span class="lineno"> 1096</span>      <span class="keywordflow">if</span> (!i) {</div>
<div class="line"><span class="lineno"> 1097</span>        (regioncount)++;</div>
<div class="line"><span class="lineno"> 1098</span>        myarray[i] = (regioncount);</div>
<div class="line"><span class="lineno"> 1099</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1100</span>        <span class="keywordflow">if</span> (myarray[i - 1]) myarray[i] = myarray[i - 1];</div>
<div class="line"><span class="lineno"> 1101</span>      }</div>
<div class="line"><span class="lineno"> 1102</span>    }</div>
<div class="line"><span class="lineno"> 1103</span>    pix++;</div>
<div class="line"><span class="lineno"> 1104</span>  }</div>
<div class="line"><span class="lineno"> 1105</span> </div>
<div class="line"><span class="lineno"> 1106</span>  <span class="keywordflow">for</span> (j = 1; j &lt; ly; j++) {</div>
<div class="line"><span class="lineno"> 1107</span>    <span class="keywordflow">for</span> (i = 0, pix = raster32-&gt;pixels(j); i &lt; lx; i++, pix++) {</div>
<div class="line"><span class="lineno"> 1108</span>      <span class="comment">/*TMSG_INFO(&quot;j=%d i=%d\n&quot;, j, i);*/</span></div>
<div class="line"><span class="lineno"> 1109</span>      <span class="keywordflow">if</span> (pix-&gt;m &gt; threshold) {</div>
<div class="line"><span class="lineno"> 1110</span>        std::vector&lt;int&gt; mask(4);</div>
<div class="line"><span class="lineno"> 1111</span>        pr++;</div>
<div class="line"><span class="lineno"> 1112</span>        <span class="comment">/* l,ul,u,ur;*/</span></div>
<div class="line"><span class="lineno"> 1113</span>        <span class="keywordflow">if</span> (i) {</div>
<div class="line"><span class="lineno"> 1114</span>          mask[0] = myarray[i - 1 + lx * j];</div>
<div class="line"><span class="lineno"> 1115</span>          mask[1] = myarray[i - 1 + lx * (j - 1)];</div>
<div class="line"><span class="lineno"> 1116</span>        }</div>
<div class="line"><span class="lineno"> 1117</span>        <span class="keywordflow">if</span> (i != lx - 1) mask[3] = myarray[i + 1 + lx * (j - 1)];</div>
<div class="line"><span class="lineno"> 1118</span>        mask[2]                  = myarray[i + lx * (j - 1)];</div>
<div class="line"><span class="lineno"> 1119</span>        <span class="keywordflow">if</span> (!mask[0] &amp;&amp; !mask[1] &amp;&amp; !mask[2] &amp;&amp; !mask[3]) {</div>
<div class="line"><span class="lineno"> 1120</span>          (regioncount)++;</div>
<div class="line"><span class="lineno"> 1121</span>          myarray[i + lx * j] = (regioncount);</div>
<div class="line"><span class="lineno"> 1122</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1123</span>          <span class="keywordtype">int</span> mc, firsttime = 1;</div>
<div class="line"><span class="lineno"> 1124</span>          <span class="keywordflow">for</span> (mc = 0; mc &lt; 4; mc++) {</div>
<div class="line"><span class="lineno"> 1125</span>            <span class="keywordflow">if</span> (mask[mc]) {</div>
<div class="line"><span class="lineno"> 1126</span>              <span class="keywordflow">if</span> (firsttime) {</div>
<div class="line"><span class="lineno"> 1127</span>                myarray[i + lx * j] = mask[mc];</div>
<div class="line"><span class="lineno"> 1128</span>                firsttime           = 0;</div>
<div class="line"><span class="lineno"> 1129</span>              } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1130</span>                <span class="keywordflow">if</span> (myarray[i + lx * j] != mask[mc]) {</div>
<div class="line"><span class="lineno"> 1131</span>                  lista.push_back(myarray[i + lx * j]);</div>
<div class="line"><span class="lineno"> 1132</span>                  listb.push_back(mask[mc]);</div>
<div class="line"><span class="lineno"> 1133</span> </div>
<div class="line"><span class="lineno"> 1134</span>                  <span class="comment">/*TMSG_INFO(&quot;j=%d i=%d mc=%d, mask=%d\n&quot;, j, i, mc,</span></div>
<div class="line"><span class="lineno"> 1135</span><span class="comment">                   * mask[mc]);*/</span></div>
<div class="line"><span class="lineno"> 1136</span>                }</div>
<div class="line"><span class="lineno"> 1137</span>              }</div>
<div class="line"><span class="lineno"> 1138</span>            }</div>
<div class="line"><span class="lineno"> 1139</span>          }</div>
<div class="line"><span class="lineno"> 1140</span>        }</div>
<div class="line"><span class="lineno"> 1141</span>      }</div>
<div class="line"><span class="lineno"> 1142</span>    }</div>
<div class="line"><span class="lineno"> 1143</span>  }</div>
<div class="line"><span class="lineno"> 1144</span>  raster32-&gt;unlock();</div>
<div class="line"><span class="lineno"> 1145</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3e6efcd77d68706c45f3540d6347eb47" name="a3e6efcd77d68706c45f3540d6347eb47"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3e6efcd77d68706c45f3540d6347eb47">&#9670;&nbsp;</a></span>fill_range_struct()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::fill_range_struct </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__ranges.html">particles_ranges</a> &amp;&#160;</td>
          <td class="paramname"><em>ranges</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  159</span>                                                                              {</div>
<div class="line"><span class="lineno">  160</span>  ranges.swing_range = values.swing_val.second - values.swing_val.first;</div>
<div class="line"><span class="lineno">  161</span>  ranges.rotswing_range =</div>
<div class="line"><span class="lineno">  162</span>      values.rotswing_val.second - values.rotswing_val.first;</div>
<div class="line"><span class="lineno">  163</span>  ranges.randomx_range = values.randomx_val.second - values.randomx_val.first;</div>
<div class="line"><span class="lineno">  164</span>  ranges.randomy_range = values.randomy_val.second - values.randomy_val.first;</div>
<div class="line"><span class="lineno">  165</span>  ranges.rotsca_range  = values.rotsca_val.second - values.rotsca_val.first;</div>
<div class="line"><span class="lineno">  166</span>  ranges.rot_range     = values.rot_val.second - values.rot_val.first;</div>
<div class="line"><span class="lineno">  167</span>  ranges.speed_range   = values.speed_val.second - values.speed_val.first;</div>
<div class="line"><span class="lineno">  168</span>  ranges.speeda_range  = values.speeda_val.second - values.speeda_val.first;</div>
<div class="line"><span class="lineno">  169</span>  ranges.mass_range    = values.mass_val.second - values.mass_val.first;</div>
<div class="line"><span class="lineno">  170</span>  ranges.scale_range   = values.scale_val.second - values.scale_val.first;</div>
<div class="line"><span class="lineno">  171</span>  ranges.lifetime_range =</div>
<div class="line"><span class="lineno">  172</span>      values.lifetime_val.second - values.lifetime_val.first;</div>
<div class="line"><span class="lineno">  173</span>  ranges.scalestep_range =</div>
<div class="line"><span class="lineno">  174</span>      values.scalestep_val.second - values.scalestep_val.first;</div>
<div class="line"><span class="lineno">  175</span>  ranges.trail_range = (int)(values.trail_val.second - values.trail_val.first);</div>
<div class="line"><span class="lineno">  176</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7838ef3ad00e160065f8a1c379985c3e" name="a7838ef3ad00e160065f8a1c379985c3e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7838ef3ad00e160065f8a1c379985c3e">&#9670;&nbsp;</a></span>fill_single_region()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::fill_single_region </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>do_source_gradation</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QList&lt; QList&lt; int &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myHistogram</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>particleOrigins</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1244</span>                                            {</div>
<div class="line"><span class="lineno"> 1245</span>  assert(ctrl1-&gt;getRaster());</div>
<div class="line"><span class="lineno"> 1246</span> </div>
<div class="line"><span class="lineno"> 1247</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> raster32(ctrl1-&gt;getRaster()-&gt;getSize());</div>
<div class="line"><span class="lineno"> 1248</span>  <a class="code hl_function" href="namespace_t_rop.html#a45a08fb48dd7d33ec629d722081d55c6">TRop::convert</a>(raster32, ctrl1-&gt;getRaster());</div>
<div class="line"><span class="lineno"> 1249</span>  assert(raster32);  <span class="comment">// per ora gestisco solo i Raster32</span></div>
<div class="line"><span class="lineno"> 1250</span> </div>
<div class="line"><span class="lineno"> 1251</span>  myregions.clear();</div>
<div class="line"><span class="lineno"> 1252</span> </div>
<div class="line"><span class="lineno"> 1253</span>  raster32-&gt;lock();</div>
<div class="line"><span class="lineno"> 1254</span> </div>
<div class="line"><span class="lineno"> 1255</span>  <span class="comment">/*- 初期化 -*/</span></div>
<div class="line"><span class="lineno"> 1256</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 256; i++) {</div>
<div class="line"><span class="lineno"> 1257</span>    QList&lt;int&gt; tmpVec;</div>
<div class="line"><span class="lineno"> 1258</span>    myHistogram.push_back(tmpVec);</div>
<div class="line"><span class="lineno"> 1259</span>  }</div>
<div class="line"><span class="lineno"> 1260</span> </div>
<div class="line"><span class="lineno"> 1261</span>  <span class="keywordflow">if</span> (!do_source_gradation) <span class="comment">/*- 1階調の場合 -*/</span></div>
<div class="line"><span class="lineno"> 1262</span>  {</div>
<div class="line"><span class="lineno"> 1263</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> po = 0; po &lt; particleOrigins.size(); po++) {</div>
<div class="line"><span class="lineno"> 1264</span>      <span class="keywordtype">int</span> index_x = (int)particleOrigins.at(po).pixPos[0];</div>
<div class="line"><span class="lineno"> 1265</span>      <span class="keywordtype">int</span> index_y = (int)particleOrigins.at(po).pixPos[1];</div>
<div class="line"><span class="lineno"> 1266</span>      <span class="keywordflow">if</span> (index_x &lt; 0)</div>
<div class="line"><span class="lineno"> 1267</span>        index_x = 0;</div>
<div class="line"><span class="lineno"> 1268</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index_x &gt;= raster32-&gt;getLx())</div>
<div class="line"><span class="lineno"> 1269</span>        index_x = raster32-&gt;getLx() - 1;</div>
<div class="line"><span class="lineno"> 1270</span>      <span class="keywordflow">if</span> (index_y &lt; 0) {</div>
<div class="line"><span class="lineno"> 1271</span>        index_y = 0;</div>
<div class="line"><span class="lineno"> 1272</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno"> 1273</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index_y &gt;= raster32-&gt;getLy()) {</div>
<div class="line"><span class="lineno"> 1274</span>        index_y = raster32-&gt;getLy() - 1;</div>
<div class="line"><span class="lineno"> 1275</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno"> 1276</span>      }</div>
<div class="line"><span class="lineno"> 1277</span>      TPixel32 *pix = raster32-&gt;pixels(index_y);</div>
<div class="line"><span class="lineno"> 1278</span>      pix += index_x;</div>
<div class="line"><span class="lineno"> 1279</span>      <span class="keywordflow">if</span> (pix-&gt;m &gt; threshold) {</div>
<div class="line"><span class="lineno"> 1280</span>        myHistogram[1].push_back(po);</div>
<div class="line"><span class="lineno"> 1281</span>        myregions.push_back(<a class="code hl_class" href="class_t_point_t.html">TPointD</a>(particleOrigins.at(po).pos[0],</div>
<div class="line"><span class="lineno"> 1282</span>                                    particleOrigins.at(po).pos[1]));</div>
<div class="line"><span class="lineno"> 1283</span>      }</div>
<div class="line"><span class="lineno"> 1284</span>    }</div>
<div class="line"><span class="lineno"> 1285</span>  }</div>
<div class="line"><span class="lineno"> 1286</span> </div>
<div class="line"><span class="lineno"> 1287</span>  <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1288</span>    <a class="code hl_class" href="class_t_random.html">TRandom</a> rand = <a class="code hl_class" href="class_t_random.html">TRandom</a>(1);</div>
<div class="line"><span class="lineno"> 1289</span> </div>
<div class="line"><span class="lineno"> 1290</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> po = 0; po &lt; particleOrigins.size(); po++) {</div>
<div class="line"><span class="lineno"> 1291</span>      <span class="keywordtype">int</span> index_x = (int)particleOrigins.at(po).pixPos[0];</div>
<div class="line"><span class="lineno"> 1292</span>      <span class="keywordtype">int</span> index_y = (int)particleOrigins.at(po).pixPos[1];</div>
<div class="line"><span class="lineno"> 1293</span>      <span class="keywordflow">if</span> (index_x &lt; 0)</div>
<div class="line"><span class="lineno"> 1294</span>        index_x = 0;</div>
<div class="line"><span class="lineno"> 1295</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index_x &gt;= raster32-&gt;getLx())</div>
<div class="line"><span class="lineno"> 1296</span>        index_x = raster32-&gt;getLx() - 1;</div>
<div class="line"><span class="lineno"> 1297</span>      <span class="keywordflow">if</span> (index_y &lt; 0)</div>
<div class="line"><span class="lineno"> 1298</span>        index_y = 0;</div>
<div class="line"><span class="lineno"> 1299</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index_y &gt;= raster32-&gt;getLy())</div>
<div class="line"><span class="lineno"> 1300</span>        index_y = raster32-&gt;getLy() - 1;</div>
<div class="line"><span class="lineno"> 1301</span> </div>
<div class="line"><span class="lineno"> 1302</span>      TPixel32 *pix = raster32-&gt;pixels(index_y);</div>
<div class="line"><span class="lineno"> 1303</span>      pix += index_x;</div>
<div class="line"><span class="lineno"> 1304</span>      <span class="keywordflow">if</span> (pix-&gt;m &gt; 0) {</div>
<div class="line"><span class="lineno"> 1305</span>        <span class="comment">/*-  Histogramの登録 -*/</span></div>
<div class="line"><span class="lineno"> 1306</span>        myHistogram[(int)pix-&gt;m].push_back(po);</div>
<div class="line"><span class="lineno"> 1307</span>        myregions.push_back(<a class="code hl_class" href="class_t_point_t.html">TPointD</a>(particleOrigins.at(po).pos[0],</div>
<div class="line"><span class="lineno"> 1308</span>                                    particleOrigins.at(po).pos[1]));</div>
<div class="line"><span class="lineno"> 1309</span>      }</div>
<div class="line"><span class="lineno"> 1310</span>    }</div>
<div class="line"><span class="lineno"> 1311</span>  }</div>
<div class="line"><span class="lineno"> 1312</span> </div>
<div class="line"><span class="lineno"> 1313</span>  raster32-&gt;unlock();</div>
<div class="line"><span class="lineno"> 1314</span>}</div>
<div class="ttc" id="aclass_t_random_html"><div class="ttname"><a href="class_t_random.html">TRandom</a></div><div class="ttdef"><b>Definition:</b> trandom.h:20</div></div>
<div class="ttc" id="anamespace_t_rop_html_a45a08fb48dd7d33ec629d722081d55c6"><div class="ttname"><a href="namespace_t_rop.html#a45a08fb48dd7d33ec629d722081d55c6">TRop::convert</a></div><div class="ttdeci">DVAPI void convert(TRasterP dst, const TRasterP &amp;src)</div><div class="ttdoc">Convert src raster in raster type dst.</div><div class="ttdef"><b>Definition:</b> tconvert.cpp:336</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a9347cf024c68197dc31ae7b941c43d69" name="a9347cf024c68197dc31ae7b941c43d69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9347cf024c68197dc31ae7b941c43d69">&#9670;&nbsp;</a></span>fill_subregions()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::fill_subregions </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cont_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1218</span>               {</div>
<div class="line"><span class="lineno"> 1219</span>  <span class="keywordtype">int</span> regioncounter = 0;</div>
<div class="line"><span class="lineno"> 1220</span> </div>
<div class="line"><span class="lineno"> 1221</span>  <span class="keywordtype">int</span> lx = ctrl1-&gt;getRaster()-&gt;getLx();</div>
<div class="line"><span class="lineno"> 1222</span>  <span class="keywordtype">int</span> ly = ctrl1-&gt;getRaster()-&gt;getLy();</div>
<div class="line"><span class="lineno"> 1223</span> </div>
<div class="line"><span class="lineno"> 1224</span>  std::vector&lt;int&gt; myarray(lx * ly);</div>
<div class="line"><span class="lineno"> 1225</span>  std::vector&lt;int&gt; lista;</div>
<div class="line"><span class="lineno"> 1226</span>  std::vector&lt;int&gt; listb;</div>
<div class="line"><span class="lineno"> 1227</span> </div>
<div class="line"><span class="lineno"> 1228</span>  fill_array(ctrl1, regioncounter, myarray, lista, listb, thres);</div>
<div class="line"><span class="lineno"> 1229</span> </div>
<div class="line"><span class="lineno"> 1230</span>  <span class="keywordflow">if</span> (regioncounter) {</div>
<div class="line"><span class="lineno"> 1231</span>    std::vector&lt;int&gt; <span class="keyword">final</span>(regioncounter + 1);</div>
<div class="line"><span class="lineno"> 1232</span>    normalize_array(myregions, ctrl1-&gt;m_pos, lx, ly, regioncounter, myarray,</div>
<div class="line"><span class="lineno"> 1233</span>                    lista, listb, <span class="keyword">final</span>);</div>
<div class="line"><span class="lineno"> 1234</span>  }</div>
<div class="line"><span class="lineno"> 1235</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a30ef592c2470d1c4937337494bc9ed47" name="a30ef592c2470d1c4937337494bc9ed47"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a30ef592c2470d1c4937337494bc9ed47">&#9670;&nbsp;</a></span>fill_value_struct()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::fill_value_struct </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>value</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frame</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   53</span>                                                           {</div>
<div class="line"><span class="lineno">   54</span>  myvalues.source_ctrl_val     = m_parent-&gt;source_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   55</span>  myvalues.bright_thres_val    = m_parent-&gt;bright_thres_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   56</span>  myvalues.x_pos_val           = m_parent-&gt;center_val-&gt;getValue(frame).x;</div>
<div class="line"><span class="lineno">   57</span>  myvalues.y_pos_val           = m_parent-&gt;center_val-&gt;getValue(frame).y;</div>
<div class="line"><span class="lineno">   58</span>  myvalues.length_val          = m_parent-&gt;length_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   59</span>  myvalues.height_val          = m_parent-&gt;height_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   60</span>  myvalues.maxnum_val          = m_parent-&gt;maxnum_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   61</span>  myvalues.lifetime_val        = m_parent-&gt;lifetime_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   62</span>  myvalues.lifetime_ctrl_val   = m_parent-&gt;lifetime_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   63</span>  myvalues.column_lifetime_val = m_parent-&gt;column_lifetime_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   64</span>  myvalues.startpos_val        = m_parent-&gt;startpos_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   65</span>  myvalues.randseed_val        = m_parent-&gt;randseed_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   66</span>  myvalues.gravity_val         = m_parent-&gt;gravity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   67</span>  myvalues.g_angle_val         = m_parent-&gt;g_angle_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   68</span>  myvalues.gravity_ctrl_val    = m_parent-&gt;gravity_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   69</span>  myvalues.friction_val        = m_parent-&gt;friction_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   70</span>  myvalues.friction_ctrl_val   = m_parent-&gt;friction_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   71</span>  myvalues.windint_val         = m_parent-&gt;windint_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   72</span>  myvalues.windangle_val       = m_parent-&gt;windangle_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   73</span>  myvalues.swingmode_val       = m_parent-&gt;swingmode_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   74</span>  myvalues.randomx_val         = m_parent-&gt;randomx_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   75</span>  myvalues.randomy_val         = m_parent-&gt;randomy_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   76</span>  myvalues.randomx_ctrl_val    = m_parent-&gt;randomx_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   77</span>  myvalues.randomy_ctrl_val    = m_parent-&gt;randomy_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   78</span>  myvalues.swing_val           = m_parent-&gt;swing_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   79</span>  myvalues.speed_val           = m_parent-&gt;speed_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   80</span>  myvalues.speed_ctrl_val      = m_parent-&gt;speed_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   81</span>  myvalues.speeda_val          = m_parent-&gt;speeda_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   82</span>  myvalues.speeda_ctrl_val     = m_parent-&gt;speeda_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   83</span>  myvalues.speeda_use_gradient_val =</div>
<div class="line"><span class="lineno">   84</span>      m_parent-&gt;speeda_use_gradient_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   85</span>  myvalues.speedscale_val     = m_parent-&gt;speedscale_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   86</span>  myvalues.toplayer_val       = m_parent-&gt;toplayer_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   87</span>  myvalues.mass_val           = m_parent-&gt;mass_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   88</span>  myvalues.scale_val          = m_parent-&gt;scale_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   89</span>  myvalues.scale_ctrl_val     = m_parent-&gt;scale_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   90</span>  myvalues.scale_ctrl_all_val = m_parent-&gt;scale_ctrl_all_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   91</span>  myvalues.rot_val            = m_parent-&gt;rot_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   92</span>  myvalues.rot_ctrl_val       = m_parent-&gt;rot_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   93</span>  myvalues.trail_val          = m_parent-&gt;trail_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   94</span>  myvalues.trailstep_val      = m_parent-&gt;trailstep_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   95</span>  myvalues.rotswingmode_val   = m_parent-&gt;rotswingmode_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   96</span>  myvalues.rotspeed_val       = m_parent-&gt;rotspeed_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   97</span>  myvalues.rotsca_val         = m_parent-&gt;rotsca_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   98</span>  myvalues.rotswing_val       = m_parent-&gt;rotswing_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   99</span>  myvalues.pathaim_val        = m_parent-&gt;pathaim_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  100</span>  myvalues.opacity_val        = m_parent-&gt;opacity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  101</span>  myvalues.opacity_ctrl_val   = m_parent-&gt;opacity_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  102</span>  myvalues.trailopacity_val   = m_parent-&gt;trailopacity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  103</span>  myvalues.scalestep_val      = m_parent-&gt;scalestep_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  104</span>  myvalues.scalestep_ctrl_val = m_parent-&gt;scalestep_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  105</span>  myvalues.fadein_val         = m_parent-&gt;fadein_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  106</span>  myvalues.fadeout_val        = m_parent-&gt;fadeout_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  107</span>  myvalues.animation_val      = m_parent-&gt;animation_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  108</span>  myvalues.step_val           = m_parent-&gt;step_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  109</span> </div>
<div class="line"><span class="lineno">  110</span>  myvalues.gencol_val         = m_parent-&gt;gencol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  111</span>  myvalues.gencol_ctrl_val    = m_parent-&gt;gencol_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  112</span>  myvalues.gencol_spread_val  = m_parent-&gt;gencol_spread_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  113</span>  myvalues.genfadecol_val     = m_parent-&gt;genfadecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  114</span>  myvalues.fincol_val         = m_parent-&gt;fincol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  115</span>  myvalues.fincol_ctrl_val    = m_parent-&gt;fincol_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  116</span>  myvalues.fincol_spread_val  = m_parent-&gt;fincol_spread_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  117</span>  myvalues.finrangecol_val    = m_parent-&gt;finrangecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  118</span>  myvalues.finfadecol_val     = m_parent-&gt;finfadecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  119</span>  myvalues.foutcol_val        = m_parent-&gt;foutcol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  120</span>  myvalues.foutcol_ctrl_val   = m_parent-&gt;foutcol_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  121</span>  myvalues.foutcol_spread_val = m_parent-&gt;foutcol_spread_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  122</span>  myvalues.foutrangecol_val   = m_parent-&gt;foutrangecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  123</span>  myvalues.foutfadecol_val    = m_parent-&gt;foutfadecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  124</span> </div>
<div class="line"><span class="lineno">  125</span>  myvalues.source_gradation_val = m_parent-&gt;source_gradation_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  126</span>  myvalues.pick_color_for_every_frame_val =</div>
<div class="line"><span class="lineno">  127</span>      m_parent-&gt;pick_color_for_every_frame_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  128</span>  <span class="comment">/*- 計算モード （背景＋粒子／粒子／背景／照明された粒子） -*/</span></div>
<div class="line"><span class="lineno">  129</span>  myvalues.iw_rendermode_val = m_parent-&gt;iw_rendermode_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  130</span>  <span class="comment">/*- 粒子に貼られる絵の素材 -*/</span></div>
<div class="line"><span class="lineno">  131</span>  myvalues.base_ctrl_val = m_parent-&gt;base_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  132</span>  <span class="comment">/*- カールノイズ的な動きを与える -*/</span></div>
<div class="line"><span class="lineno">  133</span>  myvalues.curl_val        = m_parent-&gt;curl_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  134</span>  myvalues.curl_ctrl_1_val = m_parent-&gt;curl_ctrl_1_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  135</span>  myvalues.curl_ctrl_2_val = m_parent-&gt;curl_ctrl_2_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  136</span>  <span class="comment">/*- 粒子敷き詰め。粒子を正三角形で敷き詰めたときの、</span></div>
<div class="line"><span class="lineno">  137</span><span class="comment">          正三角形の一辺の長さをインチで指定する -*/</span></div>
<div class="line"><span class="lineno">  138</span>  myvalues.iw_triangleSize = m_parent-&gt;iw_triangleSize-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  139</span>  <span class="comment">/*- ひらひら回転 -*/</span></div>
<div class="line"><span class="lineno">  140</span>  myvalues.flap_ctrl_val = m_parent-&gt;flap_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  141</span>  myvalues.iw_flap_velocity_val =</div>
<div class="line"><span class="lineno">  142</span>      m_parent-&gt;iw_flap_velocity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  143</span>  myvalues.iw_flap_dir_sensitivity_val =</div>
<div class="line"><span class="lineno">  144</span>      m_parent-&gt;iw_flap_dir_sensitivity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  145</span>  <span class="comment">/*- ひらひら粒子に照明を当てる normalize_values()内で Degree → Radian 化する</span></div>
<div class="line"><span class="lineno">  146</span><span class="comment">   * -*/</span></div>
<div class="line"><span class="lineno">  147</span>  myvalues.iw_light_theta_val = m_parent-&gt;iw_light_theta_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  148</span>  myvalues.iw_light_phi_val   = m_parent-&gt;iw_light_phi_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  149</span>  <span class="comment">/*- 読み込みマージン -*/</span></div>
<div class="line"><span class="lineno">  150</span>  myvalues.margin_val = m_parent-&gt;margin_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  151</span>  <span class="comment">/*- 重力を徐々に与えるためのフレーム長 -*/</span></div>
<div class="line"><span class="lineno">  152</span>  myvalues.iw_gravityBufferFrame_val =</div>
<div class="line"><span class="lineno">  153</span>      m_parent-&gt;iw_gravityBufferFrame_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  154</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af14be8ae622e83cbf950d60b9030317a" name="af14be8ae622e83cbf950d60b9030317a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af14be8ae622e83cbf950d60b9030317a">&#9670;&nbsp;</a></span>getInitSourceFrame()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char Iwa_Particles_Engine::getInitSourceFrame </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>first</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>last</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1429</span>                                                         {</div>
<div class="line"><span class="lineno"> 1430</span>  <span class="keywordflow">switch</span> (values.animation_val) {</div>
<div class="line"><span class="lineno"> 1431</span>  <span class="keywordflow">case</span> Iwa_TiledParticlesFx::ANIM_CYCLE:</div>
<div class="line"><span class="lineno"> 1432</span>  <span class="keywordflow">case</span> Iwa_TiledParticlesFx::ANIM_S_CYCLE:</div>
<div class="line"><span class="lineno"> 1433</span>    <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)first;</div>
<div class="line"><span class="lineno"> 1434</span> </div>
<div class="line"><span class="lineno"> 1435</span>  <span class="keywordflow">case</span> Iwa_TiledParticlesFx::ANIM_SR_CYCLE:</div>
<div class="line"><span class="lineno"> 1436</span>    <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(first +</div>
<div class="line"><span class="lineno"> 1437</span>                           (values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>()) * (last - first));</div>
<div class="line"><span class="lineno"> 1438</span> </div>
<div class="line"><span class="lineno"> 1439</span>  <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno"> 1440</span>    <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(first +</div>
<div class="line"><span class="lineno"> 1441</span>                           (values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>()) * (last - first));</div>
<div class="line"><span class="lineno"> 1442</span>  }</div>
<div class="line"><span class="lineno"> 1443</span>}</div>
<div class="ttc" id="aclass_t_random_html_a3a7f6b3a8992fcde5b0c5e8bd2049e41"><div class="ttname"><a href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">TRandom::getFloat</a></div><div class="ttdeci">float getFloat()</div><div class="ttdef"><b>Definition:</b> trandom.cpp:100</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1fa9cc79320c7b8c6e5cb60f45caeea0" name="a1fa9cc79320c7b8c6e5cb60f45caeea0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1fa9cc79320c7b8c6e5cb60f45caeea0">&#9670;&nbsp;</a></span>initParticleOrigins()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::initParticleOrigins </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_rect_t.html">TRectD</a> &amp;&#160;</td>
          <td class="paramname"><em>outTileBBox</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>particleOrigins</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_affine.html">TAffine</a>&#160;</td>
          <td class="paramname"><em>affine</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>level_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pixelMargin</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1329</span>                        {</div>
<div class="line"><span class="lineno"> 1330</span>  <span class="comment">/*- 敷き詰め三角形の一辺の長さをピクセル単位に換算する -*/</span></div>
<div class="line"><span class="lineno"> 1331</span>  <a class="code hl_class" href="class_t_point_t.html">TPointD</a> vect(values.iw_triangleSize, 0.0);</div>
<div class="line"><span class="lineno"> 1332</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> aff(affine);</div>
<div class="line"><span class="lineno"> 1333</span>  aff.a13 = aff.a23 = 0;</div>
<div class="line"><span class="lineno"> 1334</span>  vect              = aff * vect;</div>
<div class="line"><span class="lineno"> 1335</span>  <span class="keywordtype">double</span> triPixSize = sqrt(vect.x * vect.x + vect.y * vect.y);</div>
<div class="line"><span class="lineno"> 1336</span> </div>
<div class="line"><span class="lineno"> 1337</span>  <span class="keywordtype">double</span> pix2Inch = values.iw_triangleSize / triPixSize;</div>
<div class="line"><span class="lineno"> 1338</span> </div>
<div class="line"><span class="lineno"> 1339</span>  <span class="comment">/*- 横方向の移動距離 -*/</span></div>
<div class="line"><span class="lineno"> 1340</span>  <span class="keywordtype">double</span> d_hori = values.iw_triangleSize * 0.5;</div>
<div class="line"><span class="lineno"> 1341</span>  <span class="comment">/*- 縦方向の移動距離 -*/</span></div>
<div class="line"><span class="lineno"> 1342</span>  <span class="keywordtype">double</span> d_vert = values.iw_triangleSize * 0.8660254;</div>
<div class="line"><span class="lineno"> 1343</span>  <span class="comment">/*- 正三角形を横に上下交互に並べたときの、中心位置のオフセット -*/</span></div>
<div class="line"><span class="lineno"> 1344</span>  <span class="keywordtype">double</span> vOffset = values.iw_triangleSize * 0.14433758;</div>
<div class="line"><span class="lineno"> 1345</span> </div>
<div class="line"><span class="lineno"> 1346</span>  <span class="comment">/*- ピクセル位置の方も格納する -*/</span></div>
<div class="line"><span class="lineno"> 1347</span>  <span class="keywordtype">double</span> d_hori_pix  = triPixSize * 0.5;</div>
<div class="line"><span class="lineno"> 1348</span>  <span class="keywordtype">double</span> d_vert_pix  = triPixSize * 0.8660254;</div>
<div class="line"><span class="lineno"> 1349</span>  <span class="keywordtype">double</span> vOffset_pix = triPixSize * 0.14433758;</div>
<div class="line"><span class="lineno"> 1350</span> </div>
<div class="line"><span class="lineno"> 1351</span>  <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> inchBBox(</div>
<div class="line"><span class="lineno"> 1352</span>      resourceTileBBox.x0 * pix2Inch, resourceTileBBox.y0 * pix2Inch,</div>
<div class="line"><span class="lineno"> 1353</span>      resourceTileBBox.x1 * pix2Inch, resourceTileBBox.y1 * pix2Inch);</div>
<div class="line"><span class="lineno"> 1354</span>  <span class="comment">/*- インチ位置のスタート -*/</span></div>
<div class="line"><span class="lineno"> 1355</span>  <span class="keywordtype">double</span> curr_y = inchBBox.y0;</div>
<div class="line"><span class="lineno"> 1356</span>  <span class="comment">/*- 行の1列目のタテのオフセット値 -*/</span></div>
<div class="line"><span class="lineno"> 1357</span>  <span class="keywordtype">double</span> startOff = -vOffset;</div>
<div class="line"><span class="lineno"> 1358</span> </div>
<div class="line"><span class="lineno"> 1359</span>  <span class="comment">/*- ピクセル位置のスタート -*/</span></div>
<div class="line"><span class="lineno"> 1360</span>  <span class="keywordtype">double</span> curr_y_pix   = 0.0;</div>
<div class="line"><span class="lineno"> 1361</span>  <span class="keywordtype">double</span> startOff_pix = -vOffset_pix;</div>
<div class="line"><span class="lineno"> 1362</span> </div>
<div class="line"><span class="lineno"> 1363</span>  <span class="comment">/*- メモリの見積もり -*/</span></div>
<div class="line"><span class="lineno"> 1364</span>  <span class="keywordtype">int</span> gridSize;</div>
<div class="line"><span class="lineno"> 1365</span>  {</div>
<div class="line"><span class="lineno"> 1366</span>    <span class="keywordtype">int</span> ySize = 0;</div>
<div class="line"><span class="lineno"> 1367</span>    <span class="keywordflow">while</span> (curr_y &lt;= inchBBox.y1 + d_vert * 0.5) {</div>
<div class="line"><span class="lineno"> 1368</span>      curr_y += d_vert;</div>
<div class="line"><span class="lineno"> 1369</span>      ySize++;</div>
<div class="line"><span class="lineno"> 1370</span>    }</div>
<div class="line"><span class="lineno"> 1371</span>    <span class="keywordtype">int</span> xSize     = 0;</div>
<div class="line"><span class="lineno"> 1372</span>    <span class="keywordtype">double</span> curr_x = inchBBox.x0;</div>
<div class="line"><span class="lineno"> 1373</span>    <span class="keywordflow">while</span> (curr_x &lt;= inchBBox.x1 + d_hori * 0.5) {</div>
<div class="line"><span class="lineno"> 1374</span>      curr_x += d_hori;</div>
<div class="line"><span class="lineno"> 1375</span>      xSize++;</div>
<div class="line"><span class="lineno"> 1376</span>    }</div>
<div class="line"><span class="lineno"> 1377</span>    gridSize = xSize * ySize;</div>
<div class="line"><span class="lineno"> 1378</span>  }</div>
<div class="line"><span class="lineno"> 1379</span>  curr_y = inchBBox.y0;</div>
<div class="line"><span class="lineno"> 1380</span>  particleOrigins.reserve(gridSize);</div>
<div class="line"><span class="lineno"> 1381</span> </div>
<div class="line"><span class="lineno"> 1382</span>  <span class="comment">/*- タテでループ -*/</span></div>
<div class="line"><span class="lineno"> 1383</span>  <span class="keywordflow">while</span> (curr_y &lt;=</div>
<div class="line"><span class="lineno"> 1384</span>         inchBBox.y1 +</div>
<div class="line"><span class="lineno"> 1385</span>             d_vert *</div>
<div class="line"><span class="lineno"> 1386</span>                 0.5) <span class="comment">/* ←d_vert * 0.5 は最後の一行を敷き詰めるための追加分 -*/</span></div>
<div class="line"><span class="lineno"> 1387</span>  {</div>
<div class="line"><span class="lineno"> 1388</span>    <span class="keywordtype">double</span> curr_x = inchBBox.x0;</div>
<div class="line"><span class="lineno"> 1389</span>    <span class="keywordtype">double</span> off    = startOff;</div>
<div class="line"><span class="lineno"> 1390</span>    <span class="comment">/*- 三角形が上下どっちを向いているかのフラグ -*/</span></div>
<div class="line"><span class="lineno"> 1391</span>    <span class="keywordtype">bool</span> isUp = (off &lt; 0);</div>
<div class="line"><span class="lineno"> 1392</span> </div>
<div class="line"><span class="lineno"> 1393</span>    <span class="comment">/*- ピクセル位置のスタート -*/</span></div>
<div class="line"><span class="lineno"> 1394</span>    <span class="keywordtype">double</span> curr_x_pix = 0.0;</div>
<div class="line"><span class="lineno"> 1395</span>    <span class="keywordtype">double</span> off_pix    = startOff_pix;</div>
<div class="line"><span class="lineno"> 1396</span> </div>
<div class="line"><span class="lineno"> 1397</span>    <span class="comment">/*- ヨコでループ -*/</span></div>
<div class="line"><span class="lineno"> 1398</span>    <span class="keywordflow">while</span> (curr_x &lt;= inchBBox.x1 + d_hori * 0.5) {</div>
<div class="line"><span class="lineno"> 1399</span>      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> level =</div>
<div class="line"><span class="lineno"> 1400</span>          (<span class="keywordtype">unsigned</span> char)(values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * level_n);</div>
<div class="line"><span class="lineno"> 1401</span>      particleOrigins.append(<a class="code hl_struct" href="struct_particle_origin.html">ParticleOrigin</a>(</div>
<div class="line"><span class="lineno"> 1402</span>          curr_x, curr_y + off, values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>(), isUp, level,</div>
<div class="line"><span class="lineno"> 1403</span>          getInitSourceFrame(values, 0, lastframe[level]),</div>
<div class="line"><span class="lineno"> 1404</span>          (<span class="keywordtype">short</span> int)tround(curr_x_pix),</div>
<div class="line"><span class="lineno"> 1405</span>          (<span class="keywordtype">short</span> int)tround(curr_y_pix + off_pix)));</div>
<div class="line"><span class="lineno"> 1406</span> </div>
<div class="line"><span class="lineno"> 1407</span>      off = -off;</div>
<div class="line"><span class="lineno"> 1408</span>      curr_x += d_hori;</div>
<div class="line"><span class="lineno"> 1409</span>      isUp = !isUp;</div>
<div class="line"><span class="lineno"> 1410</span> </div>
<div class="line"><span class="lineno"> 1411</span>      off_pix = -off_pix;</div>
<div class="line"><span class="lineno"> 1412</span>      curr_x_pix += d_hori_pix;</div>
<div class="line"><span class="lineno"> 1413</span>    }</div>
<div class="line"><span class="lineno"> 1414</span> </div>
<div class="line"><span class="lineno"> 1415</span>    startOff = -startOff;</div>
<div class="line"><span class="lineno"> 1416</span>    curr_y += d_vert;</div>
<div class="line"><span class="lineno"> 1417</span> </div>
<div class="line"><span class="lineno"> 1418</span>    startOff_pix = -startOff_pix;</div>
<div class="line"><span class="lineno"> 1419</span>    curr_y_pix += d_vert_pix;</div>
<div class="line"><span class="lineno"> 1420</span>  }</div>
<div class="line"><span class="lineno"> 1421</span> </div>
<div class="line"><span class="lineno"> 1422</span>  <span class="comment">/*- 粒子をランダム値の大きい順に並べる -*/</span></div>
<div class="line"><span class="lineno"> 1423</span>  std::sort(particleOrigins.begin(), particleOrigins.end(), potentialLessThan);</div>
<div class="line"><span class="lineno"> 1424</span>}</div>
<div class="ttc" id="astruct_particle_origin_html"><div class="ttname"><a href="struct_particle_origin.html">ParticleOrigin</a></div><div class="ttdef"><b>Definition:</b> iwa_particlesengine.h:24</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a0e9c35ba4d075060740ab334393d8e7d" name="a0e9c35ba4d075060740ab334393d8e7d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0e9c35ba4d075060740ab334393d8e7d">&#9670;&nbsp;</a></span>normalize_array()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::normalize_array </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a>&#160;</td>
          <td class="paramname"><em>pos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>lx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>ly</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>regioncounter</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>myarray</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>lista</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>listb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>final</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1152</span>                                                   {</div>
<div class="line"><span class="lineno"> 1153</span>  <span class="keywordtype">int</span> i, j, k, l;</div>
<div class="line"><span class="lineno"> 1154</span> </div>
<div class="line"><span class="lineno"> 1155</span>  std::vector&lt;int&gt; tmp;</div>
<div class="line"><span class="lineno"> 1156</span>  <span class="keywordtype">int</span> maxregioncounter = 0;</div>
<div class="line"><span class="lineno"> 1157</span>  <span class="keywordtype">int</span> listsize         = (int)lista.size();</div>
<div class="line"><span class="lineno"> 1158</span>  <span class="comment">// TMSG_INFO(&quot;regioncounter %d, eqcount=%d\n&quot;, regioncounter, eqcount);</span></div>
<div class="line"><span class="lineno"> 1159</span>  <span class="keywordflow">for</span> (k = 1; k &lt;= regioncounter; k++) <span class="keyword">final</span>[k] = k;</div>
<div class="line"><span class="lineno"> 1160</span> </div>
<div class="line"><span class="lineno"> 1161</span>  <span class="keywordflow">for</span> (l = 0; l &lt; listsize; l++) {</div>
<div class="line"><span class="lineno"> 1162</span>    j = lista[l];</div>
<div class="line"><span class="lineno"> 1163</span>    <span class="comment">/*TMSG_INFO(&quot;j vale %d\n&quot;, j);*/</span></div>
<div class="line"><span class="lineno"> 1164</span>    <span class="keywordflow">while</span> (<span class="keyword">final</span>[j] != j) j = <span class="keyword">final</span>[j];</div>
<div class="line"><span class="lineno"> 1165</span>    k                       = listb[l];</div>
<div class="line"><span class="lineno"> 1166</span>    <span class="comment">/*TMSG_INFO(&quot;k vale %d\n&quot;, k);*/</span></div>
<div class="line"><span class="lineno"> 1167</span>    <span class="keywordflow">while</span> (<span class="keyword">final</span>[k] != k) k = <span class="keyword">final</span>[k];</div>
<div class="line"><span class="lineno"> 1168</span>    <span class="keywordflow">if</span> (j != k) <span class="keyword">final</span>[j]    = k;</div>
<div class="line"><span class="lineno"> 1169</span>  }</div>
<div class="line"><span class="lineno"> 1170</span>  <span class="comment">// TMSG_INFO(&quot;esco dal for\n&quot;);</span></div>
<div class="line"><span class="lineno"> 1171</span>  <span class="keywordflow">for</span> (j                                         = 1; j &lt;= regioncounter; j++)</div>
<div class="line"><span class="lineno"> 1172</span>    <span class="keywordflow">while</span> (<span class="keyword">final</span>[j] != <span class="keyword">final</span>[<span class="keyword">final</span>[j]]) <span class="keyword">final</span>[j] = <span class="keyword">final</span>[<span class="keyword">final</span>[j]];</div>
<div class="line"><span class="lineno"> 1173</span> </div>
<div class="line"><span class="lineno"> 1174</span>  <span class="comment">/*conto quante cavolo di regioni sono*/</span></div>
<div class="line"><span class="lineno"> 1175</span> </div>
<div class="line"><span class="lineno"> 1176</span>  tmp.push_back(<span class="keyword">final</span>[1]);</div>
<div class="line"><span class="lineno"> 1177</span>  maxregioncounter = 1;</div>
<div class="line"><span class="lineno"> 1178</span>  <span class="keywordflow">for</span> (i = 2; i &lt;= regioncounter; i++) {</div>
<div class="line"><span class="lineno"> 1179</span>    <span class="keywordtype">int</span> diff = 1;</div>
<div class="line"><span class="lineno"> 1180</span>    <span class="keywordflow">for</span> (j = 0; j &lt; maxregioncounter; j++) {</div>
<div class="line"><span class="lineno"> 1181</span>      <span class="keywordflow">if</span> (tmp[j] == <span class="keyword">final</span>[i]) {</div>
<div class="line"><span class="lineno"> 1182</span>        diff = 0;</div>
<div class="line"><span class="lineno"> 1183</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno"> 1184</span>      }</div>
<div class="line"><span class="lineno"> 1185</span>    }</div>
<div class="line"><span class="lineno"> 1186</span>    <span class="keywordflow">if</span> (diff) {</div>
<div class="line"><span class="lineno"> 1187</span>      tmp.push_back(<span class="keyword">final</span>[i]);</div>
<div class="line"><span class="lineno"> 1188</span>      maxregioncounter++;</div>
<div class="line"><span class="lineno"> 1189</span>    }</div>
<div class="line"><span class="lineno"> 1190</span>  }</div>
<div class="line"><span class="lineno"> 1191</span> </div>
<div class="line"><span class="lineno"> 1192</span>  myregions.resize(maxregioncounter);</div>
<div class="line"><span class="lineno"> 1193</span>  <span class="keywordflow">for</span> (j = 0; j &lt; ly; j++) {</div>
<div class="line"><span class="lineno"> 1194</span>    <span class="keywordflow">for</span> (i = 0; i &lt; lx; i++) {</div>
<div class="line"><span class="lineno"> 1195</span>      <span class="keywordtype">int</span> tmpindex;</div>
<div class="line"><span class="lineno"> 1196</span>      <span class="keywordflow">if</span> (myarray[i + lx * j]) {</div>
<div class="line"><span class="lineno"> 1197</span>        tmpindex = <span class="keyword">final</span>[myarray[i + lx * j]];</div>
<div class="line"><span class="lineno"> 1198</span>        <span class="comment">/*TMSG_INFO(&quot;tmpindex=%d\n&quot;, tmpindex);*/</span></div>
<div class="line"><span class="lineno"> 1199</span>        <span class="keywordflow">for</span> (k = 0; k &lt; maxregioncounter; k++) {</div>
<div class="line"><span class="lineno"> 1200</span>          <span class="keywordflow">if</span> (tmp[k] == tmpindex) <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno"> 1201</span>        }</div>
<div class="line"><span class="lineno"> 1202</span>        <span class="comment">/*TMSG_INFO(&quot;k=%d\n&quot;, k);*/</span></div>
<div class="line"><span class="lineno"> 1203</span>        <a class="code hl_class" href="class_t_point_t.html">TPointD</a> tmppoint;</div>
<div class="line"><span class="lineno"> 1204</span>        tmppoint.x = i;</div>
<div class="line"><span class="lineno"> 1205</span>        tmppoint.y = j;</div>
<div class="line"><span class="lineno"> 1206</span>        tmppoint += pos;</div>
<div class="line"><span class="lineno"> 1207</span>        myregions[k].push_back(tmppoint);</div>
<div class="line"><span class="lineno"> 1208</span>      }</div>
<div class="line"><span class="lineno"> 1209</span>    }</div>
<div class="line"><span class="lineno"> 1210</span>  }</div>
<div class="line"><span class="lineno"> 1211</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a0dc44ec341ee6f217096797da28dc886" name="a0dc44ec341ee6f217096797da28dc886"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0dc44ec341ee6f217096797da28dc886">&#9670;&nbsp;</a></span>normalize_values()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::normalize_values </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  459</span>                                                                       {</div>
<div class="line"><span class="lineno">  460</span>  <span class="keywordtype">double</span> dpicorr = 1;</div>
<div class="line"><span class="lineno">  461</span>  <a class="code hl_class" href="class_t_point_t.html">TPointD</a> pos(values.x_pos_val, values.y_pos_val);</div>
<div class="line"><span class="lineno">  462</span> </div>
<div class="line"><span class="lineno">  463</span>  (values.x_pos_val)               = pos.x;</div>
<div class="line"><span class="lineno">  464</span>  (values.y_pos_val)               = pos.y;</div>
<div class="line"><span class="lineno">  465</span>  (values.length_val)              = (values.length_val) * dpicorr;</div>
<div class="line"><span class="lineno">  466</span>  (values.height_val)              = (values.height_val) * dpicorr;</div>
<div class="line"><span class="lineno">  467</span>  (values.gravity_val)             = (values.gravity_val) * dpicorr * 0.1;</div>
<div class="line"><span class="lineno">  468</span>  (values.windint_val)             = (values.windint_val) * dpicorr;</div>
<div class="line"><span class="lineno">  469</span>  (values.speed_val.first)         = (values.speed_val.first) * dpicorr;</div>
<div class="line"><span class="lineno">  470</span>  (values.speed_val.second)        = (values.speed_val.second) * dpicorr;</div>
<div class="line"><span class="lineno">  471</span>  (values.randomx_val.first)       = (values.randomx_val.first) * dpicorr;</div>
<div class="line"><span class="lineno">  472</span>  (values.randomx_val.second)      = (values.randomx_val.second) * dpicorr;</div>
<div class="line"><span class="lineno">  473</span>  (values.randomy_val.first)       = (values.randomy_val.first) * dpicorr;</div>
<div class="line"><span class="lineno">  474</span>  (values.randomy_val.second)      = (values.randomy_val.second) * dpicorr;</div>
<div class="line"><span class="lineno">  475</span>  (values.scale_val.first)         = (values.scale_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  476</span>  (values.scale_val.second)        = (values.scale_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  477</span>  (values.scalestep_val.first)     = (values.scalestep_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  478</span>  (values.scalestep_val.second)    = (values.scalestep_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  479</span>  (values.opacity_val.first)       = (values.opacity_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  480</span>  (values.opacity_val.second)      = (values.opacity_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  481</span>  (values.trailopacity_val.first)  = (values.trailopacity_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  482</span>  (values.trailopacity_val.second) = (values.trailopacity_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  483</span>  (values.mblur_val)               = (values.mblur_val) * 0.01;</div>
<div class="line"><span class="lineno">  484</span>  (values.friction_val)            = -(values.friction_val) * 0.01;</div>
<div class="line"><span class="lineno">  485</span>  (values.windangle_val)           = (values.windangle_val) * M_PI_180;</div>
<div class="line"><span class="lineno">  486</span>  (values.g_angle_val)             = (values.g_angle_val + 180) * M_PI_180;</div>
<div class="line"><span class="lineno">  487</span>  (values.speeda_val.first)        = (values.speeda_val.first) * M_PI_180;</div>
<div class="line"><span class="lineno">  488</span>  (values.speeda_val.second)       = (values.speeda_val.second) * M_PI_180;</div>
<div class="line"><span class="lineno">  489</span>  <span class="keywordflow">if</span> (values.step_val &lt; 1) values.step_val = 1;</div>
<div class="line"><span class="lineno">  490</span>  values.genfadecol_val                    = (values.genfadecol_val) * 0.01;</div>
<div class="line"><span class="lineno">  491</span>  values.finfadecol_val                    = (values.finfadecol_val) * 0.01;</div>
<div class="line"><span class="lineno">  492</span>  values.foutfadecol_val                   = (values.foutfadecol_val) * 0.01;</div>
<div class="line"><span class="lineno">  493</span>  (values.curl_val)                        = (values.curl_val) * dpicorr * 0.1;</div>
<div class="line"><span class="lineno">  494</span>  <span class="comment">/*- ひらひら粒子に照明を当てる normalize_values()内で Degree → Radian 化する</span></div>
<div class="line"><span class="lineno">  495</span><span class="comment">   * -*/</span></div>
<div class="line"><span class="lineno">  496</span>  (values.iw_light_theta_val) = (values.iw_light_theta_val) * M_PI_180;</div>
<div class="line"><span class="lineno">  497</span>  (values.iw_light_phi_val)   = (values.iw_light_phi_val) * M_PI_180;</div>
<div class="line"><span class="lineno">  498</span>  <span class="comment">/*- 読み込みマージン -*/</span></div>
<div class="line"><span class="lineno">  499</span>  (values.margin_val) = (values.margin_val) * dpicorr;</div>
<div class="line"><span class="lineno">  500</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a207029f17f0782312898b862b3457830" name="a207029f17f0782312898b862b3457830"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a207029f17f0782312898b862b3457830">&#9670;&nbsp;</a></span>port_is_used()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Iwa_Particles_Engine::port_is_used </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  179</span>                                                                         {</div>
<div class="line"><span class="lineno">  180</span>  <span class="keywordflow">return</span> values.fincol_ctrl_val == i || values.foutcol_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  181</span>         values.friction_ctrl_val == i || values.gencol_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  182</span>         values.gravity_ctrl_val == i || values.opacity_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  183</span>         values.rot_ctrl_val == i || values.scale_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  184</span>         values.scalestep_ctrl_val == i || values.source_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  185</span>         values.speed_ctrl_val == i || values.speeda_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  186</span>         values.lifetime_ctrl_val == i || values.randomx_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  187</span>         values.randomy_ctrl_val == i || values.base_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  188</span>         values.curl_ctrl_1_val == i || values.curl_ctrl_2_val == i ||</div>
<div class="line"><span class="lineno">  189</span>         values.flap_ctrl_val == i;</div>
<div class="line"><span class="lineno">  190</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a27146e0ff733de70623ab1aebbb6bee0" name="a27146e0ff733de70623ab1aebbb6bee0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a27146e0ff733de70623ab1aebbb6bee0">&#9670;&nbsp;</a></span>render_particles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::render_particles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>part_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;&#160;</td>
          <td class="paramname"><em>p_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a> &amp;&#160;</td>
          <td class="paramname"><em>p_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; int, <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>ctrl_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt;&#160;</td>
          <td class="paramname"><em>partLevel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>dpi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>curr_frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>shrink</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>startx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>starty</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>endx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>endy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt;&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>fxId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  524</span>                        {</div>
<div class="line"><span class="lineno">  525</span>  <span class="comment">/*- 各種パーティクルのパラメータ -*/</span></div>
<div class="line"><span class="lineno">  526</span>  <span class="keyword">struct </span><a class="code hl_struct" href="structparticles__values.html">particles_values</a> values;</div>
<div class="line"><span class="lineno">  527</span>  memset(&amp;values, 0, <span class="keyword">sizeof</span>(values));</div>
<div class="line"><span class="lineno">  528</span>  <span class="comment">/*- 現在のフレームでの各パラメータを得る -*/</span></div>
<div class="line"><span class="lineno">  529</span>  fill_value_struct(values, m_frame);</div>
<div class="line"><span class="lineno">  530</span> </div>
<div class="line"><span class="lineno">  531</span>  <span class="keywordtype">int</span> frame, intpart = 0;</div>
<div class="line"><span class="lineno">  532</span> </div>
<div class="line"><span class="lineno">  533</span>  <span class="keywordtype">int</span> level_n = part_ports.size();</div>
<div class="line"><span class="lineno">  534</span>  <span class="comment">/*- 開始フレーム -*/</span></div>
<div class="line"><span class="lineno">  535</span>  <span class="keywordtype">int</span> startframe = (int)values.startpos_val;</div>
<div class="line"><span class="lineno">  536</span> </div>
<div class="line"><span class="lineno">  537</span>  <span class="keywordtype">float</span> dpicorr = dpi * 0.01f, fractpart = 0;</div>
<div class="line"><span class="lineno">  538</span> </div>
<div class="line"><span class="lineno">  539</span>  <span class="comment">/*- 不透明度の範囲（透明～不透明を 0～1 に正規化） -*/</span></div>
<div class="line"><span class="lineno">  540</span>  <span class="keywordtype">float</span> opacity_range =</div>
<div class="line"><span class="lineno">  541</span>      (values.opacity_val.second - values.opacity_val.first) * 0.01f;</div>
<div class="line"><span class="lineno">  542</span> </div>
<div class="line"><span class="lineno">  543</span>  <span class="keywordtype">bool</span> random_level = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  544</span> </div>
<div class="line"><span class="lineno">  545</span>  <span class="keywordtype">bool</span> isPrecomputingEnabled = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  546</span>  {</div>
<div class="line"><span class="lineno">  547</span>    <a class="code hl_class" href="class_t_renderer.html">TRenderer</a> renderer(<a class="code hl_function" href="class_t_renderer.html#a93afee3c1ce8ff2b753a05fa0fe3dc9d">TRenderer::instance</a>());</div>
<div class="line"><span class="lineno">  548</span>    isPrecomputingEnabled =</div>
<div class="line"><span class="lineno">  549</span>        (renderer &amp;&amp; renderer.isPrecomputingEnabled()) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  550</span>  }</div>
<div class="line"><span class="lineno">  551</span> </div>
<div class="line"><span class="lineno">  552</span>  <span class="comment">/*- シュリンクしている場合 -*/</span></div>
<div class="line"><span class="lineno">  553</span>  <span class="keywordtype">float</span> dpicorr_shrinked;</div>
<div class="line"><span class="lineno">  554</span>  <span class="keywordflow">if</span> (values.unit_val == Iwa_TiledParticlesFx::UNIT_SMALL_INCH)</div>
<div class="line"><span class="lineno">  555</span>    dpicorr_shrinked = dpicorr / shrink;</div>
<div class="line"><span class="lineno">  556</span>  <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  557</span>    dpicorr_shrinked = dpi / shrink;</div>
<div class="line"><span class="lineno">  558</span> </div>
<div class="line"><span class="lineno">  559</span>  std::map&lt;std::pair&lt;int, int&gt;, <span class="keywordtype">float</span>&gt; partScales;</div>
<div class="line"><span class="lineno">  560</span> </div>
<div class="line"><span class="lineno">  561</span>  <span class="comment">/*- 現在のフレームをステップ値にする -*/</span></div>
<div class="line"><span class="lineno">  562</span>  curr_frame = curr_frame / values.step_val;</div>
<div class="line"><span class="lineno">  563</span> </div>
<div class="line"><span class="lineno">  564</span>  <a class="code hl_class" href="class_iwa___particles_manager.html">Iwa_ParticlesManager</a> *pc = Iwa_ParticlesManager::instance();</div>
<div class="line"><span class="lineno">  565</span> </div>
<div class="line"><span class="lineno">  566</span>  <span class="keywordtype">bool</span> isFirstFrame = !(pc-&gt;isCached(fxId));</div>
<div class="line"><span class="lineno">  567</span> </div>
<div class="line"><span class="lineno">  568</span>  <span class="comment">// Retrieve the last rolled frame</span></div>
<div class="line"><span class="lineno">  569</span>  <a class="code hl_struct" href="struct_iwa___particles_manager_1_1_frame_data.html">Iwa_ParticlesManager::FrameData</a> *particlesData = pc-&gt;data(fxId);</div>
<div class="line"><span class="lineno">  570</span> </div>
<div class="line"><span class="lineno">  571</span>  std::list&lt;Iwa_Particle&gt; myParticles;</div>
<div class="line"><span class="lineno">  572</span>  <a class="code hl_class" href="class_t_random.html">TRandom</a> myRandom  = m_parent-&gt;randseed_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  573</span>  values.random_val = &amp;myRandom;</div>
<div class="line"><span class="lineno">  574</span> </div>
<div class="line"><span class="lineno">  575</span>  <span class="keywordtype">int</span> totalparticles = 0;</div>
<div class="line"><span class="lineno">  576</span> </div>
<div class="line"><span class="lineno">  577</span>  <span class="comment">/*- 規則正しく並んだ（まだ出発していない）粒子情報 -*/</span></div>
<div class="line"><span class="lineno">  578</span>  QList&lt;ParticleOrigin&gt; particleOrigins;</div>
<div class="line"><span class="lineno">  579</span>  <span class="comment">/*- 出力画像のバウンディングボックス -*/</span></div>
<div class="line"><span class="lineno">  580</span>  <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> outTileBBox(tile-&gt;m_pos, <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(tile-&gt;getRaster()-&gt;getLx(),</div>
<div class="line"><span class="lineno">  581</span>                                              tile-&gt;getRaster()-&gt;getLy()));</div>
<div class="line"><span class="lineno">  582</span> </div>
<div class="line"><span class="lineno">  583</span>  <span class="comment">/*- 現在取っておいてあるデータのフレーム番号 -*/</span></div>
<div class="line"><span class="lineno">  584</span>  <span class="keywordtype">int</span> pcFrame = particlesData-&gt;m_frame;</div>
<div class="line"><span class="lineno">  585</span> </div>
<div class="line"><span class="lineno">  586</span>  <span class="comment">/*- マージンをピクセル単位に換算する -*/</span></div>
<div class="line"><span class="lineno">  587</span>  <span class="keywordtype">double</span> pixelMargin;</div>
<div class="line"><span class="lineno">  588</span>  {</div>
<div class="line"><span class="lineno">  589</span>    <a class="code hl_class" href="class_t_point_t.html">TPointD</a> vect(values.margin_val, 0.0);</div>
<div class="line"><span class="lineno">  590</span>    <a class="code hl_class" href="class_t_affine.html">TAffine</a> aff(ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a>);</div>
<div class="line"><span class="lineno">  591</span>    aff.a13 = aff.a23 = 0;</div>
<div class="line"><span class="lineno">  592</span>    vect              = aff * vect;</div>
<div class="line"><span class="lineno">  593</span>    pixelMargin       = sqrt(vect.x * vect.x + vect.y * vect.y);</div>
<div class="line"><span class="lineno">  594</span>  }</div>
<div class="line"><span class="lineno">  595</span>  <span class="comment">/*- 外側にマージンを取って粒子を生成 -*/</span></div>
<div class="line"><span class="lineno">  596</span>  <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> resourceTileBBox = outTileBBox.enlarge(pixelMargin);</div>
<div class="line"><span class="lineno">  597</span> </div>
<div class="line"><span class="lineno">  598</span>  <span class="comment">/*- 初期粒子量。これが変わっていなければ、BGはそのまま描く -*/</span></div>
<div class="line"><span class="lineno">  599</span>  <span class="keywordtype">int</span> initialOriginsSize;</div>
<div class="line"><span class="lineno">  600</span>  <span class="keywordflow">if</span> (pcFrame &gt; curr_frame) {</div>
<div class="line"><span class="lineno">  601</span>    <span class="comment">/*- データを初期化 -*/</span></div>
<div class="line"><span class="lineno">  602</span>    <span class="comment">// Clear stored particlesData</span></div>
<div class="line"><span class="lineno">  603</span>    particlesData-&gt;clear();</div>
<div class="line"><span class="lineno">  604</span>    pcFrame = particlesData-&gt;m_frame;</div>
<div class="line"><span class="lineno">  605</span> </div>
<div class="line"><span class="lineno">  606</span>    <span class="comment">/*- まだ出発していない粒子情報を初期化 -*/</span></div>
<div class="line"><span class="lineno">  607</span>    initParticleOrigins(resourceTileBBox, particleOrigins, curr_frame,</div>
<div class="line"><span class="lineno">  608</span>                        ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a>, values, level_n, last_frame, pixelMargin);</div>
<div class="line"><span class="lineno">  609</span>    initialOriginsSize = particleOrigins.size();</div>
<div class="line"><span class="lineno">  610</span> </div>
<div class="line"><span class="lineno">  611</span>  }</div>
<div class="line"><span class="lineno">  612</span> </div>
<div class="line"><span class="lineno">  613</span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcFrame &gt;= startframe - 1) {</div>
<div class="line"><span class="lineno">  614</span>    myParticles        = particlesData-&gt;m_particles;</div>
<div class="line"><span class="lineno">  615</span>    myRandom           = particlesData-&gt;m_random;</div>
<div class="line"><span class="lineno">  616</span>    totalparticles     = particlesData-&gt;m_totalParticles;</div>
<div class="line"><span class="lineno">  617</span>    particleOrigins    = particlesData-&gt;m_particleOrigins;</div>
<div class="line"><span class="lineno">  618</span>    initialOriginsSize = -1;</div>
<div class="line"><span class="lineno">  619</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  620</span>    <span class="comment">/*- まだ出発していない粒子情報を初期化 -*/</span></div>
<div class="line"><span class="lineno">  621</span>    initParticleOrigins(resourceTileBBox, particleOrigins, curr_frame,</div>
<div class="line"><span class="lineno">  622</span>                        ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a>, values, level_n, last_frame, pixelMargin);</div>
<div class="line"><span class="lineno">  623</span>    initialOriginsSize = particleOrigins.size();</div>
<div class="line"><span class="lineno">  624</span>  }</div>
<div class="line"><span class="lineno">  625</span> </div>
<div class="line"><span class="lineno">  626</span>  <span class="comment">/*- スタートからカレントフレームまでループ -*/</span></div>
<div class="line"><span class="lineno">  627</span>  <span class="keywordflow">for</span> (frame = startframe - 1; frame &lt;= curr_frame; ++frame) {</div>
<div class="line"><span class="lineno">  628</span>    <span class="comment">/*-  参照画像はキャッシュされてるフレームでは必要ないのでは？ -*/</span></div>
<div class="line"><span class="lineno">  629</span>    <span class="keywordflow">if</span> (frame &lt;= pcFrame) <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  630</span> </div>
<div class="line"><span class="lineno">  631</span>    <span class="keywordtype">int</span> dist_frame = curr_frame - frame;</div>
<div class="line"><span class="lineno">  632</span>    <span class="comment">/*-</span></div>
<div class="line"><span class="lineno">  633</span><span class="comment">     * ループ内の現在のフレームでのパラメータを取得。スタートが負ならフレーム=0のときの値を格納。</span></div>
<div class="line"><span class="lineno">  634</span><span class="comment">     * -*/</span></div>
<div class="line"><span class="lineno">  635</span>    fill_value_struct(values, frame &lt; 0 ? 0 : frame * values.step_val);</div>
<div class="line"><span class="lineno">  636</span>    <span class="comment">/*- パラメータの正規化 -*/</span></div>
<div class="line"><span class="lineno">  637</span>    normalize_values(values, ri);</div>
<div class="line"><span class="lineno">  638</span>    <span class="comment">/*- maxnum_valは&quot;birth_rate&quot;のパラメータ -*/</span></div>
<div class="line"><span class="lineno">  639</span>    intpart = (int)values.maxnum_val;</div>
<div class="line"><span class="lineno">  640</span>    <span class="comment">/*-</span></div>
<div class="line"><span class="lineno">  641</span><span class="comment">     * birth_rateが小数だったとき、各フレームの小数部分を足しこんだ結果の整数部分をintpartに渡す</span></div>
<div class="line"><span class="lineno">  642</span><span class="comment">     * -*/</span></div>
<div class="line"><span class="lineno">  643</span>    fractpart = fractpart + values.maxnum_val - intpart;</div>
<div class="line"><span class="lineno">  644</span>    if ((<span class="keywordtype">int</span>)fractpart) {</div>
<div class="line"><span class="lineno">  645</span>      values.maxnum_val += (int)fractpart;</div>
<div class="line"><span class="lineno">  646</span>      fractpart = fractpart - (int)fractpart;</div>
<div class="line"><span class="lineno">  647</span>    }</div>
<div class="line"><span class="lineno">  648</span> </div>
<div class="line"><span class="lineno">  649</span>    std::map&lt;int, TTile *&gt; porttiles;</div>
<div class="line"><span class="lineno">  650</span> </div>
<div class="line"><span class="lineno">  651</span>    <span class="comment">// Perform the roll</span></div>
<div class="line"><span class="lineno">  652</span>    <span class="comment">/*- RenderSettingsを複製して現在のフレームの計算用にする -*/</span></div>
<div class="line"><span class="lineno">  653</span>    <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riAux(ri);</div>
<div class="line"><span class="lineno">  654</span> </div>
<div class="line"><span class="lineno">  655</span>    <span class="comment">/*- 64bitにする -*/</span></div>
<div class="line"><span class="lineno">  656</span>    riAux.m_bpp = 64;</div>
<div class="line"><span class="lineno">  657</span>    <span class="comment">// riAux.m_bpp = 32;</span></div>
<div class="line"><span class="lineno">  658</span> </div>
<div class="line"><span class="lineno">  659</span>    <span class="keywordtype">int</span> r_frame;  <span class="comment">// Useful in case of negative roll frames</span></div>
<div class="line"><span class="lineno">  660</span>    <span class="keywordflow">if</span> (frame &lt; 0)</div>
<div class="line"><span class="lineno">  661</span>      r_frame = 0;</div>
<div class="line"><span class="lineno">  662</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  663</span>      r_frame = frame;</div>
<div class="line"><span class="lineno">  664</span> </div>
<div class="line"><span class="lineno">  665</span>    <span class="comment">/*- コントロールに刺さっている各ポートについて -*/</span></div>
<div class="line"><span class="lineno">  666</span>    <span class="keywordflow">for</span> (std::map&lt;int, TRasterFxPort *&gt;::iterator it = ctrl_ports.begin();</div>
<div class="line"><span class="lineno">  667</span>         it != ctrl_ports.end(); ++it) {</div>
<div class="line"><span class="lineno">  668</span>      <a class="code hl_class" href="class_t_tile.html">TTile</a> *tmp;</div>
<div class="line"><span class="lineno">  669</span>      <span class="comment">/*- ポートが接続されていて、Fx内で実際に使用されていたら -*/</span></div>
<div class="line"><span class="lineno">  670</span>      <span class="keywordflow">if</span> ((it-&gt;second)-&gt;isConnected() &amp;&amp; port_is_used(it-&gt;first, values)) {</div>
<div class="line"><span class="lineno">  671</span>        <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> bbox = resourceTileBBox;</div>
<div class="line"><span class="lineno">  672</span> </div>
<div class="line"><span class="lineno">  673</span>        <span class="comment">/*- 素材が存在する場合、portTilesにコントロール画像タイルを格納 -*/</span></div>
<div class="line"><span class="lineno">  674</span>        <span class="keywordflow">if</span> (!bbox.<a class="code hl_function" href="class_t_rect_t.html#a53ce09c6112f8a019b43ad82d721a93b">isEmpty</a>()) {</div>
<div class="line"><span class="lineno">  675</span>          <span class="keywordflow">if</span> (frame &lt;= pcFrame) {</div>
<div class="line"><span class="lineno">  676</span>            <span class="comment">// This frame will not actually be rolled. However, it was</span></div>
<div class="line"><span class="lineno">  677</span>            <span class="comment">// dryComputed - so, declare the same here.</span></div>
<div class="line"><span class="lineno">  678</span>            (*it-&gt;second)-&gt;dryCompute(bbox, r_frame, riAux);</div>
<div class="line"><span class="lineno">  679</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  680</span>            tmp = <span class="keyword">new</span> <a class="code hl_class" href="class_t_tile.html">TTile</a>;</div>
<div class="line"><span class="lineno">  681</span> </div>
<div class="line"><span class="lineno">  682</span>            <span class="keywordflow">if</span> (isPrecomputingEnabled) {</div>
<div class="line"><span class="lineno">  683</span>              (*it-&gt;second)</div>
<div class="line"><span class="lineno">  684</span>                  -&gt;allocateAndCompute(*tmp, bbox.getP00(),</div>
<div class="line"><span class="lineno">  685</span>                                       convert(bbox).getSize(), 0, r_frame,</div>
<div class="line"><span class="lineno">  686</span>                                       riAux);</div>
<div class="line"><span class="lineno">  687</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  688</span>              std::string alias =</div>
<div class="line"><span class="lineno">  689</span>                  <span class="stringliteral">&quot;CTRL: &quot;</span> + (*(it-&gt;second))-&gt;getAlias(r_frame, riAux);</div>
<div class="line"><span class="lineno">  690</span>              <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  691</span> </div>
<div class="line"><span class="lineno">  692</span>              <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  693</span>                tmp-&gt;m_pos = bbox.getP00();</div>
<div class="line"><span class="lineno">  694</span>                tmp-&gt;setRaster(rimg-&gt;getRaster());</div>
<div class="line"><span class="lineno">  695</span>              } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  696</span>                (*it-&gt;second)</div>
<div class="line"><span class="lineno">  697</span>                    -&gt;allocateAndCompute(*tmp, bbox.getP00(),</div>
<div class="line"><span class="lineno">  698</span>                                         convert(bbox).getSize(), 0, r_frame,</div>
<div class="line"><span class="lineno">  699</span>                                         riAux);</div>
<div class="line"><span class="lineno">  700</span>              }</div>
<div class="line"><span class="lineno">  701</span>            }</div>
<div class="line"><span class="lineno">  702</span> </div>
<div class="line"><span class="lineno">  703</span>            porttiles[it-&gt;first] = tmp;</div>
<div class="line"><span class="lineno">  704</span>          }</div>
<div class="line"><span class="lineno">  705</span>        }</div>
<div class="line"><span class="lineno">  706</span>      }</div>
<div class="line"><span class="lineno">  707</span>    }</div>
<div class="line"><span class="lineno">  708</span> </div>
<div class="line"><span class="lineno">  709</span>    <a class="code hl_class" href="class_t_tile.html">TTile</a> baseImgTile;</div>
<div class="line"><span class="lineno">  710</span>    <span class="keywordflow">if</span> (values.base_ctrl_val &amp;&amp;</div>
<div class="line"><span class="lineno">  711</span>        ctrl_ports.at(values.base_ctrl_val)-&gt;isConnected() &amp;&amp;</div>
<div class="line"><span class="lineno">  712</span>        port_is_used(values.base_ctrl_val, values) &amp;&amp;</div>
<div class="line"><span class="lineno">  713</span>        values.iw_rendermode_val !=</div>
<div class="line"><span class="lineno">  714</span>            Iwa_TiledParticlesFx::</div>
<div class="line"><span class="lineno">  715</span>                REND_ILLUMINATED) <span class="comment">/*- 照明モードなら、BG素材は要らない -*/</span></div>
<div class="line"><span class="lineno">  716</span>    {</div>
<div class="line"><span class="lineno">  717</span>      std::string alias =</div>
<div class="line"><span class="lineno">  718</span>          <span class="stringliteral">&quot;BG_CTRL: &quot;</span> +</div>
<div class="line"><span class="lineno">  719</span>          (*ctrl_ports.at(values.base_ctrl_val))-&gt;getAlias(r_frame, ri);</div>
<div class="line"><span class="lineno">  720</span>      <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  721</span>      <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  722</span>        baseImgTile.m_pos = tile-&gt;m_pos;</div>
<div class="line"><span class="lineno">  723</span>        baseImgTile.setRaster(rimg-&gt;getRaster());</div>
<div class="line"><span class="lineno">  724</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  725</span>        <span class="comment">/*- 出力と同じbpcにする -*/</span></div>
<div class="line"><span class="lineno">  726</span>        (*ctrl_ports.at(values.base_ctrl_val))</div>
<div class="line"><span class="lineno">  727</span>            -&gt;allocateAndCompute(baseImgTile, tile-&gt;m_pos,</div>
<div class="line"><span class="lineno">  728</span>                                 convert(resourceTileBBox).getSize(),</div>
<div class="line"><span class="lineno">  729</span>                                 tile-&gt;getRaster(), r_frame, ri);</div>
<div class="line"><span class="lineno">  730</span>        addRenderCache(alias, <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>(baseImgTile.getRaster()));</div>
<div class="line"><span class="lineno">  731</span>      }</div>
<div class="line"><span class="lineno">  732</span>      baseImgTile.getRaster()-&gt;lock();</div>
<div class="line"><span class="lineno">  733</span>    }</div>
<div class="line"><span class="lineno">  734</span> </div>
<div class="line"><span class="lineno">  735</span>    <span class="comment">// Invoke the actual rolling procedure</span></div>
<div class="line"><span class="lineno">  736</span>    roll_particles(tile, porttiles, riAux, myParticles, values, 0, 0, frame,</div>
<div class="line"><span class="lineno">  737</span>                   curr_frame, level_n, &amp;random_level, 1, last_frame,</div>
<div class="line"><span class="lineno">  738</span>                   totalparticles, particleOrigins,</div>
<div class="line"><span class="lineno">  739</span>                   intpart <span class="comment">/*- 実際に生成したい粒子数 -*/</span></div>
<div class="line"><span class="lineno">  740</span>                   );</div>
<div class="line"><span class="lineno">  741</span> </div>
<div class="line"><span class="lineno">  742</span>    <span class="comment">// Store the rolled data in the particles manager</span></div>
<div class="line"><span class="lineno">  743</span>    <span class="keywordflow">if</span> (!particlesData-&gt;m_calculated ||</div>
<div class="line"><span class="lineno">  744</span>        particlesData-&gt;m_frame + particlesData-&gt;m_maxTrail &lt; frame) {</div>
<div class="line"><span class="lineno">  745</span>      particlesData-&gt;m_frame     = frame;</div>
<div class="line"><span class="lineno">  746</span>      particlesData-&gt;m_particles = myParticles;</div>
<div class="line"><span class="lineno">  747</span>      particlesData-&gt;m_random    = myRandom;</div>
<div class="line"><span class="lineno">  748</span>      particlesData-&gt;buildMaxTrail();</div>
<div class="line"><span class="lineno">  749</span>      particlesData-&gt;m_calculated      = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  750</span>      particlesData-&gt;m_totalParticles  = totalparticles;</div>
<div class="line"><span class="lineno">  751</span>      particlesData-&gt;m_particleOrigins = particleOrigins;</div>
<div class="line"><span class="lineno">  752</span>    }</div>
<div class="line"><span class="lineno">  753</span> </div>
<div class="line"><span class="lineno">  754</span>    <span class="comment">// Render the particles if the distance from current frame is a trail</span></div>
<div class="line"><span class="lineno">  755</span>    <span class="comment">// multiple</span></div>
<div class="line"><span class="lineno">  756</span>    <span class="comment">/*- さしあたり、trailは無視する -*/</span></div>
<div class="line"><span class="lineno">  757</span>    <span class="keywordflow">if</span> (dist_frame == 0) {</div>
<div class="line"><span class="lineno">  758</span>      <span class="comment">//--------</span></div>
<div class="line"><span class="lineno">  759</span>      <span class="comment">// Store the maximum particle size before the do_render cycle</span></div>
<div class="line"><span class="lineno">  760</span>      <span class="comment">/*- 表示されている粒子のうち、各素材について最大サイズのものを記録しておく</span></div>
<div class="line"><span class="lineno">  761</span><span class="comment">              条件にあわせ、飛んでいる粒子と飛び立つ前の粒子の両方で記録を行う</span></div>
<div class="line"><span class="lineno">  762</span><span class="comment">         -*/</span></div>
<div class="line"><span class="lineno">  763</span>      <span class="comment">/*-   ①飛んでいる粒子 -*/</span></div>
<div class="line"><span class="lineno">  764</span>      <span class="keywordflow">if</span> (values.iw_rendermode_val != Iwa_TiledParticlesFx::REND_BG) {</div>
<div class="line"><span class="lineno">  765</span>        std::list&lt;Iwa_Particle&gt;::iterator pt;</div>
<div class="line"><span class="lineno">  766</span>        <span class="keywordflow">for</span> (pt = myParticles.begin(); pt != myParticles.end(); ++pt) {</div>
<div class="line"><span class="lineno">  767</span>          <a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a> &amp;part = *pt;</div>
<div class="line"><span class="lineno">  768</span>          <span class="keywordtype">int</span> ndx            = part.frame % last_frame[part.level];</div>
<div class="line"><span class="lineno">  769</span>          std::pair&lt;int, int&gt; ndxPair(part.level, ndx);</div>
<div class="line"><span class="lineno">  770</span> </div>
<div class="line"><span class="lineno">  771</span>          std::map&lt;std::pair&lt;int, int&gt;, <span class="keywordtype">float</span>&gt;::iterator it =</div>
<div class="line"><span class="lineno">  772</span>              partScales.find(ndxPair);</div>
<div class="line"><span class="lineno">  773</span> </div>
<div class="line"><span class="lineno">  774</span>          <span class="keywordflow">if</span> (it != partScales.end())</div>
<div class="line"><span class="lineno">  775</span>            it-&gt;second = std::max(part.scale, it-&gt;second);</div>
<div class="line"><span class="lineno">  776</span>          <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  777</span>            partScales[ndxPair] = part.scale;</div>
<div class="line"><span class="lineno">  778</span>        }</div>
<div class="line"><span class="lineno">  779</span>      }</div>
<div class="line"><span class="lineno">  780</span>      <span class="comment">/*- ②飛び立つ前の粒子がひとつでもあった場合、最大値でおきかえる -*/</span></div>
<div class="line"><span class="lineno">  781</span>      <span class="keywordflow">if</span> (values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_ALL ||</div>
<div class="line"><span class="lineno">  782</span>          values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_BG) {</div>
<div class="line"><span class="lineno">  783</span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> lev = 0; lev &lt; level_n; lev++) {</div>
<div class="line"><span class="lineno">  784</span>          std::pair&lt;int, int&gt; ndxPair(lev, 0);</div>
<div class="line"><span class="lineno">  785</span>          std::map&lt;std::pair&lt;int, int&gt;, <span class="keywordtype">float</span>&gt;::iterator it =</div>
<div class="line"><span class="lineno">  786</span>              partScales.find(ndxPair);</div>
<div class="line"><span class="lineno">  787</span>          <span class="keywordflow">if</span> (it != partScales.end())</div>
<div class="line"><span class="lineno">  788</span>            it-&gt;second = std::max((<span class="keywordtype">float</span>)values.scale_val.second, it-&gt;second);</div>
<div class="line"><span class="lineno">  789</span>          <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  790</span>            partScales[ndxPair] = values.scale_val.second;</div>
<div class="line"><span class="lineno">  791</span>        }</div>
<div class="line"><span class="lineno">  792</span>      }</div>
<div class="line"><span class="lineno">  793</span>      <span class="comment">//--------</span></div>
<div class="line"><span class="lineno">  794</span> </div>
<div class="line"><span class="lineno">  795</span>      <span class="comment">/*- ここで、出発した粒子の分、穴を開けた背景を描く -*/</span></div>
<div class="line"><span class="lineno">  796</span>      <span class="comment">/*- スイッチがONなら -*/</span></div>
<div class="line"><span class="lineno">  797</span>      <span class="keywordflow">if</span> (values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_ALL ||</div>
<div class="line"><span class="lineno">  798</span>          values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_BG) {</div>
<div class="line"><span class="lineno">  799</span>        <span class="comment">/*- まだ粒子が飛び立っていない場合、そのまま背景を描く -*/</span></div>
<div class="line"><span class="lineno">  800</span>        <span class="keywordflow">if</span> (initialOriginsSize == particleOrigins.size()) {</div>
<div class="line"><span class="lineno">  801</span>          <a class="code hl_function" href="namespace_t_rop.html#a5e39bc748039afe42001ba44f2d2a073">TRop::resample</a>(tile-&gt;getRaster(), baseImgTile.getRaster(), <a class="code hl_class" href="class_t_affine.html">TAffine</a>());</div>
<div class="line"><span class="lineno">  802</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  803</span>          renderBackground(tile, particleOrigins, part_ports, ri, partLevel,</div>
<div class="line"><span class="lineno">  804</span>                           partScales, &amp;baseImgTile);</div>
<div class="line"><span class="lineno">  805</span>        }</div>
<div class="line"><span class="lineno">  806</span>      }</div>
<div class="line"><span class="lineno">  807</span> </div>
<div class="line"><span class="lineno">  808</span>      <span class="comment">/*- 粒子の描画。もし、背景モードなら描かない -*/</span></div>
<div class="line"><span class="lineno">  809</span>      <span class="keywordflow">if</span> (values.iw_rendermode_val != Iwa_TiledParticlesFx::REND_BG) {</div>
<div class="line"><span class="lineno">  810</span>        <span class="keywordflow">if</span> (values.toplayer_val == Iwa_TiledParticlesFx::TOP_SMALLER ||</div>
<div class="line"><span class="lineno">  811</span>            values.toplayer_val == Iwa_TiledParticlesFx::TOP_BIGGER)</div>
<div class="line"><span class="lineno">  812</span>          myParticles.sort(<a class="code hl_class" href="class_iwa___compareby_size.html">Iwa_ComparebySize</a>());</div>
<div class="line"><span class="lineno">  813</span> </div>
<div class="line"><span class="lineno">  814</span>        <span class="keywordflow">if</span> (values.toplayer_val == Iwa_TiledParticlesFx::TOP_SMALLER) {</div>
<div class="line"><span class="lineno">  815</span>          <span class="keywordtype">int</span> unit  = 1 + (int)myParticles.size() / 100;</div>
<div class="line"><span class="lineno">  816</span>          <span class="keywordtype">int</span> count = 0;</div>
<div class="line"><span class="lineno">  817</span>          std::list&lt;Iwa_Particle&gt;::iterator pt;</div>
<div class="line"><span class="lineno">  818</span>          <span class="keywordflow">for</span> (pt = myParticles.begin(); pt != myParticles.end(); ++pt) {</div>
<div class="line"><span class="lineno">  819</span>            count++;</div>
<div class="line"><span class="lineno">  820</span> </div>
<div class="line"><span class="lineno">  821</span>            <a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a> &amp;part = *pt;</div>
<div class="line"><span class="lineno">  822</span>            <span class="keywordflow">if</span> (dist_frame &lt;= part.trail &amp;&amp; part.scale &gt; 0.0f &amp;&amp;</div>
<div class="line"><span class="lineno">  823</span>                part.lifetime &gt; 0 &amp;&amp;</div>
<div class="line"><span class="lineno">  824</span>                part.lifetime &lt;=</div>
<div class="line"><span class="lineno">  825</span>                    part.genlifetime)  <span class="comment">// This last... shouldn&#39;t always be?</span></div>
<div class="line"><span class="lineno">  826</span>            {</div>
<div class="line"><span class="lineno">  827</span>              do_render(&amp;part, tile, part_ports, porttiles, ri, p_size,</div>
<div class="line"><span class="lineno">  828</span>                        p_offset, last_frame[part.level], partLevel, values,</div>
<div class="line"><span class="lineno">  829</span>                        opacity_range, dist_frame, partScales, &amp;baseImgTile);</div>
<div class="line"><span class="lineno">  830</span>            }</div>
<div class="line"><span class="lineno">  831</span>          }</div>
<div class="line"><span class="lineno">  832</span> </div>
<div class="line"><span class="lineno">  833</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  834</span>          <span class="keywordtype">int</span> unit  = 1 + (int)myParticles.size() / 100;</div>
<div class="line"><span class="lineno">  835</span>          <span class="keywordtype">int</span> count = 0;</div>
<div class="line"><span class="lineno">  836</span>          std::list&lt;Iwa_Particle&gt;::reverse_iterator pt;</div>
<div class="line"><span class="lineno">  837</span>          <span class="keywordflow">for</span> (pt = myParticles.rbegin(); pt != myParticles.rend(); ++pt) {</div>
<div class="line"><span class="lineno">  838</span>            count++;</div>
<div class="line"><span class="lineno">  839</span> </div>
<div class="line"><span class="lineno">  840</span>            <a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a> &amp;part = *pt;</div>
<div class="line"><span class="lineno">  841</span>            <span class="keywordflow">if</span> (dist_frame &lt;= part.trail &amp;&amp; part.scale &gt; 0.0f &amp;&amp;</div>
<div class="line"><span class="lineno">  842</span>                part.lifetime &gt; 0 &amp;&amp;</div>
<div class="line"><span class="lineno">  843</span>                part.lifetime &lt;= part.genlifetime)  <span class="comment">// Same here..?</span></div>
<div class="line"><span class="lineno">  844</span>            {</div>
<div class="line"><span class="lineno">  845</span>              do_render(&amp;part, tile, part_ports, porttiles, ri, p_size,</div>
<div class="line"><span class="lineno">  846</span>                        p_offset, last_frame[part.level], partLevel, values,</div>
<div class="line"><span class="lineno">  847</span>                        opacity_range, dist_frame, partScales, &amp;baseImgTile);</div>
<div class="line"><span class="lineno">  848</span>            }</div>
<div class="line"><span class="lineno">  849</span>          }</div>
<div class="line"><span class="lineno">  850</span>        }</div>
<div class="line"><span class="lineno">  851</span>      }</div>
<div class="line"><span class="lineno">  852</span>      <span class="comment">/*- 粒子の描画 ここまで -*/</span></div>
<div class="line"><span class="lineno">  853</span>    }</div>
<div class="line"><span class="lineno">  854</span> </div>
<div class="line"><span class="lineno">  855</span>    std::map&lt;int, TTile *&gt;::iterator it;</div>
<div class="line"><span class="lineno">  856</span>    <span class="keywordflow">for</span> (it = porttiles.begin(); it != porttiles.end(); ++it) <span class="keyword">delete</span> it-&gt;second;</div>
<div class="line"><span class="lineno">  857</span> </div>
<div class="line"><span class="lineno">  858</span>    <span class="keywordflow">if</span> (values.base_ctrl_val &amp;&amp;</div>
<div class="line"><span class="lineno">  859</span>        ctrl_ports.at(values.base_ctrl_val)-&gt;isConnected() &amp;&amp;</div>
<div class="line"><span class="lineno">  860</span>        port_is_used(values.base_ctrl_val, values) &amp;&amp;</div>
<div class="line"><span class="lineno">  861</span>        values.iw_rendermode_val != Iwa_TiledParticlesFx::REND_ILLUMINATED)</div>
<div class="line"><span class="lineno">  862</span>      baseImgTile.getRaster()-&gt;unlock();</div>
<div class="line"><span class="lineno">  863</span>  }</div>
<div class="line"><span class="lineno">  864</span>}</div>
<div class="ttc" id="aclass_iwa___compareby_size_html"><div class="ttname"><a href="class_iwa___compareby_size.html">Iwa_ComparebySize</a></div><div class="ttdef"><b>Definition:</b> iwa_particles.h:276</div></div>
<div class="ttc" id="aclass_iwa___particle_html"><div class="ttname"><a href="class_iwa___particle.html">Iwa_Particle</a></div><div class="ttdef"><b>Definition:</b> iwa_particles.h:159</div></div>
<div class="ttc" id="aclass_iwa___particles_manager_html"><div class="ttname"><a href="class_iwa___particles_manager.html">Iwa_ParticlesManager</a></div><div class="ttdef"><b>Definition:</b> iwa_particlesmanager.h:29</div></div>
<div class="ttc" id="aclass_t_rect_t_html_a53ce09c6112f8a019b43ad82d721a93b"><div class="ttname"><a href="class_t_rect_t.html#a53ce09c6112f8a019b43ad82d721a93b">TRectT::isEmpty</a></div><div class="ttdeci">bool isEmpty() const</div></div>
<div class="ttc" id="aclass_t_renderer_html"><div class="ttname"><a href="class_t_renderer.html">TRenderer</a></div><div class="ttdef"><b>Definition:</b> trenderer.h:175</div></div>
<div class="ttc" id="aclass_t_renderer_html_a93afee3c1ce8ff2b753a05fa0fe3dc9d"><div class="ttname"><a href="class_t_renderer.html#a93afee3c1ce8ff2b753a05fa0fe3dc9d">TRenderer::instance</a></div><div class="ttdeci">static TRenderer instance()</div><div class="ttdef"><b>Definition:</b> trenderer.cpp:470</div></div>
<div class="ttc" id="anamespace_t_rop_html_a5e39bc748039afe42001ba44f2d2a073"><div class="ttname"><a href="namespace_t_rop.html#a5e39bc748039afe42001ba44f2d2a073">TRop::resample</a></div><div class="ttdeci">DVAPI void resample(const TRasterP &amp;out, const TRasterP &amp;in, const TAffine &amp;aff, ResampleFilterType filterType=Triangle, double blur=1.)</div><div class="ttdef"><b>Definition:</b> tresample.cpp:4648</div></div>
<div class="ttc" id="astruct_iwa___particles_manager_1_1_frame_data_html"><div class="ttname"><a href="struct_iwa___particles_manager_1_1_frame_data.html">Iwa_ParticlesManager::FrameData</a></div><div class="ttdef"><b>Definition:</b> iwa_particlesmanager.h:35</div></div>
<div class="ttc" id="astructparticles__values_html"><div class="ttname"><a href="structparticles__values.html">particles_values</a></div><div class="ttdef"><b>Definition:</b> iwa_particles.h:19</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a4f655c139bcd2b581b560d2f2ce396d6" name="a4f655c139bcd2b581b560d2f2ce396d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f655c139bcd2b581b560d2f2ce396d6">&#9670;&nbsp;</a></span>renderBackground()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::renderBackground </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>origins</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>part_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt;&#160;</td>
          <td class="paramname"><em>partLevel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; std::pair&lt; int, int &gt;, float &gt; &amp;&#160;</td>
          <td class="paramname"><em>partScales</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>baseImgTile</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1452</span>                                                                      {</div>
<div class="line"><span class="lineno"> 1453</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> tileRas(tile-&gt;getRaster());</div>
<div class="line"><span class="lineno"> 1454</span>  <span class="keywordtype">int</span> unit = 1 + (int)origins.size() / 100;</div>
<div class="line"><span class="lineno"> 1455</span> </div>
<div class="line"><span class="lineno"> 1456</span>  <span class="comment">/*- まだ残っている粒子源について -*/</span></div>
<div class="line"><span class="lineno"> 1457</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> po = 0; po &lt; origins.size(); po++) {</div>
<div class="line"><span class="lineno"> 1458</span>    <a class="code hl_struct" href="struct_particle_origin.html">ParticleOrigin</a> origin = origins.at(po);</div>
<div class="line"><span class="lineno"> 1459</span> </div>
<div class="line"><span class="lineno"> 1460</span>    <span class="keywordtype">int</span> ndx = origin.initSourceFrame;</div>
<div class="line"><span class="lineno"> 1461</span> </div>
<div class="line"><span class="lineno"> 1462</span>    <span class="comment">/*- 粒子の回転、スケール -*/</span></div>
<div class="line"><span class="lineno"> 1463</span>    <a class="code hl_class" href="class_t_rotation.html">TRotation</a> rotM((origin.isUpward) ? 0.0 : 180.0);</div>
<div class="line"><span class="lineno"> 1464</span>    <a class="code hl_class" href="class_t_affine.html">TAffine</a> M(rotM);</div>
<div class="line"><span class="lineno"> 1465</span>    <span class="comment">// Particles deal with dpi affines on their own</span></div>
<div class="line"><span class="lineno"> 1466</span>    <a class="code hl_class" href="class_t_affine.html">TAffine</a> scaleAff(m_parent-&gt;handledAffine(ri, m_frame));</div>
<div class="line"><span class="lineno"> 1467</span>    <span class="keywordtype">float</span> partScale =</div>
<div class="line"><span class="lineno"> 1468</span>        scaleAff.a11 * partScales[std::pair&lt;int, int&gt;(origin.level, ndx)];</div>
<div class="line"><span class="lineno"> 1469</span>    <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a> partResolution(0, 0);</div>
<div class="line"><span class="lineno"> 1470</span>    <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riNew(ri);</div>
<div class="line"><span class="lineno"> 1471</span>    <span class="comment">// Retrieve the bounding box in the standard reference</span></div>
<div class="line"><span class="lineno"> 1472</span>    <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> bbox(-5.0, -5.0, 5.0, 5.0), standardRefBBox;</div>
<div class="line"><span class="lineno"> 1473</span>    <span class="keywordflow">if</span> (origin.level &lt;</div>
<div class="line"><span class="lineno"> 1474</span>            (<span class="keywordtype">int</span>)part_ports.size() &amp;&amp;  <span class="comment">// Not the default levelless cases</span></div>
<div class="line"><span class="lineno"> 1475</span>        part_ports[origin.level]-&gt;isConnected()) {</div>
<div class="line"><span class="lineno"> 1476</span>      <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riIdentity(ri);</div>
<div class="line"><span class="lineno"> 1477</span>      riIdentity.m_affine = <a class="code hl_class" href="class_t_affine.html">TAffine</a>();</div>
<div class="line"><span class="lineno"> 1478</span>      (*part_ports[origin.level])-&gt;getBBox(ndx, bbox, riIdentity);</div>
<div class="line"><span class="lineno"> 1479</span>      <span class="keywordflow">if</span> (bbox == TConsts::infiniteRectD) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1480</span>    }</div>
<div class="line"><span class="lineno"> 1481</span> </div>
<div class="line"><span class="lineno"> 1482</span>    <span class="comment">// Now, these are the particle rendering specifications</span></div>
<div class="line"><span class="lineno"> 1483</span>    bbox            = bbox.enlarge(3);</div>
<div class="line"><span class="lineno"> 1484</span>    standardRefBBox = bbox;</div>
<div class="line"><span class="lineno"> 1485</span>    riNew.m_affine  = <a class="code hl_class" href="class_t_scale.html">TScale</a>(partScale);</div>
<div class="line"><span class="lineno"> 1486</span>    bbox            = riNew.m_affine * bbox;</div>
<div class="line"><span class="lineno"> 1487</span>    <span class="comment">/*- 縮小済みのParticleのサイズ -*/</span></div>
<div class="line"><span class="lineno"> 1488</span>    partResolution = <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(tceil(bbox.getLx()), tceil(bbox.getLy()));</div>
<div class="line"><span class="lineno"> 1489</span> </div>
<div class="line"><span class="lineno"> 1490</span>    <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> ras;</div>
<div class="line"><span class="lineno"> 1491</span> </div>
<div class="line"><span class="lineno"> 1492</span>    std::string alias;</div>
<div class="line"><span class="lineno"> 1493</span>    <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg;</div>
<div class="line"><span class="lineno"> 1494</span>    rimg = partLevel[origin.level]-&gt;frame(ndx);</div>
<div class="line"><span class="lineno"> 1495</span>    <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno"> 1496</span>      ras = rimg-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1497</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1498</span>      alias = <span class="stringliteral">&quot;PART: &quot;</span> + (*part_ports[origin.level])-&gt;getAlias(ndx, riNew);</div>
<div class="line"><span class="lineno"> 1499</span>      rimg  = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno"> 1500</span>      <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno"> 1501</span>        ras = rimg-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1502</span> </div>
<div class="line"><span class="lineno"> 1503</span>        <span class="comment">// Check that the raster resolution is sufficient for our purposes</span></div>
<div class="line"><span class="lineno"> 1504</span>        <span class="keywordflow">if</span> (ras-&gt;getLx() &lt; partResolution.lx ||</div>
<div class="line"><span class="lineno"> 1505</span>            ras-&gt;getLy() &lt; partResolution.ly)</div>
<div class="line"><span class="lineno"> 1506</span>          ras = 0;</div>
<div class="line"><span class="lineno"> 1507</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1508</span>          partResolution = <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(ras-&gt;getLx(), ras-&gt;getLy());</div>
<div class="line"><span class="lineno"> 1509</span>      }</div>
<div class="line"><span class="lineno"> 1510</span>    }</div>
<div class="line"><span class="lineno"> 1511</span> </div>
<div class="line"><span class="lineno"> 1512</span>    <span class="comment">// We are interested in making the relation between scale and (integer)</span></div>
<div class="line"><span class="lineno"> 1513</span>    <span class="comment">// resolution</span></div>
<div class="line"><span class="lineno"> 1514</span>    <span class="comment">// bijective - since we shall cache by using resolution as a partial</span></div>
<div class="line"><span class="lineno"> 1515</span>    <span class="comment">// identification parameter.</span></div>
<div class="line"><span class="lineno"> 1516</span>    <span class="comment">// Therefore, we find the current bbox Lx and take a unique scale out of it.</span></div>
<div class="line"><span class="lineno"> 1517</span>    partScale      = partResolution.lx / standardRefBBox.getLx();</div>
<div class="line"><span class="lineno"> 1518</span>    riNew.m_affine = <a class="code hl_class" href="class_t_scale.html">TScale</a>(partScale);</div>
<div class="line"><span class="lineno"> 1519</span>    bbox           = riNew.m_affine * standardRefBBox;</div>
<div class="line"><span class="lineno"> 1520</span> </div>
<div class="line"><span class="lineno"> 1521</span>    <span class="comment">// If no image was retrieved from the cache (or it was not scaled enough),</span></div>
<div class="line"><span class="lineno"> 1522</span>    <span class="comment">// calculate it</span></div>
<div class="line"><span class="lineno"> 1523</span>    <span class="keywordflow">if</span> (!ras) {</div>
<div class="line"><span class="lineno"> 1524</span>      <a class="code hl_class" href="class_t_tile.html">TTile</a> auxTile;</div>
<div class="line"><span class="lineno"> 1525</span>      (*part_ports[origin.level])</div>
<div class="line"><span class="lineno"> 1526</span>          -&gt;allocateAndCompute(auxTile, bbox.getP00(),</div>
<div class="line"><span class="lineno"> 1527</span>                               <a class="code hl_class" href="class_t_dimension_t.html">TDimension</a>(partResolution.lx, partResolution.ly),</div>
<div class="line"><span class="lineno"> 1528</span>                               tile-&gt;getRaster(), ndx, riNew);</div>
<div class="line"><span class="lineno"> 1529</span>      ras = auxTile.getRaster();</div>
<div class="line"><span class="lineno"> 1530</span> </div>
<div class="line"><span class="lineno"> 1531</span>      <span class="comment">// Finally, cache the particle</span></div>
<div class="line"><span class="lineno"> 1532</span>      addRenderCache(alias, <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>(ras));</div>
<div class="line"><span class="lineno"> 1533</span>    }</div>
<div class="line"><span class="lineno"> 1534</span> </div>
<div class="line"><span class="lineno"> 1535</span>    <span class="keywordflow">if</span> (!ras) <span class="keywordflow">return</span>;  <span class="comment">// At this point, it should never happen anyway...</span></div>
<div class="line"><span class="lineno"> 1536</span> </div>
<div class="line"><span class="lineno"> 1537</span>    M = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a> * M * <a class="code hl_class" href="class_t_scale.html">TScale</a>(1.0 / partScale);</div>
<div class="line"><span class="lineno"> 1538</span>    <a class="code hl_class" href="class_t_point_t.html">TPointD</a> pos(origin.pos[0], origin.pos[1]);</div>
<div class="line"><span class="lineno"> 1539</span>    pos = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a> * pos;</div>
<div class="line"><span class="lineno"> 1540</span>    M   = <a class="code hl_class" href="class_t_translation.html">TTranslation</a>(pos - tile-&gt;m_pos) * M * <a class="code hl_class" href="class_t_translation.html">TTranslation</a>(bbox.getP00());</div>
<div class="line"><span class="lineno"> 1541</span> </div>
<div class="line"><span class="lineno"> 1542</span>    <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> myras32 = tile-&gt;getRaster())</div>
<div class="line"><span class="lineno"> 1543</span>      <a class="code hl_function" href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a>(tileRas, ras, M);</div>
<div class="line"><span class="lineno"> 1544</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster64P</a> myras64 = tile-&gt;getRaster())</div>
<div class="line"><span class="lineno"> 1545</span>      <a class="code hl_function" href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a>(tileRas, ras, M);</div>
<div class="line"><span class="lineno"> 1546</span>  }</div>
<div class="line"><span class="lineno"> 1547</span>  <span class="comment">/*- サイズ縮める操作をいれる -*/</span></div>
<div class="line"><span class="lineno"> 1548</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> resizedBGRas;</div>
<div class="line"><span class="lineno"> 1549</span>  <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> myBgRas32 = baseImgTile-&gt;getRaster())</div>
<div class="line"><span class="lineno"> 1550</span>    resizedBGRas = <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a>(tileRas-&gt;getSize());</div>
<div class="line"><span class="lineno"> 1551</span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster64P</a> myBgRas64 = baseImgTile-&gt;getRaster())</div>
<div class="line"><span class="lineno"> 1552</span>    resizedBGRas = <a class="code hl_class" href="class_t_raster_p_t.html">TRaster64P</a>(tileRas-&gt;getSize());</div>
<div class="line"><span class="lineno"> 1553</span>  <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1554</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1555</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> aff;</div>
<div class="line"><span class="lineno"> 1556</span>  <span class="comment">/*- リサンプル -*/</span></div>
<div class="line"><span class="lineno"> 1557</span>  <a class="code hl_function" href="namespace_t_rop.html#a5e39bc748039afe42001ba44f2d2a073">TRop::resample</a>(resizedBGRas, baseImgTile-&gt;getRaster(), aff);</div>
<div class="line"><span class="lineno"> 1558</span> </div>
<div class="line"><span class="lineno"> 1559</span>  TRop::ropin(resizedBGRas, tileRas, tileRas);</div>
<div class="line"><span class="lineno"> 1560</span> </div>
<div class="line"><span class="lineno"> 1561</span>  std::cout &lt;&lt; std::endl;</div>
<div class="line"><span class="lineno"> 1562</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a818ccc2106caa5fec43413520e272883" name="a818ccc2106caa5fec43413520e272883"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a818ccc2106caa5fec43413520e272883">&#9670;&nbsp;</a></span>roll_particles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Iwa_Particles_Engine::roll_particles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt;&#160;</td>
          <td class="paramname"><em>porttiles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::list&lt; <a class="el" href="class_iwa___particle.html">Iwa_Particle</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>myParticles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>cx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>cy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>curr_frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>level_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&#160;</td>
          <td class="paramname"><em>random_level</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>dpi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt;&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int &amp;&#160;</td>
          <td class="paramname"><em>totalparticles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QList&lt; <a class="el" href="struct_particle_origin.html">ParticleOrigin</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>particleOrigin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>genPartNum</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  211</span>      {</div>
<div class="line"><span class="lineno">  212</span>  <a class="code hl_struct" href="structparticles__ranges.html">particles_ranges</a> ranges;</div>
<div class="line"><span class="lineno">  213</span>  <span class="keywordtype">int</span> i;</div>
<div class="line"><span class="lineno">  214</span>  <span class="keywordtype">float</span> xgravity, ygravity, windx, windy;</div>
<div class="line"><span class="lineno">  215</span> </div>
<div class="line"><span class="lineno">  216</span>  <span class="comment">/*- 風の強さ／重力の強さをX,Y成分に分ける -*/</span></div>
<div class="line"><span class="lineno">  217</span>  windx    = values.windint_val * sin(values.windangle_val);</div>
<div class="line"><span class="lineno">  218</span>  windy    = values.windint_val * cos(values.windangle_val);</div>
<div class="line"><span class="lineno">  219</span>  xgravity = values.gravity_val * sin(values.g_angle_val);</div>
<div class="line"><span class="lineno">  220</span>  ygravity = values.gravity_val * cos(values.g_angle_val);</div>
<div class="line"><span class="lineno">  221</span> </div>
<div class="line"><span class="lineno">  222</span>  fill_range_struct(values, ranges);</div>
<div class="line"><span class="lineno">  223</span> </div>
<div class="line"><span class="lineno">  224</span>  std::vector&lt;TPointD&gt; myregions;</div>
<div class="line"><span class="lineno">  225</span>  QList&lt;QList&lt;int&gt;&gt; myHistogram;</div>
<div class="line"><span class="lineno">  226</span> </div>
<div class="line"><span class="lineno">  227</span>  std::map&lt;int, TTile *&gt;::iterator it = porttiles.find(values.source_ctrl_val);</div>
<div class="line"><span class="lineno">  228</span> </div>
<div class="line"><span class="lineno">  229</span>  <span class="comment">/*- ソース画像にコントロールが付いていた場合 -*/</span></div>
<div class="line"><span class="lineno">  230</span>  <span class="keywordflow">if</span> (values.source_ctrl_val &amp;&amp; (it != porttiles.end()) &amp;&amp;</div>
<div class="line"><span class="lineno">  231</span>      it-&gt;second-&gt;getRaster())</div>
<div class="line"><span class="lineno">  232</span>    <span class="comment">/*- 入力画像のアルファ値に比例して発生濃度を変える -*/</span></div>
<div class="line"><span class="lineno">  233</span>    fill_single_region(myregions, it-&gt;second, values.bright_thres_val,</div>
<div class="line"><span class="lineno">  234</span>                       values.source_gradation_val, myHistogram,</div>
<div class="line"><span class="lineno">  235</span>                       particleOrigins);</div>
<div class="line"><span class="lineno">  236</span> </div>
<div class="line"><span class="lineno">  237</span>  <span class="comment">/*- 粒子が出きったらもう出さない -*/</span></div>
<div class="line"><span class="lineno">  238</span>  <span class="keywordtype">int</span> actualBirthParticles = std::min(genPartNum, particleOrigins.size());</div>
<div class="line"><span class="lineno">  239</span>  <span class="comment">/*- 出発する粒子のインデックス -*/</span></div>
<div class="line"><span class="lineno">  240</span>  QList&lt;int&gt; leavingPartIndex;</div>
<div class="line"><span class="lineno">  241</span>  <span class="keywordflow">if</span> (myregions.size() &amp;&amp;</div>
<div class="line"><span class="lineno">  242</span>      porttiles.find(values.source_ctrl_val) != porttiles.end()) {</div>
<div class="line"><span class="lineno">  243</span>    <span class="keywordtype">int</span> partLeft = actualBirthParticles;</div>
<div class="line"><span class="lineno">  244</span>    <span class="keywordflow">while</span> (partLeft &gt; 0) {</div>
<div class="line"><span class="lineno">  245</span>      <span class="keywordtype">int</span> PrePartLeft = partLeft;</div>
<div class="line"><span class="lineno">  246</span> </div>
<div class="line"><span class="lineno">  247</span>      <span class="keywordtype">int</span> potential_sum = 0;</div>
<div class="line"><span class="lineno">  248</span>      QList&lt;int&gt; myWeight;</div>
<div class="line"><span class="lineno">  249</span>      <span class="comment">/*- 各濃度のポテンシャルの大きさmyWeightと、合計ポテンシャルを計算 -*/</span></div>
<div class="line"><span class="lineno">  250</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 0; m &lt; 256; m++) {</div>
<div class="line"><span class="lineno">  251</span>        <span class="keywordtype">int</span> pot = myHistogram[m].size() * m;</div>
<div class="line"><span class="lineno">  252</span>        myWeight.append(pot);</div>
<div class="line"><span class="lineno">  253</span>        potential_sum += pot;</div>
<div class="line"><span class="lineno">  254</span>      }</div>
<div class="line"><span class="lineno">  255</span>      <span class="comment">/*- 各濃度について(濃い方から) -*/</span></div>
<div class="line"><span class="lineno">  256</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 255; m &gt; 0; m--) {</div>
<div class="line"><span class="lineno">  257</span>        <span class="comment">/*- 割り当てを計算（切り上げ） -*/</span></div>
<div class="line"><span class="lineno">  258</span>        <span class="keywordtype">int</span> wariate = tceil((<span class="keywordtype">float</span>)(myWeight[m]) * (<span class="keywordtype">float</span>)(partLeft) /</div>
<div class="line"><span class="lineno">  259</span>                            (<span class="keywordtype">float</span>)potential_sum);</div>
<div class="line"><span class="lineno">  260</span>        <span class="comment">/*- 実際にこのポテンシャルから出発する粒子数 -*/</span></div>
<div class="line"><span class="lineno">  261</span>        <span class="keywordtype">int</span> leaveNum = std::min(myHistogram.at(m).size(), wariate);</div>
<div class="line"><span class="lineno">  262</span>        <span class="comment">/*- 割り当てられた粒子を頭から登録 -*/</span></div>
<div class="line"><span class="lineno">  263</span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> lp = 0; lp &lt; leaveNum; lp++) {</div>
<div class="line"><span class="lineno">  264</span>          <span class="comment">/*- Histogramから減らしながら追加 -*/</span></div>
<div class="line"><span class="lineno">  265</span>          leavingPartIndex.append(myHistogram[m].takeFirst());</div>
<div class="line"><span class="lineno">  266</span>          <span class="comment">/*- 残数を減らす -*/</span></div>
<div class="line"><span class="lineno">  267</span>          partLeft--;</div>
<div class="line"><span class="lineno">  268</span>          <span class="keywordflow">if</span> (partLeft == 0) <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  269</span>        }</div>
<div class="line"><span class="lineno">  270</span>        <span class="keywordflow">if</span> (partLeft == 0) <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  271</span>      }</div>
<div class="line"><span class="lineno">  272</span> </div>
<div class="line"><span class="lineno">  273</span>      <span class="comment">/*- ひとつも出発出来なければbreak -*/</span></div>
<div class="line"><span class="lineno">  274</span>      <span class="keywordflow">if</span> (partLeft == PrePartLeft) <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  275</span>    }</div>
<div class="line"><span class="lineno">  276</span>    <span class="comment">/*- 実際に飛び出せた粒子数 -*/</span></div>
<div class="line"><span class="lineno">  277</span>    actualBirthParticles = leavingPartIndex.size();</div>
<div class="line"><span class="lineno">  278</span>  } <span class="keywordflow">else</span> <span class="comment">/*- 何も刺さっていなければ、ランダムに発生させる -*/</span></div>
<div class="line"><span class="lineno">  279</span>  {</div>
<div class="line"><span class="lineno">  280</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; actualBirthParticles; i++) leavingPartIndex.append(i);</div>
<div class="line"><span class="lineno">  281</span>  }</div>
<div class="line"><span class="lineno">  282</span> </div>
<div class="line"><span class="lineno">  283</span>  <span class="comment">/*- 動かす粒子も生まれる粒子も無い -*/</span></div>
<div class="line"><span class="lineno">  284</span>  <span class="keywordflow">if</span> (myParticles.empty() &amp;&amp; actualBirthParticles == 0) {</div>
<div class="line"><span class="lineno">  285</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;no particles generated nor alive. returning function&quot;</span></div>
<div class="line"><span class="lineno">  286</span>              &lt;&lt; std::endl;</div>
<div class="line"><span class="lineno">  287</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  288</span>  }</div>
<div class="line"><span class="lineno">  289</span> </div>
<div class="line"><span class="lineno">  290</span>  <span class="comment">/*- 背景だけを描画するモードのときは、particlesOriginを更新するだけでOK -*/</span></div>
<div class="line"><span class="lineno">  291</span>  <span class="keywordflow">if</span> (values.iw_rendermode_val == Iwa_TiledParticlesFx::REND_BG) {</div>
<div class="line"><span class="lineno">  292</span>    <span class="comment">/*- インデックスを小さい順にならべる -*/</span></div>
<div class="line"><span class="lineno">  293</span>    std::sort(leavingPartIndex.begin(), leavingPartIndex.end());</div>
<div class="line"><span class="lineno">  294</span>    <span class="comment">/*- インデックス大きい方から消していく -*/</span></div>
<div class="line"><span class="lineno">  295</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> lp = leavingPartIndex.size() - 1; lp &gt;= 0; lp--)</div>
<div class="line"><span class="lineno">  296</span>      particleOrigins.removeAt(leavingPartIndex.at(lp));</div>
<div class="line"><span class="lineno">  297</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  298</span>  }</div>
<div class="line"><span class="lineno">  299</span> </div>
<div class="line"><span class="lineno">  300</span>  <span class="comment">/*- 新規粒子の生成 -*/</span></div>
<div class="line"><span class="lineno">  301</span>  <span class="comment">/*- 新規粒子しかない場合 -*/</span></div>
<div class="line"><span class="lineno">  302</span>  <span class="keywordflow">if</span> (myParticles.empty() &amp;&amp; actualBirthParticles)  <span class="comment">// Initial creation</span></div>
<div class="line"><span class="lineno">  303</span>  {</div>
<div class="line"><span class="lineno">  304</span>    <span class="comment">/*- 新たに作るパーティクルの数だけループ -*/</span></div>
<div class="line"><span class="lineno">  305</span>    <span class="keywordflow">for</span> (i = 0; i &lt; actualBirthParticles; i++) {</div>
<div class="line"><span class="lineno">  306</span>      <span class="comment">/*- 出発する粒子 -*/</span></div>
<div class="line"><span class="lineno">  307</span>      <a class="code hl_struct" href="struct_particle_origin.html">ParticleOrigin</a> po = particleOrigins.at(leavingPartIndex.at(i));</div>
<div class="line"><span class="lineno">  308</span> </div>
<div class="line"><span class="lineno">  309</span>      <span class="comment">/*-  どのTextureレベルを使うか -*/</span></div>
<div class="line"><span class="lineno">  310</span>      <span class="keywordtype">int</span> seed = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  311</span>                       values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  312</span> </div>
<div class="line"><span class="lineno">  313</span>      <span class="comment">/*-  Lifetimeを得る -*/</span></div>
<div class="line"><span class="lineno">  314</span>      <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  315</span>      <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  316</span>        lifetime = lastframe[po.level];</div>
<div class="line"><span class="lineno">  317</span>      <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  318</span>        lifetime = (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  319</span>                         ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  320</span>      }</div>
<div class="line"><span class="lineno">  321</span>      <span class="comment">/*-</span></div>
<div class="line"><span class="lineno">  322</span><span class="comment">       * この粒子が、レンダリングするフレームでも生きているか判断し、生きているなら生成</span></div>
<div class="line"><span class="lineno">  323</span><span class="comment">       * -*/</span></div>
<div class="line"><span class="lineno">  324</span>      <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame) {</div>
<div class="line"><span class="lineno">  325</span>        myParticles.push_back(<a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a>(</div>
<div class="line"><span class="lineno">  326</span>            lifetime, seed, porttiles, values, ranges, totalparticles, 0,</div>
<div class="line"><span class="lineno">  327</span>            (<span class="keywordtype">int</span>)po.level, lastframe[po.level], po.pos[0],</div>
<div class="line"><span class="lineno">  328</span>            po.pos[1],               <span class="comment">/*- 座標を指定して発生 -*/</span></div>
<div class="line"><span class="lineno">  329</span>            po.isUpward,             <span class="comment">/*- orientation を追加 -*/</span></div>
<div class="line"><span class="lineno">  330</span>            (int)po.initSourceFrame) <span class="comment">/*- 素材内の初期フレーム位置 -*/</span></div>
<div class="line"><span class="lineno">  331</span>                              );</div>
<div class="line"><span class="lineno">  332</span>      }</div>
<div class="line"><span class="lineno">  333</span>      totalparticles++;</div>
<div class="line"><span class="lineno">  334</span>    }</div>
<div class="line"><span class="lineno">  335</span>  }</div>
<div class="line"><span class="lineno">  336</span>  <span class="comment">/*- 既存粒子を動かし、かつ新規粒子を作る -*/</span></div>
<div class="line"><span class="lineno">  337</span>  <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  338</span>    std::list&lt;Iwa_Particle&gt;::iterator it;</div>
<div class="line"><span class="lineno">  339</span>    <span class="keywordflow">for</span> (it = myParticles.begin(); it != myParticles.end();) {</div>
<div class="line"><span class="lineno">  340</span>      std::list&lt;Iwa_Particle&gt;::iterator current = it;</div>
<div class="line"><span class="lineno">  341</span>      ++it;</div>
<div class="line"><span class="lineno">  342</span> </div>
<div class="line"><span class="lineno">  343</span>      <a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a> &amp;part = (*current);</div>
<div class="line"><span class="lineno">  344</span>      <span class="keywordflow">if</span> (part.scale &lt;= 0.0) <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  345</span>      <span class="keywordflow">if</span> (part.lifetime &lt;= 0)        <span class="comment">// Note: This is in line with the above</span></div>
<div class="line"><span class="lineno">  346</span>                                     <span class="comment">// &quot;lifetime&gt;curr_frame-frame&quot;</span></div>
<div class="line"><span class="lineno">  347</span>        myParticles.erase(current);  <span class="comment">// insertion counterpart</span></div>
<div class="line"><span class="lineno">  348</span>      <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  349</span>        part.move(porttiles, values, ranges, windx, windy, xgravity, ygravity,</div>
<div class="line"><span class="lineno">  350</span>                  dpi, lastframe[part.level]);</div>
<div class="line"><span class="lineno">  351</span>      }</div>
<div class="line"><span class="lineno">  352</span>    }</div>
<div class="line"><span class="lineno">  353</span> </div>
<div class="line"><span class="lineno">  354</span>    <span class="keywordflow">switch</span> (values.toplayer_val) {</div>
<div class="line"><span class="lineno">  355</span>    <span class="keywordflow">case</span> Iwa_TiledParticlesFx::TOP_YOUNGER:</div>
<div class="line"><span class="lineno">  356</span>      <span class="keywordflow">for</span> (i = 0; i &lt; actualBirthParticles; i++) {</div>
<div class="line"><span class="lineno">  357</span>        <span class="comment">/*- 出発する粒子 -*/</span></div>
<div class="line"><span class="lineno">  358</span>        <a class="code hl_struct" href="struct_particle_origin.html">ParticleOrigin</a> po = particleOrigins.at(leavingPartIndex.at(i));</div>
<div class="line"><span class="lineno">  359</span> </div>
<div class="line"><span class="lineno">  360</span>        <span class="keywordtype">int</span> seed = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  361</span>                         values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  362</span> </div>
<div class="line"><span class="lineno">  363</span>        <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  364</span>        <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  365</span>          lifetime = lastframe[po.level];</div>
<div class="line"><span class="lineno">  366</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  367</span>          lifetime =</div>
<div class="line"><span class="lineno">  368</span>              (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  369</span>                    ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  370</span>        }</div>
<div class="line"><span class="lineno">  371</span>        <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame) {</div>
<div class="line"><span class="lineno">  372</span>          myParticles.push_front(<a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a>(</div>
<div class="line"><span class="lineno">  373</span>              lifetime, seed, porttiles, values, ranges, totalparticles, 0,</div>
<div class="line"><span class="lineno">  374</span>              (<span class="keywordtype">int</span>)po.level, lastframe[po.level], po.pos[0], po.pos[1],</div>
<div class="line"><span class="lineno">  375</span>              po.isUpward,</div>
<div class="line"><span class="lineno">  376</span>              (int)po.initSourceFrame) <span class="comment">/*- 素材内の初期フレーム位置 -*/</span></div>
<div class="line"><span class="lineno">  377</span>                                 );</div>
<div class="line"><span class="lineno">  378</span>        }</div>
<div class="line"><span class="lineno">  379</span>        totalparticles++;</div>
<div class="line"><span class="lineno">  380</span>      }</div>
<div class="line"><span class="lineno">  381</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  382</span> </div>
<div class="line"><span class="lineno">  383</span>    <span class="keywordflow">case</span> Iwa_TiledParticlesFx::TOP_RANDOM:</div>
<div class="line"><span class="lineno">  384</span>      <span class="keywordflow">for</span> (i = 0; i &lt; actualBirthParticles; i++) {</div>
<div class="line"><span class="lineno">  385</span>        <span class="keywordtype">double</span> tmp = values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * myParticles.size();</div>
<div class="line"><span class="lineno">  386</span>        std::list&lt;Iwa_Particle&gt;::iterator it = myParticles.begin();</div>
<div class="line"><span class="lineno">  387</span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; tmp; j++, it++)</div>
<div class="line"><span class="lineno">  388</span>          ;</div>
<div class="line"><span class="lineno">  389</span>        {</div>
<div class="line"><span class="lineno">  390</span>          <span class="comment">/*- 出発する粒子 -*/</span></div>
<div class="line"><span class="lineno">  391</span>          <a class="code hl_struct" href="struct_particle_origin.html">ParticleOrigin</a> po = particleOrigins.at(leavingPartIndex.at(i));</div>
<div class="line"><span class="lineno">  392</span> </div>
<div class="line"><span class="lineno">  393</span>          <span class="keywordtype">int</span> seed = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  394</span>                           values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  395</span>          <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  396</span> </div>
<div class="line"><span class="lineno">  397</span>          <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  398</span>            lifetime = lastframe[po.level];</div>
<div class="line"><span class="lineno">  399</span>          <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  400</span>            lifetime =</div>
<div class="line"><span class="lineno">  401</span>                (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  402</span>                      ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  403</span>          }</div>
<div class="line"><span class="lineno">  404</span>          <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame) {</div>
<div class="line"><span class="lineno">  405</span>            myParticles.insert(</div>
<div class="line"><span class="lineno">  406</span>                it,</div>
<div class="line"><span class="lineno">  407</span>                <a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a>(</div>
<div class="line"><span class="lineno">  408</span>                    lifetime, seed, porttiles, values, ranges, totalparticles,</div>
<div class="line"><span class="lineno">  409</span>                    0, (<span class="keywordtype">int</span>)po.level, lastframe[po.level], po.pos[0], po.pos[1],</div>
<div class="line"><span class="lineno">  410</span>                    po.isUpward,</div>
<div class="line"><span class="lineno">  411</span>                    (int)po.initSourceFrame) <span class="comment">/*- 素材内の初期フレーム位置 -*/</span></div>
<div class="line"><span class="lineno">  412</span>                );</div>
<div class="line"><span class="lineno">  413</span>          }</div>
<div class="line"><span class="lineno">  414</span>          totalparticles++;</div>
<div class="line"><span class="lineno">  415</span>        }</div>
<div class="line"><span class="lineno">  416</span>      }</div>
<div class="line"><span class="lineno">  417</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  418</span> </div>
<div class="line"><span class="lineno">  419</span>    <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno">  420</span>      <span class="keywordflow">for</span> (i = 0; i &lt; actualBirthParticles; i++) {</div>
<div class="line"><span class="lineno">  421</span>        <span class="comment">/*- 出発する粒子 -*/</span></div>
<div class="line"><span class="lineno">  422</span>        <a class="code hl_struct" href="struct_particle_origin.html">ParticleOrigin</a> po = particleOrigins.at(leavingPartIndex.at(i));</div>
<div class="line"><span class="lineno">  423</span> </div>
<div class="line"><span class="lineno">  424</span>        <span class="keywordtype">int</span> seed = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  425</span>                         values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  426</span>        <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  427</span> </div>
<div class="line"><span class="lineno">  428</span>        <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  429</span>          lifetime = lastframe[po.level];</div>
<div class="line"><span class="lineno">  430</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  431</span>          lifetime =</div>
<div class="line"><span class="lineno">  432</span>              (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  433</span>                    ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  434</span>        <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame) {</div>
<div class="line"><span class="lineno">  435</span>          myParticles.push_back(<a class="code hl_class" href="class_iwa___particle.html">Iwa_Particle</a>(</div>
<div class="line"><span class="lineno">  436</span>              lifetime, seed, porttiles, values, ranges, totalparticles, 0,</div>
<div class="line"><span class="lineno">  437</span>              (<span class="keywordtype">int</span>)po.level, lastframe[po.level], po.pos[0], po.pos[1],</div>
<div class="line"><span class="lineno">  438</span>              po.isUpward,</div>
<div class="line"><span class="lineno">  439</span>              (int)po.initSourceFrame) <span class="comment">/*-  素材内の初期フレーム位置  -*/</span></div>
<div class="line"><span class="lineno">  440</span>                                );</div>
<div class="line"><span class="lineno">  441</span>        }</div>
<div class="line"><span class="lineno">  442</span>        totalparticles++;</div>
<div class="line"><span class="lineno">  443</span>      }</div>
<div class="line"><span class="lineno">  444</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  445</span>    }</div>
<div class="line"><span class="lineno">  446</span>  }</div>
<div class="line"><span class="lineno">  447</span> </div>
<div class="line"><span class="lineno">  448</span>  <span class="comment">/*- すでに発生したparticleOriginを消去する</span></div>
<div class="line"><span class="lineno">  449</span><span class="comment">          インデックスを小さい順にならべる -*/</span></div>
<div class="line"><span class="lineno">  450</span>  std::sort(leavingPartIndex.begin(), leavingPartIndex.end());</div>
<div class="line"><span class="lineno">  451</span>  <span class="comment">/*- インデックス大きい方から消していく -*/</span></div>
<div class="line"><span class="lineno">  452</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> lp = leavingPartIndex.size() - 1; lp &gt;= 0; lp--)</div>
<div class="line"><span class="lineno">  453</span>    particleOrigins.removeAt(leavingPartIndex.at(lp));</div>
<div class="line"><span class="lineno">  454</span>}</div>
<div class="ttc" id="astructparticles__ranges_html"><div class="ttname"><a href="structparticles__ranges.html">particles_ranges</a></div><div class="ttdef"><b>Definition:</b> iwa_particles.h:127</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a43b7302085e3306caab8549957a40227" name="a43b7302085e3306caab8549957a40227"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43b7302085e3306caab8549957a40227">&#9670;&nbsp;</a></span>m_frame</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double Iwa_Particles_Engine::m_frame</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a18b67b6aae45192dd848f999166db708" name="a18b67b6aae45192dd848f999166db708"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a18b67b6aae45192dd848f999166db708">&#9670;&nbsp;</a></span>m_parent</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_iwa___tiled_particles_fx.html">Iwa_TiledParticlesFx</a>* Iwa_Particles_Engine::m_parent</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>E:/opentoonz/toonz/sources/stdfx/<a class="el" href="">iwa_particlesengine.h</a></li>
<li>E:/opentoonz/toonz/sources/stdfx/<a class="el" href="">iwa_particlesengine.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
