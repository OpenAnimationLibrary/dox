<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>opentoonz: ResourceBuilder Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">opentoonz
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="class_resource_builder-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">ResourceBuilder Class Reference<span class="mlabels"><span class="mlabel">abstract</span></span></div></div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="">tfxcachemanager.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for ResourceBuilder:</div>
<div class="dyncontent">
 <div class="center">
  <img src="class_resource_builder.png" usemap="#ResourceBuilder_map" alt=""/>
  <map id="ResourceBuilder_map" name="ResourceBuilder_map">
<area href="class_fx_resource_builder.html" alt="FxResourceBuilder" shape="rect" coords="0,56,120,80"/>
<area href="class_level_fx_builder.html" alt="LevelFxBuilder" shape="rect" coords="130,56,250,80"/>
  </map>
</div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a22ca82c4a5f190535b674a574d44e367"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_resource_builder.html#a22ca82c4a5f190535b674a574d44e367">ResourceBuilder</a> (const std::string &amp;resourceName, const <a class="el" href="class_t_smart_pointer_t.html">TFxP</a> &amp;fx, double frame, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;rs)</td></tr>
<tr class="separator:a22ca82c4a5f190535b674a574d44e367"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a93fa732060823d1af1dc4637c6ade042"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_resource_builder.html#a93fa732060823d1af1dc4637c6ade042">simBuild</a> (const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;tile)</td></tr>
<tr class="separator:a93fa732060823d1af1dc4637c6ade042"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79021377e08366222adba816402f5dc4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_resource_builder.html#a79021377e08366222adba816402f5dc4">build</a> (const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;tile)</td></tr>
<tr class="separator:a79021377e08366222adba816402f5dc4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-static-methods" name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:ae61a58c9c0af2531b73970b01e58e839"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_resource_builder.html#ae61a58c9c0af2531b73970b01e58e839">declareResource</a> (const std::string &amp;alias, const <a class="el" href="class_t_smart_pointer_t.html">TFxP</a> &amp;fx, const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;rect, double frame, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;rs, bool subtileable=true)</td></tr>
<tr class="separator:ae61a58c9c0af2531b73970b01e58e839"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pro-methods" name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr class="memitem:a7fe13ad46d69763ff7a99b17c5bf41a1"><td class="memItemLeft" align="right" valign="top"><a id="a7fe13ad46d69763ff7a99b17c5bf41a1" name="a7fe13ad46d69763ff7a99b17c5bf41a1"></a>
virtual void&#160;</td><td class="memItemRight" valign="bottom"><b>simCompute</b> (const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;rect)=0</td></tr>
<tr class="separator:a7fe13ad46d69763ff7a99b17c5bf41a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a41876ee5ff98f2840db5022ef574c035"><td class="memItemLeft" align="right" valign="top"><a id="a41876ee5ff98f2840db5022ef574c035" name="a41876ee5ff98f2840db5022ef574c035"></a>
virtual void&#160;</td><td class="memItemRight" valign="bottom"><b>compute</b> (const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;rect)=0</td></tr>
<tr class="separator:a41876ee5ff98f2840db5022ef574c035"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abeba13fe63315fb1d604439ff181a6da"><td class="memItemLeft" align="right" valign="top"><a id="abeba13fe63315fb1d604439ff181a6da" name="abeba13fe63315fb1d604439ff181a6da"></a>
virtual void&#160;</td><td class="memItemRight" valign="bottom"><b>upload</b> (<a class="el" href="class_t_cache_resource_p.html">TCacheResourceP</a> &amp;resource)=0</td></tr>
<tr class="separator:abeba13fe63315fb1d604439ff181a6da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77aa9e18a479bdb36a04b67032d393a5"><td class="memItemLeft" align="right" valign="top"><a id="a77aa9e18a479bdb36a04b67032d393a5" name="a77aa9e18a479bdb36a04b67032d393a5"></a>
virtual bool&#160;</td><td class="memItemRight" valign="bottom"><b>download</b> (<a class="el" href="class_t_cache_resource_p.html">TCacheResourceP</a> &amp;resource)=0</td></tr>
<tr class="separator:a77aa9e18a479bdb36a04b67032d393a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p >The <a class="el" href="class_resource_builder.html">ResourceBuilder</a> class is the preferential base interface that must be used to by eventual users to interact with the Toonz cache during render processes.</p>
<p >Caching can be used to specify that some intermediate rendering result is useful, and efforts should be taken to ensure that it is stored in memory rather than repeatedly rebuilt, when it is sufficiently convenient. <br  />
These kind of operations are automatically performed by Toonz on the overall results of fx nodes - users should definitely implement hidden fx nodes rather than a specialized <a class="el" href="class_resource_builder.html">ResourceBuilder</a> class. However, <a class="el" href="class_resource_builder.html">ResourceBuilder</a> provides a more simple and generic API than <a class="el" href="class_t_raster_fx.html" title="TRasterFx is the base class for any renderable Toonz Fx.">TRasterFx</a>'s, and does not force code splitting into several fxs.</p>
<p >This class already works out most of the implementation details necessary to deal with cache management and predictability issues. <br  />
 <br  />
It just requires the implementation of two essential functions:</p>
<p >The compute() method, which performs the effective calculation of the passed tile.  The simCompute() method, which is a dummy simulation of the above compute(), used by the builder for predictive purposes.</p>
<p >Please refer to their descriptions for implementation details. <br  />
 <br  />
Once the necessary compute() and simCompute() functions have been supplied, the <a class="el" href="class_resource_builder.html">ResourceBuilder</a> can be used to obtain the resource data associated with passed <a class="el" href="class_t_tile.html">TTile</a> simply by invoking the build() method. The build() invocation performs all the cache resource availability checkings, retrieval, and the eventual resource calculation on its own. <br  />
 <br  />
The simBuild() method is the dummy counterpart for build(), which must be used in the simCompute() simulations whenever some father resource requires that a child resource is built first. </p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a22ca82c4a5f190535b674a574d44e367" name="a22ca82c4a5f190535b674a574d44e367"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22ca82c4a5f190535b674a574d44e367">&#9670;&nbsp;</a></span>ResourceBuilder()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ResourceBuilder::ResourceBuilder </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>resourceName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_smart_pointer_t.html">TFxP</a> &amp;&#160;</td>
          <td class="paramname"><em>fx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>rs</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  501</span>    : m_cacheManager(TFxCacheManager::instance())</div>
<div class="line"><span class="lineno">  502</span>    , m_data(m_cacheManager-&gt;getResource(resourceName, fx, frame, rs)) {</div>
<div class="line"><span class="lineno">  503</span><span class="preprocessor">#ifdef WRITESTACK</span></div>
<div class="line"><span class="lineno">  504</span>  DIAGNOSTICS_THRSET(<span class="stringliteral">&quot;frame&quot;</span>, frame);</div>
<div class="line"><span class="lineno">  505</span>  DIAGNOSTICS_THRSTRSET(</div>
<div class="line"><span class="lineno">  506</span>      <span class="stringliteral">&quot;frameStr&quot;</span>,</div>
<div class="line"><span class="lineno">  507</span>      <span class="stringliteral">&quot;Frame &quot;</span> + QString::number(frame).rightJustified(4, <span class="charliteral">&#39; &#39;</span>) + <span class="stringliteral">&quot; | &quot;</span>);</div>
<div class="line"><span class="lineno">  508</span>  DIAGNOSTICS_THRSTRSET(<span class="stringliteral">&quot;stackVar&quot;</span>, DIAGNOSTICS_GLOSTRGET(<span class="stringliteral">&quot;status&quot;</span>) + <span class="stringliteral">&quot;sv&quot;</span> +</div>
<div class="line"><span class="lineno">  509</span>                                        DIAGNOSTICS_GLOSTRGET(<span class="stringliteral">&quot;instVar&quot;</span>) +</div>
<div class="line"><span class="lineno">  510</span>                                        <span class="stringliteral">&quot;fr&quot;</span> + QString::number(frame));</div>
<div class="line"><span class="lineno">  511</span>  DIAGNOSTICS_THRSTRSET(<span class="stringliteral">&quot;ResourceName&quot;</span>,</div>
<div class="line"><span class="lineno">  512</span>                        QString::fromStdString(resourceName).left(35));</div>
<div class="line"><span class="lineno">  513</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  514</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a5f448ed5c33a431b0778fdbba37ab22c" name="a5f448ed5c33a431b0778fdbba37ab22c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5f448ed5c33a431b0778fdbba37ab22c">&#9670;&nbsp;</a></span>~ResourceBuilder()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual ResourceBuilder::~ResourceBuilder </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   87</span>{}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a79021377e08366222adba816402f5dc4" name="a79021377e08366222adba816402f5dc4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79021377e08366222adba816402f5dc4">&#9670;&nbsp;</a></span>build()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ResourceBuilder::build </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;&#160;</td>
          <td class="paramname"><em>tile</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  691</span>                                                  {</div>
<div class="line"><span class="lineno">  692</span><span class="preprocessor">#ifdef WRITESTACK</span></div>
<div class="line"><span class="lineno">  693</span>  QString resName(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;ResourceName&quot;</span>));</div>
<div class="line"><span class="lineno">  694</span> </div>
<div class="line"><span class="lineno">  695</span>  QString renderStr(DIAGNOSTICS_GLOSTRGET(<span class="stringliteral">&quot;compRenderStr&quot;</span>));</div>
<div class="line"><span class="lineno">  696</span>  QString frameStr(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;frameStr&quot;</span>));</div>
<div class="line"><span class="lineno">  697</span>  DIAGNOSTICS_NUMBEREDSTRSET(</div>
<div class="line"><span class="lineno">  698</span>      prefixComp + renderStr + frameStr, DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>),</div>
<div class="line"><span class="lineno">  699</span>      DIAGNOSTICS_STACKGET(<span class="stringliteral">&quot;parentResource&quot;</span>) + <span class="stringliteral">&quot; &quot;</span> + resName,</div>
<div class="line"><span class="lineno">  700</span>      ::traduce(tileRect), 4);</div>
<div class="line"><span class="lineno">  701</span>  DIAGNOSTICS_PUSHAUTO(</div>
<div class="line"><span class="lineno">  702</span>      <span class="stringliteral">&quot;parentResource&quot;</span>,</div>
<div class="line"><span class="lineno">  703</span>      QString::number(DIAGNOSTICS_GLOGET(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>))),</div>
<div class="line"><span class="lineno">  704</span>      bla);</div>
<div class="line"><span class="lineno">  705</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  706</span> </div>
<div class="line"><span class="lineno">  707</span>  <span class="comment">// If there is no resource, just compute the tile directly.</span></div>
<div class="line"><span class="lineno">  708</span>  <span class="keywordflow">if</span> (!m_data.second) {</div>
<div class="line"><span class="lineno">  709</span><span class="preprocessor">#ifdef WRITEGENERAL</span></div>
<div class="line"><span class="lineno">  710</span>    <span class="keywordflow">if</span> (m_data.first)</div>
<div class="line"><span class="lineno">  711</span>      <span class="keywordflow">if</span> (m_data.first-&gt;m_tilesCount &gt; 0)</div>
<div class="line"><span class="lineno">  712</span>        DIAGNOSTICS_ADD(</div>
<div class="line"><span class="lineno">  713</span>            prefixErr +</div>
<div class="line"><span class="lineno">  714</span>                <span class="stringliteral">&quot;Computing | No-resource build, active decl, tilesCount &gt; 0&quot;</span>,</div>
<div class="line"><span class="lineno">  715</span>            1);</div>
<div class="line"><span class="lineno">  716</span>      <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  717</span>        DIAGNOSTICS_ADD(</div>
<div class="line"><span class="lineno">  718</span>            prefixErr +</div>
<div class="line"><span class="lineno">  719</span>                <span class="stringliteral">&quot;Computing | No-resource build, active decl, tilesCount &lt;= 0&quot;</span>,</div>
<div class="line"><span class="lineno">  720</span>            1);</div>
<div class="line"><span class="lineno">  721</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  722</span> </div>
<div class="line"><span class="lineno">  723</span>    <span class="comment">// assert(!m_data.first);  //Should have been erased before the COMPUTING</span></div>
<div class="line"><span class="lineno">  724</span>    <span class="comment">// run.</span></div>
<div class="line"><span class="lineno">  725</span>    compute(tileRect);</div>
<div class="line"><span class="lineno">  726</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  727</span>  }</div>
<div class="line"><span class="lineno">  728</span> </div>
<div class="line"><span class="lineno">  729</span>  <span class="comment">// Since this function must be thread-safe, use the appropriate</span></div>
<div class="line"><span class="lineno">  730</span>  <span class="comment">// synchronization tool.</span></div>
<div class="line"><span class="lineno">  731</span>  QMutexLocker locker(m_data.second-&gt;getMutex());</div>
<div class="line"><span class="lineno">  732</span> </div>
<div class="line"><span class="lineno">  733</span>  <span class="comment">// Without declaration, you can just deal with the required tile.</span></div>
<div class="line"><span class="lineno">  734</span>  <span class="keywordflow">if</span> (!(m_data.first &amp;&amp; m_data.first-&gt;m_tilesCount &gt; 0)) {</div>
<div class="line"><span class="lineno">  735</span><span class="preprocessor">#ifdef WRITEGENERAL</span></div>
<div class="line"><span class="lineno">  736</span>    <span class="keywordflow">if</span> (!m_data.first)</div>
<div class="line"><span class="lineno">  737</span>      DIAGNOSTICS_ADD(<span class="stringliteral">&quot;#error.txt | Resources without declaration&quot;</span>, 1);</div>
<div class="line"><span class="lineno">  738</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  739</span>      DIAGNOSTICS_ADD(<span class="stringliteral">&quot;#error.txt | Resources with declaration, tilesCount &lt;=0&quot;</span>,</div>
<div class="line"><span class="lineno">  740</span>                      1);</div>
<div class="line"><span class="lineno">  741</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  742</span> </div>
<div class="line"><span class="lineno">  743</span>    <span class="keywordflow">if</span> (download(m_data.second)) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  744</span> </div>
<div class="line"><span class="lineno">  745</span>    compute(tileRect);</div>
<div class="line"><span class="lineno">  746</span> </div>
<div class="line"><span class="lineno">  747</span>    <span class="comment">// Since there is an associated resource, the calculated content is</span></div>
<div class="line"><span class="lineno">  748</span>    <span class="comment">// supposedly</span></div>
<div class="line"><span class="lineno">  749</span>    <span class="comment">// an interesting one. Upload it.</span></div>
<div class="line"><span class="lineno">  750</span>    upload(m_data.second);</div>
<div class="line"><span class="lineno">  751</span> </div>
<div class="line"><span class="lineno">  752</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  753</span>  }</div>
<div class="line"><span class="lineno">  754</span> </div>
<div class="line"><span class="lineno">  755</span>  <span class="comment">// Now, both the declaration and the resource exist.</span></div>
<div class="line"><span class="lineno">  756</span> </div>
<div class="line"><span class="lineno">  757</span>  <span class="comment">// Retrieve the predicted tile that must be built in place of tile.</span></div>
<div class="line"><span class="lineno">  758</span>  <a class="code hl_class" href="class_t_dimension_t.html">TDimension</a> dim(tileRect.getLx(), tileRect.getLy());</div>
<div class="line"><span class="lineno">  759</span> </div>
<div class="line"><span class="lineno">  760</span>  std::vector&lt;ResourceDeclaration::TileData *&gt; tiles;</div>
<div class="line"><span class="lineno">  761</span>  <span class="keywordtype">bool</span> fittingPrediction = getTilesToBuild(m_data, tileRect, tiles);</div>
<div class="line"><span class="lineno">  762</span> </div>
<div class="line"><span class="lineno">  763</span>  <span class="keywordflow">if</span> (!fittingPrediction) {</div>
<div class="line"><span class="lineno">  764</span><span class="preprocessor">#ifdef WRITEGENERAL</span></div>
<div class="line"><span class="lineno">  765</span>    DIAGNOSTICS_ADD(prefixErr + <span class="stringliteral">&quot;Computing | Not fitting tiles&quot;</span>, 1);</div>
<div class="line"><span class="lineno">  766</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  767</span> </div>
<div class="line"><span class="lineno">  768</span>    <span class="comment">// If the required tile is not fitting the prediction, we assume it is a</span></div>
<div class="line"><span class="lineno">  769</span>    <span class="comment">// full un-predicted one - so no reference count will be updated (this would</span></div>
<div class="line"><span class="lineno">  770</span>    <span class="comment">// comply</span></div>
<div class="line"><span class="lineno">  771</span>    <span class="comment">// with the simCompute() method, in case we assume that mis-predicted</span></div>
<div class="line"><span class="lineno">  772</span>    <span class="comment">// computes are always prudently built IN EXCESS).</span></div>
<div class="line"><span class="lineno">  773</span> </div>
<div class="line"><span class="lineno">  774</span>    <span class="comment">// For now, just calculate it and stop.</span></div>
<div class="line"><span class="lineno">  775</span>    locker.unlock();</div>
<div class="line"><span class="lineno">  776</span> </div>
<div class="line"><span class="lineno">  777</span>    compute(tileRect);</div>
<div class="line"><span class="lineno">  778</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  779</span>  }</div>
<div class="line"><span class="lineno">  780</span> </div>
<div class="line"><span class="lineno">  781</span>  <span class="comment">// If necessary, calculate something</span></div>
<div class="line"><span class="lineno">  782</span>  <span class="keywordflow">if</span> (tiles.size() &gt; 0) {</div>
<div class="line"><span class="lineno">  783</span>    <span class="comment">// For every tile to build</span></div>
<div class="line"><span class="lineno">  784</span>    std::vector&lt;ResourceDeclaration::TileData *&gt;::iterator it;</div>
<div class="line"><span class="lineno">  785</span>    <span class="keywordflow">for</span> (it = tiles.begin(); it != tiles.end(); ++it) {</div>
<div class="line"><span class="lineno">  786</span>      <a class="code hl_struct" href="struct_resource_declaration_1_1_tile_data.html">ResourceDeclaration::TileData</a> &amp;tileData = **it;</div>
<div class="line"><span class="lineno">  787</span> </div>
<div class="line"><span class="lineno">  788</span>      <span class="comment">// If the tile can be downloaded from the resource, it&#39;s because it has</span></div>
<div class="line"><span class="lineno">  789</span>      <span class="comment">// actually</span></div>
<div class="line"><span class="lineno">  790</span>      <span class="comment">// been calculated by another render process - either a concurrent one, or</span></div>
<div class="line"><span class="lineno">  791</span>      <span class="comment">// any</span></div>
<div class="line"><span class="lineno">  792</span>      <span class="comment">// which has written this resource part on disk storage.</span></div>
<div class="line"><span class="lineno">  793</span> </div>
<div class="line"><span class="lineno">  794</span>      <span class="comment">// Since reference counts built in the simCompute assume that tiles</span></div>
<div class="line"><span class="lineno">  795</span>      <span class="comment">// downloaded</span></div>
<div class="line"><span class="lineno">  796</span>      <span class="comment">// from the resource have been calculated in THIS very render process,</span></div>
<div class="line"><span class="lineno">  797</span>      <span class="comment">// therefore having tileData.m_calculated == true, in this case</span></div>
<div class="line"><span class="lineno">  798</span>      <span class="comment">// heir refCounts must be updated since no computing will happen on them</span></div>
<div class="line"><span class="lineno">  799</span>      <span class="comment">// due to the predicted node builds of this resource.</span></div>
<div class="line"><span class="lineno">  800</span>      <a class="code hl_class" href="class_t_rect_t.html">TRect</a> tileRectI(tileData.m_rect.<a class="code hl_variable" href="class_t_rect_t.html#ac008cbc625f50d8b3c180c8eb2594cdb">x0</a>, tileData.m_rect.y0,</div>
<div class="line"><span class="lineno">  801</span>                      tileData.m_rect.x1 - 1, tileData.m_rect.y1 - 1);</div>
<div class="line"><span class="lineno">  802</span> </div>
<div class="line"><span class="lineno">  803</span>      <span class="keywordflow">if</span> (m_data.second-&gt;canDownloadAll(tileRectI)) {</div>
<div class="line"><span class="lineno">  804</span>        <span class="keywordflow">if</span> (!tileData.m_calculated &amp;&amp; tileData.m_refCount &gt; 0) {</div>
<div class="line"><span class="lineno">  805</span>          <span class="comment">/*#ifdef WRITESTACK</span></div>
<div class="line"><span class="lineno">  806</span><span class="comment">QString renderStr(DIAGNOSTICS_GLOSTRGET(&quot;compRenderStr&quot;));</span></div>
<div class="line"><span class="lineno">  807</span><span class="comment">QString frameStr(DIAGNOSTICS_THRSTRGET(&quot;frameStr&quot;));</span></div>
<div class="line"><span class="lineno">  808</span><span class="comment">DIAGNOSTICS_NUMBEREDSTRSET(prefixComp + renderStr + frameStr,</span></div>
<div class="line"><span class="lineno">  809</span><span class="comment">DIAGNOSTICS_THRSTRGET(&quot;stackVar&quot;), &quot;$ &gt; &quot; + resName,</span></div>
<div class="line"><span class="lineno">  810</span><span class="comment">::traduce(tileData.m_rect), 4);</span></div>
<div class="line"><span class="lineno">  811</span><span class="comment">#endif*/</span></div>
<div class="line"><span class="lineno">  812</span> </div>
<div class="line"><span class="lineno">  813</span>          <span class="comment">// Deplete children refsCount - rely on the simulated procedure</span></div>
<div class="line"><span class="lineno">  814</span>          simCompute(tileData.m_rect);</div>
<div class="line"><span class="lineno">  815</span>        }</div>
<div class="line"><span class="lineno">  816</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  817</span><span class="preprocessor">#ifdef WRITESUBRECTS</span></div>
<div class="line"><span class="lineno">  818</span>        DIAGNOSTICS_NUMBEREDSTRSET(</div>
<div class="line"><span class="lineno">  819</span>            prefixComp + renderStr + frameStr,</div>
<div class="line"><span class="lineno">  820</span>            DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>),</div>
<div class="line"><span class="lineno">  821</span>            DIAGNOSTICS_STACKGET(<span class="stringliteral">&quot;parentResource&quot;</span>) + <span class="stringliteral">&quot;   &quot;</span> + resName,</div>
<div class="line"><span class="lineno">  822</span>            ::traduce(tileData.m_rect), 4);</div>
<div class="line"><span class="lineno">  823</span>        DIAGNOSTICS_PUSHAUTO(<span class="stringliteral">&quot;parentResource&quot;</span>,</div>
<div class="line"><span class="lineno">  824</span>                             QString::number(DIAGNOSTICS_GLOGET(</div>
<div class="line"><span class="lineno">  825</span>                                 DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>))),</div>
<div class="line"><span class="lineno">  826</span>                             bla2);</div>
<div class="line"><span class="lineno">  827</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  828</span> </div>
<div class="line"><span class="lineno">  829</span>        <span class="comment">// Compute the tile to be calculated</span></div>
<div class="line"><span class="lineno">  830</span>        compute(tileData.m_rect);</div>
<div class="line"><span class="lineno">  831</span>        <span class="keywordflow">if</span> (tileData.m_refCount &gt; 0) tileData.m_calculated = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  832</span> </div>
<div class="line"><span class="lineno">  833</span>        <span class="comment">// Upload the tile into the resource - do so even if the tile</span></div>
<div class="line"><span class="lineno">  834</span>        <span class="comment">// was unpredicted. In this case, we rely on the resource refCount to</span></div>
<div class="line"><span class="lineno">  835</span>        <span class="comment">// provide the deallocations... Should be so?</span></div>
<div class="line"><span class="lineno">  836</span>        upload(m_data.second);</div>
<div class="line"><span class="lineno">  837</span>      }</div>
<div class="line"><span class="lineno">  838</span>    }</div>
<div class="line"><span class="lineno">  839</span>  }</div>
<div class="line"><span class="lineno">  840</span> </div>
<div class="line"><span class="lineno">  841</span>  <span class="comment">// Finally, download the built resource in the required tile</span></div>
<div class="line"><span class="lineno">  842</span>  <span class="keywordtype">bool</span> ret = download(m_data.second);</div>
<div class="line"><span class="lineno">  843</span>  assert(ret);</div>
<div class="line"><span class="lineno">  844</span> </div>
<div class="line"><span class="lineno">  845</span><span class="preprocessor">#ifdef WRITESTACK</span></div>
<div class="line"><span class="lineno">  846</span>  <span class="keywordflow">if</span> (!ret)</div>
<div class="line"><span class="lineno">  847</span>    DIAGNOSTICS_STRSET(</div>
<div class="line"><span class="lineno">  848</span>        prefixErr + <span class="stringliteral">&quot;Download falliti | &quot;</span> +</div>
<div class="line"><span class="lineno">  849</span>            DIAGNOSTICS_GLOSTRGET(<span class="stringliteral">&quot;compRenderStr&quot;</span>) +</div>
<div class="line"><span class="lineno">  850</span>            DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;frameStr&quot;</span>) +</div>
<div class="line"><span class="lineno">  851</span>            QString::number(</div>
<div class="line"><span class="lineno">  852</span>                DIAGNOSTICS_GLOGET(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>))),</div>
<div class="line"><span class="lineno">  853</span>        <span class="stringliteral">&quot;CROP #&quot;</span> + QString::number(DIAGNOSTICS_GLOGET(<span class="stringliteral">&quot;crStack&quot;</span>)));</div>
<div class="line"><span class="lineno">  854</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  855</span> </div>
<div class="line"><span class="lineno">  856</span>  <span class="comment">// Deplete a usage for all tiles intersecting the downloaded one. Fully</span></div>
<div class="line"><span class="lineno">  857</span>  <span class="comment">// depleted</span></div>
<div class="line"><span class="lineno">  858</span>  <span class="comment">// tiles become unpredicted from now on.</span></div>
<div class="line"><span class="lineno">  859</span>  std::vector&lt;ResourceDeclaration::TileData&gt; &amp;resTiles = m_data.first-&gt;m_tiles;</div>
<div class="line"><span class="lineno">  860</span>  std::vector&lt;ResourceDeclaration::TileData&gt;::iterator it;</div>
<div class="line"><span class="lineno">  861</span>  <span class="keywordflow">for</span> (it = resTiles.begin(); it != resTiles.end(); ++it) {</div>
<div class="line"><span class="lineno">  862</span>    <a class="code hl_struct" href="struct_resource_declaration_1_1_tile_data.html">ResourceDeclaration::TileData</a> &amp;tileData = *it;</div>
<div class="line"><span class="lineno">  863</span> </div>
<div class="line"><span class="lineno">  864</span>    <span class="keywordflow">if</span> (!isEmpty(tileData.m_rect * tileRect)) {</div>
<div class="line"><span class="lineno">  865</span>      <span class="keywordflow">if</span> (tileData.m_refCount &lt;= 0) {</div>
<div class="line"><span class="lineno">  866</span><span class="preprocessor">#ifdef WRITEGENERAL</span></div>
<div class="line"><span class="lineno">  867</span>        DIAGNOSTICS_ADD(prefixErr + <span class="stringliteral">&quot;Computing | Over-used subtiles&quot;</span>, 1);</div>
<div class="line"><span class="lineno">  868</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  869</span> </div>
<div class="line"><span class="lineno">  870</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  871</span>      }</div>
<div class="line"><span class="lineno">  872</span> </div>
<div class="line"><span class="lineno">  873</span>      <span class="keywordflow">if</span> (--tileData.m_refCount == 0) {</div>
<div class="line"><span class="lineno">  874</span>        tileData.m_calculated = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  875</span>        --m_data.first-&gt;m_tilesCount;</div>
<div class="line"><span class="lineno">  876</span>      }</div>
<div class="line"><span class="lineno">  877</span> </div>
<div class="line"><span class="lineno">  878</span>      <a class="code hl_class" href="class_t_rect_t.html">TRect</a> tileRectI(tileData.m_rect.<a class="code hl_variable" href="class_t_rect_t.html#ac008cbc625f50d8b3c180c8eb2594cdb">x0</a>, tileData.m_rect.y0,</div>
<div class="line"><span class="lineno">  879</span>                      tileData.m_rect.x1 - 1, tileData.m_rect.y1 - 1);</div>
<div class="line"><span class="lineno">  880</span> </div>
<div class="line"><span class="lineno">  881</span>      m_data.second-&gt;release2(tileRectI);</div>
<div class="line"><span class="lineno">  882</span>    }</div>
<div class="line"><span class="lineno">  883</span>  }</div>
<div class="line"><span class="lineno">  884</span> </div>
<div class="line"><span class="lineno">  885</span>  <span class="comment">// If the declaration has been completely used up, destroy it.</span></div>
<div class="line"><span class="lineno">  886</span>  <span class="comment">// NOTE: Keeping the declarations is useful for diagnostic purposes. The</span></div>
<div class="line"><span class="lineno">  887</span>  <span class="comment">// following code</span></div>
<div class="line"><span class="lineno">  888</span>  <span class="comment">// could be reactivated - but declarations tend to be lightweight now...</span></div>
<div class="line"><span class="lineno">  889</span>  <span class="comment">// NOTE: If re-enabled, competing mutexes must be set where the resourcesData</span></div>
<div class="line"><span class="lineno">  890</span>  <span class="comment">// map is used...</span></div>
<div class="line"><span class="lineno">  891</span>  <span class="comment">/*if(m_data.first-&gt;m_tilesCount &lt;= 0)</span></div>
<div class="line"><span class="lineno">  892</span><span class="comment">{</span></div>
<div class="line"><span class="lineno">  893</span><span class="comment">QMutexLocker locker(&amp;m_cacheManager-&gt;m_imp-&gt;m_mutex);</span></div>
<div class="line"><span class="lineno">  894</span><span class="comment">m_cacheManager-&gt;m_imp-&gt;m_resourcesData.erase(m_data.second-&gt;getName());</span></div>
<div class="line"><span class="lineno">  895</span><span class="comment">}*/</span></div>
<div class="line"><span class="lineno">  896</span>}</div>
<div class="ttc" id="aclass_t_dimension_t_html"><div class="ttname"><a href="class_t_dimension_t.html">TDimensionT&lt; int &gt;</a></div></div>
<div class="ttc" id="aclass_t_rect_t_html"><div class="ttname"><a href="class_t_rect_t.html">TRectT&lt; int &gt;</a></div></div>
<div class="ttc" id="aclass_t_rect_t_html_ac008cbc625f50d8b3c180c8eb2594cdb"><div class="ttname"><a href="class_t_rect_t.html#ac008cbc625f50d8b3c180c8eb2594cdb">TRectT::x0</a></div><div class="ttdeci">T x0</div><div class="ttdef"><b>Definition:</b> tgeometry.h:557</div></div>
<div class="ttc" id="astruct_resource_declaration_1_1_tile_data_html"><div class="ttname"><a href="struct_resource_declaration_1_1_tile_data.html">ResourceDeclaration::TileData</a></div><div class="ttdef"><b>Definition:</b> tfxcachemanager.h:136</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae61a58c9c0af2531b73970b01e58e839" name="ae61a58c9c0af2531b73970b01e58e839"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae61a58c9c0af2531b73970b01e58e839">&#9670;&nbsp;</a></span>declareResource()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ResourceBuilder::declareResource </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>alias</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_smart_pointer_t.html">TFxP</a> &amp;&#160;</td>
          <td class="paramname"><em>fx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;&#160;</td>
          <td class="paramname"><em>rect</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>rs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>subtileable</em> = <code>true</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  521</span>                                                        {</div>
<div class="line"><span class="lineno">  522</span>  TFxCacheManager::instance()-&gt;declareResource(alias, fx, rect, frame, rs,</div>
<div class="line"><span class="lineno">  523</span>                                               subtileable);</div>
<div class="line"><span class="lineno">  524</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a93fa732060823d1af1dc4637c6ade042" name="a93fa732060823d1af1dc4637c6ade042"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a93fa732060823d1af1dc4637c6ade042">&#9670;&nbsp;</a></span>simBuild()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ResourceBuilder::simBuild </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="class_t_rect_t.html">TRectD</a> &amp;&#160;</td>
          <td class="paramname"><em>tile</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  564</span>                                                 {</div>
<div class="line"><span class="lineno">  565</span>  <span class="comment">// Retrieve the render status</span></div>
<div class="line"><span class="lineno">  566</span>  <span class="keywordtype">int</span> renderStatus = m_cacheManager-&gt;m_imp-&gt;m_renderStatus;</div>
<div class="line"><span class="lineno">  567</span> </div>
<div class="line"><span class="lineno">  568</span>  <span class="comment">// In the initial precomputing stage, just retrieve all the declarations</span></div>
<div class="line"><span class="lineno">  569</span>  <span class="comment">// without efforts.</span></div>
<div class="line"><span class="lineno">  570</span>  <span class="keywordflow">if</span> (renderStatus == TRenderer::FIRSTRUN) {</div>
<div class="line"><span class="lineno">  571</span>    simCompute(rect);</div>
<div class="line"><span class="lineno">  572</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  573</span>  }</div>
<div class="line"><span class="lineno">  574</span> </div>
<div class="line"><span class="lineno">  575</span>  <span class="comment">// Perform the test run</span></div>
<div class="line"><span class="lineno">  576</span>  <span class="keywordflow">if</span> (renderStatus == TRenderer::TESTRUN) {</div>
<div class="line"><span class="lineno">  577</span>    <span class="keywordflow">if</span> (!(m_data.first &amp;&amp; m_data.second)) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  578</span> </div>
<div class="line"><span class="lineno">  579</span><span class="preprocessor">#ifdef WRITESTACK</span></div>
<div class="line"><span class="lineno">  580</span>    QString resName(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;ResourceName&quot;</span>));</div>
<div class="line"><span class="lineno">  581</span> </div>
<div class="line"><span class="lineno">  582</span>    QString renderStr(DIAGNOSTICS_GLOSTRGET(<span class="stringliteral">&quot;testRenderStr&quot;</span>));</div>
<div class="line"><span class="lineno">  583</span>    QString frameStr(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;frameStr&quot;</span>));</div>
<div class="line"><span class="lineno">  584</span>    DIAGNOSTICS_NUMBEREDSTRSET(</div>
<div class="line"><span class="lineno">  585</span>        prefixTest + renderStr + frameStr, DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>),</div>
<div class="line"><span class="lineno">  586</span>        DIAGNOSTICS_STACKGET(<span class="stringliteral">&quot;parentResource&quot;</span>) + <span class="stringliteral">&quot; &quot;</span> + resName, ::traduce(rect),</div>
<div class="line"><span class="lineno">  587</span>        4);</div>
<div class="line"><span class="lineno">  588</span>    DIAGNOSTICS_PUSHAUTO(</div>
<div class="line"><span class="lineno">  589</span>        <span class="stringliteral">&quot;parentResource&quot;</span>,</div>
<div class="line"><span class="lineno">  590</span>        QString::number(DIAGNOSTICS_GLOGET(DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>))),</div>
<div class="line"><span class="lineno">  591</span>        bla);</div>
<div class="line"><span class="lineno">  592</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  593</span> </div>
<div class="line"><span class="lineno">  594</span>    <span class="comment">// Retrieve the tiles to build</span></div>
<div class="line"><span class="lineno">  595</span>    std::vector&lt;ResourceDeclaration::TileData&gt; &amp;tiles = m_data.first-&gt;m_tiles;</div>
<div class="line"><span class="lineno">  596</span> </div>
<div class="line"><span class="lineno">  597</span>    <span class="comment">// For every tile intersecting rect</span></div>
<div class="line"><span class="lineno">  598</span>    std::vector&lt;ResourceDeclaration::TileData&gt;::iterator it;</div>
<div class="line"><span class="lineno">  599</span>    <span class="keywordflow">for</span> (it = tiles.begin(); it != tiles.end(); ++it) {</div>
<div class="line"><span class="lineno">  600</span>      <a class="code hl_struct" href="struct_resource_declaration_1_1_tile_data.html">ResourceDeclaration::TileData</a> &amp;tileData = *it;</div>
<div class="line"><span class="lineno">  601</span> </div>
<div class="line"><span class="lineno">  602</span>      <span class="keywordflow">if</span> (!isEmpty(tileData.m_rect * rect)) {</div>
<div class="line"><span class="lineno">  603</span>        <span class="comment">// If the tile ref count == 0, assume that this tile has not yet been</span></div>
<div class="line"><span class="lineno">  604</span>        <span class="comment">// simComputed.</span></div>
<div class="line"><span class="lineno">  605</span>        <span class="comment">// Do so, then; further, add 1 to the number of predicted actively</span></div>
<div class="line"><span class="lineno">  606</span>        <span class="comment">// accessed tiles.</span></div>
<div class="line"><span class="lineno">  607</span>        <span class="keywordflow">if</span> (tileData.m_refCount == 0) {</div>
<div class="line"><span class="lineno">  608</span><span class="preprocessor">#ifdef WRITESUBRECTS</span></div>
<div class="line"><span class="lineno">  609</span>          DIAGNOSTICS_NUMBEREDSTRSET(</div>
<div class="line"><span class="lineno">  610</span>              prefixTest + renderStr + frameStr,</div>
<div class="line"><span class="lineno">  611</span>              DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>),</div>
<div class="line"><span class="lineno">  612</span>              DIAGNOSTICS_STACKGET(<span class="stringliteral">&quot;parentResource&quot;</span>) + <span class="stringliteral">&quot;   &quot;</span> + resName,</div>
<div class="line"><span class="lineno">  613</span>              ::traduce(tileData.m_rect), 4);</div>
<div class="line"><span class="lineno">  614</span>          DIAGNOSTICS_PUSHAUTO(<span class="stringliteral">&quot;parentResource&quot;</span>,</div>
<div class="line"><span class="lineno">  615</span>                               QString::number(DIAGNOSTICS_GLOGET(</div>
<div class="line"><span class="lineno">  616</span>                                   DIAGNOSTICS_THRSTRGET(<span class="stringliteral">&quot;stackVar&quot;</span>))),</div>
<div class="line"><span class="lineno">  617</span>                               bla2);</div>
<div class="line"><span class="lineno">  618</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  619</span> </div>
<div class="line"><span class="lineno">  620</span>          simCompute(tileData.m_rect);</div>
<div class="line"><span class="lineno">  621</span>          ++m_data.first-&gt;m_tilesCount;</div>
<div class="line"><span class="lineno">  622</span>        }</div>
<div class="line"><span class="lineno">  623</span> </div>
<div class="line"><span class="lineno">  624</span>        <span class="comment">// Add a reference to this tile</span></div>
<div class="line"><span class="lineno">  625</span>        ++tileData.m_refCount;</div>
<div class="line"><span class="lineno">  626</span> </div>
<div class="line"><span class="lineno">  627</span>        <span class="keywordflow">if</span> (m_data.second) {</div>
<div class="line"><span class="lineno">  628</span>          QMutexLocker locker(m_data.second-&gt;getMutex());</div>
<div class="line"><span class="lineno">  629</span> </div>
<div class="line"><span class="lineno">  630</span>          <a class="code hl_class" href="class_t_rect_t.html">TRect</a> tileRectI(tileData.m_rect.<a class="code hl_variable" href="class_t_rect_t.html#ac008cbc625f50d8b3c180c8eb2594cdb">x0</a>, tileData.m_rect.y0,</div>
<div class="line"><span class="lineno">  631</span>                          tileData.m_rect.x1 - 1, tileData.m_rect.y1 - 1);</div>
<div class="line"><span class="lineno">  632</span> </div>
<div class="line"><span class="lineno">  633</span>          m_data.second-&gt;addRef2(tileRectI);</div>
<div class="line"><span class="lineno">  634</span>        }</div>
<div class="line"><span class="lineno">  635</span>      }</div>
<div class="line"><span class="lineno">  636</span>    }</div>
<div class="line"><span class="lineno">  637</span> </div>
<div class="line"><span class="lineno">  638</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  639</span>  }</div>
<div class="line"><span class="lineno">  640</span> </div>
<div class="line"><span class="lineno">  641</span>  <span class="comment">// In this case, the simulation is used to declare that this rect will NOT be</span></div>
<div class="line"><span class="lineno">  642</span>  <span class="comment">// calculated.</span></div>
<div class="line"><span class="lineno">  643</span>  <span class="comment">// So, this is the behaviour: 1 refCount is depleted by all cells intersecting</span></div>
<div class="line"><span class="lineno">  644</span>  <span class="comment">// the rect</span></div>
<div class="line"><span class="lineno">  645</span>  <span class="comment">// - if the refCount is still &gt;0, then another request will occur that will</span></div>
<div class="line"><span class="lineno">  646</span>  <span class="comment">// make the</span></div>
<div class="line"><span class="lineno">  647</span>  <span class="comment">// tile calculated. If it is == 0, and the tile has not yet been calculated,</span></div>
<div class="line"><span class="lineno">  648</span>  <span class="comment">// then the tile</span></div>
<div class="line"><span class="lineno">  649</span>  <span class="comment">// will supposedly be NO MORE calculated, so the simCompute has to be launched</span></div>
<div class="line"><span class="lineno">  650</span>  <span class="comment">// on that tile, too.</span></div>
<div class="line"><span class="lineno">  651</span> </div>
<div class="line"><span class="lineno">  652</span>  <span class="keywordflow">if</span> (renderStatus == TRenderer::COMPUTING) {</div>
<div class="line"><span class="lineno">  653</span>    <span class="keywordflow">if</span> (!(m_data.first &amp;&amp; m_data.second)) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  654</span> </div>
<div class="line"><span class="lineno">  655</span>    QMutexLocker locker(m_data.second-&gt;getMutex());</div>
<div class="line"><span class="lineno">  656</span> </div>
<div class="line"><span class="lineno">  657</span>    <span class="comment">// Retrieve the tiles to build</span></div>
<div class="line"><span class="lineno">  658</span>    std::vector&lt;ResourceDeclaration::TileData&gt; &amp;tiles = m_data.first-&gt;m_tiles;</div>
<div class="line"><span class="lineno">  659</span> </div>
<div class="line"><span class="lineno">  660</span>    <span class="comment">// Please note that the request should definitely be fitting the predicted</span></div>
<div class="line"><span class="lineno">  661</span>    <span class="comment">// results,</span></div>
<div class="line"><span class="lineno">  662</span>    <span class="comment">// since the original rect which generated these simCompute calls must have</span></div>
<div class="line"><span class="lineno">  663</span>    <span class="comment">// been fitting.</span></div>
<div class="line"><span class="lineno">  664</span> </div>
<div class="line"><span class="lineno">  665</span>    <span class="comment">// For every tile to build</span></div>
<div class="line"><span class="lineno">  666</span>    std::vector&lt;ResourceDeclaration::TileData&gt;::iterator it;</div>
<div class="line"><span class="lineno">  667</span>    <span class="keywordflow">for</span> (it = tiles.begin(); it != tiles.end(); ++it) {</div>
<div class="line"><span class="lineno">  668</span>      <a class="code hl_struct" href="struct_resource_declaration_1_1_tile_data.html">ResourceDeclaration::TileData</a> &amp;tileData = *it;</div>
<div class="line"><span class="lineno">  669</span> </div>
<div class="line"><span class="lineno">  670</span>      <span class="keywordflow">if</span> (!isEmpty(tileData.m_rect * rect)) {</div>
<div class="line"><span class="lineno">  671</span>        <span class="keywordflow">if</span> (tileData.m_refCount &lt;= 0) <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  672</span> </div>
<div class="line"><span class="lineno">  673</span>        <span class="keywordflow">if</span> (--tileData.m_refCount == 0 &amp;&amp; !tileData.m_calculated) {</div>
<div class="line"><span class="lineno">  674</span>          --m_data.first-&gt;m_tilesCount;</div>
<div class="line"><span class="lineno">  675</span>          simCompute(tileData.m_rect);</div>
<div class="line"><span class="lineno">  676</span>        }</div>
<div class="line"><span class="lineno">  677</span> </div>
<div class="line"><span class="lineno">  678</span>        <span class="keywordflow">if</span> (m_data.second) {</div>
<div class="line"><span class="lineno">  679</span>          <a class="code hl_class" href="class_t_rect_t.html">TRect</a> tileRectI(tileData.m_rect.<a class="code hl_variable" href="class_t_rect_t.html#ac008cbc625f50d8b3c180c8eb2594cdb">x0</a>, tileData.m_rect.y0,</div>
<div class="line"><span class="lineno">  680</span>                          tileData.m_rect.x1 - 1, tileData.m_rect.y1 - 1);</div>
<div class="line"><span class="lineno">  681</span> </div>
<div class="line"><span class="lineno">  682</span>          m_data.second-&gt;release2(tileRectI);</div>
<div class="line"><span class="lineno">  683</span>        }</div>
<div class="line"><span class="lineno">  684</span>      }</div>
<div class="line"><span class="lineno">  685</span>    }</div>
<div class="line"><span class="lineno">  686</span>  }</div>
<div class="line"><span class="lineno">  687</span>}</div>
</div><!-- fragment -->
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>E:/opentoonz/toonz/sources/include/<a class="el" href="">tfxcachemanager.h</a></li>
<li>E:/opentoonz/toonz/sources/common/tfx/<a class="el" href="">tfxcachemanager.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
