<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>opentoonz: Particles_Engine Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">opentoonz
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="class_particles___engine-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">Particles_Engine Class Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a6a643d3bcce96241986846cf6d207798"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a6a643d3bcce96241986846cf6d207798">Particles_Engine</a> (<a class="el" href="class_particles_fx.html">ParticlesFx</a> *parent, double frame)</td></tr>
<tr class="separator:a6a643d3bcce96241986846cf6d207798"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4329fd86e654d5df42cd3da11d7191b8"><td class="memItemLeft" align="right" valign="top"><a id="a4329fd86e654d5df42cd3da11d7191b8" name="a4329fd86e654d5df42cd3da11d7191b8"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>scramble_particles</b> (void)</td></tr>
<tr class="separator:a4329fd86e654d5df42cd3da11d7191b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afdd23542480a7b25a65ad6bcd7bf1106"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#afdd23542480a7b25a65ad6bcd7bf1106">fill_range_struct</a> (struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, struct <a class="el" href="structparticles__ranges.html">particles_ranges</a> &amp;ranges)</td></tr>
<tr class="separator:afdd23542480a7b25a65ad6bcd7bf1106"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abe399b2056ac8e417408d3b68b6d2428"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#abe399b2056ac8e417408d3b68b6d2428">fill_value_struct</a> (struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;value, double frame)</td></tr>
<tr class="separator:abe399b2056ac8e417408d3b68b6d2428"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09e5db1ac2446bbcde754102a3030bd2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a09e5db1ac2446bbcde754102a3030bd2">roll_particles</a> (<a class="el" href="class_t_tile.html">TTile</a> *tile, std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt; porttiles, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, std::list&lt; <a class="el" href="class_particle.html">Particle</a> &gt; &amp;myParticles, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, float cx, float cy, int frame, int curr_frame, int level_n, bool *random_level, float dpi, std::vector&lt; int &gt; lastframe, int &amp;totalparticles)</td></tr>
<tr class="separator:a09e5db1ac2446bbcde754102a3030bd2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34f547141f79b53786ec88026fc7b523"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a34f547141f79b53786ec88026fc7b523">normalize_values</a> (struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri)</td></tr>
<tr class="separator:a34f547141f79b53786ec88026fc7b523"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7574ab8a9217f960e1ce339e90c18dc"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#ab7574ab8a9217f960e1ce339e90c18dc">render_particles</a> (<a class="el" href="class_t_tile.html">TTile</a> *tile, std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; part_ports, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, <a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;p_size, <a class="el" href="class_t_point_t.html">TPointD</a> &amp;p_offset, std::map&lt; int, <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; ctrl_ports, std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt; partLevel, float dpi, int curr_frame, int shrink, double startx, double starty, double endx, double endy, std::vector&lt; int &gt; lastframe, unsigned long fxId)</td></tr>
<tr class="separator:ab7574ab8a9217f960e1ce339e90c18dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab8949faf354bbfdb3a8924b7fdf6f7e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#aab8949faf354bbfdb3a8924b7fdf6f7e">do_render</a> (<a class="el" href="class_particle.html">Particle</a> *part, <a class="el" href="class_t_tile.html">TTile</a> *tile, std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt; part_ports, std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt; porttiles, const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;ri, <a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;p_size, <a class="el" href="class_t_point_t.html">TPointD</a> &amp;p_offset, int lastframe, std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt; partLevel, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values, double opacity_range, int curr_frame, std::map&lt; std::pair&lt; int, int &gt;, double &gt; &amp;partScales)</td></tr>
<tr class="separator:aab8949faf354bbfdb3a8924b7fdf6f7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af32131f9ec282edf022cf31d64c649a6"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#af32131f9ec282edf022cf31d64c649a6">port_is_used</a> (int i, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values)</td></tr>
<tr class="separator:af32131f9ec282edf022cf31d64c649a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae93e03a8c641edfbe8a7b33fb6a1fa48"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#ae93e03a8c641edfbe8a7b33fb6a1fa48">port_is_used_for_value</a> (int i, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values)</td></tr>
<tr class="separator:ae93e03a8c641edfbe8a7b33fb6a1fa48"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a661623d1f20fea584375a24ec1911471"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a661623d1f20fea584375a24ec1911471">port_is_used_for_gradient</a> (int i, struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;values)</td></tr>
<tr class="separator:a661623d1f20fea584375a24ec1911471"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af3066bd24bec784f377849544f916534"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#af3066bd24bec784f377849544f916534">fill_regions</a> (int frame, std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, <a class="el" href="class_t_tile.html">TTile</a> *ctrl1, bool multi, int thres, bool do_source_gradation, std::vector&lt; std::vector&lt; int &gt; &gt; &amp;myHistogram)</td></tr>
<tr class="separator:af3066bd24bec784f377849544f916534"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1dd98c8f78b92b7715af11295577e09c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a1dd98c8f78b92b7715af11295577e09c">fill_single_region</a> (std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, <a class="el" href="class_t_tile.html">TTile</a> *ctrl1, int thres, bool do_source_gradation, std::vector&lt; std::vector&lt; int &gt; &gt; &amp;myHistogram)</td></tr>
<tr class="separator:a1dd98c8f78b92b7715af11295577e09c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae96c2d7be493116384ee9845831bc6bd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#ae96c2d7be493116384ee9845831bc6bd">fill_regions_with_size_map</a> (std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, std::vector&lt; std::vector&lt; int &gt; &gt; &amp;myHistogram, <a class="el" href="class_t_tile.html">TTile</a> *sizeTile, <a class="el" href="class_t_tile.html">TTile</a> *sourceTile, int thres)</td></tr>
<tr class="separator:ae96c2d7be493116384ee9845831bc6bd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab92d32ddd8f0516b4a2ba25d29595c7b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#ab92d32ddd8f0516b4a2ba25d29595c7b">fill_subregions</a> (int cont_index, std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, <a class="el" href="class_t_tile.html">TTile</a> *ctrl1, int thres)</td></tr>
<tr class="separator:ab92d32ddd8f0516b4a2ba25d29595c7b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a17b1897dea0bc5f80d4d81a43d3cb6b4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a17b1897dea0bc5f80d4d81a43d3cb6b4">normalize_array</a> (std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;myregions, <a class="el" href="class_t_point_t.html">TPointD</a> pos, int lx, int ly, int regioncounter, std::vector&lt; int &gt; &amp;myarray, std::vector&lt; int &gt; &amp;lista, std::vector&lt; int &gt; &amp;listb, std::vector&lt; int &gt; &amp;final)</td></tr>
<tr class="separator:a17b1897dea0bc5f80d4d81a43d3cb6b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1af1efc8a70dc3c9e9e3a50c97b702c6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a1af1efc8a70dc3c9e9e3a50c97b702c6">fill_array</a> (<a class="el" href="class_t_tile.html">TTile</a> *ctrl1, int &amp;regioncount, std::vector&lt; int &gt; &amp;myarray, std::vector&lt; int &gt; &amp;lista, std::vector&lt; int &gt; &amp;listb, int thres)</td></tr>
<tr class="separator:a1af1efc8a70dc3c9e9e3a50c97b702c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-attribs" name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:a4d9ac86983ecdde346bf1f865aec8d5f"><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_particles_fx.html">ParticlesFx</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#a4d9ac86983ecdde346bf1f865aec8d5f">m_parent</a></td></tr>
<tr class="separator:a4d9ac86983ecdde346bf1f865aec8d5f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afeaa4f1b12435855c7a7f662fdbf0d1e"><td class="memItemLeft" align="right" valign="top">double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_particles___engine.html#afeaa4f1b12435855c7a7f662fdbf0d1e">m_frame</a></td></tr>
<tr class="separator:afeaa4f1b12435855c7a7f662fdbf0d1e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"></div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a6a643d3bcce96241986846cf6d207798" name="a6a643d3bcce96241986846cf6d207798"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6a643d3bcce96241986846cf6d207798">&#9670;&nbsp;</a></span>Particles_Engine()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Particles_Engine::Particles_Engine </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_particles_fx.html">ParticlesFx</a> *&#160;</td>
          <td class="paramname"><em>parent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frame</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   33</span>    : m_parent(parent), m_frame(frame) {}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a60db50be8cbb0028247a63c6dcdc12c2" name="a60db50be8cbb0028247a63c6dcdc12c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60db50be8cbb0028247a63c6dcdc12c2">&#9670;&nbsp;</a></span>~Particles_Engine()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Particles_Engine::~Particles_Engine </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   19</span>{};</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="aab8949faf354bbfdb3a8924b7fdf6f7e" name="aab8949faf354bbfdb3a8924b7fdf6f7e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aab8949faf354bbfdb3a8924b7fdf6f7e">&#9670;&nbsp;</a></span>do_render()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::do_render </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_particle.html">Particle</a> *&#160;</td>
          <td class="paramname"><em>part</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>part_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt;&#160;</td>
          <td class="paramname"><em>porttiles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;&#160;</td>
          <td class="paramname"><em>p_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a> &amp;&#160;</td>
          <td class="paramname"><em>p_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt;&#160;</td>
          <td class="paramname"><em>partLevel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>opacity_range</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>curr_frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; std::pair&lt; int, int &gt;, double &gt; &amp;&#160;</td>
          <td class="paramname"><em>partScales</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  717</span>                                                   {</div>
<div class="line"><span class="lineno">  718</span>  <span class="comment">// Retrieve the particle frame - that is, the *column frame* from which we are</span></div>
<div class="line"><span class="lineno">  719</span>  <span class="comment">// picking</span></div>
<div class="line"><span class="lineno">  720</span>  <span class="comment">// the particle to be rendered.</span></div>
<div class="line"><span class="lineno">  721</span>  <span class="keywordtype">int</span> ndx = part-&gt;frame % lastframe;</div>
<div class="line"><span class="lineno">  722</span> </div>
<div class="line"><span class="lineno">  723</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> tileRas(tile-&gt;getRaster());</div>
<div class="line"><span class="lineno">  724</span> </div>
<div class="line"><span class="lineno">  725</span>  std::string levelid;</div>
<div class="line"><span class="lineno">  726</span>  <span class="keywordtype">double</span> aim_angle = 0;</div>
<div class="line"><span class="lineno">  727</span>  <span class="keywordflow">if</span> (values.pathaim_val) {</div>
<div class="line"><span class="lineno">  728</span>    <span class="keywordtype">double</span> arctan = atan2(part-&gt;vy, part-&gt;vx);</div>
<div class="line"><span class="lineno">  729</span>    aim_angle     = arctan * M_180_PI;</div>
<div class="line"><span class="lineno">  730</span>  }</div>
<div class="line"><span class="lineno">  731</span> </div>
<div class="line"><span class="lineno">  732</span>  <span class="comment">// Calculate the rotational and scale components we have to apply on the</span></div>
<div class="line"><span class="lineno">  733</span>  <span class="comment">// particle</span></div>
<div class="line"><span class="lineno">  734</span>  <a class="code hl_class" href="class_t_rotation.html">TRotation</a> rotM(part-&gt;angle + aim_angle);</div>
<div class="line"><span class="lineno">  735</span>  <a class="code hl_class" href="class_t_scale.html">TScale</a> scaleM(part-&gt;scale);</div>
<div class="line"><span class="lineno">  736</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> M(rotM * scaleM);</div>
<div class="line"><span class="lineno">  737</span> </div>
<div class="line"><span class="lineno">  738</span>  <span class="comment">// Particles deal with dpi affines on their own</span></div>
<div class="line"><span class="lineno">  739</span>  <a class="code hl_class" href="class_t_affine.html">TAffine</a> scaleAff(m_parent-&gt;handledAffine(ri, m_frame));</div>
<div class="line"><span class="lineno">  740</span>  <span class="keywordtype">double</span> partScale =</div>
<div class="line"><span class="lineno">  741</span>      scaleAff.a11 * partScales[std::pair&lt;int, int&gt;(part-&gt;level, ndx)];</div>
<div class="line"><span class="lineno">  742</span>  <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a> partResolution(0, 0);</div>
<div class="line"><span class="lineno">  743</span>  <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riNew(ri);</div>
<div class="line"><span class="lineno">  744</span> </div>
<div class="line"><span class="lineno">  745</span>  <span class="comment">// Retrieve the bounding box in the standard reference</span></div>
<div class="line"><span class="lineno">  746</span>  <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> bbox(-5.0, -5.0, 5.0, 5.0), standardRefBBox;</div>
<div class="line"><span class="lineno">  747</span>  <span class="keywordflow">if</span> (part-&gt;level &lt;</div>
<div class="line"><span class="lineno">  748</span>          (<span class="keywordtype">int</span>)part_ports.size() &amp;&amp;  <span class="comment">// Not the default levelless cases</span></div>
<div class="line"><span class="lineno">  749</span>      part_ports[part-&gt;level]-&gt;isConnected()) {</div>
<div class="line"><span class="lineno">  750</span>    <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riIdentity(ri);</div>
<div class="line"><span class="lineno">  751</span>    riIdentity.m_affine = <a class="code hl_class" href="class_t_affine.html">TAffine</a>();</div>
<div class="line"><span class="lineno">  752</span> </div>
<div class="line"><span class="lineno">  753</span>    (*part_ports[part-&gt;level])-&gt;getBBox(ndx, bbox, riIdentity);</div>
<div class="line"><span class="lineno">  754</span> </div>
<div class="line"><span class="lineno">  755</span>    <span class="comment">// A particle&#39;s bbox MUST be finite. Gradients and such which have an</span></div>
<div class="line"><span class="lineno">  756</span>    <span class="comment">// infinite bbox</span></div>
<div class="line"><span class="lineno">  757</span>    <span class="comment">// are just NOT rendered.</span></div>
<div class="line"><span class="lineno">  758</span> </div>
<div class="line"><span class="lineno">  759</span>    <span class="comment">// NOTE: No fx returns half-planes or similar (ie if any coordinate is</span></div>
<div class="line"><span class="lineno">  760</span>    <span class="comment">// either</span></div>
<div class="line"><span class="lineno">  761</span>    <span class="comment">// (std::numeric_limits&lt;double&gt;::max)() or its opposite, then the rect IS</span></div>
<div class="line"><span class="lineno">  762</span>    <span class="comment">// THE infiniteRectD)</span></div>
<div class="line"><span class="lineno">  763</span>    <span class="keywordflow">if</span> (bbox.isEmpty() || bbox == TConsts::infiniteRectD) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  764</span>  }</div>
<div class="line"><span class="lineno">  765</span> </div>
<div class="line"><span class="lineno">  766</span>  <span class="comment">// Now, these are the particle rendering specifications</span></div>
<div class="line"><span class="lineno">  767</span>  bbox            = bbox.enlarge(3);</div>
<div class="line"><span class="lineno">  768</span>  standardRefBBox = bbox;</div>
<div class="line"><span class="lineno">  769</span>  riNew.m_affine  = <a class="code hl_class" href="class_t_scale.html">TScale</a>(partScale);</div>
<div class="line"><span class="lineno">  770</span>  bbox            = riNew.m_affine * bbox;</div>
<div class="line"><span class="lineno">  771</span>  <span class="comment">/*- 縮小済みのParticleのサイズ -*/</span></div>
<div class="line"><span class="lineno">  772</span>  partResolution = <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(tceil(bbox.getLx()), tceil(bbox.getLy()));</div>
<div class="line"><span class="lineno">  773</span> </div>
<div class="line"><span class="lineno">  774</span>  <a class="code hl_class" href="class_t_smart_pointer_t.html">TRasterP</a> ras;</div>
<div class="line"><span class="lineno">  775</span> </div>
<div class="line"><span class="lineno">  776</span>  std::string alias;</div>
<div class="line"><span class="lineno">  777</span>  <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg;</div>
<div class="line"><span class="lineno">  778</span>  rimg = partLevel[part-&gt;level]-&gt;frame(ndx);</div>
<div class="line"><span class="lineno">  779</span>  <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  780</span>    ras = rimg-&gt;getRaster();</div>
<div class="line"><span class="lineno">  781</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  782</span>    alias = <span class="stringliteral">&quot;PART: &quot;</span> + (*part_ports[part-&gt;level])-&gt;getAlias(ndx, riNew);</div>
<div class="line"><span class="lineno">  783</span>    rimg  = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  784</span>    <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  785</span>      ras = rimg-&gt;getRaster();</div>
<div class="line"><span class="lineno">  786</span> </div>
<div class="line"><span class="lineno">  787</span>      <span class="comment">// Check that the raster resolution is sufficient for our purposes</span></div>
<div class="line"><span class="lineno">  788</span>      <span class="keywordflow">if</span> (ras-&gt;getLx() &lt; partResolution.lx || ras-&gt;getLy() &lt; partResolution.ly)</div>
<div class="line"><span class="lineno">  789</span>        ras = 0;</div>
<div class="line"><span class="lineno">  790</span>      <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  791</span>        partResolution = <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(ras-&gt;getLx(), ras-&gt;getLy());</div>
<div class="line"><span class="lineno">  792</span>    }</div>
<div class="line"><span class="lineno">  793</span>  }</div>
<div class="line"><span class="lineno">  794</span> </div>
<div class="line"><span class="lineno">  795</span>  <span class="comment">// We are interested in making the relation between scale and (integer)</span></div>
<div class="line"><span class="lineno">  796</span>  <span class="comment">// resolution</span></div>
<div class="line"><span class="lineno">  797</span>  <span class="comment">// bijective - since we shall cache by using resolution as a partial</span></div>
<div class="line"><span class="lineno">  798</span>  <span class="comment">// identification parameter.</span></div>
<div class="line"><span class="lineno">  799</span>  <span class="comment">// Therefore, we find the current bbox Lx and take a unique scale out of it.</span></div>
<div class="line"><span class="lineno">  800</span>  partScale      = partResolution.lx / standardRefBBox.getLx();</div>
<div class="line"><span class="lineno">  801</span>  riNew.m_affine = <a class="code hl_class" href="class_t_scale.html">TScale</a>(partScale);</div>
<div class="line"><span class="lineno">  802</span>  bbox           = riNew.m_affine * standardRefBBox;</div>
<div class="line"><span class="lineno">  803</span> </div>
<div class="line"><span class="lineno">  804</span>  <span class="comment">// If no image was retrieved from the cache (or it was not scaled enough),</span></div>
<div class="line"><span class="lineno">  805</span>  <span class="comment">// calculate it</span></div>
<div class="line"><span class="lineno">  806</span>  <span class="keywordflow">if</span> (!ras) {</div>
<div class="line"><span class="lineno">  807</span>    <a class="code hl_class" href="class_t_tile.html">TTile</a> auxTile;</div>
<div class="line"><span class="lineno">  808</span>    (*part_ports[part-&gt;level])</div>
<div class="line"><span class="lineno">  809</span>        -&gt;allocateAndCompute(auxTile, bbox.getP00(),</div>
<div class="line"><span class="lineno">  810</span>                             <a class="code hl_class" href="class_t_dimension_t.html">TDimension</a>(partResolution.lx, partResolution.ly),</div>
<div class="line"><span class="lineno">  811</span>                             tile-&gt;getRaster(), ndx, riNew);</div>
<div class="line"><span class="lineno">  812</span>    ras = auxTile.getRaster();</div>
<div class="line"><span class="lineno">  813</span> </div>
<div class="line"><span class="lineno">  814</span>    <span class="comment">// For now, we&#39;ll just use 32 bit particles</span></div>
<div class="line"><span class="lineno">  815</span>    <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> rcachepart;</div>
<div class="line"><span class="lineno">  816</span>    rcachepart = ras;</div>
<div class="line"><span class="lineno">  817</span>    <span class="keywordflow">if</span> (!rcachepart) {</div>
<div class="line"><span class="lineno">  818</span>      rcachepart = <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a>(ras-&gt;getSize());</div>
<div class="line"><span class="lineno">  819</span>      <a class="code hl_function" href="namespace_t_rop.html#a45a08fb48dd7d33ec629d722081d55c6">TRop::convert</a>(rcachepart, ras);</div>
<div class="line"><span class="lineno">  820</span>    }</div>
<div class="line"><span class="lineno">  821</span>    ras = rcachepart;</div>
<div class="line"><span class="lineno">  822</span> </div>
<div class="line"><span class="lineno">  823</span>    <span class="comment">// Finally, cache the particle</span></div>
<div class="line"><span class="lineno">  824</span>    addRenderCache(alias, <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>(ras));</div>
<div class="line"><span class="lineno">  825</span>  }</div>
<div class="line"><span class="lineno">  826</span> </div>
<div class="line"><span class="lineno">  827</span>  <span class="keywordflow">if</span> (!ras) <span class="keywordflow">return</span>;  <span class="comment">// At this point, it should never happen anyway...</span></div>
<div class="line"><span class="lineno">  828</span> </div>
<div class="line"><span class="lineno">  829</span>  <span class="comment">// Deal with particle colors/opacity</span></div>
<div class="line"><span class="lineno">  830</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> rfinalpart;</div>
<div class="line"><span class="lineno">  831</span>  <span class="keywordtype">double</span> curr_opacity =</div>
<div class="line"><span class="lineno">  832</span>      part-&gt;set_Opacity(porttiles, values, opacity_range, dist_frame);</div>
<div class="line"><span class="lineno">  833</span>  <span class="keywordflow">if</span> (curr_opacity != 1.0 || part-&gt;gencol.fadecol || part-&gt;fincol.fadecol ||</div>
<div class="line"><span class="lineno">  834</span>      part-&gt;foutcol.fadecol) {</div>
<div class="line"><span class="lineno">  835</span>    <span class="comment">/*- 毎フレーム現在位置のピクセル色を参照 -*/</span></div>
<div class="line"><span class="lineno">  836</span>    <span class="keywordflow">if</span> (values.pick_color_for_every_frame_val &amp;&amp; values.gencol_ctrl_val &amp;&amp;</div>
<div class="line"><span class="lineno">  837</span>        (porttiles.find(values.gencol_ctrl_val) != porttiles.end()))</div>
<div class="line"><span class="lineno">  838</span>      part-&gt;get_image_reference(porttiles[values.gencol_ctrl_val], values,</div>
<div class="line"><span class="lineno">  839</span>                                part-&gt;gencol.col);</div>
<div class="line"><span class="lineno">  840</span> </div>
<div class="line"><span class="lineno">  841</span>    rfinalpart = ras-&gt;clone();</div>
<div class="line"><span class="lineno">  842</span>    part-&gt;modify_colors_and_opacity(values, curr_opacity, dist_frame,</div>
<div class="line"><span class="lineno">  843</span>                                    rfinalpart);</div>
<div class="line"><span class="lineno">  844</span>  } <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  845</span>    rfinalpart = ras;</div>
<div class="line"><span class="lineno">  846</span> </div>
<div class="line"><span class="lineno">  847</span>  <span class="comment">// Now, let&#39;s build the particle transform before it is overed on the output</span></div>
<div class="line"><span class="lineno">  848</span>  <span class="comment">// tile</span></div>
<div class="line"><span class="lineno">  849</span> </div>
<div class="line"><span class="lineno">  850</span>  <span class="comment">// First, complete the transform by adding the rotational and scale</span></div>
<div class="line"><span class="lineno">  851</span>  <span class="comment">// components from</span></div>
<div class="line"><span class="lineno">  852</span>  <span class="comment">// Particles parameters</span></div>
<div class="line"><span class="lineno">  853</span>  M = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a> * M * <a class="code hl_class" href="class_t_scale.html">TScale</a>(1.0 / partScale);</div>
<div class="line"><span class="lineno">  854</span> </div>
<div class="line"><span class="lineno">  855</span>  <span class="comment">// Then, retrieve the particle position in current reference.</span></div>
<div class="line"><span class="lineno">  856</span>  <a class="code hl_class" href="class_t_point_t.html">TPointD</a> pos(part-&gt;x, part-&gt;y);</div>
<div class="line"><span class="lineno">  857</span>  pos = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a> * pos;</div>
<div class="line"><span class="lineno">  858</span> </div>
<div class="line"><span class="lineno">  859</span>  <span class="comment">// Finally, add the translational component to the particle</span></div>
<div class="line"><span class="lineno">  860</span>  <span class="comment">// NOTE: p_offset is added to account for the particle relative position</span></div>
<div class="line"><span class="lineno">  861</span>  <span class="comment">// inside its level&#39;s bbox</span></div>
<div class="line"><span class="lineno">  862</span>  M = <a class="code hl_class" href="class_t_translation.html">TTranslation</a>(pos - tile-&gt;m_pos) * M * <a class="code hl_class" href="class_t_translation.html">TTranslation</a>(bbox.getP00());</div>
<div class="line"><span class="lineno">  863</span> </div>
<div class="line"><span class="lineno">  864</span>  <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> myras32 = tile-&gt;getRaster())</div>
<div class="line"><span class="lineno">  865</span>    <a class="code hl_function" href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a>(tileRas, rfinalpart, M);</div>
<div class="line"><span class="lineno">  866</span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_class" href="class_t_raster_p_t.html">TRaster64P</a> myras64 = tile-&gt;getRaster())</div>
<div class="line"><span class="lineno">  867</span>    <a class="code hl_function" href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a>(tileRas, rfinalpart, M);</div>
<div class="line"><span class="lineno">  868</span>  <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  869</span>    <span class="keywordflow">throw</span> <a class="code hl_class" href="class_t_exception.html">TException</a>(<span class="stringliteral">&quot;ParticlesFx: unsupported Pixel Type&quot;</span>);</div>
<div class="line"><span class="lineno">  870</span>}</div>
<div class="ttc" id="aclass_t_affine_html"><div class="ttname"><a href="class_t_affine.html">TAffine</a></div><div class="ttdoc">This is the base class for the affine transformations.</div><div class="ttdef"><b>Definition:</b> tgeometry.h:864</div></div>
<div class="ttc" id="aclass_t_dimension_t_html"><div class="ttname"><a href="class_t_dimension_t.html">TDimensionT&lt; double &gt;</a></div></div>
<div class="ttc" id="aclass_t_exception_html"><div class="ttname"><a href="class_t_exception.html">TException</a></div><div class="ttdef"><b>Definition:</b> texception.h:18</div></div>
<div class="ttc" id="aclass_t_image_cache_html_aea3ac2752efd6fa9689f5a7c1e895e41"><div class="ttname"><a href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">TImageCache::get</a></div><div class="ttdeci">TImageP get(const std::string &amp;id, bool toBeModified) const</div><div class="ttdef"><b>Definition:</b> timagecache.cpp:1672</div></div>
<div class="ttc" id="aclass_t_point_t_html"><div class="ttname"><a href="class_t_point_t.html">TPointT&lt; double &gt;</a></div></div>
<div class="ttc" id="aclass_t_raster_image_p_html"><div class="ttname"><a href="class_t_raster_image_p.html">TRasterImageP</a></div><div class="ttdef"><b>Definition:</b> trasterimage.h:148</div></div>
<div class="ttc" id="aclass_t_raster_p_t_html"><div class="ttname"><a href="class_t_raster_p_t.html">TRasterPT&lt; TPixel32 &gt;</a></div></div>
<div class="ttc" id="aclass_t_rect_t_html"><div class="ttname"><a href="class_t_rect_t.html">TRectT&lt; double &gt;</a></div></div>
<div class="ttc" id="aclass_t_render_settings_html"><div class="ttname"><a href="class_t_render_settings.html">TRenderSettings</a></div><div class="ttdoc">Data class containing the relevant additional information needed in a render process.</div><div class="ttdef"><b>Definition:</b> trasterfx.h:61</div></div>
<div class="ttc" id="aclass_t_render_settings_html_a1250181bf3fe8e05db005d5faa76b3ea"><div class="ttname"><a href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">TRenderSettings::m_affine</a></div><div class="ttdeci">TAffine m_affine</div><div class="ttdef"><b>Definition:</b> trasterfx.h:97</div></div>
<div class="ttc" id="aclass_t_rotation_html"><div class="ttname"><a href="class_t_rotation.html">TRotation</a></div><div class="ttdef"><b>Definition:</b> tgeometry.h:1083</div></div>
<div class="ttc" id="aclass_t_scale_html"><div class="ttname"><a href="class_t_scale.html">TScale</a></div><div class="ttdef"><b>Definition:</b> tgeometry.h:1133</div></div>
<div class="ttc" id="aclass_t_smart_pointer_t_html"><div class="ttname"><a href="class_t_smart_pointer_t.html">TSmartPointerT&lt; TRaster &gt;</a></div></div>
<div class="ttc" id="aclass_t_tile_html"><div class="ttname"><a href="class_t_tile.html">TTile</a></div><div class="ttdef"><b>Definition:</b> ttile.h:20</div></div>
<div class="ttc" id="aclass_t_translation_html"><div class="ttname"><a href="class_t_translation.html">TTranslation</a></div><div class="ttdef"><b>Definition:</b> tgeometry.h:1074</div></div>
<div class="ttc" id="anamespace_t_rop_html_a45a08fb48dd7d33ec629d722081d55c6"><div class="ttname"><a href="namespace_t_rop.html#a45a08fb48dd7d33ec629d722081d55c6">TRop::convert</a></div><div class="ttdeci">DVAPI void convert(TRasterP dst, const TRasterP &amp;src)</div><div class="ttdoc">Convert src raster in raster type dst.</div><div class="ttdef"><b>Definition:</b> tconvert.cpp:336</div></div>
<div class="ttc" id="anamespace_t_rop_html_ae5fd1fb0c2f625e1da14fe92ae0e5122"><div class="ttname"><a href="namespace_t_rop.html#ae5fd1fb0c2f625e1da14fe92ae0e5122">TRop::over</a></div><div class="ttdeci">DVAPI void over(const TRasterP &amp;out, const TRasterP &amp;dn, const TRasterP &amp;up)</div><div class="ttdef"><b>Definition:</b> tover.cpp:285</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1af1efc8a70dc3c9e9e3a50c97b702c6" name="a1af1efc8a70dc3c9e9e3a50c97b702c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1af1efc8a70dc3c9e9e3a50c97b702c6">&#9670;&nbsp;</a></span>fill_array()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_array </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int &amp;&#160;</td>
          <td class="paramname"><em>regioncount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>myarray</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>lista</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>listb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  877</span>                                                                        {</div>
<div class="line"><span class="lineno">  878</span>  <span class="keywordtype">int</span> pr = 0;</div>
<div class="line"><span class="lineno">  879</span>  <span class="keywordtype">int</span> i, j;</div>
<div class="line"><span class="lineno">  880</span>  <span class="keywordtype">int</span> lx, ly;</div>
<div class="line"><span class="lineno">  881</span>  lx = ctrl1-&gt;getRaster()-&gt;getLx();</div>
<div class="line"><span class="lineno">  882</span>  ly = ctrl1-&gt;getRaster()-&gt;getLy();</div>
<div class="line"><span class="lineno">  883</span> </div>
<div class="line"><span class="lineno">  884</span>  <span class="comment">/*prima riga*/</span></div>
<div class="line"><span class="lineno">  885</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> raster32 = ctrl1-&gt;getRaster();</div>
<div class="line"><span class="lineno">  886</span>  raster32-&gt;lock();</div>
<div class="line"><span class="lineno">  887</span>  TPixel32 *pix = raster32-&gt;pixels(0);</div>
<div class="line"><span class="lineno">  888</span>  <span class="keywordflow">for</span> (i = 0; i &lt; lx; i++) {</div>
<div class="line"><span class="lineno">  889</span>    <span class="keywordflow">if</span> (pix-&gt;m &gt; threshold) {</div>
<div class="line"><span class="lineno">  890</span>      pr++;</div>
<div class="line"><span class="lineno">  891</span>      <span class="keywordflow">if</span> (!i) {</div>
<div class="line"><span class="lineno">  892</span>        (regioncount)++;</div>
<div class="line"><span class="lineno">  893</span>        myarray[i] = (regioncount);</div>
<div class="line"><span class="lineno">  894</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  895</span>        <span class="keywordflow">if</span> (myarray[i - 1]) myarray[i] = myarray[i - 1];</div>
<div class="line"><span class="lineno">  896</span>      }</div>
<div class="line"><span class="lineno">  897</span>    }</div>
<div class="line"><span class="lineno">  898</span>    pix++;</div>
<div class="line"><span class="lineno">  899</span>  }</div>
<div class="line"><span class="lineno">  900</span> </div>
<div class="line"><span class="lineno">  901</span>  <span class="keywordflow">for</span> (j = 1; j &lt; ly; j++) {</div>
<div class="line"><span class="lineno">  902</span>    <span class="keywordflow">for</span> (i = 0, pix = raster32-&gt;pixels(j); i &lt; lx; i++, pix++) {</div>
<div class="line"><span class="lineno">  903</span>      <span class="comment">/*TMSG_INFO(&quot;j=%d i=%d\n&quot;, j, i);*/</span></div>
<div class="line"><span class="lineno">  904</span>      <span class="keywordflow">if</span> (pix-&gt;m &gt; threshold) {</div>
<div class="line"><span class="lineno">  905</span>        std::vector&lt;int&gt; mask(4);</div>
<div class="line"><span class="lineno">  906</span>        pr++;</div>
<div class="line"><span class="lineno">  907</span>        <span class="comment">/* l,ul,u,ur;*/</span></div>
<div class="line"><span class="lineno">  908</span>        <span class="keywordflow">if</span> (i) {</div>
<div class="line"><span class="lineno">  909</span>          mask[0] = myarray[i - 1 + lx * j];</div>
<div class="line"><span class="lineno">  910</span>          mask[1] = myarray[i - 1 + lx * (j - 1)];</div>
<div class="line"><span class="lineno">  911</span>        }</div>
<div class="line"><span class="lineno">  912</span>        <span class="keywordflow">if</span> (i != lx - 1) mask[3] = myarray[i + 1 + lx * (j - 1)];</div>
<div class="line"><span class="lineno">  913</span>        mask[2] = myarray[i + lx * (j - 1)];</div>
<div class="line"><span class="lineno">  914</span>        <span class="keywordflow">if</span> (!mask[0] &amp;&amp; !mask[1] &amp;&amp; !mask[2] &amp;&amp; !mask[3]) {</div>
<div class="line"><span class="lineno">  915</span>          (regioncount)++;</div>
<div class="line"><span class="lineno">  916</span>          myarray[i + lx * j] = (regioncount);</div>
<div class="line"><span class="lineno">  917</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  918</span>          <span class="keywordtype">int</span> mc, firsttime = 1;</div>
<div class="line"><span class="lineno">  919</span>          <span class="keywordflow">for</span> (mc = 0; mc &lt; 4; mc++) {</div>
<div class="line"><span class="lineno">  920</span>            <span class="keywordflow">if</span> (mask[mc]) {</div>
<div class="line"><span class="lineno">  921</span>              <span class="keywordflow">if</span> (firsttime) {</div>
<div class="line"><span class="lineno">  922</span>                myarray[i + lx * j] = mask[mc];</div>
<div class="line"><span class="lineno">  923</span>                firsttime           = 0;</div>
<div class="line"><span class="lineno">  924</span>              } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  925</span>                <span class="keywordflow">if</span> (myarray[i + lx * j] != mask[mc]) {</div>
<div class="line"><span class="lineno">  926</span>                  lista.push_back(myarray[i + lx * j]);</div>
<div class="line"><span class="lineno">  927</span>                  listb.push_back(mask[mc]);</div>
<div class="line"><span class="lineno">  928</span> </div>
<div class="line"><span class="lineno">  929</span>                  <span class="comment">/*TMSG_INFO(&quot;j=%d i=%d mc=%d, mask=%d\n&quot;, j, i, mc,</span></div>
<div class="line"><span class="lineno">  930</span><span class="comment">                   * mask[mc]);*/</span></div>
<div class="line"><span class="lineno">  931</span>                }</div>
<div class="line"><span class="lineno">  932</span>              }</div>
<div class="line"><span class="lineno">  933</span>            }</div>
<div class="line"><span class="lineno">  934</span>          }</div>
<div class="line"><span class="lineno">  935</span>        }</div>
<div class="line"><span class="lineno">  936</span>      }</div>
<div class="line"><span class="lineno">  937</span>    }</div>
<div class="line"><span class="lineno">  938</span>  }</div>
<div class="line"><span class="lineno">  939</span>  raster32-&gt;unlock();</div>
<div class="line"><span class="lineno">  940</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="afdd23542480a7b25a65ad6bcd7bf1106" name="afdd23542480a7b25a65ad6bcd7bf1106"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afdd23542480a7b25a65ad6bcd7bf1106">&#9670;&nbsp;</a></span>fill_range_struct()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_range_struct </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__ranges.html">particles_ranges</a> &amp;&#160;</td>
          <td class="paramname"><em>ranges</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  143</span>                                                                          {</div>
<div class="line"><span class="lineno">  144</span>  ranges.swing_range = values.swing_val.second - values.swing_val.first;</div>
<div class="line"><span class="lineno">  145</span>  ranges.rotswing_range =</div>
<div class="line"><span class="lineno">  146</span>      values.rotswing_val.second - values.rotswing_val.first;</div>
<div class="line"><span class="lineno">  147</span>  ranges.randomx_range = values.randomx_val.second - values.randomx_val.first;</div>
<div class="line"><span class="lineno">  148</span>  ranges.randomy_range = values.randomy_val.second - values.randomy_val.first;</div>
<div class="line"><span class="lineno">  149</span>  ranges.rotsca_range  = values.rotsca_val.second - values.rotsca_val.first;</div>
<div class="line"><span class="lineno">  150</span>  ranges.rot_range     = values.rot_val.second - values.rot_val.first;</div>
<div class="line"><span class="lineno">  151</span>  ranges.speed_range   = values.speed_val.second - values.speed_val.first;</div>
<div class="line"><span class="lineno">  152</span>  ranges.speeda_range  = values.speeda_val.second - values.speeda_val.first;</div>
<div class="line"><span class="lineno">  153</span>  ranges.mass_range    = values.mass_val.second - values.mass_val.first;</div>
<div class="line"><span class="lineno">  154</span>  ranges.scale_range   = values.scale_val.second - values.scale_val.first;</div>
<div class="line"><span class="lineno">  155</span>  ranges.lifetime_range =</div>
<div class="line"><span class="lineno">  156</span>      values.lifetime_val.second - values.lifetime_val.first;</div>
<div class="line"><span class="lineno">  157</span>  ranges.scalestep_range =</div>
<div class="line"><span class="lineno">  158</span>      values.scalestep_val.second - values.scalestep_val.first;</div>
<div class="line"><span class="lineno">  159</span>  ranges.trail_range = (int)(values.trail_val.second - values.trail_val.first);</div>
<div class="line"><span class="lineno">  160</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af3066bd24bec784f377849544f916534" name="af3066bd24bec784f377849544f916534"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af3066bd24bec784f377849544f916534">&#9670;&nbsp;</a></span>fill_regions()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_regions </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>multi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>do_source_gradation</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::vector&lt; int &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myHistogram</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1114</span>                                            {</div>
<div class="line"><span class="lineno"> 1115</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> ctrl1ras = ctrl1-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1116</span>  <span class="keywordflow">if</span> (!ctrl1ras) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1117</span>  <span class="keywordtype">int</span> i;</div>
<div class="line"><span class="lineno"> 1118</span>  <span class="keywordflow">if</span> (frame &lt;= 0)</div>
<div class="line"><span class="lineno"> 1119</span>    i = 0;</div>
<div class="line"><span class="lineno"> 1120</span>  <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1121</span>    i = frame;</div>
<div class="line"><span class="lineno"> 1122</span> </div>
<div class="line"><span class="lineno"> 1123</span>  <span class="keywordflow">if</span> (multi) {</div>
<div class="line"><span class="lineno"> 1124</span>    fill_subregions(i, myregions, ctrl1, thres);</div>
<div class="line"><span class="lineno"> 1125</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1126</span>    fill_single_region(myregions, ctrl1, thres, do_source_gradation,</div>
<div class="line"><span class="lineno"> 1127</span>                       myHistogram);</div>
<div class="line"><span class="lineno"> 1128</span>  }</div>
<div class="line"><span class="lineno"> 1129</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ae96c2d7be493116384ee9845831bc6bd" name="ae96c2d7be493116384ee9845831bc6bd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae96c2d7be493116384ee9845831bc6bd">&#9670;&nbsp;</a></span>fill_regions_with_size_map()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_regions_with_size_map </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::vector&lt; int &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myHistogram</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>sizeTile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>sourceTile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1140</span>                                  {</div>
<div class="line"><span class="lineno"> 1141</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> sizeRas = sizeTile-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1142</span>  <span class="keywordflow">if</span> (!sizeRas) <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1143</span> </div>
<div class="line"><span class="lineno"> 1144</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> sourceRas;</div>
<div class="line"><span class="lineno"> 1145</span>  <span class="keywordflow">if</span> (sourceTile) sourceRas = sourceTile-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1146</span> </div>
<div class="line"><span class="lineno"> 1147</span>  sizeRas-&gt;lock();</div>
<div class="line"><span class="lineno"> 1148</span>  <span class="keywordflow">if</span> (sourceRas) sourceRas-&gt;lock();</div>
<div class="line"><span class="lineno"> 1149</span> </div>
<div class="line"><span class="lineno"> 1150</span>  myregions.resize(1);</div>
<div class="line"><span class="lineno"> 1151</span>  myregions[0].clear();</div>
<div class="line"><span class="lineno"> 1152</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 256; i++) myHistogram.push_back(std::vector&lt;int&gt;());</div>
<div class="line"><span class="lineno"> 1153</span> </div>
<div class="line"><span class="lineno"> 1154</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; sizeRas-&gt;getLy(); j++) {</div>
<div class="line"><span class="lineno"> 1155</span>    TPixel32 *pix    = sizeRas-&gt;pixels(j);</div>
<div class="line"><span class="lineno"> 1156</span>    TPixel32 *endPix = pix + sizeRas-&gt;getLx();</div>
<div class="line"><span class="lineno"> 1157</span> </div>
<div class="line"><span class="lineno"> 1158</span>    TPixel32 *sourcePixHead = 0;</div>
<div class="line"><span class="lineno"> 1159</span>    <span class="keywordflow">if</span> (sourceRas) {</div>
<div class="line"><span class="lineno"> 1160</span>      <span class="keywordtype">int</span> sourceYPos = troundp(j + sizeTile-&gt;m_pos.y - sourceTile-&gt;m_pos.y);</div>
<div class="line"><span class="lineno"> 1161</span>      <span class="keywordflow">if</span> (sourceYPos &gt;= 0 &amp;&amp; sourceYPos &lt; sourceRas-&gt;getLy())</div>
<div class="line"><span class="lineno"> 1162</span>        sourcePixHead = sourceRas-&gt;pixels(sourceYPos);</div>
<div class="line"><span class="lineno"> 1163</span>    }</div>
<div class="line"><span class="lineno"> 1164</span> </div>
<div class="line"><span class="lineno"> 1165</span>    <span class="keywordtype">int</span> i               = 0;</div>
<div class="line"><span class="lineno"> 1166</span>    TPixel32 *sourcePix = 0;</div>
<div class="line"><span class="lineno"> 1167</span>    <span class="keywordflow">while</span> (pix &lt; endPix) {</div>
<div class="line"><span class="lineno"> 1168</span>      <span class="keywordflow">if</span> (sourceRas) {</div>
<div class="line"><span class="lineno"> 1169</span>        <span class="keywordtype">int</span> sourceXPos = (int)(i + sizeTile-&gt;m_pos.x - sourceTile-&gt;m_pos.x);</div>
<div class="line"><span class="lineno"> 1170</span>        <span class="keywordflow">if</span> (sourcePixHead &amp;&amp; sourceXPos &gt;= 0 &amp;&amp; sourceXPos &lt; sourceRas-&gt;getLx())</div>
<div class="line"><span class="lineno"> 1171</span>          sourcePix = sourcePixHead + sourceXPos;</div>
<div class="line"><span class="lineno"> 1172</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1173</span>          sourcePix = 0;</div>
<div class="line"><span class="lineno"> 1174</span>      } <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1175</span>        sourcePix = 0;</div>
<div class="line"><span class="lineno"> 1176</span> </div>
<div class="line"><span class="lineno"> 1177</span>      <span class="comment">/*-</span></div>
<div class="line"><span class="lineno"> 1178</span><span class="comment">       * Source画像があって、ピクセルがバウンディング外またはアルファが０なら抜かす。</span></div>
<div class="line"><span class="lineno"> 1179</span><span class="comment">       * -*/</span></div>
<div class="line"><span class="lineno"> 1180</span>      <span class="keywordflow">if</span> (sourceRas &amp;&amp; (!sourcePix || sourcePix-&gt;m &lt;= thres)) {</div>
<div class="line"><span class="lineno"> 1181</span>      }</div>
<div class="line"><span class="lineno"> 1182</span>      <span class="comment">/*-</span></div>
<div class="line"><span class="lineno"> 1183</span><span class="comment">         明度に比例してパーティクルを発生させる。そのピクセルのアルファ値の数だけ「立候補」させる。-*/</span></div>
<div class="line"><span class="lineno"> 1184</span>      <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1185</span>        <a class="code hl_class" href="class_t_point_t.html">TPointD</a> tmp;</div>
<div class="line"><span class="lineno"> 1186</span>        tmp.y = j;</div>
<div class="line"><span class="lineno"> 1187</span>        tmp.x = i;</div>
<div class="line"><span class="lineno"> 1188</span>        tmp += sizeTile-&gt;m_pos;</div>
<div class="line"><span class="lineno"> 1189</span> </div>
<div class="line"><span class="lineno"> 1190</span>        <span class="keywordtype">int</span> val = (int)<a class="code hl_function" href="class_t_pixel_g_r8.html#aa60eac9adab1b27ada505bffd6301e51">TPixelGR8::from</a>(*pix).value;</div>
<div class="line"><span class="lineno"> 1191</span> </div>
<div class="line"><span class="lineno"> 1192</span>        <span class="comment">/*- Histogramの登録 -*/</span></div>
<div class="line"><span class="lineno"> 1193</span>        myHistogram[val].push_back((<span class="keywordtype">int</span>)myregions[0].size());</div>
<div class="line"><span class="lineno"> 1194</span> </div>
<div class="line"><span class="lineno"> 1195</span>        <span class="comment">/*- 各Pointにウェイトを持たせる -*/</span></div>
<div class="line"><span class="lineno"> 1196</span>        myregions[0].push_back(tmp);</div>
<div class="line"><span class="lineno"> 1197</span>      }</div>
<div class="line"><span class="lineno"> 1198</span> </div>
<div class="line"><span class="lineno"> 1199</span>      i++;</div>
<div class="line"><span class="lineno"> 1200</span>      pix++;</div>
<div class="line"><span class="lineno"> 1201</span>    }</div>
<div class="line"><span class="lineno"> 1202</span>  }</div>
<div class="line"><span class="lineno"> 1203</span> </div>
<div class="line"><span class="lineno"> 1204</span>  <span class="keywordflow">if</span> (myregions[0].size() == 0) myregions.resize(0);</div>
<div class="line"><span class="lineno"> 1205</span> </div>
<div class="line"><span class="lineno"> 1206</span>  sizeRas-&gt;unlock();</div>
<div class="line"><span class="lineno"> 1207</span>  <span class="keywordflow">if</span> (sourceRas) sourceRas-&gt;unlock();</div>
<div class="line"><span class="lineno"> 1208</span>}</div>
<div class="ttc" id="aclass_t_pixel_g_r8_html_aa60eac9adab1b27ada505bffd6301e51"><div class="ttname"><a href="class_t_pixel_g_r8.html#aa60eac9adab1b27ada505bffd6301e51">TPixelGR8::from</a></div><div class="ttdeci">static TPixelGR8 from(const TPixelGR16 &amp;pix, TUINT32 randomNumber)</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1dd98c8f78b92b7715af11295577e09c" name="a1dd98c8f78b92b7715af11295577e09c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1dd98c8f78b92b7715af11295577e09c">&#9670;&nbsp;</a></span>fill_single_region()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_single_region </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>do_source_gradation</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::vector&lt; int &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myHistogram</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1036</span>                                                                      {</div>
<div class="line"><span class="lineno"> 1037</span>  <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> raster32 = ctrl1-&gt;getRaster();</div>
<div class="line"><span class="lineno"> 1038</span>  assert(raster32);  <span class="comment">// per ora gestisco solo i Raster32</span></div>
<div class="line"><span class="lineno"> 1039</span>                     <span class="comment">//  int lx=raster32-&gt;getLx();</span></div>
<div class="line"><span class="lineno"> 1040</span>                     <span class="comment">//  int ly=raster32-&gt;getLy();</span></div>
<div class="line"><span class="lineno"> 1041</span>  <span class="keywordtype">int</span> j;</div>
<div class="line"><span class="lineno"> 1042</span>  myregions.resize(1);</div>
<div class="line"><span class="lineno"> 1043</span>  myregions[0].clear();</div>
<div class="line"><span class="lineno"> 1044</span>  <span class="keywordtype">int</span> cc  = 0;</div>
<div class="line"><span class="lineno"> 1045</span>  <span class="keywordtype">int</span> icc = 0;</div>
<div class="line"><span class="lineno"> 1046</span>  raster32-&gt;lock();</div>
<div class="line"><span class="lineno"> 1047</span> </div>
<div class="line"><span class="lineno"> 1048</span>  <span class="keywordflow">if</span> (!do_source_gradation) <span class="comment">/*- 2階調の場合 -*/</span></div>
<div class="line"><span class="lineno"> 1049</span>  {</div>
<div class="line"><span class="lineno"> 1050</span>    <span class="keywordflow">for</span> (j = 0; j &lt; raster32-&gt;getLy(); j++) {</div>
<div class="line"><span class="lineno"> 1051</span>      TPixel32 *pix    = raster32-&gt;pixels(j);</div>
<div class="line"><span class="lineno"> 1052</span>      TPixel32 *endPix = pix + raster32-&gt;getLx();</div>
<div class="line"><span class="lineno"> 1053</span>      <span class="keywordtype">int</span> i            = 0;</div>
<div class="line"><span class="lineno"> 1054</span>      <span class="keywordflow">while</span> (pix &lt; endPix) {</div>
<div class="line"><span class="lineno"> 1055</span>        cc++;</div>
<div class="line"><span class="lineno"> 1056</span>        <span class="keywordflow">if</span> (pix-&gt;m &gt; threshold) {</div>
<div class="line"><span class="lineno"> 1057</span>          icc++;</div>
<div class="line"><span class="lineno"> 1058</span>          <a class="code hl_class" href="class_t_point_t.html">TPointD</a> tmp;</div>
<div class="line"><span class="lineno"> 1059</span>          tmp.y = j;</div>
<div class="line"><span class="lineno"> 1060</span>          tmp.x = i;</div>
<div class="line"><span class="lineno"> 1061</span>          tmp += ctrl1-&gt;m_pos;</div>
<div class="line"><span class="lineno"> 1062</span>          myregions[0].push_back(tmp);</div>
<div class="line"><span class="lineno"> 1063</span>          <span class="comment">/*TMSG_INFO(&quot;total=%d\n&quot;, Region[0].total);*/</span></div>
<div class="line"><span class="lineno"> 1064</span> </div>
<div class="line"><span class="lineno"> 1065</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1066</span>          <span class="comment">//           int a=0;</span></div>
<div class="line"><span class="lineno"> 1067</span>        }</div>
<div class="line"><span class="lineno"> 1068</span>        i++;</div>
<div class="line"><span class="lineno"> 1069</span>        pix++;</div>
<div class="line"><span class="lineno"> 1070</span>      }</div>
<div class="line"><span class="lineno"> 1071</span>    }</div>
<div class="line"><span class="lineno"> 1072</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1073</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 256; i++) myHistogram.push_back(std::vector&lt;int&gt;());</div>
<div class="line"><span class="lineno"> 1074</span> </div>
<div class="line"><span class="lineno"> 1075</span>    <a class="code hl_class" href="class_t_random.html">TRandom</a> rand = <a class="code hl_class" href="class_t_random.html">TRandom</a>(1);</div>
<div class="line"><span class="lineno"> 1076</span>    <span class="keywordflow">for</span> (j = 0; j &lt; raster32-&gt;getLy(); j++) {</div>
<div class="line"><span class="lineno"> 1077</span>      TPixel32 *pix    = raster32-&gt;pixels(j);</div>
<div class="line"><span class="lineno"> 1078</span>      TPixel32 *endPix = pix + raster32-&gt;getLx();</div>
<div class="line"><span class="lineno"> 1079</span>      <span class="keywordtype">int</span> i            = 0;</div>
<div class="line"><span class="lineno"> 1080</span>      <span class="keywordflow">while</span> (pix &lt; endPix) {</div>
<div class="line"><span class="lineno"> 1081</span>        cc++;</div>
<div class="line"><span class="lineno"> 1082</span>        <span class="comment">/*-- アルファの濃度に比例してパーティクルを発生させるための、</span></div>
<div class="line"><span class="lineno"> 1083</span><span class="comment">                シンプルな方法。そのピクセルのアルファ値の数だけ「立候補」させる。</span></div>
<div class="line"><span class="lineno"> 1084</span><span class="comment">        --*/</span></div>
<div class="line"><span class="lineno"> 1085</span>        <span class="keywordflow">if</span> (pix-&gt;m &gt; 0) {</div>
<div class="line"><span class="lineno"> 1086</span>          icc++;</div>
<div class="line"><span class="lineno"> 1087</span>          <a class="code hl_class" href="class_t_point_t.html">TPointD</a> tmp;</div>
<div class="line"><span class="lineno"> 1088</span>          tmp.y = j;</div>
<div class="line"><span class="lineno"> 1089</span>          tmp.x = i;</div>
<div class="line"><span class="lineno"> 1090</span>          tmp += ctrl1-&gt;m_pos;</div>
<div class="line"><span class="lineno"> 1091</span> </div>
<div class="line"><span class="lineno"> 1092</span>          <span class="comment">/*- Histogramの登録 -*/</span></div>
<div class="line"><span class="lineno"> 1093</span>          myHistogram[(int)pix-&gt;m].push_back((<span class="keywordtype">int</span>)myregions[0].size());</div>
<div class="line"><span class="lineno"> 1094</span>          <span class="comment">/*-  各Pointにウェイトを持たせる -*/</span></div>
<div class="line"><span class="lineno"> 1095</span>          myregions[0].push_back(tmp);</div>
<div class="line"><span class="lineno"> 1096</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1097</span>        }</div>
<div class="line"><span class="lineno"> 1098</span>        i++;</div>
<div class="line"><span class="lineno"> 1099</span>        pix++;</div>
<div class="line"><span class="lineno"> 1100</span>      }</div>
<div class="line"><span class="lineno"> 1101</span>    }</div>
<div class="line"><span class="lineno"> 1102</span>  }</div>
<div class="line"><span class="lineno"> 1103</span>  <span class="keywordflow">if</span> (myregions[0].size() == 0) myregions.resize(0);</div>
<div class="line"><span class="lineno"> 1104</span>  raster32-&gt;unlock();</div>
<div class="line"><span class="lineno"> 1105</span>}</div>
<div class="ttc" id="aclass_t_random_html"><div class="ttname"><a href="class_t_random.html">TRandom</a></div><div class="ttdef"><b>Definition:</b> trandom.h:20</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ab92d32ddd8f0516b4a2ba25d29595c7b" name="ab92d32ddd8f0516b4a2ba25d29595c7b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab92d32ddd8f0516b4a2ba25d29595c7b">&#9670;&nbsp;</a></span>fill_subregions()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_subregions </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cont_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>ctrl1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>thres</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1012</span>               {</div>
<div class="line"><span class="lineno"> 1013</span>  <span class="keywordtype">int</span> regioncounter = 0;</div>
<div class="line"><span class="lineno"> 1014</span> </div>
<div class="line"><span class="lineno"> 1015</span>  <span class="keywordtype">int</span> lx = ctrl1-&gt;getRaster()-&gt;getLx();</div>
<div class="line"><span class="lineno"> 1016</span>  <span class="keywordtype">int</span> ly = ctrl1-&gt;getRaster()-&gt;getLy();</div>
<div class="line"><span class="lineno"> 1017</span> </div>
<div class="line"><span class="lineno"> 1018</span>  std::vector&lt;int&gt; myarray(lx * ly);</div>
<div class="line"><span class="lineno"> 1019</span>  std::vector&lt;int&gt; lista;</div>
<div class="line"><span class="lineno"> 1020</span>  std::vector&lt;int&gt; listb;</div>
<div class="line"><span class="lineno"> 1021</span> </div>
<div class="line"><span class="lineno"> 1022</span>  fill_array(ctrl1, regioncounter, myarray, lista, listb, thres);</div>
<div class="line"><span class="lineno"> 1023</span> </div>
<div class="line"><span class="lineno"> 1024</span>  <span class="keywordflow">if</span> (regioncounter) {</div>
<div class="line"><span class="lineno"> 1025</span>    std::vector&lt;int&gt; <span class="keyword">final</span>(regioncounter + 1);</div>
<div class="line"><span class="lineno"> 1026</span>    normalize_array(myregions, ctrl1-&gt;m_pos, lx, ly, regioncounter, myarray,</div>
<div class="line"><span class="lineno"> 1027</span>                    lista, listb, <span class="keyword">final</span>);</div>
<div class="line"><span class="lineno"> 1028</span>  }</div>
<div class="line"><span class="lineno"> 1029</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="abe399b2056ac8e417408d3b68b6d2428" name="abe399b2056ac8e417408d3b68b6d2428"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abe399b2056ac8e417408d3b68b6d2428">&#9670;&nbsp;</a></span>fill_value_struct()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::fill_value_struct </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>value</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>frame</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">   58</span>                                                       {</div>
<div class="line"><span class="lineno">   59</span>  myvalues.source_ctrl_val  = m_parent-&gt;source_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   60</span>  myvalues.bright_thres_val = m_parent-&gt;bright_thres_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   61</span>  myvalues.multi_source_val = m_parent-&gt;multi_source_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   62</span>  myvalues.x_pos_val        = m_parent-&gt;center_val-&gt;getValue(frame).x;</div>
<div class="line"><span class="lineno">   63</span>  myvalues.y_pos_val        = m_parent-&gt;center_val-&gt;getValue(frame).y;</div>
<div class="line"><span class="lineno">   64</span>  <span class="comment">//  myvalues.unit_val=m_parent-&gt;unit_val-&gt;getValue(frame);</span></div>
<div class="line"><span class="lineno">   65</span>  myvalues.length_val          = m_parent-&gt;length_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   66</span>  myvalues.height_val          = m_parent-&gt;height_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   67</span>  myvalues.maxnum_val          = m_parent-&gt;maxnum_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   68</span>  myvalues.lifetime_val        = m_parent-&gt;lifetime_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   69</span>  myvalues.lifetime_ctrl_val   = m_parent-&gt;lifetime_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   70</span>  myvalues.column_lifetime_val = m_parent-&gt;column_lifetime_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   71</span>  myvalues.startpos_val        = m_parent-&gt;startpos_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   72</span>  myvalues.randseed_val        = m_parent-&gt;randseed_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   73</span>  myvalues.gravity_val         = m_parent-&gt;gravity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   74</span>  myvalues.g_angle_val         = m_parent-&gt;g_angle_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   75</span>  myvalues.gravity_ctrl_val    = m_parent-&gt;gravity_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   76</span>  myvalues.friction_val        = m_parent-&gt;friction_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   77</span>  myvalues.friction_ctrl_val   = m_parent-&gt;friction_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   78</span>  myvalues.windint_val         = m_parent-&gt;windint_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   79</span>  myvalues.windangle_val       = m_parent-&gt;windangle_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   80</span>  myvalues.swingmode_val       = m_parent-&gt;swingmode_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   81</span>  myvalues.randomx_val         = m_parent-&gt;randomx_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   82</span>  myvalues.randomy_val         = m_parent-&gt;randomy_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   83</span>  myvalues.randomx_ctrl_val    = m_parent-&gt;randomx_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   84</span>  myvalues.randomy_ctrl_val    = m_parent-&gt;randomy_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   85</span>  myvalues.swing_val           = m_parent-&gt;swing_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   86</span>  myvalues.speed_val           = m_parent-&gt;speed_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   87</span>  myvalues.speed_ctrl_val      = m_parent-&gt;speed_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   88</span>  myvalues.speeda_val          = m_parent-&gt;speeda_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   89</span>  myvalues.speeda_ctrl_val     = m_parent-&gt;speeda_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   90</span>  myvalues.speeda_use_gradient_val =</div>
<div class="line"><span class="lineno">   91</span>      m_parent-&gt;speeda_use_gradient_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   92</span>  myvalues.speedscale_val     = m_parent-&gt;speedscale_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   93</span>  myvalues.toplayer_val       = m_parent-&gt;toplayer_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   94</span>  myvalues.mass_val           = m_parent-&gt;mass_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   95</span>  myvalues.scale_val          = m_parent-&gt;scale_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   96</span>  myvalues.scale_ctrl_val     = m_parent-&gt;scale_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   97</span>  myvalues.scale_ctrl_all_val = m_parent-&gt;scale_ctrl_all_val-&gt;getValue();</div>
<div class="line"><span class="lineno">   98</span>  myvalues.rot_val            = m_parent-&gt;rot_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">   99</span>  myvalues.rot_ctrl_val       = m_parent-&gt;rot_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  100</span>  myvalues.trail_val          = m_parent-&gt;trail_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  101</span>  myvalues.trailstep_val      = m_parent-&gt;trailstep_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  102</span>  myvalues.rotswingmode_val   = m_parent-&gt;rotswingmode_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  103</span>  myvalues.rotspeed_val       = m_parent-&gt;rotspeed_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  104</span>  myvalues.rotsca_val         = m_parent-&gt;rotsca_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  105</span>  myvalues.rotswing_val       = m_parent-&gt;rotswing_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  106</span>  myvalues.pathaim_val        = m_parent-&gt;pathaim_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  107</span>  myvalues.opacity_val        = m_parent-&gt;opacity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  108</span>  myvalues.opacity_ctrl_val   = m_parent-&gt;opacity_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  109</span>  myvalues.trailopacity_val   = m_parent-&gt;trailopacity_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  110</span>  <span class="comment">//  myvalues.mblur_val=m_parent-&gt;mblur_val-&gt;getValue(frame);</span></div>
<div class="line"><span class="lineno">  111</span>  myvalues.scalestep_val      = m_parent-&gt;scalestep_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  112</span>  myvalues.scalestep_ctrl_val = m_parent-&gt;scalestep_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  113</span>  myvalues.fadein_val         = m_parent-&gt;fadein_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  114</span>  myvalues.fadeout_val        = m_parent-&gt;fadeout_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  115</span>  myvalues.animation_val      = m_parent-&gt;animation_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  116</span>  myvalues.step_val           = m_parent-&gt;step_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  117</span> </div>
<div class="line"><span class="lineno">  118</span>  myvalues.gencol_val         = m_parent-&gt;gencol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  119</span>  myvalues.gencol_ctrl_val    = m_parent-&gt;gencol_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  120</span>  myvalues.gencol_spread_val  = m_parent-&gt;gencol_spread_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  121</span>  myvalues.genfadecol_val     = m_parent-&gt;genfadecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  122</span>  myvalues.fincol_val         = m_parent-&gt;fincol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  123</span>  myvalues.fincol_ctrl_val    = m_parent-&gt;fincol_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  124</span>  myvalues.fincol_spread_val  = m_parent-&gt;fincol_spread_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  125</span>  myvalues.finrangecol_val    = m_parent-&gt;finrangecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  126</span>  myvalues.finfadecol_val     = m_parent-&gt;finfadecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  127</span>  myvalues.foutcol_val        = m_parent-&gt;foutcol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  128</span>  myvalues.foutcol_ctrl_val   = m_parent-&gt;foutcol_ctrl_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  129</span>  myvalues.foutcol_spread_val = m_parent-&gt;foutcol_spread_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  130</span>  myvalues.foutrangecol_val   = m_parent-&gt;foutrangecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  131</span>  myvalues.foutfadecol_val    = m_parent-&gt;foutfadecol_val-&gt;getValue(frame);</div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>  myvalues.source_gradation_val = m_parent-&gt;source_gradation_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  134</span>  myvalues.pick_color_for_every_frame_val =</div>
<div class="line"><span class="lineno">  135</span>      m_parent-&gt;pick_color_for_every_frame_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  136</span>  myvalues.perspective_distribution_val =</div>
<div class="line"><span class="lineno">  137</span>      m_parent-&gt;perspective_distribution_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  138</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a17b1897dea0bc5f80d4d81a43d3cb6b4" name="a17b1897dea0bc5f80d4d81a43d3cb6b4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a17b1897dea0bc5f80d4d81a43d3cb6b4">&#9670;&nbsp;</a></span>normalize_array()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::normalize_array </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>myregions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a>&#160;</td>
          <td class="paramname"><em>pos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>lx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>ly</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>regioncounter</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>myarray</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>lista</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>listb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt; &amp;&#160;</td>
          <td class="paramname"><em>final</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  947</span>                                                  {</div>
<div class="line"><span class="lineno">  948</span>  <span class="keywordtype">int</span> i, j, k, l;</div>
<div class="line"><span class="lineno">  949</span> </div>
<div class="line"><span class="lineno">  950</span>  std::vector&lt;int&gt; tmp;</div>
<div class="line"><span class="lineno">  951</span>  <span class="keywordtype">int</span> maxregioncounter = 0;</div>
<div class="line"><span class="lineno">  952</span>  <span class="keywordtype">int</span> listsize         = (int)lista.size();</div>
<div class="line"><span class="lineno">  953</span>  <span class="comment">// TMSG_INFO(&quot;regioncounter %d, eqcount=%d\n&quot;, regioncounter, eqcount);</span></div>
<div class="line"><span class="lineno">  954</span>  <span class="keywordflow">for</span> (k = 1; k &lt;= regioncounter; k++) <span class="keyword">final</span>[k] = k;</div>
<div class="line"><span class="lineno">  955</span> </div>
<div class="line"><span class="lineno">  956</span>  <span class="keywordflow">for</span> (l = 0; l &lt; listsize; l++) {</div>
<div class="line"><span class="lineno">  957</span>    j = lista[l];</div>
<div class="line"><span class="lineno">  958</span>    <span class="comment">/*TMSG_INFO(&quot;j vale %d\n&quot;, j);*/</span></div>
<div class="line"><span class="lineno">  959</span>    <span class="keywordflow">while</span> (<span class="keyword">final</span>[j] != j) j = <span class="keyword">final</span>[j];</div>
<div class="line"><span class="lineno">  960</span>    k = listb[l];</div>
<div class="line"><span class="lineno">  961</span>    <span class="comment">/*TMSG_INFO(&quot;k vale %d\n&quot;, k);*/</span></div>
<div class="line"><span class="lineno">  962</span>    <span class="keywordflow">while</span> (<span class="keyword">final</span>[k] != k) k = <span class="keyword">final</span>[k];</div>
<div class="line"><span class="lineno">  963</span>    <span class="keywordflow">if</span> (j != k) <span class="keyword">final</span>[j] = k;</div>
<div class="line"><span class="lineno">  964</span>  }</div>
<div class="line"><span class="lineno">  965</span>  <span class="comment">// TMSG_INFO(&quot;esco dal for\n&quot;);</span></div>
<div class="line"><span class="lineno">  966</span>  <span class="keywordflow">for</span> (j = 1; j &lt;= regioncounter; j++)</div>
<div class="line"><span class="lineno">  967</span>    <span class="keywordflow">while</span> (<span class="keyword">final</span>[j] != <span class="keyword">final</span>[<span class="keyword">final</span>[j]]) <span class="keyword">final</span>[j] = <span class="keyword">final</span>[<span class="keyword">final</span>[j]];</div>
<div class="line"><span class="lineno">  968</span> </div>
<div class="line"><span class="lineno">  969</span>  <span class="comment">/*conto quante cavolo di regioni sono*/</span></div>
<div class="line"><span class="lineno">  970</span> </div>
<div class="line"><span class="lineno">  971</span>  tmp.push_back(<span class="keyword">final</span>[1]);</div>
<div class="line"><span class="lineno">  972</span>  maxregioncounter = 1;</div>
<div class="line"><span class="lineno">  973</span>  <span class="keywordflow">for</span> (i = 2; i &lt;= regioncounter; i++) {</div>
<div class="line"><span class="lineno">  974</span>    <span class="keywordtype">int</span> diff = 1;</div>
<div class="line"><span class="lineno">  975</span>    <span class="keywordflow">for</span> (j = 0; j &lt; maxregioncounter; j++) {</div>
<div class="line"><span class="lineno">  976</span>      <span class="keywordflow">if</span> (tmp[j] == <span class="keyword">final</span>[i]) {</div>
<div class="line"><span class="lineno">  977</span>        diff = 0;</div>
<div class="line"><span class="lineno">  978</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  979</span>      }</div>
<div class="line"><span class="lineno">  980</span>    }</div>
<div class="line"><span class="lineno">  981</span>    <span class="keywordflow">if</span> (diff) {</div>
<div class="line"><span class="lineno">  982</span>      tmp.push_back(<span class="keyword">final</span>[i]);</div>
<div class="line"><span class="lineno">  983</span>      maxregioncounter++;</div>
<div class="line"><span class="lineno">  984</span>    }</div>
<div class="line"><span class="lineno">  985</span>  }</div>
<div class="line"><span class="lineno">  986</span> </div>
<div class="line"><span class="lineno">  987</span>  myregions.resize(maxregioncounter);</div>
<div class="line"><span class="lineno">  988</span>  <span class="keywordflow">for</span> (j = 0; j &lt; ly; j++) {</div>
<div class="line"><span class="lineno">  989</span>    <span class="keywordflow">for</span> (i = 0; i &lt; lx; i++) {</div>
<div class="line"><span class="lineno">  990</span>      <span class="keywordtype">int</span> tmpindex;</div>
<div class="line"><span class="lineno">  991</span>      <span class="keywordflow">if</span> (myarray[i + lx * j]) {</div>
<div class="line"><span class="lineno">  992</span>        tmpindex = <span class="keyword">final</span>[myarray[i + lx * j]];</div>
<div class="line"><span class="lineno">  993</span>        <span class="comment">/*TMSG_INFO(&quot;tmpindex=%d\n&quot;, tmpindex);*/</span></div>
<div class="line"><span class="lineno">  994</span>        <span class="keywordflow">for</span> (k = 0; k &lt; maxregioncounter; k++) {</div>
<div class="line"><span class="lineno">  995</span>          <span class="keywordflow">if</span> (tmp[k] == tmpindex) <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  996</span>        }</div>
<div class="line"><span class="lineno">  997</span>        <span class="comment">/*TMSG_INFO(&quot;k=%d\n&quot;, k);*/</span></div>
<div class="line"><span class="lineno">  998</span>        <a class="code hl_class" href="class_t_point_t.html">TPointD</a> tmppoint;</div>
<div class="line"><span class="lineno">  999</span>        tmppoint.x = i;</div>
<div class="line"><span class="lineno"> 1000</span>        tmppoint.y = j;</div>
<div class="line"><span class="lineno"> 1001</span>        tmppoint += pos;</div>
<div class="line"><span class="lineno"> 1002</span>        myregions[k].push_back(tmppoint);</div>
<div class="line"><span class="lineno"> 1003</span>      }</div>
<div class="line"><span class="lineno"> 1004</span>    }</div>
<div class="line"><span class="lineno"> 1005</span>  }</div>
<div class="line"><span class="lineno"> 1006</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a34f547141f79b53786ec88026fc7b523" name="a34f547141f79b53786ec88026fc7b523"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34f547141f79b53786ec88026fc7b523">&#9670;&nbsp;</a></span>normalize_values()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::normalize_values </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  390</span>                                                                   {</div>
<div class="line"><span class="lineno">  391</span>  <span class="keywordtype">double</span> dpicorr = 1;</div>
<div class="line"><span class="lineno">  392</span>  <a class="code hl_class" href="class_t_point_t.html">TPointD</a> pos(values.x_pos_val, values.y_pos_val);</div>
<div class="line"><span class="lineno">  393</span> </div>
<div class="line"><span class="lineno">  394</span>  (values.x_pos_val)               = pos.x;</div>
<div class="line"><span class="lineno">  395</span>  (values.y_pos_val)               = pos.y;</div>
<div class="line"><span class="lineno">  396</span>  (values.length_val)              = (values.length_val) * dpicorr;</div>
<div class="line"><span class="lineno">  397</span>  (values.height_val)              = (values.height_val) * dpicorr;</div>
<div class="line"><span class="lineno">  398</span>  (values.gravity_val)             = (values.gravity_val) * dpicorr * 0.1;</div>
<div class="line"><span class="lineno">  399</span>  (values.windint_val)             = (values.windint_val) * dpicorr;</div>
<div class="line"><span class="lineno">  400</span>  (values.speed_val.first)         = (values.speed_val.first) * dpicorr;</div>
<div class="line"><span class="lineno">  401</span>  (values.speed_val.second)        = (values.speed_val.second) * dpicorr;</div>
<div class="line"><span class="lineno">  402</span>  (values.randomx_val.first)       = (values.randomx_val.first) * dpicorr;</div>
<div class="line"><span class="lineno">  403</span>  (values.randomx_val.second)      = (values.randomx_val.second) * dpicorr;</div>
<div class="line"><span class="lineno">  404</span>  (values.randomy_val.first)       = (values.randomy_val.first) * dpicorr;</div>
<div class="line"><span class="lineno">  405</span>  (values.randomy_val.second)      = (values.randomy_val.second) * dpicorr;</div>
<div class="line"><span class="lineno">  406</span>  (values.scale_val.first)         = (values.scale_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  407</span>  (values.scale_val.second)        = (values.scale_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  408</span>  (values.scalestep_val.first)     = (values.scalestep_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  409</span>  (values.scalestep_val.second)    = (values.scalestep_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  410</span>  (values.opacity_val.first)       = (values.opacity_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  411</span>  (values.opacity_val.second)      = (values.opacity_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  412</span>  (values.trailopacity_val.first)  = (values.trailopacity_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  413</span>  (values.trailopacity_val.second) = (values.trailopacity_val.second) * 0.01;</div>
<div class="line"><span class="lineno">  414</span>  (values.mblur_val)               = (values.mblur_val) * 0.01;</div>
<div class="line"><span class="lineno">  415</span>  (values.friction_val)            = -(values.friction_val) * 0.01;</div>
<div class="line"><span class="lineno">  416</span>  (values.windangle_val)           = (values.windangle_val) * M_PI_180;</div>
<div class="line"><span class="lineno">  417</span>  (values.g_angle_val)             = (values.g_angle_val + 180) * M_PI_180;</div>
<div class="line"><span class="lineno">  418</span>  (values.speeda_val.first)        = (values.speeda_val.first) * M_PI_180;</div>
<div class="line"><span class="lineno">  419</span>  (values.speeda_val.second)       = (values.speeda_val.second) * M_PI_180;</div>
<div class="line"><span class="lineno">  420</span>  <span class="keywordflow">if</span> (values.step_val &lt; 1) values.step_val = 1;</div>
<div class="line"><span class="lineno">  421</span>  values.genfadecol_val  = (values.genfadecol_val) * 0.01;</div>
<div class="line"><span class="lineno">  422</span>  values.finfadecol_val  = (values.finfadecol_val) * 0.01;</div>
<div class="line"><span class="lineno">  423</span>  values.foutfadecol_val = (values.foutfadecol_val) * 0.01;</div>
<div class="line"><span class="lineno">  424</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af32131f9ec282edf022cf31d64c649a6" name="af32131f9ec282edf022cf31d64c649a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af32131f9ec282edf022cf31d64c649a6">&#9670;&nbsp;</a></span>port_is_used()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Particles_Engine::port_is_used </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  162</span>                                                                          {</div>
<div class="line"><span class="lineno">  163</span>  <span class="keywordflow">return</span> port_is_used_for_value(i, values) ||</div>
<div class="line"><span class="lineno">  164</span>         port_is_used_for_gradient(i, values);</div>
<div class="line"><span class="lineno">  165</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a661623d1f20fea584375a24ec1911471" name="a661623d1f20fea584375a24ec1911471"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a661623d1f20fea584375a24ec1911471">&#9670;&nbsp;</a></span>port_is_used_for_gradient()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Particles_Engine::port_is_used_for_gradient </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  184</span>                                            {</div>
<div class="line"><span class="lineno">  185</span>  <span class="keywordflow">return</span> values.gravity_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  186</span>         (values.speeda_ctrl_val == i &amp;&amp; values.speeda_use_gradient_val);</div>
<div class="line"><span class="lineno">  187</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ae93e03a8c641edfbe8a7b33fb6a1fa48" name="ae93e03a8c641edfbe8a7b33fb6a1fa48"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae93e03a8c641edfbe8a7b33fb6a1fa48">&#9670;&nbsp;</a></span>port_is_used_for_value()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Particles_Engine::port_is_used_for_value </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  170</span>                                                                               {</div>
<div class="line"><span class="lineno">  171</span>  <span class="keywordflow">return</span> values.fincol_ctrl_val == i || values.foutcol_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  172</span>         values.friction_ctrl_val == i || values.gencol_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  173</span>         values.opacity_ctrl_val == i || values.rot_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  174</span>         values.scale_ctrl_val == i || values.scalestep_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  175</span>         values.source_ctrl_val == i || values.speed_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  176</span>         (values.speeda_ctrl_val == i &amp;&amp; !values.speeda_use_gradient_val) ||</div>
<div class="line"><span class="lineno">  177</span>         values.lifetime_ctrl_val == i || values.randomx_ctrl_val == i ||</div>
<div class="line"><span class="lineno">  178</span>         values.randomy_ctrl_val == i;</div>
<div class="line"><span class="lineno">  179</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ab7574ab8a9217f960e1ce339e90c18dc" name="ab7574ab8a9217f960e1ce339e90c18dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab7574ab8a9217f960e1ce339e90c18dc">&#9670;&nbsp;</a></span>render_particles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::render_particles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>part_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_dimension_t.html">TDimension</a> &amp;&#160;</td>
          <td class="paramname"><em>p_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a> &amp;&#160;</td>
          <td class="paramname"><em>p_offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; int, <a class="el" href="class_t_raster_fx_port.html">TRasterFxPort</a> * &gt;&#160;</td>
          <td class="paramname"><em>ctrl_ports</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_level_p.html">TLevelP</a> &gt;&#160;</td>
          <td class="paramname"><em>partLevel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>dpi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>curr_frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>shrink</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>startx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>starty</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>endx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>endy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt;&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>fxId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  433</span>                                                                             {</div>
<div class="line"><span class="lineno">  434</span>  <span class="keywordtype">int</span> frame, startframe, intpart = 0, level_n = 0;</div>
<div class="line"><span class="lineno">  435</span>  <span class="keyword">struct </span><a class="code hl_struct" href="structparticles__values.html">particles_values</a> values;</div>
<div class="line"><span class="lineno">  436</span>  <span class="keywordtype">double</span> dpicorr = dpi * 0.01, fractpart = 0, dpicorr_shrinked = 0,</div>
<div class="line"><span class="lineno">  437</span>         opacity_range = 0;</div>
<div class="line"><span class="lineno">  438</span>  <span class="keywordtype">bool</span> random_level    = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  439</span>  level_n              = part_ports.size();</div>
<div class="line"><span class="lineno">  440</span> </div>
<div class="line"><span class="lineno">  441</span>  <span class="keywordtype">bool</span> isPrecomputingEnabled = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  442</span>  {</div>
<div class="line"><span class="lineno">  443</span>    <a class="code hl_class" href="class_t_renderer.html">TRenderer</a> renderer(<a class="code hl_function" href="class_t_renderer.html#a93afee3c1ce8ff2b753a05fa0fe3dc9d">TRenderer::instance</a>());</div>
<div class="line"><span class="lineno">  444</span>    isPrecomputingEnabled =</div>
<div class="line"><span class="lineno">  445</span>        (renderer &amp;&amp; renderer.isPrecomputingEnabled()) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  446</span>  }</div>
<div class="line"><span class="lineno">  447</span> </div>
<div class="line"><span class="lineno">  448</span>  memset(&amp;values, 0, <span class="keyword">sizeof</span>(values));</div>
<div class="line"><span class="lineno">  449</span>  <span class="comment">/*- 現在のフレームでの各種パラメータを得る -*/</span></div>
<div class="line"><span class="lineno">  450</span>  fill_value_struct(values, m_frame);</div>
<div class="line"><span class="lineno">  451</span>  <span class="comment">/*- 不透明度の範囲（透明〜不透明を 0〜1 に正規化）-*/</span></div>
<div class="line"><span class="lineno">  452</span>  opacity_range = (values.opacity_val.second - values.opacity_val.first) * 0.01;</div>
<div class="line"><span class="lineno">  453</span>  <span class="comment">/*- 開始フレーム -*/</span></div>
<div class="line"><span class="lineno">  454</span>  startframe = (int)values.startpos_val;</div>
<div class="line"><span class="lineno">  455</span>  if (values.unit_val == ParticlesFx::UNIT_SMALL_INCH)</div>
<div class="line"><span class="lineno">  456</span>    dpicorr_shrinked = dpicorr / shrink;</div>
<div class="line"><span class="lineno">  457</span>  <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  458</span>    dpicorr_shrinked = dpi / shrink;</div>
<div class="line"><span class="lineno">  459</span> </div>
<div class="line"><span class="lineno">  460</span>  std::map&lt;std::pair&lt;int, int&gt;, <span class="keywordtype">double</span>&gt; partScales;</div>
<div class="line"><span class="lineno">  461</span>  curr_frame = curr_frame / values.step_val;</div>
<div class="line"><span class="lineno">  462</span> </div>
<div class="line"><span class="lineno">  463</span>  <a class="code hl_class" href="class_particles_manager.html">ParticlesManager</a> *pc = ParticlesManager::instance();</div>
<div class="line"><span class="lineno">  464</span> </div>
<div class="line"><span class="lineno">  465</span>  <span class="comment">// Retrieve the last rolled frame</span></div>
<div class="line"><span class="lineno">  466</span>  <a class="code hl_struct" href="struct_particles_manager_1_1_frame_data.html">ParticlesManager::FrameData</a> *particlesData = pc-&gt;data(fxId);</div>
<div class="line"><span class="lineno">  467</span> </div>
<div class="line"><span class="lineno">  468</span>  std::list&lt;Particle&gt; myParticles;</div>
<div class="line"><span class="lineno">  469</span>  <a class="code hl_class" href="class_t_random.html">TRandom</a> myRandom;</div>
<div class="line"><span class="lineno">  470</span>  values.random_val  = &amp;myRandom;</div>
<div class="line"><span class="lineno">  471</span>  myRandom           = m_parent-&gt;randseed_val-&gt;getValue();</div>
<div class="line"><span class="lineno">  472</span>  <span class="keywordtype">int</span> totalparticles = 0;</div>
<div class="line"><span class="lineno">  473</span> </div>
<div class="line"><span class="lineno">  474</span>  <span class="keywordtype">int</span> pcFrame = particlesData-&gt;m_frame;</div>
<div class="line"><span class="lineno">  475</span>  <span class="keywordflow">if</span> (pcFrame &gt; curr_frame) {</div>
<div class="line"><span class="lineno">  476</span>    <span class="comment">// Clear stored particlesData</span></div>
<div class="line"><span class="lineno">  477</span>    particlesData-&gt;clear();</div>
<div class="line"><span class="lineno">  478</span>    pcFrame = particlesData-&gt;m_frame;</div>
<div class="line"><span class="lineno">  479</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcFrame &gt;= startframe - 1) {</div>
<div class="line"><span class="lineno">  480</span>    myParticles    = particlesData-&gt;m_particles;</div>
<div class="line"><span class="lineno">  481</span>    myRandom       = particlesData-&gt;m_random;</div>
<div class="line"><span class="lineno">  482</span>    totalparticles = particlesData-&gt;m_totalParticles;</div>
<div class="line"><span class="lineno">  483</span>  }</div>
<div class="line"><span class="lineno">  484</span>  <span class="comment">/*- スタートからカレントフレームまでループ -*/</span></div>
<div class="line"><span class="lineno">  485</span>  <span class="keywordflow">for</span> (frame = startframe - 1; frame &lt;= curr_frame; ++frame) {</div>
<div class="line"><span class="lineno">  486</span>    <span class="keywordtype">int</span> dist_frame = curr_frame - frame;</div>
<div class="line"><span class="lineno">  487</span>    <span class="comment">/*-</span></div>
<div class="line"><span class="lineno">  488</span><span class="comment">     * ループ内の現在のフレームでのパラメータを取得。スタートが負ならフレーム=0のときの値を格納</span></div>
<div class="line"><span class="lineno">  489</span><span class="comment">     * -*/</span></div>
<div class="line"><span class="lineno">  490</span>    fill_value_struct(values, frame &lt; 0 ? 0 : frame * values.step_val);</div>
<div class="line"><span class="lineno">  491</span>    <span class="comment">/*- パラメータの正規化 -*/</span></div>
<div class="line"><span class="lineno">  492</span>    normalize_values(values, ri);</div>
<div class="line"><span class="lineno">  493</span>    <span class="comment">/*- maxnum_valは&quot;birth_rate&quot;のパラメータ -*/</span></div>
<div class="line"><span class="lineno">  494</span>    intpart = (int)values.maxnum_val;</div>
<div class="line"><span class="lineno">  495</span>    <span class="comment">/*-</span></div>
<div class="line"><span class="lineno">  496</span><span class="comment">     * /birth_rateが小数だったとき、各フレームの小数部分を足しこんだ結果の整数部分をintpartに渡す。</span></div>
<div class="line"><span class="lineno">  497</span><span class="comment">     * -*/</span></div>
<div class="line"><span class="lineno">  498</span>    fractpart = fractpart + values.maxnum_val - intpart;</div>
<div class="line"><span class="lineno">  499</span>    if ((<span class="keywordtype">int</span>)fractpart) {</div>
<div class="line"><span class="lineno">  500</span>      values.maxnum_val += (int)fractpart;</div>
<div class="line"><span class="lineno">  501</span>      fractpart = fractpart - (int)fractpart;</div>
<div class="line"><span class="lineno">  502</span>    }</div>
<div class="line"><span class="lineno">  503</span> </div>
<div class="line"><span class="lineno">  504</span>    std::map&lt;int, TTile *&gt; porttiles;</div>
<div class="line"><span class="lineno">  505</span> </div>
<div class="line"><span class="lineno">  506</span>    <span class="comment">// Perform the roll</span></div>
<div class="line"><span class="lineno">  507</span>    <span class="comment">/*- RenderSettingsを複製して現在のフレームの計算用にする -*/</span></div>
<div class="line"><span class="lineno">  508</span>    <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riAux(ri);</div>
<div class="line"><span class="lineno">  509</span>    riAux.m_affine = <a class="code hl_class" href="class_t_affine.html">TAffine</a>();</div>
<div class="line"><span class="lineno">  510</span>    riAux.m_bpp    = 32;</div>
<div class="line"><span class="lineno">  511</span>    <span class="comment">// control image using its gradient is computed in 64bpp</span></div>
<div class="line"><span class="lineno">  512</span>    <a class="code hl_class" href="class_t_render_settings.html">TRenderSettings</a> riAux64(riAux);</div>
<div class="line"><span class="lineno">  513</span>    riAux64.m_bpp = 64;</div>
<div class="line"><span class="lineno">  514</span> </div>
<div class="line"><span class="lineno">  515</span>    <span class="keywordtype">int</span> r_frame;  <span class="comment">// Useful in case of negative roll frames</span></div>
<div class="line"><span class="lineno">  516</span>    <span class="keywordflow">if</span> (frame &lt; 0)</div>
<div class="line"><span class="lineno">  517</span>      r_frame = 0;</div>
<div class="line"><span class="lineno">  518</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  519</span>      r_frame = frame;</div>
<div class="line"><span class="lineno">  520</span>    <span class="comment">/*- 出力画像のバウンディングボックス -*/</span></div>
<div class="line"><span class="lineno">  521</span>    <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> outTileBBox(tile-&gt;m_pos, <a class="code hl_class" href="class_t_dimension_t.html">TDimensionD</a>(tile-&gt;getRaster()-&gt;getLx(),</div>
<div class="line"><span class="lineno">  522</span>                                                tile-&gt;getRaster()-&gt;getLy()));</div>
<div class="line"><span class="lineno">  523</span> </div>
<div class="line"><span class="lineno">  524</span>    <span class="comment">// enlarge bounding box for control images with infinite bbox in case the</span></div>
<div class="line"><span class="lineno">  525</span>    <span class="comment">// source region is larger than output tile</span></div>
<div class="line"><span class="lineno">  526</span>    <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> bboxForInifiniteSource = ri.<a class="code hl_variable" href="class_t_render_settings.html#a1250181bf3fe8e05db005d5faa76b3ea">m_affine</a>.<a class="code hl_function" href="class_t_affine.html#a570529b96b1ec5abc711aaa9aac09ff9">inv</a>() * outTileBBox;</div>
<div class="line"><span class="lineno">  527</span>    <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> sourceBbox;</div>
<div class="line"><span class="lineno">  528</span>    <span class="keywordflow">if</span> (values.source_ctrl_val &amp;&amp;</div>
<div class="line"><span class="lineno">  529</span>        ctrl_ports.at(values.source_ctrl_val)-&gt;isConnected()) {</div>
<div class="line"><span class="lineno">  530</span>      (*(ctrl_ports.at(values.source_ctrl_val)))</div>
<div class="line"><span class="lineno">  531</span>          -&gt;getBBox(r_frame, sourceBbox, riAux);</div>
<div class="line"><span class="lineno">  532</span>    }</div>
<div class="line"><span class="lineno">  533</span>    <span class="keywordflow">if</span> (sourceBbox.<a class="code hl_function" href="class_t_rect_t.html#a53ce09c6112f8a019b43ad82d721a93b">isEmpty</a>() || sourceBbox == TConsts::infiniteRectD) {</div>
<div class="line"><span class="lineno">  534</span>      sourceBbox = <a class="code hl_class" href="class_t_rect_t.html">TRectD</a>(values.x_pos_val - values.length_val * 0.5,</div>
<div class="line"><span class="lineno">  535</span>                          values.y_pos_val - values.height_val * 0.5,</div>
<div class="line"><span class="lineno">  536</span>                          values.x_pos_val + values.length_val * 0.5,</div>
<div class="line"><span class="lineno">  537</span>                          values.y_pos_val + values.height_val * 0.5);</div>
<div class="line"><span class="lineno">  538</span>    }</div>
<div class="line"><span class="lineno">  539</span>    bboxForInifiniteSource += sourceBbox;</div>
<div class="line"><span class="lineno">  540</span> </div>
<div class="line"><span class="lineno">  541</span>    <span class="comment">/*- Controlに刺さっている各ポートについて -*/</span></div>
<div class="line"><span class="lineno">  542</span>    <span class="keywordflow">for</span> (std::map&lt;int, TRasterFxPort *&gt;::iterator it = ctrl_ports.begin();</div>
<div class="line"><span class="lineno">  543</span>         it != ctrl_ports.end(); ++it) {</div>
<div class="line"><span class="lineno">  544</span>      <a class="code hl_class" href="class_t_tile.html">TTile</a> *tmp;</div>
<div class="line"><span class="lineno">  545</span>      <span class="comment">/*- ポートが接続されていて、Fx内で実際に使用されていたら -*/</span></div>
<div class="line"><span class="lineno">  546</span>      <span class="keywordflow">if</span> ((it-&gt;second)-&gt;isConnected() &amp;&amp; port_is_used(it-&gt;first, values)) {</div>
<div class="line"><span class="lineno">  547</span>        <a class="code hl_class" href="class_t_rect_t.html">TRectD</a> bbox;</div>
<div class="line"><span class="lineno">  548</span>        (*(it-&gt;second))-&gt;getBBox(r_frame, bbox, riAux);</div>
<div class="line"><span class="lineno">  549</span>        <span class="comment">/*- 素材が存在する場合、portTilesにコントロール画像タイルを格納 -*/</span></div>
<div class="line"><span class="lineno">  550</span>        <span class="keywordflow">if</span> (!bbox.<a class="code hl_function" href="class_t_rect_t.html#a53ce09c6112f8a019b43ad82d721a93b">isEmpty</a>()) {</div>
<div class="line"><span class="lineno">  551</span>          <span class="keywordflow">if</span> (bbox == TConsts::infiniteRectD)  <span class="comment">// There could be an infinite</span></div>
<div class="line"><span class="lineno">  552</span>                                               <span class="comment">// bbox - deal with it</span></div>
<div class="line"><span class="lineno">  553</span>            bbox = bboxForInifiniteSource;</div>
<div class="line"><span class="lineno">  554</span> </div>
<div class="line"><span class="lineno">  555</span>          <span class="keywordflow">if</span> (frame &lt;= pcFrame) {</div>
<div class="line"><span class="lineno">  556</span>            <span class="comment">// This frame will not actually be rolled. However, it was</span></div>
<div class="line"><span class="lineno">  557</span>            <span class="comment">// dryComputed - so, declare the same here.</span></div>
<div class="line"><span class="lineno">  558</span>            (*it-&gt;second)-&gt;dryCompute(bbox, r_frame, riAux);</div>
<div class="line"><span class="lineno">  559</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  560</span>            <span class="comment">// control image is used its gradient</span></div>
<div class="line"><span class="lineno">  561</span>            <span class="keywordflow">if</span> (port_is_used_for_gradient(it-&gt;first, values)) {</div>
<div class="line"><span class="lineno">  562</span>              tmp = <span class="keyword">new</span> <a class="code hl_class" href="class_t_tile.html">TTile</a>;</div>
<div class="line"><span class="lineno">  563</span> </div>
<div class="line"><span class="lineno">  564</span>              <span class="keywordflow">if</span> (isPrecomputingEnabled)</div>
<div class="line"><span class="lineno">  565</span>                (*it-&gt;second)</div>
<div class="line"><span class="lineno">  566</span>                    -&gt;allocateAndCompute(*tmp, bbox.getP00(),</div>
<div class="line"><span class="lineno">  567</span>                                         convert(bbox).getSize(), 0, r_frame,</div>
<div class="line"><span class="lineno">  568</span>                                         riAux64);</div>
<div class="line"><span class="lineno">  569</span>              <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  570</span>                std::string alias =</div>
<div class="line"><span class="lineno">  571</span>                    <span class="stringliteral">&quot;CTRL64: &quot;</span> + (*(it-&gt;second))-&gt;getAlias(r_frame, riAux64);</div>
<div class="line"><span class="lineno">  572</span>                <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  573</span> </div>
<div class="line"><span class="lineno">  574</span>                <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  575</span>                  tmp-&gt;m_pos = bbox.getP00();</div>
<div class="line"><span class="lineno">  576</span>                  tmp-&gt;setRaster(rimg-&gt;getRaster());</div>
<div class="line"><span class="lineno">  577</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  578</span>                  (*it-&gt;second)</div>
<div class="line"><span class="lineno">  579</span>                      -&gt;allocateAndCompute(*tmp, bbox.getP00(),</div>
<div class="line"><span class="lineno">  580</span>                                           convert(bbox).getSize(), 0, r_frame,</div>
<div class="line"><span class="lineno">  581</span>                                           riAux64);</div>
<div class="line"><span class="lineno">  582</span> </div>
<div class="line"><span class="lineno">  583</span>                  addRenderCache(alias, <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>(tmp-&gt;getRaster()));</div>
<div class="line"><span class="lineno">  584</span>                }</div>
<div class="line"><span class="lineno">  585</span>              }</div>
<div class="line"><span class="lineno">  586</span> </div>
<div class="line"><span class="lineno">  587</span>              porttiles[it-&gt;first + Ctrl_64_Offset] = tmp;</div>
<div class="line"><span class="lineno">  588</span> </div>
<div class="line"><span class="lineno">  589</span>              <span class="comment">// in case the control image is also used for non-gradient</span></div>
<div class="line"><span class="lineno">  590</span>              <span class="keywordflow">if</span> (port_is_used_for_value(it-&gt;first, values)) {</div>
<div class="line"><span class="lineno">  591</span>                <a class="code hl_class" href="class_t_raster_p_t.html">TRaster32P</a> tileRas(tmp-&gt;getRaster()-&gt;getSize());</div>
<div class="line"><span class="lineno">  592</span>                <a class="code hl_function" href="namespace_t_rop.html#a45a08fb48dd7d33ec629d722081d55c6">TRop::convert</a>(tileRas, tmp-&gt;getRaster());</div>
<div class="line"><span class="lineno">  593</span>                tmp        = <span class="keyword">new</span> <a class="code hl_class" href="class_t_tile.html">TTile</a>;</div>
<div class="line"><span class="lineno">  594</span>                tmp-&gt;m_pos = bbox.getP00();</div>
<div class="line"><span class="lineno">  595</span>                tmp-&gt;setRaster(tileRas);</div>
<div class="line"><span class="lineno">  596</span>                porttiles[it-&gt;first] = tmp;</div>
<div class="line"><span class="lineno">  597</span>              }</div>
<div class="line"><span class="lineno">  598</span>            }</div>
<div class="line"><span class="lineno">  599</span>            <span class="comment">// control images used only for non-gradient</span></div>
<div class="line"><span class="lineno">  600</span>            <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  601</span>              tmp = <span class="keyword">new</span> <a class="code hl_class" href="class_t_tile.html">TTile</a>;</div>
<div class="line"><span class="lineno">  602</span> </div>
<div class="line"><span class="lineno">  603</span>              <span class="keywordflow">if</span> (isPrecomputingEnabled)</div>
<div class="line"><span class="lineno">  604</span>                (*it-&gt;second)</div>
<div class="line"><span class="lineno">  605</span>                    -&gt;allocateAndCompute(*tmp, bbox.getP00(),</div>
<div class="line"><span class="lineno">  606</span>                                         convert(bbox).getSize(), 0, r_frame,</div>
<div class="line"><span class="lineno">  607</span>                                         riAux);</div>
<div class="line"><span class="lineno">  608</span>              <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  609</span>                std::string alias =</div>
<div class="line"><span class="lineno">  610</span>                    <span class="stringliteral">&quot;CTRL: &quot;</span> + (*(it-&gt;second))-&gt;getAlias(r_frame, riAux);</div>
<div class="line"><span class="lineno">  611</span>                <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a> rimg = TImageCache::instance()-&gt;<a class="code hl_function" href="class_t_image_cache.html#aea3ac2752efd6fa9689f5a7c1e895e41">get</a>(alias, <span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  612</span> </div>
<div class="line"><span class="lineno">  613</span>                <span class="keywordflow">if</span> (rimg) {</div>
<div class="line"><span class="lineno">  614</span>                  tmp-&gt;m_pos = bbox.getP00();</div>
<div class="line"><span class="lineno">  615</span>                  tmp-&gt;setRaster(rimg-&gt;getRaster());</div>
<div class="line"><span class="lineno">  616</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  617</span>                  (*it-&gt;second)</div>
<div class="line"><span class="lineno">  618</span>                      -&gt;allocateAndCompute(*tmp, bbox.getP00(),</div>
<div class="line"><span class="lineno">  619</span>                                           convert(bbox).getSize(), 0, r_frame,</div>
<div class="line"><span class="lineno">  620</span>                                           riAux);</div>
<div class="line"><span class="lineno">  621</span> </div>
<div class="line"><span class="lineno">  622</span>                  addRenderCache(alias, <a class="code hl_class" href="class_t_raster_image_p.html">TRasterImageP</a>(tmp-&gt;getRaster()));</div>
<div class="line"><span class="lineno">  623</span>                }</div>
<div class="line"><span class="lineno">  624</span>              }</div>
<div class="line"><span class="lineno">  625</span> </div>
<div class="line"><span class="lineno">  626</span>              porttiles[it-&gt;first] = tmp;</div>
<div class="line"><span class="lineno">  627</span>            }</div>
<div class="line"><span class="lineno">  628</span>          }</div>
<div class="line"><span class="lineno">  629</span>        }</div>
<div class="line"><span class="lineno">  630</span>      }</div>
<div class="line"><span class="lineno">  631</span>    }</div>
<div class="line"><span class="lineno">  632</span> </div>
<div class="line"><span class="lineno">  633</span>    <span class="keywordflow">if</span> (frame &gt; pcFrame) {</div>
<div class="line"><span class="lineno">  634</span>      <span class="comment">// Invoke the actual rolling procedure</span></div>
<div class="line"><span class="lineno">  635</span>      roll_particles(tile, porttiles, riAux, myParticles, values, 0, 0, frame,</div>
<div class="line"><span class="lineno">  636</span>                     curr_frame, level_n, &amp;random_level, 1, last_frame,</div>
<div class="line"><span class="lineno">  637</span>                     totalparticles);</div>
<div class="line"><span class="lineno">  638</span> </div>
<div class="line"><span class="lineno">  639</span>      <span class="comment">// Store the rolled data in the particles manager</span></div>
<div class="line"><span class="lineno">  640</span>      <span class="keywordflow">if</span> (!particlesData-&gt;m_calculated ||</div>
<div class="line"><span class="lineno">  641</span>          particlesData-&gt;m_frame + particlesData-&gt;m_maxTrail &lt; frame) {</div>
<div class="line"><span class="lineno">  642</span>        particlesData-&gt;m_frame     = frame;</div>
<div class="line"><span class="lineno">  643</span>        particlesData-&gt;m_particles = myParticles;</div>
<div class="line"><span class="lineno">  644</span>        particlesData-&gt;m_random    = myRandom;</div>
<div class="line"><span class="lineno">  645</span>        particlesData-&gt;buildMaxTrail();</div>
<div class="line"><span class="lineno">  646</span>        particlesData-&gt;m_calculated     = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  647</span>        particlesData-&gt;m_totalParticles = totalparticles;</div>
<div class="line"><span class="lineno">  648</span>      }</div>
<div class="line"><span class="lineno">  649</span>    }</div>
<div class="line"><span class="lineno">  650</span> </div>
<div class="line"><span class="lineno">  651</span>    <span class="comment">// Render the particles if the distance from current frame is a trail</span></div>
<div class="line"><span class="lineno">  652</span>    <span class="comment">// multiple</span></div>
<div class="line"><span class="lineno">  653</span>    <span class="keywordflow">if</span> (frame &gt;= startframe - 1 &amp;&amp;</div>
<div class="line"><span class="lineno">  654</span>        !(dist_frame %</div>
<div class="line"><span class="lineno">  655</span>          (values.trailstep_val &gt; 1.0 ? (<span class="keywordtype">int</span>)values.trailstep_val : 1))) {</div>
<div class="line"><span class="lineno">  656</span>      <span class="comment">// Store the maximum particle size before the do_render cycle</span></div>
<div class="line"><span class="lineno">  657</span>      std::list&lt;Particle&gt;::iterator pt;</div>
<div class="line"><span class="lineno">  658</span>      <span class="keywordflow">for</span> (pt = myParticles.begin(); pt != myParticles.end(); ++pt) {</div>
<div class="line"><span class="lineno">  659</span>        <a class="code hl_class" href="class_particle.html">Particle</a> &amp;part = *pt;</div>
<div class="line"><span class="lineno">  660</span>        <span class="keywordtype">int</span> ndx        = part.frame % last_frame[part.level];</div>
<div class="line"><span class="lineno">  661</span>        std::pair&lt;int, int&gt; ndxPair(part.level, ndx);</div>
<div class="line"><span class="lineno">  662</span> </div>
<div class="line"><span class="lineno">  663</span>        std::map&lt;std::pair&lt;int, int&gt;, <span class="keywordtype">double</span>&gt;::iterator it =</div>
<div class="line"><span class="lineno">  664</span>            partScales.find(ndxPair);</div>
<div class="line"><span class="lineno">  665</span> </div>
<div class="line"><span class="lineno">  666</span>        <span class="keywordflow">if</span> (it != partScales.end())</div>
<div class="line"><span class="lineno">  667</span>          it-&gt;second = std::max(part.scale, it-&gt;second);</div>
<div class="line"><span class="lineno">  668</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  669</span>          partScales[ndxPair] = part.scale;</div>
<div class="line"><span class="lineno">  670</span>      }</div>
<div class="line"><span class="lineno">  671</span> </div>
<div class="line"><span class="lineno">  672</span>      <span class="keywordflow">if</span> (values.toplayer_val == ParticlesFx::TOP_SMALLER ||</div>
<div class="line"><span class="lineno">  673</span>          values.toplayer_val == ParticlesFx::TOP_BIGGER)</div>
<div class="line"><span class="lineno">  674</span>        myParticles.sort(<a class="code hl_class" href="class_compareby_size.html">ComparebySize</a>());</div>
<div class="line"><span class="lineno">  675</span> </div>
<div class="line"><span class="lineno">  676</span>      <span class="keywordflow">if</span> (values.toplayer_val == ParticlesFx::TOP_SMALLER) {</div>
<div class="line"><span class="lineno">  677</span>        std::list&lt;Particle&gt;::iterator pt;</div>
<div class="line"><span class="lineno">  678</span>        <span class="keywordflow">for</span> (pt = myParticles.begin(); pt != myParticles.end(); ++pt) {</div>
<div class="line"><span class="lineno">  679</span>          <a class="code hl_class" href="class_particle.html">Particle</a> &amp;part = *pt;</div>
<div class="line"><span class="lineno">  680</span>          <span class="keywordflow">if</span> (dist_frame &lt;= part.trail &amp;&amp; part.scale &amp;&amp; part.lifetime &gt; 0 &amp;&amp;</div>
<div class="line"><span class="lineno">  681</span>              part.lifetime &lt;=</div>
<div class="line"><span class="lineno">  682</span>                  part.genlifetime)  <span class="comment">// This last... shouldn&#39;t always be?</span></div>
<div class="line"><span class="lineno">  683</span>          {</div>
<div class="line"><span class="lineno">  684</span>            do_render(&amp;part, tile, part_ports, porttiles, ri, p_size, p_offset,</div>
<div class="line"><span class="lineno">  685</span>                      last_frame[part.level], partLevel, values, opacity_range,</div>
<div class="line"><span class="lineno">  686</span>                      dist_frame, partScales);</div>
<div class="line"><span class="lineno">  687</span>          }</div>
<div class="line"><span class="lineno">  688</span>        }</div>
<div class="line"><span class="lineno">  689</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  690</span>        std::list&lt;Particle&gt;::reverse_iterator pt;</div>
<div class="line"><span class="lineno">  691</span>        <span class="keywordflow">for</span> (pt = myParticles.rbegin(); pt != myParticles.rend(); ++pt) {</div>
<div class="line"><span class="lineno">  692</span>          <a class="code hl_class" href="class_particle.html">Particle</a> &amp;part = *pt;</div>
<div class="line"><span class="lineno">  693</span>          <span class="keywordflow">if</span> (dist_frame &lt;= part.trail &amp;&amp; part.scale &amp;&amp; part.lifetime &gt; 0 &amp;&amp;</div>
<div class="line"><span class="lineno">  694</span>              part.lifetime &lt;= part.genlifetime)  <span class="comment">// Same here..?</span></div>
<div class="line"><span class="lineno">  695</span>          {</div>
<div class="line"><span class="lineno">  696</span>            do_render(&amp;part, tile, part_ports, porttiles, ri, p_size, p_offset,</div>
<div class="line"><span class="lineno">  697</span>                      last_frame[part.level], partLevel, values, opacity_range,</div>
<div class="line"><span class="lineno">  698</span>                      dist_frame, partScales);</div>
<div class="line"><span class="lineno">  699</span>          }</div>
<div class="line"><span class="lineno">  700</span>        }</div>
<div class="line"><span class="lineno">  701</span>      }</div>
<div class="line"><span class="lineno">  702</span>    }</div>
<div class="line"><span class="lineno">  703</span> </div>
<div class="line"><span class="lineno">  704</span>    std::map&lt;int, TTile *&gt;::iterator it;</div>
<div class="line"><span class="lineno">  705</span>    <span class="keywordflow">for</span> (it = porttiles.begin(); it != porttiles.end(); ++it) <span class="keyword">delete</span> it-&gt;second;</div>
<div class="line"><span class="lineno">  706</span>  }</div>
<div class="line"><span class="lineno">  707</span>}</div>
<div class="ttc" id="aclass_compareby_size_html"><div class="ttname"><a href="class_compareby_size.html">ComparebySize</a></div><div class="ttdef"><b>Definition:</b> particles.h:221</div></div>
<div class="ttc" id="aclass_particle_html"><div class="ttname"><a href="class_particle.html">Particle</a></div><div class="ttdef"><b>Definition:</b> particles.h:132</div></div>
<div class="ttc" id="aclass_particles_manager_html"><div class="ttname"><a href="class_particles_manager.html">ParticlesManager</a></div><div class="ttdef"><b>Definition:</b> particlesmanager.h:22</div></div>
<div class="ttc" id="aclass_t_affine_html_a570529b96b1ec5abc711aaa9aac09ff9"><div class="ttname"><a href="class_t_affine.html#a570529b96b1ec5abc711aaa9aac09ff9">TAffine::inv</a></div><div class="ttdeci">TAffine inv() const</div><div class="ttdef"><b>Definition:</b> tgeometry.cpp:55</div></div>
<div class="ttc" id="aclass_t_rect_t_html_a53ce09c6112f8a019b43ad82d721a93b"><div class="ttname"><a href="class_t_rect_t.html#a53ce09c6112f8a019b43ad82d721a93b">TRectT::isEmpty</a></div><div class="ttdeci">bool isEmpty() const</div></div>
<div class="ttc" id="aclass_t_renderer_html"><div class="ttname"><a href="class_t_renderer.html">TRenderer</a></div><div class="ttdef"><b>Definition:</b> trenderer.h:175</div></div>
<div class="ttc" id="aclass_t_renderer_html_a93afee3c1ce8ff2b753a05fa0fe3dc9d"><div class="ttname"><a href="class_t_renderer.html#a93afee3c1ce8ff2b753a05fa0fe3dc9d">TRenderer::instance</a></div><div class="ttdeci">static TRenderer instance()</div><div class="ttdef"><b>Definition:</b> trenderer.cpp:470</div></div>
<div class="ttc" id="astruct_particles_manager_1_1_frame_data_html"><div class="ttname"><a href="struct_particles_manager_1_1_frame_data.html">ParticlesManager::FrameData</a></div><div class="ttdef"><b>Definition:</b> particlesmanager.h:28</div></div>
<div class="ttc" id="astructparticles__values_html"><div class="ttname"><a href="structparticles__values.html">particles_values</a></div><div class="ttdef"><b>Definition:</b> iwa_particles.h:19</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a09e5db1ac2446bbcde754102a3030bd2" name="a09e5db1ac2446bbcde754102a3030bd2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a09e5db1ac2446bbcde754102a3030bd2">&#9670;&nbsp;</a></span>roll_particles()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Particles_Engine::roll_particles </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_tile.html">TTile</a> *&#160;</td>
          <td class="paramname"><em>tile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::map&lt; int, <a class="el" href="class_t_tile.html">TTile</a> * &gt;&#160;</td>
          <td class="paramname"><em>porttiles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="class_t_render_settings.html">TRenderSettings</a> &amp;&#160;</td>
          <td class="paramname"><em>ri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::list&lt; <a class="el" href="class_particle.html">Particle</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>myParticles</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparticles__values.html">particles_values</a> &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>cx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>cy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>curr_frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>level_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&#160;</td>
          <td class="paramname"><em>random_level</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>dpi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; int &gt;&#160;</td>
          <td class="paramname"><em>lastframe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int &amp;&#160;</td>
          <td class="paramname"><em>totalparticles</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  194</span>                                                              {</div>
<div class="line"><span class="lineno">  195</span>  <a class="code hl_struct" href="structparticles__ranges.html">particles_ranges</a> ranges;</div>
<div class="line"><span class="lineno">  196</span>  <span class="keywordtype">int</span> i, newparticles;</div>
<div class="line"><span class="lineno">  197</span>  <span class="keywordtype">float</span> xgravity, ygravity, windx, windy;</div>
<div class="line"><span class="lineno">  198</span>  <span class="comment">/*-- 風の強さ／重力の強さをX,Y成分に分ける --*/</span></div>
<div class="line"><span class="lineno">  199</span>  windx    = values.windint_val * sin(values.windangle_val);</div>
<div class="line"><span class="lineno">  200</span>  windy    = values.windint_val * cos(values.windangle_val);</div>
<div class="line"><span class="lineno">  201</span>  xgravity = values.gravity_val * sin(values.g_angle_val);</div>
<div class="line"><span class="lineno">  202</span>  ygravity = values.gravity_val * cos(values.g_angle_val);</div>
<div class="line"><span class="lineno">  203</span> </div>
<div class="line"><span class="lineno">  204</span>  fill_range_struct(values, ranges);</div>
<div class="line"><span class="lineno">  205</span> </div>
<div class="line"><span class="lineno">  206</span>  std::vector&lt;std::vector&lt;TPointD&gt;&gt; myregions;</div>
<div class="line"><span class="lineno">  207</span> </div>
<div class="line"><span class="lineno">  208</span>  <span class="comment">/*-- [1〜255]</span></div>
<div class="line"><span class="lineno">  209</span><span class="comment">   * そのIndexに対応するアルファ値を持つピクセルのインデックス値を保存。 [0]</span></div>
<div class="line"><span class="lineno">  210</span><span class="comment">   * 使用せず --*/</span></div>
<div class="line"><span class="lineno">  211</span>  std::vector&lt;std::vector&lt;int&gt;&gt; myHistogram;</div>
<div class="line"><span class="lineno">  212</span>  <span class="comment">/*--</span></div>
<div class="line"><span class="lineno">  213</span><span class="comment">   * アルファ値255から下がっていき、ピクセル数×重み又はアルファ値を次々足した値を格納</span></div>
<div class="line"><span class="lineno">  214</span><span class="comment">   * --*/</span></div>
<div class="line"><span class="lineno">  215</span>  std::vector&lt;float&gt; myWeight;</div>
<div class="line"><span class="lineno">  216</span> </div>
<div class="line"><span class="lineno">  217</span>  std::map&lt;int, TTile *&gt;::iterator it = porttiles.find(values.source_ctrl_val);</div>
<div class="line"><span class="lineno">  218</span>  <span class="comment">/*-- Perspective</span></div>
<div class="line"><span class="lineno">  219</span><span class="comment">   * DistributionがONのとき、Sizeに刺さったControlImageが粒子の発生分布を決める</span></div>
<div class="line"><span class="lineno">  220</span><span class="comment">   * --*/</span></div>
<div class="line"><span class="lineno">  221</span>  std::map&lt;int, TTile *&gt;::iterator sizeIt =</div>
<div class="line"><span class="lineno">  222</span>      porttiles.find(values.scale_ctrl_val);</div>
<div class="line"><span class="lineno">  223</span>  <span class="keywordflow">if</span> (values.perspective_distribution_val &amp;&amp; (sizeIt != porttiles.end())) {</div>
<div class="line"><span class="lineno">  224</span>    <span class="comment">/*-- ソース画像にコントロールが付いていた場合、そのアルファ値をマスクに使う</span></div>
<div class="line"><span class="lineno">  225</span><span class="comment">     * --*/</span></div>
<div class="line"><span class="lineno">  226</span>    <span class="keywordflow">if</span> (values.source_ctrl_val &amp;&amp; (it != porttiles.end()))</div>
<div class="line"><span class="lineno">  227</span>      fill_regions_with_size_map(myregions, myHistogram, sizeIt-&gt;second,</div>
<div class="line"><span class="lineno">  228</span>                                 it-&gt;second, values.bright_thres_val);</div>
<div class="line"><span class="lineno">  229</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  230</span>      fill_regions_with_size_map(myregions, myHistogram, sizeIt-&gt;second, 0,</div>
<div class="line"><span class="lineno">  231</span>                                 values.bright_thres_val);</div>
<div class="line"><span class="lineno">  232</span>    <span class="comment">/*- パーティクルを作る前に myregion内の候補数を合計する--*/</span></div>
<div class="line"><span class="lineno">  233</span>    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)myHistogram.size() == 256) {</div>
<div class="line"><span class="lineno">  234</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 255; m &gt;= 0; m--) {</div>
<div class="line"><span class="lineno">  235</span>        <span class="comment">/*-- 明度からサイズ サイズから重みを出す --*/</span></div>
<div class="line"><span class="lineno">  236</span>        <span class="keywordtype">float</span> scale =</div>
<div class="line"><span class="lineno">  237</span>            values.scale_val.first + ranges.scale_range * (float)m / 255.0f;</div>
<div class="line"><span class="lineno">  238</span>        <span class="keywordtype">float</span> weight = 1.0f / (scale * scale);</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span>        <span class="keywordtype">float</span> tmpSum = weight * (float)myHistogram[m].size();</div>
<div class="line"><span class="lineno">  241</span>        <span class="keywordtype">int</span> index    = 255 - m;</div>
<div class="line"><span class="lineno">  242</span>        <span class="keywordflow">if</span> (index &gt; 0) <span class="comment">/*-- これまでの合計に追加する --*/</span></div>
<div class="line"><span class="lineno">  243</span>          tmpSum += myWeight[index - 1];</div>
<div class="line"><span class="lineno">  244</span>        myWeight.push_back(tmpSum);</div>
<div class="line"><span class="lineno">  245</span>      }</div>
<div class="line"><span class="lineno">  246</span>    }</div>
<div class="line"><span class="lineno">  247</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  248</span>    <span class="comment">/*- ソース画像にコントロールが付いていた場合 -*/</span></div>
<div class="line"><span class="lineno">  249</span>    <span class="keywordflow">if</span> (values.source_ctrl_val &amp;&amp; (it != porttiles.end()))</div>
<div class="line"><span class="lineno">  250</span>      <span class="comment">/*-- 入力画像のアルファ値に比例して発生濃度を変える --*/</span></div>
<div class="line"><span class="lineno">  251</span>      fill_regions(1, myregions, it-&gt;second, values.multi_source_val,</div>
<div class="line"><span class="lineno">  252</span>                   values.bright_thres_val, values.source_gradation_val,</div>
<div class="line"><span class="lineno">  253</span>                   myHistogram);</div>
<div class="line"><span class="lineno">  254</span> </div>
<div class="line"><span class="lineno">  255</span>    <span class="comment">/*- パーティクルを作る前に myregion内の候補数を合計する--*/</span></div>
<div class="line"><span class="lineno">  256</span>    <span class="comment">/*-- myWeight</span></div>
<div class="line"><span class="lineno">  257</span><span class="comment">     * の中には、アルファ255から0まで、各アルファ値×ポイント数を足しこんでいったものが格納される。--*/</span></div>
<div class="line"><span class="lineno">  258</span>    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)myHistogram.size() == 256) {</div>
<div class="line"><span class="lineno">  259</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 255; m &gt; 0; m--) {</div>
<div class="line"><span class="lineno">  260</span>        <span class="keywordtype">float</span> tmpSum = (float)(m * (<span class="keywordtype">int</span>)myHistogram[m].size());</div>
<div class="line"><span class="lineno">  261</span>        <span class="keywordtype">int</span> index    = 255 - m;</div>
<div class="line"><span class="lineno">  262</span>        <span class="keywordflow">if</span> (index &gt; 0) tmpSum += myWeight[index - 1];</div>
<div class="line"><span class="lineno">  263</span>        myWeight.push_back(tmpSum);</div>
<div class="line"><span class="lineno">  264</span>      }</div>
<div class="line"><span class="lineno">  265</span>    }</div>
<div class="line"><span class="lineno">  266</span>  }</div>
<div class="line"><span class="lineno">  267</span> </div>
<div class="line"><span class="lineno">  268</span>  <span class="comment">/*- birth rate を格納 -*/</span></div>
<div class="line"><span class="lineno">  269</span>  newparticles = (int)values.maxnum_val;</div>
<div class="line"><span class="lineno">  270</span>  if (myParticles.empty() &amp;&amp; newparticles)  <span class="comment">// Initial creation</span></div>
<div class="line"><span class="lineno">  271</span>  {</div>
<div class="line"><span class="lineno">  272</span>    <span class="comment">/*- 新たに作るパーティクルの数だけ繰り返す -*/</span></div>
<div class="line"><span class="lineno">  273</span>    <span class="keywordflow">for</span> (i = 0; i &lt; newparticles; i++) {</div>
<div class="line"><span class="lineno">  274</span>      <span class="keywordtype">int</span> seed  = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  275</span>                       values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  276</span>      <span class="keywordtype">int</span> level = (int)(values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * level_n);</div>
<div class="line"><span class="lineno">  277</span> </div>
<div class="line"><span class="lineno">  278</span>      <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  279</span>      <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  280</span>        lifetime = lastframe[level];</div>
<div class="line"><span class="lineno">  281</span>      <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  282</span>        lifetime = (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  283</span>                         ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  284</span>      <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame)</div>
<div class="line"><span class="lineno">  285</span>        myParticles.push_back(<a class="code hl_class" href="class_particle.html">Particle</a>(</div>
<div class="line"><span class="lineno">  286</span>            lifetime, seed, porttiles, values, ranges, myregions,</div>
<div class="line"><span class="lineno">  287</span>            totalparticles, 0, level, lastframe[level], myHistogram, myWeight));</div>
<div class="line"><span class="lineno">  288</span> </div>
<div class="line"><span class="lineno">  289</span>      totalparticles++;</div>
<div class="line"><span class="lineno">  290</span>    }</div>
<div class="line"><span class="lineno">  291</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  292</span>    std::list&lt;Particle&gt;::iterator it;</div>
<div class="line"><span class="lineno">  293</span>    <span class="keywordflow">for</span> (it = myParticles.begin(); it != myParticles.end();) {</div>
<div class="line"><span class="lineno">  294</span>      std::list&lt;Particle&gt;::iterator current = it;</div>
<div class="line"><span class="lineno">  295</span>      ++it;</div>
<div class="line"><span class="lineno">  296</span> </div>
<div class="line"><span class="lineno">  297</span>      <a class="code hl_class" href="class_particle.html">Particle</a> &amp;part = (*current);</div>
<div class="line"><span class="lineno">  298</span>      <span class="keywordflow">if</span> (part.lifetime &lt;= 0)        <span class="comment">// Note: This is in line with the above</span></div>
<div class="line"><span class="lineno">  299</span>                                     <span class="comment">// &quot;lifetime&gt;curr_frame-frame&quot;</span></div>
<div class="line"><span class="lineno">  300</span>        myParticles.erase(current);  <span class="comment">// insertion counterpart</span></div>
<div class="line"><span class="lineno">  301</span>      <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  302</span>        part.move(porttiles, values, ranges, windx, windy, xgravity, ygravity,</div>
<div class="line"><span class="lineno">  303</span>                  dpi, lastframe[part.level]);</div>
<div class="line"><span class="lineno">  304</span>    }</div>
<div class="line"><span class="lineno">  305</span> </div>
<div class="line"><span class="lineno">  306</span>    <span class="keywordtype">int</span> oldparticles = myParticles.size();</div>
<div class="line"><span class="lineno">  307</span>    <span class="keywordflow">switch</span> (values.toplayer_val) {</div>
<div class="line"><span class="lineno">  308</span>    <span class="keywordflow">case</span> ParticlesFx::TOP_YOUNGER:</div>
<div class="line"><span class="lineno">  309</span>      <span class="keywordflow">for</span> (i = 0; i &lt; newparticles; i++) {</div>
<div class="line"><span class="lineno">  310</span>        <span class="keywordtype">int</span> seed  = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  311</span>                         values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  312</span>        <span class="keywordtype">int</span> level = (int)(values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * level_n);</div>
<div class="line"><span class="lineno">  313</span> </div>
<div class="line"><span class="lineno">  314</span>        <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  315</span>        <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  316</span>          lifetime = lastframe[level];</div>
<div class="line"><span class="lineno">  317</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  318</span>          lifetime =</div>
<div class="line"><span class="lineno">  319</span>              (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  320</span>                    ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  321</span> </div>
<div class="line"><span class="lineno">  322</span>        <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame)</div>
<div class="line"><span class="lineno">  323</span>          myParticles.push_front(<a class="code hl_class" href="class_particle.html">Particle</a>(lifetime, seed, porttiles, values,</div>
<div class="line"><span class="lineno">  324</span>                                          ranges, myregions, totalparticles, 0,</div>
<div class="line"><span class="lineno">  325</span>                                          level, lastframe[level], myHistogram,</div>
<div class="line"><span class="lineno">  326</span>                                          myWeight));</div>
<div class="line"><span class="lineno">  327</span> </div>
<div class="line"><span class="lineno">  328</span>        totalparticles++;</div>
<div class="line"><span class="lineno">  329</span>      }</div>
<div class="line"><span class="lineno">  330</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  331</span> </div>
<div class="line"><span class="lineno">  332</span>    <span class="keywordflow">case</span> ParticlesFx::TOP_RANDOM:</div>
<div class="line"><span class="lineno">  333</span>      <span class="keywordflow">for</span> (i = 0; i &lt; newparticles; i++) {</div>
<div class="line"><span class="lineno">  334</span>        <span class="keywordtype">double</span> tmp = values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * myParticles.size();</div>
<div class="line"><span class="lineno">  335</span>        std::list&lt;Particle&gt;::iterator it = myParticles.begin();</div>
<div class="line"><span class="lineno">  336</span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; tmp; j++, it++)</div>
<div class="line"><span class="lineno">  337</span>          ;</div>
<div class="line"><span class="lineno">  338</span>        {</div>
<div class="line"><span class="lineno">  339</span>          <span class="keywordtype">int</span> seed     = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  340</span>                           values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  341</span>          <span class="keywordtype">int</span> level    = (int)(values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * level_n);</div>
<div class="line"><span class="lineno">  342</span>          <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  343</span> </div>
<div class="line"><span class="lineno">  344</span>          <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  345</span>            lifetime = lastframe[level];</div>
<div class="line"><span class="lineno">  346</span>          <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  347</span>            lifetime =</div>
<div class="line"><span class="lineno">  348</span>                (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  349</span>                      ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  350</span>          <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame)</div>
<div class="line"><span class="lineno">  351</span>            myParticles.insert(</div>
<div class="line"><span class="lineno">  352</span>                it, <a class="code hl_class" href="class_particle.html">Particle</a>(lifetime, seed, porttiles, values, ranges,</div>
<div class="line"><span class="lineno">  353</span>                             myregions, totalparticles, 0, level,</div>
<div class="line"><span class="lineno">  354</span>                             lastframe[level], myHistogram, myWeight));</div>
<div class="line"><span class="lineno">  355</span> </div>
<div class="line"><span class="lineno">  356</span>          totalparticles++;</div>
<div class="line"><span class="lineno">  357</span>        }</div>
<div class="line"><span class="lineno">  358</span>      }</div>
<div class="line"><span class="lineno">  359</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  360</span> </div>
<div class="line"><span class="lineno">  361</span>    <span class="keywordflow">default</span>:</div>
<div class="line"><span class="lineno">  362</span>      <span class="keywordflow">for</span> (i = 0; i &lt; newparticles; i++) {</div>
<div class="line"><span class="lineno">  363</span>        <span class="keywordtype">int</span> seed     = (int)((std::numeric_limits&lt;int&gt;::max)() *</div>
<div class="line"><span class="lineno">  364</span>                         values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  365</span>        <span class="keywordtype">int</span> level    = (int)(values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>() * level_n);</div>
<div class="line"><span class="lineno">  366</span>        <span class="keywordtype">int</span> lifetime = 0;</div>
<div class="line"><span class="lineno">  367</span> </div>
<div class="line"><span class="lineno">  368</span>        <span class="keywordflow">if</span> (values.column_lifetime_val)</div>
<div class="line"><span class="lineno">  369</span>          lifetime = lastframe[level];</div>
<div class="line"><span class="lineno">  370</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  371</span>          lifetime =</div>
<div class="line"><span class="lineno">  372</span>              (int)(values.lifetime_val.first +</div>
<div class="line"><span class="lineno">  373</span>                    ranges.lifetime_range * values.random_val-&gt;<a class="code hl_function" href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">getFloat</a>());</div>
<div class="line"><span class="lineno">  374</span>        <span class="keywordflow">if</span> (lifetime &gt; curr_frame - frame)</div>
<div class="line"><span class="lineno">  375</span>          myParticles.push_back(<a class="code hl_class" href="class_particle.html">Particle</a>(lifetime, seed, porttiles, values,</div>
<div class="line"><span class="lineno">  376</span>                                         ranges, myregions, totalparticles, 0,</div>
<div class="line"><span class="lineno">  377</span>                                         level, lastframe[level], myHistogram,</div>
<div class="line"><span class="lineno">  378</span>                                         myWeight));</div>
<div class="line"><span class="lineno">  379</span> </div>
<div class="line"><span class="lineno">  380</span>        totalparticles++;</div>
<div class="line"><span class="lineno">  381</span>      }</div>
<div class="line"><span class="lineno">  382</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  383</span>    }</div>
<div class="line"><span class="lineno">  384</span>  }</div>
<div class="line"><span class="lineno">  385</span>}</div>
<div class="ttc" id="aclass_t_random_html_a3a7f6b3a8992fcde5b0c5e8bd2049e41"><div class="ttname"><a href="class_t_random.html#a3a7f6b3a8992fcde5b0c5e8bd2049e41">TRandom::getFloat</a></div><div class="ttdeci">float getFloat()</div><div class="ttdef"><b>Definition:</b> trandom.cpp:100</div></div>
<div class="ttc" id="astructparticles__ranges_html"><div class="ttname"><a href="structparticles__ranges.html">particles_ranges</a></div><div class="ttdef"><b>Definition:</b> iwa_particles.h:127</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="afeaa4f1b12435855c7a7f662fdbf0d1e" name="afeaa4f1b12435855c7a7f662fdbf0d1e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afeaa4f1b12435855c7a7f662fdbf0d1e">&#9670;&nbsp;</a></span>m_frame</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double Particles_Engine::m_frame</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a4d9ac86983ecdde346bf1f865aec8d5f" name="a4d9ac86983ecdde346bf1f865aec8d5f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4d9ac86983ecdde346bf1f865aec8d5f">&#9670;&nbsp;</a></span>m_parent</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_particles_fx.html">ParticlesFx</a>* Particles_Engine::m_parent</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>E:/opentoonz/toonz/sources/stdfx/<a class="el" href="">particlesengine.h</a></li>
<li>E:/opentoonz/toonz/sources/stdfx/<a class="el" href="">particlesengine.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
