<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>opentoonz: Jacobian Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">opentoonz
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-types">Public Types</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="class_jacobian-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">Jacobian Class Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-types" name="pub-types"></a>
Public Types</h2></td></tr>
<tr class="memitem:af013b8875251778c3eb016d229ee1f1e"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><b>UpdateMode</b> { <br />
&#160;&#160;<b>JACOB_Undefined</b> = 0
, <b>JACOB_JacobianTranspose</b> = 1
, <b>JACOB_PseudoInverse</b> = 2
, <b>JACOB_DLS</b> = 3
, <br />
&#160;&#160;<b>JACOB_SDLS</b> = 4
<br />
 }</td></tr>
<tr class="separator:af013b8875251778c3eb016d229ee1f1e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a4714b21bd15b45df4499143a8f7dd746"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a4714b21bd15b45df4499143a8f7dd746">Jacobian</a> (<a class="el" href="class_i_k_skeleton.html">IKSkeleton</a> *skeleton, std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &amp;target)</td></tr>
<tr class="separator:a4714b21bd15b45df4499143a8f7dd746"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa661382ab1057f0663a40d1d73127ad8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#aa661382ab1057f0663a40d1d73127ad8">computeJacobian</a> ()</td></tr>
<tr class="separator:aa661382ab1057f0663a40d1d73127ad8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e8a8e9abdcc9dfd6e47c13f533eb125"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a4e8a8e9abdcc9dfd6e47c13f533eb125">addTarget</a> (<a class="el" href="class_t_point_t.html">TPointD</a> targetPos)</td></tr>
<tr class="separator:a4e8a8e9abdcc9dfd6e47c13f533eb125"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a93f20df15d29f76884323ac738efd3d4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a93f20df15d29f76884323ac738efd3d4">deletLastTarget</a> ()</td></tr>
<tr class="separator:a93f20df15d29f76884323ac738efd3d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24eeaefbe56036da7af4a77e66f7891c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a24eeaefbe56036da7af4a77e66f7891c">setTarget</a> (int i, <a class="el" href="class_t_point_t.html">TPointD</a> targetPos)</td></tr>
<tr class="separator:a24eeaefbe56036da7af4a77e66f7891c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa7e8f89f2e5da915147a31590c3364cf"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#aa7e8f89f2e5da915147a31590c3364cf">ZeroDeltaThetas</a> ()</td></tr>
<tr class="separator:aa7e8f89f2e5da915147a31590c3364cf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0bb9b42c4eea995050f0c835aaeabcd1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a0bb9b42c4eea995050f0c835aaeabcd1">CalcDeltaThetasTranspose</a> ()</td></tr>
<tr class="separator:a0bb9b42c4eea995050f0c835aaeabcd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9bd2e44047605346ffd5987c43fe211"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#ad9bd2e44047605346ffd5987c43fe211">CalcDeltaThetasPseudoinverse</a> ()</td></tr>
<tr class="separator:ad9bd2e44047605346ffd5987c43fe211"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad3ad85d7621c0bb7f986a4b89cb5872d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#ad3ad85d7621c0bb7f986a4b89cb5872d">CalcDeltaThetasDLS</a> ()</td></tr>
<tr class="separator:ad3ad85d7621c0bb7f986a4b89cb5872d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad56901602ef95216b0c294b8e619d2a2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#ad56901602ef95216b0c294b8e619d2a2">CalcDeltaThetasDLSwithSVD</a> ()</td></tr>
<tr class="separator:ad56901602ef95216b0c294b8e619d2a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad4a0f0bf23ec7caaacd33181248a4762"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#ad4a0f0bf23ec7caaacd33181248a4762">CalcDeltaThetasSDLS</a> ()</td></tr>
<tr class="separator:ad4a0f0bf23ec7caaacd33181248a4762"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abb9b64db63ca485a053724d9b251a4dc"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#abb9b64db63ca485a053724d9b251a4dc">UpdateThetas</a> ()</td></tr>
<tr class="separator:abb9b64db63ca485a053724d9b251a4dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeabf2c921517d3f7f313701399e95b59"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#aeabf2c921517d3f7f313701399e95b59">checkJointsLimit</a> ()</td></tr>
<tr class="separator:aeabf2c921517d3f7f313701399e95b59"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a30a78448bc6bfa73d9c06a149bb9ff9e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a30a78448bc6bfa73d9c06a149bb9ff9e">UpdatedSClampValue</a> ()</td></tr>
<tr class="separator:a30a78448bc6bfa73d9c06a149bb9ff9e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c192ad28dcbcb7b8853872a112e4605"><td class="memItemLeft" align="right" valign="top"><a id="a8c192ad28dcbcb7b8853872a112e4605" name="a8c192ad28dcbcb7b8853872a112e4605"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>DrawEigenVectors</b> () const</td></tr>
<tr class="separator:a8c192ad28dcbcb7b8853872a112e4605"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61c48f4ac57b20c0b007dde2d8f6038c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a61c48f4ac57b20c0b007dde2d8f6038c">SetCurrentMode</a> (UpdateMode mode)</td></tr>
<tr class="separator:a61c48f4ac57b20c0b007dde2d8f6038c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a2be3c1b9bdfca91fd0c6bbdb152558"><td class="memItemLeft" align="right" valign="top">UpdateMode&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a5a2be3c1b9bdfca91fd0c6bbdb152558">GetCurrentMode</a> () const</td></tr>
<tr class="separator:a5a2be3c1b9bdfca91fd0c6bbdb152558"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad8fb54d90eb0fe47b0a1818f6818288f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#ad8fb54d90eb0fe47b0a1818f6818288f">SetDampingDLS</a> (double lambda)</td></tr>
<tr class="separator:ad8fb54d90eb0fe47b0a1818f6818288f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a63640e5c70a253f167e235ccbdaec132"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_jacobian.html#a63640e5c70a253f167e235ccbdaec132">Reset</a> ()</td></tr>
<tr class="separator:a63640e5c70a253f167e235ccbdaec132"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"></div><h2 class="groupheader">Member Enumeration Documentation</h2>
<a id="af013b8875251778c3eb016d229ee1f1e" name="af013b8875251778c3eb016d229ee1f1e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af013b8875251778c3eb016d229ee1f1e">&#9670;&nbsp;</a></span>UpdateMode</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum Jacobian::UpdateMode</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  639</span>                  {</div>
<div class="line"><span class="lineno">  640</span>    JACOB_Undefined         = 0,</div>
<div class="line"><span class="lineno">  641</span>    JACOB_JacobianTranspose = 1,</div>
<div class="line"><span class="lineno">  642</span>    JACOB_PseudoInverse     = 2,</div>
<div class="line"><span class="lineno">  643</span>    JACOB_DLS               = 3,</div>
<div class="line"><span class="lineno">  644</span>    JACOB_SDLS              = 4</div>
<div class="line"><span class="lineno">  645</span>  };</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a4714b21bd15b45df4499143a8f7dd746" name="a4714b21bd15b45df4499143a8f7dd746"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4714b21bd15b45df4499143a8f7dd746">&#9670;&nbsp;</a></span>Jacobian()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Jacobian::Jacobian </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_i_k_skeleton.html">IKSkeleton</a> *&#160;</td>
          <td class="paramname"><em>skeleton</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="class_t_point_t.html">TPointD</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>target</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1065</span>                                                                      {</div>
<div class="line"><span class="lineno"> 1066</span>  Jacobian::skeleton = skeleton;</div>
<div class="line"><span class="lineno"> 1067</span>  nEffector          = skeleton-&gt;getNumEffector();</div>
<div class="line"><span class="lineno"> 1068</span>  nJoint             = skeleton-&gt;getNodeCount() -</div>
<div class="line"><span class="lineno"> 1069</span>           nEffector;  <span class="comment">// numero dei giunti meno gli effettori</span></div>
<div class="line"><span class="lineno"> 1070</span>  nRow = 2 * nEffector;</div>
<div class="line"><span class="lineno"> 1071</span>  nCol = nJoint;</div>
<div class="line"><span class="lineno"> 1072</span> </div>
<div class="line"><span class="lineno"> 1073</span>  target = (targetPos);</div>
<div class="line"><span class="lineno"> 1074</span> </div>
<div class="line"><span class="lineno"> 1075</span>  Jend.SetSize(nRow, nCol);  <span class="comment">// Matrice jacobiana</span></div>
<div class="line"><span class="lineno"> 1076</span>  Jend.SetZero();</div>
<div class="line"><span class="lineno"> 1077</span> </div>
<div class="line"><span class="lineno"> 1078</span>  Jtarget.SetSize(</div>
<div class="line"><span class="lineno"> 1079</span>      nRow,</div>
<div class="line"><span class="lineno"> 1080</span>      nCol);  <span class="comment">// Matrice jacobiana basta sulle posizioni dei targets (non usata)</span></div>
<div class="line"><span class="lineno"> 1081</span>  Jtarget.SetZero();</div>
<div class="line"><span class="lineno"> 1082</span> </div>
<div class="line"><span class="lineno"> 1083</span>  U.SetSize(nRow, nRow);  <span class="comment">// matrice U per il calcolo SVD</span></div>
<div class="line"><span class="lineno"> 1084</span>  w.SetLength(min(nRow, nCol));</div>
<div class="line"><span class="lineno"> 1085</span>  V.SetSize(nCol, nCol);  <span class="comment">// matrice V per il calcolo SVD</span></div>
<div class="line"><span class="lineno"> 1086</span> </div>
<div class="line"><span class="lineno"> 1087</span>  dS.SetLength(nRow);      <span class="comment">// (Posizione Target ) - (posizione End effector)</span></div>
<div class="line"><span class="lineno"> 1088</span>  dTheta.SetLength(nCol);  <span class="comment">// Cambiamenti degli angoli dei Joints</span></div>
<div class="line"><span class="lineno"> 1089</span>  dPreTheta.SetLength(nCol);</div>
<div class="line"><span class="lineno"> 1090</span> </div>
<div class="line"><span class="lineno"> 1091</span>  <span class="comment">// Usato nel: metodo del trasposto dello Jacobiano  &amp; DLS &amp; SDLS</span></div>
<div class="line"><span class="lineno"> 1092</span>  dT.SetLength(nRow);</div>
<div class="line"><span class="lineno"> 1093</span> </div>
<div class="line"><span class="lineno"> 1094</span>  <span class="comment">// Usato nel Selectively Damped Least Squares Method</span></div>
<div class="line"><span class="lineno"> 1095</span>  dSclamp.SetLength(nEffector);</div>
<div class="line"><span class="lineno"> 1096</span> </div>
<div class="line"><span class="lineno"> 1097</span>  Jnorms.SetSize(nEffector, nCol);  <span class="comment">// Memorizza le norme della matrice attiva J</span></div>
<div class="line"><span class="lineno"> 1098</span> </div>
<div class="line"><span class="lineno"> 1099</span>  DampingLambdaSqV.SetLength(nRow);</div>
<div class="line"><span class="lineno"> 1100</span>  diagMatIdentity.SetLength(nCol);</div>
<div class="line"><span class="lineno"> 1101</span> </div>
<div class="line"><span class="lineno"> 1102</span>  Reset();</div>
<div class="line"><span class="lineno"> 1103</span>}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a4e8a8e9abdcc9dfd6e47c13f533eb125" name="a4e8a8e9abdcc9dfd6e47c13f533eb125"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4e8a8e9abdcc9dfd6e47c13f533eb125">&#9670;&nbsp;</a></span>addTarget()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::addTarget </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a>&#160;</td>
          <td class="paramname"><em>targetPos</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  654</span>{ target.push_back(targetPos); }</div>
</div><!-- fragment -->
</div>
</div>
<a id="ad3ad85d7621c0bb7f986a4b89cb5872d" name="ad3ad85d7621c0bb7f986a4b89cb5872d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad3ad85d7621c0bb7f986a4b89cb5872d">&#9670;&nbsp;</a></span>CalcDeltaThetasDLS()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::CalcDeltaThetasDLS </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1416</span>                                  {</div>
<div class="line"><span class="lineno"> 1417</span>  <span class="keyword">const</span> <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> &amp;J = Jend;</div>
<div class="line"><span class="lineno"> 1418</span> </div>
<div class="line"><span class="lineno"> 1419</span>  MatrixRmn::MultiplyTranspose(J, J, U);  <span class="comment">// U = J * (J^T)</span></div>
<div class="line"><span class="lineno"> 1420</span> </div>
<div class="line"><span class="lineno"> 1421</span>  U.AddToDiagonal(DampingLambdaSqV);</div>
<div class="line"><span class="lineno"> 1422</span> </div>
<div class="line"><span class="lineno"> 1423</span>  <span class="comment">// Use the next four lines instead of the succeeding two lines for the DLS</span></div>
<div class="line"><span class="lineno"> 1424</span>  <span class="comment">// method with clamped error vector e.</span></div>
<div class="line"><span class="lineno"> 1425</span>  <span class="comment">// CalcdTClampedFromdS();</span></div>
<div class="line"><span class="lineno"> 1426</span>  <span class="comment">// VectorRn dTextra(2*nEffector);</span></div>
<div class="line"><span class="lineno"> 1427</span>  <span class="comment">// U.Solve( dT, &amp;dTextra );</span></div>
<div class="line"><span class="lineno"> 1428</span>  <span class="comment">// J.MultiplyTranspose( dTextra, dTheta );</span></div>
<div class="line"><span class="lineno"> 1429</span> </div>
<div class="line"><span class="lineno"> 1430</span>  <span class="comment">// Use these two lines for the traditional DLS method</span></div>
<div class="line"><span class="lineno"> 1431</span>  <span class="comment">// gennaro</span></div>
<div class="line"><span class="lineno"> 1432</span> </div>
<div class="line"><span class="lineno"> 1433</span>  U.Solve(dS, &amp;dT);</div>
<div class="line"><span class="lineno"> 1434</span>  J.MultiplyTranspose(dT, dTheta);</div>
<div class="line"><span class="lineno"> 1435</span> </div>
<div class="line"><span class="lineno"> 1436</span>  <span class="comment">// Scalo per non superare l&#39;nagolo massimod i cambiamento</span></div>
<div class="line"><span class="lineno"> 1437</span>  <span class="keywordtype">double</span> maxChange = 100 * dTheta.MaxAbs();</div>
<div class="line"><span class="lineno"> 1438</span>  <span class="keywordflow">if</span> (maxChange &gt; MaxAngleDLS) {</div>
<div class="line"><span class="lineno"> 1439</span>    dTheta *= MaxAngleDLS / maxChange;</div>
<div class="line"><span class="lineno"> 1440</span>  }</div>
<div class="line"><span class="lineno"> 1441</span>}</div>
<div class="ttc" id="aclass_matrix_rmn_html"><div class="ttname"><a href="class_matrix_rmn.html">MatrixRmn</a></div><div class="ttdef"><b>Definition:</b> ikjacobian.h:233</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad56901602ef95216b0c294b8e619d2a2" name="ad56901602ef95216b0c294b8e619d2a2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad56901602ef95216b0c294b8e619d2a2">&#9670;&nbsp;</a></span>CalcDeltaThetasDLSwithSVD()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::CalcDeltaThetasDLSwithSVD </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1443</span>                                         {</div>
<div class="line"><span class="lineno"> 1444</span>  <span class="keyword">const</span> <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> &amp;J = Jend;</div>
<div class="line"><span class="lineno"> 1445</span> </div>
<div class="line"><span class="lineno"> 1446</span>  J.ComputeSVD(U, w, V);</div>
<div class="line"><span class="lineno"> 1447</span> </div>
<div class="line"><span class="lineno"> 1448</span>  <span class="comment">// For Debug</span></div>
<div class="line"><span class="lineno"> 1449</span>  assert(J.DebugCheckSVD(U, w, V));</div>
<div class="line"><span class="lineno"> 1450</span> </div>
<div class="line"><span class="lineno"> 1451</span>  <span class="comment">// Calculate response vector dTheta that is the DLS solution.</span></div>
<div class="line"><span class="lineno"> 1452</span>  <span class="comment">//    Delta target values are the dS values</span></div>
<div class="line"><span class="lineno"> 1453</span>  <span class="comment">//  We multiply by DLS inverse of the J matrix</span></div>
<div class="line"><span class="lineno"> 1454</span>  <span class="keywordtype">long</span> diagLength = w.GetLength();</div>
<div class="line"><span class="lineno"> 1455</span>  <span class="keywordtype">double</span> *wPtr    = w.GetPtr();</div>
<div class="line"><span class="lineno"> 1456</span>  dTheta.SetZero();</div>
<div class="line"><span class="lineno"> 1457</span>  <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i = 0; i &lt; diagLength; i++) {</div>
<div class="line"><span class="lineno"> 1458</span>    <span class="keywordtype">double</span> dotProdCol =</div>
<div class="line"><span class="lineno"> 1459</span>        U.DotProductColumn(dS, i);  <span class="comment">// Dot product with i-th column of U</span></div>
<div class="line"><span class="lineno"> 1460</span>    <span class="keywordtype">double</span> alpha = *(wPtr++);</div>
<div class="line"><span class="lineno"> 1461</span>    alpha        = alpha / (Square(alpha) + DampingLambdaSq);</div>
<div class="line"><span class="lineno"> 1462</span>    MatrixRmn::AddArrayScale(V.getNumRows(), V.GetColumnPtr(i), 1,</div>
<div class="line"><span class="lineno"> 1463</span>                             dTheta.GetPtr(), 1, dotProdCol * alpha);</div>
<div class="line"><span class="lineno"> 1464</span>  }</div>
<div class="line"><span class="lineno"> 1465</span> </div>
<div class="line"><span class="lineno"> 1466</span>  <span class="comment">// Scale back to not exceed maximum angle changes</span></div>
<div class="line"><span class="lineno"> 1467</span>  <span class="keywordtype">double</span> maxChange = dTheta.MaxAbs();</div>
<div class="line"><span class="lineno"> 1468</span>  <span class="keywordflow">if</span> (maxChange &gt; MaxAngleDLS) {</div>
<div class="line"><span class="lineno"> 1469</span>    dTheta *= MaxAngleDLS / maxChange;</div>
<div class="line"><span class="lineno"> 1470</span>  }</div>
<div class="line"><span class="lineno"> 1471</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ad9bd2e44047605346ffd5987c43fe211" name="ad9bd2e44047605346ffd5987c43fe211"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9bd2e44047605346ffd5987c43fe211">&#9670;&nbsp;</a></span>CalcDeltaThetasPseudoinverse()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::CalcDeltaThetasPseudoinverse </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1236</span>                                            {</div>
<div class="line"><span class="lineno"> 1237</span>  <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> &amp;J = <span class="keyword">const_cast&lt;</span><a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> &amp;<span class="keyword">&gt;</span>(Jend);</div>
<div class="line"><span class="lineno"> 1238</span> </div>
<div class="line"><span class="lineno"> 1239</span>  <span class="comment">// costruisco matrice J1</span></div>
<div class="line"><span class="lineno"> 1240</span>  <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> J1;</div>
<div class="line"><span class="lineno"> 1241</span>  J1.SetSize(2, J.getNumColumns());</div>
<div class="line"><span class="lineno"> 1242</span> </div>
<div class="line"><span class="lineno"> 1243</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; i++)</div>
<div class="line"><span class="lineno"> 1244</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; J.getNumColumns(); j++) J1.Set(i, j, J.Get(i, j));</div>
<div class="line"><span class="lineno"> 1245</span> </div>
<div class="line"><span class="lineno"> 1246</span>  <span class="comment">// COSTRUISCO VETTORI ds1 e ds2</span></div>
<div class="line"><span class="lineno"> 1247</span>  <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> dS1(2);</div>
<div class="line"><span class="lineno"> 1248</span> </div>
<div class="line"><span class="lineno"> 1249</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 2; i++) dS1.Set(i, dS.Get(i));</div>
<div class="line"><span class="lineno"> 1250</span> </div>
<div class="line"><span class="lineno"> 1251</span>  <span class="comment">// calcolo dtheta1</span></div>
<div class="line"><span class="lineno"> 1252</span>  <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> U, V;</div>
<div class="line"><span class="lineno"> 1253</span>  <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> w;</div>
<div class="line"><span class="lineno"> 1254</span> </div>
<div class="line"><span class="lineno"> 1255</span>  U.SetSize(J1.getNumRows(), J1.getNumRows());</div>
<div class="line"><span class="lineno"> 1256</span>  w.SetLength(min(J1.getNumRows(), J1.getNumColumns()));</div>
<div class="line"><span class="lineno"> 1257</span>  V.SetSize(J1.getNumColumns(), J1.getNumColumns());</div>
<div class="line"><span class="lineno"> 1258</span> </div>
<div class="line"><span class="lineno"> 1259</span>  J1.ComputeSVD(U, w, V);</div>
<div class="line"><span class="lineno"> 1260</span> </div>
<div class="line"><span class="lineno"> 1261</span>  <span class="comment">// Next line for debugging only</span></div>
<div class="line"><span class="lineno"> 1262</span>  assert(J1.DebugCheckSVD(U, w, V));</div>
<div class="line"><span class="lineno"> 1263</span> </div>
<div class="line"><span class="lineno"> 1264</span>  <span class="comment">// Calculate response vector dTheta that is the DLS solution.</span></div>
<div class="line"><span class="lineno"> 1265</span>  <span class="comment">//    Delta target values are the dS values</span></div>
<div class="line"><span class="lineno"> 1266</span>  <span class="comment">//  We multiply by Moore-Penrose pseudo-inverse of the J matrix</span></div>
<div class="line"><span class="lineno"> 1267</span> </div>
<div class="line"><span class="lineno"> 1268</span>  <span class="keywordtype">double</span> pseudoInverseThreshold = PseudoInverseThresholdFactor * w.MaxAbs();</div>
<div class="line"><span class="lineno"> 1269</span> </div>
<div class="line"><span class="lineno"> 1270</span>  <span class="keywordtype">long</span> diagLength = w.GetLength();</div>
<div class="line"><span class="lineno"> 1271</span>  <span class="keywordtype">double</span> *wPtr    = w.GetPtr();</div>
<div class="line"><span class="lineno"> 1272</span>  dTheta.SetZero();</div>
<div class="line"><span class="lineno"> 1273</span>  <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i = 0; i &lt; diagLength; i++) {</div>
<div class="line"><span class="lineno"> 1274</span>    <span class="keywordtype">double</span> dotProdCol =</div>
<div class="line"><span class="lineno"> 1275</span>        U.DotProductColumn(dS1, i);  <span class="comment">// Dot product with i-th column of U</span></div>
<div class="line"><span class="lineno"> 1276</span>    <span class="keywordtype">double</span> alpha = *(wPtr++);</div>
<div class="line"><span class="lineno"> 1277</span>    <span class="keywordflow">if</span> (fabs(alpha) &gt; pseudoInverseThreshold) {</div>
<div class="line"><span class="lineno"> 1278</span>      alpha = 1.0 / alpha;</div>
<div class="line"><span class="lineno"> 1279</span>      MatrixRmn::AddArrayScale(V.getNumRows(), V.GetColumnPtr(i), 1,</div>
<div class="line"><span class="lineno"> 1280</span>                               dTheta.GetPtr(), 1, dotProdCol * alpha);</div>
<div class="line"><span class="lineno"> 1281</span>    }</div>
<div class="line"><span class="lineno"> 1282</span>  }</div>
<div class="line"><span class="lineno"> 1283</span> </div>
<div class="line"><span class="lineno"> 1284</span>  <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> JcurrentPinv(V.getNumRows(),</div>
<div class="line"><span class="lineno"> 1285</span>                         J1.getNumRows());  <span class="comment">// pseudoinversa di J1</span></div>
<div class="line"><span class="lineno"> 1286</span>  <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> JProjPre(JcurrentPinv.getNumRows(),</div>
<div class="line"><span class="lineno"> 1287</span>                     J1.getNumColumns());  <span class="comment">// Proiezione di J1</span></div>
<div class="line"><span class="lineno"> 1288</span>  <span class="keywordflow">if</span> (skeleton-&gt;getNumEffector() &gt; 1) {</div>
<div class="line"><span class="lineno"> 1289</span>    <span class="comment">// calcolo la pseudoinversa di J1</span></div>
<div class="line"><span class="lineno"> 1290</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> VD(V.getNumRows(), J1.getNumRows());  <span class="comment">// matrice del prodotto V*w</span></div>
<div class="line"><span class="lineno"> 1291</span> </div>
<div class="line"><span class="lineno"> 1292</span>    <span class="keywordtype">double</span> *wPtr           = w.GetPtr();</div>
<div class="line"><span class="lineno"> 1293</span>    pseudoInverseThreshold = PseudoInverseThresholdFactor * w.MaxAbs();</div>
<div class="line"><span class="lineno"> 1294</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; VD.getNumColumns(); j++) {</div>
<div class="line"><span class="lineno"> 1295</span>      <span class="keywordtype">double</span> *VPtr = V.GetColumnPtr(j);</div>
<div class="line"><span class="lineno"> 1296</span>      <span class="keywordtype">double</span> alpha = *(wPtr++);  <span class="comment">// elemento matrice diagonale</span></div>
<div class="line"><span class="lineno"> 1297</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; V.getNumRows(); i++) {</div>
<div class="line"><span class="lineno"> 1298</span>        <span class="keywordflow">if</span> (fabs(alpha) &gt; pseudoInverseThreshold) {</div>
<div class="line"><span class="lineno"> 1299</span>          <span class="keywordtype">double</span> entry = *(VPtr++);</div>
<div class="line"><span class="lineno"> 1300</span>          VD.Set(i, j, entry * (1.0 / alpha));</div>
<div class="line"><span class="lineno"> 1301</span>        }</div>
<div class="line"><span class="lineno"> 1302</span>      }</div>
<div class="line"><span class="lineno"> 1303</span>    }</div>
<div class="line"><span class="lineno"> 1304</span>    MatrixRmn::MultiplyTranspose(VD, U, JcurrentPinv);</div>
<div class="line"><span class="lineno"> 1305</span> </div>
<div class="line"><span class="lineno"> 1306</span>    <span class="comment">// calcolo la proiezione J1</span></div>
<div class="line"><span class="lineno"> 1307</span>    MatrixRmn::Multiply(JcurrentPinv, J1, JProjPre);</div>
<div class="line"><span class="lineno"> 1308</span> </div>
<div class="line"><span class="lineno"> 1309</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; JProjPre.getNumColumns(); j++)</div>
<div class="line"><span class="lineno"> 1310</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; JProjPre.getNumRows(); i++) {</div>
<div class="line"><span class="lineno"> 1311</span>        <span class="keywordtype">double</span> temp = JProjPre.Get(i, j);</div>
<div class="line"><span class="lineno"> 1312</span>        JProjPre.Set(i, j, -1.0 * temp);</div>
<div class="line"><span class="lineno"> 1313</span>      }</div>
<div class="line"><span class="lineno"> 1314</span>    JProjPre.AddToDiagonal(diagMatIdentity);</div>
<div class="line"><span class="lineno"> 1315</span>  }</div>
<div class="line"><span class="lineno"> 1316</span> </div>
<div class="line"><span class="lineno"> 1317</span>  <span class="comment">// task priority strategy</span></div>
<div class="line"><span class="lineno"> 1318</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; skeleton-&gt;getNumEffector(); i++) {</div>
<div class="line"><span class="lineno"> 1319</span>    <span class="comment">// costruisco matrice Jcurrent (Ji)</span></div>
<div class="line"><span class="lineno"> 1320</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> Jcurrent(2, J.getNumColumns());</div>
<div class="line"><span class="lineno"> 1321</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; J.getNumColumns(); j++)</div>
<div class="line"><span class="lineno"> 1322</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; 2; k++) Jcurrent.Set(k, j, J.Get(k + 2 * i, j));</div>
<div class="line"><span class="lineno"> 1323</span> </div>
<div class="line"><span class="lineno"> 1324</span>    <span class="comment">// costruisco il vettore dScurrent</span></div>
<div class="line"><span class="lineno"> 1325</span>    <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> dScurrent(2);</div>
<div class="line"><span class="lineno"> 1326</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; 2; k++) dScurrent.Set(k, dS.Get(k + 2 * i));</div>
<div class="line"><span class="lineno"> 1327</span> </div>
<div class="line"><span class="lineno"> 1328</span>    <span class="comment">// Moltiplico Jcurrent per la proiezione di J(i-1)</span></div>
<div class="line"><span class="lineno"> 1329</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> Jdst(Jcurrent.getNumRows(), JProjPre.getNumColumns());</div>
<div class="line"><span class="lineno"> 1330</span>    MatrixRmn::Multiply(Jcurrent, JProjPre, Jdst);</div>
<div class="line"><span class="lineno"> 1331</span> </div>
<div class="line"><span class="lineno"> 1332</span>    <span class="comment">// Calcolo la pseudoinversa di Jdst</span></div>
<div class="line"><span class="lineno"> 1333</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> UU(Jdst.getNumRows(), Jdst.getNumRows()),</div>
<div class="line"><span class="lineno"> 1334</span>        VV(Jdst.getNumColumns(), Jdst.getNumColumns());</div>
<div class="line"><span class="lineno"> 1335</span>    <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> ww(min(Jdst.getNumRows(), Jdst.getNumColumns()));</div>
<div class="line"><span class="lineno"> 1336</span> </div>
<div class="line"><span class="lineno"> 1337</span>    Jdst.ComputeSVD(UU, ww, VV);</div>
<div class="line"><span class="lineno"> 1338</span>    assert(Jdst.DebugCheckSVD(UU, ww, VV));</div>
<div class="line"><span class="lineno"> 1339</span> </div>
<div class="line"><span class="lineno"> 1340</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> VVD(VV.getNumRows(), J1.getNumRows());  <span class="comment">// matrice V*w</span></div>
<div class="line"><span class="lineno"> 1341</span>    VVD.SetZero();</div>
<div class="line"><span class="lineno"> 1342</span>    pseudoInverseThreshold = PseudoInverseThresholdFactor * ww.MaxAbs();</div>
<div class="line"><span class="lineno"> 1343</span>    <span class="keywordtype">double</span> *wwPtr          = ww.GetPtr();</div>
<div class="line"><span class="lineno"> 1344</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; VVD.getNumColumns(); j++) {</div>
<div class="line"><span class="lineno"> 1345</span>      <span class="keywordtype">double</span> *VVPtr = VV.GetColumnPtr(j);</div>
<div class="line"><span class="lineno"> 1346</span>      <span class="keywordtype">double</span> alpha  = 50 * (*(wwPtr++));  <span class="comment">// elemento matrice diagonale</span></div>
<div class="line"><span class="lineno"> 1347</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; VV.getNumRows(); i++) {</div>
<div class="line"><span class="lineno"> 1348</span>        <span class="keywordflow">if</span> (fabs(alpha) &gt; 100 * pseudoInverseThreshold) {</div>
<div class="line"><span class="lineno"> 1349</span>          <span class="keywordtype">double</span> entry = *(VVPtr++);</div>
<div class="line"><span class="lineno"> 1350</span>          VVD.Set(i, j, entry * (1.0 / alpha));</div>
<div class="line"><span class="lineno"> 1351</span>        }</div>
<div class="line"><span class="lineno"> 1352</span>      }</div>
<div class="line"><span class="lineno"> 1353</span>    }</div>
<div class="line"><span class="lineno"> 1354</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> JdstPinv(VV.getNumRows(), J1.getNumRows());</div>
<div class="line"><span class="lineno"> 1355</span>    MatrixRmn::MultiplyTranspose(VVD, UU, JdstPinv);</div>
<div class="line"><span class="lineno"> 1356</span> </div>
<div class="line"><span class="lineno"> 1357</span>    <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> dTemp(J1.getNumRows());</div>
<div class="line"><span class="lineno"> 1358</span>    Jcurrent.Multiply(dTheta, dTemp);</div>
<div class="line"><span class="lineno"> 1359</span> </div>
<div class="line"><span class="lineno"> 1360</span>    <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> dTemp2(dScurrent.GetLength());</div>
<div class="line"><span class="lineno"> 1361</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k  = 0; k &lt; dScurrent.GetLength(); k++)</div>
<div class="line"><span class="lineno"> 1362</span>      dTemp2[k] = dScurrent[k] - dTemp[k];</div>
<div class="line"><span class="lineno"> 1363</span> </div>
<div class="line"><span class="lineno"> 1364</span>    <span class="comment">// Moltiplico JdstPinv per dTemp2</span></div>
<div class="line"><span class="lineno"> 1365</span>    <a class="code hl_class" href="class_vector_rn.html">VectorRn</a> dThetaCurrent(JdstPinv.getNumRows());</div>
<div class="line"><span class="lineno"> 1366</span>    JdstPinv.Multiply(dTemp2, dThetaCurrent);</div>
<div class="line"><span class="lineno"> 1367</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; dTheta.GetLength(); k++) dTheta[k] += dThetaCurrent[k];</div>
<div class="line"><span class="lineno"> 1368</span> </div>
<div class="line"><span class="lineno"> 1369</span>    <span class="comment">// Infine mi calcolo la pseudoinversa di Jcurrent e quindi la sua proiezione</span></div>
<div class="line"><span class="lineno"> 1370</span>    <span class="comment">// che servirà al passo successivo</span></div>
<div class="line"><span class="lineno"> 1371</span> </div>
<div class="line"><span class="lineno"> 1372</span>    <span class="comment">// calcolo la pseudoinversa di Jcurrent</span></div>
<div class="line"><span class="lineno"> 1373</span>    Jcurrent.ComputeSVD(U, w, V);</div>
<div class="line"><span class="lineno"> 1374</span>    assert(Jcurrent.DebugCheckSVD(U, w, V));</div>
<div class="line"><span class="lineno"> 1375</span> </div>
<div class="line"><span class="lineno"> 1376</span>    <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> VD(V.getNumRows(),</div>
<div class="line"><span class="lineno"> 1377</span>                 Jcurrent.getNumRows());  <span class="comment">// matrice del prodotto V*w</span></div>
<div class="line"><span class="lineno"> 1378</span> </div>
<div class="line"><span class="lineno"> 1379</span>    <span class="keywordtype">double</span> *wPtr           = w.GetPtr();</div>
<div class="line"><span class="lineno"> 1380</span>    pseudoInverseThreshold = PseudoInverseThresholdFactor * w.MaxAbs();</div>
<div class="line"><span class="lineno"> 1381</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; VVD.getNumColumns(); j++) {</div>
<div class="line"><span class="lineno"> 1382</span>      <span class="keywordtype">double</span> *VPtr = V.GetColumnPtr(j);</div>
<div class="line"><span class="lineno"> 1383</span>      <span class="keywordtype">double</span> alpha = *(wPtr++);  <span class="comment">// elemento matrice diagonale</span></div>
<div class="line"><span class="lineno"> 1384</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; V.getNumRows(); i++) {</div>
<div class="line"><span class="lineno"> 1385</span>        <span class="keywordflow">if</span> (fabs(alpha) &gt; pseudoInverseThreshold) {</div>
<div class="line"><span class="lineno"> 1386</span>          <span class="keywordtype">double</span> entry = *(VPtr++);</div>
<div class="line"><span class="lineno"> 1387</span>          VD.Set(i, j, entry * (1.0 / alpha));</div>
<div class="line"><span class="lineno"> 1388</span>        }</div>
<div class="line"><span class="lineno"> 1389</span>      }</div>
<div class="line"><span class="lineno"> 1390</span>    }</div>
<div class="line"><span class="lineno"> 1391</span>    MatrixRmn::MultiplyTranspose(VD, U, JcurrentPinv);</div>
<div class="line"><span class="lineno"> 1392</span> </div>
<div class="line"><span class="lineno"> 1393</span>    <span class="comment">// calcolo la proiezione Jcurrent</span></div>
<div class="line"><span class="lineno"> 1394</span>    MatrixRmn::Multiply(JcurrentPinv, Jcurrent, JProjPre);</div>
<div class="line"><span class="lineno"> 1395</span> </div>
<div class="line"><span class="lineno"> 1396</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; JProjPre.getNumColumns(); j++)</div>
<div class="line"><span class="lineno"> 1397</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; JProjPre.getNumRows(); k++) {</div>
<div class="line"><span class="lineno"> 1398</span>        <span class="keywordtype">double</span> temp = JProjPre.Get(k, j);</div>
<div class="line"><span class="lineno"> 1399</span>        JProjPre.Set(k, j, -1.0 * temp);</div>
<div class="line"><span class="lineno"> 1400</span>      }</div>
<div class="line"><span class="lineno"> 1401</span>    JProjPre.AddToDiagonal(diagMatIdentity);</div>
<div class="line"><span class="lineno"> 1402</span>  }</div>
<div class="line"><span class="lineno"> 1403</span> </div>
<div class="line"><span class="lineno"> 1404</span>  <span class="comment">// sw.stop();</span></div>
<div class="line"><span class="lineno"> 1405</span>  <span class="comment">// std::ofstream os(&quot;C:\\buttami.txt&quot;, std::ios::app);</span></div>
<div class="line"><span class="lineno"> 1406</span>  <span class="comment">// sw.print(os);</span></div>
<div class="line"><span class="lineno"> 1407</span>  <span class="comment">// os.close();</span></div>
<div class="line"><span class="lineno"> 1408</span> </div>
<div class="line"><span class="lineno"> 1409</span>  <span class="comment">// Scale back to not exceed maximum angle changes</span></div>
<div class="line"><span class="lineno"> 1410</span>  <span class="keywordtype">double</span> maxChange = 10 * dTheta.MaxAbs();</div>
<div class="line"><span class="lineno"> 1411</span>  <span class="keywordflow">if</span> (maxChange &gt; MaxAnglePseudoinverse) {</div>
<div class="line"><span class="lineno"> 1412</span>    dTheta *= MaxAnglePseudoinverse / maxChange;</div>
<div class="line"><span class="lineno"> 1413</span>  }</div>
<div class="line"><span class="lineno"> 1414</span>}</div>
<div class="ttc" id="aclass_vector_rn_html"><div class="ttname"><a href="class_vector_rn.html">VectorRn</a></div><div class="ttdef"><b>Definition:</b> ikjacobian.h:27</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad4a0f0bf23ec7caaacd33181248a4762" name="ad4a0f0bf23ec7caaacd33181248a4762"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad4a0f0bf23ec7caaacd33181248a4762">&#9670;&nbsp;</a></span>CalcDeltaThetasSDLS()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::CalcDeltaThetasSDLS </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1473</span>                                   {</div>
<div class="line"><span class="lineno"> 1474</span>  <span class="keyword">const</span> <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> &amp;J = Jend;</div>
<div class="line"><span class="lineno"> 1475</span> </div>
<div class="line"><span class="lineno"> 1476</span>  <span class="comment">// Compute Singular Value Decomposition</span></div>
<div class="line"><span class="lineno"> 1477</span> </div>
<div class="line"><span class="lineno"> 1478</span>  J.ComputeSVD(U, w, V);</div>
<div class="line"><span class="lineno"> 1479</span> </div>
<div class="line"><span class="lineno"> 1480</span>  <span class="comment">// Next line for debugging only</span></div>
<div class="line"><span class="lineno"> 1481</span>  assert(J.DebugCheckSVD(U, w, V));</div>
<div class="line"><span class="lineno"> 1482</span> </div>
<div class="line"><span class="lineno"> 1483</span>  <span class="comment">// Calculate response vector dTheta that is the SDLS solution.</span></div>
<div class="line"><span class="lineno"> 1484</span>  <span class="comment">//    Delta target values are the dS values</span></div>
<div class="line"><span class="lineno"> 1485</span>  <span class="keywordtype">int</span> nRows           = J.getNumRows();</div>
<div class="line"><span class="lineno"> 1486</span>  <span class="keywordtype">int</span> numEndEffectors = skeleton-&gt;getNumEffector();  <span class="comment">// Equals the number of</span></div>
<div class="line"><span class="lineno"> 1487</span>                                                     <span class="comment">// rows of J divided by</span></div>
<div class="line"><span class="lineno"> 1488</span>                                                     <span class="comment">// three</span></div>
<div class="line"><span class="lineno"> 1489</span>  <span class="keywordtype">int</span> nCols = J.getNumColumns();</div>
<div class="line"><span class="lineno"> 1490</span>  dTheta.SetZero();</div>
<div class="line"><span class="lineno"> 1491</span> </div>
<div class="line"><span class="lineno"> 1492</span>  <span class="comment">// Calculate the norms of the 3-vectors in the Jacobian</span></div>
<div class="line"><span class="lineno"> 1493</span>  <span class="keywordtype">long</span> i;</div>
<div class="line"><span class="lineno"> 1494</span>  <span class="keyword">const</span> <span class="keywordtype">double</span> *jx = J.GetPtr();</div>
<div class="line"><span class="lineno"> 1495</span>  <span class="keywordtype">double</span> *jnx      = Jnorms.GetPtr();</div>
<div class="line"><span class="lineno"> 1496</span>  <span class="keywordflow">for</span> (i = nCols * numEndEffectors; i &gt; 0; i--) {</div>
<div class="line"><span class="lineno"> 1497</span>    <span class="keywordtype">double</span> accumSq = Square(*(jx++));</div>
<div class="line"><span class="lineno"> 1498</span>    accumSq += Square(*(jx++));</div>
<div class="line"><span class="lineno"> 1499</span>    accumSq += Square(*(jx++));</div>
<div class="line"><span class="lineno"> 1500</span>    *(jnx++) = sqrt(accumSq);</div>
<div class="line"><span class="lineno"> 1501</span>  }</div>
<div class="line"><span class="lineno"> 1502</span> </div>
<div class="line"><span class="lineno"> 1503</span>  <span class="comment">// Clamp the dS values</span></div>
<div class="line"><span class="lineno"> 1504</span>  CalcdTClampedFromdS();</div>
<div class="line"><span class="lineno"> 1505</span> </div>
<div class="line"><span class="lineno"> 1506</span>  <span class="comment">// Loop over each singular vector</span></div>
<div class="line"><span class="lineno"> 1507</span>  <span class="keywordflow">for</span> (i = 0; i &lt; nRows; i++) {</div>
<div class="line"><span class="lineno"> 1508</span>    <span class="keywordtype">double</span> wiInv = w[i];</div>
<div class="line"><span class="lineno"> 1509</span>    <span class="keywordflow">if</span> (NearZero(wiInv, 1.0e-10)) {</div>
<div class="line"><span class="lineno"> 1510</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno"> 1511</span>    }</div>
<div class="line"><span class="lineno"> 1512</span>    wiInv = 1.0 / wiInv;</div>
<div class="line"><span class="lineno"> 1513</span> </div>
<div class="line"><span class="lineno"> 1514</span>    <span class="keywordtype">double</span> N = 0.0;  <span class="comment">// N is the quasi-1-norm of the i-th column of U</span></div>
<div class="line"><span class="lineno"> 1515</span>    <span class="keywordtype">double</span> alpha =</div>
<div class="line"><span class="lineno"> 1516</span>        0.0;  <span class="comment">// alpha is the dot product of dT and the i-th column of U</span></div>
<div class="line"><span class="lineno"> 1517</span> </div>
<div class="line"><span class="lineno"> 1518</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> *dTx = dT.GetPtr();</div>
<div class="line"><span class="lineno"> 1519</span>    <span class="keyword">const</span> <span class="keywordtype">double</span> *ux  = U.GetColumnPtr(i);</div>
<div class="line"><span class="lineno"> 1520</span>    <span class="keywordtype">long</span> j;</div>
<div class="line"><span class="lineno"> 1521</span>    <span class="keywordflow">for</span> (j = numEndEffectors; j &gt; 0; j--) {</div>
<div class="line"><span class="lineno"> 1522</span>      <span class="keywordtype">double</span> tmp;</div>
<div class="line"><span class="lineno"> 1523</span>      alpha += (*ux) * (*(dTx++));</div>
<div class="line"><span class="lineno"> 1524</span>      tmp = Square(*(ux++));</div>
<div class="line"><span class="lineno"> 1525</span>      alpha += (*ux) * (*(dTx++));</div>
<div class="line"><span class="lineno"> 1526</span>      tmp += Square(*(ux++));</div>
<div class="line"><span class="lineno"> 1527</span>      alpha += (*ux) * (*(dTx++));</div>
<div class="line"><span class="lineno"> 1528</span>      tmp += Square(*(ux++));</div>
<div class="line"><span class="lineno"> 1529</span>      N += sqrt(tmp);</div>
<div class="line"><span class="lineno"> 1530</span>    }</div>
<div class="line"><span class="lineno"> 1531</span> </div>
<div class="line"><span class="lineno"> 1532</span>    <span class="comment">// M is the quasi-1-norm of the response to angles changing according to the</span></div>
<div class="line"><span class="lineno"> 1533</span>    <span class="comment">// i-th column of V</span></div>
<div class="line"><span class="lineno"> 1534</span>    <span class="comment">//      Then is multiplied by the wiInv value.</span></div>
<div class="line"><span class="lineno"> 1535</span>    <span class="keywordtype">double</span> M   = 0.0;</div>
<div class="line"><span class="lineno"> 1536</span>    <span class="keywordtype">double</span> *vx = V.GetColumnPtr(i);</div>
<div class="line"><span class="lineno"> 1537</span>    jnx        = Jnorms.GetPtr();</div>
<div class="line"><span class="lineno"> 1538</span>    <span class="keywordflow">for</span> (j = nCols; j &gt; 0; j--) {</div>
<div class="line"><span class="lineno"> 1539</span>      <span class="keywordtype">double</span> accum = 0.0;</div>
<div class="line"><span class="lineno"> 1540</span>      <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k = numEndEffectors; k &gt; 0; k--) {</div>
<div class="line"><span class="lineno"> 1541</span>        accum += *(jnx++);</div>
<div class="line"><span class="lineno"> 1542</span>      }</div>
<div class="line"><span class="lineno"> 1543</span>      M += fabs((*(vx++))) * accum;</div>
<div class="line"><span class="lineno"> 1544</span>    }</div>
<div class="line"><span class="lineno"> 1545</span>    M *= fabs(wiInv);</div>
<div class="line"><span class="lineno"> 1546</span> </div>
<div class="line"><span class="lineno"> 1547</span>    <span class="keywordtype">double</span> gamma = MaxAngleSDLS;</div>
<div class="line"><span class="lineno"> 1548</span>    <span class="keywordflow">if</span> (N &lt; M) {</div>
<div class="line"><span class="lineno"> 1549</span>      gamma *= N / M;  <span class="comment">// Scale back maximum permissible joint angle</span></div>
<div class="line"><span class="lineno"> 1550</span>    }</div>
<div class="line"><span class="lineno"> 1551</span> </div>
<div class="line"><span class="lineno"> 1552</span>    <span class="comment">// Calculate the dTheta from pure pseudoinverse considerations</span></div>
<div class="line"><span class="lineno"> 1553</span>    <span class="keywordtype">double</span> scale =</div>
<div class="line"><span class="lineno"> 1554</span>        alpha *</div>
<div class="line"><span class="lineno"> 1555</span>        wiInv;  <span class="comment">// This times i-th column of V is the pseudoinverse response</span></div>
<div class="line"><span class="lineno"> 1556</span>    dPreTheta.LoadScaled(V.GetColumnPtr(i), scale);</div>
<div class="line"><span class="lineno"> 1557</span>    <span class="comment">// Now rescale the dTheta values.</span></div>
<div class="line"><span class="lineno"> 1558</span>    <span class="keywordtype">double</span> max     = dPreTheta.MaxAbs();</div>
<div class="line"><span class="lineno"> 1559</span>    <span class="keywordtype">double</span> rescale = (gamma) / (gamma + max);</div>
<div class="line"><span class="lineno"> 1560</span>    dTheta.AddScaled(dPreTheta, rescale);</div>
<div class="line"><span class="lineno"> 1561</span>    <span class="comment">/*if ( gamma&lt;max) {</span></div>
<div class="line"><span class="lineno"> 1562</span><span class="comment">            dTheta.AddScaled( dPreTheta, gamma/max );</span></div>
<div class="line"><span class="lineno"> 1563</span><span class="comment">    }</span></div>
<div class="line"><span class="lineno"> 1564</span><span class="comment">    else {</span></div>
<div class="line"><span class="lineno"> 1565</span><span class="comment">            dTheta += dPreTheta;</span></div>
<div class="line"><span class="lineno"> 1566</span><span class="comment">    }*/</span></div>
<div class="line"><span class="lineno"> 1567</span>  }</div>
<div class="line"><span class="lineno"> 1568</span> </div>
<div class="line"><span class="lineno"> 1569</span>  <span class="comment">// Scale back to not exceed maximum angle changes</span></div>
<div class="line"><span class="lineno"> 1570</span>  <span class="keywordtype">double</span> maxChange = dTheta.MaxAbs();</div>
<div class="line"><span class="lineno"> 1571</span>  <span class="keywordflow">if</span> (maxChange &gt; 100 * MaxAngleSDLS) {</div>
<div class="line"><span class="lineno"> 1572</span>    dTheta *= MaxAngleSDLS / (MaxAngleSDLS + maxChange);</div>
<div class="line"><span class="lineno"> 1573</span>    <span class="comment">// dTheta *= MaxAngleSDLS/maxChange;</span></div>
<div class="line"><span class="lineno"> 1574</span>  }</div>
<div class="line"><span class="lineno"> 1575</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a0bb9b42c4eea995050f0c835aaeabcd1" name="a0bb9b42c4eea995050f0c835aaeabcd1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0bb9b42c4eea995050f0c835aaeabcd1">&#9670;&nbsp;</a></span>CalcDeltaThetasTranspose()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::CalcDeltaThetasTranspose </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1221</span>                                        {</div>
<div class="line"><span class="lineno"> 1222</span>  <span class="keyword">const</span> <a class="code hl_class" href="class_matrix_rmn.html">MatrixRmn</a> &amp;J = Jend;</div>
<div class="line"><span class="lineno"> 1223</span> </div>
<div class="line"><span class="lineno"> 1224</span>  J.MultiplyTranspose(dS, dTheta);</div>
<div class="line"><span class="lineno"> 1225</span> </div>
<div class="line"><span class="lineno"> 1226</span>  <span class="comment">// Scale back the dTheta values greedily</span></div>
<div class="line"><span class="lineno"> 1227</span>  J.Multiply(dTheta, dT);  <span class="comment">// dT = J * dTheta</span></div>
<div class="line"><span class="lineno"> 1228</span>  <span class="keywordtype">double</span> alpha = Dot(dS, dT) / dT.NormSq();</div>
<div class="line"><span class="lineno"> 1229</span>  assert(alpha &gt; 0.0);</div>
<div class="line"><span class="lineno"> 1230</span>  <span class="comment">// Also scale back to be have max angle change less than MaxAngleJtranspose</span></div>
<div class="line"><span class="lineno"> 1231</span>  <span class="keywordtype">double</span> maxChange = dTheta.MaxAbs();</div>
<div class="line"><span class="lineno"> 1232</span>  <span class="keywordtype">double</span> beta      = MaxAngleJtranspose / maxChange;</div>
<div class="line"><span class="lineno"> 1233</span>  dTheta *= min(alpha, beta);</div>
<div class="line"><span class="lineno"> 1234</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aeabf2c921517d3f7f313701399e95b59" name="aeabf2c921517d3f7f313701399e95b59"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeabf2c921517d3f7f313701399e95b59">&#9670;&nbsp;</a></span>checkJointsLimit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Jacobian::checkJointsLimit </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1191</span>                                {</div>
<div class="line"><span class="lineno"> 1192</span>  <span class="keywordtype">bool</span> clampingDetected = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1193</span>  <span class="comment">/*</span></div>
<div class="line"><span class="lineno"> 1194</span><span class="comment">  Node* n = skeleton-&gt;getNode(3);</span></div>
<div class="line"><span class="lineno"> 1195</span><span class="comment">  int indexJoint = n-&gt;getJointNum();</span></div>
<div class="line"><span class="lineno"> 1196</span><span class="comment">  double theta = n-&gt;getTheta();</span></div>
<div class="line"><span class="lineno"> 1197</span><span class="comment">  double upperLimit = PI;</span></div>
<div class="line"><span class="lineno"> 1198</span><span class="comment">  double lowerLimit = 0.0;</span></div>
<div class="line"><span class="lineno"> 1199</span><span class="comment">  if(theta &gt;upperLimit || theta &lt;lowerLimit)</span></div>
<div class="line"><span class="lineno"> 1200</span><span class="comment">  {</span></div>
<div class="line"><span class="lineno"> 1201</span><span class="comment">          if(theta&lt;upperLimit)  upperLimit = lowerLimit;</span></div>
<div class="line"><span class="lineno"> 1202</span><span class="comment">          clampingDetected = true;</span></div>
<div class="line"><span class="lineno"> 1203</span><span class="comment">          double clampingVar = theta - upperLimit;</span></div>
<div class="line"><span class="lineno"> 1204</span><span class="comment">          for(int i=0;i&lt;Jactive-&gt;getNumRows();i++)</span></div>
<div class="line"><span class="lineno"> 1205</span><span class="comment">          {</span></div>
<div class="line"><span class="lineno"> 1206</span><span class="comment">                  double tmp = clampingVar*Jactive-&gt;Get(i,indexJoint);</span></div>
<div class="line"><span class="lineno"> 1207</span><span class="comment">                  dS[i] -= tmp;</span></div>
<div class="line"><span class="lineno"> 1208</span><span class="comment">                  Jactive-&gt;Set(i,indexJoint,0.0);</span></div>
<div class="line"><span class="lineno"> 1209</span><span class="comment">          }</span></div>
<div class="line"><span class="lineno"> 1210</span><span class="comment">          n-&gt;setTheta(upperLimit);</span></div>
<div class="line"><span class="lineno"> 1211</span><span class="comment">          diagMatIdentity.Set(indexJoint, 0.0);</span></div>
<div class="line"><span class="lineno"> 1212</span><span class="comment"></span> </div>
<div class="line"><span class="lineno"> 1213</span><span class="comment">  }*/</span></div>
<div class="line"><span class="lineno"> 1214</span>  <span class="keywordflow">return</span> clampingDetected;</div>
<div class="line"><span class="lineno"> 1215</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa661382ab1057f0663a40d1d73127ad8" name="aa661382ab1057f0663a40d1d73127ad8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa661382ab1057f0663a40d1d73127ad8">&#9670;&nbsp;</a></span>computeJacobian()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::computeJacobian </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1120</span>                               {</div>
<div class="line"><span class="lineno"> 1121</span>  <span class="comment">// Scorro tutto lo skeleton per trovare tutti gli end effectors</span></div>
<div class="line"><span class="lineno"> 1122</span> </div>
<div class="line"><span class="lineno"> 1123</span>  <span class="keywordtype">int</span> numNode = skeleton-&gt;getNodeCount();</div>
<div class="line"><span class="lineno"> 1124</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> index = 0; index &lt; numNode; index++) {</div>
<div class="line"><span class="lineno"> 1125</span>    <a class="code hl_class" href="class_i_k_node.html">IKNode</a> *n         = skeleton-&gt;getNode(index);</div>
<div class="line"><span class="lineno"> 1126</span>    <span class="keywordtype">int</span> effectorCount = skeleton-&gt;getNumEffector();</div>
<div class="line"><span class="lineno"> 1127</span>    <span class="keywordflow">if</span> (n-&gt;IsEffector()) {</div>
<div class="line"><span class="lineno"> 1128</span>      <span class="keywordtype">int</span> i                    = n-&gt;getEffectorNum();</div>
<div class="line"><span class="lineno"> 1129</span>      <span class="keyword">const</span> <a class="code hl_class" href="class_t_point_t.html">TPointD</a> &amp;targetPos = target[i];</div>
<div class="line"><span class="lineno"> 1130</span>      <a class="code hl_class" href="class_t_point_t.html">TPointD</a> temp;</div>
<div class="line"><span class="lineno"> 1131</span>      <span class="comment">// Calcolo i valori di deltaS (differenza tra end effectors e target</span></div>
<div class="line"><span class="lineno"> 1132</span>      <span class="comment">// positions.)</span></div>
<div class="line"><span class="lineno"> 1133</span>      temp      = targetPos;</div>
<div class="line"><span class="lineno"> 1134</span>      <a class="code hl_class" href="class_t_point_t.html">TPointD</a> a = n-&gt;GetS();</div>
<div class="line"><span class="lineno"> 1135</span>      temp -= n-&gt;GetS();</div>
<div class="line"><span class="lineno"> 1136</span>      <span class="keywordflow">if</span> (i &lt; effectorCount - 1) {</div>
<div class="line"><span class="lineno"> 1137</span>        temp.x = 100 * temp.x;</div>
<div class="line"><span class="lineno"> 1138</span>        temp.y = 100 * temp.y;</div>
<div class="line"><span class="lineno"> 1139</span>      }</div>
<div class="line"><span class="lineno"> 1140</span>      dS.SetCouple(i, temp);</div>
<div class="line"><span class="lineno"> 1141</span> </div>
<div class="line"><span class="lineno"> 1142</span>      <span class="comment">// Find all ancestors (they will usually all be joints)</span></div>
<div class="line"><span class="lineno"> 1143</span>      <span class="comment">// Set the corresponding entries in the Jacobians J, K.</span></div>
<div class="line"><span class="lineno"> 1144</span>      <a class="code hl_class" href="class_i_k_node.html">IKNode</a> *m = skeleton-&gt;getParent(n);</div>
<div class="line"><span class="lineno"> 1145</span> </div>
<div class="line"><span class="lineno"> 1146</span>      <span class="keywordflow">while</span> (m) {</div>
<div class="line"><span class="lineno"> 1147</span>        <span class="keywordtype">int</span> j = m-&gt;getJointNum();</div>
<div class="line"><span class="lineno"> 1148</span>        <span class="comment">// assert(j&gt;=0 &amp;&amp; j&lt;skeleton-&gt;GetNumJoint());</span></div>
<div class="line"><span class="lineno"> 1149</span>        <span class="keywordtype">int</span> numnode = skeleton-&gt;getNodeCount();</div>
<div class="line"><span class="lineno"> 1150</span>        assert(0 &lt;= i &amp;&amp; i &lt; nEffector &amp;&amp; 0 &lt;= j &amp;&amp;</div>
<div class="line"><span class="lineno"> 1151</span>               j &lt; (skeleton-&gt;getNodeCount() - skeleton-&gt;getNumEffector()));</div>
<div class="line"><span class="lineno"> 1152</span>        <span class="keywordflow">if</span> (m-&gt;isFrozen()) {</div>
<div class="line"><span class="lineno"> 1153</span>          Jend.SetCouple(i, j, <a class="code hl_class" href="class_t_point_t.html">TPointD</a>(0.0, 0.0));</div>
<div class="line"><span class="lineno"> 1154</span> </div>
<div class="line"><span class="lineno"> 1155</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1156</span>          temp = m-&gt;GetS();   <span class="comment">// joint pos.</span></div>
<div class="line"><span class="lineno"> 1157</span>          temp -= n-&gt;GetS();  <span class="comment">// -(end effector pos. - joint pos.)</span></div>
<div class="line"><span class="lineno"> 1158</span> </div>
<div class="line"><span class="lineno"> 1159</span>          <span class="keywordtype">double</span> tx = temp.x;</div>
<div class="line"><span class="lineno"> 1160</span>          temp.x    = temp.y;</div>
<div class="line"><span class="lineno"> 1161</span>          temp.y    = -tx;</div>
<div class="line"><span class="lineno"> 1162</span> </div>
<div class="line"><span class="lineno"> 1163</span>          <span class="keywordflow">if</span> (i &lt; effectorCount - 1) {</div>
<div class="line"><span class="lineno"> 1164</span>            temp.x = 100 * temp.x;</div>
<div class="line"><span class="lineno"> 1165</span>            temp.y = 100 * temp.y;</div>
<div class="line"><span class="lineno"> 1166</span>          }</div>
<div class="line"><span class="lineno"> 1167</span>          Jend.SetCouple(i, j, temp);</div>
<div class="line"><span class="lineno"> 1168</span>        }</div>
<div class="line"><span class="lineno"> 1169</span>        m = skeleton-&gt;getParent(m);</div>
<div class="line"><span class="lineno"> 1170</span>      }</div>
<div class="line"><span class="lineno"> 1171</span>    }</div>
<div class="line"><span class="lineno"> 1172</span>  }</div>
<div class="line"><span class="lineno"> 1173</span>}</div>
<div class="ttc" id="aclass_i_k_node_html"><div class="ttname"><a href="class_i_k_node.html">IKNode</a></div><div class="ttdef"><b>Definition:</b> iknode.h:20</div></div>
<div class="ttc" id="aclass_t_point_t_html"><div class="ttname"><a href="class_t_point_t.html">TPointT&lt; double &gt;</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a93f20df15d29f76884323ac738efd3d4" name="a93f20df15d29f76884323ac738efd3d4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a93f20df15d29f76884323ac738efd3d4">&#9670;&nbsp;</a></span>deletLastTarget()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::deletLastTarget </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  655</span>{ target.pop_back(); }</div>
</div><!-- fragment -->
</div>
</div>
<a id="a5a2be3c1b9bdfca91fd0c6bbdb152558" name="a5a2be3c1b9bdfca91fd0c6bbdb152558"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5a2be3c1b9bdfca91fd0c6bbdb152558">&#9670;&nbsp;</a></span>GetCurrentMode()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">UpdateMode Jacobian::GetCurrentMode </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  672</span>{ <span class="keywordflow">return</span> CurrentUpdateMode; }</div>
</div><!-- fragment -->
</div>
</div>
<a id="a63640e5c70a253f167e235ccbdaec132" name="a63640e5c70a253f167e235ccbdaec132"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a63640e5c70a253f167e235ccbdaec132">&#9670;&nbsp;</a></span>Reset()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::Reset </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1105</span>                     {</div>
<div class="line"><span class="lineno"> 1106</span>  <span class="comment">// Usato nel Damped Least Squares Method</span></div>
<div class="line"><span class="lineno"> 1107</span>  DampingLambda   = DefaultDampingLambda;</div>
<div class="line"><span class="lineno"> 1108</span>  DampingLambdaSq = Square(DampingLambda);</div>
<div class="line"><span class="lineno"> 1109</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i            = 0; i &lt; DampingLambdaSqV.GetLength(); i++)</div>
<div class="line"><span class="lineno"> 1110</span>    DampingLambdaSqV[i] = DampingLambdaSq;</div>
<div class="line"><span class="lineno"> 1111</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i           = 0; i &lt; diagMatIdentity.GetLength(); i++)</div>
<div class="line"><span class="lineno"> 1112</span>    diagMatIdentity[i] = 1.0;</div>
<div class="line"><span class="lineno"> 1113</span>  <span class="comment">// DampingLambdaSDLS = 1.5*DefaultDampingLambda;</span></div>
<div class="line"><span class="lineno"> 1114</span> </div>
<div class="line"><span class="lineno"> 1115</span>  dSclamp.Fill(HUGE_VAL);</div>
<div class="line"><span class="lineno"> 1116</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a61c48f4ac57b20c0b007dde2d8f6038c" name="a61c48f4ac57b20c0b007dde2d8f6038c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a61c48f4ac57b20c0b007dde2d8f6038c">&#9670;&nbsp;</a></span>SetCurrentMode()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::SetCurrentMode </td>
          <td>(</td>
          <td class="paramtype">UpdateMode&#160;</td>
          <td class="paramname"><em>mode</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  671</span>{ CurrentUpdateMode = mode; }</div>
</div><!-- fragment -->
</div>
</div>
<a id="ad8fb54d90eb0fe47b0a1818f6818288f" name="ad8fb54d90eb0fe47b0a1818f6818288f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad8fb54d90eb0fe47b0a1818f6818288f">&#9670;&nbsp;</a></span>SetDampingDLS()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::SetDampingDLS </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>lambda</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  673</span>                                    {</div>
<div class="line"><span class="lineno">  674</span>    DampingLambda   = lambda;</div>
<div class="line"><span class="lineno">  675</span>    DampingLambdaSq = lambda * lambda;</div>
<div class="line"><span class="lineno">  676</span>  }</div>
</div><!-- fragment -->
</div>
</div>
<a id="a24eeaefbe56036da7af4a77e66f7891c" name="a24eeaefbe56036da7af4a77e66f7891c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a24eeaefbe56036da7af4a77e66f7891c">&#9670;&nbsp;</a></span>setTarget()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::setTarget </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_t_point_t.html">TPointD</a>&#160;</td>
          <td class="paramname"><em>targetPos</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno">  656</span>{ target[i] = targetPos; }</div>
</div><!-- fragment -->
</div>
</div>
<a id="a30a78448bc6bfa73d9c06a149bb9ff9e" name="a30a78448bc6bfa73d9c06a149bb9ff9e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a30a78448bc6bfa73d9c06a149bb9ff9e">&#9670;&nbsp;</a></span>UpdatedSClampValue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::UpdatedSClampValue </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1595</span>                                  {</div>
<div class="line"><span class="lineno"> 1596</span>  <span class="comment">// Traverse skeleton to find all end effectors</span></div>
<div class="line"><span class="lineno"> 1597</span>  <a class="code hl_class" href="class_t_point_t.html">TPointD</a> temp;</div>
<div class="line"><span class="lineno"> 1598</span> </div>
<div class="line"><span class="lineno"> 1599</span>  <span class="keywordtype">int</span> numNode = skeleton-&gt;getNodeCount();</div>
<div class="line"><span class="lineno"> 1600</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numNode; i++) {</div>
<div class="line"><span class="lineno"> 1601</span>    <a class="code hl_class" href="class_i_k_node.html">IKNode</a> *n = skeleton-&gt;getNode(i);</div>
<div class="line"><span class="lineno"> 1602</span>    <span class="keywordflow">if</span> (n-&gt;IsEffector()) {</div>
<div class="line"><span class="lineno"> 1603</span>      <span class="keywordtype">int</span> i                    = n-&gt;getEffectorNum();</div>
<div class="line"><span class="lineno"> 1604</span>      <span class="keyword">const</span> <a class="code hl_class" href="class_t_point_t.html">TPointD</a> &amp;targetPos = target[i];</div>
<div class="line"><span class="lineno"> 1605</span> </div>
<div class="line"><span class="lineno"> 1606</span>      <span class="comment">// Compute the delta S value (differences from end effectors to target</span></div>
<div class="line"><span class="lineno"> 1607</span>      <span class="comment">// positions.</span></div>
<div class="line"><span class="lineno"> 1608</span>      <span class="comment">// While we are at it, also update the clamping values in dSclamp;</span></div>
<div class="line"><span class="lineno"> 1609</span>      temp = targetPos;</div>
<div class="line"><span class="lineno"> 1610</span>      temp -= n-&gt;GetS();</div>
<div class="line"><span class="lineno"> 1611</span>      <span class="keywordtype">double</span> normSi      = sqrt(Square(dS[i]) + Square(dS[i + 1]));</div>
<div class="line"><span class="lineno"> 1612</span>      <span class="keywordtype">double</span> norma       = sqrt(temp.x * temp.x + temp.y * temp.y);</div>
<div class="line"><span class="lineno"> 1613</span>      <span class="keywordtype">double</span> changedDist = norma - normSi;</div>
<div class="line"><span class="lineno"> 1614</span> </div>
<div class="line"><span class="lineno"> 1615</span>      <span class="keywordflow">if</span> (changedDist &gt; 0.0) {</div>
<div class="line"><span class="lineno"> 1616</span>        dSclamp[i] = BaseMaxTargetDist + changedDist;</div>
<div class="line"><span class="lineno"> 1617</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1618</span>        dSclamp[i] = BaseMaxTargetDist;</div>
<div class="line"><span class="lineno"> 1619</span>      }</div>
<div class="line"><span class="lineno"> 1620</span>    }</div>
<div class="line"><span class="lineno"> 1621</span>  }</div>
<div class="line"><span class="lineno"> 1622</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="abb9b64db63ca485a053724d9b251a4dc" name="abb9b64db63ca485a053724d9b251a4dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abb9b64db63ca485a053724d9b251a4dc">&#9670;&nbsp;</a></span>UpdateThetas()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::UpdateThetas </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1178</span>                            {</div>
<div class="line"><span class="lineno"> 1179</span>  <span class="comment">// Update the joint angles</span></div>
<div class="line"><span class="lineno"> 1180</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> index = 0; index &lt; skeleton-&gt;getNodeCount(); index++) {</div>
<div class="line"><span class="lineno"> 1181</span>    <a class="code hl_class" href="class_i_k_node.html">IKNode</a> *n = skeleton-&gt;getNode(index);</div>
<div class="line"><span class="lineno"> 1182</span>    <span class="keywordflow">if</span> (n-&gt;IsJoint()) {</div>
<div class="line"><span class="lineno"> 1183</span>      <span class="keywordtype">int</span> i = n-&gt;getJointNum();</div>
<div class="line"><span class="lineno"> 1184</span>      n-&gt;AddToTheta(dTheta[i]);</div>
<div class="line"><span class="lineno"> 1185</span>    }</div>
<div class="line"><span class="lineno"> 1186</span>  }</div>
<div class="line"><span class="lineno"> 1187</span>  <span class="comment">// Aggiorno le posizioni dei joint</span></div>
<div class="line"><span class="lineno"> 1188</span>  skeleton-&gt;compute();</div>
<div class="line"><span class="lineno"> 1189</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa7e8f89f2e5da915147a31590c3364cf" name="aa7e8f89f2e5da915147a31590c3364cf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa7e8f89f2e5da915147a31590c3364cf">&#9670;&nbsp;</a></span>ZeroDeltaThetas()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Jacobian::ZeroDeltaThetas </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="fragment"><div class="line"><span class="lineno"> 1217</span>{ dTheta.SetZero(); }</div>
</div><!-- fragment -->
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>E:/opentoonz/toonz/sources/include/toonz/<a class="el" href="">ikjacobian.h</a></li>
<li>E:/opentoonz/toonz/sources/toonzlib/<a class="el" href="">ikjacobian.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
