\hypertarget{class_expression_reference_manager}{}\doxysection{Expression\+Reference\+Manager Class Reference}
\label{class_expression_reference_manager}\index{ExpressionReferenceManager@{ExpressionReferenceManager}}
Inheritance diagram for Expression\+Reference\+Manager\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=1.812298cm]{class_expression_reference_manager}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_expression_reference_manager_affd3e8adaae9434ee16687ecfdc2b8c2}{on\+Change}} (const \mbox{\hyperlink{class_t_xsheet_column_change}{TXsheet\+Column\+Change}} \&) override
\item 
void \mbox{\hyperlink{class_expression_reference_manager_a4d54224e6a10ce8ad4ad7b240f7ca83e}{on\+Fx\+Added}} (const std\+::vector$<$ \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$ $>$ \&) override
\item 
void \mbox{\hyperlink{class_expression_reference_manager_a9e8a79c8f31bb93344012e3fd10880fe}{on\+Stage\+Object\+Added}} (const \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}}) override
\item 
bool \mbox{\hyperlink{class_expression_reference_manager_a7d2193f2d7d439abeccbda3ce860db81}{is\+Ignored}} (\mbox{\hyperlink{class_t_double_param}{TDouble\+Param}} $\ast$) override
\item 
void \mbox{\hyperlink{class_expression_reference_manager_ac64d64709176e3a2d6b664922482f035}{on\+Change}} (const \mbox{\hyperlink{class_t_param_change}{TParam\+Change}} \&) override
\item 
void \mbox{\hyperlink{class_expression_reference_manager_a2e2d0ac0da62c69ccbde1d5cc8512dc5}{init}} ()
\item 
bool \mbox{\hyperlink{class_expression_reference_manager_a99fa4657a707d4218d896327f74fdf83}{check\+Reference\+Deletion}} (const QSet$<$ int $>$ \&column\+Ids\+To\+Be\+Deleted, const QSet$<$ \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$ $>$ \&fxs\+To\+Be\+Deleted, const QList$<$ \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}} $>$ \&obj\+Ids\+To\+Be\+Duplicated, bool check\+Invert)
\item 
bool \mbox{\hyperlink{class_expression_reference_manager_a6734d6136f2fdec15024ee1c486ff325}{check\+Reference\+Deletion}} (const QList$<$ \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}} $>$ \&object\+Ids\+To\+Be\+Deleted)
\item 
bool \mbox{\hyperlink{class_expression_reference_manager_a9e51344bb93545f5d1022a11de10e192}{check\+Explode}} (\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$child\+Xsh, int index, bool remove\+Column, bool columns\+Only)
\item 
void \mbox{\hyperlink{class_expression_reference_manager_a23888deaef18d64449c53e7f38c216e0}{transfer\+Reference}} (\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$from\+Xsh, \mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$to\+Xsh, const QMap$<$ \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}}, \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}} $>$ \&id\+Table, const QMap$<$ \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$, \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$ $>$ \&fx\+Table)
\item 
bool \mbox{\hyperlink{class_expression_reference_manager_a4b8c5db759d1e2518441d094ff765565}{ask\+If\+Param\+Is\+Ignored\+On\+Save}} (bool save\+Sub\+Xsheet)
\item 
void \mbox{\hyperlink{class_expression_reference_manager_aca9cda487e4d479576864a3c982cbfd2}{refresh\+Xsheet\+Ref\+Info}} (\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$xsh)
\end{DoxyCompactItemize}
\doxysubsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static \mbox{\hyperlink{class_expression_reference_manager}{Expression\+Reference\+Manager}} $\ast$ \mbox{\hyperlink{class_expression_reference_manager_a12cddd2c05db89867f7e92f6e8a11c64}{instance}} ()
\end{DoxyCompactItemize}
\doxysubsection*{Protected Slots}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_expression_reference_manager_abc948b79e4ebe2a3ecca428bc289b820}{on\+Scene\+Switched}} ()
\item 
void \mbox{\hyperlink{class_expression_reference_manager_acb993d77ffad5e7502b5a187dbb8e0d1}{on\+Xsheet\+Switched}} ()
\item 
void \mbox{\hyperlink{class_expression_reference_manager_a2b51ae09599f187a45b87c8ff33b2c38}{on\+Xsheet\+Changed}} ()
\item 
void \mbox{\hyperlink{class_expression_reference_manager_aec044254071c31e669b8f3ac5cbf358c}{on\+Preference\+Changed}} (const QString \&pref\+Name)
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_expression_reference_manager_a4b8c5db759d1e2518441d094ff765565}\label{class_expression_reference_manager_a4b8c5db759d1e2518441d094ff765565}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!askIfParamIsIgnoredOnSave@{askIfParamIsIgnoredOnSave}}
\index{askIfParamIsIgnoredOnSave@{askIfParamIsIgnoredOnSave}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{askIfParamIsIgnoredOnSave()}{askIfParamIsIgnoredOnSave()}}
{\footnotesize\ttfamily bool Expression\+Reference\+Manager\+::ask\+If\+Param\+Is\+Ignored\+On\+Save (\begin{DoxyParamCaption}\item[{bool}]{save\+Sub\+Xsheet }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00992                                                                              \{}
\DoxyCodeLine{00993   \textcolor{comment}{// return if the preference option is off}}
\DoxyCodeLine{00994   \textcolor{keywordtype}{bool} on =}
\DoxyCodeLine{00995       Preferences::instance()-\/>isModifyExpressionOnMovingReferencesEnabled();}
\DoxyCodeLine{00996   \textcolor{keywordflow}{if} (!on) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00997   QSet<TXsheet*> xsheetSet;}
\DoxyCodeLine{00998   \mbox{\hyperlink{class_t_xsheet}{TXsheet}}* parentXsh;}
\DoxyCodeLine{00999   \textcolor{keywordflow}{if} (saveSubXsheet)  \textcolor{comment}{// check only inside the current xsheet}}
\DoxyCodeLine{01000     parentXsh = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}()-\/>getXsheet();}
\DoxyCodeLine{01001   \textcolor{keywordflow}{else}  \textcolor{comment}{// check whole xsheets from the top}}
\DoxyCodeLine{01002     parentXsh = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_abbbf1fae564e9e510826eda4f6637d20}{getCurrentScene}}()-\/>getScene()-\/>\mbox{\hyperlink{class_toonz_scene_aaffd562eebbd8faba4caeaed69bfcc18}{getTopXsheet}}();}
\DoxyCodeLine{01003 }
\DoxyCodeLine{01004   gatherXsheets(parentXsh, xsheetSet);}
\DoxyCodeLine{01005 }
\DoxyCodeLine{01006   \textcolor{comment}{// gather the ignored parameter names}}
\DoxyCodeLine{01007   QStringList ignoredParamNames;}
\DoxyCodeLine{01008   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} xsh : xsheetSet) \{}
\DoxyCodeLine{01009     \textcolor{keywordtype}{bool} isParent = (xsh == parentXsh);}
\DoxyCodeLine{01010     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} itr = info(xsh).begin(); itr != info(xsh).end(); itr++) \{}
\DoxyCodeLine{01011       \textcolor{keywordflow}{if} (!itr.value().ignored()) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01012       QString paramName = itr.value().name();}
\DoxyCodeLine{01013       \textcolor{keywordflow}{if} (!isParent) paramName += \textcolor{stringliteral}{"{}  "{}} + tr(\textcolor{stringliteral}{"{}(In a sub xsheet)"{}});}
\DoxyCodeLine{01014       ignoredParamNames.append(paramName);}
\DoxyCodeLine{01015     \}}
\DoxyCodeLine{01016   \}}
\DoxyCodeLine{01017 }
\DoxyCodeLine{01018   \textcolor{comment}{// return if there is not ignored parameters}}
\DoxyCodeLine{01019   \textcolor{keywordflow}{if} (ignoredParamNames.isEmpty()) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{01020 }
\DoxyCodeLine{01021   \textcolor{comment}{// open warning popup}}
\DoxyCodeLine{01022   QString warningTxt =}
\DoxyCodeLine{01023       tr(\textcolor{stringliteral}{"{}Following parameters may contain broken references in expressions:"{}});}
\DoxyCodeLine{01024   warningTxt += \textcolor{stringliteral}{"{}\(\backslash\)n  "{}} + ignoredParamNames.join(\textcolor{stringliteral}{"{}\(\backslash\)n  "{}});}
\DoxyCodeLine{01025   warningTxt += \textcolor{stringliteral}{"{}\(\backslash\)n"{}} + tr(\textcolor{stringliteral}{"{}Do you want to save the scene anyway ?"{}});}
\DoxyCodeLine{01026 }
\DoxyCodeLine{01027   \textcolor{keywordtype}{int} ret =}
\DoxyCodeLine{01028       DVGui::MsgBox(warningTxt, QObject::tr(\textcolor{stringliteral}{"{}Save"{}}), QObject::tr(\textcolor{stringliteral}{"{}Cancel"{}}), 0);}
\DoxyCodeLine{01029   \textcolor{keywordflow}{if} (ret == 0 || ret == 2) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01030 }
\DoxyCodeLine{01031   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{01032 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a9e51344bb93545f5d1022a11de10e192}\label{class_expression_reference_manager_a9e51344bb93545f5d1022a11de10e192}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!checkExplode@{checkExplode}}
\index{checkExplode@{checkExplode}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{checkExplode()}{checkExplode()}}
{\footnotesize\ttfamily bool Expression\+Reference\+Manager\+::check\+Explode (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$}]{child\+Xsh,  }\item[{int}]{index,  }\item[{bool}]{remove\+Column,  }\item[{bool}]{columns\+Only }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00707                                                                 \{}
\DoxyCodeLine{00708   \textcolor{comment}{// return if the preference option is off}}
\DoxyCodeLine{00709   \textcolor{keywordtype}{bool} on =}
\DoxyCodeLine{00710       Preferences::instance()-\/>isModifyExpressionOnMovingReferencesEnabled();}
\DoxyCodeLine{00711   \textcolor{keywordflow}{if} (!on) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00712 }
\DoxyCodeLine{00713   QSet<TDoubleParam*> mainCautionParams, subCautionParams;}
\DoxyCodeLine{00714   \textcolor{keywordflow}{if} (removeColumn) \{}
\DoxyCodeLine{00715     \textcolor{comment}{// find params referring to the sub xsheet column to be exploded and removed}}
\DoxyCodeLine{00716     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} itr = info().begin(); itr != info().end(); itr++) \{}
\DoxyCodeLine{00717       \textcolor{keywordflow}{if} (itr.value().colRefMap().contains(index))}
\DoxyCodeLine{00718         mainCautionParams.insert(itr.key());}
\DoxyCodeLine{00719     \}}
\DoxyCodeLine{00720   \}}
\DoxyCodeLine{00721 }
\DoxyCodeLine{00722   m\_model-\/>refreshData(childXsh);}
\DoxyCodeLine{00723   \textcolor{comment}{// find params referring to the stage params to be deleted}}
\DoxyCodeLine{00724   QList<TDoubleParam*> stageParamsToBeDeleted;}
\DoxyCodeLine{00725   \mbox{\hyperlink{class_t_stage_object}{TStageObject}}* table = childXsh-\/>\mbox{\hyperlink{class_t_xsheet_a13d9b9c08ca8dde39769f5644e046ee5}{getStageObject}}(TStageObjectId::TableId);}
\DoxyCodeLine{00726   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00727     \mbox{\hyperlink{class_stage_object_channel_group}{StageObjectChannelGroup}}* socg = \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_stage_object_channel_group}{StageObjectChannelGroup}}*\textcolor{keyword}{>}(}
\DoxyCodeLine{00728         m\_model-\/>getStageObjectChannel(i));}
\DoxyCodeLine{00729     \textcolor{keywordflow}{if} (!socg) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00730     \mbox{\hyperlink{class_t_stage_object_id}{TStageObjectId}} \textcolor{keywordtype}{id} = socg-\/>getStageObject()-\/>\mbox{\hyperlink{class_t_stage_object_a7acac7f9d2b8aabae125a81cc4ac5b10}{getId}}();}
\DoxyCodeLine{00731     \textcolor{keywordflow}{if} ((columnsOnly \&\& !\textcolor{keywordtype}{id}.isColumn()) ||}
\DoxyCodeLine{00732         (!columnsOnly \&\& !socg-\/>getStageObject()-\/>\mbox{\hyperlink{class_t_stage_object_a2793ff9c084eaeb949eef18f06f0a781}{isAncestor}}(table)))}
\DoxyCodeLine{00733       gatherParams(socg, stageParamsToBeDeleted);}
\DoxyCodeLine{00734   \}}
\DoxyCodeLine{00735   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} itr = info(childXsh).begin(); itr != info(childXsh).end(); itr++) \{}
\DoxyCodeLine{00736     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} refParam : itr.value().paramRefMap()) \{}
\DoxyCodeLine{00737       \textcolor{keywordflow}{if} (stageParamsToBeDeleted.contains(refParam)) \{}
\DoxyCodeLine{00738         subCautionParams.insert(itr.key());}
\DoxyCodeLine{00739         \textcolor{keywordflow}{break};}
\DoxyCodeLine{00740       \}}
\DoxyCodeLine{00741     \}}
\DoxyCodeLine{00742   \}}
\DoxyCodeLine{00743 }
\DoxyCodeLine{00744   \textcolor{comment}{// remove parameters from the list which itself will be deleted}}
\DoxyCodeLine{00745   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = subCautionParams.begin(); it != subCautionParams.end();)}
\DoxyCodeLine{00746     \textcolor{keywordflow}{if} (stageParamsToBeDeleted.contains(*it))}
\DoxyCodeLine{00747       it = subCautionParams.erase(it);}
\DoxyCodeLine{00748     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00749       ++it;}
\DoxyCodeLine{00750 }
\DoxyCodeLine{00751   \mbox{\hyperlink{class_t_xsheet}{TXsheet}}* currentXsh = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}()-\/>getXsheet();}
\DoxyCodeLine{00752   m\_model-\/>refreshData(currentXsh);}
\DoxyCodeLine{00753 }
\DoxyCodeLine{00754   \textcolor{comment}{// return true if there is no parameters which will lose references}}
\DoxyCodeLine{00755   \textcolor{keywordflow}{if} (mainCautionParams.isEmpty() \&\& subCautionParams.isEmpty()) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00756 }
\DoxyCodeLine{00757   \textcolor{comment}{// open warning popup}}
\DoxyCodeLine{00758   QString warningTxt =}
\DoxyCodeLine{00759       tr(\textcolor{stringliteral}{"{}Following parameters will lose reference in expressions:"{}});}
\DoxyCodeLine{00760   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} param : mainCautionParams) \{}
\DoxyCodeLine{00761     warningTxt +=}
\DoxyCodeLine{00762         \textcolor{stringliteral}{"{}\(\backslash\)n  "{}} + touchInfo(param).name() + \textcolor{stringliteral}{"{}  "{}} + tr(\textcolor{stringliteral}{"{}(In the current xsheet)"{}});}
\DoxyCodeLine{00763   \}}
\DoxyCodeLine{00764   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} param : subCautionParams) \{}
\DoxyCodeLine{00765     warningTxt += \textcolor{stringliteral}{"{}\(\backslash\)n  "{}} + touchInfo(param, childXsh).name() + \textcolor{stringliteral}{"{}  "{}} +}
\DoxyCodeLine{00766                   tr(\textcolor{stringliteral}{"{}(To be brought from the subxsheet)"{}});}
\DoxyCodeLine{00767   \}}
\DoxyCodeLine{00768   warningTxt += tr(\textcolor{stringliteral}{"{}\(\backslash\)nDo you want to explode anyway ?"{}});}
\DoxyCodeLine{00769 }
\DoxyCodeLine{00770   \textcolor{keywordtype}{int} ret = DVGui::MsgBox(warningTxt, QObject::tr(\textcolor{stringliteral}{"{}Explode"{}}),}
\DoxyCodeLine{00771                           QObject::tr(\textcolor{stringliteral}{"{}Cancel"{}}), 0);}
\DoxyCodeLine{00772   \textcolor{keywordflow}{if} (ret == 0 || ret == 2) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{00773 }
\DoxyCodeLine{00774   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00775 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a6734d6136f2fdec15024ee1c486ff325}\label{class_expression_reference_manager_a6734d6136f2fdec15024ee1c486ff325}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!checkReferenceDeletion@{checkReferenceDeletion}}
\index{checkReferenceDeletion@{checkReferenceDeletion}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{checkReferenceDeletion()}{checkReferenceDeletion()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily bool Expression\+Reference\+Manager\+::check\+Reference\+Deletion (\begin{DoxyParamCaption}\item[{const QList$<$ \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}} $>$ \&}]{object\+Ids\+To\+Be\+Deleted }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00656                                                        \{}
\DoxyCodeLine{00657   \textcolor{keywordtype}{bool} on =}
\DoxyCodeLine{00658       Preferences::instance()-\/>isModifyExpressionOnMovingReferencesEnabled();}
\DoxyCodeLine{00659   \textcolor{keywordflow}{if} (!on) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00660   QSet<int> columnIdsToBeDeleted;}
\DoxyCodeLine{00661   QSet<TFx*> fxsToBeDeleted;}
\DoxyCodeLine{00662 }
\DoxyCodeLine{00663   \mbox{\hyperlink{class_t_app}{TApp}}* app    = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}();}
\DoxyCodeLine{00664   \mbox{\hyperlink{class_t_xsheet}{TXsheet}}* xsh = app-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}()-\/>getXsheet();}
\DoxyCodeLine{00665   std::set<TFx*> leaves;}
\DoxyCodeLine{00666   \textcolor{comment}{// fx references should be checked when deleting columns}}
\DoxyCodeLine{00667   \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& objId : objectIdsToBeDeleted) \{}
\DoxyCodeLine{00668     \textcolor{keywordflow}{if} (objId.isColumn()) \{}
\DoxyCodeLine{00669       \textcolor{keywordtype}{int} index = objId.getIndex();}
\DoxyCodeLine{00670       \textcolor{keywordflow}{if} (index < 0) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00671       \mbox{\hyperlink{class_t_xsh_column}{TXshColumn}}* column = xsh-\/>\mbox{\hyperlink{class_t_xsheet_a3e1a216c019a0ebdf73d95acac95d8d0}{getColumn}}(index);}
\DoxyCodeLine{00672       \textcolor{keywordflow}{if} (!column) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00673       columnIdsToBeDeleted.insert(index);}
\DoxyCodeLine{00674       \mbox{\hyperlink{class_t_fx}{TFx}}* fx = column-\/>getFx();}
\DoxyCodeLine{00675       \textcolor{keywordflow}{if} (fx) \{}
\DoxyCodeLine{00676         leaves.insert(fx);}
\DoxyCodeLine{00677         \mbox{\hyperlink{class_t_zerary_column_fx}{TZeraryColumnFx}}* zcfx = \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_t_zerary_column_fx}{TZeraryColumnFx}}*\textcolor{keyword}{>}(fx);}
\DoxyCodeLine{00678         \textcolor{keywordflow}{if} (zcfx) fxsToBeDeleted.insert(zcfx-\/>getZeraryFx());}
\DoxyCodeLine{00679       \}}
\DoxyCodeLine{00680     \}}
\DoxyCodeLine{00681   \}}
\DoxyCodeLine{00682   \textcolor{comment}{// store fx to be deleted along with columns}}
\DoxyCodeLine{00683   \mbox{\hyperlink{class_t_fx_set}{TFxSet}}* fxSet = xsh-\/>\mbox{\hyperlink{class_t_xsheet_adc7c74cce346abf3699bb250eb17a9c2}{getFxDag}}()-\/>getInternalFxs();}
\DoxyCodeLine{00684   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < fxSet-\/>getFxCount(); i++) \{}
\DoxyCodeLine{00685     \mbox{\hyperlink{class_t_fx}{TFx}}* fx = fxSet-\/>getFx(i);}
\DoxyCodeLine{00686     \textcolor{keywordflow}{if} (canRemoveFx(leaves, fx)) fxsToBeDeleted.insert(fx);}
\DoxyCodeLine{00687   \}}
\DoxyCodeLine{00688   QList<TStageObjectId> dummy;}
\DoxyCodeLine{00689 }
\DoxyCodeLine{00690   \textcolor{keywordflow}{return} doCheckReferenceDeletion(columnIdsToBeDeleted, fxsToBeDeleted,}
\DoxyCodeLine{00691                                   objectIdsToBeDeleted, dummy);}
\DoxyCodeLine{00692 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a99fa4657a707d4218d896327f74fdf83}\label{class_expression_reference_manager_a99fa4657a707d4218d896327f74fdf83}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!checkReferenceDeletion@{checkReferenceDeletion}}
\index{checkReferenceDeletion@{checkReferenceDeletion}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{checkReferenceDeletion()}{checkReferenceDeletion()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily bool Expression\+Reference\+Manager\+::check\+Reference\+Deletion (\begin{DoxyParamCaption}\item[{const QSet$<$ int $>$ \&}]{column\+Ids\+To\+Be\+Deleted,  }\item[{const QSet$<$ \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$ $>$ \&}]{fxs\+To\+Be\+Deleted,  }\item[{const QList$<$ \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}} $>$ \&}]{obj\+Ids\+To\+Be\+Duplicated,  }\item[{bool}]{check\+Invert }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00640                                                                          \{}
\DoxyCodeLine{00641   \textcolor{keywordtype}{bool} on =}
\DoxyCodeLine{00642       Preferences::instance()-\/>isModifyExpressionOnMovingReferencesEnabled();}
\DoxyCodeLine{00643   \textcolor{keywordflow}{if} (!on) \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{00644   QList<TStageObjectId> objectIdsToBeDeleted;}
\DoxyCodeLine{00645   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} colId : columnIdsToBeDeleted)}
\DoxyCodeLine{00646     objectIdsToBeDeleted.append(TStageObjectId::ColumnId(colId));}
\DoxyCodeLine{00647 }
\DoxyCodeLine{00648   \textcolor{keywordflow}{return} doCheckReferenceDeletion(columnIdsToBeDeleted, fxsToBeDeleted,}
\DoxyCodeLine{00649                                   objectIdsToBeDeleted, objIdsToBeDuplicated,}
\DoxyCodeLine{00650                                   checkInvert);}
\DoxyCodeLine{00651 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a2e2d0ac0da62c69ccbde1d5cc8512dc5}\label{class_expression_reference_manager_a2e2d0ac0da62c69ccbde1d5cc8512dc5}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!init@{init}}
\index{init@{init}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{init()}{init()}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::init (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00164                                       \{}
\DoxyCodeLine{00165   connect(\mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>getCurrentScene(),}
\DoxyCodeLine{00166           SIGNAL(preferenceChanged(\textcolor{keyword}{const} QString\&)), \textcolor{keyword}{this},}
\DoxyCodeLine{00167           SLOT(onPreferenceChanged(\textcolor{keyword}{const} QString\&)));}
\DoxyCodeLine{00168   onPreferenceChanged(\textcolor{stringliteral}{"{}modifyExpressionOnMovingReferences"{}});}
\DoxyCodeLine{00169 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a12cddd2c05db89867f7e92f6e8a11c64}\label{class_expression_reference_manager_a12cddd2c05db89867f7e92f6e8a11c64}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!instance@{instance}}
\index{instance@{instance}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{instance()}{instance()}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_expression_reference_manager}{Expression\+Reference\+Manager}} $\ast$ Expression\+Reference\+Manager\+::instance (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00210                                                                  \{}
\DoxyCodeLine{00211   \textcolor{keyword}{static} \mbox{\hyperlink{class_expression_reference_manager}{ExpressionReferenceManager}} \_instance;}
\DoxyCodeLine{00212   \textcolor{keywordflow}{return} \&\_instance;}
\DoxyCodeLine{00213 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a7d2193f2d7d439abeccbda3ce860db81}\label{class_expression_reference_manager_a7d2193f2d7d439abeccbda3ce860db81}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!isIgnored@{isIgnored}}
\index{isIgnored@{isIgnored}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{isIgnored()}{isIgnored()}}
{\footnotesize\ttfamily bool Expression\+Reference\+Manager\+::is\+Ignored (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_double_param}{TDouble\+Param}} $\ast$}]{param }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_xsheet_column_change_observer}{TXsheet\+Column\+Change\+Observer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00433                                                               \{}
\DoxyCodeLine{00434   \textcolor{keywordflow}{return} touchInfo(param).ignored();}
\DoxyCodeLine{00435 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_ac64d64709176e3a2d6b664922482f035}\label{class_expression_reference_manager_ac64d64709176e3a2d6b664922482f035}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onChange@{onChange}}
\index{onChange@{onChange}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onChange()}{onChange()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Change (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_param_change}{TParam\+Change}} \&}]{change }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_param_observer}{TParam\+Observer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00439                                                                     \{}
\DoxyCodeLine{00440   \textcolor{comment}{// do nothing if the change is due to this manager itself}}
\DoxyCodeLine{00441   \textcolor{keywordflow}{if} (m\_blockParamChange) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00442   \textcolor{comment}{// do nothing if keyframe does not change or while dragging}}
\DoxyCodeLine{00443   \textcolor{keywordflow}{if} (!change.m\_keyframeChanged || change.m\_dragging) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00444   \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* curve = \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_t_double_param}{TDoubleParam}}*\textcolor{keyword}{>}(change.m\_param);}
\DoxyCodeLine{00445   \textcolor{keywordflow}{if} (!curve) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00446   \textcolor{keywordtype}{bool} hasRef = refreshParamsRef(curve, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00447   \textcolor{keywordflow}{if} (hasRef) \{}
\DoxyCodeLine{00448     \mbox{\hyperlink{class_function_tree_model_1_1_channel}{FunctionTreeModel::Channel}}* channel = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00449     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00450       channel = findChannel(curve, m\_model-\/>getStageObjectChannel(i));}
\DoxyCodeLine{00451       \textcolor{keywordflow}{if} (channel) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00452     \}}
\DoxyCodeLine{00453     \textcolor{keywordflow}{if} (!channel) \{}
\DoxyCodeLine{00454       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00455         channel = findChannel(curve, m\_model-\/>getFxChannel(i));}
\DoxyCodeLine{00456         \textcolor{keywordflow}{if} (channel) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00457       \}}
\DoxyCodeLine{00458     \}}
\DoxyCodeLine{00459     \textcolor{keywordflow}{if} (channel) \{}
\DoxyCodeLine{00460       touchInfo(curve).name() = channel-\/>getLongName();}
\DoxyCodeLine{00461     \}}
\DoxyCodeLine{00462 }
\DoxyCodeLine{00463     \textcolor{keywordflow}{if} (touchInfo(curve).ignored()) \{}
\DoxyCodeLine{00464       DVGui::info(tr(\textcolor{stringliteral}{"{}Expression monitoring restarted: \(\backslash\)"{}\%1\(\backslash\)"{}"{}})}
\DoxyCodeLine{00465                       .arg(touchInfo(curve).name()));}
\DoxyCodeLine{00466       touchInfo(curve).ignored() = \textcolor{keyword}{false};}
\DoxyCodeLine{00467     \}}
\DoxyCodeLine{00468   \}}
\DoxyCodeLine{00469 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_affd3e8adaae9434ee16687ecfdc2b8c2}\label{class_expression_reference_manager_affd3e8adaae9434ee16687ecfdc2b8c2}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onChange@{onChange}}
\index{onChange@{onChange}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onChange()}{onChange()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Change (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_xsheet_column_change}{TXsheet\+Column\+Change}} \&}]{change }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_xsheet_column_change_observer}{TXsheet\+Column\+Change\+Observer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00370                                                                            \{}
\DoxyCodeLine{00371   \mbox{\hyperlink{class_t_xsheet}{TXsheet}}* xsh = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}()-\/>getXsheet();}
\DoxyCodeLine{00372   QMap<TStageObjectId, TStageObjectId> idTable;}
\DoxyCodeLine{00373 }
\DoxyCodeLine{00374   \textcolor{keyword}{auto} setIds = [\&](\textcolor{keywordtype}{int} from, \textcolor{keywordtype}{int} to) \{}
\DoxyCodeLine{00375     idTable.insert(TStageObjectId::ColumnId(from),}
\DoxyCodeLine{00376                    TStageObjectId::ColumnId(to));}
\DoxyCodeLine{00377   \};}
\DoxyCodeLine{00378 }
\DoxyCodeLine{00379   \textcolor{keywordflow}{switch} (change.m\_type) \{}
\DoxyCodeLine{00380   \textcolor{keywordflow}{case} TXsheetColumnChange::Insert: \{}
\DoxyCodeLine{00381     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = xsh-\/>\mbox{\hyperlink{class_t_xsheet_a17464dc5617cf87a46f03e1a52d36cc1}{getColumnCount}}() -\/ 2; c >= change.m\_index1; c-\/-\/) \{}
\DoxyCodeLine{00382       setIds(c, c + 1);}
\DoxyCodeLine{00383     \}}
\DoxyCodeLine{00384   \} \textcolor{keywordflow}{break};}
\DoxyCodeLine{00385   \textcolor{keywordflow}{case} TXsheetColumnChange::Remove: \{}
\DoxyCodeLine{00386     \textcolor{comment}{// update ignore info}}
\DoxyCodeLine{00387     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = info().begin(); it != info().end(); it++) \{}
\DoxyCodeLine{00388       \textcolor{keywordflow}{if} (it.value().colRefMap().contains(change.m\_index1))}
\DoxyCodeLine{00389         it.value().ignored() = \textcolor{keyword}{true};}
\DoxyCodeLine{00390     \}}
\DoxyCodeLine{00391     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = change.m\_index1; c < xsh-\/>getColumnCount(); c++) \{}
\DoxyCodeLine{00392       setIds(c + 1, c);}
\DoxyCodeLine{00393     \}}
\DoxyCodeLine{00394   \} \textcolor{keywordflow}{break};}
\DoxyCodeLine{00395   \textcolor{keywordflow}{case} TXsheetColumnChange::Move: \{}
\DoxyCodeLine{00396     \textcolor{keywordflow}{if} (change.m\_index1 < change.m\_index2) \{}
\DoxyCodeLine{00397       setIds(change.m\_index1, change.m\_index2);}
\DoxyCodeLine{00398       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = change.m\_index1 + 1; c <= change.m\_index2; c++) \{}
\DoxyCodeLine{00399         setIds(c, c -\/ 1);}
\DoxyCodeLine{00400       \}}
\DoxyCodeLine{00401     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00402       setIds(change.m\_index1, change.m\_index2);}
\DoxyCodeLine{00403       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = change.m\_index2; c < change.m\_index1; c++) \{}
\DoxyCodeLine{00404         setIds(c, c + 1);}
\DoxyCodeLine{00405       \}}
\DoxyCodeLine{00406     \}}
\DoxyCodeLine{00407   \} \textcolor{keywordflow}{break};}
\DoxyCodeLine{00408   \}}
\DoxyCodeLine{00409 }
\DoxyCodeLine{00410   \textcolor{comment}{// use empty map since the fxs does not transfer}}
\DoxyCodeLine{00411   QMap<TFx*, TFx*> fxTable;}
\DoxyCodeLine{00412   transferReference(xsh, xsh, idTable, fxTable);}
\DoxyCodeLine{00413 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a4d54224e6a10ce8ad4ad7b240f7ca83e}\label{class_expression_reference_manager_a4d54224e6a10ce8ad4ad7b240f7ca83e}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onFxAdded@{onFxAdded}}
\index{onFxAdded@{onFxAdded}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onFxAdded()}{onFxAdded()}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Fx\+Added (\begin{DoxyParamCaption}\item[{const std\+::vector$<$ \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$ $>$ \&}]{fxs }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_xsheet_column_change_observer}{TXsheet\+Column\+Change\+Observer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00415                                                                      \{}
\DoxyCodeLine{00416   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00417     \mbox{\hyperlink{class_fx_channel_group}{FxChannelGroup}}* fcg =}
\DoxyCodeLine{00418         \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_fx_channel_group}{FxChannelGroup}}*\textcolor{keyword}{>}(m\_model-\/>getFxChannel(i));}
\DoxyCodeLine{00419     \textcolor{keywordflow}{if} (fcg \&\& fxs.end() != std::find(fxs.begin(), fxs.end(), fcg-\/>getFx()))}
\DoxyCodeLine{00420       checkRef(fcg);}
\DoxyCodeLine{00421   \}}
\DoxyCodeLine{00422 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_aec044254071c31e669b8f3ac5cbf358c}\label{class_expression_reference_manager_aec044254071c31e669b8f3ac5cbf358c}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onPreferenceChanged@{onPreferenceChanged}}
\index{onPreferenceChanged@{onPreferenceChanged}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onPreferenceChanged}{onPreferenceChanged}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Preference\+Changed (\begin{DoxyParamCaption}\item[{const QString \&}]{pref\+Name }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}, {\ttfamily [slot]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00173                                                                             \{}
\DoxyCodeLine{00174   \textcolor{keywordflow}{if} (prefName != \textcolor{stringliteral}{"{}modifyExpressionOnMovingReferences"{}}) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00175 }
\DoxyCodeLine{00176   \mbox{\hyperlink{class_t_xsheet_handle}{TXsheetHandle}}* xshHandle  = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}();}
\DoxyCodeLine{00177   \mbox{\hyperlink{class_t_scene_handle}{TSceneHandle}}* sceneHandle = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_abbbf1fae564e9e510826eda4f6637d20}{getCurrentScene}}();}
\DoxyCodeLine{00178   \textcolor{keywordtype}{bool} on =}
\DoxyCodeLine{00179       Preferences::instance()-\/>isModifyExpressionOnMovingReferencesEnabled();}
\DoxyCodeLine{00180   \textcolor{keywordflow}{if} (on) \{}
\DoxyCodeLine{00181     \textcolor{comment}{// when the scene switched, refresh the all list}}
\DoxyCodeLine{00182     connect(sceneHandle, SIGNAL(sceneSwitched()), \textcolor{keyword}{this},}
\DoxyCodeLine{00183             SLOT(onSceneSwitched()));}
\DoxyCodeLine{00184     connect(xshHandle, SIGNAL(xsheetSwitched()), \textcolor{keyword}{this},}
\DoxyCodeLine{00185             SLOT(onXsheetSwitched()));}
\DoxyCodeLine{00186     connect(xshHandle, SIGNAL(xsheetChanged()), \textcolor{keyword}{this}, SLOT(onXsheetChanged()));}
\DoxyCodeLine{00187     onSceneSwitched();}
\DoxyCodeLine{00188   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00189     \textcolor{comment}{// when the scene switched, refresh the all list}}
\DoxyCodeLine{00190     disconnect(sceneHandle, SIGNAL(sceneSwitched()), \textcolor{keyword}{this},}
\DoxyCodeLine{00191                SLOT(onSceneSwitched()));}
\DoxyCodeLine{00192     disconnect(xshHandle, SIGNAL(xsheetSwitched()), \textcolor{keyword}{this},}
\DoxyCodeLine{00193                SLOT(onXsheetSwitched()));}
\DoxyCodeLine{00194     disconnect(xshHandle, SIGNAL(xsheetChanged()), \textcolor{keyword}{this},}
\DoxyCodeLine{00195                SLOT(onXsheetChanged()));}
\DoxyCodeLine{00196 }
\DoxyCodeLine{00197     \textcolor{comment}{// clear all monitor info}}
\DoxyCodeLine{00198     QSet<TXsheet*> allXsheets = getAllXsheets();}
\DoxyCodeLine{00199     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} xsh : allXsheets) \{}
\DoxyCodeLine{00200       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} curve : xsh-\/>getExpRefMonitor()-\/>info().keys())}
\DoxyCodeLine{00201         curve-\/>removeObserver(\textcolor{keyword}{this});}
\DoxyCodeLine{00202       xsh-\/>getExpRefMonitor()-\/>clearAll();}
\DoxyCodeLine{00203       xsh-\/>setObserver(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00204     \}}
\DoxyCodeLine{00205   \}}
\DoxyCodeLine{00206 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_abc948b79e4ebe2a3ecca428bc289b820}\label{class_expression_reference_manager_abc948b79e4ebe2a3ecca428bc289b820}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onSceneSwitched@{onSceneSwitched}}
\index{onSceneSwitched@{onSceneSwitched}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onSceneSwitched}{onSceneSwitched}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Scene\+Switched (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}, {\ttfamily [slot]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00293                                                  \{}
\DoxyCodeLine{00294   QSet<TXsheet*> allXsheets = getAllXsheets();}
\DoxyCodeLine{00295   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} xsh : allXsheets) \{}
\DoxyCodeLine{00296     xsh-\/>setObserver(\textcolor{keyword}{this});}
\DoxyCodeLine{00297 }
\DoxyCodeLine{00298     m\_model-\/>refreshData(xsh);}
\DoxyCodeLine{00299     xsh-\/>getExpRefMonitor()-\/>clearAll();}
\DoxyCodeLine{00300 }
\DoxyCodeLine{00301     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00302       checkRef(m\_model-\/>getStageObjectChannel(i), xsh);}
\DoxyCodeLine{00303     \}}
\DoxyCodeLine{00304     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00305       checkRef(m\_model-\/>getFxChannel(i), xsh);}
\DoxyCodeLine{00306     \}}
\DoxyCodeLine{00307   \}}
\DoxyCodeLine{00308   onXsheetSwitched();}
\DoxyCodeLine{00309 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a9e8a79c8f31bb93344012e3fd10880fe}\label{class_expression_reference_manager_a9e8a79c8f31bb93344012e3fd10880fe}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onStageObjectAdded@{onStageObjectAdded}}
\index{onStageObjectAdded@{onStageObjectAdded}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onStageObjectAdded()}{onStageObjectAdded()}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Stage\+Object\+Added (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}}}]{obj\+Id }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_xsheet_column_change_observer}{TXsheet\+Column\+Change\+Observer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00425                                 \{}
\DoxyCodeLine{00426   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00427     \mbox{\hyperlink{class_stage_object_channel_group}{StageObjectChannelGroup}}* socg = \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_stage_object_channel_group}{StageObjectChannelGroup}}*\textcolor{keyword}{>}(}
\DoxyCodeLine{00428         m\_model-\/>getStageObjectChannel(i));}
\DoxyCodeLine{00429     \textcolor{keywordflow}{if} (socg \&\& objId == socg-\/>getStageObject()-\/>\mbox{\hyperlink{class_t_stage_object_a7acac7f9d2b8aabae125a81cc4ac5b10}{getId}}()) checkRef(socg);}
\DoxyCodeLine{00430   \}}
\DoxyCodeLine{00431 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a2b51ae09599f187a45b87c8ff33b2c38}\label{class_expression_reference_manager_a2b51ae09599f187a45b87c8ff33b2c38}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onXsheetChanged@{onXsheetChanged}}
\index{onXsheetChanged@{onXsheetChanged}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onXsheetChanged}{onXsheetChanged}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Xsheet\+Changed (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}, {\ttfamily [slot]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00336                                                  \{}
\DoxyCodeLine{00337   \mbox{\hyperlink{class_t_xsheet}{TXsheet}}* xsh = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}()-\/>getXsheet();}
\DoxyCodeLine{00338   m\_model-\/>refreshData(xsh);}
\DoxyCodeLine{00339   \textcolor{comment}{// remove deleted parameters}}
\DoxyCodeLine{00340   QList<TDoubleParam*> paramSet;}
\DoxyCodeLine{00341   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00342     gatherParams(m\_model-\/>getStageObjectChannel(i), paramSet);}
\DoxyCodeLine{00343   \}}
\DoxyCodeLine{00344   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00345     gatherParams(m\_model-\/>getFxChannel(i), paramSet);}
\DoxyCodeLine{00346   \}}
\DoxyCodeLine{00347 }
\DoxyCodeLine{00348   \textcolor{comment}{// remove deleted parameter from reference map}}
\DoxyCodeLine{00349   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} itr = info(xsh).begin(); itr != info(xsh).end();) \{}
\DoxyCodeLine{00350     \textcolor{keywordflow}{if} (!paramSet.contains(itr.key()))}
\DoxyCodeLine{00351       itr = info(xsh).erase(itr);}
\DoxyCodeLine{00352     \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00353       \textcolor{comment}{// check if the referenced parameters are deleted}}
\DoxyCodeLine{00354       \textcolor{keywordflow}{if} (!itr.value().ignored()) \{}
\DoxyCodeLine{00355         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} refParam : itr.value().paramRefMap()) \{}
\DoxyCodeLine{00356           \textcolor{keywordflow}{if} (!paramSet.contains(refParam)) \{}
\DoxyCodeLine{00357             \textcolor{comment}{// ignore the parameter if the reference does not exist anymore}}
\DoxyCodeLine{00358             itr.value().ignored() = \textcolor{keyword}{true};}
\DoxyCodeLine{00359             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00360           \}}
\DoxyCodeLine{00361         \}}
\DoxyCodeLine{00362       \}}
\DoxyCodeLine{00363       ++itr;}
\DoxyCodeLine{00364     \}}
\DoxyCodeLine{00365   \}}
\DoxyCodeLine{00366 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_acb993d77ffad5e7502b5a187dbb8e0d1}\label{class_expression_reference_manager_acb993d77ffad5e7502b5a187dbb8e0d1}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!onXsheetSwitched@{onXsheetSwitched}}
\index{onXsheetSwitched@{onXsheetSwitched}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{onXsheetSwitched}{onXsheetSwitched}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::on\+Xsheet\+Switched (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}, {\ttfamily [slot]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00328                                                   \{}
\DoxyCodeLine{00329   \mbox{\hyperlink{class_t_xsheet}{TXsheet}}* xsh = \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>\mbox{\hyperlink{class_t_app_a13f509e753824cb0500787f68bb51a09}{getCurrentXsheet}}()-\/>getXsheet();}
\DoxyCodeLine{00330   xsh-\/>setObserver(\textcolor{keyword}{this});}
\DoxyCodeLine{00331   m\_model-\/>refreshData(xsh);}
\DoxyCodeLine{00332 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_aca9cda487e4d479576864a3c982cbfd2}\label{class_expression_reference_manager_aca9cda487e4d479576864a3c982cbfd2}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!refreshXsheetRefInfo@{refreshXsheetRefInfo}}
\index{refreshXsheetRefInfo@{refreshXsheetRefInfo}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{refreshXsheetRefInfo()}{refreshXsheetRefInfo()}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::refresh\+Xsheet\+Ref\+Info (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$}]{xsh }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00313                                                                   \{}
\DoxyCodeLine{00314   xsh-\/>setObserver(\textcolor{keyword}{this});}
\DoxyCodeLine{00315   m\_model-\/>refreshData(xsh);}
\DoxyCodeLine{00316   xsh-\/>getExpRefMonitor()-\/>clearAll();}
\DoxyCodeLine{00317   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00318     checkRef(m\_model-\/>getStageObjectChannel(i), xsh);}
\DoxyCodeLine{00319   \}}
\DoxyCodeLine{00320   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00321     checkRef(m\_model-\/>getFxChannel(i), xsh);}
\DoxyCodeLine{00322   \}}
\DoxyCodeLine{00323   onXsheetSwitched();}
\DoxyCodeLine{00324 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_expression_reference_manager_a23888deaef18d64449c53e7f38c216e0}\label{class_expression_reference_manager_a23888deaef18d64449c53e7f38c216e0}} 
\index{ExpressionReferenceManager@{ExpressionReferenceManager}!transferReference@{transferReference}}
\index{transferReference@{transferReference}!ExpressionReferenceManager@{ExpressionReferenceManager}}
\doxysubsubsection{\texorpdfstring{transferReference()}{transferReference()}}
{\footnotesize\ttfamily void Expression\+Reference\+Manager\+::transfer\+Reference (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$}]{from\+Xsh,  }\item[{\mbox{\hyperlink{class_t_xsheet}{TXsheet}} $\ast$}]{to\+Xsh,  }\item[{const QMap$<$ \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}}, \mbox{\hyperlink{class_t_stage_object_id}{TStage\+Object\+Id}} $>$ \&}]{id\+Table,  }\item[{const QMap$<$ \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$, \mbox{\hyperlink{class_t_fx}{TFx}} $\ast$ $>$ \&}]{fx\+Table }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00782                                      \{}
\DoxyCodeLine{00783   \textcolor{comment}{// return if the preference option is off}}
\DoxyCodeLine{00784   \textcolor{keywordtype}{bool} on =}
\DoxyCodeLine{00785       Preferences::instance()-\/>isModifyExpressionOnMovingReferencesEnabled();}
\DoxyCodeLine{00786   \textcolor{keywordflow}{if} (!on) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00787 }
\DoxyCodeLine{00788   \textcolor{comment}{// 1. create 3 tables for replacing; column indices, parameter pointers, and}}
\DoxyCodeLine{00789   \textcolor{comment}{// expression texts. Note that moving columns in the same xsheet does not need}}
\DoxyCodeLine{00790   \textcolor{comment}{// to replace the parameter pointers since they are swapped along with}}
\DoxyCodeLine{00791   \textcolor{comment}{// columns.}}
\DoxyCodeLine{00792   QMap<int, int> colIdReplaceTable;}
\DoxyCodeLine{00793   QMap<TDoubleParam*, TDoubleParam*> curveReplaceTable;}
\DoxyCodeLine{00794   std::map<std::string, std::string> exprReplaceTable;}
\DoxyCodeLine{00795 }
\DoxyCodeLine{00796   \textcolor{keywordtype}{bool} sameXSheet = (fromXsh == toXsh);}
\DoxyCodeLine{00797 }
\DoxyCodeLine{00798   \textcolor{comment}{// First, check the stage objects}}
\DoxyCodeLine{00799   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} obj\_itr = idTable.constBegin(); obj\_itr != idTable.constEnd();}
\DoxyCodeLine{00800        obj\_itr++) \{}
\DoxyCodeLine{00801     \mbox{\hyperlink{class_t_stage_object_id}{TStageObjectId}} fromId = obj\_itr.key();}
\DoxyCodeLine{00802     \mbox{\hyperlink{class_t_stage_object_id}{TStageObjectId}} toId   = obj\_itr.value();}
\DoxyCodeLine{00803 }
\DoxyCodeLine{00804     \textcolor{comment}{// register column indices replacement table ( register even if fromId and}}
\DoxyCodeLine{00805     \textcolor{comment}{// toId are identical )}}
\DoxyCodeLine{00806     \textcolor{keywordflow}{if} (fromId.\mbox{\hyperlink{class_t_stage_object_id_af6d13fcf31e7e10eef28f085855f469c}{isColumn}}() \&\& toId.\mbox{\hyperlink{class_t_stage_object_id_af6d13fcf31e7e10eef28f085855f469c}{isColumn}}())}
\DoxyCodeLine{00807       colIdReplaceTable.insert(fromId.getIndex(), toId.getIndex());}
\DoxyCodeLine{00808     \textcolor{comment}{// register expression texts replacement table ( register only if the}}
\DoxyCodeLine{00809     \textcolor{comment}{// phrases will be changed )}}
\DoxyCodeLine{00810     \textcolor{keywordflow}{if} (fromId != toId) \{}
\DoxyCodeLine{00811       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} ph = 0; ph < getPhraseCount(fromId); ph++)}
\DoxyCodeLine{00812         exprReplaceTable[getPhrase(fromId, ph)] = getPhrase(toId, ph);}
\DoxyCodeLine{00813     \}}
\DoxyCodeLine{00814     \textcolor{keywordflow}{if} (sameXSheet) \{}
\DoxyCodeLine{00815       \textcolor{comment}{// the parameter pointers are already swapped when moving columns in the}}
\DoxyCodeLine{00816       \textcolor{comment}{// same xsheet curveReplaceTable will be used just for parameter list to}}
\DoxyCodeLine{00817       \textcolor{comment}{// be modified}}
\DoxyCodeLine{00818       \mbox{\hyperlink{class_t_stage_object}{TStageObject}}* toObj =}
\DoxyCodeLine{00819           toXsh-\/>\mbox{\hyperlink{class_t_xsheet_a5dc925584e35e1678f5678b79c470959}{getStageObjectTree}}()-\/>\mbox{\hyperlink{class_t_stage_object_tree_a688e5b4f2f5730afb0cb10264f13a113}{getStageObject}}(toId, \textcolor{keyword}{false});}
\DoxyCodeLine{00820       assert(toObj);}
\DoxyCodeLine{00821       \textcolor{keywordflow}{if} (toObj) \{}
\DoxyCodeLine{00822         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = 0; c < TStageObject::T\_ChannelCount; c++) \{}
\DoxyCodeLine{00823           \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* to\_p = toObj-\/>\mbox{\hyperlink{class_t_stage_object_ae4cf64f5085310a14074ceb54d2b5177}{getParam}}((\mbox{\hyperlink{class_t_stage_object_ac7a60ddc803173dc7591f784577cb439}{TStageObject::Channel}})c);}
\DoxyCodeLine{00824           curveReplaceTable.insert(to\_p, to\_p);}
\DoxyCodeLine{00825         \}}
\DoxyCodeLine{00826       \}}
\DoxyCodeLine{00827     \} \textcolor{keywordflow}{else} \{  \textcolor{comment}{// for transferring objects over xsheets (i.e. collapse and}}
\DoxyCodeLine{00828               \textcolor{comment}{// explode)}}
\DoxyCodeLine{00829       \textcolor{comment}{// register to the parameter pointer replacement table}}
\DoxyCodeLine{00830       \mbox{\hyperlink{class_t_stage_object}{TStageObject}}* fromObj =}
\DoxyCodeLine{00831           fromXsh-\/>\mbox{\hyperlink{class_t_xsheet_a5dc925584e35e1678f5678b79c470959}{getStageObjectTree}}()-\/>\mbox{\hyperlink{class_t_stage_object_tree_a688e5b4f2f5730afb0cb10264f13a113}{getStageObject}}(fromId, \textcolor{keyword}{false});}
\DoxyCodeLine{00832       \mbox{\hyperlink{class_t_stage_object}{TStageObject}}* toObj =}
\DoxyCodeLine{00833           toXsh-\/>\mbox{\hyperlink{class_t_xsheet_a5dc925584e35e1678f5678b79c470959}{getStageObjectTree}}()-\/>\mbox{\hyperlink{class_t_stage_object_tree_a688e5b4f2f5730afb0cb10264f13a113}{getStageObject}}(toId, \textcolor{keyword}{false});}
\DoxyCodeLine{00834       assert(fromObj \&\& toObj);}
\DoxyCodeLine{00835       \textcolor{keywordflow}{if} (fromObj \&\& toObj) \{}
\DoxyCodeLine{00836         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = 0; c < TStageObject::T\_ChannelCount; c++) \{}
\DoxyCodeLine{00837           \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* from\_p = fromObj-\/>\mbox{\hyperlink{class_t_stage_object_ae4cf64f5085310a14074ceb54d2b5177}{getParam}}((\mbox{\hyperlink{class_t_stage_object_ac7a60ddc803173dc7591f784577cb439}{TStageObject::Channel}})c);}
\DoxyCodeLine{00838           \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* to\_p   = toObj-\/>\mbox{\hyperlink{class_t_stage_object_ae4cf64f5085310a14074ceb54d2b5177}{getParam}}((\mbox{\hyperlink{class_t_stage_object_ac7a60ddc803173dc7591f784577cb439}{TStageObject::Channel}})c);}
\DoxyCodeLine{00839           curveReplaceTable.insert(from\_p, to\_p);}
\DoxyCodeLine{00840         \}}
\DoxyCodeLine{00841       \}}
\DoxyCodeLine{00842     \}}
\DoxyCodeLine{00843   \}}
\DoxyCodeLine{00844 }
\DoxyCodeLine{00845   \textcolor{comment}{// Secondly, check the Fxs}}
\DoxyCodeLine{00846   QMap<TFx*, QList<TDoubleParam*>> fromFxParams, toFxParams;}
\DoxyCodeLine{00847   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} fx\_itr = fxTable.constBegin(); fx\_itr != fxTable.constEnd();}
\DoxyCodeLine{00848        fx\_itr++) \{}
\DoxyCodeLine{00849     \mbox{\hyperlink{class_t_fx}{TFx}}* fromFx = fx\_itr.key();}
\DoxyCodeLine{00850     \mbox{\hyperlink{class_t_fx}{TFx}}* toFx   = fx\_itr.value();}
\DoxyCodeLine{00851     \textcolor{comment}{// skip the case that the Xsheet node is converted to the OverFx when}}
\DoxyCodeLine{00852     \textcolor{comment}{// exploding}}
\DoxyCodeLine{00853     \textcolor{keywordflow}{if} (fromFx-\/>getFxType() == toFx-\/>getFxType()) \{}
\DoxyCodeLine{00854       fromFxParams.insert(fromFx, QList<TDoubleParam*>());}
\DoxyCodeLine{00855       toFxParams.insert(toFx, QList<TDoubleParam*>());}
\DoxyCodeLine{00856       \textcolor{comment}{// register expression texts replacement table}}
\DoxyCodeLine{00857       \textcolor{keywordflow}{if} (fromFx-\/>getFxId() != toFx-\/>getFxId())}
\DoxyCodeLine{00858         exprReplaceTable[getPhrase(fromFx)] = getPhrase(toFx);}
\DoxyCodeLine{00859     \}}
\DoxyCodeLine{00860   \}}
\DoxyCodeLine{00861   \textcolor{keywordflow}{if} (!fromFxParams.isEmpty() \&\& !toFxParams.isEmpty()) \{}
\DoxyCodeLine{00862     \textcolor{comment}{// gather from-\/fx parameter pointers}}
\DoxyCodeLine{00863     m\_model-\/>refreshData(fromXsh);}
\DoxyCodeLine{00864     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00865       \mbox{\hyperlink{class_fx_channel_group}{FxChannelGroup}}* fcg =}
\DoxyCodeLine{00866           \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_fx_channel_group}{FxChannelGroup}}*\textcolor{keyword}{>}(m\_model-\/>getFxChannel(i));}
\DoxyCodeLine{00867       \textcolor{keywordflow}{if} (!fcg) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00868       \textcolor{keywordflow}{if} (fromFxParams.contains(fcg-\/>getFx()))}
\DoxyCodeLine{00869         gatherParams(fcg, fromFxParams[fcg-\/>getFx()]);}
\DoxyCodeLine{00870     \}}
\DoxyCodeLine{00871     \textcolor{comment}{// gather to-\/fx parameter pointers}}
\DoxyCodeLine{00872     m\_model-\/>refreshData(toXsh);}
\DoxyCodeLine{00873     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00874       \mbox{\hyperlink{class_fx_channel_group}{FxChannelGroup}}* fcg =}
\DoxyCodeLine{00875           \textcolor{keyword}{dynamic\_cast<}\mbox{\hyperlink{class_fx_channel_group}{FxChannelGroup}}*\textcolor{keyword}{>}(m\_model-\/>getFxChannel(i));}
\DoxyCodeLine{00876       \textcolor{keywordflow}{if} (!fcg) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00877       \textcolor{keywordflow}{if} (toFxParams.contains(fcg-\/>getFx()))}
\DoxyCodeLine{00878         gatherParams(fcg, toFxParams[fcg-\/>getFx()]);}
\DoxyCodeLine{00879     \}}
\DoxyCodeLine{00880     \textcolor{comment}{// register parameters to the table}}
\DoxyCodeLine{00881     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} ffp\_itr = fromFxParams.constBegin();}
\DoxyCodeLine{00882          ffp\_itr != fromFxParams.constEnd(); ffp\_itr++) \{}
\DoxyCodeLine{00883       \mbox{\hyperlink{class_t_fx}{TFx}}* fromFx = ffp\_itr.key();}
\DoxyCodeLine{00884       \mbox{\hyperlink{class_t_fx}{TFx}}* toFx   = fxTable.value(fromFx);}
\DoxyCodeLine{00885       assert(toFx \&\& toFxParams.contains(toFx));}
\DoxyCodeLine{00886       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < ffp\_itr.value().size(); i++) \{}
\DoxyCodeLine{00887         curveReplaceTable.insert(ffp\_itr.value().at(i),}
\DoxyCodeLine{00888                                  toFxParams.value(toFx).at(i));}
\DoxyCodeLine{00889       \}}
\DoxyCodeLine{00890     \}}
\DoxyCodeLine{00891   \}}
\DoxyCodeLine{00892 }
\DoxyCodeLine{00893   \textcolor{comment}{// 2. transfer reference information from fromXsh to toXsh by using tables}}
\DoxyCodeLine{00894   \textcolor{comment}{// QMap<int, int> colIdReplaceTable;}}
\DoxyCodeLine{00895   \textcolor{comment}{// QMap<TDoubleParam*, TDoubleParam*> curveReplaceTable;}}
\DoxyCodeLine{00896   \textcolor{comment}{// std::map<std::string, std::string> exprReplaceTable;}}
\DoxyCodeLine{00897   QSet<TDoubleParam*> insertedCurves;}
\DoxyCodeLine{00898   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} itr = info(fromXsh).begin(); itr != info(fromXsh).end(); itr++) \{}
\DoxyCodeLine{00899     \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* fromParam = itr.key();}
\DoxyCodeLine{00900     \textcolor{keywordtype}{bool} ignored            = touchInfo(fromParam, fromXsh).ignored();}
\DoxyCodeLine{00901     \textcolor{keywordflow}{if} (sameXSheet) \{}
\DoxyCodeLine{00902       \textcolor{comment}{// transfer as-\/is if the parameter is ignored}}
\DoxyCodeLine{00903       \textcolor{keywordflow}{if} (!ignored) \{}
\DoxyCodeLine{00904         \textcolor{comment}{// converting the column indices.}}
\DoxyCodeLine{00905         QSet<int> convertedColIdSet;}
\DoxyCodeLine{00906         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} fromId : itr.value().colRefMap()) \{}
\DoxyCodeLine{00907           \textcolor{keywordflow}{if} (colIdReplaceTable.contains(fromId))}
\DoxyCodeLine{00908             convertedColIdSet.insert(colIdReplaceTable.value(fromId));}
\DoxyCodeLine{00909           \textcolor{comment}{// if there is a index not in the replacement table, transfer it}}
\DoxyCodeLine{00910           \textcolor{comment}{// as-\/is.}}
\DoxyCodeLine{00911           \textcolor{keywordflow}{else}}
\DoxyCodeLine{00912             convertedColIdSet.insert(fromId);}
\DoxyCodeLine{00913         \}}
\DoxyCodeLine{00914         \textcolor{comment}{// replacing the info}}
\DoxyCodeLine{00915         itr.value().colRefMap() = convertedColIdSet;}
\DoxyCodeLine{00916       \}}
\DoxyCodeLine{00917       insertedCurves.insert(fromParam);}
\DoxyCodeLine{00918     \}}
\DoxyCodeLine{00919     \textcolor{comment}{// if the parameter is in the replacement table}}
\DoxyCodeLine{00920     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (curveReplaceTable.contains(fromParam)) \{}
\DoxyCodeLine{00921       \textcolor{comment}{// transfer as-\/is if the parameter is ignored}}
\DoxyCodeLine{00922       \textcolor{comment}{// converting the column indices.}}
\DoxyCodeLine{00923       QSet<int> convertedColIdSet;}
\DoxyCodeLine{00924       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} fromId : itr.value().colRefMap()) \{}
\DoxyCodeLine{00925         \textcolor{keywordflow}{if} (ignored) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00926         \textcolor{keywordflow}{if} (colIdReplaceTable.contains(fromId))}
\DoxyCodeLine{00927           convertedColIdSet.insert(colIdReplaceTable.value(fromId));}
\DoxyCodeLine{00928         \textcolor{comment}{// if there is a index not in the replacement table, the parameter will}}
\DoxyCodeLine{00929         \textcolor{comment}{// be ignored}}
\DoxyCodeLine{00930         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00931           ignored = \textcolor{keyword}{true};}
\DoxyCodeLine{00932       \}}
\DoxyCodeLine{00933 }
\DoxyCodeLine{00934       \textcolor{comment}{// converting the parameter pointers}}
\DoxyCodeLine{00935       QSet<TDoubleParam*> convertedParamSet;}
\DoxyCodeLine{00936       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} fromRefParam : itr.value().paramRefMap()) \{}
\DoxyCodeLine{00937         \textcolor{keywordflow}{if} (curveReplaceTable.contains(fromRefParam))}
\DoxyCodeLine{00938           convertedParamSet.insert(curveReplaceTable.value(fromRefParam));}
\DoxyCodeLine{00939         \textcolor{comment}{// if there is a index not in the replacement table, the parameter will}}
\DoxyCodeLine{00940         \textcolor{comment}{// be ignored}}
\DoxyCodeLine{00941         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00942           ignored = \textcolor{keyword}{true};}
\DoxyCodeLine{00943       \}}
\DoxyCodeLine{00944 }
\DoxyCodeLine{00945       \textcolor{comment}{// register the converted list to toXsh}}
\DoxyCodeLine{00946       \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* toParam = curveReplaceTable.value(fromParam);}
\DoxyCodeLine{00947       \textcolor{keywordflow}{if} (ignored) \{}
\DoxyCodeLine{00948         touchInfo(toParam, toXsh).ignored() = \textcolor{keyword}{true};}
\DoxyCodeLine{00949         \textcolor{comment}{// if the parameter is ignored, transfer the column reference list}}
\DoxyCodeLine{00950         \textcolor{comment}{// as-\/is.}}
\DoxyCodeLine{00951         touchInfo(toParam, toXsh).colRefMap() = itr.value().colRefMap();}
\DoxyCodeLine{00952       \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{00953         touchInfo(toParam, toXsh).colRefMap() = convertedColIdSet;}
\DoxyCodeLine{00954 }
\DoxyCodeLine{00955       touchInfo(toParam, toXsh).paramRefMap() = convertedParamSet;}
\DoxyCodeLine{00956 }
\DoxyCodeLine{00957       insertedCurves.insert(toParam);}
\DoxyCodeLine{00958     \}}
\DoxyCodeLine{00959 }
\DoxyCodeLine{00960     \textcolor{comment}{// update parameter names}}
\DoxyCodeLine{00961     \textcolor{keywordflow}{if} (curveReplaceTable.contains(fromParam)) \{}
\DoxyCodeLine{00962       \mbox{\hyperlink{class_t_double_param}{TDoubleParam}}* toParam               = curveReplaceTable.value(fromParam);}
\DoxyCodeLine{00963       \mbox{\hyperlink{class_function_tree_model_1_1_channel}{FunctionTreeModel::Channel}}* channel = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00964       \textcolor{comment}{// here m\_model should be refreshed using toXsh}}
\DoxyCodeLine{00965       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getStageObjectsChannelCount(); i++) \{}
\DoxyCodeLine{00966         channel = findChannel(toParam, m\_model-\/>getStageObjectChannel(i));}
\DoxyCodeLine{00967         \textcolor{keywordflow}{if} (channel) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00968       \}}
\DoxyCodeLine{00969       \textcolor{keywordflow}{if} (!channel) \{}
\DoxyCodeLine{00970         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_model-\/>getFxsChannelCount(); i++) \{}
\DoxyCodeLine{00971           channel = findChannel(toParam, m\_model-\/>getFxChannel(i));}
\DoxyCodeLine{00972           \textcolor{keywordflow}{if} (channel) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00973         \}}
\DoxyCodeLine{00974       \}}
\DoxyCodeLine{00975       \textcolor{keywordflow}{if} (channel) \{}
\DoxyCodeLine{00976         touchInfo(toParam, toXsh).name() = channel-\/>getLongName();}
\DoxyCodeLine{00977       \}}
\DoxyCodeLine{00978     \}}
\DoxyCodeLine{00979   \}}
\DoxyCodeLine{00980 }
\DoxyCodeLine{00981   \textcolor{comment}{// refresh m\_model with the current xsheet}}
\DoxyCodeLine{00982   \textcolor{keywordflow}{if} (toXsh != \mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>getCurrentXsheet()-\/>getXsheet())}
\DoxyCodeLine{00983     m\_model-\/>refreshData(\mbox{\hyperlink{class_t_app_a24088f8647d5d9447fcec6b9b9bbf9eb}{TApp::instance}}()-\/>getCurrentXsheet()-\/>getXsheet());}
\DoxyCodeLine{00984 }
\DoxyCodeLine{00985   \textcolor{comment}{// 3. replace the expression texts}}
\DoxyCodeLine{00986   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} ic : insertedCurves) replaceExpressionTexts(ic, exprReplaceTable);}
\DoxyCodeLine{00987 \}}

\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/toonz/expressionreferencemanager.\+h\item 
E\+:/opentoonz/toonz/sources/toonz/expressionreferencemanager.\+cpp\end{DoxyCompactItemize}
