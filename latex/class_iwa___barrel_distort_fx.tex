\hypertarget{class_iwa___barrel_distort_fx}{}\doxysection{Iwa\+\_\+\+Barrel\+Distort\+Fx Class Reference}
\label{class_iwa___barrel_distort_fx}\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
Inheritance diagram for Iwa\+\_\+\+Barrel\+Distort\+Fx\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=5.000000cm]{class_iwa___barrel_distort_fx}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
bool \mbox{\hyperlink{class_iwa___barrel_distort_fx_a2c919294263fea4b1b505635131a7d82}{do\+Get\+BBox}} (double frame, \mbox{\hyperlink{class_t_rect_t}{TRectD}} \&b\+Box, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&info) override
\item 
void \mbox{\hyperlink{class_iwa___barrel_distort_fx_a0c80185ff2c2471efb81405ada040814}{do\+Compute}} (\mbox{\hyperlink{class_t_tile}{TTile}} \&tile, double frame, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&) override
\item 
void \mbox{\hyperlink{class_iwa___barrel_distort_fx_a69ccd62fbbe4786bb594a37cee7656f1}{do\+Compute\+\_\+\+CPU}} (\mbox{\hyperlink{class_t_point_t}{TPointD}} \&point, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&source\+Point, float dist, float dist\+Aspect, \mbox{\hyperlink{structfloat4}{float4}} $\ast$source\+\_\+host, \mbox{\hyperlink{structfloat4}{float4}} $\ast$result\+\_\+host, \mbox{\hyperlink{class_t_rect_t}{TRectD}} \&rect\+Out, \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&source\+Dim, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&offset, float precision, double vignette\+Amount, double vignette\+Gamma, double vignette\+Midpoint, float scale, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri)
\item 
void \mbox{\hyperlink{class_iwa___barrel_distort_fx_a746433de97e506e61b04102fb6609bba}{do\+Compute\+\_\+chroma\+\_\+\+CPU}} (\mbox{\hyperlink{class_t_point_t}{TPointD}} \&point, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&source\+Point, float dist, float dist\+Aspect, float chroma, \mbox{\hyperlink{structfloat4}{float4}} $\ast$source\+\_\+host, \mbox{\hyperlink{structfloat4}{float4}} $\ast$result\+\_\+host, \mbox{\hyperlink{class_t_rect_t}{TRectD}} \&rect\+Out, \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&source\+Dim, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&offset, float precision, double vignette\+Amount, double vignette\+Gamma, double vignette\+Midpoint, float scale, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri)
\item 
bool \mbox{\hyperlink{class_iwa___barrel_distort_fx_a2f45037836bb9ff46118712830862be3}{can\+Handle}} (const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&info, double frame) override
\item 
void \mbox{\hyperlink{class_iwa___barrel_distort_fx_a567509cd6012d7660de5b03af7bb0bd9}{get\+Param\+UIs}} (\mbox{\hyperlink{class_t_param_u_i_concept}{TParam\+UIConcept}} $\ast$\&concepts, int \&length) override
\end{DoxyCompactItemize}
\doxysubsection*{Additional Inherited Members}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_aa2c04200be77a521d2d81f8199f5c3b6}\label{class_iwa___barrel_distort_fx_aa2c04200be77a521d2d81f8199f5c3b6}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{Iwa\_BarrelDistortFx()}{Iwa\_BarrelDistortFx()}}
{\footnotesize\ttfamily Iwa\+\_\+\+Barrel\+Distort\+Fx\+::\+Iwa\+\_\+\+Barrel\+Distort\+Fx (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00118       : m\_point(\mbox{\hyperlink{class_t_point_t}{TPointD}}(0.0, 0.0))}
\DoxyCodeLine{00119       , m\_distortion(0.0)}
\DoxyCodeLine{00120       , m\_distortionAspect(1.0)}
\DoxyCodeLine{00121       , m\_precision(1.0)}
\DoxyCodeLine{00122       , m\_chromaticAberration(0.0)}
\DoxyCodeLine{00123       , m\_vignetteAmount(0.0)}
\DoxyCodeLine{00124       , m\_vignetteGamma(1.0)}
\DoxyCodeLine{00125       , m\_vignetteMidpoint(0.5)}
\DoxyCodeLine{00126       , m\_scale(1.0) \{}
\DoxyCodeLine{00127     m\_point-\/>getX()-\/>setMeasureName(\textcolor{stringliteral}{"{}fxLength"{}});}
\DoxyCodeLine{00128     m\_point-\/>getY()-\/>setMeasureName(\textcolor{stringliteral}{"{}fxLength"{}});}
\DoxyCodeLine{00129     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}center"{}}, m\_point);}
\DoxyCodeLine{00130     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}distortion"{}}, m\_distortion);}
\DoxyCodeLine{00131     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}distortionAspect"{}}, m\_distortionAspect);}
\DoxyCodeLine{00132     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}precision"{}}, m\_precision);}
\DoxyCodeLine{00133     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}chromaticAberration"{}}, m\_chromaticAberration);}
\DoxyCodeLine{00134     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}vignetteAmount"{}}, m\_vignetteAmount);}
\DoxyCodeLine{00135     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}vignetteGamma"{}}, m\_vignetteGamma);}
\DoxyCodeLine{00136     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}vignetteMidpoint"{}}, m\_vignetteMidpoint);}
\DoxyCodeLine{00137     bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}scale"{}}, m\_scale);}
\DoxyCodeLine{00138 }
\DoxyCodeLine{00139     \mbox{\hyperlink{class_t_fx_af0ccf8d65934ed9f7a62d3b45ee5f2b6}{addInputPort}}(\textcolor{stringliteral}{"{}Source"{}}, m\_source);}
\DoxyCodeLine{00140     m\_distortion-\/>setValueRange(-\/2.0, 2.0);}
\DoxyCodeLine{00141     m\_distortionAspect-\/>setValueRange(0.2, 5.0);}
\DoxyCodeLine{00142     m\_precision-\/>setValueRange(1.0, 3.0);}
\DoxyCodeLine{00143     m\_chromaticAberration-\/>setValueRange(-\/0.1, 0.1);}
\DoxyCodeLine{00144     m\_vignetteAmount-\/>setValueRange(-\/1.0, 1.0);}
\DoxyCodeLine{00145     m\_vignetteGamma-\/>setValueRange(0.05, 20.0);}
\DoxyCodeLine{00146     m\_vignetteMidpoint-\/>setValueRange(0.0, 1.0);}
\DoxyCodeLine{00147     m\_scale-\/>setValueRange(0.1, 2.0);}
\DoxyCodeLine{00148   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_ad2d414a73a24f715ddda0cf7b78b1521}\label{class_iwa___barrel_distort_fx_ad2d414a73a24f715ddda0cf7b78b1521}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!````~Iwa\_BarrelDistortFx@{$\sim$Iwa\_BarrelDistortFx}}
\index{````~Iwa\_BarrelDistortFx@{$\sim$Iwa\_BarrelDistortFx}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{$\sim$Iwa\_BarrelDistortFx()}{~Iwa\_BarrelDistortFx()}}
{\footnotesize\ttfamily Iwa\+\_\+\+Barrel\+Distort\+Fx\+::$\sim$\+Iwa\+\_\+\+Barrel\+Distort\+Fx (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00150 \{\};}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_a2f45037836bb9ff46118712830862be3}\label{class_iwa___barrel_distort_fx_a2f45037836bb9ff46118712830862be3}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!canHandle@{canHandle}}
\index{canHandle@{canHandle}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{canHandle()}{canHandle()}}
{\footnotesize\ttfamily bool Iwa\+\_\+\+Barrel\+Distort\+Fx\+::can\+Handle (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{info,  }\item[{double}]{frame }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_raster_fx}{TRaster\+Fx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00179                                                                      \{}
\DoxyCodeLine{00180     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{00181   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_a0c80185ff2c2471efb81405ada040814}\label{class_iwa___barrel_distort_fx_a0c80185ff2c2471efb81405ada040814}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!doCompute@{doCompute}}
\index{doCompute@{doCompute}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{doCompute()}{doCompute()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Barrel\+Distort\+Fx\+::do\+Compute (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} \&}]{tile,  }\item[{double}]{frame,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_raster_fx}{TRaster\+Fx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00195                                                                \{}
\DoxyCodeLine{00196   \textcolor{keywordflow}{if} (!m\_source.isConnected()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00197 }
\DoxyCodeLine{00198   \mbox{\hyperlink{class_t_point_t}{TPointD}} point = m\_point-\/>getValue(frame);}
\DoxyCodeLine{00199   \mbox{\hyperlink{class_t_affine}{TAffine}} aff   = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}};}
\DoxyCodeLine{00200   \textcolor{comment}{// convert the coordinate to with origin at bottom-\/left corner of the camera}}
\DoxyCodeLine{00201   point = aff * point +}
\DoxyCodeLine{00202           \mbox{\hyperlink{class_t_point_t}{TPointD}}(ri.m\_cameraBox.getLx() / 2.0, ri.m\_cameraBox.getLy() / 2.0);}
\DoxyCodeLine{00203   \textcolor{keywordtype}{double} dist       = m\_distortion-\/>getValue(frame);}
\DoxyCodeLine{00204   \textcolor{keywordtype}{double} distAspect = m\_distortionAspect-\/>getValue(frame);}
\DoxyCodeLine{00205   \textcolor{keywordtype}{double} scale      = m\_scale-\/>getValue(frame);}
\DoxyCodeLine{00206 }
\DoxyCodeLine{00207   \mbox{\hyperlink{class_t_rect_t}{TRectD}} rectOut(tile.m\_pos, \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tile.getRaster()-\/>getLx(),}
\DoxyCodeLine{00208                                          tile.getRaster()-\/>getLy()));}
\DoxyCodeLine{00209   \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} outDim(rectOut.getLx(), rectOut.getLy());}
\DoxyCodeLine{00210 }
\DoxyCodeLine{00211   \textcolor{keywordtype}{float} precision = m\_precision-\/>getValue(frame);}
\DoxyCodeLine{00212   \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} source\_ri(ri);}
\DoxyCodeLine{00213   \mbox{\hyperlink{class_t_point_t}{TPointD}} sourcePoint(point);}
\DoxyCodeLine{00214   \textcolor{keywordflow}{if} (precision > 1.0) \{}
\DoxyCodeLine{00215     source\_ri.m\_affine *= \mbox{\hyperlink{class_t_scale}{TScale}}(precision, precision);}
\DoxyCodeLine{00216     sourcePoint = source\_ri.m\_affine * m\_point-\/>getValue(frame) +}
\DoxyCodeLine{00217                   \mbox{\hyperlink{class_t_point_t}{TPointD}}(source\_ri.m\_cameraBox.getLx() / 2.0,}
\DoxyCodeLine{00218                           source\_ri.m\_cameraBox.getLy() / 2.0);}
\DoxyCodeLine{00219   \}}
\DoxyCodeLine{00220 }
\DoxyCodeLine{00221   \mbox{\hyperlink{class_t_rect_t}{TRectD}} sourceBBox;}
\DoxyCodeLine{00222   m\_source-\/>getBBox(frame, sourceBBox, source\_ri);}
\DoxyCodeLine{00223   \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} sourceDim;}
\DoxyCodeLine{00224   \textcolor{keywordflow}{if} (sourceBBox == TConsts::infiniteRectD) \{}
\DoxyCodeLine{00225     \mbox{\hyperlink{class_t_point_t}{TPointD}} tileOffset = tile.m\_pos + tile.getRaster()-\/>getCenterD();}
\DoxyCodeLine{00226     sourceBBox         = \mbox{\hyperlink{class_t_rect_t}{TRectD}}(\mbox{\hyperlink{class_t_point_t}{TPointD}}(source\_ri.m\_cameraBox.x0 + tileOffset.x,}
\DoxyCodeLine{00227                                 source\_ri.m\_cameraBox.y0 + tileOffset.y),}
\DoxyCodeLine{00228                         \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(source\_ri.m\_cameraBox.getLx(),}
\DoxyCodeLine{00229                                     source\_ri.m\_cameraBox.getLy()));}
\DoxyCodeLine{00230   \}}
\DoxyCodeLine{00231   sourceDim.lx = std::ceil(sourceBBox.getLx());}
\DoxyCodeLine{00232   sourceDim.ly = std::ceil(sourceBBox.getLy());}
\DoxyCodeLine{00233 }
\DoxyCodeLine{00234   \mbox{\hyperlink{class_t_tile}{TTile}} sourceTile;}
\DoxyCodeLine{00235   m\_source-\/>allocateAndCompute(sourceTile, sourceBBox.getP00(), sourceDim,}
\DoxyCodeLine{00236                                tile.getRaster(), frame, source\_ri);}
\DoxyCodeLine{00237 }
\DoxyCodeLine{00238   \mbox{\hyperlink{structfloat4}{float4}} *source\_host;}
\DoxyCodeLine{00239   \mbox{\hyperlink{class_t_raster_p_t}{TRasterGR8P}} source\_host\_ras(sourceDim.lx * \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structfloat4}{float4}}), sourceDim.ly);}
\DoxyCodeLine{00240   source\_host\_ras-\/>lock();}
\DoxyCodeLine{00241   source\_host = (\mbox{\hyperlink{structfloat4}{float4}} *)source\_host\_ras-\/>getRawData();}
\DoxyCodeLine{00242 }
\DoxyCodeLine{00243   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} ras32 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}})sourceTile.getRaster();}
\DoxyCodeLine{00244   \mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} ras64 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}})sourceTile.getRaster();}
\DoxyCodeLine{00245   \textcolor{keywordflow}{if} (ras32)}
\DoxyCodeLine{00246     setSourceRaster<TRaster32P, TPixel32>(ras32, source\_host, sourceDim);}
\DoxyCodeLine{00247   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ras64)}
\DoxyCodeLine{00248     setSourceRaster<TRaster64P, TPixel64>(ras64, source\_host, sourceDim);}
\DoxyCodeLine{00249 }
\DoxyCodeLine{00250   \mbox{\hyperlink{class_t_raster_p_t}{TRasterGR8P}} result\_host\_ras(outDim.lx * \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structfloat4}{float4}}), outDim.ly);}
\DoxyCodeLine{00251 }
\DoxyCodeLine{00252   \textcolor{comment}{// memory to store the result}}
\DoxyCodeLine{00253   \mbox{\hyperlink{structfloat4}{float4}} *result\_host;}
\DoxyCodeLine{00254   result\_host\_ras-\/>lock();}
\DoxyCodeLine{00255   result\_host = (\mbox{\hyperlink{structfloat4}{float4}} *)result\_host\_ras-\/>getRawData();}
\DoxyCodeLine{00256 }
\DoxyCodeLine{00257   \mbox{\hyperlink{class_t_point_t}{TPointD}} offset = sourceTile.m\_pos + \mbox{\hyperlink{class_t_point_t}{TPointD}}(ri.m\_cameraBox.getLx() / 2.0,}
\DoxyCodeLine{00258                                               ri.m\_cameraBox.getLy() / 2.0);}
\DoxyCodeLine{00259 }
\DoxyCodeLine{00260   \textcolor{keywordtype}{double} vignetteAmount   = m\_vignetteAmount-\/>getValue(frame);}
\DoxyCodeLine{00261   \textcolor{keywordtype}{double} vignetteGamma    = m\_vignetteGamma-\/>getValue(frame);}
\DoxyCodeLine{00262   \textcolor{keywordtype}{double} vignetteMidpoint = m\_vignetteMidpoint-\/>getValue(frame);}
\DoxyCodeLine{00263 }
\DoxyCodeLine{00264   \textcolor{keywordtype}{double} chroma = m\_chromaticAberration-\/>getValue(frame);}
\DoxyCodeLine{00265   \textcolor{keywordflow}{if} (areAlmostEqual(chroma, 0.0))}
\DoxyCodeLine{00266     doCompute\_CPU(point, sourcePoint, dist, distAspect, source\_host,}
\DoxyCodeLine{00267                   result\_host, rectOut, sourceDim, offset, precision,}
\DoxyCodeLine{00268                   vignetteAmount, vignetteGamma, vignetteMidpoint, scale, ri);}
\DoxyCodeLine{00269   \textcolor{keywordflow}{else}}
\DoxyCodeLine{00270     doCompute\_chroma\_CPU(point, sourcePoint, dist, distAspect, chroma,}
\DoxyCodeLine{00271                          source\_host, result\_host, rectOut, sourceDim, offset,}
\DoxyCodeLine{00272                          precision, vignetteAmount, vignetteGamma,}
\DoxyCodeLine{00273                          vignetteMidpoint, scale, ri);}
\DoxyCodeLine{00274 }
\DoxyCodeLine{00275   source\_host\_ras-\/>unlock();}
\DoxyCodeLine{00276 }
\DoxyCodeLine{00277   \textcolor{comment}{// convert the result to channel value and store to the output raster}}
\DoxyCodeLine{00278   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} outRas32 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}})tile.getRaster();}
\DoxyCodeLine{00279   \mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} outRas64 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}})tile.getRaster();}
\DoxyCodeLine{00280   \textcolor{keywordflow}{if} (outRas32)}
\DoxyCodeLine{00281     setOutputRaster<TRaster32P, TPixel32>(result\_host, outRas32);}
\DoxyCodeLine{00282   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (outRas64)}
\DoxyCodeLine{00283     setOutputRaster<TRaster64P, TPixel64>(result\_host, outRas64);}
\DoxyCodeLine{00284 }
\DoxyCodeLine{00285   result\_host\_ras-\/>unlock();}
\DoxyCodeLine{00286 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_a746433de97e506e61b04102fb6609bba}\label{class_iwa___barrel_distort_fx_a746433de97e506e61b04102fb6609bba}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!doCompute\_chroma\_CPU@{doCompute\_chroma\_CPU}}
\index{doCompute\_chroma\_CPU@{doCompute\_chroma\_CPU}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{doCompute\_chroma\_CPU()}{doCompute\_chroma\_CPU()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Barrel\+Distort\+Fx\+::do\+Compute\+\_\+chroma\+\_\+\+CPU (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{point,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{source\+Point,  }\item[{float}]{dist,  }\item[{float}]{dist\+Aspect,  }\item[{float}]{chroma,  }\item[{\mbox{\hyperlink{structfloat4}{float4}} $\ast$}]{source\+\_\+host,  }\item[{\mbox{\hyperlink{structfloat4}{float4}} $\ast$}]{result\+\_\+host,  }\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{rect\+Out,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&}]{source\+Dim,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{offset,  }\item[{float}]{precision,  }\item[{double}]{vignette\+Amount,  }\item[{double}]{vignette\+Gamma,  }\item[{double}]{vignette\+Midpoint,  }\item[{float}]{scale,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00375                                             \{}
\DoxyCodeLine{00376   \mbox{\hyperlink{structfloat4}{float4}} *result\_p = result\_host;}
\DoxyCodeLine{00377   \textcolor{keywordtype}{float} squaredSize =}
\DoxyCodeLine{00378       (float)(ri.m\_cameraBox.getLx() * ri.m\_cameraBox.getLy()) * 0.25f;}
\DoxyCodeLine{00379   QPointF offsetCenter(sourcePoint.x -\/ offset.x, sourcePoint.y -\/ offset.y);}
\DoxyCodeLine{00380   \textcolor{keywordtype}{float} dist\_ch[3] = \{dist + chroma, dist, dist -\/ chroma\};}
\DoxyCodeLine{00381 }
\DoxyCodeLine{00382   \textcolor{keywordtype}{bool} doVignette = !areAlmostEqual(vignetteAmount, 0.0);}
\DoxyCodeLine{00383 }
\DoxyCodeLine{00384   \textcolor{comment}{// Only the case of barrel distortion (dist < 0) , decrease the sample}}
\DoxyCodeLine{00385   \textcolor{comment}{// position.}}
\DoxyCodeLine{00386   \textcolor{comment}{// It will enlarge the result image.}}
\DoxyCodeLine{00387   \textcolor{comment}{// Such adjustment can be seen in Lens Correction feature of PhotoShop.}}
\DoxyCodeLine{00388   \textcolor{keywordtype}{float} sizeAdjust = (dist < 0.0f) ? (1.0f + dist) : 1.0f;}
\DoxyCodeLine{00389 }
\DoxyCodeLine{00390   QVector2D distAspectVec(1, 1);}
\DoxyCodeLine{00391   \textcolor{keywordflow}{if} (distAspect > 0.0f \&\& distAspect != 1.0f) \{}
\DoxyCodeLine{00392     \textcolor{keywordtype}{float} aspectSqrt = std::sqrt(distAspect);}
\DoxyCodeLine{00393     \textcolor{keywordflow}{if} (dist < 0.0f)}
\DoxyCodeLine{00394       distAspectVec = QVector2D(1.0 / aspectSqrt, aspectSqrt);}
\DoxyCodeLine{00395     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00396       distAspectVec = QVector2D(aspectSqrt, 1.0 / aspectSqrt);}
\DoxyCodeLine{00397   \}}
\DoxyCodeLine{00398 }
\DoxyCodeLine{00399   \mbox{\hyperlink{class_t_point_t}{TPointD}} outImgOrigin =}
\DoxyCodeLine{00400       rectOut.getP00() +}
\DoxyCodeLine{00401       \mbox{\hyperlink{class_t_point_t}{TPointD}}(ri.m\_cameraBox.getLx() / 2.0, ri.m\_cameraBox.getLy() / 2.0);}
\DoxyCodeLine{00402 }
\DoxyCodeLine{00403   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < (int)rectOut.getLy(); j++) \{}
\DoxyCodeLine{00404     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < (int)rectOut.getLx(); i++, result\_p++) \{}
\DoxyCodeLine{00405       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c = 0; c < 3; c++) \{}
\DoxyCodeLine{00406         QVector2D ru(QPointF((\textcolor{keywordtype}{float})i, (\textcolor{keywordtype}{float})j) +}
\DoxyCodeLine{00407                      QPointF(outImgOrigin.x, outImgOrigin.y) -\/}
\DoxyCodeLine{00408                      QPointF(point.x, point.y));}
\DoxyCodeLine{00409         \textcolor{comment}{// apply global scaling}}
\DoxyCodeLine{00410         ru /= scale;}
\DoxyCodeLine{00411         \textcolor{keywordtype}{float} val = (ru * distAspectVec).lengthSquared() / squaredSize;}
\DoxyCodeLine{00412         \textcolor{keywordflow}{if} (dist\_ch[c] > 0.0f \&\& val > 1.0f / dist\_ch[c]) \{}
\DoxyCodeLine{00413           (*result\_p) = \{0.0f, 0.0f, 0.0f, 0.0f\};}
\DoxyCodeLine{00414           \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00415         \}}
\DoxyCodeLine{00416         \textcolor{keywordtype}{float} distortRatio = sizeAdjust / (1.0f + dist\_ch[c] * val);}
\DoxyCodeLine{00417         QVector2D rd       = distortRatio * ru;}
\DoxyCodeLine{00418         QPointF samplePos  = offsetCenter + rd.toPointF() * precision;}
\DoxyCodeLine{00419         \textcolor{keywordflow}{if} (samplePos.x() <= -\/1.0f || samplePos.x() >= (float)(sourceDim.lx) ||}
\DoxyCodeLine{00420             samplePos.y() <= -\/1.0f || samplePos.y() >= (float)(sourceDim.ly)) \{}
\DoxyCodeLine{00421           (*result\_p) = \{0.0f, 0.0f, 0.0f, 0.0f\};}
\DoxyCodeLine{00422           \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00423         \}}
\DoxyCodeLine{00424         QPoint pos(std::floor(samplePos.x()), std::floor(samplePos.y()));}
\DoxyCodeLine{00425         QPointF ratio(samplePos.x() -\/ (\textcolor{keywordtype}{float})pos.x(),}
\DoxyCodeLine{00426                       samplePos.y() -\/ (\textcolor{keywordtype}{float})pos.y());}
\DoxyCodeLine{00427         \mbox{\hyperlink{structfloat4}{float4}} result\_tmp = interp\_CPU(}
\DoxyCodeLine{00428             interp\_CPU(}
\DoxyCodeLine{00429                 getSource\_CPU(source\_host, sourceDim, pos.x(), pos.y()),}
\DoxyCodeLine{00430                 getSource\_CPU(source\_host, sourceDim, pos.x() + 1, pos.y()),}
\DoxyCodeLine{00431                 ratio.x()),}
\DoxyCodeLine{00432             interp\_CPU(}
\DoxyCodeLine{00433                 getSource\_CPU(source\_host, sourceDim, pos.x(), pos.y() + 1),}
\DoxyCodeLine{00434                 getSource\_CPU(source\_host, sourceDim, pos.x() + 1, pos.y() + 1),}
\DoxyCodeLine{00435                 ratio.x()),}
\DoxyCodeLine{00436             ratio.y());}
\DoxyCodeLine{00437         \textcolor{keywordflow}{switch} (c) \{}
\DoxyCodeLine{00438         \textcolor{keywordflow}{case} 0:}
\DoxyCodeLine{00439           (*result\_p).x = result\_tmp.x;}
\DoxyCodeLine{00440           \textcolor{keywordflow}{if} (doVignette)}
\DoxyCodeLine{00441             (*result\_p).x =}
\DoxyCodeLine{00442                 adjustExposure((*result\_p).x, distortRatio * distortRatio * val,}
\DoxyCodeLine{00443                                vignetteAmount, vignetteGamma, vignetteMidpoint);}
\DoxyCodeLine{00444           \textcolor{keywordflow}{break};}
\DoxyCodeLine{00445         \textcolor{keywordflow}{case} 1:}
\DoxyCodeLine{00446           (*result\_p).y = result\_tmp.y;}
\DoxyCodeLine{00447           (*result\_p).w = result\_tmp.w;}
\DoxyCodeLine{00448           \textcolor{keywordflow}{if} (doVignette)}
\DoxyCodeLine{00449             (*result\_p).y =}
\DoxyCodeLine{00450                 adjustExposure((*result\_p).y, distortRatio * distortRatio * val,}
\DoxyCodeLine{00451                                vignetteAmount, vignetteGamma, vignetteMidpoint);}
\DoxyCodeLine{00452           \textcolor{keywordflow}{break};}
\DoxyCodeLine{00453         \textcolor{keywordflow}{case} 2:}
\DoxyCodeLine{00454           (*result\_p).z = result\_tmp.z;}
\DoxyCodeLine{00455           \textcolor{keywordflow}{if} (doVignette)}
\DoxyCodeLine{00456             (*result\_p).z =}
\DoxyCodeLine{00457                 adjustExposure((*result\_p).z, distortRatio * distortRatio * val,}
\DoxyCodeLine{00458                                vignetteAmount, vignetteGamma, vignetteMidpoint);}
\DoxyCodeLine{00459           \textcolor{keywordflow}{break};}
\DoxyCodeLine{00460         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00461           \textcolor{keywordflow}{break};}
\DoxyCodeLine{00462         \}}
\DoxyCodeLine{00463       \}}
\DoxyCodeLine{00464     \}}
\DoxyCodeLine{00465   \}}
\DoxyCodeLine{00466 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_a69ccd62fbbe4786bb594a37cee7656f1}\label{class_iwa___barrel_distort_fx_a69ccd62fbbe4786bb594a37cee7656f1}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!doCompute\_CPU@{doCompute\_CPU}}
\index{doCompute\_CPU@{doCompute\_CPU}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{doCompute\_CPU()}{doCompute\_CPU()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Barrel\+Distort\+Fx\+::do\+Compute\+\_\+\+CPU (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{point,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{source\+Point,  }\item[{float}]{dist,  }\item[{float}]{dist\+Aspect,  }\item[{\mbox{\hyperlink{structfloat4}{float4}} $\ast$}]{source\+\_\+host,  }\item[{\mbox{\hyperlink{structfloat4}{float4}} $\ast$}]{result\+\_\+host,  }\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{rect\+Out,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&}]{source\+Dim,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{offset,  }\item[{float}]{precision,  }\item[{double}]{vignette\+Amount,  }\item[{double}]{vignette\+Gamma,  }\item[{double}]{vignette\+Midpoint,  }\item[{float}]{scale,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00294                                             \{}
\DoxyCodeLine{00295   \mbox{\hyperlink{structfloat4}{float4}} *result\_p = result\_host;}
\DoxyCodeLine{00296   \textcolor{keywordtype}{float} squaredSize =}
\DoxyCodeLine{00297       (float)(ri.m\_cameraBox.getLx() * ri.m\_cameraBox.getLy()) * 0.25f;}
\DoxyCodeLine{00298 }
\DoxyCodeLine{00299   QPointF offsetCenter(sourcePoint.x -\/ offset.x, sourcePoint.y -\/ offset.y);}
\DoxyCodeLine{00300 }
\DoxyCodeLine{00301   \textcolor{keywordtype}{bool} doVignette = !areAlmostEqual(vignetteAmount, 0.0);}
\DoxyCodeLine{00302 }
\DoxyCodeLine{00303   \textcolor{comment}{// Only the case of barrel distortion (dist < 0) , decrease the sample}}
\DoxyCodeLine{00304   \textcolor{comment}{// position.}}
\DoxyCodeLine{00305   \textcolor{comment}{// It will enlarge the result image.}}
\DoxyCodeLine{00306   \textcolor{comment}{// Such adjustment can be seen in Lens Correction feature of PhotoShop.}}
\DoxyCodeLine{00307   \textcolor{keywordtype}{float} sizeAdjust = (dist < 0.0f) ? (1.0f + dist) : 1.0f;}
\DoxyCodeLine{00308 }
\DoxyCodeLine{00309   QVector2D distAspectVec(1, 1);}
\DoxyCodeLine{00310   \textcolor{keywordflow}{if} (distAspect > 0.0f \&\& distAspect != 1.0f) \{}
\DoxyCodeLine{00311     \textcolor{keywordtype}{float} aspectSqrt = std::sqrt(distAspect);}
\DoxyCodeLine{00312     \textcolor{keywordflow}{if} (dist < 0.0f)}
\DoxyCodeLine{00313       distAspectVec = QVector2D(1.0 / aspectSqrt, aspectSqrt);}
\DoxyCodeLine{00314     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00315       distAspectVec = QVector2D(aspectSqrt, 1.0 / aspectSqrt);}
\DoxyCodeLine{00316   \}}
\DoxyCodeLine{00317 }
\DoxyCodeLine{00318   \mbox{\hyperlink{class_t_point_t}{TPointD}} outImgOrigin =}
\DoxyCodeLine{00319       rectOut.getP00() +}
\DoxyCodeLine{00320       \mbox{\hyperlink{class_t_point_t}{TPointD}}(ri.m\_cameraBox.getLx() / 2.0, ri.m\_cameraBox.getLy() / 2.0);}
\DoxyCodeLine{00321 }
\DoxyCodeLine{00322   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < (int)rectOut.getLy(); j++) \{}
\DoxyCodeLine{00323     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < (int)rectOut.getLx(); i++, result\_p++) \{}
\DoxyCodeLine{00324       QVector2D ru(QPointF((\textcolor{keywordtype}{float})i, (\textcolor{keywordtype}{float})j) +}
\DoxyCodeLine{00325                    QPointF(outImgOrigin.x, outImgOrigin.y) -\/}
\DoxyCodeLine{00326                    QPointF(point.x, point.y));}
\DoxyCodeLine{00327       \textcolor{comment}{// apply global scaling}}
\DoxyCodeLine{00328       ru /= scale;}
\DoxyCodeLine{00329       \textcolor{keywordtype}{float} val = (ru * distAspectVec).lengthSquared() / squaredSize;}
\DoxyCodeLine{00330       \textcolor{keywordflow}{if} (dist > 0.0f \&\& val > 1.0f / dist) \{}
\DoxyCodeLine{00331         (*result\_p) = \{0.0f, 0.0f, 0.0f, 0.0f\};}
\DoxyCodeLine{00332         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00333       \}}
\DoxyCodeLine{00334       \textcolor{keywordtype}{float} distortRatio = sizeAdjust / (1.0f + dist * val);}
\DoxyCodeLine{00335       QVector2D rd       = distortRatio * ru;}
\DoxyCodeLine{00336       QPointF samplePos  = offsetCenter + rd.toPointF() * precision;}
\DoxyCodeLine{00337       \textcolor{keywordflow}{if} (samplePos.x() <= -\/1.0f || samplePos.x() >= (float)(sourceDim.lx) ||}
\DoxyCodeLine{00338           samplePos.y() <= -\/1.0f || samplePos.y() >= (float)(sourceDim.ly)) \{}
\DoxyCodeLine{00339         (*result\_p) = \{0.0f, 0.0f, 0.0f, 0.0f\};}
\DoxyCodeLine{00340         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00341       \}}
\DoxyCodeLine{00342       QPoint pos(std::floor(samplePos.x()), std::floor(samplePos.y()));}
\DoxyCodeLine{00343       QPointF ratio(samplePos.x() -\/ (\textcolor{keywordtype}{float})pos.x(),}
\DoxyCodeLine{00344                     samplePos.y() -\/ (\textcolor{keywordtype}{float})pos.y());}
\DoxyCodeLine{00345       (*result\_p) = interp\_CPU(}
\DoxyCodeLine{00346           interp\_CPU(}
\DoxyCodeLine{00347               getSource\_CPU(source\_host, sourceDim, pos.x(), pos.y()),}
\DoxyCodeLine{00348               getSource\_CPU(source\_host, sourceDim, pos.x() + 1, pos.y()),}
\DoxyCodeLine{00349               ratio.x()),}
\DoxyCodeLine{00350           interp\_CPU(}
\DoxyCodeLine{00351               getSource\_CPU(source\_host, sourceDim, pos.x(), pos.y() + 1),}
\DoxyCodeLine{00352               getSource\_CPU(source\_host, sourceDim, pos.x() + 1, pos.y() + 1),}
\DoxyCodeLine{00353               ratio.x()),}
\DoxyCodeLine{00354           ratio.y());}
\DoxyCodeLine{00355       \textcolor{keywordflow}{if} (doVignette) \{}
\DoxyCodeLine{00356         \textcolor{keywordtype}{float} distance = distortRatio * distortRatio * val;}
\DoxyCodeLine{00357         (*result\_p).x  = adjustExposure((*result\_p).x, distance, vignetteAmount,}
\DoxyCodeLine{00358                                        vignetteGamma, vignetteMidpoint);}
\DoxyCodeLine{00359         (*result\_p).y = adjustExposure((*result\_p).y, distance, vignetteAmount,}
\DoxyCodeLine{00360                                        vignetteGamma, vignetteMidpoint);}
\DoxyCodeLine{00361         (*result\_p).z = adjustExposure((*result\_p).z, distance, vignetteAmount,}
\DoxyCodeLine{00362                                        vignetteGamma, vignetteMidpoint);}
\DoxyCodeLine{00363       \}}
\DoxyCodeLine{00364     \}}
\DoxyCodeLine{00365   \}}
\DoxyCodeLine{00366 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_a2c919294263fea4b1b505635131a7d82}\label{class_iwa___barrel_distort_fx_a2c919294263fea4b1b505635131a7d82}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!doGetBBox@{doGetBBox}}
\index{doGetBBox@{doGetBBox}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{doGetBBox()}{doGetBBox()}}
{\footnotesize\ttfamily bool Iwa\+\_\+\+Barrel\+Distort\+Fx\+::do\+Get\+BBox (\begin{DoxyParamCaption}\item[{double}]{frame,  }\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{b\+Box,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{info }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_raster_fx}{TRaster\+Fx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00153                                                        \{}
\DoxyCodeLine{00154     \textcolor{keywordflow}{if} (m\_source.isConnected()) \{}
\DoxyCodeLine{00155       \textcolor{keywordtype}{bool} ret      = m\_source-\/>doGetBBox(frame, bBox, info);}
\DoxyCodeLine{00156       \textcolor{keywordflow}{if} (ret) bBox = TConsts::infiniteRectD;}
\DoxyCodeLine{00157       \textcolor{keywordflow}{return} ret;}
\DoxyCodeLine{00158     \}}
\DoxyCodeLine{00159     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{00160   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___barrel_distort_fx_a567509cd6012d7660de5b03af7bb0bd9}\label{class_iwa___barrel_distort_fx_a567509cd6012d7660de5b03af7bb0bd9}} 
\index{Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}!getParamUIs@{getParamUIs}}
\index{getParamUIs@{getParamUIs}!Iwa\_BarrelDistortFx@{Iwa\_BarrelDistortFx}}
\doxysubsubsection{\texorpdfstring{getParamUIs()}{getParamUIs()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Barrel\+Distort\+Fx\+::get\+Param\+UIs (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_param_u_i_concept}{TParam\+UIConcept}} $\ast$\&}]{params,  }\item[{int \&}]{length }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [virtual]}}

Returns a list of User Interface Concepts to be displayed when editing the fx parameters. \begin{DoxyNote}{Note}
Ownership of the returned array allocated with new\mbox{[}\mbox{]} is passed to callers. 
\end{DoxyNote}


Reimplemented from \mbox{\hyperlink{class_t_fx_a18766b107b77772d67c5678e7d832b18}{TFx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00183                                                                      \{}
\DoxyCodeLine{00184     concepts = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_param_u_i_concept}{TParamUIConcept}}[length = 1];}
\DoxyCodeLine{00185 }
\DoxyCodeLine{00186     concepts[0].\mbox{\hyperlink{class_t_param_u_i_concept_a2dbb7c954ca5f2441a6931945cf004a5}{m\_type}}  = TParamUIConcept::POINT;}
\DoxyCodeLine{00187     concepts[0].m\_label = \textcolor{stringliteral}{"{}Center"{}};}
\DoxyCodeLine{00188     concepts[0].m\_params.push\_back(m\_point);}
\DoxyCodeLine{00189   \}}

\end{DoxyCode}


References \mbox{\hyperlink{l00078}{TParam\+UIConcept\+::m\+\_\+label}}, \mbox{\hyperlink{l00079}{TParam\+UIConcept\+::m\+\_\+params}}, and \mbox{\hyperlink{l00077}{TParam\+UIConcept\+::m\+\_\+type}}.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+barreldistortfx.\+cpp\end{DoxyCompactItemize}
