\hypertarget{class_iwa___bokeh_fx}{}\doxysection{Iwa\+\_\+\+Bokeh\+Fx Class Reference}
\label{class_iwa___bokeh_fx}\index{Iwa\_BokehFx@{Iwa\_BokehFx}}
Inheritance diagram for Iwa\+\_\+\+Bokeh\+Fx\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=6.000000cm]{class_iwa___bokeh_fx}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_iwa___bokeh_fx_a5a5fe8642872e957162b7d6859442779}{do\+Compute}} (\mbox{\hyperlink{class_t_tile}{TTile}} \&tile, double frame, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&settings) override
\end{DoxyCompactItemize}
\doxysubsection*{Additional Inherited Members}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_iwa___bokeh_fx_a0d28b3f7b8aa6fea98c50293f99a5758}\label{class_iwa___bokeh_fx_a0d28b3f7b8aa6fea98c50293f99a5758}} 
\index{Iwa\_BokehFx@{Iwa\_BokehFx}!Iwa\_BokehFx@{Iwa\_BokehFx}}
\index{Iwa\_BokehFx@{Iwa\_BokehFx}!Iwa\_BokehFx@{Iwa\_BokehFx}}
\doxysubsubsection{\texorpdfstring{Iwa\_BokehFx()}{Iwa\_BokehFx()}}
{\footnotesize\ttfamily Iwa\+\_\+\+Bokeh\+Fx\+::\+Iwa\+\_\+\+Bokeh\+Fx (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00048                          \{}
\DoxyCodeLine{00049   \textcolor{comment}{// Bind the common parameters}}
\DoxyCodeLine{00050   bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}on\_focus\_distance"{}}, m\_onFocusDistance, \textcolor{keyword}{false});}
\DoxyCodeLine{00051   bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}bokeh\_amount"{}}, m\_bokehAmount, \textcolor{keyword}{false});}
\DoxyCodeLine{00052   bindParam(\textcolor{keyword}{this}, \textcolor{stringliteral}{"{}hardness"{}}, m\_hardness, \textcolor{keyword}{false});}
\DoxyCodeLine{00053 }
\DoxyCodeLine{00054   \textcolor{comment}{// Bind the layer parameters}}
\DoxyCodeLine{00055   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} layer = 0; layer < LAYER\_NUM; layer++) \{}
\DoxyCodeLine{00056     m\_layerParams[layer].m\_distance        = TDoubleParamP(0.5);}
\DoxyCodeLine{00057     m\_layerParams[layer].m\_bokehAdjustment = TDoubleParamP(1.0);}
\DoxyCodeLine{00058     \textcolor{comment}{// The premultiply option is not displayed anymore for simplicity}}
\DoxyCodeLine{00059     m\_layerParams[layer].m\_premultiply = TBoolParamP(\textcolor{keyword}{false});}
\DoxyCodeLine{00060 }
\DoxyCodeLine{00061     std::string str = QString(\textcolor{stringliteral}{"{}Source\%1"{}}).arg(layer + 1).toStdString();}
\DoxyCodeLine{00062     \mbox{\hyperlink{class_t_fx_af0ccf8d65934ed9f7a62d3b45ee5f2b6}{addInputPort}}(str, m\_layerParams[layer].m\_source);}
\DoxyCodeLine{00063     bindParam(\textcolor{keyword}{this}, QString(\textcolor{stringliteral}{"{}distance\%1"{}}).arg(layer + 1).toStdString(),}
\DoxyCodeLine{00064               m\_layerParams[layer].m\_distance, \textcolor{keyword}{false});}
\DoxyCodeLine{00065     bindParam(\textcolor{keyword}{this}, QString(\textcolor{stringliteral}{"{}bokeh\_adjustment\%1"{}}).arg(layer + 1).toStdString(),}
\DoxyCodeLine{00066               m\_layerParams[layer].m\_bokehAdjustment, \textcolor{keyword}{false});}
\DoxyCodeLine{00067     bindParam(\textcolor{keyword}{this}, QString(\textcolor{stringliteral}{"{}premultiply\%1"{}}).arg(layer + 1).toStdString(),}
\DoxyCodeLine{00068               m\_layerParams[layer].m\_premultiply, \textcolor{keyword}{false});}
\DoxyCodeLine{00069 }
\DoxyCodeLine{00070     m\_layerParams[layer].m\_distance-\/>setValueRange(0.0, 1.0);}
\DoxyCodeLine{00071     m\_layerParams[layer].m\_bokehAdjustment-\/>setValueRange(0.0, 2.0);}
\DoxyCodeLine{00072   \}}
\DoxyCodeLine{00073 \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_iwa___bokeh_fx_a5a5fe8642872e957162b7d6859442779}\label{class_iwa___bokeh_fx_a5a5fe8642872e957162b7d6859442779}} 
\index{Iwa\_BokehFx@{Iwa\_BokehFx}!doCompute@{doCompute}}
\index{doCompute@{doCompute}!Iwa\_BokehFx@{Iwa\_BokehFx}}
\doxysubsubsection{\texorpdfstring{doCompute()}{doCompute()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Bokeh\+Fx\+::do\+Compute (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} \&}]{tile,  }\item[{double}]{frame,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{settings }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_iwa___bokeh_common_fx}{Iwa\+\_\+\+Bokeh\+Common\+Fx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00076                                                              \{}
\DoxyCodeLine{00077   \textcolor{comment}{// If the iris is not connected, then do nothing}}
\DoxyCodeLine{00078   \textcolor{keywordflow}{if} (!m\_iris.isConnected()) \{}
\DoxyCodeLine{00079     tile.getRaster()-\/>clear();}
\DoxyCodeLine{00080     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00081   \}}
\DoxyCodeLine{00082   \textcolor{comment}{// If none of the source ports is connected, then do nothing}}
\DoxyCodeLine{00083   \textcolor{keywordtype}{bool} sourceIsConnected = \textcolor{keyword}{false};}
\DoxyCodeLine{00084   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < LAYER\_NUM; i++) \{}
\DoxyCodeLine{00085     \textcolor{keywordflow}{if} (m\_layerParams[i].m\_source.isConnected()) \{}
\DoxyCodeLine{00086       sourceIsConnected = \textcolor{keyword}{true};}
\DoxyCodeLine{00087       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00088     \}}
\DoxyCodeLine{00089   \}}
\DoxyCodeLine{00090   \textcolor{keywordflow}{if} (!sourceIsConnected) \{}
\DoxyCodeLine{00091     tile.getRaster()-\/>clear();}
\DoxyCodeLine{00092     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00093   \}}
\DoxyCodeLine{00094 }
\DoxyCodeLine{00095   \textcolor{comment}{// Sort source layers by distance}}
\DoxyCodeLine{00096   QList<int> sourceIndices = getSortedSourceIndices(frame);}
\DoxyCodeLine{00097 }
\DoxyCodeLine{00098   \textcolor{comment}{// Get the pixel size of bokehAmount ( referenced ino\_blur.cpp )}}
\DoxyCodeLine{00099   \textcolor{keywordtype}{double} bokehPixelAmount = BokehUtils::getBokehPixelAmount(}
\DoxyCodeLine{00100       m\_bokehAmount-\/>getValue(frame), settings.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}});}
\DoxyCodeLine{00101 }
\DoxyCodeLine{00102   \textcolor{comment}{// Compute the bokeh size for each layer. The source tile will be enlarged by}}
\DoxyCodeLine{00103   \textcolor{comment}{// the largest size of them.}}
\DoxyCodeLine{00104   \textcolor{keywordtype}{double} maxIrisSize;}
\DoxyCodeLine{00105   QMap<int, double> irisSizes =}
\DoxyCodeLine{00106       getIrisSizes(frame, sourceIndices, bokehPixelAmount, maxIrisSize);}
\DoxyCodeLine{00107 }
\DoxyCodeLine{00108   \textcolor{keywordtype}{int} margin = tceil(maxIrisSize / 2.0);}
\DoxyCodeLine{00109 }
\DoxyCodeLine{00110   \textcolor{comment}{// Range of computation}}
\DoxyCodeLine{00111   \mbox{\hyperlink{class_t_rect_t}{TRectD}} \_rectOut(tile.m\_pos, \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tile.getRaster()-\/>getLx(),}
\DoxyCodeLine{00112                                           tile.getRaster()-\/>getLy()));}
\DoxyCodeLine{00113   \_rectOut = \_rectOut.enlarge(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(margin));}
\DoxyCodeLine{00114 }
\DoxyCodeLine{00115   \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} dimOut(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(\_rectOut.getLx() + 0.5),}
\DoxyCodeLine{00116                      \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(\_rectOut.getLy() + 0.5));}
\DoxyCodeLine{00117 }
\DoxyCodeLine{00118   \textcolor{comment}{// Enlarge the size to the "{}fast size"{} for kissfft which has no factors other}}
\DoxyCodeLine{00119   \textcolor{comment}{// than 2,3, or 5.}}
\DoxyCodeLine{00120   \textcolor{keywordflow}{if} (dimOut.lx < 10000 \&\& dimOut.ly < 10000) \{}
\DoxyCodeLine{00121     \textcolor{keywordtype}{int} new\_x = kiss\_fft\_next\_fast\_size(dimOut.lx);}
\DoxyCodeLine{00122     \textcolor{keywordtype}{int} new\_y = kiss\_fft\_next\_fast\_size(dimOut.ly);}
\DoxyCodeLine{00123     \textcolor{comment}{// margin should be integer}}
\DoxyCodeLine{00124     \textcolor{keywordflow}{while} ((new\_x -\/ dimOut.lx) \% 2 != 0)}
\DoxyCodeLine{00125       new\_x = kiss\_fft\_next\_fast\_size(new\_x + 1);}
\DoxyCodeLine{00126     \textcolor{keywordflow}{while} ((new\_y -\/ dimOut.ly) \% 2 != 0)}
\DoxyCodeLine{00127       new\_y = kiss\_fft\_next\_fast\_size(new\_y + 1);}
\DoxyCodeLine{00128 }
\DoxyCodeLine{00129     \_rectOut = \_rectOut.enlarge(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(new\_x -\/ dimOut.lx) / 2.0,}
\DoxyCodeLine{00130                                 \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(new\_y -\/ dimOut.ly) / 2.0);}
\DoxyCodeLine{00131 }
\DoxyCodeLine{00132     dimOut.lx = new\_x;}
\DoxyCodeLine{00133     dimOut.ly = new\_y;}
\DoxyCodeLine{00134   \}}
\DoxyCodeLine{00135 }
\DoxyCodeLine{00136   \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00137   \textcolor{comment}{// Compute the input tiles first}}
\DoxyCodeLine{00138   QMap<int, TTile*> sourceTiles;}
\DoxyCodeLine{00139   \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} infoOnInput(settings);}
\DoxyCodeLine{00140   infoOnInput.m\_bpp = 64;}
\DoxyCodeLine{00141   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} index : sourceIndices) \{}
\DoxyCodeLine{00142     \mbox{\hyperlink{class_t_tile}{TTile}}* layerTile = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_tile}{TTile}}();}
\DoxyCodeLine{00143     m\_layerParams[index].m\_source-\/>allocateAndCompute(}
\DoxyCodeLine{00144         *layerTile, \_rectOut.getP00(), dimOut, 0, frame, infoOnInput);}
\DoxyCodeLine{00145     sourceTiles[index] = layerTile;}
\DoxyCodeLine{00146   \}}
\DoxyCodeLine{00147 }
\DoxyCodeLine{00148   \textcolor{comment}{// Get the original size of Iris image}}
\DoxyCodeLine{00149   \mbox{\hyperlink{class_t_rect_t}{TRectD}} irisBBox;}
\DoxyCodeLine{00150   m\_iris-\/>getBBox(frame, irisBBox, settings);}
\DoxyCodeLine{00151   \textcolor{comment}{// Compute the iris tile.}}
\DoxyCodeLine{00152   \mbox{\hyperlink{class_t_tile}{TTile}} irisTile;}
\DoxyCodeLine{00153   m\_iris-\/>allocateAndCompute(}
\DoxyCodeLine{00154       irisTile, irisBBox.getP00(),}
\DoxyCodeLine{00155       \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(irisBBox.getLx() + 0.5),}
\DoxyCodeLine{00156                  \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(irisBBox.getLy() + 0.5)),}
\DoxyCodeLine{00157       tile.getRaster(), frame, settings);}
\DoxyCodeLine{00158 }
\DoxyCodeLine{00159   \textcolor{keywordtype}{double} masterHardness = m\_hardness-\/>getValue(frame);}
\DoxyCodeLine{00160 }
\DoxyCodeLine{00161   QMap<int, unsigned char*> ctrls;}
\DoxyCodeLine{00162 }
\DoxyCodeLine{00163   QList<LayerValue> layerValues;}
\DoxyCodeLine{00164   \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} index : sourceIndices) \{}
\DoxyCodeLine{00165     LayerValue layerValue;}
\DoxyCodeLine{00166     layerValue.sourceTile = sourceTiles[index];}
\DoxyCodeLine{00167     layerValue.premultiply =}
\DoxyCodeLine{00168         m\_layerParams[index].m\_premultiply-\/>getValue() ? 1 : 0;}
\DoxyCodeLine{00169     layerValue.layerHardness = masterHardness;}
\DoxyCodeLine{00170     layerValue.depth\_ref     = 0;}
\DoxyCodeLine{00171     layerValue.irisSize      = irisSizes.value(index);}
\DoxyCodeLine{00172     layerValue.distance      = m\_layerParams[index].m\_distance-\/>getValue(frame);}
\DoxyCodeLine{00173     layerValue.bokehAdjustment =}
\DoxyCodeLine{00174         m\_layerParams[index].m\_bokehAdjustment-\/>getValue(frame);}
\DoxyCodeLine{00175     layerValues.append(layerValue);}
\DoxyCodeLine{00176   \}}
\DoxyCodeLine{00177 }
\DoxyCodeLine{00178   Iwa\_BokehCommonFx::doFx(tile, frame, settings, bokehPixelAmount, margin,}
\DoxyCodeLine{00179                           dimOut, irisBBox, irisTile, layerValues, ctrls);}
\DoxyCodeLine{00180   qDeleteAll(sourceTiles);}
\DoxyCodeLine{00181 \}}

\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+bokehfx.\+h\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+bokehfx.\+cpp\end{DoxyCompactItemize}
