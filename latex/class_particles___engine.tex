\hypertarget{class_particles___engine}{}\doxysection{Particles\+\_\+\+Engine Class Reference}
\label{class_particles___engine}\index{Particles\_Engine@{Particles\_Engine}}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_particles___engine_a6a643d3bcce96241986846cf6d207798}{Particles\+\_\+\+Engine}} (\mbox{\hyperlink{class_particles_fx}{Particles\+Fx}} $\ast$parent, double frame)
\item 
\mbox{\Hypertarget{class_particles___engine_a4329fd86e654d5df42cd3da11d7191b8}\label{class_particles___engine_a4329fd86e654d5df42cd3da11d7191b8}} 
void {\bfseries scramble\+\_\+particles} (void)
\item 
void \mbox{\hyperlink{class_particles___engine_afdd23542480a7b25a65ad6bcd7bf1106}{fill\+\_\+range\+\_\+struct}} (struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, struct \mbox{\hyperlink{structparticles__ranges}{particles\+\_\+ranges}} \&ranges)
\item 
void \mbox{\hyperlink{class_particles___engine_abe399b2056ac8e417408d3b68b6d2428}{fill\+\_\+value\+\_\+struct}} (struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&value, double frame)
\item 
void \mbox{\hyperlink{class_particles___engine_a09e5db1ac2446bbcde754102a3030bd2}{roll\+\_\+particles}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$ porttiles, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, std\+::list$<$ \mbox{\hyperlink{class_particle}{Particle}} $>$ \&my\+Particles, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, float cx, float cy, int frame, int curr\+\_\+frame, int level\+\_\+n, bool $\ast$random\+\_\+level, float dpi, std\+::vector$<$ int $>$ lastframe, int \&totalparticles)
\item 
void \mbox{\hyperlink{class_particles___engine_a34f547141f79b53786ec88026fc7b523}{normalize\+\_\+values}} (struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri)
\item 
void \mbox{\hyperlink{class_particles___engine_ab7574ab8a9217f960e1ce339e90c18dc}{render\+\_\+particles}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ part\+\_\+ports, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&p\+\_\+size, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&p\+\_\+offset, std\+::map$<$ int, \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ ctrl\+\_\+ports, std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$ part\+Level, float dpi, int curr\+\_\+frame, int shrink, double startx, double starty, double endx, double endy, std\+::vector$<$ int $>$ lastframe, unsigned long fx\+Id)
\item 
void \mbox{\hyperlink{class_particles___engine_aab8949faf354bbfdb3a8924b7fdf6f7e}{do\+\_\+render}} (\mbox{\hyperlink{class_particle}{Particle}} $\ast$part, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ part\+\_\+ports, std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$ porttiles, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&p\+\_\+size, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&p\+\_\+offset, int lastframe, std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$ part\+Level, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, double opacity\+\_\+range, int curr\+\_\+frame, std\+::map$<$ std\+::pair$<$ int, int $>$, double $>$ \&part\+Scales)
\item 
bool \mbox{\hyperlink{class_particles___engine_af32131f9ec282edf022cf31d64c649a6}{port\+\_\+is\+\_\+used}} (int i, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values)
\item 
bool \mbox{\hyperlink{class_particles___engine_ae93e03a8c641edfbe8a7b33fb6a1fa48}{port\+\_\+is\+\_\+used\+\_\+for\+\_\+value}} (int i, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values)
\item 
bool \mbox{\hyperlink{class_particles___engine_a661623d1f20fea584375a24ec1911471}{port\+\_\+is\+\_\+used\+\_\+for\+\_\+gradient}} (int i, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values)
\item 
void \mbox{\hyperlink{class_particles___engine_af3066bd24bec784f377849544f916534}{fill\+\_\+regions}} (int frame, std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, bool multi, int thres, bool do\+\_\+source\+\_\+gradation, std\+::vector$<$ std\+::vector$<$ int $>$ $>$ \&my\+Histogram)
\item 
void \mbox{\hyperlink{class_particles___engine_a1dd98c8f78b92b7715af11295577e09c}{fill\+\_\+single\+\_\+region}} (std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, int thres, bool do\+\_\+source\+\_\+gradation, std\+::vector$<$ std\+::vector$<$ int $>$ $>$ \&my\+Histogram)
\item 
void \mbox{\hyperlink{class_particles___engine_ae96c2d7be493116384ee9845831bc6bd}{fill\+\_\+regions\+\_\+with\+\_\+size\+\_\+map}} (std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, std\+::vector$<$ std\+::vector$<$ int $>$ $>$ \&my\+Histogram, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$size\+Tile, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$source\+Tile, int thres)
\item 
void \mbox{\hyperlink{class_particles___engine_ab92d32ddd8f0516b4a2ba25d29595c7b}{fill\+\_\+subregions}} (int cont\+\_\+index, std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, int thres)
\item 
void \mbox{\hyperlink{class_particles___engine_a17b1897dea0bc5f80d4d81a43d3cb6b4}{normalize\+\_\+array}} (std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, \mbox{\hyperlink{class_t_point_t}{TPointD}} pos, int lx, int ly, int regioncounter, std\+::vector$<$ int $>$ \&myarray, std\+::vector$<$ int $>$ \&lista, std\+::vector$<$ int $>$ \&listb, std\+::vector$<$ int $>$ \&final)
\item 
void \mbox{\hyperlink{class_particles___engine_a1af1efc8a70dc3c9e9e3a50c97b702c6}{fill\+\_\+array}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, int \&regioncount, std\+::vector$<$ int $>$ \&myarray, std\+::vector$<$ int $>$ \&lista, std\+::vector$<$ int $>$ \&listb, int thres)
\end{DoxyCompactItemize}
\doxysubsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_particles_fx}{Particles\+Fx}} $\ast$ \mbox{\hyperlink{class_particles___engine_a4d9ac86983ecdde346bf1f865aec8d5f}{m\+\_\+parent}}
\item 
double \mbox{\hyperlink{class_particles___engine_afeaa4f1b12435855c7a7f662fdbf0d1e}{m\+\_\+frame}}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_particles___engine_a6a643d3bcce96241986846cf6d207798}\label{class_particles___engine_a6a643d3bcce96241986846cf6d207798}} 
\index{Particles\_Engine@{Particles\_Engine}!Particles\_Engine@{Particles\_Engine}}
\index{Particles\_Engine@{Particles\_Engine}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{Particles\_Engine()}{Particles\_Engine()}}
{\footnotesize\ttfamily Particles\+\_\+\+Engine\+::\+Particles\+\_\+\+Engine (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_particles_fx}{Particles\+Fx}} $\ast$}]{parent,  }\item[{double}]{frame }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00033     : m\_parent(parent), m\_frame(frame) \{\}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a60db50be8cbb0028247a63c6dcdc12c2}\label{class_particles___engine_a60db50be8cbb0028247a63c6dcdc12c2}} 
\index{Particles\_Engine@{Particles\_Engine}!````~Particles\_Engine@{$\sim$Particles\_Engine}}
\index{````~Particles\_Engine@{$\sim$Particles\_Engine}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{$\sim$Particles\_Engine()}{~Particles\_Engine()}}
{\footnotesize\ttfamily Particles\+\_\+\+Engine\+::$\sim$\+Particles\+\_\+\+Engine (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00019 \{\};}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_particles___engine_aab8949faf354bbfdb3a8924b7fdf6f7e}\label{class_particles___engine_aab8949faf354bbfdb3a8924b7fdf6f7e}} 
\index{Particles\_Engine@{Particles\_Engine}!do\_render@{do\_render}}
\index{do\_render@{do\_render}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{do\_render()}{do\_render()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::do\+\_\+render (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_particle}{Particle}} $\ast$}]{part,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{part\+\_\+ports,  }\item[{std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$}]{porttiles,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&}]{p\+\_\+size,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{p\+\_\+offset,  }\item[{int}]{lastframe,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$}]{part\+Level,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{double}]{opacity\+\_\+range,  }\item[{int}]{curr\+\_\+frame,  }\item[{std\+::map$<$ std\+::pair$<$ int, int $>$, double $>$ \&}]{part\+Scales }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00717                                                    \{}
\DoxyCodeLine{00718   \textcolor{comment}{// Retrieve the particle frame -\/ that is, the *column frame* from which we are}}
\DoxyCodeLine{00719   \textcolor{comment}{// picking}}
\DoxyCodeLine{00720   \textcolor{comment}{// the particle to be rendered.}}
\DoxyCodeLine{00721   \textcolor{keywordtype}{int} ndx = part-\/>frame \% lastframe;}
\DoxyCodeLine{00722 }
\DoxyCodeLine{00723   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} tileRas(tile-\/>getRaster());}
\DoxyCodeLine{00724 }
\DoxyCodeLine{00725   std::string levelid;}
\DoxyCodeLine{00726   \textcolor{keywordtype}{double} aim\_angle = 0;}
\DoxyCodeLine{00727   \textcolor{keywordflow}{if} (values.pathaim\_val) \{}
\DoxyCodeLine{00728     \textcolor{keywordtype}{double} arctan = atan2(part-\/>vy, part-\/>vx);}
\DoxyCodeLine{00729     aim\_angle     = arctan * M\_180\_PI;}
\DoxyCodeLine{00730   \}}
\DoxyCodeLine{00731 }
\DoxyCodeLine{00732   \textcolor{comment}{// Calculate the rotational and scale components we have to apply on the}}
\DoxyCodeLine{00733   \textcolor{comment}{// particle}}
\DoxyCodeLine{00734   \mbox{\hyperlink{class_t_rotation}{TRotation}} rotM(part-\/>angle + aim\_angle);}
\DoxyCodeLine{00735   \mbox{\hyperlink{class_t_scale}{TScale}} scaleM(part-\/>scale);}
\DoxyCodeLine{00736   \mbox{\hyperlink{class_t_affine}{TAffine}} M(rotM * scaleM);}
\DoxyCodeLine{00737 }
\DoxyCodeLine{00738   \textcolor{comment}{// Particles deal with dpi affines on their own}}
\DoxyCodeLine{00739   \mbox{\hyperlink{class_t_affine}{TAffine}} scaleAff(m\_parent-\/>handledAffine(ri, m\_frame));}
\DoxyCodeLine{00740   \textcolor{keywordtype}{double} partScale =}
\DoxyCodeLine{00741       scaleAff.a11 * partScales[std::pair<int, int>(part-\/>level, ndx)];}
\DoxyCodeLine{00742   \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}} partResolution(0, 0);}
\DoxyCodeLine{00743   \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riNew(ri);}
\DoxyCodeLine{00744 }
\DoxyCodeLine{00745   \textcolor{comment}{// Retrieve the bounding box in the standard reference}}
\DoxyCodeLine{00746   \mbox{\hyperlink{class_t_rect_t}{TRectD}} bbox(-\/5.0, -\/5.0, 5.0, 5.0), standardRefBBox;}
\DoxyCodeLine{00747   \textcolor{keywordflow}{if} (part-\/>level <}
\DoxyCodeLine{00748           (\textcolor{keywordtype}{int})part\_ports.size() \&\&  \textcolor{comment}{// Not the default levelless cases}}
\DoxyCodeLine{00749       part\_ports[part-\/>level]-\/>isConnected()) \{}
\DoxyCodeLine{00750     \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riIdentity(ri);}
\DoxyCodeLine{00751     riIdentity.m\_affine = \mbox{\hyperlink{class_t_affine}{TAffine}}();}
\DoxyCodeLine{00752 }
\DoxyCodeLine{00753     (*part\_ports[part-\/>level])-\/>getBBox(ndx, bbox, riIdentity);}
\DoxyCodeLine{00754 }
\DoxyCodeLine{00755     \textcolor{comment}{// A particle's bbox MUST be finite. Gradients and such which have an}}
\DoxyCodeLine{00756     \textcolor{comment}{// infinite bbox}}
\DoxyCodeLine{00757     \textcolor{comment}{// are just NOT rendered.}}
\DoxyCodeLine{00758 }
\DoxyCodeLine{00759     \textcolor{comment}{// NOTE: No fx returns half-\/planes or similar (ie if any coordinate is}}
\DoxyCodeLine{00760     \textcolor{comment}{// either}}
\DoxyCodeLine{00761     \textcolor{comment}{// (std::numeric\_limits<double>::max)() or its opposite, then the rect IS}}
\DoxyCodeLine{00762     \textcolor{comment}{// THE infiniteRectD)}}
\DoxyCodeLine{00763     \textcolor{keywordflow}{if} (bbox.isEmpty() || bbox == TConsts::infiniteRectD) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00764   \}}
\DoxyCodeLine{00765 }
\DoxyCodeLine{00766   \textcolor{comment}{// Now, these are the particle rendering specifications}}
\DoxyCodeLine{00767   bbox            = bbox.enlarge(3);}
\DoxyCodeLine{00768   standardRefBBox = bbox;}
\DoxyCodeLine{00769   riNew.m\_affine  = \mbox{\hyperlink{class_t_scale}{TScale}}(partScale);}
\DoxyCodeLine{00770   bbox            = riNew.m\_affine * bbox;}
\DoxyCodeLine{00771   \textcolor{comment}{/*-\/ 縮小済みのParticleのサイズ -\/*/}}
\DoxyCodeLine{00772   partResolution = \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tceil(bbox.getLx()), tceil(bbox.getLy()));}
\DoxyCodeLine{00773 }
\DoxyCodeLine{00774   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} ras;}
\DoxyCodeLine{00775 }
\DoxyCodeLine{00776   std::string alias;}
\DoxyCodeLine{00777   \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg;}
\DoxyCodeLine{00778   rimg = partLevel[part-\/>level]-\/>frame(ndx);}
\DoxyCodeLine{00779   \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00780     ras = rimg-\/>getRaster();}
\DoxyCodeLine{00781   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00782     alias = \textcolor{stringliteral}{"{}PART: "{}} + (*part\_ports[part-\/>level])-\/>getAlias(ndx, riNew);}
\DoxyCodeLine{00783     rimg  = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{00784     \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00785       ras = rimg-\/>getRaster();}
\DoxyCodeLine{00786 }
\DoxyCodeLine{00787       \textcolor{comment}{// Check that the raster resolution is sufficient for our purposes}}
\DoxyCodeLine{00788       \textcolor{keywordflow}{if} (ras-\/>getLx() < partResolution.lx || ras-\/>getLy() < partResolution.ly)}
\DoxyCodeLine{00789         ras = 0;}
\DoxyCodeLine{00790       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00791         partResolution = \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(ras-\/>getLx(), ras-\/>getLy());}
\DoxyCodeLine{00792     \}}
\DoxyCodeLine{00793   \}}
\DoxyCodeLine{00794 }
\DoxyCodeLine{00795   \textcolor{comment}{// We are interested in making the relation between scale and (integer)}}
\DoxyCodeLine{00796   \textcolor{comment}{// resolution}}
\DoxyCodeLine{00797   \textcolor{comment}{// bijective -\/ since we shall cache by using resolution as a partial}}
\DoxyCodeLine{00798   \textcolor{comment}{// identification parameter.}}
\DoxyCodeLine{00799   \textcolor{comment}{// Therefore, we find the current bbox Lx and take a unique scale out of it.}}
\DoxyCodeLine{00800   partScale      = partResolution.lx / standardRefBBox.getLx();}
\DoxyCodeLine{00801   riNew.m\_affine = \mbox{\hyperlink{class_t_scale}{TScale}}(partScale);}
\DoxyCodeLine{00802   bbox           = riNew.m\_affine * standardRefBBox;}
\DoxyCodeLine{00803 }
\DoxyCodeLine{00804   \textcolor{comment}{// If no image was retrieved from the cache (or it was not scaled enough),}}
\DoxyCodeLine{00805   \textcolor{comment}{// calculate it}}
\DoxyCodeLine{00806   \textcolor{keywordflow}{if} (!ras) \{}
\DoxyCodeLine{00807     \mbox{\hyperlink{class_t_tile}{TTile}} auxTile;}
\DoxyCodeLine{00808     (*part\_ports[part-\/>level])}
\DoxyCodeLine{00809         -\/>allocateAndCompute(auxTile, bbox.getP00(),}
\DoxyCodeLine{00810                              \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(partResolution.lx, partResolution.ly),}
\DoxyCodeLine{00811                              tile-\/>getRaster(), ndx, riNew);}
\DoxyCodeLine{00812     ras = auxTile.getRaster();}
\DoxyCodeLine{00813 }
\DoxyCodeLine{00814     \textcolor{comment}{// For now, we'll just use 32 bit particles}}
\DoxyCodeLine{00815     \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} rcachepart;}
\DoxyCodeLine{00816     rcachepart = ras;}
\DoxyCodeLine{00817     \textcolor{keywordflow}{if} (!rcachepart) \{}
\DoxyCodeLine{00818       rcachepart = \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}}(ras-\/>getSize());}
\DoxyCodeLine{00819       \mbox{\hyperlink{namespace_t_rop_a45a08fb48dd7d33ec629d722081d55c6}{TRop::convert}}(rcachepart, ras);}
\DoxyCodeLine{00820     \}}
\DoxyCodeLine{00821     ras = rcachepart;}
\DoxyCodeLine{00822 }
\DoxyCodeLine{00823     \textcolor{comment}{// Finally, cache the particle}}
\DoxyCodeLine{00824     addRenderCache(alias, \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}}(ras));}
\DoxyCodeLine{00825   \}}
\DoxyCodeLine{00826 }
\DoxyCodeLine{00827   \textcolor{keywordflow}{if} (!ras) \textcolor{keywordflow}{return};  \textcolor{comment}{// At this point, it should never happen anyway...}}
\DoxyCodeLine{00828 }
\DoxyCodeLine{00829   \textcolor{comment}{// Deal with particle colors/opacity}}
\DoxyCodeLine{00830   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} rfinalpart;}
\DoxyCodeLine{00831   \textcolor{keywordtype}{double} curr\_opacity =}
\DoxyCodeLine{00832       part-\/>set\_Opacity(porttiles, values, opacity\_range, dist\_frame);}
\DoxyCodeLine{00833   \textcolor{keywordflow}{if} (curr\_opacity != 1.0 || part-\/>gencol.fadecol || part-\/>fincol.fadecol ||}
\DoxyCodeLine{00834       part-\/>foutcol.fadecol) \{}
\DoxyCodeLine{00835     \textcolor{comment}{/*-\/ 毎フレーム現在位置のピクセル色を参照 -\/*/}}
\DoxyCodeLine{00836     \textcolor{keywordflow}{if} (values.pick\_color\_for\_every\_frame\_val \&\& values.gencol\_ctrl\_val \&\&}
\DoxyCodeLine{00837         (porttiles.find(values.gencol\_ctrl\_val) != porttiles.end()))}
\DoxyCodeLine{00838       part-\/>get\_image\_reference(porttiles[values.gencol\_ctrl\_val], values,}
\DoxyCodeLine{00839                                 part-\/>gencol.col);}
\DoxyCodeLine{00840 }
\DoxyCodeLine{00841     rfinalpart = ras-\/>clone();}
\DoxyCodeLine{00842     part-\/>modify\_colors\_and\_opacity(values, curr\_opacity, dist\_frame,}
\DoxyCodeLine{00843                                     rfinalpart);}
\DoxyCodeLine{00844   \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{00845     rfinalpart = ras;}
\DoxyCodeLine{00846 }
\DoxyCodeLine{00847   \textcolor{comment}{// Now, let's build the particle transform before it is overed on the output}}
\DoxyCodeLine{00848   \textcolor{comment}{// tile}}
\DoxyCodeLine{00849 }
\DoxyCodeLine{00850   \textcolor{comment}{// First, complete the transform by adding the rotational and scale}}
\DoxyCodeLine{00851   \textcolor{comment}{// components from}}
\DoxyCodeLine{00852   \textcolor{comment}{// Particles parameters}}
\DoxyCodeLine{00853   M = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}} * M * \mbox{\hyperlink{class_t_scale}{TScale}}(1.0 / partScale);}
\DoxyCodeLine{00854 }
\DoxyCodeLine{00855   \textcolor{comment}{// Then, retrieve the particle position in current reference.}}
\DoxyCodeLine{00856   \mbox{\hyperlink{class_t_point_t}{TPointD}} pos(part-\/>x, part-\/>y);}
\DoxyCodeLine{00857   pos = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}} * pos;}
\DoxyCodeLine{00858 }
\DoxyCodeLine{00859   \textcolor{comment}{// Finally, add the translational component to the particle}}
\DoxyCodeLine{00860   \textcolor{comment}{// NOTE: p\_offset is added to account for the particle relative position}}
\DoxyCodeLine{00861   \textcolor{comment}{// inside its level's bbox}}
\DoxyCodeLine{00862   M = \mbox{\hyperlink{class_t_translation}{TTranslation}}(pos -\/ tile-\/>m\_pos) * M * \mbox{\hyperlink{class_t_translation}{TTranslation}}(bbox.getP00());}
\DoxyCodeLine{00863 }
\DoxyCodeLine{00864   \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} myras32 = tile-\/>getRaster())}
\DoxyCodeLine{00865     \mbox{\hyperlink{namespace_t_rop_ae5fd1fb0c2f625e1da14fe92ae0e5122}{TRop::over}}(tileRas, rfinalpart, M);}
\DoxyCodeLine{00866   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} myras64 = tile-\/>getRaster())}
\DoxyCodeLine{00867     \mbox{\hyperlink{namespace_t_rop_ae5fd1fb0c2f625e1da14fe92ae0e5122}{TRop::over}}(tileRas, rfinalpart, M);}
\DoxyCodeLine{00868   \textcolor{keywordflow}{else}}
\DoxyCodeLine{00869     \textcolor{keywordflow}{throw} \mbox{\hyperlink{class_t_exception}{TException}}(\textcolor{stringliteral}{"{}ParticlesFx: unsupported Pixel Type"{}});}
\DoxyCodeLine{00870 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a1af1efc8a70dc3c9e9e3a50c97b702c6}\label{class_particles___engine_a1af1efc8a70dc3c9e9e3a50c97b702c6}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_array@{fill\_array}}
\index{fill\_array@{fill\_array}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_array()}{fill\_array()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+array (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{int \&}]{regioncount,  }\item[{std\+::vector$<$ int $>$ \&}]{myarray,  }\item[{std\+::vector$<$ int $>$ \&}]{lista,  }\item[{std\+::vector$<$ int $>$ \&}]{listb,  }\item[{int}]{thres }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00877                                                                         \{}
\DoxyCodeLine{00878   \textcolor{keywordtype}{int} pr = 0;}
\DoxyCodeLine{00879   \textcolor{keywordtype}{int} i, j;}
\DoxyCodeLine{00880   \textcolor{keywordtype}{int} lx, ly;}
\DoxyCodeLine{00881   lx = ctrl1-\/>getRaster()-\/>getLx();}
\DoxyCodeLine{00882   ly = ctrl1-\/>getRaster()-\/>getLy();}
\DoxyCodeLine{00883 }
\DoxyCodeLine{00884   \textcolor{comment}{/*prima riga*/}}
\DoxyCodeLine{00885   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} raster32 = ctrl1-\/>getRaster();}
\DoxyCodeLine{00886   raster32-\/>lock();}
\DoxyCodeLine{00887   TPixel32 *pix = raster32-\/>pixels(0);}
\DoxyCodeLine{00888   \textcolor{keywordflow}{for} (i = 0; i < lx; i++) \{}
\DoxyCodeLine{00889     \textcolor{keywordflow}{if} (pix-\/>m > threshold) \{}
\DoxyCodeLine{00890       pr++;}
\DoxyCodeLine{00891       \textcolor{keywordflow}{if} (!i) \{}
\DoxyCodeLine{00892         (regioncount)++;}
\DoxyCodeLine{00893         myarray[i] = (regioncount);}
\DoxyCodeLine{00894       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00895         \textcolor{keywordflow}{if} (myarray[i -\/ 1]) myarray[i] = myarray[i -\/ 1];}
\DoxyCodeLine{00896       \}}
\DoxyCodeLine{00897     \}}
\DoxyCodeLine{00898     pix++;}
\DoxyCodeLine{00899   \}}
\DoxyCodeLine{00900 }
\DoxyCodeLine{00901   \textcolor{keywordflow}{for} (j = 1; j < ly; j++) \{}
\DoxyCodeLine{00902     \textcolor{keywordflow}{for} (i = 0, pix = raster32-\/>pixels(j); i < lx; i++, pix++) \{}
\DoxyCodeLine{00903       \textcolor{comment}{/*TMSG\_INFO("{}j=\%d i=\%d\(\backslash\)n"{}, j, i);*/}}
\DoxyCodeLine{00904       \textcolor{keywordflow}{if} (pix-\/>m > threshold) \{}
\DoxyCodeLine{00905         std::vector<int> mask(4);}
\DoxyCodeLine{00906         pr++;}
\DoxyCodeLine{00907         \textcolor{comment}{/* l,ul,u,ur;*/}}
\DoxyCodeLine{00908         \textcolor{keywordflow}{if} (i) \{}
\DoxyCodeLine{00909           mask[0] = myarray[i -\/ 1 + lx * j];}
\DoxyCodeLine{00910           mask[1] = myarray[i -\/ 1 + lx * (j -\/ 1)];}
\DoxyCodeLine{00911         \}}
\DoxyCodeLine{00912         \textcolor{keywordflow}{if} (i != lx -\/ 1) mask[3] = myarray[i + 1 + lx * (j -\/ 1)];}
\DoxyCodeLine{00913         mask[2] = myarray[i + lx * (j -\/ 1)];}
\DoxyCodeLine{00914         \textcolor{keywordflow}{if} (!mask[0] \&\& !mask[1] \&\& !mask[2] \&\& !mask[3]) \{}
\DoxyCodeLine{00915           (regioncount)++;}
\DoxyCodeLine{00916           myarray[i + lx * j] = (regioncount);}
\DoxyCodeLine{00917         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00918           \textcolor{keywordtype}{int} mc, firsttime = 1;}
\DoxyCodeLine{00919           \textcolor{keywordflow}{for} (mc = 0; mc < 4; mc++) \{}
\DoxyCodeLine{00920             \textcolor{keywordflow}{if} (mask[mc]) \{}
\DoxyCodeLine{00921               \textcolor{keywordflow}{if} (firsttime) \{}
\DoxyCodeLine{00922                 myarray[i + lx * j] = mask[mc];}
\DoxyCodeLine{00923                 firsttime           = 0;}
\DoxyCodeLine{00924               \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00925                 \textcolor{keywordflow}{if} (myarray[i + lx * j] != mask[mc]) \{}
\DoxyCodeLine{00926                   lista.push\_back(myarray[i + lx * j]);}
\DoxyCodeLine{00927                   listb.push\_back(mask[mc]);}
\DoxyCodeLine{00928 }
\DoxyCodeLine{00929                   \textcolor{comment}{/*TMSG\_INFO("{}j=\%d i=\%d mc=\%d, mask=\%d\(\backslash\)n"{}, j, i, mc,}}
\DoxyCodeLine{00930 \textcolor{comment}{                   * mask[mc]);*/}}
\DoxyCodeLine{00931                 \}}
\DoxyCodeLine{00932               \}}
\DoxyCodeLine{00933             \}}
\DoxyCodeLine{00934           \}}
\DoxyCodeLine{00935         \}}
\DoxyCodeLine{00936       \}}
\DoxyCodeLine{00937     \}}
\DoxyCodeLine{00938   \}}
\DoxyCodeLine{00939   raster32-\/>unlock();}
\DoxyCodeLine{00940 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_afdd23542480a7b25a65ad6bcd7bf1106}\label{class_particles___engine_afdd23542480a7b25a65ad6bcd7bf1106}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_range\_struct@{fill\_range\_struct}}
\index{fill\_range\_struct@{fill\_range\_struct}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_range\_struct()}{fill\_range\_struct()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+range\+\_\+struct (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{struct \mbox{\hyperlink{structparticles__ranges}{particles\+\_\+ranges}} \&}]{ranges }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00143                                                                           \{}
\DoxyCodeLine{00144   ranges.swing\_range = values.swing\_val.second -\/ values.swing\_val.first;}
\DoxyCodeLine{00145   ranges.rotswing\_range =}
\DoxyCodeLine{00146       values.rotswing\_val.second -\/ values.rotswing\_val.first;}
\DoxyCodeLine{00147   ranges.randomx\_range = values.randomx\_val.second -\/ values.randomx\_val.first;}
\DoxyCodeLine{00148   ranges.randomy\_range = values.randomy\_val.second -\/ values.randomy\_val.first;}
\DoxyCodeLine{00149   ranges.rotsca\_range  = values.rotsca\_val.second -\/ values.rotsca\_val.first;}
\DoxyCodeLine{00150   ranges.rot\_range     = values.rot\_val.second -\/ values.rot\_val.first;}
\DoxyCodeLine{00151   ranges.speed\_range   = values.speed\_val.second -\/ values.speed\_val.first;}
\DoxyCodeLine{00152   ranges.speeda\_range  = values.speeda\_val.second -\/ values.speeda\_val.first;}
\DoxyCodeLine{00153   ranges.mass\_range    = values.mass\_val.second -\/ values.mass\_val.first;}
\DoxyCodeLine{00154   ranges.scale\_range   = values.scale\_val.second -\/ values.scale\_val.first;}
\DoxyCodeLine{00155   ranges.lifetime\_range =}
\DoxyCodeLine{00156       values.lifetime\_val.second -\/ values.lifetime\_val.first;}
\DoxyCodeLine{00157   ranges.scalestep\_range =}
\DoxyCodeLine{00158       values.scalestep\_val.second -\/ values.scalestep\_val.first;}
\DoxyCodeLine{00159   ranges.trail\_range = (int)(values.trail\_val.second -\/ values.trail\_val.first);}
\DoxyCodeLine{00160 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_af3066bd24bec784f377849544f916534}\label{class_particles___engine_af3066bd24bec784f377849544f916534}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_regions@{fill\_regions}}
\index{fill\_regions@{fill\_regions}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_regions()}{fill\_regions()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+regions (\begin{DoxyParamCaption}\item[{int}]{frame,  }\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{bool}]{multi,  }\item[{int}]{thres,  }\item[{bool}]{do\+\_\+source\+\_\+gradation,  }\item[{std\+::vector$<$ std\+::vector$<$ int $>$ $>$ \&}]{my\+Histogram }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01114                                             \{}
\DoxyCodeLine{01115   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} ctrl1ras = ctrl1-\/>getRaster();}
\DoxyCodeLine{01116   \textcolor{keywordflow}{if} (!ctrl1ras) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01117   \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{01118   \textcolor{keywordflow}{if} (frame <= 0)}
\DoxyCodeLine{01119     i = 0;}
\DoxyCodeLine{01120   \textcolor{keywordflow}{else}}
\DoxyCodeLine{01121     i = frame;}
\DoxyCodeLine{01122 }
\DoxyCodeLine{01123   \textcolor{keywordflow}{if} (multi) \{}
\DoxyCodeLine{01124     fill\_subregions(i, myregions, ctrl1, thres);}
\DoxyCodeLine{01125   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01126     fill\_single\_region(myregions, ctrl1, thres, do\_source\_gradation,}
\DoxyCodeLine{01127                        myHistogram);}
\DoxyCodeLine{01128   \}}
\DoxyCodeLine{01129 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_ae96c2d7be493116384ee9845831bc6bd}\label{class_particles___engine_ae96c2d7be493116384ee9845831bc6bd}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_regions\_with\_size\_map@{fill\_regions\_with\_size\_map}}
\index{fill\_regions\_with\_size\_map@{fill\_regions\_with\_size\_map}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_regions\_with\_size\_map()}{fill\_regions\_with\_size\_map()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+regions\+\_\+with\+\_\+size\+\_\+map (\begin{DoxyParamCaption}\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{std\+::vector$<$ std\+::vector$<$ int $>$ $>$ \&}]{my\+Histogram,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{size\+Tile,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{source\+Tile,  }\item[{int}]{thres }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01140                                   \{}
\DoxyCodeLine{01141   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} sizeRas = sizeTile-\/>getRaster();}
\DoxyCodeLine{01142   \textcolor{keywordflow}{if} (!sizeRas) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01143 }
\DoxyCodeLine{01144   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} sourceRas;}
\DoxyCodeLine{01145   \textcolor{keywordflow}{if} (sourceTile) sourceRas = sourceTile-\/>getRaster();}
\DoxyCodeLine{01146 }
\DoxyCodeLine{01147   sizeRas-\/>lock();}
\DoxyCodeLine{01148   \textcolor{keywordflow}{if} (sourceRas) sourceRas-\/>lock();}
\DoxyCodeLine{01149 }
\DoxyCodeLine{01150   myregions.resize(1);}
\DoxyCodeLine{01151   myregions[0].clear();}
\DoxyCodeLine{01152   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 256; i++) myHistogram.push\_back(std::vector<int>());}
\DoxyCodeLine{01153 }
\DoxyCodeLine{01154   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < sizeRas-\/>getLy(); j++) \{}
\DoxyCodeLine{01155     TPixel32 *pix    = sizeRas-\/>pixels(j);}
\DoxyCodeLine{01156     TPixel32 *endPix = pix + sizeRas-\/>getLx();}
\DoxyCodeLine{01157 }
\DoxyCodeLine{01158     TPixel32 *sourcePixHead = 0;}
\DoxyCodeLine{01159     \textcolor{keywordflow}{if} (sourceRas) \{}
\DoxyCodeLine{01160       \textcolor{keywordtype}{int} sourceYPos = troundp(j + sizeTile-\/>m\_pos.y -\/ sourceTile-\/>m\_pos.y);}
\DoxyCodeLine{01161       \textcolor{keywordflow}{if} (sourceYPos >= 0 \&\& sourceYPos < sourceRas-\/>getLy())}
\DoxyCodeLine{01162         sourcePixHead = sourceRas-\/>pixels(sourceYPos);}
\DoxyCodeLine{01163     \}}
\DoxyCodeLine{01164 }
\DoxyCodeLine{01165     \textcolor{keywordtype}{int} i               = 0;}
\DoxyCodeLine{01166     TPixel32 *sourcePix = 0;}
\DoxyCodeLine{01167     \textcolor{keywordflow}{while} (pix < endPix) \{}
\DoxyCodeLine{01168       \textcolor{keywordflow}{if} (sourceRas) \{}
\DoxyCodeLine{01169         \textcolor{keywordtype}{int} sourceXPos = (int)(i + sizeTile-\/>m\_pos.x -\/ sourceTile-\/>m\_pos.x);}
\DoxyCodeLine{01170         \textcolor{keywordflow}{if} (sourcePixHead \&\& sourceXPos >= 0 \&\& sourceXPos < sourceRas-\/>getLx())}
\DoxyCodeLine{01171           sourcePix = sourcePixHead + sourceXPos;}
\DoxyCodeLine{01172         \textcolor{keywordflow}{else}}
\DoxyCodeLine{01173           sourcePix = 0;}
\DoxyCodeLine{01174       \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{01175         sourcePix = 0;}
\DoxyCodeLine{01176 }
\DoxyCodeLine{01177       \textcolor{comment}{/*-\/}}
\DoxyCodeLine{01178 \textcolor{comment}{       * Source画像があって、ピクセルがバウンディング外またはアルファが０なら抜かす。}}
\DoxyCodeLine{01179 \textcolor{comment}{       * -\/*/}}
\DoxyCodeLine{01180       \textcolor{keywordflow}{if} (sourceRas \&\& (!sourcePix || sourcePix-\/>m <= thres)) \{}
\DoxyCodeLine{01181       \}}
\DoxyCodeLine{01182       \textcolor{comment}{/*-\/}}
\DoxyCodeLine{01183 \textcolor{comment}{         明度に比例してパーティクルを発生させる。そのピクセルのアルファ値の数だけ「立候補」させる。-\/*/}}
\DoxyCodeLine{01184       \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01185         \mbox{\hyperlink{class_t_point_t}{TPointD}} tmp;}
\DoxyCodeLine{01186         tmp.y = j;}
\DoxyCodeLine{01187         tmp.x = i;}
\DoxyCodeLine{01188         tmp += sizeTile-\/>m\_pos;}
\DoxyCodeLine{01189 }
\DoxyCodeLine{01190         \textcolor{keywordtype}{int} val = (int)\mbox{\hyperlink{class_t_pixel_g_r8_aa60eac9adab1b27ada505bffd6301e51}{TPixelGR8::from}}(*pix).value;}
\DoxyCodeLine{01191 }
\DoxyCodeLine{01192         \textcolor{comment}{/*-\/ Histogramの登録 -\/*/}}
\DoxyCodeLine{01193         myHistogram[val].push\_back((\textcolor{keywordtype}{int})myregions[0].size());}
\DoxyCodeLine{01194 }
\DoxyCodeLine{01195         \textcolor{comment}{/*-\/ 各Pointにウェイトを持たせる -\/*/}}
\DoxyCodeLine{01196         myregions[0].push\_back(tmp);}
\DoxyCodeLine{01197       \}}
\DoxyCodeLine{01198 }
\DoxyCodeLine{01199       i++;}
\DoxyCodeLine{01200       pix++;}
\DoxyCodeLine{01201     \}}
\DoxyCodeLine{01202   \}}
\DoxyCodeLine{01203 }
\DoxyCodeLine{01204   \textcolor{keywordflow}{if} (myregions[0].size() == 0) myregions.resize(0);}
\DoxyCodeLine{01205 }
\DoxyCodeLine{01206   sizeRas-\/>unlock();}
\DoxyCodeLine{01207   \textcolor{keywordflow}{if} (sourceRas) sourceRas-\/>unlock();}
\DoxyCodeLine{01208 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a1dd98c8f78b92b7715af11295577e09c}\label{class_particles___engine_a1dd98c8f78b92b7715af11295577e09c}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_single\_region@{fill\_single\_region}}
\index{fill\_single\_region@{fill\_single\_region}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_single\_region()}{fill\_single\_region()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+single\+\_\+region (\begin{DoxyParamCaption}\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{int}]{thres,  }\item[{bool}]{do\+\_\+source\+\_\+gradation,  }\item[{std\+::vector$<$ std\+::vector$<$ int $>$ $>$ \&}]{my\+Histogram }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01036                                                                       \{}
\DoxyCodeLine{01037   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} raster32 = ctrl1-\/>getRaster();}
\DoxyCodeLine{01038   assert(raster32);  \textcolor{comment}{// per ora gestisco solo i Raster32}}
\DoxyCodeLine{01039                      \textcolor{comment}{//  int lx=raster32-\/>getLx();}}
\DoxyCodeLine{01040                      \textcolor{comment}{//  int ly=raster32-\/>getLy();}}
\DoxyCodeLine{01041   \textcolor{keywordtype}{int} j;}
\DoxyCodeLine{01042   myregions.resize(1);}
\DoxyCodeLine{01043   myregions[0].clear();}
\DoxyCodeLine{01044   \textcolor{keywordtype}{int} cc  = 0;}
\DoxyCodeLine{01045   \textcolor{keywordtype}{int} icc = 0;}
\DoxyCodeLine{01046   raster32-\/>lock();}
\DoxyCodeLine{01047 }
\DoxyCodeLine{01048   \textcolor{keywordflow}{if} (!do\_source\_gradation) \textcolor{comment}{/*-\/ 2階調の場合 -\/*/}}
\DoxyCodeLine{01049   \{}
\DoxyCodeLine{01050     \textcolor{keywordflow}{for} (j = 0; j < raster32-\/>getLy(); j++) \{}
\DoxyCodeLine{01051       TPixel32 *pix    = raster32-\/>pixels(j);}
\DoxyCodeLine{01052       TPixel32 *endPix = pix + raster32-\/>getLx();}
\DoxyCodeLine{01053       \textcolor{keywordtype}{int} i            = 0;}
\DoxyCodeLine{01054       \textcolor{keywordflow}{while} (pix < endPix) \{}
\DoxyCodeLine{01055         cc++;}
\DoxyCodeLine{01056         \textcolor{keywordflow}{if} (pix-\/>m > threshold) \{}
\DoxyCodeLine{01057           icc++;}
\DoxyCodeLine{01058           \mbox{\hyperlink{class_t_point_t}{TPointD}} tmp;}
\DoxyCodeLine{01059           tmp.y = j;}
\DoxyCodeLine{01060           tmp.x = i;}
\DoxyCodeLine{01061           tmp += ctrl1-\/>m\_pos;}
\DoxyCodeLine{01062           myregions[0].push\_back(tmp);}
\DoxyCodeLine{01063           \textcolor{comment}{/*TMSG\_INFO("{}total=\%d\(\backslash\)n"{}, Region[0].total);*/}}
\DoxyCodeLine{01064 }
\DoxyCodeLine{01065         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01066           \textcolor{comment}{//           int a=0;}}
\DoxyCodeLine{01067         \}}
\DoxyCodeLine{01068         i++;}
\DoxyCodeLine{01069         pix++;}
\DoxyCodeLine{01070       \}}
\DoxyCodeLine{01071     \}}
\DoxyCodeLine{01072   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01073     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 256; i++) myHistogram.push\_back(std::vector<int>());}
\DoxyCodeLine{01074 }
\DoxyCodeLine{01075     \mbox{\hyperlink{class_t_random}{TRandom}} rand = \mbox{\hyperlink{class_t_random}{TRandom}}(1);}
\DoxyCodeLine{01076     \textcolor{keywordflow}{for} (j = 0; j < raster32-\/>getLy(); j++) \{}
\DoxyCodeLine{01077       TPixel32 *pix    = raster32-\/>pixels(j);}
\DoxyCodeLine{01078       TPixel32 *endPix = pix + raster32-\/>getLx();}
\DoxyCodeLine{01079       \textcolor{keywordtype}{int} i            = 0;}
\DoxyCodeLine{01080       \textcolor{keywordflow}{while} (pix < endPix) \{}
\DoxyCodeLine{01081         cc++;}
\DoxyCodeLine{01082         \textcolor{comment}{/*-\/-\/ アルファの濃度に比例してパーティクルを発生させるための、}}
\DoxyCodeLine{01083 \textcolor{comment}{                シンプルな方法。そのピクセルのアルファ値の数だけ「立候補」させる。}}
\DoxyCodeLine{01084 \textcolor{comment}{        -\/-\/*/}}
\DoxyCodeLine{01085         \textcolor{keywordflow}{if} (pix-\/>m > 0) \{}
\DoxyCodeLine{01086           icc++;}
\DoxyCodeLine{01087           \mbox{\hyperlink{class_t_point_t}{TPointD}} tmp;}
\DoxyCodeLine{01088           tmp.y = j;}
\DoxyCodeLine{01089           tmp.x = i;}
\DoxyCodeLine{01090           tmp += ctrl1-\/>m\_pos;}
\DoxyCodeLine{01091 }
\DoxyCodeLine{01092           \textcolor{comment}{/*-\/ Histogramの登録 -\/*/}}
\DoxyCodeLine{01093           myHistogram[(int)pix-\/>m].push\_back((\textcolor{keywordtype}{int})myregions[0].size());}
\DoxyCodeLine{01094           \textcolor{comment}{/*-\/  各Pointにウェイトを持たせる -\/*/}}
\DoxyCodeLine{01095           myregions[0].push\_back(tmp);}
\DoxyCodeLine{01096         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01097         \}}
\DoxyCodeLine{01098         i++;}
\DoxyCodeLine{01099         pix++;}
\DoxyCodeLine{01100       \}}
\DoxyCodeLine{01101     \}}
\DoxyCodeLine{01102   \}}
\DoxyCodeLine{01103   \textcolor{keywordflow}{if} (myregions[0].size() == 0) myregions.resize(0);}
\DoxyCodeLine{01104   raster32-\/>unlock();}
\DoxyCodeLine{01105 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_ab92d32ddd8f0516b4a2ba25d29595c7b}\label{class_particles___engine_ab92d32ddd8f0516b4a2ba25d29595c7b}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_subregions@{fill\_subregions}}
\index{fill\_subregions@{fill\_subregions}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_subregions()}{fill\_subregions()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+subregions (\begin{DoxyParamCaption}\item[{int}]{cont\+\_\+index,  }\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{int}]{thres }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01012                \{}
\DoxyCodeLine{01013   \textcolor{keywordtype}{int} regioncounter = 0;}
\DoxyCodeLine{01014 }
\DoxyCodeLine{01015   \textcolor{keywordtype}{int} lx = ctrl1-\/>getRaster()-\/>getLx();}
\DoxyCodeLine{01016   \textcolor{keywordtype}{int} ly = ctrl1-\/>getRaster()-\/>getLy();}
\DoxyCodeLine{01017 }
\DoxyCodeLine{01018   std::vector<int> myarray(lx * ly);}
\DoxyCodeLine{01019   std::vector<int> lista;}
\DoxyCodeLine{01020   std::vector<int> listb;}
\DoxyCodeLine{01021 }
\DoxyCodeLine{01022   fill\_array(ctrl1, regioncounter, myarray, lista, listb, thres);}
\DoxyCodeLine{01023 }
\DoxyCodeLine{01024   \textcolor{keywordflow}{if} (regioncounter) \{}
\DoxyCodeLine{01025     std::vector<int> \textcolor{keyword}{final}(regioncounter + 1);}
\DoxyCodeLine{01026     normalize\_array(myregions, ctrl1-\/>m\_pos, lx, ly, regioncounter, myarray,}
\DoxyCodeLine{01027                     lista, listb, \textcolor{keyword}{final});}
\DoxyCodeLine{01028   \}}
\DoxyCodeLine{01029 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_abe399b2056ac8e417408d3b68b6d2428}\label{class_particles___engine_abe399b2056ac8e417408d3b68b6d2428}} 
\index{Particles\_Engine@{Particles\_Engine}!fill\_value\_struct@{fill\_value\_struct}}
\index{fill\_value\_struct@{fill\_value\_struct}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_value\_struct()}{fill\_value\_struct()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::fill\+\_\+value\+\_\+struct (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{value,  }\item[{double}]{frame }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00058                                                        \{}
\DoxyCodeLine{00059   myvalues.source\_ctrl\_val  = m\_parent-\/>source\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00060   myvalues.bright\_thres\_val = m\_parent-\/>bright\_thres\_val-\/>getValue();}
\DoxyCodeLine{00061   myvalues.multi\_source\_val = m\_parent-\/>multi\_source\_val-\/>getValue();}
\DoxyCodeLine{00062   myvalues.x\_pos\_val        = m\_parent-\/>center\_val-\/>getValue(frame).x;}
\DoxyCodeLine{00063   myvalues.y\_pos\_val        = m\_parent-\/>center\_val-\/>getValue(frame).y;}
\DoxyCodeLine{00064   \textcolor{comment}{//  myvalues.unit\_val=m\_parent-\/>unit\_val-\/>getValue(frame);}}
\DoxyCodeLine{00065   myvalues.length\_val          = m\_parent-\/>length\_val-\/>getValue(frame);}
\DoxyCodeLine{00066   myvalues.height\_val          = m\_parent-\/>height\_val-\/>getValue(frame);}
\DoxyCodeLine{00067   myvalues.maxnum\_val          = m\_parent-\/>maxnum\_val-\/>getValue(frame);}
\DoxyCodeLine{00068   myvalues.lifetime\_val        = m\_parent-\/>lifetime\_val-\/>getValue(frame);}
\DoxyCodeLine{00069   myvalues.lifetime\_ctrl\_val   = m\_parent-\/>lifetime\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00070   myvalues.column\_lifetime\_val = m\_parent-\/>column\_lifetime\_val-\/>getValue();}
\DoxyCodeLine{00071   myvalues.startpos\_val        = m\_parent-\/>startpos\_val-\/>getValue();}
\DoxyCodeLine{00072   myvalues.randseed\_val        = m\_parent-\/>randseed\_val-\/>getValue();}
\DoxyCodeLine{00073   myvalues.gravity\_val         = m\_parent-\/>gravity\_val-\/>getValue(frame);}
\DoxyCodeLine{00074   myvalues.g\_angle\_val         = m\_parent-\/>g\_angle\_val-\/>getValue(frame);}
\DoxyCodeLine{00075   myvalues.gravity\_ctrl\_val    = m\_parent-\/>gravity\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00076   myvalues.friction\_val        = m\_parent-\/>friction\_val-\/>getValue(frame);}
\DoxyCodeLine{00077   myvalues.friction\_ctrl\_val   = m\_parent-\/>friction\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00078   myvalues.windint\_val         = m\_parent-\/>windint\_val-\/>getValue(frame);}
\DoxyCodeLine{00079   myvalues.windangle\_val       = m\_parent-\/>windangle\_val-\/>getValue(frame);}
\DoxyCodeLine{00080   myvalues.swingmode\_val       = m\_parent-\/>swingmode\_val-\/>getValue();}
\DoxyCodeLine{00081   myvalues.randomx\_val         = m\_parent-\/>randomx\_val-\/>getValue(frame);}
\DoxyCodeLine{00082   myvalues.randomy\_val         = m\_parent-\/>randomy\_val-\/>getValue(frame);}
\DoxyCodeLine{00083   myvalues.randomx\_ctrl\_val    = m\_parent-\/>randomx\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00084   myvalues.randomy\_ctrl\_val    = m\_parent-\/>randomy\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00085   myvalues.swing\_val           = m\_parent-\/>swing\_val-\/>getValue(frame);}
\DoxyCodeLine{00086   myvalues.speed\_val           = m\_parent-\/>speed\_val-\/>getValue(frame);}
\DoxyCodeLine{00087   myvalues.speed\_ctrl\_val      = m\_parent-\/>speed\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00088   myvalues.speeda\_val          = m\_parent-\/>speeda\_val-\/>getValue(frame);}
\DoxyCodeLine{00089   myvalues.speeda\_ctrl\_val     = m\_parent-\/>speeda\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00090   myvalues.speeda\_use\_gradient\_val =}
\DoxyCodeLine{00091       m\_parent-\/>speeda\_use\_gradient\_val-\/>getValue();}
\DoxyCodeLine{00092   myvalues.speedscale\_val     = m\_parent-\/>speedscale\_val-\/>getValue();}
\DoxyCodeLine{00093   myvalues.toplayer\_val       = m\_parent-\/>toplayer\_val-\/>getValue();}
\DoxyCodeLine{00094   myvalues.mass\_val           = m\_parent-\/>mass\_val-\/>getValue(frame);}
\DoxyCodeLine{00095   myvalues.scale\_val          = m\_parent-\/>scale\_val-\/>getValue(frame);}
\DoxyCodeLine{00096   myvalues.scale\_ctrl\_val     = m\_parent-\/>scale\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00097   myvalues.scale\_ctrl\_all\_val = m\_parent-\/>scale\_ctrl\_all\_val-\/>getValue();}
\DoxyCodeLine{00098   myvalues.rot\_val            = m\_parent-\/>rot\_val-\/>getValue(frame);}
\DoxyCodeLine{00099   myvalues.rot\_ctrl\_val       = m\_parent-\/>rot\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00100   myvalues.trail\_val          = m\_parent-\/>trail\_val-\/>getValue(frame);}
\DoxyCodeLine{00101   myvalues.trailstep\_val      = m\_parent-\/>trailstep\_val-\/>getValue(frame);}
\DoxyCodeLine{00102   myvalues.rotswingmode\_val   = m\_parent-\/>rotswingmode\_val-\/>getValue();}
\DoxyCodeLine{00103   myvalues.rotspeed\_val       = m\_parent-\/>rotspeed\_val-\/>getValue(frame);}
\DoxyCodeLine{00104   myvalues.rotsca\_val         = m\_parent-\/>rotsca\_val-\/>getValue(frame);}
\DoxyCodeLine{00105   myvalues.rotswing\_val       = m\_parent-\/>rotswing\_val-\/>getValue(frame);}
\DoxyCodeLine{00106   myvalues.pathaim\_val        = m\_parent-\/>pathaim\_val-\/>getValue();}
\DoxyCodeLine{00107   myvalues.opacity\_val        = m\_parent-\/>opacity\_val-\/>getValue(frame);}
\DoxyCodeLine{00108   myvalues.opacity\_ctrl\_val   = m\_parent-\/>opacity\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00109   myvalues.trailopacity\_val   = m\_parent-\/>trailopacity\_val-\/>getValue(frame);}
\DoxyCodeLine{00110   \textcolor{comment}{//  myvalues.mblur\_val=m\_parent-\/>mblur\_val-\/>getValue(frame);}}
\DoxyCodeLine{00111   myvalues.scalestep\_val      = m\_parent-\/>scalestep\_val-\/>getValue(frame);}
\DoxyCodeLine{00112   myvalues.scalestep\_ctrl\_val = m\_parent-\/>scalestep\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00113   myvalues.fadein\_val         = m\_parent-\/>fadein\_val-\/>getValue(frame);}
\DoxyCodeLine{00114   myvalues.fadeout\_val        = m\_parent-\/>fadeout\_val-\/>getValue(frame);}
\DoxyCodeLine{00115   myvalues.animation\_val      = m\_parent-\/>animation\_val-\/>getValue();}
\DoxyCodeLine{00116   myvalues.step\_val           = m\_parent-\/>step\_val-\/>getValue();}
\DoxyCodeLine{00117 }
\DoxyCodeLine{00118   myvalues.gencol\_val         = m\_parent-\/>gencol\_val-\/>getValue(frame);}
\DoxyCodeLine{00119   myvalues.gencol\_ctrl\_val    = m\_parent-\/>gencol\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00120   myvalues.gencol\_spread\_val  = m\_parent-\/>gencol\_spread\_val-\/>getValue(frame);}
\DoxyCodeLine{00121   myvalues.genfadecol\_val     = m\_parent-\/>genfadecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00122   myvalues.fincol\_val         = m\_parent-\/>fincol\_val-\/>getValue(frame);}
\DoxyCodeLine{00123   myvalues.fincol\_ctrl\_val    = m\_parent-\/>fincol\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00124   myvalues.fincol\_spread\_val  = m\_parent-\/>fincol\_spread\_val-\/>getValue(frame);}
\DoxyCodeLine{00125   myvalues.finrangecol\_val    = m\_parent-\/>finrangecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00126   myvalues.finfadecol\_val     = m\_parent-\/>finfadecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00127   myvalues.foutcol\_val        = m\_parent-\/>foutcol\_val-\/>getValue(frame);}
\DoxyCodeLine{00128   myvalues.foutcol\_ctrl\_val   = m\_parent-\/>foutcol\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00129   myvalues.foutcol\_spread\_val = m\_parent-\/>foutcol\_spread\_val-\/>getValue(frame);}
\DoxyCodeLine{00130   myvalues.foutrangecol\_val   = m\_parent-\/>foutrangecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00131   myvalues.foutfadecol\_val    = m\_parent-\/>foutfadecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00132 }
\DoxyCodeLine{00133   myvalues.source\_gradation\_val = m\_parent-\/>source\_gradation\_val-\/>getValue();}
\DoxyCodeLine{00134   myvalues.pick\_color\_for\_every\_frame\_val =}
\DoxyCodeLine{00135       m\_parent-\/>pick\_color\_for\_every\_frame\_val-\/>getValue();}
\DoxyCodeLine{00136   myvalues.perspective\_distribution\_val =}
\DoxyCodeLine{00137       m\_parent-\/>perspective\_distribution\_val-\/>getValue();}
\DoxyCodeLine{00138 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a17b1897dea0bc5f80d4d81a43d3cb6b4}\label{class_particles___engine_a17b1897dea0bc5f80d4d81a43d3cb6b4}} 
\index{Particles\_Engine@{Particles\_Engine}!normalize\_array@{normalize\_array}}
\index{normalize\_array@{normalize\_array}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{normalize\_array()}{normalize\_array()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::normalize\+\_\+array (\begin{DoxyParamCaption}\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}}}]{pos,  }\item[{int}]{lx,  }\item[{int}]{ly,  }\item[{int}]{regioncounter,  }\item[{std\+::vector$<$ int $>$ \&}]{myarray,  }\item[{std\+::vector$<$ int $>$ \&}]{lista,  }\item[{std\+::vector$<$ int $>$ \&}]{listb,  }\item[{std\+::vector$<$ int $>$ \&}]{final }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00947                                                   \{}
\DoxyCodeLine{00948   \textcolor{keywordtype}{int} i, j, k, l;}
\DoxyCodeLine{00949 }
\DoxyCodeLine{00950   std::vector<int> tmp;}
\DoxyCodeLine{00951   \textcolor{keywordtype}{int} maxregioncounter = 0;}
\DoxyCodeLine{00952   \textcolor{keywordtype}{int} listsize         = (int)lista.size();}
\DoxyCodeLine{00953   \textcolor{comment}{// TMSG\_INFO("{}regioncounter \%d, eqcount=\%d\(\backslash\)n"{}, regioncounter, eqcount);}}
\DoxyCodeLine{00954   \textcolor{keywordflow}{for} (k = 1; k <= regioncounter; k++) \textcolor{keyword}{final}[k] = k;}
\DoxyCodeLine{00955 }
\DoxyCodeLine{00956   \textcolor{keywordflow}{for} (l = 0; l < listsize; l++) \{}
\DoxyCodeLine{00957     j = lista[l];}
\DoxyCodeLine{00958     \textcolor{comment}{/*TMSG\_INFO("{}j vale \%d\(\backslash\)n"{}, j);*/}}
\DoxyCodeLine{00959     \textcolor{keywordflow}{while} (\textcolor{keyword}{final}[j] != j) j = \textcolor{keyword}{final}[j];}
\DoxyCodeLine{00960     k = listb[l];}
\DoxyCodeLine{00961     \textcolor{comment}{/*TMSG\_INFO("{}k vale \%d\(\backslash\)n"{}, k);*/}}
\DoxyCodeLine{00962     \textcolor{keywordflow}{while} (\textcolor{keyword}{final}[k] != k) k = \textcolor{keyword}{final}[k];}
\DoxyCodeLine{00963     \textcolor{keywordflow}{if} (j != k) \textcolor{keyword}{final}[j] = k;}
\DoxyCodeLine{00964   \}}
\DoxyCodeLine{00965   \textcolor{comment}{// TMSG\_INFO("{}esco dal for\(\backslash\)n"{});}}
\DoxyCodeLine{00966   \textcolor{keywordflow}{for} (j = 1; j <= regioncounter; j++)}
\DoxyCodeLine{00967     \textcolor{keywordflow}{while} (\textcolor{keyword}{final}[j] != \textcolor{keyword}{final}[\textcolor{keyword}{final}[j]]) \textcolor{keyword}{final}[j] = \textcolor{keyword}{final}[\textcolor{keyword}{final}[j]];}
\DoxyCodeLine{00968 }
\DoxyCodeLine{00969   \textcolor{comment}{/*conto quante cavolo di regioni sono*/}}
\DoxyCodeLine{00970 }
\DoxyCodeLine{00971   tmp.push\_back(\textcolor{keyword}{final}[1]);}
\DoxyCodeLine{00972   maxregioncounter = 1;}
\DoxyCodeLine{00973   \textcolor{keywordflow}{for} (i = 2; i <= regioncounter; i++) \{}
\DoxyCodeLine{00974     \textcolor{keywordtype}{int} diff = 1;}
\DoxyCodeLine{00975     \textcolor{keywordflow}{for} (j = 0; j < maxregioncounter; j++) \{}
\DoxyCodeLine{00976       \textcolor{keywordflow}{if} (tmp[j] == \textcolor{keyword}{final}[i]) \{}
\DoxyCodeLine{00977         diff = 0;}
\DoxyCodeLine{00978         \textcolor{keywordflow}{break};}
\DoxyCodeLine{00979       \}}
\DoxyCodeLine{00980     \}}
\DoxyCodeLine{00981     \textcolor{keywordflow}{if} (diff) \{}
\DoxyCodeLine{00982       tmp.push\_back(\textcolor{keyword}{final}[i]);}
\DoxyCodeLine{00983       maxregioncounter++;}
\DoxyCodeLine{00984     \}}
\DoxyCodeLine{00985   \}}
\DoxyCodeLine{00986 }
\DoxyCodeLine{00987   myregions.resize(maxregioncounter);}
\DoxyCodeLine{00988   \textcolor{keywordflow}{for} (j = 0; j < ly; j++) \{}
\DoxyCodeLine{00989     \textcolor{keywordflow}{for} (i = 0; i < lx; i++) \{}
\DoxyCodeLine{00990       \textcolor{keywordtype}{int} tmpindex;}
\DoxyCodeLine{00991       \textcolor{keywordflow}{if} (myarray[i + lx * j]) \{}
\DoxyCodeLine{00992         tmpindex = \textcolor{keyword}{final}[myarray[i + lx * j]];}
\DoxyCodeLine{00993         \textcolor{comment}{/*TMSG\_INFO("{}tmpindex=\%d\(\backslash\)n"{}, tmpindex);*/}}
\DoxyCodeLine{00994         \textcolor{keywordflow}{for} (k = 0; k < maxregioncounter; k++) \{}
\DoxyCodeLine{00995           \textcolor{keywordflow}{if} (tmp[k] == tmpindex) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00996         \}}
\DoxyCodeLine{00997         \textcolor{comment}{/*TMSG\_INFO("{}k=\%d\(\backslash\)n"{}, k);*/}}
\DoxyCodeLine{00998         \mbox{\hyperlink{class_t_point_t}{TPointD}} tmppoint;}
\DoxyCodeLine{00999         tmppoint.x = i;}
\DoxyCodeLine{01000         tmppoint.y = j;}
\DoxyCodeLine{01001         tmppoint += pos;}
\DoxyCodeLine{01002         myregions[k].push\_back(tmppoint);}
\DoxyCodeLine{01003       \}}
\DoxyCodeLine{01004     \}}
\DoxyCodeLine{01005   \}}
\DoxyCodeLine{01006 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a34f547141f79b53786ec88026fc7b523}\label{class_particles___engine_a34f547141f79b53786ec88026fc7b523}} 
\index{Particles\_Engine@{Particles\_Engine}!normalize\_values@{normalize\_values}}
\index{normalize\_values@{normalize\_values}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{normalize\_values()}{normalize\_values()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::normalize\+\_\+values (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00390                                                                    \{}
\DoxyCodeLine{00391   \textcolor{keywordtype}{double} dpicorr = 1;}
\DoxyCodeLine{00392   \mbox{\hyperlink{class_t_point_t}{TPointD}} pos(values.x\_pos\_val, values.y\_pos\_val);}
\DoxyCodeLine{00393 }
\DoxyCodeLine{00394   (values.x\_pos\_val)               = pos.x;}
\DoxyCodeLine{00395   (values.y\_pos\_val)               = pos.y;}
\DoxyCodeLine{00396   (values.length\_val)              = (values.length\_val) * dpicorr;}
\DoxyCodeLine{00397   (values.height\_val)              = (values.height\_val) * dpicorr;}
\DoxyCodeLine{00398   (values.gravity\_val)             = (values.gravity\_val) * dpicorr * 0.1;}
\DoxyCodeLine{00399   (values.windint\_val)             = (values.windint\_val) * dpicorr;}
\DoxyCodeLine{00400   (values.speed\_val.first)         = (values.speed\_val.first) * dpicorr;}
\DoxyCodeLine{00401   (values.speed\_val.second)        = (values.speed\_val.second) * dpicorr;}
\DoxyCodeLine{00402   (values.randomx\_val.first)       = (values.randomx\_val.first) * dpicorr;}
\DoxyCodeLine{00403   (values.randomx\_val.second)      = (values.randomx\_val.second) * dpicorr;}
\DoxyCodeLine{00404   (values.randomy\_val.first)       = (values.randomy\_val.first) * dpicorr;}
\DoxyCodeLine{00405   (values.randomy\_val.second)      = (values.randomy\_val.second) * dpicorr;}
\DoxyCodeLine{00406   (values.scale\_val.first)         = (values.scale\_val.first) * 0.01;}
\DoxyCodeLine{00407   (values.scale\_val.second)        = (values.scale\_val.second) * 0.01;}
\DoxyCodeLine{00408   (values.scalestep\_val.first)     = (values.scalestep\_val.first) * 0.01;}
\DoxyCodeLine{00409   (values.scalestep\_val.second)    = (values.scalestep\_val.second) * 0.01;}
\DoxyCodeLine{00410   (values.opacity\_val.first)       = (values.opacity\_val.first) * 0.01;}
\DoxyCodeLine{00411   (values.opacity\_val.second)      = (values.opacity\_val.second) * 0.01;}
\DoxyCodeLine{00412   (values.trailopacity\_val.first)  = (values.trailopacity\_val.first) * 0.01;}
\DoxyCodeLine{00413   (values.trailopacity\_val.second) = (values.trailopacity\_val.second) * 0.01;}
\DoxyCodeLine{00414   (values.mblur\_val)               = (values.mblur\_val) * 0.01;}
\DoxyCodeLine{00415   (values.friction\_val)            = -\/(values.friction\_val) * 0.01;}
\DoxyCodeLine{00416   (values.windangle\_val)           = (values.windangle\_val) * M\_PI\_180;}
\DoxyCodeLine{00417   (values.g\_angle\_val)             = (values.g\_angle\_val + 180) * M\_PI\_180;}
\DoxyCodeLine{00418   (values.speeda\_val.first)        = (values.speeda\_val.first) * M\_PI\_180;}
\DoxyCodeLine{00419   (values.speeda\_val.second)       = (values.speeda\_val.second) * M\_PI\_180;}
\DoxyCodeLine{00420   \textcolor{keywordflow}{if} (values.step\_val < 1) values.step\_val = 1;}
\DoxyCodeLine{00421   values.genfadecol\_val  = (values.genfadecol\_val) * 0.01;}
\DoxyCodeLine{00422   values.finfadecol\_val  = (values.finfadecol\_val) * 0.01;}
\DoxyCodeLine{00423   values.foutfadecol\_val = (values.foutfadecol\_val) * 0.01;}
\DoxyCodeLine{00424 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_af32131f9ec282edf022cf31d64c649a6}\label{class_particles___engine_af32131f9ec282edf022cf31d64c649a6}} 
\index{Particles\_Engine@{Particles\_Engine}!port\_is\_used@{port\_is\_used}}
\index{port\_is\_used@{port\_is\_used}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{port\_is\_used()}{port\_is\_used()}}
{\footnotesize\ttfamily bool Particles\+\_\+\+Engine\+::port\+\_\+is\+\_\+used (\begin{DoxyParamCaption}\item[{int}]{i,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00162                                                                           \{}
\DoxyCodeLine{00163   \textcolor{keywordflow}{return} port\_is\_used\_for\_value(i, values) ||}
\DoxyCodeLine{00164          port\_is\_used\_for\_gradient(i, values);}
\DoxyCodeLine{00165 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a661623d1f20fea584375a24ec1911471}\label{class_particles___engine_a661623d1f20fea584375a24ec1911471}} 
\index{Particles\_Engine@{Particles\_Engine}!port\_is\_used\_for\_gradient@{port\_is\_used\_for\_gradient}}
\index{port\_is\_used\_for\_gradient@{port\_is\_used\_for\_gradient}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{port\_is\_used\_for\_gradient()}{port\_is\_used\_for\_gradient()}}
{\footnotesize\ttfamily bool Particles\+\_\+\+Engine\+::port\+\_\+is\+\_\+used\+\_\+for\+\_\+gradient (\begin{DoxyParamCaption}\item[{int}]{i,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00184                                             \{}
\DoxyCodeLine{00185   \textcolor{keywordflow}{return} values.gravity\_ctrl\_val == i ||}
\DoxyCodeLine{00186          (values.speeda\_ctrl\_val == i \&\& values.speeda\_use\_gradient\_val);}
\DoxyCodeLine{00187 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_ae93e03a8c641edfbe8a7b33fb6a1fa48}\label{class_particles___engine_ae93e03a8c641edfbe8a7b33fb6a1fa48}} 
\index{Particles\_Engine@{Particles\_Engine}!port\_is\_used\_for\_value@{port\_is\_used\_for\_value}}
\index{port\_is\_used\_for\_value@{port\_is\_used\_for\_value}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{port\_is\_used\_for\_value()}{port\_is\_used\_for\_value()}}
{\footnotesize\ttfamily bool Particles\+\_\+\+Engine\+::port\+\_\+is\+\_\+used\+\_\+for\+\_\+value (\begin{DoxyParamCaption}\item[{int}]{i,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00170                                                                                \{}
\DoxyCodeLine{00171   \textcolor{keywordflow}{return} values.fincol\_ctrl\_val == i || values.foutcol\_ctrl\_val == i ||}
\DoxyCodeLine{00172          values.friction\_ctrl\_val == i || values.gencol\_ctrl\_val == i ||}
\DoxyCodeLine{00173          values.opacity\_ctrl\_val == i || values.rot\_ctrl\_val == i ||}
\DoxyCodeLine{00174          values.scale\_ctrl\_val == i || values.scalestep\_ctrl\_val == i ||}
\DoxyCodeLine{00175          values.source\_ctrl\_val == i || values.speed\_ctrl\_val == i ||}
\DoxyCodeLine{00176          (values.speeda\_ctrl\_val == i \&\& !values.speeda\_use\_gradient\_val) ||}
\DoxyCodeLine{00177          values.lifetime\_ctrl\_val == i || values.randomx\_ctrl\_val == i ||}
\DoxyCodeLine{00178          values.randomy\_ctrl\_val == i;}
\DoxyCodeLine{00179 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_ab7574ab8a9217f960e1ce339e90c18dc}\label{class_particles___engine_ab7574ab8a9217f960e1ce339e90c18dc}} 
\index{Particles\_Engine@{Particles\_Engine}!render\_particles@{render\_particles}}
\index{render\_particles@{render\_particles}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{render\_particles()}{render\_particles()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::render\+\_\+particles (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{part\+\_\+ports,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&}]{p\+\_\+size,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{p\+\_\+offset,  }\item[{std\+::map$<$ int, \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{ctrl\+\_\+ports,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$}]{part\+Level,  }\item[{float}]{dpi,  }\item[{int}]{curr\+\_\+frame,  }\item[{int}]{shrink,  }\item[{double}]{startx,  }\item[{double}]{starty,  }\item[{double}]{endx,  }\item[{double}]{endy,  }\item[{std\+::vector$<$ int $>$}]{lastframe,  }\item[{unsigned long}]{fx\+Id }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00433                                                                              \{}
\DoxyCodeLine{00434   \textcolor{keywordtype}{int} frame, startframe, intpart = 0, level\_n = 0;}
\DoxyCodeLine{00435   \textcolor{keyword}{struct }\mbox{\hyperlink{structparticles__values}{particles\_values}} values;}
\DoxyCodeLine{00436   \textcolor{keywordtype}{double} dpicorr = dpi * 0.01, fractpart = 0, dpicorr\_shrinked = 0,}
\DoxyCodeLine{00437          opacity\_range = 0;}
\DoxyCodeLine{00438   \textcolor{keywordtype}{bool} random\_level    = \textcolor{keyword}{false};}
\DoxyCodeLine{00439   level\_n              = part\_ports.size();}
\DoxyCodeLine{00440 }
\DoxyCodeLine{00441   \textcolor{keywordtype}{bool} isPrecomputingEnabled = \textcolor{keyword}{false};}
\DoxyCodeLine{00442   \{}
\DoxyCodeLine{00443     \mbox{\hyperlink{class_t_renderer}{TRenderer}} renderer(\mbox{\hyperlink{class_t_renderer_a93afee3c1ce8ff2b753a05fa0fe3dc9d}{TRenderer::instance}}());}
\DoxyCodeLine{00444     isPrecomputingEnabled =}
\DoxyCodeLine{00445         (renderer \&\& renderer.isPrecomputingEnabled()) ? \textcolor{keyword}{true} : \textcolor{keyword}{false};}
\DoxyCodeLine{00446   \}}
\DoxyCodeLine{00447 }
\DoxyCodeLine{00448   memset(\&values, 0, \textcolor{keyword}{sizeof}(values));}
\DoxyCodeLine{00449   \textcolor{comment}{/*-\/ 現在のフレームでの各種パラメータを得る -\/*/}}
\DoxyCodeLine{00450   fill\_value\_struct(values, m\_frame);}
\DoxyCodeLine{00451   \textcolor{comment}{/*-\/ 不透明度の範囲（透明〜不透明を 0〜1 に正規化）-\/*/}}
\DoxyCodeLine{00452   opacity\_range = (values.opacity\_val.second -\/ values.opacity\_val.first) * 0.01;}
\DoxyCodeLine{00453   \textcolor{comment}{/*-\/ 開始フレーム -\/*/}}
\DoxyCodeLine{00454   startframe = (int)values.startpos\_val;}
\DoxyCodeLine{00455   if (values.unit\_val == ParticlesFx::UNIT\_SMALL\_INCH)}
\DoxyCodeLine{00456     dpicorr\_shrinked = dpicorr / shrink;}
\DoxyCodeLine{00457   \textcolor{keywordflow}{else}}
\DoxyCodeLine{00458     dpicorr\_shrinked = dpi / shrink;}
\DoxyCodeLine{00459 }
\DoxyCodeLine{00460   std::map<std::pair<int, int>, \textcolor{keywordtype}{double}> partScales;}
\DoxyCodeLine{00461   curr\_frame = curr\_frame / values.step\_val;}
\DoxyCodeLine{00462 }
\DoxyCodeLine{00463   \mbox{\hyperlink{class_particles_manager}{ParticlesManager}} *pc = ParticlesManager::instance();}
\DoxyCodeLine{00464 }
\DoxyCodeLine{00465   \textcolor{comment}{// Retrieve the last rolled frame}}
\DoxyCodeLine{00466   \mbox{\hyperlink{struct_particles_manager_1_1_frame_data}{ParticlesManager::FrameData}} *particlesData = pc-\/>data(fxId);}
\DoxyCodeLine{00467 }
\DoxyCodeLine{00468   std::list<Particle> myParticles;}
\DoxyCodeLine{00469   \mbox{\hyperlink{class_t_random}{TRandom}} myRandom;}
\DoxyCodeLine{00470   values.random\_val  = \&myRandom;}
\DoxyCodeLine{00471   myRandom           = m\_parent-\/>randseed\_val-\/>getValue();}
\DoxyCodeLine{00472   \textcolor{keywordtype}{int} totalparticles = 0;}
\DoxyCodeLine{00473 }
\DoxyCodeLine{00474   \textcolor{keywordtype}{int} pcFrame = particlesData-\/>m\_frame;}
\DoxyCodeLine{00475   \textcolor{keywordflow}{if} (pcFrame > curr\_frame) \{}
\DoxyCodeLine{00476     \textcolor{comment}{// Clear stored particlesData}}
\DoxyCodeLine{00477     particlesData-\/>clear();}
\DoxyCodeLine{00478     pcFrame = particlesData-\/>m\_frame;}
\DoxyCodeLine{00479   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (pcFrame >= startframe -\/ 1) \{}
\DoxyCodeLine{00480     myParticles    = particlesData-\/>m\_particles;}
\DoxyCodeLine{00481     myRandom       = particlesData-\/>m\_random;}
\DoxyCodeLine{00482     totalparticles = particlesData-\/>m\_totalParticles;}
\DoxyCodeLine{00483   \}}
\DoxyCodeLine{00484   \textcolor{comment}{/*-\/ スタートからカレントフレームまでループ -\/*/}}
\DoxyCodeLine{00485   \textcolor{keywordflow}{for} (frame = startframe -\/ 1; frame <= curr\_frame; ++frame) \{}
\DoxyCodeLine{00486     \textcolor{keywordtype}{int} dist\_frame = curr\_frame -\/ frame;}
\DoxyCodeLine{00487     \textcolor{comment}{/*-\/}}
\DoxyCodeLine{00488 \textcolor{comment}{     * ループ内の現在のフレームでのパラメータを取得。スタートが負ならフレーム=0のときの値を格納}}
\DoxyCodeLine{00489 \textcolor{comment}{     * -\/*/}}
\DoxyCodeLine{00490     fill\_value\_struct(values, frame < 0 ? 0 : frame * values.step\_val);}
\DoxyCodeLine{00491     \textcolor{comment}{/*-\/ パラメータの正規化 -\/*/}}
\DoxyCodeLine{00492     normalize\_values(values, ri);}
\DoxyCodeLine{00493     \textcolor{comment}{/*-\/ maxnum\_valは"{}birth\_rate"{}のパラメータ -\/*/}}
\DoxyCodeLine{00494     intpart = (int)values.maxnum\_val;}
\DoxyCodeLine{00495     \textcolor{comment}{/*-\/}}
\DoxyCodeLine{00496 \textcolor{comment}{     * /birth\_rateが小数だったとき、各フレームの小数部分を足しこんだ結果の整数部分をintpartに渡す。}}
\DoxyCodeLine{00497 \textcolor{comment}{     * -\/*/}}
\DoxyCodeLine{00498     fractpart = fractpart + values.maxnum\_val -\/ intpart;}
\DoxyCodeLine{00499     if ((\textcolor{keywordtype}{int})fractpart) \{}
\DoxyCodeLine{00500       values.maxnum\_val += (int)fractpart;}
\DoxyCodeLine{00501       fractpart = fractpart -\/ (int)fractpart;}
\DoxyCodeLine{00502     \}}
\DoxyCodeLine{00503 }
\DoxyCodeLine{00504     std::map<int, TTile *> porttiles;}
\DoxyCodeLine{00505 }
\DoxyCodeLine{00506     \textcolor{comment}{// Perform the roll}}
\DoxyCodeLine{00507     \textcolor{comment}{/*-\/ RenderSettingsを複製して現在のフレームの計算用にする -\/*/}}
\DoxyCodeLine{00508     \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riAux(ri);}
\DoxyCodeLine{00509     riAux.m\_affine = \mbox{\hyperlink{class_t_affine}{TAffine}}();}
\DoxyCodeLine{00510     riAux.m\_bpp    = 32;}
\DoxyCodeLine{00511     \textcolor{comment}{// control image using its gradient is computed in 64bpp}}
\DoxyCodeLine{00512     \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riAux64(riAux);}
\DoxyCodeLine{00513     riAux64.m\_bpp = 64;}
\DoxyCodeLine{00514 }
\DoxyCodeLine{00515     \textcolor{keywordtype}{int} r\_frame;  \textcolor{comment}{// Useful in case of negative roll frames}}
\DoxyCodeLine{00516     \textcolor{keywordflow}{if} (frame < 0)}
\DoxyCodeLine{00517       r\_frame = 0;}
\DoxyCodeLine{00518     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00519       r\_frame = frame;}
\DoxyCodeLine{00520     \textcolor{comment}{/*-\/ 出力画像のバウンディングボックス -\/*/}}
\DoxyCodeLine{00521     \mbox{\hyperlink{class_t_rect_t}{TRectD}} outTileBBox(tile-\/>m\_pos, \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tile-\/>getRaster()-\/>getLx(),}
\DoxyCodeLine{00522                                                 tile-\/>getRaster()-\/>getLy()));}
\DoxyCodeLine{00523 }
\DoxyCodeLine{00524     \textcolor{comment}{// enlarge bounding box for control images with infinite bbox in case the}}
\DoxyCodeLine{00525     \textcolor{comment}{// source region is larger than output tile}}
\DoxyCodeLine{00526     \mbox{\hyperlink{class_t_rect_t}{TRectD}} bboxForInifiniteSource = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}}.\mbox{\hyperlink{class_t_affine_a570529b96b1ec5abc711aaa9aac09ff9}{inv}}() * outTileBBox;}
\DoxyCodeLine{00527     \mbox{\hyperlink{class_t_rect_t}{TRectD}} sourceBbox;}
\DoxyCodeLine{00528     \textcolor{keywordflow}{if} (values.source\_ctrl\_val \&\&}
\DoxyCodeLine{00529         ctrl\_ports.at(values.source\_ctrl\_val)-\/>isConnected()) \{}
\DoxyCodeLine{00530       (*(ctrl\_ports.at(values.source\_ctrl\_val)))}
\DoxyCodeLine{00531           -\/>getBBox(r\_frame, sourceBbox, riAux);}
\DoxyCodeLine{00532     \}}
\DoxyCodeLine{00533     \textcolor{keywordflow}{if} (sourceBbox.\mbox{\hyperlink{class_t_rect_t_a53ce09c6112f8a019b43ad82d721a93b}{isEmpty}}() || sourceBbox == TConsts::infiniteRectD) \{}
\DoxyCodeLine{00534       sourceBbox = \mbox{\hyperlink{class_t_rect_t}{TRectD}}(values.x\_pos\_val -\/ values.length\_val * 0.5,}
\DoxyCodeLine{00535                           values.y\_pos\_val -\/ values.height\_val * 0.5,}
\DoxyCodeLine{00536                           values.x\_pos\_val + values.length\_val * 0.5,}
\DoxyCodeLine{00537                           values.y\_pos\_val + values.height\_val * 0.5);}
\DoxyCodeLine{00538     \}}
\DoxyCodeLine{00539     bboxForInifiniteSource += sourceBbox;}
\DoxyCodeLine{00540 }
\DoxyCodeLine{00541     \textcolor{comment}{/*-\/ Controlに刺さっている各ポートについて -\/*/}}
\DoxyCodeLine{00542     \textcolor{keywordflow}{for} (std::map<int, TRasterFxPort *>::iterator it = ctrl\_ports.begin();}
\DoxyCodeLine{00543          it != ctrl\_ports.end(); ++it) \{}
\DoxyCodeLine{00544       \mbox{\hyperlink{class_t_tile}{TTile}} *tmp;}
\DoxyCodeLine{00545       \textcolor{comment}{/*-\/ ポートが接続されていて、Fx内で実際に使用されていたら -\/*/}}
\DoxyCodeLine{00546       \textcolor{keywordflow}{if} ((it-\/>second)-\/>isConnected() \&\& port\_is\_used(it-\/>first, values)) \{}
\DoxyCodeLine{00547         \mbox{\hyperlink{class_t_rect_t}{TRectD}} bbox;}
\DoxyCodeLine{00548         (*(it-\/>second))-\/>getBBox(r\_frame, bbox, riAux);}
\DoxyCodeLine{00549         \textcolor{comment}{/*-\/ 素材が存在する場合、portTilesにコントロール画像タイルを格納 -\/*/}}
\DoxyCodeLine{00550         \textcolor{keywordflow}{if} (!bbox.\mbox{\hyperlink{class_t_rect_t_a53ce09c6112f8a019b43ad82d721a93b}{isEmpty}}()) \{}
\DoxyCodeLine{00551           \textcolor{keywordflow}{if} (bbox == TConsts::infiniteRectD)  \textcolor{comment}{// There could be an infinite}}
\DoxyCodeLine{00552                                                \textcolor{comment}{// bbox -\/ deal with it}}
\DoxyCodeLine{00553             bbox = bboxForInifiniteSource;}
\DoxyCodeLine{00554 }
\DoxyCodeLine{00555           \textcolor{keywordflow}{if} (frame <= pcFrame) \{}
\DoxyCodeLine{00556             \textcolor{comment}{// This frame will not actually be rolled. However, it was}}
\DoxyCodeLine{00557             \textcolor{comment}{// dryComputed -\/ so, declare the same here.}}
\DoxyCodeLine{00558             (*it-\/>second)-\/>dryCompute(bbox, r\_frame, riAux);}
\DoxyCodeLine{00559           \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00560             \textcolor{comment}{// control image is used its gradient}}
\DoxyCodeLine{00561             \textcolor{keywordflow}{if} (port\_is\_used\_for\_gradient(it-\/>first, values)) \{}
\DoxyCodeLine{00562               tmp = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_tile}{TTile}};}
\DoxyCodeLine{00563 }
\DoxyCodeLine{00564               \textcolor{keywordflow}{if} (isPrecomputingEnabled)}
\DoxyCodeLine{00565                 (*it-\/>second)}
\DoxyCodeLine{00566                     -\/>allocateAndCompute(*tmp, bbox.getP00(),}
\DoxyCodeLine{00567                                          convert(bbox).getSize(), 0, r\_frame,}
\DoxyCodeLine{00568                                          riAux64);}
\DoxyCodeLine{00569               \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00570                 std::string alias =}
\DoxyCodeLine{00571                     \textcolor{stringliteral}{"{}CTRL64: "{}} + (*(it-\/>second))-\/>getAlias(r\_frame, riAux64);}
\DoxyCodeLine{00572                 \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{00573 }
\DoxyCodeLine{00574                 \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00575                   tmp-\/>m\_pos = bbox.getP00();}
\DoxyCodeLine{00576                   tmp-\/>setRaster(rimg-\/>getRaster());}
\DoxyCodeLine{00577                 \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00578                   (*it-\/>second)}
\DoxyCodeLine{00579                       -\/>allocateAndCompute(*tmp, bbox.getP00(),}
\DoxyCodeLine{00580                                            convert(bbox).getSize(), 0, r\_frame,}
\DoxyCodeLine{00581                                            riAux64);}
\DoxyCodeLine{00582 }
\DoxyCodeLine{00583                   addRenderCache(alias, \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}}(tmp-\/>getRaster()));}
\DoxyCodeLine{00584                 \}}
\DoxyCodeLine{00585               \}}
\DoxyCodeLine{00586 }
\DoxyCodeLine{00587               porttiles[it-\/>first + Ctrl\_64\_Offset] = tmp;}
\DoxyCodeLine{00588 }
\DoxyCodeLine{00589               \textcolor{comment}{// in case the control image is also used for non-\/gradient}}
\DoxyCodeLine{00590               \textcolor{keywordflow}{if} (port\_is\_used\_for\_value(it-\/>first, values)) \{}
\DoxyCodeLine{00591                 \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} tileRas(tmp-\/>getRaster()-\/>getSize());}
\DoxyCodeLine{00592                 \mbox{\hyperlink{namespace_t_rop_a45a08fb48dd7d33ec629d722081d55c6}{TRop::convert}}(tileRas, tmp-\/>getRaster());}
\DoxyCodeLine{00593                 tmp        = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_tile}{TTile}};}
\DoxyCodeLine{00594                 tmp-\/>m\_pos = bbox.getP00();}
\DoxyCodeLine{00595                 tmp-\/>setRaster(tileRas);}
\DoxyCodeLine{00596                 porttiles[it-\/>first] = tmp;}
\DoxyCodeLine{00597               \}}
\DoxyCodeLine{00598             \}}
\DoxyCodeLine{00599             \textcolor{comment}{// control images used only for non-\/gradient}}
\DoxyCodeLine{00600             \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00601               tmp = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_tile}{TTile}};}
\DoxyCodeLine{00602 }
\DoxyCodeLine{00603               \textcolor{keywordflow}{if} (isPrecomputingEnabled)}
\DoxyCodeLine{00604                 (*it-\/>second)}
\DoxyCodeLine{00605                     -\/>allocateAndCompute(*tmp, bbox.getP00(),}
\DoxyCodeLine{00606                                          convert(bbox).getSize(), 0, r\_frame,}
\DoxyCodeLine{00607                                          riAux);}
\DoxyCodeLine{00608               \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00609                 std::string alias =}
\DoxyCodeLine{00610                     \textcolor{stringliteral}{"{}CTRL: "{}} + (*(it-\/>second))-\/>getAlias(r\_frame, riAux);}
\DoxyCodeLine{00611                 \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{00612 }
\DoxyCodeLine{00613                 \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00614                   tmp-\/>m\_pos = bbox.getP00();}
\DoxyCodeLine{00615                   tmp-\/>setRaster(rimg-\/>getRaster());}
\DoxyCodeLine{00616                 \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00617                   (*it-\/>second)}
\DoxyCodeLine{00618                       -\/>allocateAndCompute(*tmp, bbox.getP00(),}
\DoxyCodeLine{00619                                            convert(bbox).getSize(), 0, r\_frame,}
\DoxyCodeLine{00620                                            riAux);}
\DoxyCodeLine{00621 }
\DoxyCodeLine{00622                   addRenderCache(alias, \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}}(tmp-\/>getRaster()));}
\DoxyCodeLine{00623                 \}}
\DoxyCodeLine{00624               \}}
\DoxyCodeLine{00625 }
\DoxyCodeLine{00626               porttiles[it-\/>first] = tmp;}
\DoxyCodeLine{00627             \}}
\DoxyCodeLine{00628           \}}
\DoxyCodeLine{00629         \}}
\DoxyCodeLine{00630       \}}
\DoxyCodeLine{00631     \}}
\DoxyCodeLine{00632 }
\DoxyCodeLine{00633     \textcolor{keywordflow}{if} (frame > pcFrame) \{}
\DoxyCodeLine{00634       \textcolor{comment}{// Invoke the actual rolling procedure}}
\DoxyCodeLine{00635       roll\_particles(tile, porttiles, riAux, myParticles, values, 0, 0, frame,}
\DoxyCodeLine{00636                      curr\_frame, level\_n, \&random\_level, 1, last\_frame,}
\DoxyCodeLine{00637                      totalparticles);}
\DoxyCodeLine{00638 }
\DoxyCodeLine{00639       \textcolor{comment}{// Store the rolled data in the particles manager}}
\DoxyCodeLine{00640       \textcolor{keywordflow}{if} (!particlesData-\/>m\_calculated ||}
\DoxyCodeLine{00641           particlesData-\/>m\_frame + particlesData-\/>m\_maxTrail < frame) \{}
\DoxyCodeLine{00642         particlesData-\/>m\_frame     = frame;}
\DoxyCodeLine{00643         particlesData-\/>m\_particles = myParticles;}
\DoxyCodeLine{00644         particlesData-\/>m\_random    = myRandom;}
\DoxyCodeLine{00645         particlesData-\/>buildMaxTrail();}
\DoxyCodeLine{00646         particlesData-\/>m\_calculated     = \textcolor{keyword}{true};}
\DoxyCodeLine{00647         particlesData-\/>m\_totalParticles = totalparticles;}
\DoxyCodeLine{00648       \}}
\DoxyCodeLine{00649     \}}
\DoxyCodeLine{00650 }
\DoxyCodeLine{00651     \textcolor{comment}{// Render the particles if the distance from current frame is a trail}}
\DoxyCodeLine{00652     \textcolor{comment}{// multiple}}
\DoxyCodeLine{00653     \textcolor{keywordflow}{if} (frame >= startframe -\/ 1 \&\&}
\DoxyCodeLine{00654         !(dist\_frame \%}
\DoxyCodeLine{00655           (values.trailstep\_val > 1.0 ? (\textcolor{keywordtype}{int})values.trailstep\_val : 1))) \{}
\DoxyCodeLine{00656       \textcolor{comment}{// Store the maximum particle size before the do\_render cycle}}
\DoxyCodeLine{00657       std::list<Particle>::iterator pt;}
\DoxyCodeLine{00658       \textcolor{keywordflow}{for} (pt = myParticles.begin(); pt != myParticles.end(); ++pt) \{}
\DoxyCodeLine{00659         \mbox{\hyperlink{class_particle}{Particle}} \&part = *pt;}
\DoxyCodeLine{00660         \textcolor{keywordtype}{int} ndx        = part.frame \% last\_frame[part.level];}
\DoxyCodeLine{00661         std::pair<int, int> ndxPair(part.level, ndx);}
\DoxyCodeLine{00662 }
\DoxyCodeLine{00663         std::map<std::pair<int, int>, \textcolor{keywordtype}{double}>::iterator it =}
\DoxyCodeLine{00664             partScales.find(ndxPair);}
\DoxyCodeLine{00665 }
\DoxyCodeLine{00666         \textcolor{keywordflow}{if} (it != partScales.end())}
\DoxyCodeLine{00667           it-\/>second = std::max(part.scale, it-\/>second);}
\DoxyCodeLine{00668         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00669           partScales[ndxPair] = part.scale;}
\DoxyCodeLine{00670       \}}
\DoxyCodeLine{00671 }
\DoxyCodeLine{00672       \textcolor{keywordflow}{if} (values.toplayer\_val == ParticlesFx::TOP\_SMALLER ||}
\DoxyCodeLine{00673           values.toplayer\_val == ParticlesFx::TOP\_BIGGER)}
\DoxyCodeLine{00674         myParticles.sort(\mbox{\hyperlink{class_compareby_size}{ComparebySize}}());}
\DoxyCodeLine{00675 }
\DoxyCodeLine{00676       \textcolor{keywordflow}{if} (values.toplayer\_val == ParticlesFx::TOP\_SMALLER) \{}
\DoxyCodeLine{00677         std::list<Particle>::iterator pt;}
\DoxyCodeLine{00678         \textcolor{keywordflow}{for} (pt = myParticles.begin(); pt != myParticles.end(); ++pt) \{}
\DoxyCodeLine{00679           \mbox{\hyperlink{class_particle}{Particle}} \&part = *pt;}
\DoxyCodeLine{00680           \textcolor{keywordflow}{if} (dist\_frame <= part.trail \&\& part.scale \&\& part.lifetime > 0 \&\&}
\DoxyCodeLine{00681               part.lifetime <=}
\DoxyCodeLine{00682                   part.genlifetime)  \textcolor{comment}{// This last... shouldn't always be?}}
\DoxyCodeLine{00683           \{}
\DoxyCodeLine{00684             do\_render(\&part, tile, part\_ports, porttiles, ri, p\_size, p\_offset,}
\DoxyCodeLine{00685                       last\_frame[part.level], partLevel, values, opacity\_range,}
\DoxyCodeLine{00686                       dist\_frame, partScales);}
\DoxyCodeLine{00687           \}}
\DoxyCodeLine{00688         \}}
\DoxyCodeLine{00689       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00690         std::list<Particle>::reverse\_iterator pt;}
\DoxyCodeLine{00691         \textcolor{keywordflow}{for} (pt = myParticles.rbegin(); pt != myParticles.rend(); ++pt) \{}
\DoxyCodeLine{00692           \mbox{\hyperlink{class_particle}{Particle}} \&part = *pt;}
\DoxyCodeLine{00693           \textcolor{keywordflow}{if} (dist\_frame <= part.trail \&\& part.scale \&\& part.lifetime > 0 \&\&}
\DoxyCodeLine{00694               part.lifetime <= part.genlifetime)  \textcolor{comment}{// Same here..?}}
\DoxyCodeLine{00695           \{}
\DoxyCodeLine{00696             do\_render(\&part, tile, part\_ports, porttiles, ri, p\_size, p\_offset,}
\DoxyCodeLine{00697                       last\_frame[part.level], partLevel, values, opacity\_range,}
\DoxyCodeLine{00698                       dist\_frame, partScales);}
\DoxyCodeLine{00699           \}}
\DoxyCodeLine{00700         \}}
\DoxyCodeLine{00701       \}}
\DoxyCodeLine{00702     \}}
\DoxyCodeLine{00703 }
\DoxyCodeLine{00704     std::map<int, TTile *>::iterator it;}
\DoxyCodeLine{00705     \textcolor{keywordflow}{for} (it = porttiles.begin(); it != porttiles.end(); ++it) \textcolor{keyword}{delete} it-\/>second;}
\DoxyCodeLine{00706   \}}
\DoxyCodeLine{00707 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_particles___engine_a09e5db1ac2446bbcde754102a3030bd2}\label{class_particles___engine_a09e5db1ac2446bbcde754102a3030bd2}} 
\index{Particles\_Engine@{Particles\_Engine}!roll\_particles@{roll\_particles}}
\index{roll\_particles@{roll\_particles}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{roll\_particles()}{roll\_particles()}}
{\footnotesize\ttfamily void Particles\+\_\+\+Engine\+::roll\+\_\+particles (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$}]{porttiles,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{std\+::list$<$ \mbox{\hyperlink{class_particle}{Particle}} $>$ \&}]{my\+Particles,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{float}]{cx,  }\item[{float}]{cy,  }\item[{int}]{frame,  }\item[{int}]{curr\+\_\+frame,  }\item[{int}]{level\+\_\+n,  }\item[{bool $\ast$}]{random\+\_\+level,  }\item[{float}]{dpi,  }\item[{std\+::vector$<$ int $>$}]{lastframe,  }\item[{int \&}]{totalparticles }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00194                                                               \{}
\DoxyCodeLine{00195   \mbox{\hyperlink{structparticles__ranges}{particles\_ranges}} ranges;}
\DoxyCodeLine{00196   \textcolor{keywordtype}{int} i, newparticles;}
\DoxyCodeLine{00197   \textcolor{keywordtype}{float} xgravity, ygravity, windx, windy;}
\DoxyCodeLine{00198   \textcolor{comment}{/*-\/-\/ 風の強さ／重力の強さをX,Y成分に分ける -\/-\/*/}}
\DoxyCodeLine{00199   windx    = values.windint\_val * sin(values.windangle\_val);}
\DoxyCodeLine{00200   windy    = values.windint\_val * cos(values.windangle\_val);}
\DoxyCodeLine{00201   xgravity = values.gravity\_val * sin(values.g\_angle\_val);}
\DoxyCodeLine{00202   ygravity = values.gravity\_val * cos(values.g\_angle\_val);}
\DoxyCodeLine{00203 }
\DoxyCodeLine{00204   fill\_range\_struct(values, ranges);}
\DoxyCodeLine{00205 }
\DoxyCodeLine{00206   std::vector<std::vector<TPointD>> myregions;}
\DoxyCodeLine{00207 }
\DoxyCodeLine{00208   \textcolor{comment}{/*-\/-\/ [1〜255]}}
\DoxyCodeLine{00209 \textcolor{comment}{   * そのIndexに対応するアルファ値を持つピクセルのインデックス値を保存。 [0]}}
\DoxyCodeLine{00210 \textcolor{comment}{   * 使用せず -\/-\/*/}}
\DoxyCodeLine{00211   std::vector<std::vector<int>> myHistogram;}
\DoxyCodeLine{00212   \textcolor{comment}{/*-\/-\/}}
\DoxyCodeLine{00213 \textcolor{comment}{   * アルファ値255から下がっていき、ピクセル数×重み又はアルファ値を次々足した値を格納}}
\DoxyCodeLine{00214 \textcolor{comment}{   * -\/-\/*/}}
\DoxyCodeLine{00215   std::vector<float> myWeight;}
\DoxyCodeLine{00216 }
\DoxyCodeLine{00217   std::map<int, TTile *>::iterator it = porttiles.find(values.source\_ctrl\_val);}
\DoxyCodeLine{00218   \textcolor{comment}{/*-\/-\/ Perspective}}
\DoxyCodeLine{00219 \textcolor{comment}{   * DistributionがONのとき、Sizeに刺さったControlImageが粒子の発生分布を決める}}
\DoxyCodeLine{00220 \textcolor{comment}{   * -\/-\/*/}}
\DoxyCodeLine{00221   std::map<int, TTile *>::iterator sizeIt =}
\DoxyCodeLine{00222       porttiles.find(values.scale\_ctrl\_val);}
\DoxyCodeLine{00223   \textcolor{keywordflow}{if} (values.perspective\_distribution\_val \&\& (sizeIt != porttiles.end())) \{}
\DoxyCodeLine{00224     \textcolor{comment}{/*-\/-\/ ソース画像にコントロールが付いていた場合、そのアルファ値をマスクに使う}}
\DoxyCodeLine{00225 \textcolor{comment}{     * -\/-\/*/}}
\DoxyCodeLine{00226     \textcolor{keywordflow}{if} (values.source\_ctrl\_val \&\& (it != porttiles.end()))}
\DoxyCodeLine{00227       fill\_regions\_with\_size\_map(myregions, myHistogram, sizeIt-\/>second,}
\DoxyCodeLine{00228                                  it-\/>second, values.bright\_thres\_val);}
\DoxyCodeLine{00229     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00230       fill\_regions\_with\_size\_map(myregions, myHistogram, sizeIt-\/>second, 0,}
\DoxyCodeLine{00231                                  values.bright\_thres\_val);}
\DoxyCodeLine{00232     \textcolor{comment}{/*-\/ パーティクルを作る前に myregion内の候補数を合計する-\/-\/*/}}
\DoxyCodeLine{00233     \textcolor{keywordflow}{if} ((\textcolor{keywordtype}{int})myHistogram.size() == 256) \{}
\DoxyCodeLine{00234       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} m = 255; m >= 0; m-\/-\/) \{}
\DoxyCodeLine{00235         \textcolor{comment}{/*-\/-\/ 明度からサイズ サイズから重みを出す -\/-\/*/}}
\DoxyCodeLine{00236         \textcolor{keywordtype}{float} scale =}
\DoxyCodeLine{00237             values.scale\_val.first + ranges.scale\_range * (float)m / 255.0f;}
\DoxyCodeLine{00238         \textcolor{keywordtype}{float} weight = 1.0f / (scale * scale);}
\DoxyCodeLine{00239 }
\DoxyCodeLine{00240         \textcolor{keywordtype}{float} tmpSum = weight * (float)myHistogram[m].size();}
\DoxyCodeLine{00241         \textcolor{keywordtype}{int} index    = 255 -\/ m;}
\DoxyCodeLine{00242         \textcolor{keywordflow}{if} (index > 0) \textcolor{comment}{/*-\/-\/ これまでの合計に追加する -\/-\/*/}}
\DoxyCodeLine{00243           tmpSum += myWeight[index -\/ 1];}
\DoxyCodeLine{00244         myWeight.push\_back(tmpSum);}
\DoxyCodeLine{00245       \}}
\DoxyCodeLine{00246     \}}
\DoxyCodeLine{00247   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00248     \textcolor{comment}{/*-\/ ソース画像にコントロールが付いていた場合 -\/*/}}
\DoxyCodeLine{00249     \textcolor{keywordflow}{if} (values.source\_ctrl\_val \&\& (it != porttiles.end()))}
\DoxyCodeLine{00250       \textcolor{comment}{/*-\/-\/ 入力画像のアルファ値に比例して発生濃度を変える -\/-\/*/}}
\DoxyCodeLine{00251       fill\_regions(1, myregions, it-\/>second, values.multi\_source\_val,}
\DoxyCodeLine{00252                    values.bright\_thres\_val, values.source\_gradation\_val,}
\DoxyCodeLine{00253                    myHistogram);}
\DoxyCodeLine{00254 }
\DoxyCodeLine{00255     \textcolor{comment}{/*-\/ パーティクルを作る前に myregion内の候補数を合計する-\/-\/*/}}
\DoxyCodeLine{00256     \textcolor{comment}{/*-\/-\/ myWeight}}
\DoxyCodeLine{00257 \textcolor{comment}{     * の中には、アルファ255から0まで、各アルファ値×ポイント数を足しこんでいったものが格納される。-\/-\/*/}}
\DoxyCodeLine{00258     \textcolor{keywordflow}{if} ((\textcolor{keywordtype}{int})myHistogram.size() == 256) \{}
\DoxyCodeLine{00259       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} m = 255; m > 0; m-\/-\/) \{}
\DoxyCodeLine{00260         \textcolor{keywordtype}{float} tmpSum = (float)(m * (\textcolor{keywordtype}{int})myHistogram[m].size());}
\DoxyCodeLine{00261         \textcolor{keywordtype}{int} index    = 255 -\/ m;}
\DoxyCodeLine{00262         \textcolor{keywordflow}{if} (index > 0) tmpSum += myWeight[index -\/ 1];}
\DoxyCodeLine{00263         myWeight.push\_back(tmpSum);}
\DoxyCodeLine{00264       \}}
\DoxyCodeLine{00265     \}}
\DoxyCodeLine{00266   \}}
\DoxyCodeLine{00267 }
\DoxyCodeLine{00268   \textcolor{comment}{/*-\/ birth rate を格納 -\/*/}}
\DoxyCodeLine{00269   newparticles = (int)values.maxnum\_val;}
\DoxyCodeLine{00270   if (myParticles.empty() \&\& newparticles)  \textcolor{comment}{// Initial creation}}
\DoxyCodeLine{00271   \{}
\DoxyCodeLine{00272     \textcolor{comment}{/*-\/ 新たに作るパーティクルの数だけ繰り返す -\/*/}}
\DoxyCodeLine{00273     \textcolor{keywordflow}{for} (i = 0; i < newparticles; i++) \{}
\DoxyCodeLine{00274       \textcolor{keywordtype}{int} seed  = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00275                        values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00276       \textcolor{keywordtype}{int} level = (int)(values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * level\_n);}
\DoxyCodeLine{00277 }
\DoxyCodeLine{00278       \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00279       \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00280         lifetime = lastframe[level];}
\DoxyCodeLine{00281       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00282         lifetime = (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00283                          ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00284       \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame)}
\DoxyCodeLine{00285         myParticles.push\_back(\mbox{\hyperlink{class_particle}{Particle}}(}
\DoxyCodeLine{00286             lifetime, seed, porttiles, values, ranges, myregions,}
\DoxyCodeLine{00287             totalparticles, 0, level, lastframe[level], myHistogram, myWeight));}
\DoxyCodeLine{00288 }
\DoxyCodeLine{00289       totalparticles++;}
\DoxyCodeLine{00290     \}}
\DoxyCodeLine{00291   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00292     std::list<Particle>::iterator it;}
\DoxyCodeLine{00293     \textcolor{keywordflow}{for} (it = myParticles.begin(); it != myParticles.end();) \{}
\DoxyCodeLine{00294       std::list<Particle>::iterator current = it;}
\DoxyCodeLine{00295       ++it;}
\DoxyCodeLine{00296 }
\DoxyCodeLine{00297       \mbox{\hyperlink{class_particle}{Particle}} \&part = (*current);}
\DoxyCodeLine{00298       \textcolor{keywordflow}{if} (part.lifetime <= 0)        \textcolor{comment}{// Note: This is in line with the above}}
\DoxyCodeLine{00299                                      \textcolor{comment}{// "{}lifetime>curr\_frame-\/frame"{}}}
\DoxyCodeLine{00300         myParticles.erase(current);  \textcolor{comment}{// insertion counterpart}}
\DoxyCodeLine{00301       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00302         part.move(porttiles, values, ranges, windx, windy, xgravity, ygravity,}
\DoxyCodeLine{00303                   dpi, lastframe[part.level]);}
\DoxyCodeLine{00304     \}}
\DoxyCodeLine{00305 }
\DoxyCodeLine{00306     \textcolor{keywordtype}{int} oldparticles = myParticles.size();}
\DoxyCodeLine{00307     \textcolor{keywordflow}{switch} (values.toplayer\_val) \{}
\DoxyCodeLine{00308     \textcolor{keywordflow}{case} ParticlesFx::TOP\_YOUNGER:}
\DoxyCodeLine{00309       \textcolor{keywordflow}{for} (i = 0; i < newparticles; i++) \{}
\DoxyCodeLine{00310         \textcolor{keywordtype}{int} seed  = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00311                          values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00312         \textcolor{keywordtype}{int} level = (int)(values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * level\_n);}
\DoxyCodeLine{00313 }
\DoxyCodeLine{00314         \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00315         \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00316           lifetime = lastframe[level];}
\DoxyCodeLine{00317         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00318           lifetime =}
\DoxyCodeLine{00319               (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00320                     ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00321 }
\DoxyCodeLine{00322         \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame)}
\DoxyCodeLine{00323           myParticles.push\_front(\mbox{\hyperlink{class_particle}{Particle}}(lifetime, seed, porttiles, values,}
\DoxyCodeLine{00324                                           ranges, myregions, totalparticles, 0,}
\DoxyCodeLine{00325                                           level, lastframe[level], myHistogram,}
\DoxyCodeLine{00326                                           myWeight));}
\DoxyCodeLine{00327 }
\DoxyCodeLine{00328         totalparticles++;}
\DoxyCodeLine{00329       \}}
\DoxyCodeLine{00330       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00331 }
\DoxyCodeLine{00332     \textcolor{keywordflow}{case} ParticlesFx::TOP\_RANDOM:}
\DoxyCodeLine{00333       \textcolor{keywordflow}{for} (i = 0; i < newparticles; i++) \{}
\DoxyCodeLine{00334         \textcolor{keywordtype}{double} tmp = values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * myParticles.size();}
\DoxyCodeLine{00335         std::list<Particle>::iterator it = myParticles.begin();}
\DoxyCodeLine{00336         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < tmp; j++, it++)}
\DoxyCodeLine{00337           ;}
\DoxyCodeLine{00338         \{}
\DoxyCodeLine{00339           \textcolor{keywordtype}{int} seed     = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00340                            values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00341           \textcolor{keywordtype}{int} level    = (int)(values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * level\_n);}
\DoxyCodeLine{00342           \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00343 }
\DoxyCodeLine{00344           \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00345             lifetime = lastframe[level];}
\DoxyCodeLine{00346           \textcolor{keywordflow}{else}}
\DoxyCodeLine{00347             lifetime =}
\DoxyCodeLine{00348                 (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00349                       ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00350           \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame)}
\DoxyCodeLine{00351             myParticles.insert(}
\DoxyCodeLine{00352                 it, \mbox{\hyperlink{class_particle}{Particle}}(lifetime, seed, porttiles, values, ranges,}
\DoxyCodeLine{00353                              myregions, totalparticles, 0, level,}
\DoxyCodeLine{00354                              lastframe[level], myHistogram, myWeight));}
\DoxyCodeLine{00355 }
\DoxyCodeLine{00356           totalparticles++;}
\DoxyCodeLine{00357         \}}
\DoxyCodeLine{00358       \}}
\DoxyCodeLine{00359       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00360 }
\DoxyCodeLine{00361     \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00362       \textcolor{keywordflow}{for} (i = 0; i < newparticles; i++) \{}
\DoxyCodeLine{00363         \textcolor{keywordtype}{int} seed     = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00364                          values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00365         \textcolor{keywordtype}{int} level    = (int)(values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * level\_n);}
\DoxyCodeLine{00366         \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00367 }
\DoxyCodeLine{00368         \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00369           lifetime = lastframe[level];}
\DoxyCodeLine{00370         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00371           lifetime =}
\DoxyCodeLine{00372               (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00373                     ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00374         \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame)}
\DoxyCodeLine{00375           myParticles.push\_back(\mbox{\hyperlink{class_particle}{Particle}}(lifetime, seed, porttiles, values,}
\DoxyCodeLine{00376                                          ranges, myregions, totalparticles, 0,}
\DoxyCodeLine{00377                                          level, lastframe[level], myHistogram,}
\DoxyCodeLine{00378                                          myWeight));}
\DoxyCodeLine{00379 }
\DoxyCodeLine{00380         totalparticles++;}
\DoxyCodeLine{00381       \}}
\DoxyCodeLine{00382       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00383     \}}
\DoxyCodeLine{00384   \}}
\DoxyCodeLine{00385 \}}

\end{DoxyCode}


\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{class_particles___engine_afeaa4f1b12435855c7a7f662fdbf0d1e}\label{class_particles___engine_afeaa4f1b12435855c7a7f662fdbf0d1e}} 
\index{Particles\_Engine@{Particles\_Engine}!m\_frame@{m\_frame}}
\index{m\_frame@{m\_frame}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{m\_frame}{m\_frame}}
{\footnotesize\ttfamily double Particles\+\_\+\+Engine\+::m\+\_\+frame}

\mbox{\Hypertarget{class_particles___engine_a4d9ac86983ecdde346bf1f865aec8d5f}\label{class_particles___engine_a4d9ac86983ecdde346bf1f865aec8d5f}} 
\index{Particles\_Engine@{Particles\_Engine}!m\_parent@{m\_parent}}
\index{m\_parent@{m\_parent}!Particles\_Engine@{Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{m\_parent}{m\_parent}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_particles_fx}{Particles\+Fx}}$\ast$ Particles\+\_\+\+Engine\+::m\+\_\+parent}



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/stdfx/particlesengine.\+h\item 
E\+:/opentoonz/toonz/sources/stdfx/particlesengine.\+cpp\end{DoxyCompactItemize}
