\hypertarget{class_playback_executor}{}\doxysection{Playback\+Executor Class Reference}
\label{class_playback_executor}\index{PlaybackExecutor@{PlaybackExecutor}}
Inheritance diagram for Playback\+Executor\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=2.000000cm]{class_playback_executor}
\end{center}
\end{figure}
\doxysubsection*{Signals}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{class_playback_executor_a575ae5eb0c38fc64f2a589a683bf5028}\label{class_playback_executor_a575ae5eb0c38fc64f2a589a683bf5028}} 
void {\bfseries next\+Frame} (int fps, QElapsed\+Timer $\ast$timer, qint64 target\+Instant)
\end{DoxyCompactItemize}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_playback_executor_a729a4ce96d27fcef9c135335fb13b7c2}{reset\+Fps}} (int fps)
\item 
void \mbox{\hyperlink{class_playback_executor_ac4f769fb1b5c41e193ec2715fb0cf71b}{run}} () override
\item 
void \mbox{\hyperlink{class_playback_executor_adbe6b13ff2785db5ccd3ca8e438a554d}{abort}} ()
\item 
bool \mbox{\hyperlink{class_playback_executor_abc92e73b66fc519f9be3f47ae81e2017}{is\+Aborted}} ()
\item 
void \mbox{\hyperlink{class_playback_executor_ae18f6fa4c6846d2612fd08e16636b050}{emit\+Next\+Frame}} (int fps)
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_playback_executor_a4544e6dcf5a338589fd9c14b9911a179}\label{class_playback_executor_a4544e6dcf5a338589fd9c14b9911a179}} 
\index{PlaybackExecutor@{PlaybackExecutor}!PlaybackExecutor@{PlaybackExecutor}}
\index{PlaybackExecutor@{PlaybackExecutor}!PlaybackExecutor@{PlaybackExecutor}}
\doxysubsubsection{\texorpdfstring{PlaybackExecutor()}{PlaybackExecutor()}}
{\footnotesize\ttfamily Playback\+Executor\+::\+Playback\+Executor (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00147 : m\_fps(25), m\_abort(\textcolor{keyword}{false}) \{\}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_playback_executor_adbe6b13ff2785db5ccd3ca8e438a554d}\label{class_playback_executor_adbe6b13ff2785db5ccd3ca8e438a554d}} 
\index{PlaybackExecutor@{PlaybackExecutor}!abort@{abort}}
\index{abort@{abort}!PlaybackExecutor@{PlaybackExecutor}}
\doxysubsubsection{\texorpdfstring{abort()}{abort()}}
{\footnotesize\ttfamily void Playback\+Executor\+::abort (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00064 \{ m\_abort = \textcolor{keyword}{true}; \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_playback_executor_ae18f6fa4c6846d2612fd08e16636b050}\label{class_playback_executor_ae18f6fa4c6846d2612fd08e16636b050}} 
\index{PlaybackExecutor@{PlaybackExecutor}!emitNextFrame@{emitNextFrame}}
\index{emitNextFrame@{emitNextFrame}!PlaybackExecutor@{PlaybackExecutor}}
\doxysubsubsection{\texorpdfstring{emitNextFrame()}{emitNextFrame()}}
{\footnotesize\ttfamily void Playback\+Executor\+::emit\+Next\+Frame (\begin{DoxyParamCaption}\item[{int}]{fps }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00066 \{ emit nextFrame(fps, \textcolor{keyword}{nullptr}, 0); \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_playback_executor_abc92e73b66fc519f9be3f47ae81e2017}\label{class_playback_executor_abc92e73b66fc519f9be3f47ae81e2017}} 
\index{PlaybackExecutor@{PlaybackExecutor}!isAborted@{isAborted}}
\index{isAborted@{isAborted}!PlaybackExecutor@{PlaybackExecutor}}
\doxysubsubsection{\texorpdfstring{isAborted()}{isAborted()}}
{\footnotesize\ttfamily bool Playback\+Executor\+::is\+Aborted (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00065 \{ \textcolor{keywordflow}{return} m\_abort; \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_playback_executor_a729a4ce96d27fcef9c135335fb13b7c2}\label{class_playback_executor_a729a4ce96d27fcef9c135335fb13b7c2}} 
\index{PlaybackExecutor@{PlaybackExecutor}!resetFps@{resetFps}}
\index{resetFps@{resetFps}!PlaybackExecutor@{PlaybackExecutor}}
\doxysubsubsection{\texorpdfstring{resetFps()}{resetFps()}}
{\footnotesize\ttfamily void Playback\+Executor\+::reset\+Fps (\begin{DoxyParamCaption}\item[{int}]{fps }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00151 \{ m\_fps = fps; \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_playback_executor_ac4f769fb1b5c41e193ec2715fb0cf71b}\label{class_playback_executor_ac4f769fb1b5c41e193ec2715fb0cf71b}} 
\index{PlaybackExecutor@{PlaybackExecutor}!run@{run}}
\index{run@{run}!PlaybackExecutor@{PlaybackExecutor}}
\doxysubsubsection{\texorpdfstring{run()}{run()}}
{\footnotesize\ttfamily void Playback\+Executor\+::run (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00155                            \{}
\DoxyCodeLine{00156   \textcolor{comment}{// (Daniele)}}
\DoxyCodeLine{00157   \textcolor{comment}{// We'll build the fps considering an interval of roughly 1 second (the last}}
\DoxyCodeLine{00158   \textcolor{comment}{// one). However, the fps should be sampled at a faster rate. Each sample is}}
\DoxyCodeLine{00159   \textcolor{comment}{// taken at 1/4 second, and the last 4 samples data are stored to keep trace}}
\DoxyCodeLine{00160   \textcolor{comment}{// of the last second of playback.}}
\DoxyCodeLine{00161   m\_timer.start();}
\DoxyCodeLine{00162 }
\DoxyCodeLine{00163   qint64 timeResolution =}
\DoxyCodeLine{00164       250 * 1000000;  \textcolor{comment}{// Use a sufficient sampling resolution (currently 1/4}}
\DoxyCodeLine{00165                       \textcolor{comment}{// sec). Fps calculation is made once per sample.}}
\DoxyCodeLine{00166 }
\DoxyCodeLine{00167   \textcolor{keywordtype}{int} fps = m\_fps, currSample = 0;}
\DoxyCodeLine{00168   qint64 playedFramesCount = 0;}
\DoxyCodeLine{00169   qint64 nextSampleInstant = timeResolution;}
\DoxyCodeLine{00170 }
\DoxyCodeLine{00171   qint64 lastFrameCounts[4]    = \{0, 0, 0,}
\DoxyCodeLine{00172                                0\};  \textcolor{comment}{// Keep the last 4 'played frames' counts.}}
\DoxyCodeLine{00173   qint64 lastSampleInstants[4] = \{0, 0, 0,}
\DoxyCodeLine{00174                                   0\};  \textcolor{comment}{// Same for the last sampling instants}}
\DoxyCodeLine{00175 }
\DoxyCodeLine{00176   qint64 targetFrameTime =}
\DoxyCodeLine{00177       1000000000 / (qint64)abs(m\_fps);  \textcolor{comment}{// User-\/required time between frames}}
\DoxyCodeLine{00178 }
\DoxyCodeLine{00179   qint64 emissionInstant = 0;  \textcolor{comment}{// starting instant in which rendering is invoked}}
\DoxyCodeLine{00180   qint64 avgSwapTime     = 0;  \textcolor{comment}{// average time for swapping buffers}}
\DoxyCodeLine{00181   qint64 shortTermDelayAdjuster =}
\DoxyCodeLine{00182       0;  \textcolor{comment}{// accumurate recent errors and adjust in short term}}
\DoxyCodeLine{00183 }
\DoxyCodeLine{00184   \textcolor{keywordflow}{while} (!m\_abort) \{}
\DoxyCodeLine{00185     emissionInstant = m\_timer.nsecsElapsed();}
\DoxyCodeLine{00186 }
\DoxyCodeLine{00187     \textcolor{keywordflow}{if} (emissionInstant > nextSampleInstant) \{}
\DoxyCodeLine{00188       \textcolor{comment}{// Fps calculation}}
\DoxyCodeLine{00189       qint64 framesCount = playedFramesCount -\/ lastFrameCounts[currSample];}
\DoxyCodeLine{00190       qint64 elapsedTime = emissionInstant -\/ lastSampleInstants[currSample];}
\DoxyCodeLine{00191       fps                = troundp((\textcolor{keywordtype}{long} \textcolor{keywordtype}{double})(1000000000 * framesCount) /}
\DoxyCodeLine{00192                     (\textcolor{keywordtype}{long} \textcolor{keywordtype}{double})elapsedTime);}
\DoxyCodeLine{00193 }
\DoxyCodeLine{00194       targetFrameTime =}
\DoxyCodeLine{00195           1000000000 / (qint64)abs(m\_fps);  \textcolor{comment}{// m\_fps could have changed...}}
\DoxyCodeLine{00196 }
\DoxyCodeLine{00197       \textcolor{comment}{// estimate time for swapping buffers}}
\DoxyCodeLine{00198       qint64 avgSwapTimeD = (elapsedTime / framesCount) -\/ targetFrameTime;}
\DoxyCodeLine{00199       \textcolor{keywordflow}{if} (avgSwapTime -\/ avgSwapTimeD >}
\DoxyCodeLine{00200           20000000)  \textcolor{comment}{// Reset beyond, say, 20 msecs tolerance.}}
\DoxyCodeLine{00201         avgSwapTime = avgSwapTimeD;}
\DoxyCodeLine{00202       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00203         avgSwapTime += avgSwapTimeD;}
\DoxyCodeLine{00204       avgSwapTime = std::min(targetFrameTime, std::max(avgSwapTime, (qint64)0));}
\DoxyCodeLine{00205 }
\DoxyCodeLine{00206       \textcolor{comment}{// prepare for the next sampling}}
\DoxyCodeLine{00207       lastFrameCounts[currSample]    = playedFramesCount;}
\DoxyCodeLine{00208       lastSampleInstants[currSample] = emissionInstant;}
\DoxyCodeLine{00209       currSample                     = (currSample + 1) \% 4;}
\DoxyCodeLine{00210       nextSampleInstant              = emissionInstant + timeResolution;}
\DoxyCodeLine{00211     \}}
\DoxyCodeLine{00212 }
\DoxyCodeLine{00213     \textcolor{comment}{// draw the next frame}}
\DoxyCodeLine{00214     \textcolor{keywordflow}{if} (playedFramesCount) \{}
\DoxyCodeLine{00215       qint64 delayAdjust = shortTermDelayAdjuster / 4;}
\DoxyCodeLine{00216       qint64 targetInstant =}
\DoxyCodeLine{00217           emissionInstant + targetFrameTime -\/ avgSwapTime -\/ delayAdjust;}
\DoxyCodeLine{00218       targetInstant = std::max(targetInstant, emissionInstant);}
\DoxyCodeLine{00219       shortTermDelayAdjuster -\/= delayAdjust;}
\DoxyCodeLine{00220 }
\DoxyCodeLine{00221       \textcolor{comment}{// Show the next frame, telling currently measured fps}}
\DoxyCodeLine{00222       \textcolor{comment}{// The wait time will be inserted at the end of paintGL in order to}}
\DoxyCodeLine{00223       \textcolor{comment}{// achieve precise playback}}
\DoxyCodeLine{00224       emit nextFrame(fps, \&m\_timer, targetInstant);}
\DoxyCodeLine{00225 }
\DoxyCodeLine{00226       \textcolor{keywordflow}{if} (FlipConsole::m\_areLinked) \{}
\DoxyCodeLine{00227         \textcolor{comment}{// In case there are linked consoles, update them too.}}
\DoxyCodeLine{00228         \textcolor{comment}{// Their load time must be included in the fps calculation.}}
\DoxyCodeLine{00229         \textcolor{keywordtype}{int} i, consolesCount = FlipConsole::m\_visibleConsoles.size();}
\DoxyCodeLine{00230         \textcolor{keywordflow}{for} (i = 0; i < consolesCount; ++i) \{}
\DoxyCodeLine{00231           \mbox{\hyperlink{class_flip_console}{FlipConsole}} *console = FlipConsole::m\_visibleConsoles.at(i);}
\DoxyCodeLine{00232           \textcolor{keywordflow}{if} (console-\/>isLinkable() \&\& console != FlipConsole::m\_currentConsole)}
\DoxyCodeLine{00233             console-\/>playbackExecutor().emitNextFrame(m\_fps < 0 ? -\/fps : fps);}
\DoxyCodeLine{00234         \}}
\DoxyCodeLine{00235       \}}
\DoxyCodeLine{00236     \}}
\DoxyCodeLine{00237 }
\DoxyCodeLine{00238     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/ Each nextFrame() blocks until the frame has been shown -\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00239 }
\DoxyCodeLine{00240     \textcolor{comment}{// accumurate error and slightly adjust waiting time for subsequent frames}}
\DoxyCodeLine{00241     qint64 delay = m\_timer.nsecsElapsed() -\/ emissionInstant -\/ targetFrameTime;}
\DoxyCodeLine{00242     \textcolor{comment}{// just ignore a large error}}
\DoxyCodeLine{00243     \textcolor{keywordflow}{if} (delay < targetFrameTime) shortTermDelayAdjuster += delay;}
\DoxyCodeLine{00244 }
\DoxyCodeLine{00245     ++playedFramesCount;}
\DoxyCodeLine{00246   \}}
\DoxyCodeLine{00247 }
\DoxyCodeLine{00248   m\_abort = \textcolor{keyword}{false};}
\DoxyCodeLine{00249   m\_timer.invalidate();}
\DoxyCodeLine{00250 \}}

\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/include/toonzqt/flipconsole.\+h\item 
E\+:/opentoonz/toonz/sources/toonzqt/flipconsole.\+cpp\end{DoxyCompactItemize}
