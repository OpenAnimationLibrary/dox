\hypertarget{class_iwa___particles___engine}{}\doxysection{Iwa\+\_\+\+Particles\+\_\+\+Engine Class Reference}
\label{class_iwa___particles___engine}\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_iwa___particles___engine_ad9c08a302d0c763aaf6680e45d723443}{Iwa\+\_\+\+Particles\+\_\+\+Engine}} (\mbox{\hyperlink{class_iwa___tiled_particles_fx}{Iwa\+\_\+\+Tiled\+Particles\+Fx}} $\ast$parent, double frame)
\item 
\mbox{\Hypertarget{class_iwa___particles___engine_a0b6044568dbb679cc678f303e3d74972}\label{class_iwa___particles___engine_a0b6044568dbb679cc678f303e3d74972}} 
void {\bfseries scramble\+\_\+particles} (void)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a3e6efcd77d68706c45f3540d6347eb47}{fill\+\_\+range\+\_\+struct}} (struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, struct \mbox{\hyperlink{structparticles__ranges}{particles\+\_\+ranges}} \&ranges)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a30ef592c2470d1c4937337494bc9ed47}{fill\+\_\+value\+\_\+struct}} (struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&value, double frame)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a818ccc2106caa5fec43413520e272883}{roll\+\_\+particles}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$ porttiles, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, std\+::list$<$ \mbox{\hyperlink{class_iwa___particle}{Iwa\+\_\+\+Particle}} $>$ \&my\+Particles, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, float cx, float cy, int frame, int curr\+\_\+frame, int level\+\_\+n, bool $\ast$random\+\_\+level, float dpi, std\+::vector$<$ int $>$ lastframe, int \&totalparticles, QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&particle\+Origin, int gen\+Part\+Num)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a0dc44ec341ee6f217096797da28dc886}{normalize\+\_\+values}} (struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a27146e0ff733de70623ab1aebbb6bee0}{render\+\_\+particles}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ part\+\_\+ports, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&p\+\_\+size, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&p\+\_\+offset, std\+::map$<$ int, \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ ctrl\+\_\+ports, std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$ part\+Level, float dpi, int curr\+\_\+frame, int shrink, double startx, double starty, double endx, double endy, std\+::vector$<$ int $>$ lastframe, unsigned long fx\+Id)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a2924ee9a714c52f031b8dd467458a8a0}{do\+\_\+render}} (\mbox{\hyperlink{class_iwa___particle}{Iwa\+\_\+\+Particle}} $\ast$part, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ part\+\_\+ports, std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$ porttiles, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&p\+\_\+size, \mbox{\hyperlink{class_t_point_t}{TPointD}} \&p\+\_\+offset, int lastframe, std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$ part\+Level, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, float opacity\+\_\+range, int curr\+\_\+frame, std\+::map$<$ std\+::pair$<$ int, int $>$, float $>$ \&part\+Scales, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$base\+Img\+Tile)
\item 
bool \mbox{\hyperlink{class_iwa___particles___engine_a207029f17f0782312898b862b3457830}{port\+\_\+is\+\_\+used}} (int i, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a7838ef3ad00e160065f8a1c379985c3e}{fill\+\_\+single\+\_\+region}} (std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ \&myregions, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, int thres, bool do\+\_\+source\+\_\+gradation, QList$<$ QList$<$ int $>$ $>$ \&my\+Histogram, QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&particle\+Origins)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a9347cf024c68197dc31ae7b941c43d69}{fill\+\_\+subregions}} (int cont\+\_\+index, std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, int thres)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a0e9c35ba4d075060740ab334393d8e7d}{normalize\+\_\+array}} (std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&myregions, \mbox{\hyperlink{class_t_point_t}{TPointD}} pos, int lx, int ly, int regioncounter, std\+::vector$<$ int $>$ \&myarray, std\+::vector$<$ int $>$ \&lista, std\+::vector$<$ int $>$ \&listb, std\+::vector$<$ int $>$ \&final)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a0701cb754e053a291ed9dc168c517b1b}{fill\+\_\+array}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ctrl1, int \&regioncount, std\+::vector$<$ int $>$ \&myarray, std\+::vector$<$ int $>$ \&lista, std\+::vector$<$ int $>$ \&listb, int thres)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a1fa9cc79320c7b8c6e5cb60f45caeea0}{init\+Particle\+Origins}} (\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&out\+Tile\+BBox, QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&particle\+Origins, const double frame, const \mbox{\hyperlink{class_t_affine}{TAffine}} affine, struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, int level\+\_\+n, std\+::vector$<$ int $>$ \&lastframe, double pixel\+Margin)
\item 
unsigned char \mbox{\hyperlink{class_iwa___particles___engine_af14be8ae622e83cbf950d60b9030317a}{get\+Init\+Source\+Frame}} (const \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&values, int first, int last)
\item 
void \mbox{\hyperlink{class_iwa___particles___engine_a4f655c139bcd2b581b560d2f2ce396d6}{render\+Background}} (\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$tile, QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&origins, std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$ part\+\_\+ports, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&ri, std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$ part\+Level, std\+::map$<$ std\+::pair$<$ int, int $>$, float $>$ \&part\+Scales, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$base\+Img\+Tile)
\end{DoxyCompactItemize}
\doxysubsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_iwa___tiled_particles_fx}{Iwa\+\_\+\+Tiled\+Particles\+Fx}} $\ast$ \mbox{\hyperlink{class_iwa___particles___engine_a18b67b6aae45192dd848f999166db708}{m\+\_\+parent}}
\item 
double \mbox{\hyperlink{class_iwa___particles___engine_a43b7302085e3306caab8549957a40227}{m\+\_\+frame}}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_iwa___particles___engine_ad9c08a302d0c763aaf6680e45d723443}\label{class_iwa___particles___engine_ad9c08a302d0c763aaf6680e45d723443}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{Iwa\_Particles\_Engine()}{Iwa\_Particles\_Engine()}}
{\footnotesize\ttfamily Iwa\+\_\+\+Particles\+\_\+\+Engine\+::\+Iwa\+\_\+\+Particles\+\_\+\+Engine (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_iwa___tiled_particles_fx}{Iwa\+\_\+\+Tiled\+Particles\+Fx}} $\ast$}]{parent,  }\item[{double}]{frame }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00048     : m\_parent(parent), m\_frame(frame) \{\}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_acbba862d0f70c0f6e74368c42a41207e}\label{class_iwa___particles___engine_acbba862d0f70c0f6e74368c42a41207e}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!````~Iwa\_Particles\_Engine@{$\sim$Iwa\_Particles\_Engine}}
\index{````~Iwa\_Particles\_Engine@{$\sim$Iwa\_Particles\_Engine}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{$\sim$Iwa\_Particles\_Engine()}{~Iwa\_Particles\_Engine()}}
{\footnotesize\ttfamily Iwa\+\_\+\+Particles\+\_\+\+Engine\+::$\sim$\+Iwa\+\_\+\+Particles\+\_\+\+Engine (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00059 \{\};}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_iwa___particles___engine_a2924ee9a714c52f031b8dd467458a8a0}\label{class_iwa___particles___engine_a2924ee9a714c52f031b8dd467458a8a0}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!do\_render@{do\_render}}
\index{do\_render@{do\_render}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{do\_render()}{do\_render()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::do\+\_\+render (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_iwa___particle}{Iwa\+\_\+\+Particle}} $\ast$}]{part,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{part\+\_\+ports,  }\item[{std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$}]{porttiles,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&}]{p\+\_\+size,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{p\+\_\+offset,  }\item[{int}]{lastframe,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$}]{part\+Level,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{float}]{opacity\+\_\+range,  }\item[{int}]{curr\+\_\+frame,  }\item[{std\+::map$<$ std\+::pair$<$ int, int $>$, float $>$ \&}]{part\+Scales,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{base\+Img\+Tile }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00877                                                                       \{}
\DoxyCodeLine{00878   \textcolor{comment}{/*-\/ カメラに対してタテになっている粒子を描かずに飛ばす -\/*/}}
\DoxyCodeLine{00879   \textcolor{keywordflow}{if} (std::abs(cosf(part-\/>flap\_phi * 3.14159f / 180.0f)) < 0.03f) \{}
\DoxyCodeLine{00880     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00881   \}}
\DoxyCodeLine{00882   \textcolor{comment}{// Retrieve the particle frame -\/ that is, the *column frame* from which we are}}
\DoxyCodeLine{00883   \textcolor{comment}{// picking}}
\DoxyCodeLine{00884   \textcolor{comment}{// the particle to be rendered.}}
\DoxyCodeLine{00885   \textcolor{keywordtype}{int} ndx = part-\/>frame \% lastframe;}
\DoxyCodeLine{00886 }
\DoxyCodeLine{00887   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} tileRas(tile-\/>getRaster());}
\DoxyCodeLine{00888 }
\DoxyCodeLine{00889   std::string levelid;}
\DoxyCodeLine{00890   \textcolor{keywordtype}{double} aim\_angle = 0;}
\DoxyCodeLine{00891   \textcolor{keywordflow}{if} (values.pathaim\_val) \{}
\DoxyCodeLine{00892     \textcolor{keywordtype}{float} arctan = atan2f(part-\/>vy, part-\/>vx);}
\DoxyCodeLine{00893     aim\_angle    = arctan * M\_180\_PI;}
\DoxyCodeLine{00894   \}}
\DoxyCodeLine{00895 }
\DoxyCodeLine{00896   \textcolor{comment}{/*-\/ 粒子の回転、スケールをアフィン行列に入れる -\/*/}}
\DoxyCodeLine{00897   \textcolor{comment}{// Calculate the rotational and scale components we have to apply on the}}
\DoxyCodeLine{00898   \textcolor{comment}{// particle}}
\DoxyCodeLine{00899   \mbox{\hyperlink{class_t_rotation}{TRotation}} rotM(part-\/>angle + aim\_angle);}
\DoxyCodeLine{00900   \mbox{\hyperlink{class_t_scale}{TScale}} scaleM(part-\/>scale);}
\DoxyCodeLine{00901 }
\DoxyCodeLine{00902   \textcolor{comment}{/*-\/ ひらひら -\/*/}}
\DoxyCodeLine{00903   \mbox{\hyperlink{class_t_affine}{TAffine}} testAff;}
\DoxyCodeLine{00904   \textcolor{keywordtype}{float} illuminant;}
\DoxyCodeLine{00905   \{}
\DoxyCodeLine{00906     \textcolor{keywordtype}{float} theta = part-\/>flap\_theta * 3.14159f / 180.0f;}
\DoxyCodeLine{00907     \textcolor{keywordtype}{float} phi   = part-\/>flap\_phi * 3.14159f / 180.0f;}
\DoxyCodeLine{00908     \textcolor{keywordtype}{float} cosT  = cosf(theta);}
\DoxyCodeLine{00909     \textcolor{keywordtype}{float} sinT  = sinf(theta);}
\DoxyCodeLine{00910     \textcolor{keywordtype}{float} k     = 1.0f -\/ cosf(phi);}
\DoxyCodeLine{00911 }
\DoxyCodeLine{00912     testAff.a11 = 1.0f -\/ k * cosT * cosT;}
\DoxyCodeLine{00913     testAff.a21 = -\/k * cosT * sinT;}
\DoxyCodeLine{00914     testAff.a12 = -\/k * cosT * sinT;}
\DoxyCodeLine{00915     testAff.a22 = 1.0f -\/ k * sinT * sinT;}
\DoxyCodeLine{00916 }
\DoxyCodeLine{00917     \textcolor{comment}{/*-\/ ここで、照明モードのとき、その明るさを計算する -\/*/}}
\DoxyCodeLine{00918     \textcolor{keywordflow}{if} (values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_ILLUMINATED) \{}
\DoxyCodeLine{00919       \textcolor{keywordtype}{float} liTheta  = values.iw\_light\_theta\_val;}
\DoxyCodeLine{00920       \textcolor{keywordtype}{float} liPhi    = values.iw\_light\_phi\_val;}
\DoxyCodeLine{00921       \mbox{\hyperlink{structfloat3}{float3}} normVec = \{sinf(theta) * sinf(phi), cosf(theta) * sinf(phi),}
\DoxyCodeLine{00922                         cosf(phi)\};}
\DoxyCodeLine{00923       \mbox{\hyperlink{structfloat3}{float3}} lightVec = \{sinf(liTheta) * sinf(liPhi),}
\DoxyCodeLine{00924                          cosf(liTheta) * sinf(liPhi), cosf(liPhi)\};}
\DoxyCodeLine{00925       \textcolor{comment}{/*-\/ 法線ベクトルと光源ベクトルの内積の絶対値 -\/*/}}
\DoxyCodeLine{00926       illuminant = std::abs(normVec.x * lightVec.x + normVec.y * lightVec.y +}
\DoxyCodeLine{00927                             normVec.z * lightVec.z);}
\DoxyCodeLine{00928     \}}
\DoxyCodeLine{00929   \}}
\DoxyCodeLine{00930 }
\DoxyCodeLine{00931   \mbox{\hyperlink{class_t_affine}{TAffine}} M(rotM * scaleM * testAff);}
\DoxyCodeLine{00932 }
\DoxyCodeLine{00933   \textcolor{comment}{// Particles deal with dpi affines on their own}}
\DoxyCodeLine{00934   \mbox{\hyperlink{class_t_affine}{TAffine}} scaleAff(m\_parent-\/>handledAffine(ri, m\_frame));}
\DoxyCodeLine{00935   \textcolor{keywordtype}{float} partScale =}
\DoxyCodeLine{00936       scaleAff.a11 * partScales[std::pair<int, int>(part-\/>level, ndx)];}
\DoxyCodeLine{00937   \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}} partResolution(0, 0);}
\DoxyCodeLine{00938   \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riNew(ri);}
\DoxyCodeLine{00939 }
\DoxyCodeLine{00940   \textcolor{comment}{// Retrieve the bounding box in the standard reference}}
\DoxyCodeLine{00941   \mbox{\hyperlink{class_t_rect_t}{TRectD}} bbox(-\/5.0, -\/5.0, 5.0, 5.0), standardRefBBox;}
\DoxyCodeLine{00942   \textcolor{keywordflow}{if} (part-\/>level <}
\DoxyCodeLine{00943           (\textcolor{keywordtype}{int})part\_ports.size() \&\&  \textcolor{comment}{// Not the default levelless cases}}
\DoxyCodeLine{00944       part\_ports[part-\/>level]-\/>isConnected()) \{}
\DoxyCodeLine{00945     \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riIdentity(ri);}
\DoxyCodeLine{00946     riIdentity.m\_affine = \mbox{\hyperlink{class_t_affine}{TAffine}}();}
\DoxyCodeLine{00947 }
\DoxyCodeLine{00948     (*part\_ports[part-\/>level])-\/>getBBox(ndx, bbox, riIdentity);}
\DoxyCodeLine{00949 }
\DoxyCodeLine{00950     \textcolor{comment}{// A particle's bbox MUST be finite. Gradients and such which have an}}
\DoxyCodeLine{00951     \textcolor{comment}{// infinite bbox}}
\DoxyCodeLine{00952     \textcolor{comment}{// are just NOT rendered.}}
\DoxyCodeLine{00953 }
\DoxyCodeLine{00954     \textcolor{comment}{// NOTE: No fx returns half-\/planes or similar (ie if any coordinate is}}
\DoxyCodeLine{00955     \textcolor{comment}{// either}}
\DoxyCodeLine{00956     \textcolor{comment}{// (std::numeric\_limits<double>::max)() or its opposite, then the rect IS}}
\DoxyCodeLine{00957     \textcolor{comment}{// THE infiniteRectD)}}
\DoxyCodeLine{00958     \textcolor{keywordflow}{if} (bbox == TConsts::infiniteRectD) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00959   \}}
\DoxyCodeLine{00960 }
\DoxyCodeLine{00961   \textcolor{comment}{// Now, these are the particle rendering specifications}}
\DoxyCodeLine{00962   bbox            = bbox.enlarge(3);}
\DoxyCodeLine{00963   standardRefBBox = bbox;}
\DoxyCodeLine{00964   riNew.m\_affine  = \mbox{\hyperlink{class_t_scale}{TScale}}(partScale);}
\DoxyCodeLine{00965   bbox            = riNew.m\_affine * bbox;}
\DoxyCodeLine{00966   \textcolor{comment}{/*-\/ 縮小済みのParticleのサイズ -\/*/}}
\DoxyCodeLine{00967   partResolution = \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tceil(bbox.getLx()), tceil(bbox.getLy()));}
\DoxyCodeLine{00968 }
\DoxyCodeLine{00969   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} ras;}
\DoxyCodeLine{00970 }
\DoxyCodeLine{00971   std::string alias;}
\DoxyCodeLine{00972   \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg;}
\DoxyCodeLine{00973   rimg = partLevel[part-\/>level]-\/>frame(ndx);}
\DoxyCodeLine{00974   \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00975     ras = rimg-\/>getRaster();}
\DoxyCodeLine{00976   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00977     alias = \textcolor{stringliteral}{"{}PART: "{}} + (*part\_ports[part-\/>level])-\/>getAlias(ndx, riNew);}
\DoxyCodeLine{00978     rimg  = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{00979     \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00980       ras = rimg-\/>getRaster();}
\DoxyCodeLine{00981 }
\DoxyCodeLine{00982       \textcolor{comment}{// Check that the raster resolution is sufficient for our purposes}}
\DoxyCodeLine{00983       \textcolor{keywordflow}{if} (ras-\/>getLx() < partResolution.lx || ras-\/>getLy() < partResolution.ly)}
\DoxyCodeLine{00984         ras = 0;}
\DoxyCodeLine{00985       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00986         partResolution = \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(ras-\/>getLx(), ras-\/>getLy());}
\DoxyCodeLine{00987     \}}
\DoxyCodeLine{00988   \}}
\DoxyCodeLine{00989 }
\DoxyCodeLine{00990   \textcolor{comment}{// We are interested in making the relation between scale and (integer)}}
\DoxyCodeLine{00991   \textcolor{comment}{// resolution}}
\DoxyCodeLine{00992   \textcolor{comment}{// bijective -\/ since we shall cache by using resolution as a partial}}
\DoxyCodeLine{00993   \textcolor{comment}{// identification parameter.}}
\DoxyCodeLine{00994   \textcolor{comment}{// Therefore, we find the current bbox Lx and take a unique scale out of it.}}
\DoxyCodeLine{00995   partScale      = partResolution.lx / standardRefBBox.getLx();}
\DoxyCodeLine{00996   riNew.m\_affine = \mbox{\hyperlink{class_t_scale}{TScale}}(partScale);}
\DoxyCodeLine{00997   bbox           = riNew.m\_affine * standardRefBBox;}
\DoxyCodeLine{00998 }
\DoxyCodeLine{00999   \textcolor{comment}{// If no image was retrieved from the cache (or it was not scaled enough),}}
\DoxyCodeLine{01000   \textcolor{comment}{// calculate it}}
\DoxyCodeLine{01001   \textcolor{keywordflow}{if} (!ras) \{}
\DoxyCodeLine{01002     \mbox{\hyperlink{class_t_tile}{TTile}} auxTile;}
\DoxyCodeLine{01003     (*part\_ports[part-\/>level])}
\DoxyCodeLine{01004         -\/>allocateAndCompute(auxTile, bbox.getP00(),}
\DoxyCodeLine{01005                              \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(partResolution.lx, partResolution.ly),}
\DoxyCodeLine{01006                              tile-\/>getRaster(), ndx, riNew);}
\DoxyCodeLine{01007     ras = auxTile.getRaster();}
\DoxyCodeLine{01008 }
\DoxyCodeLine{01009     \textcolor{comment}{// Finally, cache the particle}}
\DoxyCodeLine{01010     addRenderCache(alias, \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}}(ras));}
\DoxyCodeLine{01011   \}}
\DoxyCodeLine{01012 }
\DoxyCodeLine{01013   \textcolor{keywordflow}{if} (!ras) \textcolor{keywordflow}{return};  \textcolor{comment}{// At this point, it should never happen anyway...}}
\DoxyCodeLine{01014 }
\DoxyCodeLine{01015   \textcolor{comment}{// Deal with particle colors/opacity}}
\DoxyCodeLine{01016   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} rfinalpart;}
\DoxyCodeLine{01017   \textcolor{comment}{// TRaster32P rfinalpart;}}
\DoxyCodeLine{01018   \textcolor{keywordtype}{double} curr\_opacity =}
\DoxyCodeLine{01019       part-\/>set\_Opacity(porttiles, values, opacity\_range, dist\_frame);}
\DoxyCodeLine{01020   \textcolor{keywordflow}{if} (curr\_opacity != 1.0 || part-\/>gencol.fadecol || part-\/>fincol.fadecol ||}
\DoxyCodeLine{01021       part-\/>foutcol.fadecol) \{}
\DoxyCodeLine{01022     \textcolor{keywordflow}{if} (values.pick\_color\_for\_every\_frame\_val \&\& values.gencol\_ctrl\_val \&\&}
\DoxyCodeLine{01023         (porttiles.find(values.gencol\_ctrl\_val) != porttiles.end()))}
\DoxyCodeLine{01024       part-\/>get\_image\_reference(porttiles[values.gencol\_ctrl\_val], values,}
\DoxyCodeLine{01025                                 part-\/>gencol.col);}
\DoxyCodeLine{01026 }
\DoxyCodeLine{01027     rfinalpart = ras-\/>clone();}
\DoxyCodeLine{01028     part-\/>modify\_colors\_and\_opacity(values, curr\_opacity, dist\_frame,}
\DoxyCodeLine{01029                                     rfinalpart);}
\DoxyCodeLine{01030   \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{01031     rfinalpart = ras;}
\DoxyCodeLine{01032 }
\DoxyCodeLine{01033   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} rfinalpart2;}
\DoxyCodeLine{01034   \textcolor{comment}{/*-\/ 照明モードのとき、その明るさを色に格納 -\/*/}}
\DoxyCodeLine{01035   \textcolor{keywordflow}{if} (values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_ILLUMINATED) \{}
\DoxyCodeLine{01036     rfinalpart2 = rfinalpart-\/>clone();}
\DoxyCodeLine{01037     part-\/>set\_illuminated\_colors(illuminant, rfinalpart2);}
\DoxyCodeLine{01038   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (baseImgTile-\/>getRaster() \&\& !baseImgTile-\/>getRaster()-\/>isEmpty()) \{}
\DoxyCodeLine{01039     rfinalpart2 = rfinalpart-\/>clone();}
\DoxyCodeLine{01040     \textcolor{comment}{/*-\/ サイズが小さい場合は、単に色を拾う -\/*/}}
\DoxyCodeLine{01041     \textcolor{keywordflow}{if} (partResolution.lx <= 4.0 \&\& partResolution.ly <= 4.0)}
\DoxyCodeLine{01042       part-\/>get\_base\_image\_color(baseImgTile, values, rfinalpart2, bbox, ri);}
\DoxyCodeLine{01043     \textcolor{keywordflow}{else}}
\DoxyCodeLine{01044       part-\/>get\_base\_image\_texture(baseImgTile, values, rfinalpart2, bbox, ri);}
\DoxyCodeLine{01045   \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{01046     rfinalpart2 = rfinalpart;}
\DoxyCodeLine{01047 }
\DoxyCodeLine{01048   \textcolor{comment}{// Now, let's build the particle transform before it is overed on the output}}
\DoxyCodeLine{01049   \textcolor{comment}{// tile}}
\DoxyCodeLine{01050 }
\DoxyCodeLine{01051   \textcolor{comment}{// First, complete the transform by adding the rotational and scale}}
\DoxyCodeLine{01052   \textcolor{comment}{// components from}}
\DoxyCodeLine{01053   \textcolor{comment}{// Particles parameters}}
\DoxyCodeLine{01054   M = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}} * M * \mbox{\hyperlink{class_t_scale}{TScale}}(1.0 / partScale);}
\DoxyCodeLine{01055 }
\DoxyCodeLine{01056   \textcolor{comment}{// Then, retrieve the particle position in current reference.}}
\DoxyCodeLine{01057   \mbox{\hyperlink{class_t_point_t}{TPointD}} pos(part-\/>x, part-\/>y);}
\DoxyCodeLine{01058   pos = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}} * pos;}
\DoxyCodeLine{01059 }
\DoxyCodeLine{01060   \textcolor{comment}{// Finally, add the translational component to the particle}}
\DoxyCodeLine{01061   \textcolor{comment}{// NOTE: p\_offset is added to account for the particle relative position}}
\DoxyCodeLine{01062   \textcolor{comment}{// inside its level's bbox}}
\DoxyCodeLine{01063   M = \mbox{\hyperlink{class_t_translation}{TTranslation}}(pos -\/ tile-\/>m\_pos) * M * \mbox{\hyperlink{class_t_translation}{TTranslation}}(bbox.getP00());}
\DoxyCodeLine{01064 }
\DoxyCodeLine{01065   \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} myras32 = tile-\/>getRaster())}
\DoxyCodeLine{01066     \mbox{\hyperlink{namespace_t_rop_ae5fd1fb0c2f625e1da14fe92ae0e5122}{TRop::over}}(tileRas, rfinalpart2, M);}
\DoxyCodeLine{01067   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} myras64 = tile-\/>getRaster())}
\DoxyCodeLine{01068     \mbox{\hyperlink{namespace_t_rop_ae5fd1fb0c2f625e1da14fe92ae0e5122}{TRop::over}}(tileRas, rfinalpart2, M);}
\DoxyCodeLine{01069   \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01070     \textcolor{keywordflow}{throw} \mbox{\hyperlink{class_t_exception}{TException}}(\textcolor{stringliteral}{"{}ParticlesFx: unsupported Pixel Type"{}});}
\DoxyCodeLine{01071   \}}
\DoxyCodeLine{01072 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a0701cb754e053a291ed9dc168c517b1b}\label{class_iwa___particles___engine_a0701cb754e053a291ed9dc168c517b1b}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!fill\_array@{fill\_array}}
\index{fill\_array@{fill\_array}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_array()}{fill\_array()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::fill\+\_\+array (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{int \&}]{regioncount,  }\item[{std\+::vector$<$ int $>$ \&}]{myarray,  }\item[{std\+::vector$<$ int $>$ \&}]{lista,  }\item[{std\+::vector$<$ int $>$ \&}]{listb,  }\item[{int}]{thres }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01082                                           \{}
\DoxyCodeLine{01083   \textcolor{keywordtype}{int} pr = 0;}
\DoxyCodeLine{01084   \textcolor{keywordtype}{int} i, j;}
\DoxyCodeLine{01085   \textcolor{keywordtype}{int} lx, ly;}
\DoxyCodeLine{01086   lx = ctrl1-\/>getRaster()-\/>getLx();}
\DoxyCodeLine{01087   ly = ctrl1-\/>getRaster()-\/>getLy();}
\DoxyCodeLine{01088 }
\DoxyCodeLine{01089   \textcolor{comment}{/*prima riga*/}}
\DoxyCodeLine{01090   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} raster32 = ctrl1-\/>getRaster();}
\DoxyCodeLine{01091   raster32-\/>lock();}
\DoxyCodeLine{01092   TPixel32 *pix = raster32-\/>pixels(0);}
\DoxyCodeLine{01093   \textcolor{keywordflow}{for} (i = 0; i < lx; i++) \{}
\DoxyCodeLine{01094     \textcolor{keywordflow}{if} (pix-\/>m > threshold) \{}
\DoxyCodeLine{01095       pr++;}
\DoxyCodeLine{01096       \textcolor{keywordflow}{if} (!i) \{}
\DoxyCodeLine{01097         (regioncount)++;}
\DoxyCodeLine{01098         myarray[i] = (regioncount);}
\DoxyCodeLine{01099       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01100         \textcolor{keywordflow}{if} (myarray[i -\/ 1]) myarray[i] = myarray[i -\/ 1];}
\DoxyCodeLine{01101       \}}
\DoxyCodeLine{01102     \}}
\DoxyCodeLine{01103     pix++;}
\DoxyCodeLine{01104   \}}
\DoxyCodeLine{01105 }
\DoxyCodeLine{01106   \textcolor{keywordflow}{for} (j = 1; j < ly; j++) \{}
\DoxyCodeLine{01107     \textcolor{keywordflow}{for} (i = 0, pix = raster32-\/>pixels(j); i < lx; i++, pix++) \{}
\DoxyCodeLine{01108       \textcolor{comment}{/*TMSG\_INFO("{}j=\%d i=\%d\(\backslash\)n"{}, j, i);*/}}
\DoxyCodeLine{01109       \textcolor{keywordflow}{if} (pix-\/>m > threshold) \{}
\DoxyCodeLine{01110         std::vector<int> mask(4);}
\DoxyCodeLine{01111         pr++;}
\DoxyCodeLine{01112         \textcolor{comment}{/* l,ul,u,ur;*/}}
\DoxyCodeLine{01113         \textcolor{keywordflow}{if} (i) \{}
\DoxyCodeLine{01114           mask[0] = myarray[i -\/ 1 + lx * j];}
\DoxyCodeLine{01115           mask[1] = myarray[i -\/ 1 + lx * (j -\/ 1)];}
\DoxyCodeLine{01116         \}}
\DoxyCodeLine{01117         \textcolor{keywordflow}{if} (i != lx -\/ 1) mask[3] = myarray[i + 1 + lx * (j -\/ 1)];}
\DoxyCodeLine{01118         mask[2]                  = myarray[i + lx * (j -\/ 1)];}
\DoxyCodeLine{01119         \textcolor{keywordflow}{if} (!mask[0] \&\& !mask[1] \&\& !mask[2] \&\& !mask[3]) \{}
\DoxyCodeLine{01120           (regioncount)++;}
\DoxyCodeLine{01121           myarray[i + lx * j] = (regioncount);}
\DoxyCodeLine{01122         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01123           \textcolor{keywordtype}{int} mc, firsttime = 1;}
\DoxyCodeLine{01124           \textcolor{keywordflow}{for} (mc = 0; mc < 4; mc++) \{}
\DoxyCodeLine{01125             \textcolor{keywordflow}{if} (mask[mc]) \{}
\DoxyCodeLine{01126               \textcolor{keywordflow}{if} (firsttime) \{}
\DoxyCodeLine{01127                 myarray[i + lx * j] = mask[mc];}
\DoxyCodeLine{01128                 firsttime           = 0;}
\DoxyCodeLine{01129               \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01130                 \textcolor{keywordflow}{if} (myarray[i + lx * j] != mask[mc]) \{}
\DoxyCodeLine{01131                   lista.push\_back(myarray[i + lx * j]);}
\DoxyCodeLine{01132                   listb.push\_back(mask[mc]);}
\DoxyCodeLine{01133 }
\DoxyCodeLine{01134                   \textcolor{comment}{/*TMSG\_INFO("{}j=\%d i=\%d mc=\%d, mask=\%d\(\backslash\)n"{}, j, i, mc,}}
\DoxyCodeLine{01135 \textcolor{comment}{                   * mask[mc]);*/}}
\DoxyCodeLine{01136                 \}}
\DoxyCodeLine{01137               \}}
\DoxyCodeLine{01138             \}}
\DoxyCodeLine{01139           \}}
\DoxyCodeLine{01140         \}}
\DoxyCodeLine{01141       \}}
\DoxyCodeLine{01142     \}}
\DoxyCodeLine{01143   \}}
\DoxyCodeLine{01144   raster32-\/>unlock();}
\DoxyCodeLine{01145 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a3e6efcd77d68706c45f3540d6347eb47}\label{class_iwa___particles___engine_a3e6efcd77d68706c45f3540d6347eb47}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!fill\_range\_struct@{fill\_range\_struct}}
\index{fill\_range\_struct@{fill\_range\_struct}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_range\_struct()}{fill\_range\_struct()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::fill\+\_\+range\+\_\+struct (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{struct \mbox{\hyperlink{structparticles__ranges}{particles\+\_\+ranges}} \&}]{ranges }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00159                                                                               \{}
\DoxyCodeLine{00160   ranges.swing\_range = values.swing\_val.second -\/ values.swing\_val.first;}
\DoxyCodeLine{00161   ranges.rotswing\_range =}
\DoxyCodeLine{00162       values.rotswing\_val.second -\/ values.rotswing\_val.first;}
\DoxyCodeLine{00163   ranges.randomx\_range = values.randomx\_val.second -\/ values.randomx\_val.first;}
\DoxyCodeLine{00164   ranges.randomy\_range = values.randomy\_val.second -\/ values.randomy\_val.first;}
\DoxyCodeLine{00165   ranges.rotsca\_range  = values.rotsca\_val.second -\/ values.rotsca\_val.first;}
\DoxyCodeLine{00166   ranges.rot\_range     = values.rot\_val.second -\/ values.rot\_val.first;}
\DoxyCodeLine{00167   ranges.speed\_range   = values.speed\_val.second -\/ values.speed\_val.first;}
\DoxyCodeLine{00168   ranges.speeda\_range  = values.speeda\_val.second -\/ values.speeda\_val.first;}
\DoxyCodeLine{00169   ranges.mass\_range    = values.mass\_val.second -\/ values.mass\_val.first;}
\DoxyCodeLine{00170   ranges.scale\_range   = values.scale\_val.second -\/ values.scale\_val.first;}
\DoxyCodeLine{00171   ranges.lifetime\_range =}
\DoxyCodeLine{00172       values.lifetime\_val.second -\/ values.lifetime\_val.first;}
\DoxyCodeLine{00173   ranges.scalestep\_range =}
\DoxyCodeLine{00174       values.scalestep\_val.second -\/ values.scalestep\_val.first;}
\DoxyCodeLine{00175   ranges.trail\_range = (int)(values.trail\_val.second -\/ values.trail\_val.first);}
\DoxyCodeLine{00176 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a7838ef3ad00e160065f8a1c379985c3e}\label{class_iwa___particles___engine_a7838ef3ad00e160065f8a1c379985c3e}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!fill\_single\_region@{fill\_single\_region}}
\index{fill\_single\_region@{fill\_single\_region}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_single\_region()}{fill\_single\_region()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::fill\+\_\+single\+\_\+region (\begin{DoxyParamCaption}\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{int}]{thres,  }\item[{bool}]{do\+\_\+source\+\_\+gradation,  }\item[{QList$<$ QList$<$ int $>$ $>$ \&}]{my\+Histogram,  }\item[{QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&}]{particle\+Origins }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01244                                             \{}
\DoxyCodeLine{01245   assert(ctrl1-\/>getRaster());}
\DoxyCodeLine{01246 }
\DoxyCodeLine{01247   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} raster32(ctrl1-\/>getRaster()-\/>getSize());}
\DoxyCodeLine{01248   \mbox{\hyperlink{namespace_t_rop_a45a08fb48dd7d33ec629d722081d55c6}{TRop::convert}}(raster32, ctrl1-\/>getRaster());}
\DoxyCodeLine{01249   assert(raster32);  \textcolor{comment}{// per ora gestisco solo i Raster32}}
\DoxyCodeLine{01250 }
\DoxyCodeLine{01251   myregions.clear();}
\DoxyCodeLine{01252 }
\DoxyCodeLine{01253   raster32-\/>lock();}
\DoxyCodeLine{01254 }
\DoxyCodeLine{01255   \textcolor{comment}{/*-\/ 初期化 -\/*/}}
\DoxyCodeLine{01256   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 256; i++) \{}
\DoxyCodeLine{01257     QList<int> tmpVec;}
\DoxyCodeLine{01258     myHistogram.push\_back(tmpVec);}
\DoxyCodeLine{01259   \}}
\DoxyCodeLine{01260 }
\DoxyCodeLine{01261   \textcolor{keywordflow}{if} (!do\_source\_gradation) \textcolor{comment}{/*-\/ 1階調の場合 -\/*/}}
\DoxyCodeLine{01262   \{}
\DoxyCodeLine{01263     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} po = 0; po < particleOrigins.size(); po++) \{}
\DoxyCodeLine{01264       \textcolor{keywordtype}{int} index\_x = (int)particleOrigins.at(po).pixPos[0];}
\DoxyCodeLine{01265       \textcolor{keywordtype}{int} index\_y = (int)particleOrigins.at(po).pixPos[1];}
\DoxyCodeLine{01266       \textcolor{keywordflow}{if} (index\_x < 0)}
\DoxyCodeLine{01267         index\_x = 0;}
\DoxyCodeLine{01268       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (index\_x >= raster32-\/>getLx())}
\DoxyCodeLine{01269         index\_x = raster32-\/>getLx() -\/ 1;}
\DoxyCodeLine{01270       \textcolor{keywordflow}{if} (index\_y < 0) \{}
\DoxyCodeLine{01271         index\_y = 0;}
\DoxyCodeLine{01272         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01273       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (index\_y >= raster32-\/>getLy()) \{}
\DoxyCodeLine{01274         index\_y = raster32-\/>getLy() -\/ 1;}
\DoxyCodeLine{01275         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01276       \}}
\DoxyCodeLine{01277       TPixel32 *pix = raster32-\/>pixels(index\_y);}
\DoxyCodeLine{01278       pix += index\_x;}
\DoxyCodeLine{01279       \textcolor{keywordflow}{if} (pix-\/>m > threshold) \{}
\DoxyCodeLine{01280         myHistogram[1].push\_back(po);}
\DoxyCodeLine{01281         myregions.push\_back(\mbox{\hyperlink{class_t_point_t}{TPointD}}(particleOrigins.at(po).pos[0],}
\DoxyCodeLine{01282                                     particleOrigins.at(po).pos[1]));}
\DoxyCodeLine{01283       \}}
\DoxyCodeLine{01284     \}}
\DoxyCodeLine{01285   \}}
\DoxyCodeLine{01286 }
\DoxyCodeLine{01287   \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01288     \mbox{\hyperlink{class_t_random}{TRandom}} rand = \mbox{\hyperlink{class_t_random}{TRandom}}(1);}
\DoxyCodeLine{01289 }
\DoxyCodeLine{01290     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} po = 0; po < particleOrigins.size(); po++) \{}
\DoxyCodeLine{01291       \textcolor{keywordtype}{int} index\_x = (int)particleOrigins.at(po).pixPos[0];}
\DoxyCodeLine{01292       \textcolor{keywordtype}{int} index\_y = (int)particleOrigins.at(po).pixPos[1];}
\DoxyCodeLine{01293       \textcolor{keywordflow}{if} (index\_x < 0)}
\DoxyCodeLine{01294         index\_x = 0;}
\DoxyCodeLine{01295       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (index\_x >= raster32-\/>getLx())}
\DoxyCodeLine{01296         index\_x = raster32-\/>getLx() -\/ 1;}
\DoxyCodeLine{01297       \textcolor{keywordflow}{if} (index\_y < 0)}
\DoxyCodeLine{01298         index\_y = 0;}
\DoxyCodeLine{01299       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (index\_y >= raster32-\/>getLy())}
\DoxyCodeLine{01300         index\_y = raster32-\/>getLy() -\/ 1;}
\DoxyCodeLine{01301 }
\DoxyCodeLine{01302       TPixel32 *pix = raster32-\/>pixels(index\_y);}
\DoxyCodeLine{01303       pix += index\_x;}
\DoxyCodeLine{01304       \textcolor{keywordflow}{if} (pix-\/>m > 0) \{}
\DoxyCodeLine{01305         \textcolor{comment}{/*-\/  Histogramの登録 -\/*/}}
\DoxyCodeLine{01306         myHistogram[(int)pix-\/>m].push\_back(po);}
\DoxyCodeLine{01307         myregions.push\_back(\mbox{\hyperlink{class_t_point_t}{TPointD}}(particleOrigins.at(po).pos[0],}
\DoxyCodeLine{01308                                     particleOrigins.at(po).pos[1]));}
\DoxyCodeLine{01309       \}}
\DoxyCodeLine{01310     \}}
\DoxyCodeLine{01311   \}}
\DoxyCodeLine{01312 }
\DoxyCodeLine{01313   raster32-\/>unlock();}
\DoxyCodeLine{01314 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a9347cf024c68197dc31ae7b941c43d69}\label{class_iwa___particles___engine_a9347cf024c68197dc31ae7b941c43d69}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!fill\_subregions@{fill\_subregions}}
\index{fill\_subregions@{fill\_subregions}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_subregions()}{fill\_subregions()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::fill\+\_\+subregions (\begin{DoxyParamCaption}\item[{int}]{cont\+\_\+index,  }\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{ctrl1,  }\item[{int}]{thres }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01218                \{}
\DoxyCodeLine{01219   \textcolor{keywordtype}{int} regioncounter = 0;}
\DoxyCodeLine{01220 }
\DoxyCodeLine{01221   \textcolor{keywordtype}{int} lx = ctrl1-\/>getRaster()-\/>getLx();}
\DoxyCodeLine{01222   \textcolor{keywordtype}{int} ly = ctrl1-\/>getRaster()-\/>getLy();}
\DoxyCodeLine{01223 }
\DoxyCodeLine{01224   std::vector<int> myarray(lx * ly);}
\DoxyCodeLine{01225   std::vector<int> lista;}
\DoxyCodeLine{01226   std::vector<int> listb;}
\DoxyCodeLine{01227 }
\DoxyCodeLine{01228   fill\_array(ctrl1, regioncounter, myarray, lista, listb, thres);}
\DoxyCodeLine{01229 }
\DoxyCodeLine{01230   \textcolor{keywordflow}{if} (regioncounter) \{}
\DoxyCodeLine{01231     std::vector<int> \textcolor{keyword}{final}(regioncounter + 1);}
\DoxyCodeLine{01232     normalize\_array(myregions, ctrl1-\/>m\_pos, lx, ly, regioncounter, myarray,}
\DoxyCodeLine{01233                     lista, listb, \textcolor{keyword}{final});}
\DoxyCodeLine{01234   \}}
\DoxyCodeLine{01235 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a30ef592c2470d1c4937337494bc9ed47}\label{class_iwa___particles___engine_a30ef592c2470d1c4937337494bc9ed47}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!fill\_value\_struct@{fill\_value\_struct}}
\index{fill\_value\_struct@{fill\_value\_struct}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{fill\_value\_struct()}{fill\_value\_struct()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::fill\+\_\+value\+\_\+struct (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{value,  }\item[{double}]{frame }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00053                                                            \{}
\DoxyCodeLine{00054   myvalues.source\_ctrl\_val     = m\_parent-\/>source\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00055   myvalues.bright\_thres\_val    = m\_parent-\/>bright\_thres\_val-\/>getValue();}
\DoxyCodeLine{00056   myvalues.x\_pos\_val           = m\_parent-\/>center\_val-\/>getValue(frame).x;}
\DoxyCodeLine{00057   myvalues.y\_pos\_val           = m\_parent-\/>center\_val-\/>getValue(frame).y;}
\DoxyCodeLine{00058   myvalues.length\_val          = m\_parent-\/>length\_val-\/>getValue(frame);}
\DoxyCodeLine{00059   myvalues.height\_val          = m\_parent-\/>height\_val-\/>getValue(frame);}
\DoxyCodeLine{00060   myvalues.maxnum\_val          = m\_parent-\/>maxnum\_val-\/>getValue(frame);}
\DoxyCodeLine{00061   myvalues.lifetime\_val        = m\_parent-\/>lifetime\_val-\/>getValue(frame);}
\DoxyCodeLine{00062   myvalues.lifetime\_ctrl\_val   = m\_parent-\/>lifetime\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00063   myvalues.column\_lifetime\_val = m\_parent-\/>column\_lifetime\_val-\/>getValue();}
\DoxyCodeLine{00064   myvalues.startpos\_val        = m\_parent-\/>startpos\_val-\/>getValue();}
\DoxyCodeLine{00065   myvalues.randseed\_val        = m\_parent-\/>randseed\_val-\/>getValue();}
\DoxyCodeLine{00066   myvalues.gravity\_val         = m\_parent-\/>gravity\_val-\/>getValue(frame);}
\DoxyCodeLine{00067   myvalues.g\_angle\_val         = m\_parent-\/>g\_angle\_val-\/>getValue(frame);}
\DoxyCodeLine{00068   myvalues.gravity\_ctrl\_val    = m\_parent-\/>gravity\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00069   myvalues.friction\_val        = m\_parent-\/>friction\_val-\/>getValue(frame);}
\DoxyCodeLine{00070   myvalues.friction\_ctrl\_val   = m\_parent-\/>friction\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00071   myvalues.windint\_val         = m\_parent-\/>windint\_val-\/>getValue(frame);}
\DoxyCodeLine{00072   myvalues.windangle\_val       = m\_parent-\/>windangle\_val-\/>getValue(frame);}
\DoxyCodeLine{00073   myvalues.swingmode\_val       = m\_parent-\/>swingmode\_val-\/>getValue();}
\DoxyCodeLine{00074   myvalues.randomx\_val         = m\_parent-\/>randomx\_val-\/>getValue(frame);}
\DoxyCodeLine{00075   myvalues.randomy\_val         = m\_parent-\/>randomy\_val-\/>getValue(frame);}
\DoxyCodeLine{00076   myvalues.randomx\_ctrl\_val    = m\_parent-\/>randomx\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00077   myvalues.randomy\_ctrl\_val    = m\_parent-\/>randomy\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00078   myvalues.swing\_val           = m\_parent-\/>swing\_val-\/>getValue(frame);}
\DoxyCodeLine{00079   myvalues.speed\_val           = m\_parent-\/>speed\_val-\/>getValue(frame);}
\DoxyCodeLine{00080   myvalues.speed\_ctrl\_val      = m\_parent-\/>speed\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00081   myvalues.speeda\_val          = m\_parent-\/>speeda\_val-\/>getValue(frame);}
\DoxyCodeLine{00082   myvalues.speeda\_ctrl\_val     = m\_parent-\/>speeda\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00083   myvalues.speeda\_use\_gradient\_val =}
\DoxyCodeLine{00084       m\_parent-\/>speeda\_use\_gradient\_val-\/>getValue();}
\DoxyCodeLine{00085   myvalues.speedscale\_val     = m\_parent-\/>speedscale\_val-\/>getValue();}
\DoxyCodeLine{00086   myvalues.toplayer\_val       = m\_parent-\/>toplayer\_val-\/>getValue();}
\DoxyCodeLine{00087   myvalues.mass\_val           = m\_parent-\/>mass\_val-\/>getValue(frame);}
\DoxyCodeLine{00088   myvalues.scale\_val          = m\_parent-\/>scale\_val-\/>getValue(frame);}
\DoxyCodeLine{00089   myvalues.scale\_ctrl\_val     = m\_parent-\/>scale\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00090   myvalues.scale\_ctrl\_all\_val = m\_parent-\/>scale\_ctrl\_all\_val-\/>getValue();}
\DoxyCodeLine{00091   myvalues.rot\_val            = m\_parent-\/>rot\_val-\/>getValue(frame);}
\DoxyCodeLine{00092   myvalues.rot\_ctrl\_val       = m\_parent-\/>rot\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00093   myvalues.trail\_val          = m\_parent-\/>trail\_val-\/>getValue(frame);}
\DoxyCodeLine{00094   myvalues.trailstep\_val      = m\_parent-\/>trailstep\_val-\/>getValue(frame);}
\DoxyCodeLine{00095   myvalues.rotswingmode\_val   = m\_parent-\/>rotswingmode\_val-\/>getValue();}
\DoxyCodeLine{00096   myvalues.rotspeed\_val       = m\_parent-\/>rotspeed\_val-\/>getValue(frame);}
\DoxyCodeLine{00097   myvalues.rotsca\_val         = m\_parent-\/>rotsca\_val-\/>getValue(frame);}
\DoxyCodeLine{00098   myvalues.rotswing\_val       = m\_parent-\/>rotswing\_val-\/>getValue(frame);}
\DoxyCodeLine{00099   myvalues.pathaim\_val        = m\_parent-\/>pathaim\_val-\/>getValue();}
\DoxyCodeLine{00100   myvalues.opacity\_val        = m\_parent-\/>opacity\_val-\/>getValue(frame);}
\DoxyCodeLine{00101   myvalues.opacity\_ctrl\_val   = m\_parent-\/>opacity\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00102   myvalues.trailopacity\_val   = m\_parent-\/>trailopacity\_val-\/>getValue(frame);}
\DoxyCodeLine{00103   myvalues.scalestep\_val      = m\_parent-\/>scalestep\_val-\/>getValue(frame);}
\DoxyCodeLine{00104   myvalues.scalestep\_ctrl\_val = m\_parent-\/>scalestep\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00105   myvalues.fadein\_val         = m\_parent-\/>fadein\_val-\/>getValue(frame);}
\DoxyCodeLine{00106   myvalues.fadeout\_val        = m\_parent-\/>fadeout\_val-\/>getValue(frame);}
\DoxyCodeLine{00107   myvalues.animation\_val      = m\_parent-\/>animation\_val-\/>getValue();}
\DoxyCodeLine{00108   myvalues.step\_val           = m\_parent-\/>step\_val-\/>getValue();}
\DoxyCodeLine{00109 }
\DoxyCodeLine{00110   myvalues.gencol\_val         = m\_parent-\/>gencol\_val-\/>getValue(frame);}
\DoxyCodeLine{00111   myvalues.gencol\_ctrl\_val    = m\_parent-\/>gencol\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00112   myvalues.gencol\_spread\_val  = m\_parent-\/>gencol\_spread\_val-\/>getValue(frame);}
\DoxyCodeLine{00113   myvalues.genfadecol\_val     = m\_parent-\/>genfadecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00114   myvalues.fincol\_val         = m\_parent-\/>fincol\_val-\/>getValue(frame);}
\DoxyCodeLine{00115   myvalues.fincol\_ctrl\_val    = m\_parent-\/>fincol\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00116   myvalues.fincol\_spread\_val  = m\_parent-\/>fincol\_spread\_val-\/>getValue(frame);}
\DoxyCodeLine{00117   myvalues.finrangecol\_val    = m\_parent-\/>finrangecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00118   myvalues.finfadecol\_val     = m\_parent-\/>finfadecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00119   myvalues.foutcol\_val        = m\_parent-\/>foutcol\_val-\/>getValue(frame);}
\DoxyCodeLine{00120   myvalues.foutcol\_ctrl\_val   = m\_parent-\/>foutcol\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00121   myvalues.foutcol\_spread\_val = m\_parent-\/>foutcol\_spread\_val-\/>getValue(frame);}
\DoxyCodeLine{00122   myvalues.foutrangecol\_val   = m\_parent-\/>foutrangecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00123   myvalues.foutfadecol\_val    = m\_parent-\/>foutfadecol\_val-\/>getValue(frame);}
\DoxyCodeLine{00124 }
\DoxyCodeLine{00125   myvalues.source\_gradation\_val = m\_parent-\/>source\_gradation\_val-\/>getValue();}
\DoxyCodeLine{00126   myvalues.pick\_color\_for\_every\_frame\_val =}
\DoxyCodeLine{00127       m\_parent-\/>pick\_color\_for\_every\_frame\_val-\/>getValue();}
\DoxyCodeLine{00128   \textcolor{comment}{/*-\/ 計算モード （背景＋粒子／粒子／背景／照明された粒子） -\/*/}}
\DoxyCodeLine{00129   myvalues.iw\_rendermode\_val = m\_parent-\/>iw\_rendermode\_val-\/>getValue();}
\DoxyCodeLine{00130   \textcolor{comment}{/*-\/ 粒子に貼られる絵の素材 -\/*/}}
\DoxyCodeLine{00131   myvalues.base\_ctrl\_val = m\_parent-\/>base\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00132   \textcolor{comment}{/*-\/ カールノイズ的な動きを与える -\/*/}}
\DoxyCodeLine{00133   myvalues.curl\_val        = m\_parent-\/>curl\_val-\/>getValue(frame);}
\DoxyCodeLine{00134   myvalues.curl\_ctrl\_1\_val = m\_parent-\/>curl\_ctrl\_1\_val-\/>getValue();}
\DoxyCodeLine{00135   myvalues.curl\_ctrl\_2\_val = m\_parent-\/>curl\_ctrl\_2\_val-\/>getValue();}
\DoxyCodeLine{00136   \textcolor{comment}{/*-\/ 粒子敷き詰め。粒子を正三角形で敷き詰めたときの、}}
\DoxyCodeLine{00137 \textcolor{comment}{          正三角形の一辺の長さをインチで指定する -\/*/}}
\DoxyCodeLine{00138   myvalues.iw\_triangleSize = m\_parent-\/>iw\_triangleSize-\/>getValue(frame);}
\DoxyCodeLine{00139   \textcolor{comment}{/*-\/ ひらひら回転 -\/*/}}
\DoxyCodeLine{00140   myvalues.flap\_ctrl\_val = m\_parent-\/>flap\_ctrl\_val-\/>getValue();}
\DoxyCodeLine{00141   myvalues.iw\_flap\_velocity\_val =}
\DoxyCodeLine{00142       m\_parent-\/>iw\_flap\_velocity\_val-\/>getValue(frame);}
\DoxyCodeLine{00143   myvalues.iw\_flap\_dir\_sensitivity\_val =}
\DoxyCodeLine{00144       m\_parent-\/>iw\_flap\_dir\_sensitivity\_val-\/>getValue(frame);}
\DoxyCodeLine{00145   \textcolor{comment}{/*-\/ ひらひら粒子に照明を当てる normalize\_values()内で Degree → Radian 化する}}
\DoxyCodeLine{00146 \textcolor{comment}{   * -\/*/}}
\DoxyCodeLine{00147   myvalues.iw\_light\_theta\_val = m\_parent-\/>iw\_light\_theta\_val-\/>getValue(frame);}
\DoxyCodeLine{00148   myvalues.iw\_light\_phi\_val   = m\_parent-\/>iw\_light\_phi\_val-\/>getValue(frame);}
\DoxyCodeLine{00149   \textcolor{comment}{/*-\/ 読み込みマージン -\/*/}}
\DoxyCodeLine{00150   myvalues.margin\_val = m\_parent-\/>margin\_val-\/>getValue(frame);}
\DoxyCodeLine{00151   \textcolor{comment}{/*-\/ 重力を徐々に与えるためのフレーム長 -\/*/}}
\DoxyCodeLine{00152   myvalues.iw\_gravityBufferFrame\_val =}
\DoxyCodeLine{00153       m\_parent-\/>iw\_gravityBufferFrame\_val-\/>getValue();}
\DoxyCodeLine{00154 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_af14be8ae622e83cbf950d60b9030317a}\label{class_iwa___particles___engine_af14be8ae622e83cbf950d60b9030317a}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!getInitSourceFrame@{getInitSourceFrame}}
\index{getInitSourceFrame@{getInitSourceFrame}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{getInitSourceFrame()}{getInitSourceFrame()}}
{\footnotesize\ttfamily unsigned char Iwa\+\_\+\+Particles\+\_\+\+Engine\+::get\+Init\+Source\+Frame (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{int}]{first,  }\item[{int}]{last }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01429                                                          \{}
\DoxyCodeLine{01430   \textcolor{keywordflow}{switch} (values.animation\_val) \{}
\DoxyCodeLine{01431   \textcolor{keywordflow}{case} Iwa\_TiledParticlesFx::ANIM\_CYCLE:}
\DoxyCodeLine{01432   \textcolor{keywordflow}{case} Iwa\_TiledParticlesFx::ANIM\_S\_CYCLE:}
\DoxyCodeLine{01433     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char})first;}
\DoxyCodeLine{01434 }
\DoxyCodeLine{01435   \textcolor{keywordflow}{case} Iwa\_TiledParticlesFx::ANIM\_SR\_CYCLE:}
\DoxyCodeLine{01436     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char})(first +}
\DoxyCodeLine{01437                            (values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}()) * (last -\/ first));}
\DoxyCodeLine{01438 }
\DoxyCodeLine{01439   \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01440     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char})(first +}
\DoxyCodeLine{01441                            (values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}()) * (last -\/ first));}
\DoxyCodeLine{01442   \}}
\DoxyCodeLine{01443 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a1fa9cc79320c7b8c6e5cb60f45caeea0}\label{class_iwa___particles___engine_a1fa9cc79320c7b8c6e5cb60f45caeea0}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!initParticleOrigins@{initParticleOrigins}}
\index{initParticleOrigins@{initParticleOrigins}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{initParticleOrigins()}{initParticleOrigins()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::init\+Particle\+Origins (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{out\+Tile\+BBox,  }\item[{QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&}]{particle\+Origins,  }\item[{const double}]{frame,  }\item[{const \mbox{\hyperlink{class_t_affine}{TAffine}}}]{affine,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{int}]{level\+\_\+n,  }\item[{std\+::vector$<$ int $>$ \&}]{lastframe,  }\item[{double}]{pixel\+Margin }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01329                         \{}
\DoxyCodeLine{01330   \textcolor{comment}{/*-\/ 敷き詰め三角形の一辺の長さをピクセル単位に換算する -\/*/}}
\DoxyCodeLine{01331   \mbox{\hyperlink{class_t_point_t}{TPointD}} vect(values.iw\_triangleSize, 0.0);}
\DoxyCodeLine{01332   \mbox{\hyperlink{class_t_affine}{TAffine}} aff(affine);}
\DoxyCodeLine{01333   aff.a13 = aff.a23 = 0;}
\DoxyCodeLine{01334   vect              = aff * vect;}
\DoxyCodeLine{01335   \textcolor{keywordtype}{double} triPixSize = sqrt(vect.x * vect.x + vect.y * vect.y);}
\DoxyCodeLine{01336 }
\DoxyCodeLine{01337   \textcolor{keywordtype}{double} pix2Inch = values.iw\_triangleSize / triPixSize;}
\DoxyCodeLine{01338 }
\DoxyCodeLine{01339   \textcolor{comment}{/*-\/ 横方向の移動距離 -\/*/}}
\DoxyCodeLine{01340   \textcolor{keywordtype}{double} d\_hori = values.iw\_triangleSize * 0.5;}
\DoxyCodeLine{01341   \textcolor{comment}{/*-\/ 縦方向の移動距離 -\/*/}}
\DoxyCodeLine{01342   \textcolor{keywordtype}{double} d\_vert = values.iw\_triangleSize * 0.8660254;}
\DoxyCodeLine{01343   \textcolor{comment}{/*-\/ 正三角形を横に上下交互に並べたときの、中心位置のオフセット -\/*/}}
\DoxyCodeLine{01344   \textcolor{keywordtype}{double} vOffset = values.iw\_triangleSize * 0.14433758;}
\DoxyCodeLine{01345 }
\DoxyCodeLine{01346   \textcolor{comment}{/*-\/ ピクセル位置の方も格納する -\/*/}}
\DoxyCodeLine{01347   \textcolor{keywordtype}{double} d\_hori\_pix  = triPixSize * 0.5;}
\DoxyCodeLine{01348   \textcolor{keywordtype}{double} d\_vert\_pix  = triPixSize * 0.8660254;}
\DoxyCodeLine{01349   \textcolor{keywordtype}{double} vOffset\_pix = triPixSize * 0.14433758;}
\DoxyCodeLine{01350 }
\DoxyCodeLine{01351   \mbox{\hyperlink{class_t_rect_t}{TRectD}} inchBBox(}
\DoxyCodeLine{01352       resourceTileBBox.x0 * pix2Inch, resourceTileBBox.y0 * pix2Inch,}
\DoxyCodeLine{01353       resourceTileBBox.x1 * pix2Inch, resourceTileBBox.y1 * pix2Inch);}
\DoxyCodeLine{01354   \textcolor{comment}{/*-\/ インチ位置のスタート -\/*/}}
\DoxyCodeLine{01355   \textcolor{keywordtype}{double} curr\_y = inchBBox.y0;}
\DoxyCodeLine{01356   \textcolor{comment}{/*-\/ 行の1列目のタテのオフセット値 -\/*/}}
\DoxyCodeLine{01357   \textcolor{keywordtype}{double} startOff = -\/vOffset;}
\DoxyCodeLine{01358 }
\DoxyCodeLine{01359   \textcolor{comment}{/*-\/ ピクセル位置のスタート -\/*/}}
\DoxyCodeLine{01360   \textcolor{keywordtype}{double} curr\_y\_pix   = 0.0;}
\DoxyCodeLine{01361   \textcolor{keywordtype}{double} startOff\_pix = -\/vOffset\_pix;}
\DoxyCodeLine{01362 }
\DoxyCodeLine{01363   \textcolor{comment}{/*-\/ メモリの見積もり -\/*/}}
\DoxyCodeLine{01364   \textcolor{keywordtype}{int} gridSize;}
\DoxyCodeLine{01365   \{}
\DoxyCodeLine{01366     \textcolor{keywordtype}{int} ySize = 0;}
\DoxyCodeLine{01367     \textcolor{keywordflow}{while} (curr\_y <= inchBBox.y1 + d\_vert * 0.5) \{}
\DoxyCodeLine{01368       curr\_y += d\_vert;}
\DoxyCodeLine{01369       ySize++;}
\DoxyCodeLine{01370     \}}
\DoxyCodeLine{01371     \textcolor{keywordtype}{int} xSize     = 0;}
\DoxyCodeLine{01372     \textcolor{keywordtype}{double} curr\_x = inchBBox.x0;}
\DoxyCodeLine{01373     \textcolor{keywordflow}{while} (curr\_x <= inchBBox.x1 + d\_hori * 0.5) \{}
\DoxyCodeLine{01374       curr\_x += d\_hori;}
\DoxyCodeLine{01375       xSize++;}
\DoxyCodeLine{01376     \}}
\DoxyCodeLine{01377     gridSize = xSize * ySize;}
\DoxyCodeLine{01378   \}}
\DoxyCodeLine{01379   curr\_y = inchBBox.y0;}
\DoxyCodeLine{01380   particleOrigins.reserve(gridSize);}
\DoxyCodeLine{01381 }
\DoxyCodeLine{01382   \textcolor{comment}{/*-\/ タテでループ -\/*/}}
\DoxyCodeLine{01383   \textcolor{keywordflow}{while} (curr\_y <=}
\DoxyCodeLine{01384          inchBBox.y1 +}
\DoxyCodeLine{01385              d\_vert *}
\DoxyCodeLine{01386                  0.5) \textcolor{comment}{/* ←d\_vert * 0.5 は最後の一行を敷き詰めるための追加分 -\/*/}}
\DoxyCodeLine{01387   \{}
\DoxyCodeLine{01388     \textcolor{keywordtype}{double} curr\_x = inchBBox.x0;}
\DoxyCodeLine{01389     \textcolor{keywordtype}{double} off    = startOff;}
\DoxyCodeLine{01390     \textcolor{comment}{/*-\/ 三角形が上下どっちを向いているかのフラグ -\/*/}}
\DoxyCodeLine{01391     \textcolor{keywordtype}{bool} isUp = (off < 0);}
\DoxyCodeLine{01392 }
\DoxyCodeLine{01393     \textcolor{comment}{/*-\/ ピクセル位置のスタート -\/*/}}
\DoxyCodeLine{01394     \textcolor{keywordtype}{double} curr\_x\_pix = 0.0;}
\DoxyCodeLine{01395     \textcolor{keywordtype}{double} off\_pix    = startOff\_pix;}
\DoxyCodeLine{01396 }
\DoxyCodeLine{01397     \textcolor{comment}{/*-\/ ヨコでループ -\/*/}}
\DoxyCodeLine{01398     \textcolor{keywordflow}{while} (curr\_x <= inchBBox.x1 + d\_hori * 0.5) \{}
\DoxyCodeLine{01399       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} level =}
\DoxyCodeLine{01400           (\textcolor{keywordtype}{unsigned} char)(values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * level\_n);}
\DoxyCodeLine{01401       particleOrigins.append(\mbox{\hyperlink{struct_particle_origin}{ParticleOrigin}}(}
\DoxyCodeLine{01402           curr\_x, curr\_y + off, values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}(), isUp, level,}
\DoxyCodeLine{01403           getInitSourceFrame(values, 0, lastframe[level]),}
\DoxyCodeLine{01404           (\textcolor{keywordtype}{short} int)tround(curr\_x\_pix),}
\DoxyCodeLine{01405           (\textcolor{keywordtype}{short} int)tround(curr\_y\_pix + off\_pix)));}
\DoxyCodeLine{01406 }
\DoxyCodeLine{01407       off = -\/off;}
\DoxyCodeLine{01408       curr\_x += d\_hori;}
\DoxyCodeLine{01409       isUp = !isUp;}
\DoxyCodeLine{01410 }
\DoxyCodeLine{01411       off\_pix = -\/off\_pix;}
\DoxyCodeLine{01412       curr\_x\_pix += d\_hori\_pix;}
\DoxyCodeLine{01413     \}}
\DoxyCodeLine{01414 }
\DoxyCodeLine{01415     startOff = -\/startOff;}
\DoxyCodeLine{01416     curr\_y += d\_vert;}
\DoxyCodeLine{01417 }
\DoxyCodeLine{01418     startOff\_pix = -\/startOff\_pix;}
\DoxyCodeLine{01419     curr\_y\_pix += d\_vert\_pix;}
\DoxyCodeLine{01420   \}}
\DoxyCodeLine{01421 }
\DoxyCodeLine{01422   \textcolor{comment}{/*-\/ 粒子をランダム値の大きい順に並べる -\/*/}}
\DoxyCodeLine{01423   std::sort(particleOrigins.begin(), particleOrigins.end(), potentialLessThan);}
\DoxyCodeLine{01424 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a0e9c35ba4d075060740ab334393d8e7d}\label{class_iwa___particles___engine_a0e9c35ba4d075060740ab334393d8e7d}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!normalize\_array@{normalize\_array}}
\index{normalize\_array@{normalize\_array}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{normalize\_array()}{normalize\_array()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::normalize\+\_\+array (\begin{DoxyParamCaption}\item[{std\+::vector$<$ std\+::vector$<$ \mbox{\hyperlink{class_t_point_t}{TPointD}} $>$ $>$ \&}]{myregions,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}}}]{pos,  }\item[{int}]{lx,  }\item[{int}]{ly,  }\item[{int}]{regioncounter,  }\item[{std\+::vector$<$ int $>$ \&}]{myarray,  }\item[{std\+::vector$<$ int $>$ \&}]{lista,  }\item[{std\+::vector$<$ int $>$ \&}]{listb,  }\item[{std\+::vector$<$ int $>$ \&}]{final }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01152                                                    \{}
\DoxyCodeLine{01153   \textcolor{keywordtype}{int} i, j, k, l;}
\DoxyCodeLine{01154 }
\DoxyCodeLine{01155   std::vector<int> tmp;}
\DoxyCodeLine{01156   \textcolor{keywordtype}{int} maxregioncounter = 0;}
\DoxyCodeLine{01157   \textcolor{keywordtype}{int} listsize         = (int)lista.size();}
\DoxyCodeLine{01158   \textcolor{comment}{// TMSG\_INFO("{}regioncounter \%d, eqcount=\%d\(\backslash\)n"{}, regioncounter, eqcount);}}
\DoxyCodeLine{01159   \textcolor{keywordflow}{for} (k = 1; k <= regioncounter; k++) \textcolor{keyword}{final}[k] = k;}
\DoxyCodeLine{01160 }
\DoxyCodeLine{01161   \textcolor{keywordflow}{for} (l = 0; l < listsize; l++) \{}
\DoxyCodeLine{01162     j = lista[l];}
\DoxyCodeLine{01163     \textcolor{comment}{/*TMSG\_INFO("{}j vale \%d\(\backslash\)n"{}, j);*/}}
\DoxyCodeLine{01164     \textcolor{keywordflow}{while} (\textcolor{keyword}{final}[j] != j) j = \textcolor{keyword}{final}[j];}
\DoxyCodeLine{01165     k                       = listb[l];}
\DoxyCodeLine{01166     \textcolor{comment}{/*TMSG\_INFO("{}k vale \%d\(\backslash\)n"{}, k);*/}}
\DoxyCodeLine{01167     \textcolor{keywordflow}{while} (\textcolor{keyword}{final}[k] != k) k = \textcolor{keyword}{final}[k];}
\DoxyCodeLine{01168     \textcolor{keywordflow}{if} (j != k) \textcolor{keyword}{final}[j]    = k;}
\DoxyCodeLine{01169   \}}
\DoxyCodeLine{01170   \textcolor{comment}{// TMSG\_INFO("{}esco dal for\(\backslash\)n"{});}}
\DoxyCodeLine{01171   \textcolor{keywordflow}{for} (j                                         = 1; j <= regioncounter; j++)}
\DoxyCodeLine{01172     \textcolor{keywordflow}{while} (\textcolor{keyword}{final}[j] != \textcolor{keyword}{final}[\textcolor{keyword}{final}[j]]) \textcolor{keyword}{final}[j] = \textcolor{keyword}{final}[\textcolor{keyword}{final}[j]];}
\DoxyCodeLine{01173 }
\DoxyCodeLine{01174   \textcolor{comment}{/*conto quante cavolo di regioni sono*/}}
\DoxyCodeLine{01175 }
\DoxyCodeLine{01176   tmp.push\_back(\textcolor{keyword}{final}[1]);}
\DoxyCodeLine{01177   maxregioncounter = 1;}
\DoxyCodeLine{01178   \textcolor{keywordflow}{for} (i = 2; i <= regioncounter; i++) \{}
\DoxyCodeLine{01179     \textcolor{keywordtype}{int} diff = 1;}
\DoxyCodeLine{01180     \textcolor{keywordflow}{for} (j = 0; j < maxregioncounter; j++) \{}
\DoxyCodeLine{01181       \textcolor{keywordflow}{if} (tmp[j] == \textcolor{keyword}{final}[i]) \{}
\DoxyCodeLine{01182         diff = 0;}
\DoxyCodeLine{01183         \textcolor{keywordflow}{break};}
\DoxyCodeLine{01184       \}}
\DoxyCodeLine{01185     \}}
\DoxyCodeLine{01186     \textcolor{keywordflow}{if} (diff) \{}
\DoxyCodeLine{01187       tmp.push\_back(\textcolor{keyword}{final}[i]);}
\DoxyCodeLine{01188       maxregioncounter++;}
\DoxyCodeLine{01189     \}}
\DoxyCodeLine{01190   \}}
\DoxyCodeLine{01191 }
\DoxyCodeLine{01192   myregions.resize(maxregioncounter);}
\DoxyCodeLine{01193   \textcolor{keywordflow}{for} (j = 0; j < ly; j++) \{}
\DoxyCodeLine{01194     \textcolor{keywordflow}{for} (i = 0; i < lx; i++) \{}
\DoxyCodeLine{01195       \textcolor{keywordtype}{int} tmpindex;}
\DoxyCodeLine{01196       \textcolor{keywordflow}{if} (myarray[i + lx * j]) \{}
\DoxyCodeLine{01197         tmpindex = \textcolor{keyword}{final}[myarray[i + lx * j]];}
\DoxyCodeLine{01198         \textcolor{comment}{/*TMSG\_INFO("{}tmpindex=\%d\(\backslash\)n"{}, tmpindex);*/}}
\DoxyCodeLine{01199         \textcolor{keywordflow}{for} (k = 0; k < maxregioncounter; k++) \{}
\DoxyCodeLine{01200           \textcolor{keywordflow}{if} (tmp[k] == tmpindex) \textcolor{keywordflow}{break};}
\DoxyCodeLine{01201         \}}
\DoxyCodeLine{01202         \textcolor{comment}{/*TMSG\_INFO("{}k=\%d\(\backslash\)n"{}, k);*/}}
\DoxyCodeLine{01203         \mbox{\hyperlink{class_t_point_t}{TPointD}} tmppoint;}
\DoxyCodeLine{01204         tmppoint.x = i;}
\DoxyCodeLine{01205         tmppoint.y = j;}
\DoxyCodeLine{01206         tmppoint += pos;}
\DoxyCodeLine{01207         myregions[k].push\_back(tmppoint);}
\DoxyCodeLine{01208       \}}
\DoxyCodeLine{01209     \}}
\DoxyCodeLine{01210   \}}
\DoxyCodeLine{01211 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a0dc44ec341ee6f217096797da28dc886}\label{class_iwa___particles___engine_a0dc44ec341ee6f217096797da28dc886}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!normalize\_values@{normalize\_values}}
\index{normalize\_values@{normalize\_values}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{normalize\_values()}{normalize\_values()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::normalize\+\_\+values (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00459                                                                        \{}
\DoxyCodeLine{00460   \textcolor{keywordtype}{double} dpicorr = 1;}
\DoxyCodeLine{00461   \mbox{\hyperlink{class_t_point_t}{TPointD}} pos(values.x\_pos\_val, values.y\_pos\_val);}
\DoxyCodeLine{00462 }
\DoxyCodeLine{00463   (values.x\_pos\_val)               = pos.x;}
\DoxyCodeLine{00464   (values.y\_pos\_val)               = pos.y;}
\DoxyCodeLine{00465   (values.length\_val)              = (values.length\_val) * dpicorr;}
\DoxyCodeLine{00466   (values.height\_val)              = (values.height\_val) * dpicorr;}
\DoxyCodeLine{00467   (values.gravity\_val)             = (values.gravity\_val) * dpicorr * 0.1;}
\DoxyCodeLine{00468   (values.windint\_val)             = (values.windint\_val) * dpicorr;}
\DoxyCodeLine{00469   (values.speed\_val.first)         = (values.speed\_val.first) * dpicorr;}
\DoxyCodeLine{00470   (values.speed\_val.second)        = (values.speed\_val.second) * dpicorr;}
\DoxyCodeLine{00471   (values.randomx\_val.first)       = (values.randomx\_val.first) * dpicorr;}
\DoxyCodeLine{00472   (values.randomx\_val.second)      = (values.randomx\_val.second) * dpicorr;}
\DoxyCodeLine{00473   (values.randomy\_val.first)       = (values.randomy\_val.first) * dpicorr;}
\DoxyCodeLine{00474   (values.randomy\_val.second)      = (values.randomy\_val.second) * dpicorr;}
\DoxyCodeLine{00475   (values.scale\_val.first)         = (values.scale\_val.first) * 0.01;}
\DoxyCodeLine{00476   (values.scale\_val.second)        = (values.scale\_val.second) * 0.01;}
\DoxyCodeLine{00477   (values.scalestep\_val.first)     = (values.scalestep\_val.first) * 0.01;}
\DoxyCodeLine{00478   (values.scalestep\_val.second)    = (values.scalestep\_val.second) * 0.01;}
\DoxyCodeLine{00479   (values.opacity\_val.first)       = (values.opacity\_val.first) * 0.01;}
\DoxyCodeLine{00480   (values.opacity\_val.second)      = (values.opacity\_val.second) * 0.01;}
\DoxyCodeLine{00481   (values.trailopacity\_val.first)  = (values.trailopacity\_val.first) * 0.01;}
\DoxyCodeLine{00482   (values.trailopacity\_val.second) = (values.trailopacity\_val.second) * 0.01;}
\DoxyCodeLine{00483   (values.mblur\_val)               = (values.mblur\_val) * 0.01;}
\DoxyCodeLine{00484   (values.friction\_val)            = -\/(values.friction\_val) * 0.01;}
\DoxyCodeLine{00485   (values.windangle\_val)           = (values.windangle\_val) * M\_PI\_180;}
\DoxyCodeLine{00486   (values.g\_angle\_val)             = (values.g\_angle\_val + 180) * M\_PI\_180;}
\DoxyCodeLine{00487   (values.speeda\_val.first)        = (values.speeda\_val.first) * M\_PI\_180;}
\DoxyCodeLine{00488   (values.speeda\_val.second)       = (values.speeda\_val.second) * M\_PI\_180;}
\DoxyCodeLine{00489   \textcolor{keywordflow}{if} (values.step\_val < 1) values.step\_val = 1;}
\DoxyCodeLine{00490   values.genfadecol\_val                    = (values.genfadecol\_val) * 0.01;}
\DoxyCodeLine{00491   values.finfadecol\_val                    = (values.finfadecol\_val) * 0.01;}
\DoxyCodeLine{00492   values.foutfadecol\_val                   = (values.foutfadecol\_val) * 0.01;}
\DoxyCodeLine{00493   (values.curl\_val)                        = (values.curl\_val) * dpicorr * 0.1;}
\DoxyCodeLine{00494   \textcolor{comment}{/*-\/ ひらひら粒子に照明を当てる normalize\_values()内で Degree → Radian 化する}}
\DoxyCodeLine{00495 \textcolor{comment}{   * -\/*/}}
\DoxyCodeLine{00496   (values.iw\_light\_theta\_val) = (values.iw\_light\_theta\_val) * M\_PI\_180;}
\DoxyCodeLine{00497   (values.iw\_light\_phi\_val)   = (values.iw\_light\_phi\_val) * M\_PI\_180;}
\DoxyCodeLine{00498   \textcolor{comment}{/*-\/ 読み込みマージン -\/*/}}
\DoxyCodeLine{00499   (values.margin\_val) = (values.margin\_val) * dpicorr;}
\DoxyCodeLine{00500 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a207029f17f0782312898b862b3457830}\label{class_iwa___particles___engine_a207029f17f0782312898b862b3457830}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!port\_is\_used@{port\_is\_used}}
\index{port\_is\_used@{port\_is\_used}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{port\_is\_used()}{port\_is\_used()}}
{\footnotesize\ttfamily bool Iwa\+\_\+\+Particles\+\_\+\+Engine\+::port\+\_\+is\+\_\+used (\begin{DoxyParamCaption}\item[{int}]{i,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00179                                                                          \{}
\DoxyCodeLine{00180   \textcolor{keywordflow}{return} values.fincol\_ctrl\_val == i || values.foutcol\_ctrl\_val == i ||}
\DoxyCodeLine{00181          values.friction\_ctrl\_val == i || values.gencol\_ctrl\_val == i ||}
\DoxyCodeLine{00182          values.gravity\_ctrl\_val == i || values.opacity\_ctrl\_val == i ||}
\DoxyCodeLine{00183          values.rot\_ctrl\_val == i || values.scale\_ctrl\_val == i ||}
\DoxyCodeLine{00184          values.scalestep\_ctrl\_val == i || values.source\_ctrl\_val == i ||}
\DoxyCodeLine{00185          values.speed\_ctrl\_val == i || values.speeda\_ctrl\_val == i ||}
\DoxyCodeLine{00186          values.lifetime\_ctrl\_val == i || values.randomx\_ctrl\_val == i ||}
\DoxyCodeLine{00187          values.randomy\_ctrl\_val == i || values.base\_ctrl\_val == i ||}
\DoxyCodeLine{00188          values.curl\_ctrl\_1\_val == i || values.curl\_ctrl\_2\_val == i ||}
\DoxyCodeLine{00189          values.flap\_ctrl\_val == i;}
\DoxyCodeLine{00190 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a27146e0ff733de70623ab1aebbb6bee0}\label{class_iwa___particles___engine_a27146e0ff733de70623ab1aebbb6bee0}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!render\_particles@{render\_particles}}
\index{render\_particles@{render\_particles}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{render\_particles()}{render\_particles()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::render\+\_\+particles (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{part\+\_\+ports,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&}]{p\+\_\+size,  }\item[{\mbox{\hyperlink{class_t_point_t}{TPointD}} \&}]{p\+\_\+offset,  }\item[{std\+::map$<$ int, \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{ctrl\+\_\+ports,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$}]{part\+Level,  }\item[{float}]{dpi,  }\item[{int}]{curr\+\_\+frame,  }\item[{int}]{shrink,  }\item[{double}]{startx,  }\item[{double}]{starty,  }\item[{double}]{endx,  }\item[{double}]{endy,  }\item[{std\+::vector$<$ int $>$}]{lastframe,  }\item[{unsigned long}]{fx\+Id }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00524                         \{}
\DoxyCodeLine{00525   \textcolor{comment}{/*-\/ 各種パーティクルのパラメータ -\/*/}}
\DoxyCodeLine{00526   \textcolor{keyword}{struct }\mbox{\hyperlink{structparticles__values}{particles\_values}} values;}
\DoxyCodeLine{00527   memset(\&values, 0, \textcolor{keyword}{sizeof}(values));}
\DoxyCodeLine{00528   \textcolor{comment}{/*-\/ 現在のフレームでの各パラメータを得る -\/*/}}
\DoxyCodeLine{00529   fill\_value\_struct(values, m\_frame);}
\DoxyCodeLine{00530 }
\DoxyCodeLine{00531   \textcolor{keywordtype}{int} frame, intpart = 0;}
\DoxyCodeLine{00532 }
\DoxyCodeLine{00533   \textcolor{keywordtype}{int} level\_n = part\_ports.size();}
\DoxyCodeLine{00534   \textcolor{comment}{/*-\/ 開始フレーム -\/*/}}
\DoxyCodeLine{00535   \textcolor{keywordtype}{int} startframe = (int)values.startpos\_val;}
\DoxyCodeLine{00536 }
\DoxyCodeLine{00537   \textcolor{keywordtype}{float} dpicorr = dpi * 0.01f, fractpart = 0;}
\DoxyCodeLine{00538 }
\DoxyCodeLine{00539   \textcolor{comment}{/*-\/ 不透明度の範囲（透明～不透明を 0～1 に正規化） -\/*/}}
\DoxyCodeLine{00540   \textcolor{keywordtype}{float} opacity\_range =}
\DoxyCodeLine{00541       (values.opacity\_val.second -\/ values.opacity\_val.first) * 0.01f;}
\DoxyCodeLine{00542 }
\DoxyCodeLine{00543   \textcolor{keywordtype}{bool} random\_level = \textcolor{keyword}{false};}
\DoxyCodeLine{00544 }
\DoxyCodeLine{00545   \textcolor{keywordtype}{bool} isPrecomputingEnabled = \textcolor{keyword}{false};}
\DoxyCodeLine{00546   \{}
\DoxyCodeLine{00547     \mbox{\hyperlink{class_t_renderer}{TRenderer}} renderer(\mbox{\hyperlink{class_t_renderer_a93afee3c1ce8ff2b753a05fa0fe3dc9d}{TRenderer::instance}}());}
\DoxyCodeLine{00548     isPrecomputingEnabled =}
\DoxyCodeLine{00549         (renderer \&\& renderer.isPrecomputingEnabled()) ? \textcolor{keyword}{true} : \textcolor{keyword}{false};}
\DoxyCodeLine{00550   \}}
\DoxyCodeLine{00551 }
\DoxyCodeLine{00552   \textcolor{comment}{/*-\/ シュリンクしている場合 -\/*/}}
\DoxyCodeLine{00553   \textcolor{keywordtype}{float} dpicorr\_shrinked;}
\DoxyCodeLine{00554   \textcolor{keywordflow}{if} (values.unit\_val == Iwa\_TiledParticlesFx::UNIT\_SMALL\_INCH)}
\DoxyCodeLine{00555     dpicorr\_shrinked = dpicorr / shrink;}
\DoxyCodeLine{00556   \textcolor{keywordflow}{else}}
\DoxyCodeLine{00557     dpicorr\_shrinked = dpi / shrink;}
\DoxyCodeLine{00558 }
\DoxyCodeLine{00559   std::map<std::pair<int, int>, \textcolor{keywordtype}{float}> partScales;}
\DoxyCodeLine{00560 }
\DoxyCodeLine{00561   \textcolor{comment}{/*-\/ 現在のフレームをステップ値にする -\/*/}}
\DoxyCodeLine{00562   curr\_frame = curr\_frame / values.step\_val;}
\DoxyCodeLine{00563 }
\DoxyCodeLine{00564   \mbox{\hyperlink{class_iwa___particles_manager}{Iwa\_ParticlesManager}} *pc = Iwa\_ParticlesManager::instance();}
\DoxyCodeLine{00565 }
\DoxyCodeLine{00566   \textcolor{keywordtype}{bool} isFirstFrame = !(pc-\/>isCached(fxId));}
\DoxyCodeLine{00567 }
\DoxyCodeLine{00568   \textcolor{comment}{// Retrieve the last rolled frame}}
\DoxyCodeLine{00569   \mbox{\hyperlink{struct_iwa___particles_manager_1_1_frame_data}{Iwa\_ParticlesManager::FrameData}} *particlesData = pc-\/>data(fxId);}
\DoxyCodeLine{00570 }
\DoxyCodeLine{00571   std::list<Iwa\_Particle> myParticles;}
\DoxyCodeLine{00572   \mbox{\hyperlink{class_t_random}{TRandom}} myRandom  = m\_parent-\/>randseed\_val-\/>getValue();}
\DoxyCodeLine{00573   values.random\_val = \&myRandom;}
\DoxyCodeLine{00574 }
\DoxyCodeLine{00575   \textcolor{keywordtype}{int} totalparticles = 0;}
\DoxyCodeLine{00576 }
\DoxyCodeLine{00577   \textcolor{comment}{/*-\/ 規則正しく並んだ（まだ出発していない）粒子情報 -\/*/}}
\DoxyCodeLine{00578   QList<ParticleOrigin> particleOrigins;}
\DoxyCodeLine{00579   \textcolor{comment}{/*-\/ 出力画像のバウンディングボックス -\/*/}}
\DoxyCodeLine{00580   \mbox{\hyperlink{class_t_rect_t}{TRectD}} outTileBBox(tile-\/>m\_pos, \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tile-\/>getRaster()-\/>getLx(),}
\DoxyCodeLine{00581                                               tile-\/>getRaster()-\/>getLy()));}
\DoxyCodeLine{00582 }
\DoxyCodeLine{00583   \textcolor{comment}{/*-\/ 現在取っておいてあるデータのフレーム番号 -\/*/}}
\DoxyCodeLine{00584   \textcolor{keywordtype}{int} pcFrame = particlesData-\/>m\_frame;}
\DoxyCodeLine{00585 }
\DoxyCodeLine{00586   \textcolor{comment}{/*-\/ マージンをピクセル単位に換算する -\/*/}}
\DoxyCodeLine{00587   \textcolor{keywordtype}{double} pixelMargin;}
\DoxyCodeLine{00588   \{}
\DoxyCodeLine{00589     \mbox{\hyperlink{class_t_point_t}{TPointD}} vect(values.margin\_val, 0.0);}
\DoxyCodeLine{00590     \mbox{\hyperlink{class_t_affine}{TAffine}} aff(ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}});}
\DoxyCodeLine{00591     aff.a13 = aff.a23 = 0;}
\DoxyCodeLine{00592     vect              = aff * vect;}
\DoxyCodeLine{00593     pixelMargin       = sqrt(vect.x * vect.x + vect.y * vect.y);}
\DoxyCodeLine{00594   \}}
\DoxyCodeLine{00595   \textcolor{comment}{/*-\/ 外側にマージンを取って粒子を生成 -\/*/}}
\DoxyCodeLine{00596   \mbox{\hyperlink{class_t_rect_t}{TRectD}} resourceTileBBox = outTileBBox.enlarge(pixelMargin);}
\DoxyCodeLine{00597 }
\DoxyCodeLine{00598   \textcolor{comment}{/*-\/ 初期粒子量。これが変わっていなければ、BGはそのまま描く -\/*/}}
\DoxyCodeLine{00599   \textcolor{keywordtype}{int} initialOriginsSize;}
\DoxyCodeLine{00600   \textcolor{keywordflow}{if} (pcFrame > curr\_frame) \{}
\DoxyCodeLine{00601     \textcolor{comment}{/*-\/ データを初期化 -\/*/}}
\DoxyCodeLine{00602     \textcolor{comment}{// Clear stored particlesData}}
\DoxyCodeLine{00603     particlesData-\/>clear();}
\DoxyCodeLine{00604     pcFrame = particlesData-\/>m\_frame;}
\DoxyCodeLine{00605 }
\DoxyCodeLine{00606     \textcolor{comment}{/*-\/ まだ出発していない粒子情報を初期化 -\/*/}}
\DoxyCodeLine{00607     initParticleOrigins(resourceTileBBox, particleOrigins, curr\_frame,}
\DoxyCodeLine{00608                         ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}}, values, level\_n, last\_frame, pixelMargin);}
\DoxyCodeLine{00609     initialOriginsSize = particleOrigins.size();}
\DoxyCodeLine{00610 }
\DoxyCodeLine{00611   \}}
\DoxyCodeLine{00612 }
\DoxyCodeLine{00613   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (pcFrame >= startframe -\/ 1) \{}
\DoxyCodeLine{00614     myParticles        = particlesData-\/>m\_particles;}
\DoxyCodeLine{00615     myRandom           = particlesData-\/>m\_random;}
\DoxyCodeLine{00616     totalparticles     = particlesData-\/>m\_totalParticles;}
\DoxyCodeLine{00617     particleOrigins    = particlesData-\/>m\_particleOrigins;}
\DoxyCodeLine{00618     initialOriginsSize = -\/1;}
\DoxyCodeLine{00619   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00620     \textcolor{comment}{/*-\/ まだ出発していない粒子情報を初期化 -\/*/}}
\DoxyCodeLine{00621     initParticleOrigins(resourceTileBBox, particleOrigins, curr\_frame,}
\DoxyCodeLine{00622                         ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}}, values, level\_n, last\_frame, pixelMargin);}
\DoxyCodeLine{00623     initialOriginsSize = particleOrigins.size();}
\DoxyCodeLine{00624   \}}
\DoxyCodeLine{00625 }
\DoxyCodeLine{00626   \textcolor{comment}{/*-\/ スタートからカレントフレームまでループ -\/*/}}
\DoxyCodeLine{00627   \textcolor{keywordflow}{for} (frame = startframe -\/ 1; frame <= curr\_frame; ++frame) \{}
\DoxyCodeLine{00628     \textcolor{comment}{/*-\/  参照画像はキャッシュされてるフレームでは必要ないのでは？ -\/*/}}
\DoxyCodeLine{00629     \textcolor{keywordflow}{if} (frame <= pcFrame) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00630 }
\DoxyCodeLine{00631     \textcolor{keywordtype}{int} dist\_frame = curr\_frame -\/ frame;}
\DoxyCodeLine{00632     \textcolor{comment}{/*-\/}}
\DoxyCodeLine{00633 \textcolor{comment}{     * ループ内の現在のフレームでのパラメータを取得。スタートが負ならフレーム=0のときの値を格納。}}
\DoxyCodeLine{00634 \textcolor{comment}{     * -\/*/}}
\DoxyCodeLine{00635     fill\_value\_struct(values, frame < 0 ? 0 : frame * values.step\_val);}
\DoxyCodeLine{00636     \textcolor{comment}{/*-\/ パラメータの正規化 -\/*/}}
\DoxyCodeLine{00637     normalize\_values(values, ri);}
\DoxyCodeLine{00638     \textcolor{comment}{/*-\/ maxnum\_valは"{}birth\_rate"{}のパラメータ -\/*/}}
\DoxyCodeLine{00639     intpart = (int)values.maxnum\_val;}
\DoxyCodeLine{00640     \textcolor{comment}{/*-\/}}
\DoxyCodeLine{00641 \textcolor{comment}{     * birth\_rateが小数だったとき、各フレームの小数部分を足しこんだ結果の整数部分をintpartに渡す}}
\DoxyCodeLine{00642 \textcolor{comment}{     * -\/*/}}
\DoxyCodeLine{00643     fractpart = fractpart + values.maxnum\_val -\/ intpart;}
\DoxyCodeLine{00644     if ((\textcolor{keywordtype}{int})fractpart) \{}
\DoxyCodeLine{00645       values.maxnum\_val += (int)fractpart;}
\DoxyCodeLine{00646       fractpart = fractpart -\/ (int)fractpart;}
\DoxyCodeLine{00647     \}}
\DoxyCodeLine{00648 }
\DoxyCodeLine{00649     std::map<int, TTile *> porttiles;}
\DoxyCodeLine{00650 }
\DoxyCodeLine{00651     \textcolor{comment}{// Perform the roll}}
\DoxyCodeLine{00652     \textcolor{comment}{/*-\/ RenderSettingsを複製して現在のフレームの計算用にする -\/*/}}
\DoxyCodeLine{00653     \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riAux(ri);}
\DoxyCodeLine{00654 }
\DoxyCodeLine{00655     \textcolor{comment}{/*-\/ 64bitにする -\/*/}}
\DoxyCodeLine{00656     riAux.m\_bpp = 64;}
\DoxyCodeLine{00657     \textcolor{comment}{// riAux.m\_bpp = 32;}}
\DoxyCodeLine{00658 }
\DoxyCodeLine{00659     \textcolor{keywordtype}{int} r\_frame;  \textcolor{comment}{// Useful in case of negative roll frames}}
\DoxyCodeLine{00660     \textcolor{keywordflow}{if} (frame < 0)}
\DoxyCodeLine{00661       r\_frame = 0;}
\DoxyCodeLine{00662     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00663       r\_frame = frame;}
\DoxyCodeLine{00664 }
\DoxyCodeLine{00665     \textcolor{comment}{/*-\/ コントロールに刺さっている各ポートについて -\/*/}}
\DoxyCodeLine{00666     \textcolor{keywordflow}{for} (std::map<int, TRasterFxPort *>::iterator it = ctrl\_ports.begin();}
\DoxyCodeLine{00667          it != ctrl\_ports.end(); ++it) \{}
\DoxyCodeLine{00668       \mbox{\hyperlink{class_t_tile}{TTile}} *tmp;}
\DoxyCodeLine{00669       \textcolor{comment}{/*-\/ ポートが接続されていて、Fx内で実際に使用されていたら -\/*/}}
\DoxyCodeLine{00670       \textcolor{keywordflow}{if} ((it-\/>second)-\/>isConnected() \&\& port\_is\_used(it-\/>first, values)) \{}
\DoxyCodeLine{00671         \mbox{\hyperlink{class_t_rect_t}{TRectD}} bbox = resourceTileBBox;}
\DoxyCodeLine{00672 }
\DoxyCodeLine{00673         \textcolor{comment}{/*-\/ 素材が存在する場合、portTilesにコントロール画像タイルを格納 -\/*/}}
\DoxyCodeLine{00674         \textcolor{keywordflow}{if} (!bbox.\mbox{\hyperlink{class_t_rect_t_a53ce09c6112f8a019b43ad82d721a93b}{isEmpty}}()) \{}
\DoxyCodeLine{00675           \textcolor{keywordflow}{if} (frame <= pcFrame) \{}
\DoxyCodeLine{00676             \textcolor{comment}{// This frame will not actually be rolled. However, it was}}
\DoxyCodeLine{00677             \textcolor{comment}{// dryComputed -\/ so, declare the same here.}}
\DoxyCodeLine{00678             (*it-\/>second)-\/>dryCompute(bbox, r\_frame, riAux);}
\DoxyCodeLine{00679           \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00680             tmp = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_tile}{TTile}};}
\DoxyCodeLine{00681 }
\DoxyCodeLine{00682             \textcolor{keywordflow}{if} (isPrecomputingEnabled) \{}
\DoxyCodeLine{00683               (*it-\/>second)}
\DoxyCodeLine{00684                   -\/>allocateAndCompute(*tmp, bbox.getP00(),}
\DoxyCodeLine{00685                                        convert(bbox).getSize(), 0, r\_frame,}
\DoxyCodeLine{00686                                        riAux);}
\DoxyCodeLine{00687             \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00688               std::string alias =}
\DoxyCodeLine{00689                   \textcolor{stringliteral}{"{}CTRL: "{}} + (*(it-\/>second))-\/>getAlias(r\_frame, riAux);}
\DoxyCodeLine{00690               \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{00691 }
\DoxyCodeLine{00692               \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00693                 tmp-\/>m\_pos = bbox.getP00();}
\DoxyCodeLine{00694                 tmp-\/>setRaster(rimg-\/>getRaster());}
\DoxyCodeLine{00695               \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00696                 (*it-\/>second)}
\DoxyCodeLine{00697                     -\/>allocateAndCompute(*tmp, bbox.getP00(),}
\DoxyCodeLine{00698                                          convert(bbox).getSize(), 0, r\_frame,}
\DoxyCodeLine{00699                                          riAux);}
\DoxyCodeLine{00700               \}}
\DoxyCodeLine{00701             \}}
\DoxyCodeLine{00702 }
\DoxyCodeLine{00703             porttiles[it-\/>first] = tmp;}
\DoxyCodeLine{00704           \}}
\DoxyCodeLine{00705         \}}
\DoxyCodeLine{00706       \}}
\DoxyCodeLine{00707     \}}
\DoxyCodeLine{00708 }
\DoxyCodeLine{00709     \mbox{\hyperlink{class_t_tile}{TTile}} baseImgTile;}
\DoxyCodeLine{00710     \textcolor{keywordflow}{if} (values.base\_ctrl\_val \&\&}
\DoxyCodeLine{00711         ctrl\_ports.at(values.base\_ctrl\_val)-\/>isConnected() \&\&}
\DoxyCodeLine{00712         port\_is\_used(values.base\_ctrl\_val, values) \&\&}
\DoxyCodeLine{00713         values.iw\_rendermode\_val !=}
\DoxyCodeLine{00714             Iwa\_TiledParticlesFx::}
\DoxyCodeLine{00715                 REND\_ILLUMINATED) \textcolor{comment}{/*-\/ 照明モードなら、BG素材は要らない -\/*/}}
\DoxyCodeLine{00716     \{}
\DoxyCodeLine{00717       std::string alias =}
\DoxyCodeLine{00718           \textcolor{stringliteral}{"{}BG\_CTRL: "{}} +}
\DoxyCodeLine{00719           (*ctrl\_ports.at(values.base\_ctrl\_val))-\/>getAlias(r\_frame, ri);}
\DoxyCodeLine{00720       \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{00721       \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{00722         baseImgTile.m\_pos = tile-\/>m\_pos;}
\DoxyCodeLine{00723         baseImgTile.setRaster(rimg-\/>getRaster());}
\DoxyCodeLine{00724       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00725         \textcolor{comment}{/*-\/ 出力と同じbpcにする -\/*/}}
\DoxyCodeLine{00726         (*ctrl\_ports.at(values.base\_ctrl\_val))}
\DoxyCodeLine{00727             -\/>allocateAndCompute(baseImgTile, tile-\/>m\_pos,}
\DoxyCodeLine{00728                                  convert(resourceTileBBox).getSize(),}
\DoxyCodeLine{00729                                  tile-\/>getRaster(), r\_frame, ri);}
\DoxyCodeLine{00730         addRenderCache(alias, \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}}(baseImgTile.getRaster()));}
\DoxyCodeLine{00731       \}}
\DoxyCodeLine{00732       baseImgTile.getRaster()-\/>lock();}
\DoxyCodeLine{00733     \}}
\DoxyCodeLine{00734 }
\DoxyCodeLine{00735     \textcolor{comment}{// Invoke the actual rolling procedure}}
\DoxyCodeLine{00736     roll\_particles(tile, porttiles, riAux, myParticles, values, 0, 0, frame,}
\DoxyCodeLine{00737                    curr\_frame, level\_n, \&random\_level, 1, last\_frame,}
\DoxyCodeLine{00738                    totalparticles, particleOrigins,}
\DoxyCodeLine{00739                    intpart \textcolor{comment}{/*-\/ 実際に生成したい粒子数 -\/*/}}
\DoxyCodeLine{00740                    );}
\DoxyCodeLine{00741 }
\DoxyCodeLine{00742     \textcolor{comment}{// Store the rolled data in the particles manager}}
\DoxyCodeLine{00743     \textcolor{keywordflow}{if} (!particlesData-\/>m\_calculated ||}
\DoxyCodeLine{00744         particlesData-\/>m\_frame + particlesData-\/>m\_maxTrail < frame) \{}
\DoxyCodeLine{00745       particlesData-\/>m\_frame     = frame;}
\DoxyCodeLine{00746       particlesData-\/>m\_particles = myParticles;}
\DoxyCodeLine{00747       particlesData-\/>m\_random    = myRandom;}
\DoxyCodeLine{00748       particlesData-\/>buildMaxTrail();}
\DoxyCodeLine{00749       particlesData-\/>m\_calculated      = \textcolor{keyword}{true};}
\DoxyCodeLine{00750       particlesData-\/>m\_totalParticles  = totalparticles;}
\DoxyCodeLine{00751       particlesData-\/>m\_particleOrigins = particleOrigins;}
\DoxyCodeLine{00752     \}}
\DoxyCodeLine{00753 }
\DoxyCodeLine{00754     \textcolor{comment}{// Render the particles if the distance from current frame is a trail}}
\DoxyCodeLine{00755     \textcolor{comment}{// multiple}}
\DoxyCodeLine{00756     \textcolor{comment}{/*-\/ さしあたり、trailは無視する -\/*/}}
\DoxyCodeLine{00757     \textcolor{keywordflow}{if} (dist\_frame == 0) \{}
\DoxyCodeLine{00758       \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00759       \textcolor{comment}{// Store the maximum particle size before the do\_render cycle}}
\DoxyCodeLine{00760       \textcolor{comment}{/*-\/ 表示されている粒子のうち、各素材について最大サイズのものを記録しておく}}
\DoxyCodeLine{00761 \textcolor{comment}{              条件にあわせ、飛んでいる粒子と飛び立つ前の粒子の両方で記録を行う}}
\DoxyCodeLine{00762 \textcolor{comment}{         -\/*/}}
\DoxyCodeLine{00763       \textcolor{comment}{/*-\/   ①飛んでいる粒子 -\/*/}}
\DoxyCodeLine{00764       \textcolor{keywordflow}{if} (values.iw\_rendermode\_val != Iwa\_TiledParticlesFx::REND\_BG) \{}
\DoxyCodeLine{00765         std::list<Iwa\_Particle>::iterator pt;}
\DoxyCodeLine{00766         \textcolor{keywordflow}{for} (pt = myParticles.begin(); pt != myParticles.end(); ++pt) \{}
\DoxyCodeLine{00767           \mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}} \&part = *pt;}
\DoxyCodeLine{00768           \textcolor{keywordtype}{int} ndx            = part.frame \% last\_frame[part.level];}
\DoxyCodeLine{00769           std::pair<int, int> ndxPair(part.level, ndx);}
\DoxyCodeLine{00770 }
\DoxyCodeLine{00771           std::map<std::pair<int, int>, \textcolor{keywordtype}{float}>::iterator it =}
\DoxyCodeLine{00772               partScales.find(ndxPair);}
\DoxyCodeLine{00773 }
\DoxyCodeLine{00774           \textcolor{keywordflow}{if} (it != partScales.end())}
\DoxyCodeLine{00775             it-\/>second = std::max(part.scale, it-\/>second);}
\DoxyCodeLine{00776           \textcolor{keywordflow}{else}}
\DoxyCodeLine{00777             partScales[ndxPair] = part.scale;}
\DoxyCodeLine{00778         \}}
\DoxyCodeLine{00779       \}}
\DoxyCodeLine{00780       \textcolor{comment}{/*-\/ ②飛び立つ前の粒子がひとつでもあった場合、最大値でおきかえる -\/*/}}
\DoxyCodeLine{00781       \textcolor{keywordflow}{if} (values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_ALL ||}
\DoxyCodeLine{00782           values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_BG) \{}
\DoxyCodeLine{00783         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} lev = 0; lev < level\_n; lev++) \{}
\DoxyCodeLine{00784           std::pair<int, int> ndxPair(lev, 0);}
\DoxyCodeLine{00785           std::map<std::pair<int, int>, \textcolor{keywordtype}{float}>::iterator it =}
\DoxyCodeLine{00786               partScales.find(ndxPair);}
\DoxyCodeLine{00787           \textcolor{keywordflow}{if} (it != partScales.end())}
\DoxyCodeLine{00788             it-\/>second = std::max((\textcolor{keywordtype}{float})values.scale\_val.second, it-\/>second);}
\DoxyCodeLine{00789           \textcolor{keywordflow}{else}}
\DoxyCodeLine{00790             partScales[ndxPair] = values.scale\_val.second;}
\DoxyCodeLine{00791         \}}
\DoxyCodeLine{00792       \}}
\DoxyCodeLine{00793       \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00794 }
\DoxyCodeLine{00795       \textcolor{comment}{/*-\/ ここで、出発した粒子の分、穴を開けた背景を描く -\/*/}}
\DoxyCodeLine{00796       \textcolor{comment}{/*-\/ スイッチがONなら -\/*/}}
\DoxyCodeLine{00797       \textcolor{keywordflow}{if} (values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_ALL ||}
\DoxyCodeLine{00798           values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_BG) \{}
\DoxyCodeLine{00799         \textcolor{comment}{/*-\/ まだ粒子が飛び立っていない場合、そのまま背景を描く -\/*/}}
\DoxyCodeLine{00800         \textcolor{keywordflow}{if} (initialOriginsSize == particleOrigins.size()) \{}
\DoxyCodeLine{00801           \mbox{\hyperlink{namespace_t_rop_a5e39bc748039afe42001ba44f2d2a073}{TRop::resample}}(tile-\/>getRaster(), baseImgTile.getRaster(), \mbox{\hyperlink{class_t_affine}{TAffine}}());}
\DoxyCodeLine{00802         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00803           renderBackground(tile, particleOrigins, part\_ports, ri, partLevel,}
\DoxyCodeLine{00804                            partScales, \&baseImgTile);}
\DoxyCodeLine{00805         \}}
\DoxyCodeLine{00806       \}}
\DoxyCodeLine{00807 }
\DoxyCodeLine{00808       \textcolor{comment}{/*-\/ 粒子の描画。もし、背景モードなら描かない -\/*/}}
\DoxyCodeLine{00809       \textcolor{keywordflow}{if} (values.iw\_rendermode\_val != Iwa\_TiledParticlesFx::REND\_BG) \{}
\DoxyCodeLine{00810         \textcolor{keywordflow}{if} (values.toplayer\_val == Iwa\_TiledParticlesFx::TOP\_SMALLER ||}
\DoxyCodeLine{00811             values.toplayer\_val == Iwa\_TiledParticlesFx::TOP\_BIGGER)}
\DoxyCodeLine{00812           myParticles.sort(\mbox{\hyperlink{class_iwa___compareby_size}{Iwa\_ComparebySize}}());}
\DoxyCodeLine{00813 }
\DoxyCodeLine{00814         \textcolor{keywordflow}{if} (values.toplayer\_val == Iwa\_TiledParticlesFx::TOP\_SMALLER) \{}
\DoxyCodeLine{00815           \textcolor{keywordtype}{int} unit  = 1 + (int)myParticles.size() / 100;}
\DoxyCodeLine{00816           \textcolor{keywordtype}{int} count = 0;}
\DoxyCodeLine{00817           std::list<Iwa\_Particle>::iterator pt;}
\DoxyCodeLine{00818           \textcolor{keywordflow}{for} (pt = myParticles.begin(); pt != myParticles.end(); ++pt) \{}
\DoxyCodeLine{00819             count++;}
\DoxyCodeLine{00820 }
\DoxyCodeLine{00821             \mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}} \&part = *pt;}
\DoxyCodeLine{00822             \textcolor{keywordflow}{if} (dist\_frame <= part.trail \&\& part.scale > 0.0f \&\&}
\DoxyCodeLine{00823                 part.lifetime > 0 \&\&}
\DoxyCodeLine{00824                 part.lifetime <=}
\DoxyCodeLine{00825                     part.genlifetime)  \textcolor{comment}{// This last... shouldn't always be?}}
\DoxyCodeLine{00826             \{}
\DoxyCodeLine{00827               do\_render(\&part, tile, part\_ports, porttiles, ri, p\_size,}
\DoxyCodeLine{00828                         p\_offset, last\_frame[part.level], partLevel, values,}
\DoxyCodeLine{00829                         opacity\_range, dist\_frame, partScales, \&baseImgTile);}
\DoxyCodeLine{00830             \}}
\DoxyCodeLine{00831           \}}
\DoxyCodeLine{00832 }
\DoxyCodeLine{00833         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00834           \textcolor{keywordtype}{int} unit  = 1 + (int)myParticles.size() / 100;}
\DoxyCodeLine{00835           \textcolor{keywordtype}{int} count = 0;}
\DoxyCodeLine{00836           std::list<Iwa\_Particle>::reverse\_iterator pt;}
\DoxyCodeLine{00837           \textcolor{keywordflow}{for} (pt = myParticles.rbegin(); pt != myParticles.rend(); ++pt) \{}
\DoxyCodeLine{00838             count++;}
\DoxyCodeLine{00839 }
\DoxyCodeLine{00840             \mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}} \&part = *pt;}
\DoxyCodeLine{00841             \textcolor{keywordflow}{if} (dist\_frame <= part.trail \&\& part.scale > 0.0f \&\&}
\DoxyCodeLine{00842                 part.lifetime > 0 \&\&}
\DoxyCodeLine{00843                 part.lifetime <= part.genlifetime)  \textcolor{comment}{// Same here..?}}
\DoxyCodeLine{00844             \{}
\DoxyCodeLine{00845               do\_render(\&part, tile, part\_ports, porttiles, ri, p\_size,}
\DoxyCodeLine{00846                         p\_offset, last\_frame[part.level], partLevel, values,}
\DoxyCodeLine{00847                         opacity\_range, dist\_frame, partScales, \&baseImgTile);}
\DoxyCodeLine{00848             \}}
\DoxyCodeLine{00849           \}}
\DoxyCodeLine{00850         \}}
\DoxyCodeLine{00851       \}}
\DoxyCodeLine{00852       \textcolor{comment}{/*-\/ 粒子の描画 ここまで -\/*/}}
\DoxyCodeLine{00853     \}}
\DoxyCodeLine{00854 }
\DoxyCodeLine{00855     std::map<int, TTile *>::iterator it;}
\DoxyCodeLine{00856     \textcolor{keywordflow}{for} (it = porttiles.begin(); it != porttiles.end(); ++it) \textcolor{keyword}{delete} it-\/>second;}
\DoxyCodeLine{00857 }
\DoxyCodeLine{00858     \textcolor{keywordflow}{if} (values.base\_ctrl\_val \&\&}
\DoxyCodeLine{00859         ctrl\_ports.at(values.base\_ctrl\_val)-\/>isConnected() \&\&}
\DoxyCodeLine{00860         port\_is\_used(values.base\_ctrl\_val, values) \&\&}
\DoxyCodeLine{00861         values.iw\_rendermode\_val != Iwa\_TiledParticlesFx::REND\_ILLUMINATED)}
\DoxyCodeLine{00862       baseImgTile.getRaster()-\/>unlock();}
\DoxyCodeLine{00863   \}}
\DoxyCodeLine{00864 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a4f655c139bcd2b581b560d2f2ce396d6}\label{class_iwa___particles___engine_a4f655c139bcd2b581b560d2f2ce396d6}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!renderBackground@{renderBackground}}
\index{renderBackground@{renderBackground}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{renderBackground()}{renderBackground()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::render\+Background (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&}]{origins,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} $\ast$ $>$}]{part\+\_\+ports,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{std\+::vector$<$ \mbox{\hyperlink{class_t_level_p}{TLevelP}} $>$}]{part\+Level,  }\item[{std\+::map$<$ std\+::pair$<$ int, int $>$, float $>$ \&}]{part\+Scales,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{base\+Img\+Tile }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01452                                                                       \{}
\DoxyCodeLine{01453   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} tileRas(tile-\/>getRaster());}
\DoxyCodeLine{01454   \textcolor{keywordtype}{int} unit = 1 + (int)origins.size() / 100;}
\DoxyCodeLine{01455 }
\DoxyCodeLine{01456   \textcolor{comment}{/*-\/ まだ残っている粒子源について -\/*/}}
\DoxyCodeLine{01457   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} po = 0; po < origins.size(); po++) \{}
\DoxyCodeLine{01458     \mbox{\hyperlink{struct_particle_origin}{ParticleOrigin}} origin = origins.at(po);}
\DoxyCodeLine{01459 }
\DoxyCodeLine{01460     \textcolor{keywordtype}{int} ndx = origin.initSourceFrame;}
\DoxyCodeLine{01461 }
\DoxyCodeLine{01462     \textcolor{comment}{/*-\/ 粒子の回転、スケール -\/*/}}
\DoxyCodeLine{01463     \mbox{\hyperlink{class_t_rotation}{TRotation}} rotM((origin.isUpward) ? 0.0 : 180.0);}
\DoxyCodeLine{01464     \mbox{\hyperlink{class_t_affine}{TAffine}} M(rotM);}
\DoxyCodeLine{01465     \textcolor{comment}{// Particles deal with dpi affines on their own}}
\DoxyCodeLine{01466     \mbox{\hyperlink{class_t_affine}{TAffine}} scaleAff(m\_parent-\/>handledAffine(ri, m\_frame));}
\DoxyCodeLine{01467     \textcolor{keywordtype}{float} partScale =}
\DoxyCodeLine{01468         scaleAff.a11 * partScales[std::pair<int, int>(origin.level, ndx)];}
\DoxyCodeLine{01469     \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}} partResolution(0, 0);}
\DoxyCodeLine{01470     \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riNew(ri);}
\DoxyCodeLine{01471     \textcolor{comment}{// Retrieve the bounding box in the standard reference}}
\DoxyCodeLine{01472     \mbox{\hyperlink{class_t_rect_t}{TRectD}} bbox(-\/5.0, -\/5.0, 5.0, 5.0), standardRefBBox;}
\DoxyCodeLine{01473     \textcolor{keywordflow}{if} (origin.level <}
\DoxyCodeLine{01474             (\textcolor{keywordtype}{int})part\_ports.size() \&\&  \textcolor{comment}{// Not the default levelless cases}}
\DoxyCodeLine{01475         part\_ports[origin.level]-\/>isConnected()) \{}
\DoxyCodeLine{01476       \mbox{\hyperlink{class_t_render_settings}{TRenderSettings}} riIdentity(ri);}
\DoxyCodeLine{01477       riIdentity.m\_affine = \mbox{\hyperlink{class_t_affine}{TAffine}}();}
\DoxyCodeLine{01478       (*part\_ports[origin.level])-\/>getBBox(ndx, bbox, riIdentity);}
\DoxyCodeLine{01479       \textcolor{keywordflow}{if} (bbox == TConsts::infiniteRectD) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01480     \}}
\DoxyCodeLine{01481 }
\DoxyCodeLine{01482     \textcolor{comment}{// Now, these are the particle rendering specifications}}
\DoxyCodeLine{01483     bbox            = bbox.enlarge(3);}
\DoxyCodeLine{01484     standardRefBBox = bbox;}
\DoxyCodeLine{01485     riNew.m\_affine  = \mbox{\hyperlink{class_t_scale}{TScale}}(partScale);}
\DoxyCodeLine{01486     bbox            = riNew.m\_affine * bbox;}
\DoxyCodeLine{01487     \textcolor{comment}{/*-\/ 縮小済みのParticleのサイズ -\/*/}}
\DoxyCodeLine{01488     partResolution = \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(tceil(bbox.getLx()), tceil(bbox.getLy()));}
\DoxyCodeLine{01489 }
\DoxyCodeLine{01490     \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} ras;}
\DoxyCodeLine{01491 }
\DoxyCodeLine{01492     std::string alias;}
\DoxyCodeLine{01493     \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}} rimg;}
\DoxyCodeLine{01494     rimg = partLevel[origin.level]-\/>frame(ndx);}
\DoxyCodeLine{01495     \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{01496       ras = rimg-\/>getRaster();}
\DoxyCodeLine{01497     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01498       alias = \textcolor{stringliteral}{"{}PART: "{}} + (*part\_ports[origin.level])-\/>getAlias(ndx, riNew);}
\DoxyCodeLine{01499       rimg  = TImageCache::instance()-\/>\mbox{\hyperlink{class_t_image_cache_aea3ac2752efd6fa9689f5a7c1e895e41}{get}}(alias, \textcolor{keyword}{false});}
\DoxyCodeLine{01500       \textcolor{keywordflow}{if} (rimg) \{}
\DoxyCodeLine{01501         ras = rimg-\/>getRaster();}
\DoxyCodeLine{01502 }
\DoxyCodeLine{01503         \textcolor{comment}{// Check that the raster resolution is sufficient for our purposes}}
\DoxyCodeLine{01504         \textcolor{keywordflow}{if} (ras-\/>getLx() < partResolution.lx ||}
\DoxyCodeLine{01505             ras-\/>getLy() < partResolution.ly)}
\DoxyCodeLine{01506           ras = 0;}
\DoxyCodeLine{01507         \textcolor{keywordflow}{else}}
\DoxyCodeLine{01508           partResolution = \mbox{\hyperlink{class_t_dimension_t}{TDimensionD}}(ras-\/>getLx(), ras-\/>getLy());}
\DoxyCodeLine{01509       \}}
\DoxyCodeLine{01510     \}}
\DoxyCodeLine{01511 }
\DoxyCodeLine{01512     \textcolor{comment}{// We are interested in making the relation between scale and (integer)}}
\DoxyCodeLine{01513     \textcolor{comment}{// resolution}}
\DoxyCodeLine{01514     \textcolor{comment}{// bijective -\/ since we shall cache by using resolution as a partial}}
\DoxyCodeLine{01515     \textcolor{comment}{// identification parameter.}}
\DoxyCodeLine{01516     \textcolor{comment}{// Therefore, we find the current bbox Lx and take a unique scale out of it.}}
\DoxyCodeLine{01517     partScale      = partResolution.lx / standardRefBBox.getLx();}
\DoxyCodeLine{01518     riNew.m\_affine = \mbox{\hyperlink{class_t_scale}{TScale}}(partScale);}
\DoxyCodeLine{01519     bbox           = riNew.m\_affine * standardRefBBox;}
\DoxyCodeLine{01520 }
\DoxyCodeLine{01521     \textcolor{comment}{// If no image was retrieved from the cache (or it was not scaled enough),}}
\DoxyCodeLine{01522     \textcolor{comment}{// calculate it}}
\DoxyCodeLine{01523     \textcolor{keywordflow}{if} (!ras) \{}
\DoxyCodeLine{01524       \mbox{\hyperlink{class_t_tile}{TTile}} auxTile;}
\DoxyCodeLine{01525       (*part\_ports[origin.level])}
\DoxyCodeLine{01526           -\/>allocateAndCompute(auxTile, bbox.getP00(),}
\DoxyCodeLine{01527                                \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(partResolution.lx, partResolution.ly),}
\DoxyCodeLine{01528                                tile-\/>getRaster(), ndx, riNew);}
\DoxyCodeLine{01529       ras = auxTile.getRaster();}
\DoxyCodeLine{01530 }
\DoxyCodeLine{01531       \textcolor{comment}{// Finally, cache the particle}}
\DoxyCodeLine{01532       addRenderCache(alias, \mbox{\hyperlink{class_t_raster_image_p}{TRasterImageP}}(ras));}
\DoxyCodeLine{01533     \}}
\DoxyCodeLine{01534 }
\DoxyCodeLine{01535     \textcolor{keywordflow}{if} (!ras) \textcolor{keywordflow}{return};  \textcolor{comment}{// At this point, it should never happen anyway...}}
\DoxyCodeLine{01536 }
\DoxyCodeLine{01537     M = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}} * M * \mbox{\hyperlink{class_t_scale}{TScale}}(1.0 / partScale);}
\DoxyCodeLine{01538     \mbox{\hyperlink{class_t_point_t}{TPointD}} pos(origin.pos[0], origin.pos[1]);}
\DoxyCodeLine{01539     pos = ri.\mbox{\hyperlink{class_t_render_settings_a1250181bf3fe8e05db005d5faa76b3ea}{m\_affine}} * pos;}
\DoxyCodeLine{01540     M   = \mbox{\hyperlink{class_t_translation}{TTranslation}}(pos -\/ tile-\/>m\_pos) * M * \mbox{\hyperlink{class_t_translation}{TTranslation}}(bbox.getP00());}
\DoxyCodeLine{01541 }
\DoxyCodeLine{01542     \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} myras32 = tile-\/>getRaster())}
\DoxyCodeLine{01543       \mbox{\hyperlink{namespace_t_rop_ae5fd1fb0c2f625e1da14fe92ae0e5122}{TRop::over}}(tileRas, ras, M);}
\DoxyCodeLine{01544     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} myras64 = tile-\/>getRaster())}
\DoxyCodeLine{01545       \mbox{\hyperlink{namespace_t_rop_ae5fd1fb0c2f625e1da14fe92ae0e5122}{TRop::over}}(tileRas, ras, M);}
\DoxyCodeLine{01546   \}}
\DoxyCodeLine{01547   \textcolor{comment}{/*-\/ サイズ縮める操作をいれる -\/*/}}
\DoxyCodeLine{01548   \mbox{\hyperlink{class_t_smart_pointer_t}{TRasterP}} resizedBGRas;}
\DoxyCodeLine{01549   \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} myBgRas32 = baseImgTile-\/>getRaster())}
\DoxyCodeLine{01550     resizedBGRas = \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}}(tileRas-\/>getSize());}
\DoxyCodeLine{01551   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} myBgRas64 = baseImgTile-\/>getRaster())}
\DoxyCodeLine{01552     resizedBGRas = \mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}}(tileRas-\/>getSize());}
\DoxyCodeLine{01553   \textcolor{keywordflow}{else}}
\DoxyCodeLine{01554     \textcolor{keywordflow}{return};}
\DoxyCodeLine{01555   \mbox{\hyperlink{class_t_affine}{TAffine}} aff;}
\DoxyCodeLine{01556   \textcolor{comment}{/*-\/ リサンプル -\/*/}}
\DoxyCodeLine{01557   \mbox{\hyperlink{namespace_t_rop_a5e39bc748039afe42001ba44f2d2a073}{TRop::resample}}(resizedBGRas, baseImgTile-\/>getRaster(), aff);}
\DoxyCodeLine{01558 }
\DoxyCodeLine{01559   TRop::ropin(resizedBGRas, tileRas, tileRas);}
\DoxyCodeLine{01560 }
\DoxyCodeLine{01561   std::cout << std::endl;}
\DoxyCodeLine{01562 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___particles___engine_a818ccc2106caa5fec43413520e272883}\label{class_iwa___particles___engine_a818ccc2106caa5fec43413520e272883}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!roll\_particles@{roll\_particles}}
\index{roll\_particles@{roll\_particles}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{roll\_particles()}{roll\_particles()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Particles\+\_\+\+Engine\+::roll\+\_\+particles (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} $\ast$}]{tile,  }\item[{std\+::map$<$ int, \mbox{\hyperlink{class_t_tile}{TTile}} $\ast$ $>$}]{porttiles,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{ri,  }\item[{std\+::list$<$ \mbox{\hyperlink{class_iwa___particle}{Iwa\+\_\+\+Particle}} $>$ \&}]{my\+Particles,  }\item[{struct \mbox{\hyperlink{structparticles__values}{particles\+\_\+values}} \&}]{values,  }\item[{float}]{cx,  }\item[{float}]{cy,  }\item[{int}]{frame,  }\item[{int}]{curr\+\_\+frame,  }\item[{int}]{level\+\_\+n,  }\item[{bool $\ast$}]{random\+\_\+level,  }\item[{float}]{dpi,  }\item[{std\+::vector$<$ int $>$}]{lastframe,  }\item[{int \&}]{totalparticles,  }\item[{QList$<$ \mbox{\hyperlink{struct_particle_origin}{Particle\+Origin}} $>$ \&}]{particle\+Origin,  }\item[{int}]{gen\+Part\+Num }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00211       \{}
\DoxyCodeLine{00212   \mbox{\hyperlink{structparticles__ranges}{particles\_ranges}} ranges;}
\DoxyCodeLine{00213   \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{00214   \textcolor{keywordtype}{float} xgravity, ygravity, windx, windy;}
\DoxyCodeLine{00215 }
\DoxyCodeLine{00216   \textcolor{comment}{/*-\/ 風の強さ／重力の強さをX,Y成分に分ける -\/*/}}
\DoxyCodeLine{00217   windx    = values.windint\_val * sin(values.windangle\_val);}
\DoxyCodeLine{00218   windy    = values.windint\_val * cos(values.windangle\_val);}
\DoxyCodeLine{00219   xgravity = values.gravity\_val * sin(values.g\_angle\_val);}
\DoxyCodeLine{00220   ygravity = values.gravity\_val * cos(values.g\_angle\_val);}
\DoxyCodeLine{00221 }
\DoxyCodeLine{00222   fill\_range\_struct(values, ranges);}
\DoxyCodeLine{00223 }
\DoxyCodeLine{00224   std::vector<TPointD> myregions;}
\DoxyCodeLine{00225   QList<QList<int>> myHistogram;}
\DoxyCodeLine{00226 }
\DoxyCodeLine{00227   std::map<int, TTile *>::iterator it = porttiles.find(values.source\_ctrl\_val);}
\DoxyCodeLine{00228 }
\DoxyCodeLine{00229   \textcolor{comment}{/*-\/ ソース画像にコントロールが付いていた場合 -\/*/}}
\DoxyCodeLine{00230   \textcolor{keywordflow}{if} (values.source\_ctrl\_val \&\& (it != porttiles.end()) \&\&}
\DoxyCodeLine{00231       it-\/>second-\/>getRaster())}
\DoxyCodeLine{00232     \textcolor{comment}{/*-\/ 入力画像のアルファ値に比例して発生濃度を変える -\/*/}}
\DoxyCodeLine{00233     fill\_single\_region(myregions, it-\/>second, values.bright\_thres\_val,}
\DoxyCodeLine{00234                        values.source\_gradation\_val, myHistogram,}
\DoxyCodeLine{00235                        particleOrigins);}
\DoxyCodeLine{00236 }
\DoxyCodeLine{00237   \textcolor{comment}{/*-\/ 粒子が出きったらもう出さない -\/*/}}
\DoxyCodeLine{00238   \textcolor{keywordtype}{int} actualBirthParticles = std::min(genPartNum, particleOrigins.size());}
\DoxyCodeLine{00239   \textcolor{comment}{/*-\/ 出発する粒子のインデックス -\/*/}}
\DoxyCodeLine{00240   QList<int> leavingPartIndex;}
\DoxyCodeLine{00241   \textcolor{keywordflow}{if} (myregions.size() \&\&}
\DoxyCodeLine{00242       porttiles.find(values.source\_ctrl\_val) != porttiles.end()) \{}
\DoxyCodeLine{00243     \textcolor{keywordtype}{int} partLeft = actualBirthParticles;}
\DoxyCodeLine{00244     \textcolor{keywordflow}{while} (partLeft > 0) \{}
\DoxyCodeLine{00245       \textcolor{keywordtype}{int} PrePartLeft = partLeft;}
\DoxyCodeLine{00246 }
\DoxyCodeLine{00247       \textcolor{keywordtype}{int} potential\_sum = 0;}
\DoxyCodeLine{00248       QList<int> myWeight;}
\DoxyCodeLine{00249       \textcolor{comment}{/*-\/ 各濃度のポテンシャルの大きさmyWeightと、合計ポテンシャルを計算 -\/*/}}
\DoxyCodeLine{00250       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} m = 0; m < 256; m++) \{}
\DoxyCodeLine{00251         \textcolor{keywordtype}{int} pot = myHistogram[m].size() * m;}
\DoxyCodeLine{00252         myWeight.append(pot);}
\DoxyCodeLine{00253         potential\_sum += pot;}
\DoxyCodeLine{00254       \}}
\DoxyCodeLine{00255       \textcolor{comment}{/*-\/ 各濃度について(濃い方から) -\/*/}}
\DoxyCodeLine{00256       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} m = 255; m > 0; m-\/-\/) \{}
\DoxyCodeLine{00257         \textcolor{comment}{/*-\/ 割り当てを計算（切り上げ） -\/*/}}
\DoxyCodeLine{00258         \textcolor{keywordtype}{int} wariate = tceil((\textcolor{keywordtype}{float})(myWeight[m]) * (\textcolor{keywordtype}{float})(partLeft) /}
\DoxyCodeLine{00259                             (\textcolor{keywordtype}{float})potential\_sum);}
\DoxyCodeLine{00260         \textcolor{comment}{/*-\/ 実際にこのポテンシャルから出発する粒子数 -\/*/}}
\DoxyCodeLine{00261         \textcolor{keywordtype}{int} leaveNum = std::min(myHistogram.at(m).size(), wariate);}
\DoxyCodeLine{00262         \textcolor{comment}{/*-\/ 割り当てられた粒子を頭から登録 -\/*/}}
\DoxyCodeLine{00263         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} lp = 0; lp < leaveNum; lp++) \{}
\DoxyCodeLine{00264           \textcolor{comment}{/*-\/ Histogramから減らしながら追加 -\/*/}}
\DoxyCodeLine{00265           leavingPartIndex.append(myHistogram[m].takeFirst());}
\DoxyCodeLine{00266           \textcolor{comment}{/*-\/ 残数を減らす -\/*/}}
\DoxyCodeLine{00267           partLeft-\/-\/;}
\DoxyCodeLine{00268           \textcolor{keywordflow}{if} (partLeft == 0) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00269         \}}
\DoxyCodeLine{00270         \textcolor{keywordflow}{if} (partLeft == 0) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00271       \}}
\DoxyCodeLine{00272 }
\DoxyCodeLine{00273       \textcolor{comment}{/*-\/ ひとつも出発出来なければbreak -\/*/}}
\DoxyCodeLine{00274       \textcolor{keywordflow}{if} (partLeft == PrePartLeft) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00275     \}}
\DoxyCodeLine{00276     \textcolor{comment}{/*-\/ 実際に飛び出せた粒子数 -\/*/}}
\DoxyCodeLine{00277     actualBirthParticles = leavingPartIndex.size();}
\DoxyCodeLine{00278   \} \textcolor{keywordflow}{else} \textcolor{comment}{/*-\/ 何も刺さっていなければ、ランダムに発生させる -\/*/}}
\DoxyCodeLine{00279   \{}
\DoxyCodeLine{00280     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < actualBirthParticles; i++) leavingPartIndex.append(i);}
\DoxyCodeLine{00281   \}}
\DoxyCodeLine{00282 }
\DoxyCodeLine{00283   \textcolor{comment}{/*-\/ 動かす粒子も生まれる粒子も無い -\/*/}}
\DoxyCodeLine{00284   \textcolor{keywordflow}{if} (myParticles.empty() \&\& actualBirthParticles == 0) \{}
\DoxyCodeLine{00285     std::cout << \textcolor{stringliteral}{"{}no particles generated nor alive. returning function"{}}}
\DoxyCodeLine{00286               << std::endl;}
\DoxyCodeLine{00287     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00288   \}}
\DoxyCodeLine{00289 }
\DoxyCodeLine{00290   \textcolor{comment}{/*-\/ 背景だけを描画するモードのときは、particlesOriginを更新するだけでOK -\/*/}}
\DoxyCodeLine{00291   \textcolor{keywordflow}{if} (values.iw\_rendermode\_val == Iwa\_TiledParticlesFx::REND\_BG) \{}
\DoxyCodeLine{00292     \textcolor{comment}{/*-\/ インデックスを小さい順にならべる -\/*/}}
\DoxyCodeLine{00293     std::sort(leavingPartIndex.begin(), leavingPartIndex.end());}
\DoxyCodeLine{00294     \textcolor{comment}{/*-\/ インデックス大きい方から消していく -\/*/}}
\DoxyCodeLine{00295     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} lp = leavingPartIndex.size() -\/ 1; lp >= 0; lp-\/-\/)}
\DoxyCodeLine{00296       particleOrigins.removeAt(leavingPartIndex.at(lp));}
\DoxyCodeLine{00297     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00298   \}}
\DoxyCodeLine{00299 }
\DoxyCodeLine{00300   \textcolor{comment}{/*-\/ 新規粒子の生成 -\/*/}}
\DoxyCodeLine{00301   \textcolor{comment}{/*-\/ 新規粒子しかない場合 -\/*/}}
\DoxyCodeLine{00302   \textcolor{keywordflow}{if} (myParticles.empty() \&\& actualBirthParticles)  \textcolor{comment}{// Initial creation}}
\DoxyCodeLine{00303   \{}
\DoxyCodeLine{00304     \textcolor{comment}{/*-\/ 新たに作るパーティクルの数だけループ -\/*/}}
\DoxyCodeLine{00305     \textcolor{keywordflow}{for} (i = 0; i < actualBirthParticles; i++) \{}
\DoxyCodeLine{00306       \textcolor{comment}{/*-\/ 出発する粒子 -\/*/}}
\DoxyCodeLine{00307       \mbox{\hyperlink{struct_particle_origin}{ParticleOrigin}} po = particleOrigins.at(leavingPartIndex.at(i));}
\DoxyCodeLine{00308 }
\DoxyCodeLine{00309       \textcolor{comment}{/*-\/  どのTextureレベルを使うか -\/*/}}
\DoxyCodeLine{00310       \textcolor{keywordtype}{int} seed = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00311                        values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00312 }
\DoxyCodeLine{00313       \textcolor{comment}{/*-\/  Lifetimeを得る -\/*/}}
\DoxyCodeLine{00314       \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00315       \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00316         lifetime = lastframe[po.level];}
\DoxyCodeLine{00317       \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00318         lifetime = (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00319                          ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00320       \}}
\DoxyCodeLine{00321       \textcolor{comment}{/*-\/}}
\DoxyCodeLine{00322 \textcolor{comment}{       * この粒子が、レンダリングするフレームでも生きているか判断し、生きているなら生成}}
\DoxyCodeLine{00323 \textcolor{comment}{       * -\/*/}}
\DoxyCodeLine{00324       \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame) \{}
\DoxyCodeLine{00325         myParticles.push\_back(\mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}}(}
\DoxyCodeLine{00326             lifetime, seed, porttiles, values, ranges, totalparticles, 0,}
\DoxyCodeLine{00327             (\textcolor{keywordtype}{int})po.level, lastframe[po.level], po.pos[0],}
\DoxyCodeLine{00328             po.pos[1],               \textcolor{comment}{/*-\/ 座標を指定して発生 -\/*/}}
\DoxyCodeLine{00329             po.isUpward,             \textcolor{comment}{/*-\/ orientation を追加 -\/*/}}
\DoxyCodeLine{00330             (int)po.initSourceFrame) \textcolor{comment}{/*-\/ 素材内の初期フレーム位置 -\/*/}}
\DoxyCodeLine{00331                               );}
\DoxyCodeLine{00332       \}}
\DoxyCodeLine{00333       totalparticles++;}
\DoxyCodeLine{00334     \}}
\DoxyCodeLine{00335   \}}
\DoxyCodeLine{00336   \textcolor{comment}{/*-\/ 既存粒子を動かし、かつ新規粒子を作る -\/*/}}
\DoxyCodeLine{00337   \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00338     std::list<Iwa\_Particle>::iterator it;}
\DoxyCodeLine{00339     \textcolor{keywordflow}{for} (it = myParticles.begin(); it != myParticles.end();) \{}
\DoxyCodeLine{00340       std::list<Iwa\_Particle>::iterator current = it;}
\DoxyCodeLine{00341       ++it;}
\DoxyCodeLine{00342 }
\DoxyCodeLine{00343       \mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}} \&part = (*current);}
\DoxyCodeLine{00344       \textcolor{keywordflow}{if} (part.scale <= 0.0) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00345       \textcolor{keywordflow}{if} (part.lifetime <= 0)        \textcolor{comment}{// Note: This is in line with the above}}
\DoxyCodeLine{00346                                      \textcolor{comment}{// "{}lifetime>curr\_frame-\/frame"{}}}
\DoxyCodeLine{00347         myParticles.erase(current);  \textcolor{comment}{// insertion counterpart}}
\DoxyCodeLine{00348       \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00349         part.move(porttiles, values, ranges, windx, windy, xgravity, ygravity,}
\DoxyCodeLine{00350                   dpi, lastframe[part.level]);}
\DoxyCodeLine{00351       \}}
\DoxyCodeLine{00352     \}}
\DoxyCodeLine{00353 }
\DoxyCodeLine{00354     \textcolor{keywordflow}{switch} (values.toplayer\_val) \{}
\DoxyCodeLine{00355     \textcolor{keywordflow}{case} Iwa\_TiledParticlesFx::TOP\_YOUNGER:}
\DoxyCodeLine{00356       \textcolor{keywordflow}{for} (i = 0; i < actualBirthParticles; i++) \{}
\DoxyCodeLine{00357         \textcolor{comment}{/*-\/ 出発する粒子 -\/*/}}
\DoxyCodeLine{00358         \mbox{\hyperlink{struct_particle_origin}{ParticleOrigin}} po = particleOrigins.at(leavingPartIndex.at(i));}
\DoxyCodeLine{00359 }
\DoxyCodeLine{00360         \textcolor{keywordtype}{int} seed = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00361                          values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00362 }
\DoxyCodeLine{00363         \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00364         \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00365           lifetime = lastframe[po.level];}
\DoxyCodeLine{00366         \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00367           lifetime =}
\DoxyCodeLine{00368               (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00369                     ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00370         \}}
\DoxyCodeLine{00371         \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame) \{}
\DoxyCodeLine{00372           myParticles.push\_front(\mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}}(}
\DoxyCodeLine{00373               lifetime, seed, porttiles, values, ranges, totalparticles, 0,}
\DoxyCodeLine{00374               (\textcolor{keywordtype}{int})po.level, lastframe[po.level], po.pos[0], po.pos[1],}
\DoxyCodeLine{00375               po.isUpward,}
\DoxyCodeLine{00376               (int)po.initSourceFrame) \textcolor{comment}{/*-\/ 素材内の初期フレーム位置 -\/*/}}
\DoxyCodeLine{00377                                  );}
\DoxyCodeLine{00378         \}}
\DoxyCodeLine{00379         totalparticles++;}
\DoxyCodeLine{00380       \}}
\DoxyCodeLine{00381       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00382 }
\DoxyCodeLine{00383     \textcolor{keywordflow}{case} Iwa\_TiledParticlesFx::TOP\_RANDOM:}
\DoxyCodeLine{00384       \textcolor{keywordflow}{for} (i = 0; i < actualBirthParticles; i++) \{}
\DoxyCodeLine{00385         \textcolor{keywordtype}{double} tmp = values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}() * myParticles.size();}
\DoxyCodeLine{00386         std::list<Iwa\_Particle>::iterator it = myParticles.begin();}
\DoxyCodeLine{00387         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < tmp; j++, it++)}
\DoxyCodeLine{00388           ;}
\DoxyCodeLine{00389         \{}
\DoxyCodeLine{00390           \textcolor{comment}{/*-\/ 出発する粒子 -\/*/}}
\DoxyCodeLine{00391           \mbox{\hyperlink{struct_particle_origin}{ParticleOrigin}} po = particleOrigins.at(leavingPartIndex.at(i));}
\DoxyCodeLine{00392 }
\DoxyCodeLine{00393           \textcolor{keywordtype}{int} seed = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00394                            values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00395           \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00396 }
\DoxyCodeLine{00397           \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00398             lifetime = lastframe[po.level];}
\DoxyCodeLine{00399           \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00400             lifetime =}
\DoxyCodeLine{00401                 (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00402                       ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00403           \}}
\DoxyCodeLine{00404           \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame) \{}
\DoxyCodeLine{00405             myParticles.insert(}
\DoxyCodeLine{00406                 it,}
\DoxyCodeLine{00407                 \mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}}(}
\DoxyCodeLine{00408                     lifetime, seed, porttiles, values, ranges, totalparticles,}
\DoxyCodeLine{00409                     0, (\textcolor{keywordtype}{int})po.level, lastframe[po.level], po.pos[0], po.pos[1],}
\DoxyCodeLine{00410                     po.isUpward,}
\DoxyCodeLine{00411                     (int)po.initSourceFrame) \textcolor{comment}{/*-\/ 素材内の初期フレーム位置 -\/*/}}
\DoxyCodeLine{00412                 );}
\DoxyCodeLine{00413           \}}
\DoxyCodeLine{00414           totalparticles++;}
\DoxyCodeLine{00415         \}}
\DoxyCodeLine{00416       \}}
\DoxyCodeLine{00417       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00418 }
\DoxyCodeLine{00419     \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00420       \textcolor{keywordflow}{for} (i = 0; i < actualBirthParticles; i++) \{}
\DoxyCodeLine{00421         \textcolor{comment}{/*-\/ 出発する粒子 -\/*/}}
\DoxyCodeLine{00422         \mbox{\hyperlink{struct_particle_origin}{ParticleOrigin}} po = particleOrigins.at(leavingPartIndex.at(i));}
\DoxyCodeLine{00423 }
\DoxyCodeLine{00424         \textcolor{keywordtype}{int} seed = (int)((std::numeric\_limits<int>::max)() *}
\DoxyCodeLine{00425                          values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00426         \textcolor{keywordtype}{int} lifetime = 0;}
\DoxyCodeLine{00427 }
\DoxyCodeLine{00428         \textcolor{keywordflow}{if} (values.column\_lifetime\_val)}
\DoxyCodeLine{00429           lifetime = lastframe[po.level];}
\DoxyCodeLine{00430         \textcolor{keywordflow}{else}}
\DoxyCodeLine{00431           lifetime =}
\DoxyCodeLine{00432               (int)(values.lifetime\_val.first +}
\DoxyCodeLine{00433                     ranges.lifetime\_range * values.random\_val-\/>\mbox{\hyperlink{class_t_random_a3a7f6b3a8992fcde5b0c5e8bd2049e41}{getFloat}}());}
\DoxyCodeLine{00434         \textcolor{keywordflow}{if} (lifetime > curr\_frame -\/ frame) \{}
\DoxyCodeLine{00435           myParticles.push\_back(\mbox{\hyperlink{class_iwa___particle}{Iwa\_Particle}}(}
\DoxyCodeLine{00436               lifetime, seed, porttiles, values, ranges, totalparticles, 0,}
\DoxyCodeLine{00437               (\textcolor{keywordtype}{int})po.level, lastframe[po.level], po.pos[0], po.pos[1],}
\DoxyCodeLine{00438               po.isUpward,}
\DoxyCodeLine{00439               (int)po.initSourceFrame) \textcolor{comment}{/*-\/  素材内の初期フレーム位置  -\/*/}}
\DoxyCodeLine{00440                                 );}
\DoxyCodeLine{00441         \}}
\DoxyCodeLine{00442         totalparticles++;}
\DoxyCodeLine{00443       \}}
\DoxyCodeLine{00444       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00445     \}}
\DoxyCodeLine{00446   \}}
\DoxyCodeLine{00447 }
\DoxyCodeLine{00448   \textcolor{comment}{/*-\/ すでに発生したparticleOriginを消去する}}
\DoxyCodeLine{00449 \textcolor{comment}{          インデックスを小さい順にならべる -\/*/}}
\DoxyCodeLine{00450   std::sort(leavingPartIndex.begin(), leavingPartIndex.end());}
\DoxyCodeLine{00451   \textcolor{comment}{/*-\/ インデックス大きい方から消していく -\/*/}}
\DoxyCodeLine{00452   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} lp = leavingPartIndex.size() -\/ 1; lp >= 0; lp-\/-\/)}
\DoxyCodeLine{00453     particleOrigins.removeAt(leavingPartIndex.at(lp));}
\DoxyCodeLine{00454 \}}

\end{DoxyCode}


\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{class_iwa___particles___engine_a43b7302085e3306caab8549957a40227}\label{class_iwa___particles___engine_a43b7302085e3306caab8549957a40227}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!m\_frame@{m\_frame}}
\index{m\_frame@{m\_frame}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{m\_frame}{m\_frame}}
{\footnotesize\ttfamily double Iwa\+\_\+\+Particles\+\_\+\+Engine\+::m\+\_\+frame}

\mbox{\Hypertarget{class_iwa___particles___engine_a18b67b6aae45192dd848f999166db708}\label{class_iwa___particles___engine_a18b67b6aae45192dd848f999166db708}} 
\index{Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}!m\_parent@{m\_parent}}
\index{m\_parent@{m\_parent}!Iwa\_Particles\_Engine@{Iwa\_Particles\_Engine}}
\doxysubsubsection{\texorpdfstring{m\_parent}{m\_parent}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_iwa___tiled_particles_fx}{Iwa\+\_\+\+Tiled\+Particles\+Fx}}$\ast$ Iwa\+\_\+\+Particles\+\_\+\+Engine\+::m\+\_\+parent}



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+particlesengine.\+h\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+particlesengine.\+cpp\end{DoxyCompactItemize}
