\hypertarget{class_t_level_writer_tzl}{}\doxysection{TLevel\+Writer\+Tzl Class Reference}
\label{class_t_level_writer_tzl}\index{TLevelWriterTzl@{TLevelWriterTzl}}
Inheritance diagram for TLevel\+Writer\+Tzl\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=3.000000cm]{class_t_level_writer_tzl}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_t_level_writer_tzl_aaa8bf8d9232828c7231a0c7f91faacaa}{TLevel\+Writer\+Tzl}} (const \mbox{\hyperlink{class_t_file_path}{TFile\+Path}} \&path, \mbox{\hyperlink{class_t_property_group}{TProperty\+Group}} $\ast$winfo)
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_a67e9bda1d1213888e101677e9df61496}{set\+Palette}} (\mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$palette) override
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_a3c3bad6d9871bdcc57befa492636b77b}{set\+Overwrite\+Palette\+Flag}} (bool overwrite) override
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_a52b3d608e4f3efea6185df0da82288b3}{renumber\+Fids}} (const std\+::map$<$ \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}}, \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} $>$ \&renumber\+Table) override
\begin{DoxyCompactList}\small\item\em Maps a list of existing level frames to a new list of frames. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_aae9d3879deb37fcc5b6cd8ded0089b4b}{set\+Icon\+Size}} (\mbox{\hyperlink{class_t_dimension_t}{TDimension}} icon\+Size) override
\item 
\mbox{\hyperlink{class_t_dimension_t}{TDimension}} \mbox{\hyperlink{class_t_level_writer_tzl_ad0071cabf4d4c23fbfb64c847677aaa2}{get\+Icon\+Size}} () const override
\item 
\mbox{\hyperlink{class_t_image_writer_p}{TImage\+WriterP}} \mbox{\hyperlink{class_t_level_writer_tzl_a8ac7a3a9170610c78f1aa2d486fc934c}{get\+Frame\+Writer}} (\mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} fid) override
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_ab71207fb203b45c857e1d6d78b65b9b2}{save}} (const \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} \&img)
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_a02e09a8ab99455f1aeb3518501055067}{save}} (const \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} \&img, const \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} \&fid)
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_a3e0e510c90f1b17ecef03a9df85e2480}{save\+Icon}} (const \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} \&img, const \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} \&fid)
\item 
bool \mbox{\hyperlink{class_t_level_writer_tzl_a47766e2b57e1b830af0d4f0cde36d48e}{check\+Icon\+Size}} (const \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&new\+Size)
\begin{DoxyCompactList}\small\item\em Checks the icons size stored inside an already existing level file, and compares it with the specified new\+Size. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{class_t_level_writer_tzl_ac54e00cebbb44364eda8eda05cd046aa}{resize\+Icons}} (const \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&new\+Size)
\item 
void \mbox{\hyperlink{class_t_level_writer_tzl_a912407df1edf71bbd8ab6a643ad4994c}{remove}} (const \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} \&fid)
\item 
float \mbox{\hyperlink{class_t_level_writer_tzl_a014f5fcd43fc973231caff83a1c4aa2a}{get\+Free\+Space}} ()
\item 
bool \mbox{\hyperlink{class_t_level_writer_tzl_aaea2ac5affb123a89dd812b52140fe28}{optimize}} ()
\end{DoxyCompactItemize}
\doxysubsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}} $\ast$ \mbox{\hyperlink{class_t_level_writer_tzl_a48b83f490ee81907fa24a1f47d14d87f}{create}} (const \mbox{\hyperlink{class_t_file_path}{TFile\+Path}} \&f, \mbox{\hyperlink{class_t_property_group}{TProperty\+Group}} $\ast$winfo)
\end{DoxyCompactItemize}
\doxysubsection*{Additional Inherited Members}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_t_level_writer_tzl_aaa8bf8d9232828c7231a0c7f91faacaa}\label{class_t_level_writer_tzl_aaa8bf8d9232828c7231a0c7f91faacaa}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!TLevelWriterTzl@{TLevelWriterTzl}}
\index{TLevelWriterTzl@{TLevelWriterTzl}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{TLevelWriterTzl()}{TLevelWriterTzl()}}
{\footnotesize\ttfamily TLevel\+Writer\+Tzl\+::\+TLevel\+Writer\+Tzl (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_file_path}{TFile\+Path}} \&}]{path,  }\item[{\mbox{\hyperlink{class_t_property_group}{TProperty\+Group}} $\ast$}]{winfo }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00515     : \mbox{\hyperlink{class_t_level_writer}{TLevelWriter}}(path, info)}
\DoxyCodeLine{00516     , m\_headerWritten(\textcolor{keyword}{false})}
\DoxyCodeLine{00517     , m\_creatorWritten(\textcolor{keyword}{false})}
\DoxyCodeLine{00518     , m\_chan(0)}
\DoxyCodeLine{00519     , m\_frameCountPos(0)}
\DoxyCodeLine{00520     , m\_frameCount(0)}
\DoxyCodeLine{00521     , m\_palette(0)}
\DoxyCodeLine{00522     , m\_res(0, 0)}
\DoxyCodeLine{00523     , m\_exists(\textcolor{keyword}{false})}
\DoxyCodeLine{00524     , m\_version(currentVersion())}
\DoxyCodeLine{00525     , m\_updatedIconsSize(\textcolor{keyword}{false})}
\DoxyCodeLine{00526     , m\_currentIconSize(0, 0)}
\DoxyCodeLine{00527     , m\_iconSize(\mbox{\hyperlink{class_t_dimension_t}{TDimension}}(80, 60))}
\DoxyCodeLine{00528     , m\_userIconSize(\mbox{\hyperlink{class_t_dimension_t}{TDimension}}(80, 60))}
\DoxyCodeLine{00529     , m\_adjustRatio(\textcolor{keyword}{false})}
\DoxyCodeLine{00530     , m\_codec(\textcolor{keyword}{new} \mbox{\hyperlink{class_t_raster_codec_l_z_o}{TRasterCodecLZO}}(\textcolor{stringliteral}{"{}LZO"{}}, \textcolor{keyword}{true}))}
\DoxyCodeLine{00531     , m\_overwritePaletteFlag(\textcolor{keyword}{true}) \{}
\DoxyCodeLine{00532   m\_path        = path;}
\DoxyCodeLine{00533   m\_palettePath = path.withNoFrame().\mbox{\hyperlink{class_t_file_path_a1437b0e0720e9258b622f68b6858e95d}{withType}}(\textcolor{stringliteral}{"{}tpl"{}});}
\DoxyCodeLine{00534   \mbox{\hyperlink{class_t_file_status}{TFileStatus}} fs(path);}
\DoxyCodeLine{00535   m\_magic     = (m\_version == 14) ? \textcolor{stringliteral}{"{}TLV14B1a"{}} : \textcolor{stringliteral}{"{}TLV15B1a"{}};  \textcolor{comment}{// actual version}}
\DoxyCodeLine{00536   erasedFrame = \textcolor{keyword}{false};}
\DoxyCodeLine{00537   \textcolor{comment}{// version TLV10B1a: first version}}
\DoxyCodeLine{00538   \textcolor{comment}{// version TLV11B1a: added frameIds}}
\DoxyCodeLine{00539   \textcolor{comment}{// version TLV12B1a: incremental writings}}
\DoxyCodeLine{00540   \textcolor{comment}{// version TLV13B1a: added thumbnails}}
\DoxyCodeLine{00541   \textcolor{comment}{// version TLV14B1a: add creator string (fixed size = CREATOR\_LENGTH char)}}
\DoxyCodeLine{00542   \textcolor{comment}{// version TLV15B1a: support multiple suffixes}}
\DoxyCodeLine{00543 }
\DoxyCodeLine{00544   \textcolor{keywordflow}{if} (fs.doesExist()) \{}
\DoxyCodeLine{00545     \textcolor{comment}{// if (!fs.isWritable())}}
\DoxyCodeLine{00546     m\_chan = fopen(path, \textcolor{stringliteral}{"{}rb+"{}});}
\DoxyCodeLine{00547     \textcolor{comment}{/*-\/-\/-\/ 誰かが開いている、または権限が無いとき -\/-\/-\/*/}}
\DoxyCodeLine{00548     \textcolor{keywordflow}{if} (!m\_chan) \{}
\DoxyCodeLine{00549       \textcolor{keywordflow}{throw} \mbox{\hyperlink{class_t_system_exception}{TSystemException}}(path, \textcolor{stringliteral}{"{}can't fopen."{}});}
\DoxyCodeLine{00550     \}}
\DoxyCodeLine{00551     \textcolor{comment}{/*-\/-\/-\/ TLVファイルのヘッダが正しく読めなかった場合 -\/-\/-\/*/}}
\DoxyCodeLine{00552     \textcolor{keywordflow}{if} (!readHeaderAndOffsets(m\_chan, m\_frameOffsTable, m\_iconOffsTable, m\_res,}
\DoxyCodeLine{00553                               m\_version, m\_creator, \&m\_frameCount,}
\DoxyCodeLine{00554                               \&m\_offsetTablePos, \&m\_iconOffsetTablePos, 0)) \{}
\DoxyCodeLine{00555       \textcolor{keywordflow}{throw} \mbox{\hyperlink{class_t_system_exception}{TSystemException}}(path, \textcolor{stringliteral}{"{}can't readHeaderAndOffsets."{}});}
\DoxyCodeLine{00556     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00557       \textcolor{keywordflow}{if} (m\_version >= 12) buildFreeChunksTable();}
\DoxyCodeLine{00558       m\_headerWritten = \textcolor{keyword}{true};}
\DoxyCodeLine{00559       m\_exists        = \textcolor{keyword}{true};}
\DoxyCodeLine{00560       \textcolor{keywordflow}{if} (m\_version >= 14)}
\DoxyCodeLine{00561         m\_frameCountPos = 8 + CREATOR\_LENGTH + 3 * \textcolor{keyword}{sizeof}(TINT32);}
\DoxyCodeLine{00562       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00563         m\_frameCountPos = 8 + 3 * \textcolor{keyword}{sizeof}(TINT32);}
\DoxyCodeLine{00564     \}}
\DoxyCodeLine{00565   \}}
\DoxyCodeLine{00566   \textcolor{keywordflow}{if} (!m\_exists) \{}
\DoxyCodeLine{00567     \mbox{\hyperlink{class_t_file_path}{TFilePath}} parentDir = path.\mbox{\hyperlink{class_t_file_path_a1f5014e9c396bc2268820c19bc15657d}{getParentDir}}();}
\DoxyCodeLine{00568     \textcolor{keywordflow}{if} (!\mbox{\hyperlink{class_t_file_status}{TFileStatus}}(parentDir).doesExist()) \{}
\DoxyCodeLine{00569       \textcolor{keywordflow}{try} \{}
\DoxyCodeLine{00570         TSystem::mkDir(parentDir);}
\DoxyCodeLine{00571 }
\DoxyCodeLine{00572       \} \textcolor{keywordflow}{catch} (...) \{}
\DoxyCodeLine{00573         \textcolor{keywordflow}{return};}
\DoxyCodeLine{00574       \}}
\DoxyCodeLine{00575     \}}
\DoxyCodeLine{00576     m\_chan = fopen(path, \textcolor{stringliteral}{"{}wb"{}});}
\DoxyCodeLine{00577     \textcolor{keywordflow}{if} (!m\_chan) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00578     \textcolor{keywordflow}{if} (!writeVersionAndCreator(m\_chan, m\_magic, m\_creator)) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00579   \}}
\DoxyCodeLine{00580 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_aa0ca0b191422693160c34e9cb3d9dca1}\label{class_t_level_writer_tzl_aa0ca0b191422693160c34e9cb3d9dca1}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!````~TLevelWriterTzl@{$\sim$TLevelWriterTzl}}
\index{````~TLevelWriterTzl@{$\sim$TLevelWriterTzl}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{$\sim$TLevelWriterTzl()}{~TLevelWriterTzl()}}
{\footnotesize\ttfamily TLevel\+Writer\+Tzl\+::$\sim$\+TLevel\+Writer\+Tzl (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00584                                   \{}
\DoxyCodeLine{00585   \textcolor{keywordflow}{if} (m\_version < currentVersion()) \{}
\DoxyCodeLine{00586     \textcolor{keywordflow}{if} (!convertToLatestVersion()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00587     assert(m\_version == currentVersion());}
\DoxyCodeLine{00588   \}}
\DoxyCodeLine{00589   \textcolor{keyword}{delete} m\_codec;}
\DoxyCodeLine{00590 }
\DoxyCodeLine{00591   TINT32 offsetMapPos     = 0;}
\DoxyCodeLine{00592   TINT32 iconOffsetMapPos = 0;}
\DoxyCodeLine{00593   \textcolor{keywordflow}{if} (!m\_chan) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00594 }
\DoxyCodeLine{00595   assert(m\_frameCount == (\textcolor{keywordtype}{int})m\_frameOffsTable.size());}
\DoxyCodeLine{00596   assert(m\_frameCount == (\textcolor{keywordtype}{int})m\_iconOffsTable.size());}
\DoxyCodeLine{00597 }
\DoxyCodeLine{00598   offsetMapPos = (m\_exists ? m\_offsetTablePos : ftell(m\_chan));}
\DoxyCodeLine{00599   fseek(m\_chan, offsetMapPos, SEEK\_SET);}
\DoxyCodeLine{00600 }
\DoxyCodeLine{00601   TzlOffsetMap::iterator it = m\_frameOffsTable.begin();}
\DoxyCodeLine{00602   \textcolor{keywordflow}{for} (; it != m\_frameOffsTable.end(); ++it) \{}
\DoxyCodeLine{00603     \mbox{\hyperlink{class_t_frame_id}{TFrameId}} fid      = it-\/>first;}
\DoxyCodeLine{00604     TINT32 num        = fid.getNumber();}
\DoxyCodeLine{00605     QByteArray suffix = fid.getLetter().toUtf8();}
\DoxyCodeLine{00606     TINT32 offs       = it-\/>second.m\_offs;}
\DoxyCodeLine{00607     TINT32 length     = it-\/>second.m\_length;}
\DoxyCodeLine{00608     tfwrite(\&num, 1, m\_chan);}
\DoxyCodeLine{00609     \textcolor{keywordflow}{if} (m\_version >= 15) \{  \textcolor{comment}{// write the suffix length before data}}
\DoxyCodeLine{00610       TINT32 suffixLength = suffix.size();}
\DoxyCodeLine{00611       tfwrite(\&suffixLength, 1, m\_chan);}
\DoxyCodeLine{00612       tfwrite(suffix.constData(), suffixLength, m\_chan);}
\DoxyCodeLine{00613     \} \textcolor{keywordflow}{else}  \textcolor{comment}{// write only the first byte}}
\DoxyCodeLine{00614       tfwrite(suffix.constData(), 1, m\_chan);}
\DoxyCodeLine{00615     tfwrite(\&offs, 1, m\_chan);}
\DoxyCodeLine{00616     tfwrite(\&length, 1, m\_chan);}
\DoxyCodeLine{00617   \}}
\DoxyCodeLine{00618 }
\DoxyCodeLine{00619   \textcolor{comment}{// Write Icon Offset Table after frameOffsTable}}
\DoxyCodeLine{00620   iconOffsetMapPos =}
\DoxyCodeLine{00621       ftell(m\_chan);  \textcolor{comment}{//(m\_exists?m\_iconOffsetTablePos: ftell(m\_chan));}}
\DoxyCodeLine{00622   fseek(m\_chan, iconOffsetMapPos, SEEK\_SET);}
\DoxyCodeLine{00623 }
\DoxyCodeLine{00624   TzlOffsetMap::iterator iconIt = m\_iconOffsTable.begin();}
\DoxyCodeLine{00625   \textcolor{keywordflow}{for} (; iconIt != m\_iconOffsTable.end(); ++iconIt) \{}
\DoxyCodeLine{00626     \mbox{\hyperlink{class_t_frame_id}{TFrameId}} fid           = iconIt-\/>first;}
\DoxyCodeLine{00627     TINT32 num             = fid.getNumber();}
\DoxyCodeLine{00628     QByteArray suffix      = fid.getLetter().toUtf8();}
\DoxyCodeLine{00629     TINT32 thumbnailOffs   = iconIt-\/>second.m\_offs;}
\DoxyCodeLine{00630     TINT32 thumbnailLength = iconIt-\/>second.m\_length;}
\DoxyCodeLine{00631     tfwrite(\&num, 1, m\_chan);}
\DoxyCodeLine{00632     \textcolor{keywordflow}{if} (m\_version >= 15) \{  \textcolor{comment}{// write the suffix length before data}}
\DoxyCodeLine{00633       TINT32 suffixLength = suffix.size();}
\DoxyCodeLine{00634       tfwrite(\&suffixLength, 1, m\_chan);}
\DoxyCodeLine{00635       tfwrite(suffix.constData(), suffixLength, m\_chan);}
\DoxyCodeLine{00636     \} \textcolor{keywordflow}{else}  \textcolor{comment}{// write only the first byte}}
\DoxyCodeLine{00637       tfwrite(suffix.constData(), 1, m\_chan);}
\DoxyCodeLine{00638     tfwrite(\&thumbnailOffs, 1, m\_chan);}
\DoxyCodeLine{00639     tfwrite(\&thumbnailLength, 1, m\_chan);}
\DoxyCodeLine{00640   \}}
\DoxyCodeLine{00641 }
\DoxyCodeLine{00642   fseek(m\_chan, m\_frameCountPos, SEEK\_SET);}
\DoxyCodeLine{00643   TINT32 frameCount = m\_frameCount;}
\DoxyCodeLine{00644 }
\DoxyCodeLine{00645   tfwrite(\&frameCount, 1, m\_chan);}
\DoxyCodeLine{00646   tfwrite(\&offsetMapPos, 1, m\_chan);}
\DoxyCodeLine{00647   tfwrite(\&iconOffsetMapPos, 1, m\_chan);}
\DoxyCodeLine{00648   fclose(m\_chan);}
\DoxyCodeLine{00649   m\_chan = 0;}
\DoxyCodeLine{00650 }
\DoxyCodeLine{00651   \textcolor{keywordflow}{if} (m\_palette \&\& m\_overwritePaletteFlag \&\&}
\DoxyCodeLine{00652       (m\_palette-\/>\mbox{\hyperlink{class_t_palette_a4e573ec80c4779bcdb543e4b743a8c34}{getDirtyFlag}}() ||}
\DoxyCodeLine{00653        !TSystem::doesExistFileOrLevel(m\_palettePath))) \{}
\DoxyCodeLine{00654     \mbox{\hyperlink{class_t_o_stream}{TOStream}} os(m\_palettePath);}
\DoxyCodeLine{00655     os << m\_palette;}
\DoxyCodeLine{00656     m\_palette-\/>release();}
\DoxyCodeLine{00657   \}}
\DoxyCodeLine{00658 }
\DoxyCodeLine{00659   \textcolor{keywordflow}{if} (m\_contentHistory) \{}
\DoxyCodeLine{00660     \mbox{\hyperlink{class_t_file_path}{TFilePath}} historyFp = m\_path.withNoFrame().\mbox{\hyperlink{class_t_file_path_a1437b0e0720e9258b622f68b6858e95d}{withType}}(\textcolor{stringliteral}{"{}hst"{}});}
\DoxyCodeLine{00661     FILE *historyChan   = fopen(historyFp, \textcolor{stringliteral}{"{}w"{}});}
\DoxyCodeLine{00662     \textcolor{keywordflow}{if} (historyChan) \{}
\DoxyCodeLine{00663       std::string historyData = m\_contentHistory-\/>\mbox{\hyperlink{class_t_content_history_aac53dd08c6fc7fa07ba1c8c5beb51131}{serialize}}().toStdString();}
\DoxyCodeLine{00664       fwrite(\&historyData[0], 1, historyData.length(), historyChan);}
\DoxyCodeLine{00665       fclose(historyChan);}
\DoxyCodeLine{00666     \}}
\DoxyCodeLine{00667   \}}
\DoxyCodeLine{00668   \textcolor{comment}{// Se lo spazio libero (cioè la somma di tutti i buchi che si sono creati tra}}
\DoxyCodeLine{00669   \textcolor{comment}{// i frame)}}
\DoxyCodeLine{00670   \textcolor{comment}{// è maggiore di una certa soglia oppure è stato rimosso almeno un frame}}
\DoxyCodeLine{00671   \textcolor{comment}{// allora ottimizzo il file}}
\DoxyCodeLine{00672   \textcolor{comment}{// (in pratica risalvo il file da capo senza buchi).}}
\DoxyCodeLine{00673   \textcolor{keywordflow}{if} (\mbox{\hyperlink{class_t_level_writer_tzl_a014f5fcd43fc973231caff83a1c4aa2a}{getFreeSpace}}() > 0.3 || erasedFrame) \mbox{\hyperlink{class_t_level_writer_tzl_aaea2ac5affb123a89dd812b52140fe28}{optimize}}();}
\DoxyCodeLine{00674 \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_t_level_writer_tzl_a47766e2b57e1b830af0d4f0cde36d48e}\label{class_t_level_writer_tzl_a47766e2b57e1b830af0d4f0cde36d48e}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!checkIconSize@{checkIconSize}}
\index{checkIconSize@{checkIconSize}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{checkIconSize()}{checkIconSize()}}
{\footnotesize\ttfamily bool TLevel\+Writer\+Tzl\+::check\+Icon\+Size (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&}]{new\+Size }\end{DoxyParamCaption})}



Checks the icons size stored inside an already existing level file, and compares it with the specified new\+Size. 

\begin{DoxyReturn}{Returns}
Whether the specified new\+Size {\itshape matches} the icons size in the level file. 
\end{DoxyReturn}

\begin{DoxyCode}{0}
\DoxyCodeLine{01288                                                              \{}
\DoxyCodeLine{01289   assert(m\_version >= 13);}
\DoxyCodeLine{01290 }
\DoxyCodeLine{01291   \textcolor{keywordflow}{if} (!m\_exists || m\_iconOffsTable.empty() || !m\_chan || m\_version < 13)}
\DoxyCodeLine{01292     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01293 }
\DoxyCodeLine{01294   \textcolor{comment}{// Read the size of icons in the file}}
\DoxyCodeLine{01295   TINT32 iconLx = 0, iconLy = 0;}
\DoxyCodeLine{01296 }
\DoxyCodeLine{01297   \textcolor{keywordtype}{long} currentPos =}
\DoxyCodeLine{01298       ftell(m\_chan);  \textcolor{comment}{// Backup current reading position in the file}}
\DoxyCodeLine{01299 }
\DoxyCodeLine{01300   TzlOffsetMap::iterator it = m\_iconOffsTable.begin();}
\DoxyCodeLine{01301   \textcolor{keywordtype}{long} offs                 = it-\/>second.m\_offs;}
\DoxyCodeLine{01302 }
\DoxyCodeLine{01303   fseek(m\_chan, offs, SEEK\_SET);}
\DoxyCodeLine{01304 }
\DoxyCodeLine{01305   fread(\&iconLx, \textcolor{keyword}{sizeof}(TINT32), 1, m\_chan);}
\DoxyCodeLine{01306   fread(\&iconLy, \textcolor{keyword}{sizeof}(TINT32), 1, m\_chan);}
\DoxyCodeLine{01307 }
\DoxyCodeLine{01308   fseek(m\_chan, currentPos,}
\DoxyCodeLine{01309         SEEK\_SET);  \textcolor{comment}{// Reset to the original position in the file}}
\DoxyCodeLine{01310 }
\DoxyCodeLine{01311   assert(iconLx > 0 \&\& iconLy > 0);}
\DoxyCodeLine{01312   \textcolor{keywordflow}{if} (iconLx <= 0 || iconLy <= 0 || iconLx > m\_res.lx || iconLy > m\_res.ly)}
\DoxyCodeLine{01313     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01314 }
\DoxyCodeLine{01315   m\_currentIconSize = \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(}
\DoxyCodeLine{01316       iconLx, iconLy);  \textcolor{comment}{// This is not performed if the above pre-\/emptive}}
\DoxyCodeLine{01317                         \textcolor{comment}{// bailout kicks in. BTW, m\_currentIconSize}}
\DoxyCodeLine{01318                         \textcolor{comment}{// is currently UNUSED! Should be cleaned up...}}
\DoxyCodeLine{01319   \textcolor{comment}{// Compare newSize against read icon size in the file}}
\DoxyCodeLine{01320   \textcolor{keywordflow}{return} (m\_currentIconSize == newSize);}
\DoxyCodeLine{01321 \}}

\end{DoxyCode}


Referenced by \mbox{\hyperlink{l01254}{set\+Icon\+Size()}}.

\mbox{\Hypertarget{class_t_level_writer_tzl_a48b83f490ee81907fa24a1f47d14d87f}\label{class_t_level_writer_tzl_a48b83f490ee81907fa24a1f47d14d87f}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!create@{create}}
\index{create@{create}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{create()}{create()}}
{\footnotesize\ttfamily static \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}} $\ast$ TLevel\+Writer\+Tzl\+::create (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_file_path}{TFile\+Path}} \&}]{f,  }\item[{\mbox{\hyperlink{class_t_property_group}{TProperty\+Group}} $\ast$}]{winfo }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00111                                                                          \{}
\DoxyCodeLine{00112     \textcolor{keywordflow}{return} \textcolor{keyword}{new} \mbox{\hyperlink{class_t_level_writer_tzl}{TLevelWriterTzl}}(f, winfo);}
\DoxyCodeLine{00113   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_a8ac7a3a9170610c78f1aa2d486fc934c}\label{class_t_level_writer_tzl_a8ac7a3a9170610c78f1aa2d486fc934c}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!getFrameWriter@{getFrameWriter}}
\index{getFrameWriter@{getFrameWriter}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{getFrameWriter()}{getFrameWriter()}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_image_writer_p}{TImage\+WriterP}} TLevel\+Writer\+Tzl\+::get\+Frame\+Writer (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}}}]{fid }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Reimplemented from \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00678                                                           \{}
\DoxyCodeLine{00679   \textcolor{keywordflow}{return} \textcolor{keyword}{new} \mbox{\hyperlink{class_t_image_writer_tzl}{TImageWriterTzl}}(\textcolor{keyword}{this}, fid);}
\DoxyCodeLine{00680 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_a014f5fcd43fc973231caff83a1c4aa2a}\label{class_t_level_writer_tzl_a014f5fcd43fc973231caff83a1c4aa2a}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!getFreeSpace@{getFreeSpace}}
\index{getFreeSpace@{getFreeSpace}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{getFreeSpace()}{getFreeSpace()}}
{\footnotesize\ttfamily float TLevel\+Writer\+Tzl\+::get\+Free\+Space (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

\begin{DoxyVerb}  Da informazioni relativamente allo spazio libero presente su file.
  Ritorna un numero compreso tra 0 e 1: 0 nessuno spazio libero, 1
\end{DoxyVerb}
 tutto lo spazio è libero. 
\begin{DoxyCode}{0}
\DoxyCodeLine{01388                                     \{}
\DoxyCodeLine{01389   \textcolor{keywordflow}{if} (m\_exists \&\& m\_version >= 13) \{}
\DoxyCodeLine{01390     TINT32 freeSpace                = 0;}
\DoxyCodeLine{01391     std::set<TzlChunk>::iterator it = m\_freeChunks.begin();}
\DoxyCodeLine{01392     \textcolor{keywordflow}{for} (; it != m\_freeChunks.end(); ++it) freeSpace += it-\/>m\_length;}
\DoxyCodeLine{01393 }
\DoxyCodeLine{01394     TINT32 totalSpace = 0;}
\DoxyCodeLine{01395     if (m\_version == 13)}
\DoxyCodeLine{01396       totalSpace = m\_offsetTablePos -\/ 6 * \textcolor{keyword}{sizeof}(TINT32) -\/ 4 * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) -\/}
\DoxyCodeLine{01397                    8 * \textcolor{keyword}{sizeof}(char);}
\DoxyCodeLine{01398     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (m\_version >= 14)}
\DoxyCodeLine{01399       totalSpace = m\_offsetTablePos -\/ 6 * \textcolor{keyword}{sizeof}(TINT32) -\/ 4 * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}) -\/}
\DoxyCodeLine{01400                    8 * \textcolor{keyword}{sizeof}(char) -\/ CREATOR\_LENGTH * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char});}
\DoxyCodeLine{01401     assert(totalSpace > 0);}
\DoxyCodeLine{01402     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{float})freeSpace / totalSpace;}
\DoxyCodeLine{01403   \}}
\DoxyCodeLine{01404   \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{01405 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_ad0071cabf4d4c23fbfb64c847677aaa2}\label{class_t_level_writer_tzl_ad0071cabf4d4c23fbfb64c847677aaa2}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!getIconSize@{getIconSize}}
\index{getIconSize@{getIconSize}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{getIconSize()}{getIconSize()}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_dimension_t}{TDimension}} TLevel\+Writer\+Tzl\+::get\+Icon\+Size (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption}) const\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [virtual]}}



Reimplemented from \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00080 \{ \textcolor{keywordflow}{return} m\_iconSize; \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_aaea2ac5affb123a89dd812b52140fe28}\label{class_t_level_writer_tzl_aaea2ac5affb123a89dd812b52140fe28}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!optimize@{optimize}}
\index{optimize@{optimize}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{optimize()}{optimize()}}
{\footnotesize\ttfamily bool TLevel\+Writer\+Tzl\+::optimize (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

Save the file without free\+Space. Salva tutti i frame in maniera continua, senza buchi. Return TRUE if successfully. 
\begin{DoxyCode}{0}
\DoxyCodeLine{01407                                \{}
\DoxyCodeLine{01408   \mbox{\hyperlink{class_t_file_status}{TFileStatus}} fs(m\_path);}
\DoxyCodeLine{01409   assert(fs.doesExist());}
\DoxyCodeLine{01410 }
\DoxyCodeLine{01411   std::string tempName = \textcolor{stringliteral}{"{}\string~"{}} + m\_path.\mbox{\hyperlink{class_t_file_path_af94f9b0aeceb6cdb980fa1789473503a}{getName}}() + \textcolor{stringliteral}{"{}tmp\&.tlv"{}};}
\DoxyCodeLine{01412   \mbox{\hyperlink{class_t_file_path}{TFilePath}} tempPath =}
\DoxyCodeLine{01413       TSystem::getTempDir() + tempName;  \textcolor{comment}{// Path temporaneo del file ottimizzato}}
\DoxyCodeLine{01414 }
\DoxyCodeLine{01415   \textcolor{keywordflow}{if} (TSystem::doesExistFileOrLevel(tempPath)) TSystem::deleteFile(tempPath);}
\DoxyCodeLine{01416 }
\DoxyCodeLine{01417   \mbox{\hyperlink{class_t_level_writer_p}{TLevelWriterP}} lw(tempPath);}
\DoxyCodeLine{01418 }
\DoxyCodeLine{01419   \mbox{\hyperlink{class_t_level_reader_p}{TLevelReaderP}} lr(m\_path);}
\DoxyCodeLine{01420   lw-\/>setIconSize(m\_userIconSize);}
\DoxyCodeLine{01421   \mbox{\hyperlink{class_t_level_p}{TLevelP}} level = lr-\/>loadInfo();}
\DoxyCodeLine{01422   \textcolor{keywordflow}{if} (!level || level-\/>getFrameCount() == 0) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01423   TLevel::Iterator levelIt = level-\/>begin();}
\DoxyCodeLine{01424   \textcolor{keywordflow}{for} (; levelIt != level-\/>end(); ++levelIt) \{}
\DoxyCodeLine{01425     \mbox{\hyperlink{class_t_toonz_image_p}{TToonzImageP}} img = lr-\/>getFrameReader(levelIt-\/>first)-\/>load();}
\DoxyCodeLine{01426     assert(img);}
\DoxyCodeLine{01427     lw-\/>getFrameWriter(levelIt-\/>first)-\/>save(img);}
\DoxyCodeLine{01428   \}}
\DoxyCodeLine{01429   lr = \mbox{\hyperlink{class_t_level_reader_p}{TLevelReaderP}}();}
\DoxyCodeLine{01430   lw = \mbox{\hyperlink{class_t_level_writer_p}{TLevelWriterP}}();}
\DoxyCodeLine{01431 }
\DoxyCodeLine{01432   \textcolor{comment}{// Se il file tempPath (ottimizzato) è stato creato}}
\DoxyCodeLine{01433   \textcolor{comment}{// lo copio sostituendolo ad m\_path}}
\DoxyCodeLine{01434   \textcolor{keywordflow}{if} (TSystem::doesExistFileOrLevel(tempPath)) \{}
\DoxyCodeLine{01435     assert(m\_path != tempPath);}
\DoxyCodeLine{01436     \textcolor{keywordflow}{if} (TSystem::doesExistFileOrLevel(m\_path))}
\DoxyCodeLine{01437       TSystem::deleteFile(m\_path);  \textcolor{comment}{// Cancello il file non ottimizzato}}
\DoxyCodeLine{01438     TSystem::copyFile(m\_path, tempPath);}
\DoxyCodeLine{01439     TSystem::deleteFile(tempPath);}
\DoxyCodeLine{01440   \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{01441     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01442   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{01443 \}}

\end{DoxyCode}


References \mbox{\hyperlink{l00636}{TFile\+Path\+::get\+Name()}}.

\mbox{\Hypertarget{class_t_level_writer_tzl_a912407df1edf71bbd8ab6a643ad4994c}\label{class_t_level_writer_tzl_a912407df1edf71bbd8ab6a643ad4994c}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!remove@{remove}}
\index{remove@{remove}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{remove()}{remove()}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::remove (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} \&}]{fid }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01227                                                 \{}
\DoxyCodeLine{01228   TzlOffsetMap::iterator it = m\_frameOffsTable.find(fid);}
\DoxyCodeLine{01229   \textcolor{comment}{// se il fid non esiste non faccio nulla}}
\DoxyCodeLine{01230   \textcolor{keywordflow}{if} (it == m\_frameOffsTable.end()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01231   \textcolor{comment}{// aggiungo spazio vuoto}}
\DoxyCodeLine{01232   \textcolor{comment}{// m\_freeChunks.insert(TzlChunk(it-\/>second.m\_offs, it-\/>second.m\_length));}}
\DoxyCodeLine{01233   addFreeChunk(it-\/>second.m\_offs, it-\/>second.m\_length);}
\DoxyCodeLine{01234   \textcolor{comment}{// cancello l'immagine dalla tabella}}
\DoxyCodeLine{01235   m\_frameOffsTable.erase(it);}
\DoxyCodeLine{01236 }
\DoxyCodeLine{01237   \textcolor{keywordflow}{if} (m\_iconOffsTable.size() > 0) \{}
\DoxyCodeLine{01238     TzlOffsetMap::iterator iconIt = m\_iconOffsTable.find(fid);}
\DoxyCodeLine{01239     \textcolor{comment}{// deve necessariamente esserci anche l'iconcina}}
\DoxyCodeLine{01240     assert(iconIt != m\_iconOffsTable.end());}
\DoxyCodeLine{01241     \textcolor{keywordflow}{if} (iconIt == m\_iconOffsTable.end()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01242     \textcolor{comment}{// aggiungo spazio vuoto}}
\DoxyCodeLine{01243     \textcolor{comment}{// m\_freeChunks.insert(TzlChunk(iconIt-\/>second.m\_offs,}}
\DoxyCodeLine{01244     \textcolor{comment}{// iconIt-\/>second.m\_length));}}
\DoxyCodeLine{01245     addFreeChunk(iconIt-\/>second.m\_offs, iconIt-\/>second.m\_length);}
\DoxyCodeLine{01246     \textcolor{comment}{// Cancello la relativa icona}}
\DoxyCodeLine{01247     m\_iconOffsTable.erase(iconIt);}
\DoxyCodeLine{01248     erasedFrame = \textcolor{keyword}{true};}
\DoxyCodeLine{01249   \}}
\DoxyCodeLine{01250 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_a52b3d608e4f3efea6185df0da82288b3}\label{class_t_level_writer_tzl_a52b3d608e4f3efea6185df0da82288b3}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!renumberFids@{renumberFids}}
\index{renumberFids@{renumberFids}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{renumberFids()}{renumberFids()}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::renumber\+Fids (\begin{DoxyParamCaption}\item[{const std\+::map$<$ \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}}, \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} $>$ \&}]{table }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Maps a list of existing level frames to a new list of frames. 

This function allows an existing level to reorganize (or discard) its {\itshape disk} content. It is typically implemented by TLevel\+Writers that support {\itshape  random access writing \texorpdfstring{$<$}{<}\textbackslash{}I\texorpdfstring{$>$}{>}, which can therefore write new frames on top of an existing level. ~\newline
~\newline
This function requires that frames present on disk {\itshape and} in the table be remapped, while frames on disk {\itshape not} in the table be {\bfseries{deleted}}. Eventual frames present in the table but not on disk are ignored. ~\newline
~\newline
The default implementation provides renumbering for standard Toonz multi-\/file level types (level\+Name.\#\#\#\#c.\+ext), and does nothing if the specified path is not compatible with the multi-\/file format. }

Reimplemented from \mbox{\hyperlink{class_t_level_writer_aa060a07f822355ccb029882f437407b9}{TLevel\+Writer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{01124                                                      \{}
\DoxyCodeLine{01125   m\_renumberTable = renumberTable;}
\DoxyCodeLine{01126   \textcolor{keywordflow}{if} (m\_version < 13) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01127   \textcolor{keywordflow}{if} (m\_frameOffsTable.empty() || !m\_exists) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01128 }
\DoxyCodeLine{01129   \textcolor{comment}{// Rimozione dei frame non presenti nella prima colonna di renumberTable}}
\DoxyCodeLine{01130   std::map<TFrameId, TzlChunk> frameOffsTableTemp;}
\DoxyCodeLine{01131   frameOffsTableTemp        = m\_frameOffsTable;}
\DoxyCodeLine{01132   TzlOffsetMap::iterator it = frameOffsTableTemp.begin();}
\DoxyCodeLine{01133   \textcolor{keywordflow}{while} (it != frameOffsTableTemp.end()) \{}
\DoxyCodeLine{01134     \mbox{\hyperlink{class_t_frame_id}{TFrameId}} fid                                     = it-\/>first;}
\DoxyCodeLine{01135     std::map<TFrameId, TFrameId>::const\_iterator it2 = renumberTable.find(fid);}
\DoxyCodeLine{01136     \textcolor{keywordflow}{if} (it2 == renumberTable.end()) remove(fid);}
\DoxyCodeLine{01137     it++;}
\DoxyCodeLine{01138   \}}
\DoxyCodeLine{01139 }
\DoxyCodeLine{01140   std::map<TFrameId, TzlChunk> frameOffsTable, iconOffsTable;}
\DoxyCodeLine{01141   \textcolor{comment}{// Renumber Frame}}
\DoxyCodeLine{01142   std::map<TFrameId, TFrameId>::const\_iterator it3 = renumberTable.begin();}
\DoxyCodeLine{01143   \textcolor{keywordflow}{while} (it3 != renumberTable.end()) \{}
\DoxyCodeLine{01144     \mbox{\hyperlink{class_t_frame_id}{TFrameId}} fidToRenumber        = it3-\/>first;}
\DoxyCodeLine{01145     TzlOffsetMap::iterator it     = m\_frameOffsTable.find(fidToRenumber);}
\DoxyCodeLine{01146     TzlOffsetMap::iterator iconIt = m\_iconOffsTable.find(fidToRenumber);}
\DoxyCodeLine{01147     \textcolor{keywordflow}{if} (it != m\_frameOffsTable.end()) frameOffsTable[it3-\/>second] = it-\/>second;}
\DoxyCodeLine{01148     \textcolor{keywordflow}{if} (m\_iconOffsTable.size() > 0 \&\& iconIt != m\_iconOffsTable.end())}
\DoxyCodeLine{01149       iconOffsTable[it3-\/>second] = iconIt-\/>second;}
\DoxyCodeLine{01150     it3++;}
\DoxyCodeLine{01151   \}}
\DoxyCodeLine{01152 }
\DoxyCodeLine{01153   m\_frameOffsTable.clear();}
\DoxyCodeLine{01154   m\_frameOffsTable = frameOffsTable;}
\DoxyCodeLine{01155   m\_iconOffsTable.clear();}
\DoxyCodeLine{01156   m\_iconOffsTable = iconOffsTable;}
\DoxyCodeLine{01157   m\_frameCount    = m\_frameOffsTable.size();}
\DoxyCodeLine{01158   \textcolor{comment}{// buildFreeChunksTable();}}
\DoxyCodeLine{01159 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_ac54e00cebbb44364eda8eda05cd046aa}\label{class_t_level_writer_tzl_ac54e00cebbb44364eda8eda05cd046aa}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!resizeIcons@{resizeIcons}}
\index{resizeIcons@{resizeIcons}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{resizeIcons()}{resizeIcons()}}
{\footnotesize\ttfamily bool TLevel\+Writer\+Tzl\+::resize\+Icons (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_dimension_t}{TDimension}} \&}]{new\+Size }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01325                                                            \{}
\DoxyCodeLine{01326   \textcolor{keywordflow}{if} (!m\_exists) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01327   \textcolor{keywordflow}{if} (m\_iconOffsTable.empty()) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01328   \textcolor{keywordflow}{if} (!m\_chan) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01329   assert(m\_version >= 13);}
\DoxyCodeLine{01330 }
\DoxyCodeLine{01331   \textcolor{comment}{// faccio una copia di m\_path per poi usarla per la resizeIcons()}}
\DoxyCodeLine{01332   fclose(m\_chan);}
\DoxyCodeLine{01333   m\_chan = 0;}
\DoxyCodeLine{01334   \mbox{\hyperlink{class_t_file_status}{TFileStatus}} fs(m\_path);}
\DoxyCodeLine{01335   assert(fs.doesExist());}
\DoxyCodeLine{01336   \textcolor{keywordflow}{if} (!fs.doesExist()) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01337   std::string tempName = \textcolor{stringliteral}{"{}\string~"{}} + m\_path.\mbox{\hyperlink{class_t_file_path_af94f9b0aeceb6cdb980fa1789473503a}{getName}}() + \textcolor{stringliteral}{"{}tmpIcon\&.tlv"{}};}
\DoxyCodeLine{01338   \mbox{\hyperlink{class_t_file_path}{TFilePath}} tempPath   = TSystem::getTempDir() + tempName;}
\DoxyCodeLine{01339   \textcolor{keywordflow}{if} (TSystem::doesExistFileOrLevel(m\_path)) \{}
\DoxyCodeLine{01340     assert(m\_path != tempPath);}
\DoxyCodeLine{01341     \textcolor{keywordflow}{if} (TSystem::doesExistFileOrLevel(tempPath)) TSystem::deleteFile(tempPath);}
\DoxyCodeLine{01342     TSystem::copyFile(tempPath, m\_path);}
\DoxyCodeLine{01343   \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{01344     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01345   m\_chan = fopen(m\_path, \textcolor{stringliteral}{"{}rb+"{}});}
\DoxyCodeLine{01346   assert(m\_chan);}
\DoxyCodeLine{01347 }
\DoxyCodeLine{01348   assert(TSystem::doesExistFileOrLevel(tempPath));}
\DoxyCodeLine{01349   \textcolor{keywordflow}{if} (!TSystem::doesExistFileOrLevel(tempPath)) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01350   \mbox{\hyperlink{class_t_level_reader_p}{TLevelReaderP}} lr(tempPath);}
\DoxyCodeLine{01351   \mbox{\hyperlink{class_t_level_p}{TLevelP}} level = lr-\/>loadInfo();}
\DoxyCodeLine{01352   \textcolor{comment}{/*}}
\DoxyCodeLine{01353 \textcolor{comment}{  if(m\_currentIconSize.lx>newSize.lx \&\& m\_currentIconSize.ly>newSize.ly)}}
\DoxyCodeLine{01354 \textcolor{comment}{  \{}}
\DoxyCodeLine{01355 \textcolor{comment}{          for(TLevel::Iterator it=level-\/>begin(); it != level-\/>end(); ++it)}}
\DoxyCodeLine{01356 \textcolor{comment}{          \{}}
\DoxyCodeLine{01357 \textcolor{comment}{                  TImageReaderP ir = lr-\/>getFrameReader(it-\/>first);}}
\DoxyCodeLine{01358 \textcolor{comment}{}}
\DoxyCodeLine{01359 \textcolor{comment}{                  // carico l'iconcina}}
\DoxyCodeLine{01360 \textcolor{comment}{            TImageP img = ir-\/>loadIcon();}}
\DoxyCodeLine{01361 \textcolor{comment}{                  TImageP icon;}}
\DoxyCodeLine{01362 \textcolor{comment}{                  createIcon(img,icon);}}
\DoxyCodeLine{01363 \textcolor{comment}{                  saveIcon(icon,it-\/>first);}}
\DoxyCodeLine{01364 \textcolor{comment}{          \}}}
\DoxyCodeLine{01365 \textcolor{comment}{  \}}}
\DoxyCodeLine{01366 \textcolor{comment}{  else}}
\DoxyCodeLine{01367 \textcolor{comment}{  \{              */}}
\DoxyCodeLine{01368   \textcolor{comment}{// leggo tutte le immagini da file e creo le iconcine da da zero}}
\DoxyCodeLine{01369   \textcolor{keywordflow}{for} (TLevel::Iterator it = level-\/>begin(); it != level-\/>end(); ++it) \{}
\DoxyCodeLine{01370     \textcolor{comment}{// carico l'iconcina}}
\DoxyCodeLine{01371     \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} img = lr-\/>getFrameReader(it-\/>first)-\/>load();}
\DoxyCodeLine{01372     \textcolor{comment}{// creo e salvo}}
\DoxyCodeLine{01373     \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} icon;}
\DoxyCodeLine{01374     createIcon(img, icon);}
\DoxyCodeLine{01375     saveIcon(icon, it-\/>first);}
\DoxyCodeLine{01376   \}}
\DoxyCodeLine{01377 }
\DoxyCodeLine{01378   \textcolor{comment}{//\}}}
\DoxyCodeLine{01379   lr = \mbox{\hyperlink{class_t_level_reader_p}{TLevelReaderP}}();}
\DoxyCodeLine{01380   \textcolor{comment}{// delete m\_tempPath}}
\DoxyCodeLine{01381   \textcolor{keywordflow}{if} (TSystem::doesExistFileOrLevel(tempPath)) \{}
\DoxyCodeLine{01382     TSystem::deleteFile(tempPath);}
\DoxyCodeLine{01383   \}}
\DoxyCodeLine{01384 }
\DoxyCodeLine{01385   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{01386 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_ab71207fb203b45c857e1d6d78b65b9b2}\label{class_t_level_writer_tzl_ab71207fb203b45c857e1d6d78b65b9b2}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!save@{save}}
\index{save@{save}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{save()}{save()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::save (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} \&}]{img }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01108 \{ doSave(img, \mbox{\hyperlink{class_t_frame_id}{TFrameId}}()); \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_a02e09a8ab99455f1aeb3518501055067}\label{class_t_level_writer_tzl_a02e09a8ab99455f1aeb3518501055067}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!save@{save}}
\index{save@{save}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{save()}{save()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::save (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} \&}]{img,  }\item[{const \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} \&}]{fid }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01105                                                                   \{}
\DoxyCodeLine{01106   doSave(img, fid);}
\DoxyCodeLine{01107 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_a3e0e510c90f1b17ecef03a9df85e2480}\label{class_t_level_writer_tzl_a3e0e510c90f1b17ecef03a9df85e2480}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!saveIcon@{saveIcon}}
\index{saveIcon@{saveIcon}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{saveIcon()}{saveIcon()}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::save\+Icon (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} \&}]{img,  }\item[{const \mbox{\hyperlink{class_t_frame_id}{TFrame\+Id}} \&}]{fid }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01110                                                                       \{}
\DoxyCodeLine{01111   \textcolor{comment}{// salvo su file come icona}}
\DoxyCodeLine{01112   saveImage(img, fid, \textcolor{keyword}{true});}
\DoxyCodeLine{01113 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_aae9d3879deb37fcc5b6cd8ded0089b4b}\label{class_t_level_writer_tzl_aae9d3879deb37fcc5b6cd8ded0089b4b}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!setIconSize@{setIconSize}}
\index{setIconSize@{setIconSize}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{setIconSize()}{setIconSize()}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::set\+Icon\+Size (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimension}}}]{icon\+Size }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}

\begin{DoxyVerb}         Setta le dimensioni dell'iconcina nel file.
         ATTENZIONE: va necessariamente richiamata prima di
\end{DoxyVerb}
 \mbox{\hyperlink{class_t_level_writer_tzl_a52b3d608e4f3efea6185df0da82288b3}{renumber\+Fids()}}! 

Reimplemented from \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{01254                                                      \{}
\DoxyCodeLine{01255   assert(iconSize.lx > 0 \&\& iconSize.ly > 0);}
\DoxyCodeLine{01256 }
\DoxyCodeLine{01257   m\_iconSize     = \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(iconSize.lx, iconSize.ly);}
\DoxyCodeLine{01258   m\_userIconSize = \mbox{\hyperlink{class_t_dimension_t}{TDimension}}(}
\DoxyCodeLine{01259       iconSize.lx, iconSize.ly);  \textcolor{comment}{// Used in TLevelWriterTzl::optimize().}}
\DoxyCodeLine{01260                                   \textcolor{comment}{// Observe that m\_iconSize may change below.}}
\DoxyCodeLine{01261   \textcolor{keywordflow}{if} (m\_version >= 13 \&\& m\_exists) \{}
\DoxyCodeLine{01262     \textcolor{comment}{// A supported level file already exists at the specified path}}
\DoxyCodeLine{01263 }
\DoxyCodeLine{01264     \textcolor{comment}{// Check whether icons stored in the file already}}
\DoxyCodeLine{01265     \textcolor{comment}{// have the required size}}
\DoxyCodeLine{01266     \textcolor{keywordflow}{if} (!m\_updatedIconsSize)  \textcolor{comment}{// m\_updatedIconsSize tells whether}}
\DoxyCodeLine{01267       m\_updatedIconsSize =}
\DoxyCodeLine{01268           \mbox{\hyperlink{class_t_level_writer_tzl_a47766e2b57e1b830af0d4f0cde36d48e}{checkIconSize}}(m\_iconSize);  \textcolor{comment}{// icon sizes in the file match m\_iconSize}}
\DoxyCodeLine{01269 }
\DoxyCodeLine{01270     \textcolor{keywordflow}{if} (!m\_updatedIconsSize) \{}
\DoxyCodeLine{01271       \textcolor{comment}{// Icons in the stored file mismatch with the}}
\DoxyCodeLine{01272       \textcolor{comment}{// required size. They need to be resized.}}
\DoxyCodeLine{01273       m\_updatedIconsSize = resizeIcons(m\_iconSize);}
\DoxyCodeLine{01274       assert(m\_updatedIconsSize);}
\DoxyCodeLine{01275     \}}
\DoxyCodeLine{01276   \}}
\DoxyCodeLine{01277 \}}

\end{DoxyCode}


References \mbox{\hyperlink{l01288}{check\+Icon\+Size()}}.

\mbox{\Hypertarget{class_t_level_writer_tzl_a3c3bad6d9871bdcc57befa492636b77b}\label{class_t_level_writer_tzl_a3c3bad6d9871bdcc57befa492636b77b}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!setOverwritePaletteFlag@{setOverwritePaletteFlag}}
\index{setOverwritePaletteFlag@{setOverwritePaletteFlag}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{setOverwritePaletteFlag()}{setOverwritePaletteFlag()}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::set\+Overwrite\+Palette\+Flag (\begin{DoxyParamCaption}\item[{bool}]{overwrite }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [virtual]}}



Reimplemented from \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00069                                                         \{}
\DoxyCodeLine{00070     m\_overwritePaletteFlag = overwrite;}
\DoxyCodeLine{00071   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_t_level_writer_tzl_a67e9bda1d1213888e101677e9df61496}\label{class_t_level_writer_tzl_a67e9bda1d1213888e101677e9df61496}} 
\index{TLevelWriterTzl@{TLevelWriterTzl}!setPalette@{setPalette}}
\index{setPalette@{setPalette}!TLevelWriterTzl@{TLevelWriterTzl}}
\doxysubsubsection{\texorpdfstring{setPalette()}{setPalette()}}
{\footnotesize\ttfamily void TLevel\+Writer\+Tzl\+::set\+Palette (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$}]{palette }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Reimplemented from \mbox{\hyperlink{class_t_level_writer}{TLevel\+Writer}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{01116                                                   \{}
\DoxyCodeLine{01117   \textcolor{keywordflow}{if} (!m\_palette) \{}
\DoxyCodeLine{01118     m\_palette = palette;}
\DoxyCodeLine{01119     m\_palette-\/>addRef();}
\DoxyCodeLine{01120   \}}
\DoxyCodeLine{01121 \}}

\end{DoxyCode}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/image/tzl/tiio\+\_\+tzl.\+h\item 
E\+:/opentoonz/toonz/sources/image/tzl/tiio\+\_\+tzl.\+cpp\end{DoxyCompactItemize}
