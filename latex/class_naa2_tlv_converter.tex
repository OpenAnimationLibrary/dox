\hypertarget{class_naa2_tlv_converter}{}\doxysection{Naa2\+Tlv\+Converter Class Reference}
\label{class_naa2_tlv_converter}\index{Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a132f6dbc74f18919c82e1d09eeda44a0}{set\+Source\+Image}} (const \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} \&src\+Ras)
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a8363dc9951f08203745420ef89b65848}{set\+Palette}} (\mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$palette)
\item 
\mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$ \mbox{\hyperlink{class_naa2_tlv_converter_a19266e6fc236f1c71037b4ff9037f447}{get\+Palette}} () const
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a9c95132fcdc0f8e7243b526c34929cbb}{separate\+Regions}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a4b691387ed3777720d7560944c91fc34}{compute\+Links}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a0e685ba8107ef1dbe30dd4a49d347193}{find\+Region\+Borders}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_ae5094e8e50745238644eaf21645dffb1}{erode\+Regions}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a2988866d4a3609b1ca1318867e723141}{compute\+Main\+Ink\+Thickness}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a93df5ceb3d392b0da338ba54d8854181}{assign\+Color\+Types}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a6496d92f56d05170610a871c0228af77}{add\+Border\+Inks}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a636358a90fd9e6491f535fc09cddb693}{find\+Background\+Regions}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_ab9118d93065548cb1a01661bfee4ec0e}{find\+Main\+Inks}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a7a862677aeb8909f6f6c8aec92ec0238}{find\+Large\+Paints}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_aabbf949273280be231e954fd88f2da88}{find\+Thin\+Inks}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a0f3e37ed9565884330cf14dca3174391}{find\+Paints}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a4a500f92be650df0fac71b874249558e}{find\+Paints2}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a4935692bd8410887715578358fba22d0}{find\+Thin\+Paints}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_a15c4d3ec5423fe914b197a56011180b9}{find\+Suspect\+Inks}} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_afcbe43bcb6bb6cec6da9b42068feeddb}{measure\+Thickness}} ()
\item 
int \mbox{\hyperlink{class_naa2_tlv_converter_a49611b50e7951a08c0c27fd4602e96e7}{measure\+Thickness}} (int x, int y)
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_adac817fad601b5981867163088f4cec2}{process}} (const \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} \&src\+Ras)
\item 
int \mbox{\hyperlink{class_naa2_tlv_converter_ae47d71cceb01ca2b6ea9f0a20de7874e}{get\+Region\+Index}} (int x, int y) const
\item 
\mbox{\hyperlink{class_t_toonz_image_p}{TToonz\+ImageP}} \mbox{\hyperlink{class_naa2_tlv_converter_a99634f4451b98f749ab9b0d5f015da5b}{make\+Tlv}} (bool transparent\+Synthetic\+Inks, QList$<$ int $>$ \&used\+Style\+Ids, double dpi=0.\+0)
\item 
\mbox{\hyperlink{class_t_vector_image_p}{TVector\+ImageP}} \mbox{\hyperlink{class_naa2_tlv_converter_ab3d734da9514382920e8db48e66179bc}{vectorize}} (const \mbox{\hyperlink{class_t_toonz_image_p}{TToonz\+ImageP}} \&ti)
\item 
\mbox{\Hypertarget{class_naa2_tlv_converter_a289ac6bb1db00e86ce3a9de249afcde3}\label{class_naa2_tlv_converter_a289ac6bb1db00e86ce3a9de249afcde3}} 
\mbox{\hyperlink{class_t_vector_image_p}{TVector\+ImageP}} {\bfseries vectorize} (const \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} \&ras)
\item 
\mbox{\Hypertarget{class_naa2_tlv_converter_a428eaeb0f3eaf2062451c6a33d41b319}\label{class_naa2_tlv_converter_a428eaeb0f3eaf2062451c6a33d41b319}} 
\mbox{\hyperlink{class_t_vector_image_p}{TVector\+ImageP}} {\bfseries vectorize} ()
\item 
void \mbox{\hyperlink{class_naa2_tlv_converter_ad72599e811a8f2211fc47982ac7a86c0}{remove\+Unused\+Styles}} (const QList$<$ int $>$ \&style\+Ids)
\end{DoxyCompactItemize}
\doxysubsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
const int \mbox{\hyperlink{class_naa2_tlv_converter_ad82deae9481139d35a00c97c186396fd}{Max\+Color\+Count}}
\item 
\mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$ unsigned short $>$ $\ast$ \mbox{\hyperlink{class_naa2_tlv_converter_a818cf5ab9bec6c237a80d010ba850c82}{m\+\_\+region\+Ras}}
\item 
\mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$ unsigned char $>$ $\ast$ \mbox{\hyperlink{class_naa2_tlv_converter_a0b0daae74da1bd01b9f08c4f3e863793}{m\+\_\+border\+Ras}}
\item 
\mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$ unsigned char $>$ $\ast$ \mbox{\hyperlink{class_naa2_tlv_converter_a40cb144beaf2f9ae3762a9be1360783d}{m\+\_\+dot\+Ras}}
\item 
\mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$ unsigned char $>$ $\ast$ \mbox{\hyperlink{class_naa2_tlv_converter_aca510d1f840fde7592ce170aea57c90f}{m\+\_\+synthetic\+Ink\+Ras}}
\item 
QVector$<$ TPixel32 $>$ \mbox{\hyperlink{class_naa2_tlv_converter_ae96dfe88c5c33f6e70270049e1a7de6e}{m\+\_\+colors}}
\item 
QVector$<$ \mbox{\hyperlink{struct_region_info}{Region\+Info}} $>$ \mbox{\hyperlink{class_naa2_tlv_converter_a1401dcef1312dcd358d1feb1dc42fcaa}{m\+\_\+regions}}
\item 
double \mbox{\hyperlink{class_naa2_tlv_converter_a5ddcaf9de0e08d6aa0e2d48fdfce1ad5}{m\+\_\+ink\+Thickness}}
\item 
\mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$ \mbox{\hyperlink{class_naa2_tlv_converter_a5be1af2e152f70560a76ada841b7d685}{m\+\_\+palette}}
\item 
bool \mbox{\hyperlink{class_naa2_tlv_converter_a8ba425d3324998fa444ba91e5fe68272}{m\+\_\+valid}}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_naa2_tlv_converter_ac60ed5da6eaa8aa83645e3b2883ed0ae}\label{class_naa2_tlv_converter_ac60ed5da6eaa8aa83645e3b2883ed0ae}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!Naa2TlvConverter@{Naa2TlvConverter}}
\index{Naa2TlvConverter@{Naa2TlvConverter}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{Naa2TlvConverter()}{Naa2TlvConverter()}}
{\footnotesize\ttfamily Naa2\+Tlv\+Converter\+::\+Naa2\+Tlv\+Converter (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00043     : MaxColorCount(1000)}
\DoxyCodeLine{00044     , m\_regionRas(0)}
\DoxyCodeLine{00045     , m\_borderRas(0)}
\DoxyCodeLine{00046     , m\_dotRas(0)}
\DoxyCodeLine{00047     , m\_syntheticInkRas(0)}
\DoxyCodeLine{00048     , m\_inkThickness(0)}
\DoxyCodeLine{00049     , m\_palette(0)}
\DoxyCodeLine{00050     , m\_valid(\textcolor{keyword}{false})}
\DoxyCodeLine{00051 }
\DoxyCodeLine{00052 \{\}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_ae86460abc499a90416729adb4a2be8d9}\label{class_naa2_tlv_converter_ae86460abc499a90416729adb4a2be8d9}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!````~Naa2TlvConverter@{$\sim$Naa2TlvConverter}}
\index{````~Naa2TlvConverter@{$\sim$Naa2TlvConverter}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{$\sim$Naa2TlvConverter()}{~Naa2TlvConverter()}}
{\footnotesize\ttfamily Naa2\+Tlv\+Converter\+::$\sim$\+Naa2\+Tlv\+Converter (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00054                                     \{}
\DoxyCodeLine{00055   \textcolor{keyword}{delete} m\_regionRas;}
\DoxyCodeLine{00056   \textcolor{keyword}{delete} m\_borderRas;}
\DoxyCodeLine{00057   \textcolor{keyword}{delete} m\_dotRas;}
\DoxyCodeLine{00058   \textcolor{keyword}{delete} m\_syntheticInkRas;}
\DoxyCodeLine{00059   \textcolor{keywordflow}{if} (m\_palette) m\_palette-\/>release();}
\DoxyCodeLine{00060 \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_naa2_tlv_converter_a6496d92f56d05170610a871c0228af77}\label{class_naa2_tlv_converter_a6496d92f56d05170610a871c0228af77}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!addBorderInks@{addBorderInks}}
\index{addBorderInks@{addBorderInks}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{addBorderInks()}{addBorderInks()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::add\+Border\+Inks (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00738 \{}
\DoxyCodeLine{00739   \textcolor{keywordtype}{int} lx                   = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00740   \textcolor{keywordtype}{int} ly                   = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00741   \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{int} dd[][2] = \{\{0, -\/1\}, \{-\/1, 0\},  \{1, 0\},  \{0, 1\},}
\DoxyCodeLine{00742                               \{1, 1\},  \{-\/1, -\/1\}, \{-\/1, 1\}, \{1, -\/1\}\};}
\DoxyCodeLine{00743 }
\DoxyCodeLine{00744   m\_syntheticInkRas = \textcolor{keyword}{new} \mbox{\hyperlink{class_work_raster}{WorkRaster<unsigned char>}}(lx, ly);}
\DoxyCodeLine{00745   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < lx * ly; i++) m\_syntheticInkRas-\/>pixels(0)[i] = 0;}
\DoxyCodeLine{00746 }
\DoxyCodeLine{00747   \textcolor{comment}{// calculate brightness of all colors in order to decide the region on which}}
\DoxyCodeLine{00748   \textcolor{comment}{// the border to be added}}
\DoxyCodeLine{00749   QList<int> colorsBrightness;}
\DoxyCodeLine{00750   QVector<TPixel32>::iterator c;}
\DoxyCodeLine{00751   \textcolor{keywordflow}{for} (c = m\_colors.begin(); c != m\_colors.end(); ++c)}
\DoxyCodeLine{00752     colorsBrightness.append((\textcolor{keywordtype}{int})(*c).r * 30 + (\textcolor{keywordtype}{int})(*c).g * 59 +}
\DoxyCodeLine{00753                             (\textcolor{keywordtype}{int})(*c).b * 11);}
\DoxyCodeLine{00754 }
\DoxyCodeLine{00755   \textcolor{keywordtype}{int} borderInkColorIndex = m\_colors.count();}
\DoxyCodeLine{00756   m\_colors.append(TPixel32(255, 0, 0));}
\DoxyCodeLine{00757 }
\DoxyCodeLine{00758   \mbox{\hyperlink{struct_region_info}{RegionInfo}} borderInkRegion;}
\DoxyCodeLine{00759   borderInkRegion.type       = RegionInfo::SyntheticInk;}
\DoxyCodeLine{00760   borderInkRegion.colorIndex = borderInkColorIndex;}
\DoxyCodeLine{00761   \textcolor{keywordtype}{int} borderInkRegionIndex   = m\_regions.count();}
\DoxyCodeLine{00762   m\_regions.append(borderInkRegion);}
\DoxyCodeLine{00763 }
\DoxyCodeLine{00764   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00765     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *workScanLine  = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00766     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *borderScanLine = m\_borderRas-\/>pixels(y);}
\DoxyCodeLine{00767     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00768       \textcolor{keywordtype}{int} c = workScanLine[x];}
\DoxyCodeLine{00769       \textcolor{keywordflow}{if} (borderScanLine[x] != 1) \textcolor{keywordflow}{continue};  \textcolor{comment}{// consider border pixel only}}
\DoxyCodeLine{00770       \textcolor{keywordflow}{if} (0 == (m\_regions[c].type \& RegionInfo::Paint) \&\&}
\DoxyCodeLine{00771           m\_regions[c].type != RegionInfo::Unknown)}
\DoxyCodeLine{00772         \textcolor{keywordflow}{continue};  \textcolor{comment}{// consider paint pixels only}}
\DoxyCodeLine{00773 }
\DoxyCodeLine{00774       \textcolor{comment}{// is touching a different no-\/ink pixel?}}
\DoxyCodeLine{00775       \textcolor{keywordtype}{bool} touchesOtherRegion = \textcolor{keyword}{false};}
\DoxyCodeLine{00776       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < 8; j++) \{}
\DoxyCodeLine{00777         \textcolor{keywordtype}{int} x1 = x + dd[j][0], y1 = y + dd[j][1];}
\DoxyCodeLine{00778         \textcolor{keywordflow}{if} (0 <= x1 \&\& x1 < lx \&\& 0 <= y1 \&\& y1 < ly) \{}
\DoxyCodeLine{00779           \textcolor{keywordtype}{int} c1 = m\_regionRas-\/>pixels(y1)[x1];}
\DoxyCodeLine{00780 }
\DoxyCodeLine{00781           \textcolor{keywordflow}{if} (m\_regions[c1].type == RegionInfo::Background) \{}
\DoxyCodeLine{00782             touchesOtherRegion = \textcolor{keyword}{true};}
\DoxyCodeLine{00783             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00784           \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (m\_regions[c1].type == RegionInfo::Unknown ||}
\DoxyCodeLine{00785                      (m\_regions[c1].type \& RegionInfo::Paint) != 0) \{}
\DoxyCodeLine{00786             \textcolor{comment}{// OLD: note: we consider only regions with a lower index, to avoid}}
\DoxyCodeLine{00787             \textcolor{comment}{// to create double border strokes}}
\DoxyCodeLine{00788             \textcolor{comment}{// NEW: we put synthetic ink pixels in larger regions}}
\DoxyCodeLine{00789             \textcolor{comment}{// UPDATE 2017/5/12 : we put ink on darker style}}
\DoxyCodeLine{00790             \textcolor{keywordflow}{if} (colorsBrightness[m\_regions[c1].colorIndex] >}
\DoxyCodeLine{00791                 colorsBrightness[m\_regions[c].colorIndex]) \{}
\DoxyCodeLine{00792               touchesOtherRegion = \textcolor{keyword}{true};}
\DoxyCodeLine{00793               \textcolor{keywordflow}{break};}
\DoxyCodeLine{00794             \}}
\DoxyCodeLine{00795           \}}
\DoxyCodeLine{00796         \}}
\DoxyCodeLine{00797       \}}
\DoxyCodeLine{00798 }
\DoxyCodeLine{00799       \textcolor{keywordflow}{if} (touchesOtherRegion) \{}
\DoxyCodeLine{00800         m\_syntheticInkRas-\/>pixels(y)[x] = 1;}
\DoxyCodeLine{00801       \}}
\DoxyCodeLine{00802     \}}
\DoxyCodeLine{00803   \}}
\DoxyCodeLine{00804 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a93df5ceb3d392b0da338ba54d8854181}\label{class_naa2_tlv_converter_a93df5ceb3d392b0da338ba54d8854181}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!assignColorTypes@{assignColorTypes}}
\index{assignColorTypes@{assignColorTypes}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{assignColorTypes()}{assignColorTypes()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::assign\+Color\+Types (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00712                                         \{}
\DoxyCodeLine{00713   \textcolor{keywordflow}{if} (!m\_regionRas || !m\_borderRas || m\_regions.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00714   \textcolor{keywordtype}{int} lx = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00715   \textcolor{keywordtype}{int} ly = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00716 }
\DoxyCodeLine{00717   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00718     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00719     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00720     QList<int> \&bs = region.boundaries;}
\DoxyCodeLine{00721     \textcolor{keywordflow}{if} (bs[0] > 0) \{}
\DoxyCodeLine{00722       region.type = RegionInfo::LargePaint;}
\DoxyCodeLine{00723     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00724       \textcolor{keywordtype}{int} b = 0;}
\DoxyCodeLine{00725       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 1; j <= 2 \&\& j < bs.count(); j++) b += bs[j];}
\DoxyCodeLine{00726       \textcolor{keywordflow}{if} (region.pixelCount > 200 \&\&}
\DoxyCodeLine{00727           (region.pixelCount -\/ b) * 10 < region.pixelCount) \{}
\DoxyCodeLine{00728         region.type = RegionInfo::ThinInk;}
\DoxyCodeLine{00729       \}}
\DoxyCodeLine{00730     \}}
\DoxyCodeLine{00731   \}}
\DoxyCodeLine{00732 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a4b691387ed3777720d7560944c91fc34}\label{class_naa2_tlv_converter_a4b691387ed3777720d7560944c91fc34}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!computeLinks@{computeLinks}}
\index{computeLinks@{computeLinks}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{computeLinks()}{computeLinks()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::compute\+Links (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00293                                     \{}
\DoxyCodeLine{00294   \textcolor{keywordflow}{if} (!m\_regionRas || m\_regions.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00295   \textcolor{keyword}{const} \textcolor{keywordtype}{int} lx   = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00296   \textcolor{keyword}{const} \textcolor{keywordtype}{int} ly   = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00297   \textcolor{keyword}{const} \textcolor{keywordtype}{int} wrap = lx;}
\DoxyCodeLine{00298   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *waScanLine;}
\DoxyCodeLine{00299   \textcolor{keywordtype}{int} x;}
\DoxyCodeLine{00300   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) m\_regions[i].perimeter = 0;}
\DoxyCodeLine{00301   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00302     waScanLine = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00303     \textcolor{keywordflow}{for} (x = 0; x < lx; x++) \{}
\DoxyCodeLine{00304       \textcolor{keywordtype}{int} c     = waScanLine[x];}
\DoxyCodeLine{00305       \textcolor{keywordtype}{int} cUp   = y > 0 ? waScanLine[x -\/ wrap] : -\/1;}
\DoxyCodeLine{00306       \textcolor{keywordtype}{int} cLeft = x > 0 ? waScanLine[x -\/ 1] : -\/1;}
\DoxyCodeLine{00307       \textcolor{keywordflow}{if} (c != cUp) \{}
\DoxyCodeLine{00308         m\_regions[c].touchRegion(cUp);}
\DoxyCodeLine{00309         m\_regions[c].perimeter++;}
\DoxyCodeLine{00310         \textcolor{keywordflow}{if} (cUp >= 0) \{}
\DoxyCodeLine{00311           m\_regions[cUp].touchRegion(c);}
\DoxyCodeLine{00312           m\_regions[cUp].perimeter++;}
\DoxyCodeLine{00313         \}}
\DoxyCodeLine{00314       \}}
\DoxyCodeLine{00315       \textcolor{keywordflow}{if} (c != cLeft) \{}
\DoxyCodeLine{00316         m\_regions[c].touchRegion(cLeft);}
\DoxyCodeLine{00317         m\_regions[c].perimeter++;}
\DoxyCodeLine{00318         \textcolor{keywordflow}{if} (cLeft >= 0) \{}
\DoxyCodeLine{00319           m\_regions[cLeft].touchRegion(c);}
\DoxyCodeLine{00320           m\_regions[cLeft].perimeter++;}
\DoxyCodeLine{00321         \}}
\DoxyCodeLine{00322       \}}
\DoxyCodeLine{00323     \}}
\DoxyCodeLine{00324     m\_regions[waScanLine[lx -\/ 1]].touchRegion(-\/1);}
\DoxyCodeLine{00325   \}}
\DoxyCodeLine{00326   waScanLine = m\_regionRas-\/>pixels(ly -\/ 1);}
\DoxyCodeLine{00327   \textcolor{keywordflow}{for} (x = 0; x < lx; x++) \{}
\DoxyCodeLine{00328     m\_regions[waScanLine[x]].touchRegion(-\/1);}
\DoxyCodeLine{00329   \}}
\DoxyCodeLine{00330 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a2988866d4a3609b1ca1318867e723141}\label{class_naa2_tlv_converter_a2988866d4a3609b1ca1318867e723141}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!computeMainInkThickness@{computeMainInkThickness}}
\index{computeMainInkThickness@{computeMainInkThickness}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{computeMainInkThickness()}{computeMainInkThickness()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::compute\+Main\+Ink\+Thickness (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00497                                                \{}
\DoxyCodeLine{00498   m\_inkThickness  = 0.0;}
\DoxyCodeLine{00499   \textcolor{keywordtype}{int} largestArea = 0;}
\DoxyCodeLine{00500   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00501     \textcolor{keywordflow}{if} (m\_regions[i].type != RegionInfo::MainInk) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00502     \textcolor{keywordflow}{if} (m\_regions[i].pixelCount < largestArea) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00503     largestArea = m\_regions[i].pixelCount;}
\DoxyCodeLine{00504     \textcolor{keywordflow}{if} (i == 55) \{}
\DoxyCodeLine{00505       \textcolor{keywordtype}{int} x = 123;}
\DoxyCodeLine{00506     \}}
\DoxyCodeLine{00507     QList<int> \&bs = m\_regions[i].boundaries;}
\DoxyCodeLine{00508     Q\_ASSERT(bs[1] > 0);}
\DoxyCodeLine{00509     \textcolor{keywordtype}{int} perimeter = m\_regions[i].perimeter;}
\DoxyCodeLine{00510     \textcolor{keywordtype}{int} area      = bs[1];}
\DoxyCodeLine{00511     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 2; j < bs.count() \&\& bs[j] * 2 > bs[1]; j++) area += bs[j];}
\DoxyCodeLine{00512     \textcolor{keywordflow}{if} (perimeter > 0) \{}
\DoxyCodeLine{00513       m\_inkThickness = 2 * (double)area / (\textcolor{keywordtype}{double})perimeter;}
\DoxyCodeLine{00514     \}}
\DoxyCodeLine{00515   \}}
\DoxyCodeLine{00516 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_ae5094e8e50745238644eaf21645dffb1}\label{class_naa2_tlv_converter_ae5094e8e50745238644eaf21645dffb1}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!erodeRegions@{erodeRegions}}
\index{erodeRegions@{erodeRegions}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{erodeRegions()}{erodeRegions()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::erode\+Regions (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00409                                     \{}
\DoxyCodeLine{00410   QTime clock;}
\DoxyCodeLine{00411   clock.start();}
\DoxyCodeLine{00412   \textcolor{keywordflow}{if} (!m\_regionRas || !m\_borderRas) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00413   \textcolor{keywordtype}{int} lx = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00414   \textcolor{keywordtype}{int} ly = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00415 }
\DoxyCodeLine{00416   \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{int} dd[][2] = \{\{-\/1, -\/1\}, \{0, -\/1\}, \{1, -\/1\}, \{-\/1, 0\},}
\DoxyCodeLine{00417                               \{1, 0\},   \{-\/1, 1\}, \{0, 1\},  \{1, 1\}\};}
\DoxyCodeLine{00418 }
\DoxyCodeLine{00419   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} iter = 0; iter < 10; iter++) \{}
\DoxyCodeLine{00420     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00421       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *workScanLine  = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00422       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *borderScanLine = m\_borderRas-\/>pixels(y);}
\DoxyCodeLine{00423       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00424         \textcolor{keywordflow}{if} (borderScanLine[x] != iter + 1) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00425         \textcolor{keywordtype}{int} c = workScanLine[x];}
\DoxyCodeLine{00426         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < 8; j++) \{}
\DoxyCodeLine{00427           \textcolor{keywordtype}{int} x1 = x + dd[j][0], y1 = y + dd[j][1];}
\DoxyCodeLine{00428           \textcolor{keywordflow}{if} (!(0 <= x1 \&\& x1 < lx \&\& 0 <= y1 \&\& y1 < ly)) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00429           \textcolor{keywordtype}{int} c1 = m\_regionRas-\/>pixels(y1)[x1];}
\DoxyCodeLine{00430           \textcolor{keywordtype}{int} b1 = m\_borderRas-\/>pixels(y1)[x1];}
\DoxyCodeLine{00431           \textcolor{keywordflow}{if} (c1 == c \&\& b1 == 0) m\_borderRas-\/>pixels(y1)[x1] = iter + 2;}
\DoxyCodeLine{00432         \}}
\DoxyCodeLine{00433       \}}
\DoxyCodeLine{00434     \}}
\DoxyCodeLine{00435   \}}
\DoxyCodeLine{00436 }
\DoxyCodeLine{00437   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) m\_regions[i].boundaries.clear();}
\DoxyCodeLine{00438   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00439     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *workScanLine  = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00440     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *borderScanLine = m\_borderRas-\/>pixels(y);}
\DoxyCodeLine{00441     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00442       \textcolor{keywordtype}{int} c          = workScanLine[x];}
\DoxyCodeLine{00443       \textcolor{keywordtype}{int} b          = borderScanLine[x];}
\DoxyCodeLine{00444       \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&r  = m\_regions[c];}
\DoxyCodeLine{00445       QList<int> \&bs = r.boundaries;}
\DoxyCodeLine{00446       \textcolor{keywordflow}{while} (bs.count() <= b) bs.append(0);}
\DoxyCodeLine{00447       bs[b]++;}
\DoxyCodeLine{00448       \textcolor{keywordflow}{if} (b == bs.count() -\/ 1) r.pos = QPoint(x, y);}
\DoxyCodeLine{00449       \textcolor{keywordflow}{if} (r.x0 > r.x1) \{}
\DoxyCodeLine{00450         r.x0 = r.x1 = x;}
\DoxyCodeLine{00451         r.y0 = r.y1 = y;}
\DoxyCodeLine{00452       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00453         \textcolor{keywordflow}{if} (x < r.x0)}
\DoxyCodeLine{00454           r.x0 = x;}
\DoxyCodeLine{00455         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (x > r.x1)}
\DoxyCodeLine{00456           r.x1 = x;}
\DoxyCodeLine{00457         \textcolor{keywordflow}{if} (y < r.y0)}
\DoxyCodeLine{00458           r.y0 = y;}
\DoxyCodeLine{00459         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (y > r.y1)}
\DoxyCodeLine{00460           r.y1 = y;}
\DoxyCodeLine{00461       \}}
\DoxyCodeLine{00462     \}}
\DoxyCodeLine{00463   \}}
\DoxyCodeLine{00464   qDebug() << \textcolor{stringliteral}{"{}Erode regions. time = "{}} << clock.elapsed();}
\DoxyCodeLine{00465 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a636358a90fd9e6491f535fc09cddb693}\label{class_naa2_tlv_converter_a636358a90fd9e6491f535fc09cddb693}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findBackgroundRegions@{findBackgroundRegions}}
\index{findBackgroundRegions@{findBackgroundRegions}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findBackgroundRegions()}{findBackgroundRegions()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Background\+Regions (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00336                                              \{}
\DoxyCodeLine{00337   \textcolor{keywordflow}{if} (!m\_regionRas || m\_regions.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00338   \textcolor{keywordtype}{int} lx = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00339   \textcolor{keywordtype}{int} ly = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00340 }
\DoxyCodeLine{00341   \textcolor{comment}{// find the whitest color}}
\DoxyCodeLine{00342   \textcolor{keywordtype}{int} bgColorIndex = -\/1;}
\DoxyCodeLine{00343   \textcolor{keywordtype}{int} maxV         = 0;}
\DoxyCodeLine{00344   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_colors.count(); i++) \{}
\DoxyCodeLine{00345     TPixel color = m\_colors.at(i);}
\DoxyCodeLine{00346     \textcolor{keywordtype}{int} v        = color.r + color.g + color.b;}
\DoxyCodeLine{00347     \textcolor{keywordtype}{int} a        = std::min(\{color.r, color.g, color.b\});}
\DoxyCodeLine{00348     \textcolor{keywordflow}{if} (a < 230) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00349     \textcolor{keywordflow}{if} (v > maxV) \{}
\DoxyCodeLine{00350       bgColorIndex = i;}
\DoxyCodeLine{00351       maxV         = v;}
\DoxyCodeLine{00352     \}}
\DoxyCodeLine{00353   \}}
\DoxyCodeLine{00354   \textcolor{keywordflow}{if} (bgColorIndex < 0) \{}
\DoxyCodeLine{00355     \textcolor{comment}{// no white found. no bg region}}
\DoxyCodeLine{00356     \textcolor{keywordflow}{return};}
\DoxyCodeLine{00357   \}}
\DoxyCodeLine{00358 }
\DoxyCodeLine{00359   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00360     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region                                 = m\_regions[i];}
\DoxyCodeLine{00361     \textcolor{keywordflow}{if} (region.colorIndex == bgColorIndex) region.type = RegionInfo::Background;}
\DoxyCodeLine{00362   \}}
\DoxyCodeLine{00363 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a7a862677aeb8909f6f6c8aec92ec0238}\label{class_naa2_tlv_converter_a7a862677aeb8909f6f6c8aec92ec0238}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findLargePaints@{findLargePaints}}
\index{findLargePaints@{findLargePaints}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findLargePaints()}{findLargePaints()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Large\+Paints (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00520                                        \{}
\DoxyCodeLine{00521   \textcolor{keywordflow}{if} (!m\_regionRas || !m\_borderRas || m\_regions.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00522   QSet<int> largePaintColors;}
\DoxyCodeLine{00523   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00524     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00525     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00526     QList<int> \&bs = region.boundaries;}
\DoxyCodeLine{00527     \textcolor{keywordflow}{if} (bs[0] > 0) \{}
\DoxyCodeLine{00528       region.type = RegionInfo::LargePaint;}
\DoxyCodeLine{00529       largePaintColors.insert(region.colorIndex);}
\DoxyCodeLine{00530     \}}
\DoxyCodeLine{00531   \}}
\DoxyCodeLine{00532   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00533     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00534     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00535     \textcolor{keywordflow}{if} (largePaintColors.contains(region.colorIndex))}
\DoxyCodeLine{00536       region.type = RegionInfo::LargePaint;}
\DoxyCodeLine{00537   \}}
\DoxyCodeLine{00538 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_ab9118d93065548cb1a01661bfee4ec0e}\label{class_naa2_tlv_converter_ab9118d93065548cb1a01661bfee4ec0e}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findMainInks@{findMainInks}}
\index{findMainInks@{findMainInks}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findMainInks()}{findMainInks()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Main\+Inks (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00470                                     \{}
\DoxyCodeLine{00471   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00472     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00473     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00474     \textcolor{keywordflow}{if} (region.isBackground() || region.type == RegionInfo::LargePaint ||}
\DoxyCodeLine{00475         region.boundaries[0] > 0)}
\DoxyCodeLine{00476       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00477     \textcolor{keywordtype}{double} ap2 =}
\DoxyCodeLine{00478         100000.0 * (double)region.pixelCount / pow((\textcolor{keywordtype}{double})region.perimeter, 2);}
\DoxyCodeLine{00479     \textcolor{keywordflow}{if} (ap2 > 100) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00480     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c : region.links.keys()) \{}
\DoxyCodeLine{00481       \textcolor{keywordflow}{if} (c >= 0 \&\& (m\_regions[c].isBackground() ||}
\DoxyCodeLine{00482                      m\_regions[c].type == RegionInfo::LargePaint)) \{}
\DoxyCodeLine{00483         \textcolor{keywordtype}{int} strength = region.links[c];}
\DoxyCodeLine{00484         \textcolor{keywordflow}{if} (strength > 50) \{}
\DoxyCodeLine{00485           m\_regions[i].type = RegionInfo::MainInk;}
\DoxyCodeLine{00486           \textcolor{keywordflow}{break};}
\DoxyCodeLine{00487         \}}
\DoxyCodeLine{00488       \}}
\DoxyCodeLine{00489     \}}
\DoxyCodeLine{00490   \}}
\DoxyCodeLine{00491 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a0f3e37ed9565884330cf14dca3174391}\label{class_naa2_tlv_converter_a0f3e37ed9565884330cf14dca3174391}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findPaints@{findPaints}}
\index{findPaints@{findPaints}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findPaints()}{findPaints()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Paints (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00566                                   \{}
\DoxyCodeLine{00567   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00568     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00569     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00570     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c : m\_regions[i].links.keys()) \{}
\DoxyCodeLine{00571       \textcolor{keywordflow}{if} (c >= 0 \&\& m\_regions[c].isInk()) \{}
\DoxyCodeLine{00572         m\_regions[i].type = RegionInfo::Paint;}
\DoxyCodeLine{00573         \textcolor{keywordflow}{break};}
\DoxyCodeLine{00574       \}}
\DoxyCodeLine{00575     \}}
\DoxyCodeLine{00576   \}}
\DoxyCodeLine{00577 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a4a500f92be650df0fac71b874249558e}\label{class_naa2_tlv_converter_a4a500f92be650df0fac71b874249558e}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findPaints2@{findPaints2}}
\index{findPaints2@{findPaints2}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findPaints2()}{findPaints2()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Paints2 (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00581                                    \{}
\DoxyCodeLine{00582   \textcolor{keywordtype}{double} avThickness = 0.0;}
\DoxyCodeLine{00583   \textcolor{keywordtype}{int} m              = 0;}
\DoxyCodeLine{00584   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00585     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00586     \textcolor{keywordflow}{if} (region.type == RegionInfo::MainInk) \{}
\DoxyCodeLine{00587       avThickness += region.thickness * region.pixelCount;}
\DoxyCodeLine{00588       m += region.pixelCount;}
\DoxyCodeLine{00589     \}}
\DoxyCodeLine{00590   \}}
\DoxyCodeLine{00591   \textcolor{keywordflow}{if} (m > 0) \{}
\DoxyCodeLine{00592     avThickness = avThickness / m;}
\DoxyCodeLine{00593   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00594     avThickness = 1.5;  \textcolor{comment}{// this should never happen}}
\DoxyCodeLine{00595   \}}
\DoxyCodeLine{00596 }
\DoxyCodeLine{00597   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00598     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00599     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00600 }
\DoxyCodeLine{00601     \textcolor{keywordflow}{if} (region.thickness > 0.0) \{}
\DoxyCodeLine{00602       \textcolor{keywordflow}{if} (region.thickness < 1.2 * avThickness)}
\DoxyCodeLine{00603         region.type = RegionInfo::Ink;}
\DoxyCodeLine{00604       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00605         region.type = RegionInfo::Paint;}
\DoxyCodeLine{00606     \}}
\DoxyCodeLine{00607   \}}
\DoxyCodeLine{00608 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a0e685ba8107ef1dbe30dd4a49d347193}\label{class_naa2_tlv_converter_a0e685ba8107ef1dbe30dd4a49d347193}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findRegionBorders@{findRegionBorders}}
\index{findRegionBorders@{findRegionBorders}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findRegionBorders()}{findRegionBorders()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Region\+Borders (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00369                                          \{}
\DoxyCodeLine{00370   \textcolor{keywordflow}{if} (!m\_regionRas) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00371   \textcolor{keywordtype}{int} lx = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00372   \textcolor{keywordtype}{int} ly = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00373   \textcolor{keyword}{delete} m\_borderRas;}
\DoxyCodeLine{00374   m\_borderRas = \textcolor{keyword}{new} \mbox{\hyperlink{class_work_raster}{WorkRaster<unsigned char>}}(lx, ly);}
\DoxyCodeLine{00375 }
\DoxyCodeLine{00376   \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{int} dd[][2] = \{\{-\/1, -\/1\}, \{0, -\/1\}, \{1, -\/1\}, \{-\/1, 0\},}
\DoxyCodeLine{00377                               \{1, 0\},   \{-\/1, 1\}, \{0, 1\},  \{1, 1\}\};}
\DoxyCodeLine{00378 }
\DoxyCodeLine{00379   \textcolor{comment}{// find region-\/region boundaries}}
\DoxyCodeLine{00380   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00381     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *workScanLine  = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00382     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *borderScanLine = m\_borderRas-\/>pixels(y);}
\DoxyCodeLine{00383 }
\DoxyCodeLine{00384     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00385       \textcolor{keywordtype}{int} k = workScanLine[x];}
\DoxyCodeLine{00386       Q\_ASSERT(0 <= k \&\& k < m\_regions.count());}
\DoxyCodeLine{00387       \textcolor{keywordtype}{int} isBoundary = 0;}
\DoxyCodeLine{00388       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < 8; j++) \{}
\DoxyCodeLine{00389         \textcolor{keywordtype}{int} x1 = x + dd[j][0], y1 = y + dd[j][1];}
\DoxyCodeLine{00390         \textcolor{keywordflow}{if} (0 <= x1 \&\& x1 < lx \&\& 0 <= y1 \&\& y1 < ly) \{}
\DoxyCodeLine{00391           \textcolor{keywordtype}{int} k1 = m\_regionRas-\/>pixels(y1)[x1];}
\DoxyCodeLine{00392           \textcolor{keywordflow}{if} (k1 != k) \{}
\DoxyCodeLine{00393             isBoundary = 1;}
\DoxyCodeLine{00394             \textcolor{keywordflow}{break};}
\DoxyCodeLine{00395           \}}
\DoxyCodeLine{00396         \}}
\DoxyCodeLine{00397       \}}
\DoxyCodeLine{00398       borderScanLine[x] = isBoundary;}
\DoxyCodeLine{00399     \}}
\DoxyCodeLine{00400   \}}
\DoxyCodeLine{00401 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a15c4d3ec5423fe914b197a56011180b9}\label{class_naa2_tlv_converter_a15c4d3ec5423fe914b197a56011180b9}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findSuspectInks@{findSuspectInks}}
\index{findSuspectInks@{findSuspectInks}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findSuspectInks()}{findSuspectInks()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Suspect\+Inks (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00639                                        \{}
\DoxyCodeLine{00640   QMultiMap<TUINT32, int> paintColorTable;}
\DoxyCodeLine{00641   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00642     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00643     \textcolor{keywordflow}{if} (0 == (region.type \& RegionInfo::Paint)) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00644     TPixel32 color = m\_colors[region.colorIndex];}
\DoxyCodeLine{00645     \textcolor{keywordflow}{if} (color == TPixel32(0, 0, 0)) \{}
\DoxyCodeLine{00646       \textcolor{keywordtype}{int} x = 1234;}
\DoxyCodeLine{00647       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00648     \}}
\DoxyCodeLine{00649     TUINT32 rawColor = *(TUINT32 *)\&color;}
\DoxyCodeLine{00650     paintColorTable.insert(rawColor, i);}
\DoxyCodeLine{00651   \}}
\DoxyCodeLine{00652 }
\DoxyCodeLine{00653   \textcolor{keywordtype}{int} count = 0;}
\DoxyCodeLine{00654   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00655     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00656     \textcolor{keywordflow}{if} (region.isInk() \&\& region.links.size() == 2) \{}
\DoxyCodeLine{00657       \textcolor{keywordtype}{int} ra = region.links.keys().at(0), rb = region.links.keys().at(1);}
\DoxyCodeLine{00658       \textcolor{keywordflow}{if} (ra >= 0 \&\& rb >= 0) \{}
\DoxyCodeLine{00659         \textcolor{keywordflow}{if} (!m\_regions[ra].isInk()) qSwap(ra, rb);}
\DoxyCodeLine{00660         \textcolor{keywordflow}{if} (m\_regions[ra].isInk() \&\& !m\_regions[rb].isInk()) \{}
\DoxyCodeLine{00661           \textcolor{keywordtype}{int} sa = region.links[ra];}
\DoxyCodeLine{00662           \textcolor{keywordtype}{int} sb = region.links[rb];}
\DoxyCodeLine{00663           \textcolor{keywordflow}{if} (sa > sb) \{}
\DoxyCodeLine{00664             region.type = RegionInfo::Paint;}
\DoxyCodeLine{00665             count++;}
\DoxyCodeLine{00666             \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00667           \}}
\DoxyCodeLine{00668         \}}
\DoxyCodeLine{00669       \}}
\DoxyCodeLine{00670     \}}
\DoxyCodeLine{00671 }
\DoxyCodeLine{00672     \textcolor{keywordflow}{if} (region.type != RegionInfo::ThinInk) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00673     TUINT32 rawColor = *(TUINT32 *)\&m\_colors[region.colorIndex];}
\DoxyCodeLine{00674     if (paintColorTable.contains(rawColor)) \{}
\DoxyCodeLine{00675       region.type = RegionInfo::Unknown;}
\DoxyCodeLine{00676       count++;}
\DoxyCodeLine{00677     \}}
\DoxyCodeLine{00678   \}}
\DoxyCodeLine{00679 }
\DoxyCodeLine{00680   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00681     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00682     \textcolor{keywordflow}{if} (region.isInk() \&\& 10 <= region.pixelCount \&\& region.pixelCount < 100) \{}
\DoxyCodeLine{00683       \textcolor{keywordtype}{int} lx = region.x1 -\/ region.x0 + 1;}
\DoxyCodeLine{00684       \textcolor{keywordtype}{int} ly = region.y1 -\/ region.y0 + 1;}
\DoxyCodeLine{00685       \textcolor{keywordtype}{int} d  = std::max(lx, ly);}
\DoxyCodeLine{00686       \textcolor{keywordflow}{if} (std::min(lx, ly) * 2 > std::max(lx, ly) \&\& region.pixelCount > d * d / 2) \{}
\DoxyCodeLine{00687         region.type = RegionInfo::Paint;}
\DoxyCodeLine{00688       \}}
\DoxyCodeLine{00689     \}}
\DoxyCodeLine{00690 }
\DoxyCodeLine{00691     \textcolor{keywordflow}{if} (region.type == RegionInfo::Paint ||}
\DoxyCodeLine{00692         region.type == RegionInfo::Unknown) \{}
\DoxyCodeLine{00693       \textcolor{keywordtype}{bool} isInk = \textcolor{keyword}{false};}
\DoxyCodeLine{00694       \textcolor{keywordflow}{if} (region.boundaries.at(0) == 0) \{}
\DoxyCodeLine{00695         \textcolor{keywordflow}{if} (region.boundaries.count() == 2)}
\DoxyCodeLine{00696           isInk = \textcolor{keyword}{true};}
\DoxyCodeLine{00697         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (region.boundaries.count() == 3) \{}
\DoxyCodeLine{00698           \textcolor{keywordtype}{int} b1                 = region.boundaries.at(1);}
\DoxyCodeLine{00699           \textcolor{keywordtype}{int} b2                 = region.boundaries.at(2);}
\DoxyCodeLine{00700           \textcolor{keywordflow}{if} (b1 * 2 < b2) isInk = \textcolor{keyword}{true};}
\DoxyCodeLine{00701         \}}
\DoxyCodeLine{00702       \}}
\DoxyCodeLine{00703       \textcolor{keywordflow}{if} (isInk) region.type = RegionInfo::Ink;}
\DoxyCodeLine{00704     \}}
\DoxyCodeLine{00705   \}}
\DoxyCodeLine{00706 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_aabbf949273280be231e954fd88f2da88}\label{class_naa2_tlv_converter_aabbf949273280be231e954fd88f2da88}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findThinInks@{findThinInks}}
\index{findThinInks@{findThinInks}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findThinInks()}{findThinInks()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Thin\+Inks (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00542                                     \{}
\DoxyCodeLine{00543   \textcolor{keywordflow}{if} (!m\_regionRas || !m\_borderRas || m\_regions.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00544   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00545     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00546     \textcolor{keywordflow}{if} (region.type != RegionInfo::Unknown) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00547     QList<int> \&bs = region.boundaries;}
\DoxyCodeLine{00548     \textcolor{keywordflow}{if} (bs.count() == 2)}
\DoxyCodeLine{00549       region.type = RegionInfo::ThinInk;}
\DoxyCodeLine{00550     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (bs.count() == 3) \{}
\DoxyCodeLine{00551       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00552       \textcolor{keywordflow}{if} (bs[2] * 5 < bs[1]) region.type = RegionInfo::ThinInk;}
\DoxyCodeLine{00553     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00554       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00555       \textcolor{keywordtype}{int} k = 1;}
\DoxyCodeLine{00556       \textcolor{keywordtype}{int} s = 0;}
\DoxyCodeLine{00557       \textcolor{keywordflow}{while} (k < bs.count() \&\& s * 100 < region.pixelCount * 90) s += bs[k++];}
\DoxyCodeLine{00558       \textcolor{keywordflow}{if} (region.pixelCount > 100 \&\& k <= 3)}
\DoxyCodeLine{00559         region.type = RegionInfo::ThinInk;  \textcolor{comment}{// era Ink per qualche ragione}}
\DoxyCodeLine{00560     \}}
\DoxyCodeLine{00561   \}}
\DoxyCodeLine{00562 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a4935692bd8410887715578358fba22d0}\label{class_naa2_tlv_converter_a4935692bd8410887715578358fba22d0}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!findThinPaints@{findThinPaints}}
\index{findThinPaints@{findThinPaints}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{findThinPaints()}{findThinPaints()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::find\+Thin\+Paints (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00612                                       \{}
\DoxyCodeLine{00613   \textcolor{keywordtype}{int} lx = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00614   \textcolor{keywordtype}{int} ly = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00615 }
\DoxyCodeLine{00616   QList<int> regions;}
\DoxyCodeLine{00617   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00618     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00619     \textcolor{keywordflow}{if} (!region.isInk()) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00620     \textcolor{keywordflow}{if} (region.type == RegionInfo::MainInk) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00621 }
\DoxyCodeLine{00622     \textcolor{keywordtype}{int} inkBoundary = 0;}
\DoxyCodeLine{00623     QMap<int, int>::ConstIterator it;}
\DoxyCodeLine{00624     \textcolor{keywordflow}{for} (it = region.links.begin(); it != region.links.end(); ++it) \{}
\DoxyCodeLine{00625       \textcolor{keywordtype}{int} c            = it.key();}
\DoxyCodeLine{00626       \textcolor{keywordtype}{int} linkStrength = it.value();  \textcolor{comment}{// number of contact points}}
\DoxyCodeLine{00627       \textcolor{keywordflow}{if} (c >= 0 \&\& m\_regions[c].isInk()) inkBoundary += linkStrength;}
\DoxyCodeLine{00628     \}}
\DoxyCodeLine{00629     region.inkBoundary = inkBoundary;}
\DoxyCodeLine{00630     \textcolor{keywordflow}{if} (inkBoundary * 100 > region.perimeter * 80) regions.append(i);}
\DoxyCodeLine{00631   \}}
\DoxyCodeLine{00632 }
\DoxyCodeLine{00633   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} c : regions)}
\DoxyCodeLine{00634     m\_regions[c].type = RegionInfo::SmallPaint;}
\DoxyCodeLine{00635 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a19266e6fc236f1c71037b4ff9037f447}\label{class_naa2_tlv_converter_a19266e6fc236f1c71037b4ff9037f447}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!getPalette@{getPalette}}
\index{getPalette@{getPalette}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{getPalette()}{getPalette()}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$ Naa2\+Tlv\+Converter\+::get\+Palette (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption}) const\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00117 \{ \textcolor{keywordflow}{return} m\_palette; \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_ae47d71cceb01ca2b6ea9f0a20de7874e}\label{class_naa2_tlv_converter_ae47d71cceb01ca2b6ea9f0a20de7874e}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!getRegionIndex@{getRegionIndex}}
\index{getRegionIndex@{getRegionIndex}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{getRegionIndex()}{getRegionIndex()}}
{\footnotesize\ttfamily int Naa2\+Tlv\+Converter\+::get\+Region\+Index (\begin{DoxyParamCaption}\item[{int}]{x,  }\item[{int}]{y }\end{DoxyParamCaption}) const\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{00141                                          \{}
\DoxyCodeLine{00142     \textcolor{keywordflow}{if} (!!m\_regionRas \&\& 0 <= x \&\& x < m\_regionRas-\/>getLx() \&\& 0 <= y \&\&}
\DoxyCodeLine{00143         y < m\_regionRas-\/>getLy())}
\DoxyCodeLine{00144       \textcolor{keywordflow}{return} m\_regionRas-\/>pixels(y)[x];}
\DoxyCodeLine{00145     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00146       \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00147   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a99634f4451b98f749ab9b0d5f015da5b}\label{class_naa2_tlv_converter_a99634f4451b98f749ab9b0d5f015da5b}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!makeTlv@{makeTlv}}
\index{makeTlv@{makeTlv}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{makeTlv()}{makeTlv()}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_toonz_image_p}{TToonz\+ImageP}} Naa2\+Tlv\+Converter\+::make\+Tlv (\begin{DoxyParamCaption}\item[{bool}]{transparent\+Synthetic\+Inks,  }\item[{QList$<$ int $>$ \&}]{used\+Style\+Ids,  }\item[{double}]{dpi = {\ttfamily 0.0} }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01015                                                                              \{}
\DoxyCodeLine{01016   \textcolor{keywordflow}{if} (!m\_valid || m\_colors.empty() || m\_regions.empty() || !m\_regionRas)}
\DoxyCodeLine{01017     \textcolor{keywordflow}{return} \mbox{\hyperlink{class_t_toonz_image_p}{TToonzImageP}}();}
\DoxyCodeLine{01018   \textcolor{keywordtype}{int} lx                = m\_regionRas-\/>getLx();}
\DoxyCodeLine{01019   \textcolor{keywordtype}{int} ly                = m\_regionRas-\/>getLy();}
\DoxyCodeLine{01020   \mbox{\hyperlink{class_t_palette}{TPalette}} *palette     = m\_palette;}
\DoxyCodeLine{01021   \textcolor{keywordflow}{if} (!palette) palette = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_palette}{TPalette}}();}
\DoxyCodeLine{01022 }
\DoxyCodeLine{01023   \mbox{\hyperlink{class_t_raster_p_t}{TRasterCM32P}} ras(lx, ly);}
\DoxyCodeLine{01024 }
\DoxyCodeLine{01025   QList<int> styleIds;}
\DoxyCodeLine{01026 }
\DoxyCodeLine{01027   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_colors.count() -\/ 1; i++) \{}
\DoxyCodeLine{01028     TPixel32 color  = m\_colors.at(i);}
\DoxyCodeLine{01029     \textcolor{keywordtype}{int} styleId     = palette-\/>getClosestStyle(color);}
\DoxyCodeLine{01030     \mbox{\hyperlink{class_t_color_style}{TColorStyle}} *cs = styleId < 0 ? 0 : palette-\/>getStyle(styleId);}
\DoxyCodeLine{01031     \textcolor{keywordflow}{if} (cs) \{}
\DoxyCodeLine{01032       \textcolor{keywordflow}{if} (cs-\/>\mbox{\hyperlink{class_t_color_style_abd78dd4e3ff3e2e78b647195f7622aa7}{getMainColor}}() != color) cs = 0;}
\DoxyCodeLine{01033     \}}
\DoxyCodeLine{01034     \textcolor{keywordflow}{if} (cs == 0) \{}
\DoxyCodeLine{01035       styleId = palette-\/>addStyle(color);}
\DoxyCodeLine{01036       palette-\/>getPage(0)-\/>addStyle(styleId);}
\DoxyCodeLine{01037       cs = palette-\/>getStyle(styleId);}
\DoxyCodeLine{01038     \}}
\DoxyCodeLine{01039     styleIds.append(styleId);}
\DoxyCodeLine{01040     \textcolor{keywordflow}{if} (!usedStyleIds.contains(styleId)) usedStyleIds.append(styleId);}
\DoxyCodeLine{01041   \}}
\DoxyCodeLine{01042   styleIds.append(0);  \textcolor{comment}{// synthetic ink}}
\DoxyCodeLine{01043 }
\DoxyCodeLine{01044   \textcolor{comment}{// int syntheticInkStyleId = palette-\/>getPage(0)-\/>addStyle(TPixel32(0,0,0,0));}}
\DoxyCodeLine{01045   \textcolor{comment}{// styleIds.append(syntheticInkStyleId);}}
\DoxyCodeLine{01046 }
\DoxyCodeLine{01047   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{01048     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *workScanLine = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{01049     \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}} *outScanLine      = ras-\/>pixels(y);}
\DoxyCodeLine{01050     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{01051       \textcolor{keywordtype}{int} c = workScanLine[x];}
\DoxyCodeLine{01052       Q\_ASSERT(0 <= c \&\& c < m\_regions.count());}
\DoxyCodeLine{01053 }
\DoxyCodeLine{01054       \textcolor{keywordtype}{int} color = m\_regions[c].colorIndex;}
\DoxyCodeLine{01055       Q\_ASSERT(0 <= color \&\& color < styleIds.count());}
\DoxyCodeLine{01056 }
\DoxyCodeLine{01057       \textcolor{keywordtype}{int} styleId = styleIds.at(color);}
\DoxyCodeLine{01058 }
\DoxyCodeLine{01059       RegionInfo::Type type = m\_regions.at(c).type;}
\DoxyCodeLine{01060       \textcolor{keywordflow}{if} (type == RegionInfo::Background)}
\DoxyCodeLine{01061         outScanLine[x] = \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}}();}
\DoxyCodeLine{01062       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (type \& RegionInfo::Ink)}
\DoxyCodeLine{01063         outScanLine[x] = \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}}(styleId, 0, 0);}
\DoxyCodeLine{01064       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (m\_syntheticInkRas-\/>pixels(y)[x] == 1)}
\DoxyCodeLine{01065         outScanLine[x] =}
\DoxyCodeLine{01066             \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}}(transparentSyntheticInks ? 0 : styleId, 0, 0);}
\DoxyCodeLine{01067       \textcolor{keywordflow}{else}}
\DoxyCodeLine{01068         outScanLine[x] = \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}}(0, styleId, 255);}
\DoxyCodeLine{01069     \}}
\DoxyCodeLine{01070   \}}
\DoxyCodeLine{01071 }
\DoxyCodeLine{01072   \textcolor{keyword}{struct }locals \{}
\DoxyCodeLine{01073     \textcolor{keyword}{static} \textcolor{keywordtype}{bool} compare(\textcolor{keyword}{const} QPair<int, int> \&p1, \textcolor{keyword}{const} QPair<int, int> \&p2) \{}
\DoxyCodeLine{01074       \textcolor{keywordflow}{return} p1.second > p2.second;}
\DoxyCodeLine{01075     \}}
\DoxyCodeLine{01076 }
\DoxyCodeLine{01077     \textcolor{keyword}{static} \textcolor{keywordtype}{void} addPaint(QList<QPair<int, int>> \&list, \textcolor{keyword}{const} \textcolor{keywordtype}{int} paintId) \{}
\DoxyCodeLine{01078       \textcolor{keywordflow}{if} (paintId == 0) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01079       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < list.size(); i++)}
\DoxyCodeLine{01080         \textcolor{keywordflow}{if} (list[i].first == paintId) \{}
\DoxyCodeLine{01081           list[i].second += 1;}
\DoxyCodeLine{01082           \textcolor{keywordflow}{return};}
\DoxyCodeLine{01083         \}}
\DoxyCodeLine{01084       list.append(QPair<int, int>(paintId, 1));}
\DoxyCodeLine{01085     \}}
\DoxyCodeLine{01086   \};  \textcolor{comment}{// locals}}
\DoxyCodeLine{01087 }
\DoxyCodeLine{01088   \textcolor{comment}{// Here, expand paint area under the solid ink pixel in order to prevent the}}
\DoxyCodeLine{01089   \textcolor{comment}{// gap appears when the "{}Add Antialiasing"{} option is activated.}}
\DoxyCodeLine{01090   \mbox{\hyperlink{class_t_raster_p_t}{TRasterCM32P}} copiedRas = ras-\/>clone();}
\DoxyCodeLine{01091   copiedRas-\/>lock();}
\DoxyCodeLine{01092   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{01093     \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}} *topScanLine    = copiedRas-\/>pixels((y == 0) ? y : y -\/ 1);}
\DoxyCodeLine{01094     \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}} *middleScanLine = copiedRas-\/>pixels(y);}
\DoxyCodeLine{01095     \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}} *bottomScanLine = copiedRas-\/>pixels((y == ly -\/ 1) ? y : y + 1);}
\DoxyCodeLine{01096     \mbox{\hyperlink{class_t_pixel_c_m32}{TPixelCM32}} *outScanLine    = ras-\/>pixels(y);}
\DoxyCodeLine{01097     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{01098       \textcolor{keywordflow}{if} (!middleScanLine[x].isPureInk() || middleScanLine[x].getPaint() != 0)}
\DoxyCodeLine{01099         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01100 }
\DoxyCodeLine{01101       \textcolor{keywordtype}{int} prev\_x = (x == 0) ? x : x -\/ 1;}
\DoxyCodeLine{01102       \textcolor{keywordtype}{int} next\_x = (x == lx -\/ 1) ? x : x + 1;}
\DoxyCodeLine{01103       QList<QPair<int, int>> neighborPaints;}
\DoxyCodeLine{01104       locals::addPaint(neighborPaints, topScanLine[prev\_x].getPaint());}
\DoxyCodeLine{01105       locals::addPaint(neighborPaints, topScanLine[x].getPaint());}
\DoxyCodeLine{01106       locals::addPaint(neighborPaints, topScanLine[next\_x].getPaint());}
\DoxyCodeLine{01107       locals::addPaint(neighborPaints, middleScanLine[prev\_x].getPaint());}
\DoxyCodeLine{01108       locals::addPaint(neighborPaints, middleScanLine[next\_x].getPaint());}
\DoxyCodeLine{01109       locals::addPaint(neighborPaints, bottomScanLine[prev\_x].getPaint());}
\DoxyCodeLine{01110       locals::addPaint(neighborPaints, bottomScanLine[x].getPaint());}
\DoxyCodeLine{01111       locals::addPaint(neighborPaints, bottomScanLine[next\_x].getPaint());}
\DoxyCodeLine{01112       std::sort(neighborPaints.begin(), neighborPaints.end(), locals::compare);}
\DoxyCodeLine{01113 }
\DoxyCodeLine{01114       \textcolor{keywordflow}{if} (!neighborPaints.isEmpty())}
\DoxyCodeLine{01115         outScanLine[x].setPaint(neighborPaints[0].first);}
\DoxyCodeLine{01116     \}}
\DoxyCodeLine{01117   \}}
\DoxyCodeLine{01118   copiedRas-\/>unlock();}
\DoxyCodeLine{01119 }
\DoxyCodeLine{01120   \mbox{\hyperlink{class_t_toonz_image_p}{TToonzImageP}} ti = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_toonz_image}{TToonzImage}}(ras, ras-\/>getBounds());}
\DoxyCodeLine{01121   ti-\/>setPalette(palette);}
\DoxyCodeLine{01122 }
\DoxyCodeLine{01123   \textcolor{keywordflow}{if} (dpi > 0.0)  \textcolor{comment}{// for now, accept only square pixel}}
\DoxyCodeLine{01124     ti-\/>setDpi(dpi, dpi);}
\DoxyCodeLine{01125   \textcolor{keywordflow}{else}}
\DoxyCodeLine{01126     ti-\/>setDpi(72, 72);}
\DoxyCodeLine{01127 }
\DoxyCodeLine{01128   \textcolor{keywordflow}{return} ti;}
\DoxyCodeLine{01129 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_afcbe43bcb6bb6cec6da9b42068feeddb}\label{class_naa2_tlv_converter_afcbe43bcb6bb6cec6da9b42068feeddb}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!measureThickness@{measureThickness}}
\index{measureThickness@{measureThickness}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{measureThickness()}{measureThickness()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::measure\+Thickness (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00808                                         \{}
\DoxyCodeLine{00809   QTime timer;}
\DoxyCodeLine{00810   timer.start();}
\DoxyCodeLine{00811   \textcolor{keywordflow}{if} (!m\_regionRas || !m\_borderRas) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00812   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *regionBuffer = m\_regionRas-\/>pixels();}
\DoxyCodeLine{00813   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *borderBuffer  = m\_borderRas-\/>pixels();}
\DoxyCodeLine{00814   \textcolor{keywordtype}{int} lx                       = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00815   \textcolor{keywordtype}{int} ly                       = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00816 }
\DoxyCodeLine{00817   \textcolor{keywordflow}{if} (!m\_dotRas || m\_dotRas-\/>getLx() != lx || m\_dotRas-\/>getLy() != ly) \{}
\DoxyCodeLine{00818     \textcolor{keyword}{delete} m\_dotRas;}
\DoxyCodeLine{00819     m\_dotRas = \textcolor{keyword}{new} \mbox{\hyperlink{class_work_raster}{WorkRaster<unsigned char>}}(lx, ly);}
\DoxyCodeLine{00820   \}}
\DoxyCodeLine{00821   memset(m\_dotRas-\/>pixels(), 0, lx * ly);}
\DoxyCodeLine{00822   \textcolor{comment}{// for(int i=0;i<lx*ly;i++) m\_dotRas-\/>pixels()[i]=0;}}
\DoxyCodeLine{00823 }
\DoxyCodeLine{00824   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *dotBuffer = m\_dotRas-\/>pixels();}
\DoxyCodeLine{00825 }
\DoxyCodeLine{00826   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00827     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00828       \textcolor{keywordflow}{if} (borderBuffer[y * lx + x] != 1) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00829       \textcolor{keywordflow}{if} (dotBuffer[y * lx + x] != 0) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00830       \textcolor{keywordtype}{int} regionId       = regionBuffer[y * lx + x];}
\DoxyCodeLine{00831       \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[regionId];}
\DoxyCodeLine{00832       \textcolor{keywordtype}{int} type           = region.type;}
\DoxyCodeLine{00833       \textcolor{keywordflow}{if} (type == RegionInfo::Background || type == RegionInfo::LargePaint ||}
\DoxyCodeLine{00834           type == RegionInfo::ThinInk)}
\DoxyCodeLine{00835         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00836 }
\DoxyCodeLine{00837       \textcolor{keywordtype}{int} thickness = measureThickness(x, y);}
\DoxyCodeLine{00838       \textcolor{keywordflow}{if} (thickness < 1) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00839       QMap<int, int>::Iterator it = region.thicknessHistogram.find(thickness);}
\DoxyCodeLine{00840       \textcolor{keywordflow}{if} (it != region.thicknessHistogram.end())}
\DoxyCodeLine{00841         it.value() += 1;}
\DoxyCodeLine{00842       \textcolor{keywordflow}{else}}
\DoxyCodeLine{00843         region.thicknessHistogram.insert(thickness, 1);}
\DoxyCodeLine{00844     \}}
\DoxyCodeLine{00845   \}}
\DoxyCodeLine{00846 }
\DoxyCodeLine{00847   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) \{}
\DoxyCodeLine{00848     \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&region = m\_regions[i];}
\DoxyCodeLine{00849     \textcolor{keywordtype}{int} type           = region.type;}
\DoxyCodeLine{00850     \textcolor{keywordflow}{if} (type == RegionInfo::Background || type == RegionInfo::LargePaint ||}
\DoxyCodeLine{00851         type == RegionInfo::ThinInk)}
\DoxyCodeLine{00852       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00853     \textcolor{keywordtype}{int} thicknessCount = 0;}
\DoxyCodeLine{00854     \textcolor{keywordtype}{double} thickness   = 0.0;}
\DoxyCodeLine{00855     \textcolor{keywordflow}{for} (QMap<int, int>::Iterator it = region.thicknessHistogram.begin();}
\DoxyCodeLine{00856          it != region.thicknessHistogram.end(); ++it) \{}
\DoxyCodeLine{00857       thicknessCount += it.value();}
\DoxyCodeLine{00858       thickness += it.key() * it.value();}
\DoxyCodeLine{00859     \}}
\DoxyCodeLine{00860     \textcolor{keywordflow}{if} (thicknessCount > 0) \{}
\DoxyCodeLine{00861       thickness *= 1.0 / thicknessCount;}
\DoxyCodeLine{00862       region.thickness = thickness;}
\DoxyCodeLine{00863     \}}
\DoxyCodeLine{00864   \}}
\DoxyCodeLine{00865   qDebug() << \textcolor{stringliteral}{"{}measure thickness. time="{}} << timer.elapsed();}
\DoxyCodeLine{00866 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a49611b50e7951a08c0c27fd4602e96e7}\label{class_naa2_tlv_converter_a49611b50e7951a08c0c27fd4602e96e7}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!measureThickness@{measureThickness}}
\index{measureThickness@{measureThickness}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{measureThickness()}{measureThickness()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily int Naa2\+Tlv\+Converter\+::measure\+Thickness (\begin{DoxyParamCaption}\item[{int}]{x,  }\item[{int}]{y }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00870                                                      \{}
\DoxyCodeLine{00871   \textcolor{keywordflow}{if} (!m\_regionRas || !m\_borderRas || !m\_dotRas) \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00872   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *regionBuffer = m\_regionRas-\/>pixels();}
\DoxyCodeLine{00873   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *borderBuffer  = m\_borderRas-\/>pixels();}
\DoxyCodeLine{00874   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} *dotBuffer     = m\_dotRas-\/>pixels();}
\DoxyCodeLine{00875 }
\DoxyCodeLine{00876   \textcolor{keywordtype}{int} lx = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00877   \textcolor{keywordtype}{int} ly = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00878 }
\DoxyCodeLine{00879   \textcolor{keywordtype}{int} k0 = lx * y0 + x0;}
\DoxyCodeLine{00880   \textcolor{comment}{// no needs to worry about image limits}}
\DoxyCodeLine{00881   \textcolor{keywordflow}{if} (x0 -\/ 1 < 0 || x0 + 1 >= lx || y0 -\/ 1 < 0 || y0 + 1 >= ly) \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00882   \textcolor{comment}{// we must start from a border}}
\DoxyCodeLine{00883   \textcolor{keywordflow}{if} (borderBuffer[k0] != 1) \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00884 }
\DoxyCodeLine{00885   \textcolor{comment}{// far from other measures}}
\DoxyCodeLine{00886   \textcolor{keywordflow}{if} (dotBuffer[k0] != 0) \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00887 }
\DoxyCodeLine{00888   \textcolor{keywordtype}{int} regionId     = regionBuffer[k0];}
\DoxyCodeLine{00889   \mbox{\hyperlink{struct_region_info}{RegionInfo}} \&info = m\_regions[regionId];}
\DoxyCodeLine{00890 }
\DoxyCodeLine{00891   \textcolor{comment}{// directions}}
\DoxyCodeLine{00892   \textcolor{keyword}{const} \textcolor{keywordtype}{int} dd[8] = \{1, lx + 1, lx, lx -\/ 1, -\/1, -\/1 -\/ lx, -\/lx, 1 -\/ lx\};}
\DoxyCodeLine{00893 }
\DoxyCodeLine{00894   \textcolor{comment}{// a is a direction index; a : inside; a+1 : outside}}
\DoxyCodeLine{00895   \textcolor{keywordtype}{int} a = 0;}
\DoxyCodeLine{00896   \textcolor{keywordflow}{while} (a < 8 \&\&}
\DoxyCodeLine{00897          !(regionBuffer[k0 + dd[a]] == regionId \&\&}
\DoxyCodeLine{00898            regionBuffer[k0 + dd[(a + 1) \% 8]] != regionId))}
\DoxyCodeLine{00899     a++;}
\DoxyCodeLine{00900   \textcolor{keywordflow}{if} (a == 8) \{}
\DoxyCodeLine{00901     \textcolor{comment}{// k0 is an isolated point or (strange!) an intern point}}
\DoxyCodeLine{00902     qDebug() << \textcolor{stringliteral}{"{}Isolated point or intern point"{}};}
\DoxyCodeLine{00903     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00904   \}}
\DoxyCodeLine{00905   \textcolor{keywordtype}{int} ka = k0 + dd[a];}
\DoxyCodeLine{00906 }
\DoxyCodeLine{00907   \textcolor{keywordtype}{int} b                                          = (a + 2) \% 8;}
\DoxyCodeLine{00908   \textcolor{keywordflow}{while} (regionBuffer[k0 + dd[b]] != regionId) b = (b + 1) \% 8;}
\DoxyCodeLine{00909   \textcolor{comment}{// a..b = boundaries}}
\DoxyCodeLine{00910   \textcolor{keywordtype}{int} kb = k0 + dd[b];}
\DoxyCodeLine{00911   \textcolor{keywordflow}{if} (a == b || ((b + 1) \% 8) == a) \textcolor{keywordflow}{return} -\/1;  \textcolor{comment}{// k0 is a corner}}
\DoxyCodeLine{00912 }
\DoxyCodeLine{00913   dotBuffer[k0] = 1;}
\DoxyCodeLine{00914   dotBuffer[ka] = 2;}
\DoxyCodeLine{00915   dotBuffer[kb] = 3;}
\DoxyCodeLine{00916 }
\DoxyCodeLine{00917   \textcolor{keywordtype}{int} c       = (b + 1) \% 8;}
\DoxyCodeLine{00918   \textcolor{keywordtype}{bool} isThin = \textcolor{keyword}{false};}
\DoxyCodeLine{00919   \textcolor{keywordflow}{while} (c != a) \{}
\DoxyCodeLine{00920     \textcolor{keywordflow}{if} (regionBuffer[k0 + dd[c]] != regionId) \{}
\DoxyCodeLine{00921       isThin = \textcolor{keyword}{true};}
\DoxyCodeLine{00922       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00923     \}}
\DoxyCodeLine{00924     c = (c + 1) \% 8;}
\DoxyCodeLine{00925   \}}
\DoxyCodeLine{00926   \textcolor{keywordflow}{if} (isThin) \{}
\DoxyCodeLine{00927     \textcolor{comment}{// stroke larga un pixel, con paint da una parte e dall'altra.}}
\DoxyCodeLine{00928     \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{00929   \}}
\DoxyCodeLine{00930 }
\DoxyCodeLine{00931   \textcolor{keywordtype}{int} baseLength = 3;}
\DoxyCodeLine{00932 }
\DoxyCodeLine{00933   \textcolor{keywordtype}{int} d      = b;}
\DoxyCodeLine{00934   \textcolor{keywordtype}{int} oldk   = k0;}
\DoxyCodeLine{00935   \textcolor{keywordtype}{int} k      = kb;}
\DoxyCodeLine{00936   \textcolor{keywordtype}{int} lastd2 = 0;}
\DoxyCodeLine{00937   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < baseLength; i++) \{}
\DoxyCodeLine{00938     \textcolor{keywordtype}{int} x = k \% lx;}
\DoxyCodeLine{00939     \textcolor{keywordtype}{int} y = k / lx;}
\DoxyCodeLine{00940     \textcolor{keywordflow}{if} (x <= 1 || x >= lx -\/ 1 || y <= 1 || y >= ly -\/ 1)}
\DoxyCodeLine{00941       \textcolor{keywordflow}{break};  \textcolor{comment}{// just to be sure}}
\DoxyCodeLine{00942     \textcolor{keywordtype}{int} d2 = (x -\/ x0) * (x -\/ x0) + (y -\/ y0) * (y -\/ y0);}
\DoxyCodeLine{00943     \textcolor{keywordflow}{if} (d2 <= lastd2) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00944     lastd2                                          = d2;}
\DoxyCodeLine{00945     \textcolor{keywordtype}{int} d1                                          = (d + 4) \% 8;}
\DoxyCodeLine{00946     d1                                              = (d1 + 1) \% 8;}
\DoxyCodeLine{00947     \textcolor{keywordflow}{while} (regionBuffer[k + dd[d1]] != regionId) d1 = (d1 + 1) \% 8;}
\DoxyCodeLine{00948     Q\_ASSERT(regionBuffer[k + dd[d1]] == regionId);}
\DoxyCodeLine{00949     oldk         = k;}
\DoxyCodeLine{00950     k            = k + dd[d1];}
\DoxyCodeLine{00951     d            = d1;}
\DoxyCodeLine{00952     dotBuffer[k] = 4;}
\DoxyCodeLine{00953   \}}
\DoxyCodeLine{00954 }
\DoxyCodeLine{00955   \textcolor{comment}{// punto ad un estremo (lungo il confine)}}
\DoxyCodeLine{00956   \textcolor{keywordtype}{int} x1 = k \% lx;}
\DoxyCodeLine{00957   \textcolor{keywordtype}{int} y1 = k / lx;}
\DoxyCodeLine{00958 }
\DoxyCodeLine{00959   d      = a;}
\DoxyCodeLine{00960   oldk   = k0;}
\DoxyCodeLine{00961   k      = ka;}
\DoxyCodeLine{00962   lastd2 = 0;}
\DoxyCodeLine{00963   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < baseLength; i++) \{}
\DoxyCodeLine{00964     \textcolor{keywordtype}{int} x = k \% lx;}
\DoxyCodeLine{00965     \textcolor{keywordtype}{int} y = k / lx;}
\DoxyCodeLine{00966     \textcolor{keywordflow}{if} (x <= 1 || x >= lx -\/ 1 || y <= 1 || y >= ly -\/ 1)}
\DoxyCodeLine{00967       \textcolor{keywordflow}{break};  \textcolor{comment}{// just to be sure}}
\DoxyCodeLine{00968     \textcolor{keywordtype}{int} d2 = (x -\/ x0) * (x -\/ x0) + (y -\/ y0) * (y -\/ y0);}
\DoxyCodeLine{00969     \textcolor{keywordflow}{if} (d2 <= lastd2) \textcolor{keywordflow}{break};}
\DoxyCodeLine{00970     lastd2                                          = d2;}
\DoxyCodeLine{00971     \textcolor{keywordtype}{int} d1                                          = (d + 4) \% 8;}
\DoxyCodeLine{00972     d1                                              = (d1 + 7) \% 8;}
\DoxyCodeLine{00973     \textcolor{keywordflow}{while} (regionBuffer[k + dd[d1]] != regionId) d1 = (d1 + 7) \% 8;}
\DoxyCodeLine{00974     Q\_ASSERT(regionBuffer[k + dd[d1]] == regionId);}
\DoxyCodeLine{00975     oldk         = k;}
\DoxyCodeLine{00976     k            = k + dd[d1];}
\DoxyCodeLine{00977     d            = d1;}
\DoxyCodeLine{00978     dotBuffer[k] = 5;}
\DoxyCodeLine{00979   \}}
\DoxyCodeLine{00980 }
\DoxyCodeLine{00981   \textcolor{comment}{// punto all'estremo opposto (lungo il confine)}}
\DoxyCodeLine{00982   \textcolor{keywordtype}{int} x2 = k \% lx;}
\DoxyCodeLine{00983   \textcolor{keywordtype}{int} y2 = k / lx;}
\DoxyCodeLine{00984 }
\DoxyCodeLine{00985   \textcolor{keywordtype}{int} dx = y2 -\/ y1, dy = x1 -\/ x2;}
\DoxyCodeLine{00986 }
\DoxyCodeLine{00987   \textcolor{keywordtype}{int} delta2 = dx * dx + dy * dy;}
\DoxyCodeLine{00988   \textcolor{keywordflow}{if} (delta2 < baseLength * baseLength * 3) \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{00989 }
\DoxyCodeLine{00990   \textcolor{keywordtype}{int} adx = abs(dx), ady = abs(dy);}
\DoxyCodeLine{00991   \textcolor{keywordtype}{int} sgx = dx > 0 ? 1 : -\/1, sgy = dy > 0 ? 1 : -\/1;}
\DoxyCodeLine{00992   \textcolor{keywordtype}{int} thickness          = 1;}
\DoxyCodeLine{00993   \textcolor{keyword}{const} \textcolor{keywordtype}{int} maxThickness = 64;}
\DoxyCodeLine{00994   \textcolor{keywordflow}{for} (; thickness < maxThickness; thickness++) \{}
\DoxyCodeLine{00995     \textcolor{keywordtype}{int} x, y;}
\DoxyCodeLine{00996     \textcolor{keywordflow}{if} (adx > ady) \{}
\DoxyCodeLine{00997       x = x0 + thickness * sgx;}
\DoxyCodeLine{00998       y = y0 + sgy * (thickness * ady + adx / 2) / adx;}
\DoxyCodeLine{00999     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01000       y = y0 + thickness * sgy;}
\DoxyCodeLine{01001       x = x0 + sgx * (thickness * adx + ady / 2) / ady;}
\DoxyCodeLine{01002     \}}
\DoxyCodeLine{01003     k = y * lx + x;}
\DoxyCodeLine{01004     \textcolor{keywordflow}{if} (0 <= x \&\& x < lx \&\& 0 <= y \&\& y < ly \&\& regionBuffer[k] == regionId)}
\DoxyCodeLine{01005       dotBuffer[k] = 6;}
\DoxyCodeLine{01006     \textcolor{keywordflow}{else}}
\DoxyCodeLine{01007       \textcolor{keywordflow}{break};}
\DoxyCodeLine{01008   \}}
\DoxyCodeLine{01009   \textcolor{keywordflow}{return} thickness;}
\DoxyCodeLine{01010 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_adac817fad601b5981867163088f4cec2}\label{class_naa2_tlv_converter_adac817fad601b5981867163088f4cec2}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!process@{process}}
\index{process@{process}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{process()}{process()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::process (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} \&}]{src\+Ras }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00070                                                        \{}
\DoxyCodeLine{00071   m\_valid = \textcolor{keyword}{false};}
\DoxyCodeLine{00072   setSourceImage(srcRas);}
\DoxyCodeLine{00073   \textcolor{keywordflow}{if} (!m\_valid) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00074 }
\DoxyCodeLine{00075   separateRegions();}
\DoxyCodeLine{00076 }
\DoxyCodeLine{00077   computeLinks();}
\DoxyCodeLine{00078 }
\DoxyCodeLine{00079   findRegionBorders();}
\DoxyCodeLine{00080   erodeRegions();}
\DoxyCodeLine{00081 }
\DoxyCodeLine{00082   findLargePaints();}
\DoxyCodeLine{00083 }
\DoxyCodeLine{00084   findBackgroundRegions();}
\DoxyCodeLine{00085   findMainInks();}
\DoxyCodeLine{00086 }
\DoxyCodeLine{00087   \textcolor{comment}{// computeMainInkThickness();}}
\DoxyCodeLine{00088   findThinInks();}
\DoxyCodeLine{00089 }
\DoxyCodeLine{00090   measureThickness();}
\DoxyCodeLine{00091 }
\DoxyCodeLine{00092   \textcolor{comment}{// findPaints();}}
\DoxyCodeLine{00093   findPaints2();}
\DoxyCodeLine{00094 }
\DoxyCodeLine{00095   findThinPaints();}
\DoxyCodeLine{00096 }
\DoxyCodeLine{00097   findSuspectInks();}
\DoxyCodeLine{00098 }
\DoxyCodeLine{00099   addBorderInks();}
\DoxyCodeLine{00100 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_ad72599e811a8f2211fc47982ac7a86c0}\label{class_naa2_tlv_converter_ad72599e811a8f2211fc47982ac7a86c0}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!removeUnusedStyles@{removeUnusedStyles}}
\index{removeUnusedStyles@{removeUnusedStyles}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{removeUnusedStyles()}{removeUnusedStyles()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::remove\+Unused\+Styles (\begin{DoxyParamCaption}\item[{const QList$<$ int $>$ \&}]{style\+Ids }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01165                                                                     \{}
\DoxyCodeLine{01166   \textcolor{comment}{// Remove unused styles from input palette}}
\DoxyCodeLine{01167   \textcolor{keywordflow}{if} (!m\_palette) \textcolor{keywordflow}{return};}
\DoxyCodeLine{01168   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} p = m\_palette-\/>\mbox{\hyperlink{class_t_palette_afd211cadf0f047450bc31897f858fa73}{getPageCount}}() -\/ 1; p >= 0; p-\/-\/) \{}
\DoxyCodeLine{01169     \mbox{\hyperlink{class_t_palette_1_1_page}{TPalette::Page}} *page = m\_palette-\/>\mbox{\hyperlink{class_t_palette_a25f83b7baf3eb774e50c726fa702056c}{getPage}}(p);}
\DoxyCodeLine{01170     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} s = page-\/>\mbox{\hyperlink{class_t_palette_1_1_page_ae6d6b899ee10f5b3900081acd882f8ee}{getStyleCount}}() -\/ 1; s >= 0; s-\/-\/) \{}
\DoxyCodeLine{01171       \textcolor{keywordtype}{int} styleId = page-\/>\mbox{\hyperlink{class_t_palette_1_1_page_a3d6eed995ee8b1c22d50a73911a45786}{getStyleId}}(s);}
\DoxyCodeLine{01172       \textcolor{keywordflow}{if} (styleId == -\/1) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01173       \textcolor{comment}{// check if the style is used or not}}
\DoxyCodeLine{01174       \textcolor{keywordflow}{if} (!styleIds.contains(styleId)) page-\/>\mbox{\hyperlink{class_t_palette_1_1_page_a7619abc839bf063d3065596235171982}{removeStyle}}(s);}
\DoxyCodeLine{01175     \}}
\DoxyCodeLine{01176     \textcolor{comment}{// erase empty page}}
\DoxyCodeLine{01177     \textcolor{keywordflow}{if} (page-\/>\mbox{\hyperlink{class_t_palette_1_1_page_ae6d6b899ee10f5b3900081acd882f8ee}{getStyleCount}}() == 0) m\_palette-\/>\mbox{\hyperlink{class_t_palette_a6a18830b8f209aac7c13bccfe88b19e4}{erasePage}}(p);}
\DoxyCodeLine{01178   \}}
\DoxyCodeLine{01179 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a9c95132fcdc0f8e7243b526c34929cbb}\label{class_naa2_tlv_converter_a9c95132fcdc0f8e7243b526c34929cbb}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!separateRegions@{separateRegions}}
\index{separateRegions@{separateRegions}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{separateRegions()}{separateRegions()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::separate\+Regions (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00168                                        \{}
\DoxyCodeLine{00169   \textcolor{keywordflow}{if} (!m\_regionRas) \textcolor{keywordflow}{return};}
\DoxyCodeLine{00170   \textcolor{keyword}{const} \textcolor{keywordtype}{int} lx   = m\_regionRas-\/>getLx();}
\DoxyCodeLine{00171   \textcolor{keyword}{const} \textcolor{keywordtype}{int} ly   = m\_regionRas-\/>getLy();}
\DoxyCodeLine{00172   \textcolor{keyword}{const} \textcolor{keywordtype}{int} wrap = lx;}
\DoxyCodeLine{00173 }
\DoxyCodeLine{00174   \textcolor{comment}{// we assume that m\_regions contains almost no information (except:}}
\DoxyCodeLine{00175   \textcolor{comment}{// m\_regions[i].colorIndex == i)}}
\DoxyCodeLine{00176   m\_regions.clear();}
\DoxyCodeLine{00177 }
\DoxyCodeLine{00178   \mbox{\hyperlink{class_work_raster}{WorkRaster<int>}} wb(lx, ly);  \textcolor{comment}{// work buffer}}
\DoxyCodeLine{00179 }
\DoxyCodeLine{00180   QVector<int> regionMap;  \textcolor{comment}{// wb pixels => region indices}}
\DoxyCodeLine{00181   QList<int> freeRegions;}
\DoxyCodeLine{00182 }
\DoxyCodeLine{00183   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00184     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *waScanLine = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00185     \textcolor{keywordtype}{int} *wbScanLine            = wb.pixels(y);}
\DoxyCodeLine{00186     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00187       \textcolor{keywordtype}{int} c       = waScanLine[x];}
\DoxyCodeLine{00188       \textcolor{keywordtype}{int} cUp     = y > 0 ? waScanLine[x -\/ wrap] : -\/1;}
\DoxyCodeLine{00189       \textcolor{keywordtype}{int} cLeft   = x > 0 ? waScanLine[x -\/ 1] : -\/1;}
\DoxyCodeLine{00190       \textcolor{keywordtype}{int} cUpLeft = x > 0 \&\& y > 0 ? waScanLine[x -\/ wrap -\/ 1] : -\/1;}
\DoxyCodeLine{00191 }
\DoxyCodeLine{00192       \textcolor{keywordflow}{if} (c != cUp \&\& c != cLeft \&\& c != cUpLeft) \{}
\DoxyCodeLine{00193         \textcolor{comment}{// no connection: create a new region}}
\DoxyCodeLine{00194         Q\_ASSERT(0 <= c \&\& c < m\_colors.count());}
\DoxyCodeLine{00195         \mbox{\hyperlink{struct_region_info}{RegionInfo}} region;}
\DoxyCodeLine{00196         region.colorIndex = c;}
\DoxyCodeLine{00197         \textcolor{keywordtype}{int} regionIndex;}
\DoxyCodeLine{00198         \textcolor{keywordflow}{if} (!freeRegions.empty()) \{}
\DoxyCodeLine{00199           \textcolor{comment}{// use a previously discarded region}}
\DoxyCodeLine{00200           regionIndex = freeRegions.back();}
\DoxyCodeLine{00201           freeRegions.pop\_back();}
\DoxyCodeLine{00202           m\_regions[regionIndex] = region;}
\DoxyCodeLine{00203         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00204           \textcolor{comment}{// create a new region}}
\DoxyCodeLine{00205           regionIndex = m\_regions.count();}
\DoxyCodeLine{00206           m\_regions.append(region);}
\DoxyCodeLine{00207         \}}
\DoxyCodeLine{00208         wbScanLine[x] = regionMap.count();}
\DoxyCodeLine{00209         regionMap.append(regionIndex);}
\DoxyCodeLine{00210       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00211         \textcolor{comment}{// at least one connection}}
\DoxyCodeLine{00212         \textcolor{keywordflow}{if} (c == cUpLeft)}
\DoxyCodeLine{00213           wbScanLine[x] = wbScanLine[x -\/ wrap -\/ 1];}
\DoxyCodeLine{00214         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (c == cUp)}
\DoxyCodeLine{00215           wbScanLine[x] = wbScanLine[x -\/ wrap];}
\DoxyCodeLine{00216         \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00217           Q\_ASSERT(c == cLeft);}
\DoxyCodeLine{00218           wbScanLine[x] = wbScanLine[x -\/ 1];}
\DoxyCodeLine{00219         \}}
\DoxyCodeLine{00220       \}}
\DoxyCodeLine{00221 }
\DoxyCodeLine{00222       \textcolor{comment}{// merge if needed}}
\DoxyCodeLine{00223       \textcolor{keywordflow}{if} (cUp == cLeft \&\& cUp >= 0 \&\&}
\DoxyCodeLine{00224           regionMap[wbScanLine[x -\/ 1]] != regionMap[wbScanLine[x -\/ wrap]]) \{}
\DoxyCodeLine{00225         \textcolor{comment}{// merge}}
\DoxyCodeLine{00226         \textcolor{keywordtype}{int} pixelToDiscard = wbScanLine[x -\/ 1];}
\DoxyCodeLine{00227         \textcolor{keywordtype}{int} pixelToKeep    = wbScanLine[x -\/ wrap];}
\DoxyCodeLine{00228         Q\_ASSERT(pixelToDiscard != pixelToKeep);}
\DoxyCodeLine{00229         \textcolor{keywordtype}{int} regionToDiscard = regionMap[pixelToDiscard];}
\DoxyCodeLine{00230         \textcolor{keywordtype}{int} regionToKeep    = regionMap[pixelToKeep];}
\DoxyCodeLine{00231         Q\_ASSERT(regionToDiscard != regionToKeep);}
\DoxyCodeLine{00232         Q\_ASSERT(m\_regions[regionToDiscard].type != RegionInfo::Unused);}
\DoxyCodeLine{00233         Q\_ASSERT(m\_regions[regionToKeep].type != RegionInfo::Unused);}
\DoxyCodeLine{00234         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < regionMap.count(); i++)}
\DoxyCodeLine{00235           \textcolor{keywordflow}{if} (regionMap[i] == regionToDiscard) regionMap[i] = regionToKeep;}
\DoxyCodeLine{00236         \textcolor{comment}{// wbScanLine[x] = pixelToKeep;}}
\DoxyCodeLine{00237         m\_regions[regionToDiscard].type = RegionInfo::Unused;}
\DoxyCodeLine{00238         freeRegions.append(regionToDiscard);}
\DoxyCodeLine{00239       \}}
\DoxyCodeLine{00240     \}}
\DoxyCodeLine{00241   \}}
\DoxyCodeLine{00242 }
\DoxyCodeLine{00243   \textcolor{comment}{// fill gaps}}
\DoxyCodeLine{00244   \textcolor{keywordflow}{for} (;;) \{}
\DoxyCodeLine{00245     \textcolor{comment}{// just remove topmost Unused regions}}
\DoxyCodeLine{00246     \textcolor{keywordflow}{if} (!m\_regions.empty() \&\& m\_regions.back().type == RegionInfo::Unused) \{}
\DoxyCodeLine{00247       m\_regions.pop\_back();}
\DoxyCodeLine{00248       \textcolor{keywordtype}{int} k = m\_regions.count();}
\DoxyCodeLine{00249       freeRegions.removeAll(k);}
\DoxyCodeLine{00250     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!freeRegions.empty()) \{}
\DoxyCodeLine{00251       \textcolor{comment}{// last region is used, but there is at least a free region with lower}}
\DoxyCodeLine{00252       \textcolor{comment}{// index: move it there}}
\DoxyCodeLine{00253       \textcolor{keywordtype}{int} regionToDiscard = m\_regions.count() -\/ 1;}
\DoxyCodeLine{00254       \textcolor{keywordtype}{int} regionToKeep    = freeRegions.back();}
\DoxyCodeLine{00255       freeRegions.pop\_back();}
\DoxyCodeLine{00256       Q\_ASSERT(m\_regions[regionToKeep].type == RegionInfo::Unused);}
\DoxyCodeLine{00257       Q\_ASSERT(m\_regions[regionToDiscard].type != RegionInfo::Unused);}
\DoxyCodeLine{00258       Q\_ASSERT(regionToKeep < regionToDiscard);}
\DoxyCodeLine{00259       m\_regions[regionToKeep] = m\_regions[regionToDiscard];}
\DoxyCodeLine{00260       \textcolor{comment}{// pop the region to discard}}
\DoxyCodeLine{00261       m\_regions.pop\_back();}
\DoxyCodeLine{00262       \textcolor{comment}{// update map}}
\DoxyCodeLine{00263       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < regionMap.count(); i++)}
\DoxyCodeLine{00264         \textcolor{keywordflow}{if} (regionMap[i] == regionToDiscard) regionMap[i] = regionToKeep;}
\DoxyCodeLine{00265     \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{00266       \textcolor{keywordflow}{break};}
\DoxyCodeLine{00267   \}}
\DoxyCodeLine{00268 }
\DoxyCodeLine{00269   Q\_ASSERT(freeRegions.empty());}
\DoxyCodeLine{00270 }
\DoxyCodeLine{00271   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < m\_regions.count(); i++) m\_regions[i].pixelCount = 0;}
\DoxyCodeLine{00272 }
\DoxyCodeLine{00273   \textcolor{comment}{// wb => m\_regionRas}}
\DoxyCodeLine{00274   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00275     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *regionScanLine = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00276     \textcolor{keywordtype}{int} *wbScanLine                = wb.pixels(y);}
\DoxyCodeLine{00277     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00278       \textcolor{keywordtype}{int} regionIndex   = regionMap[wbScanLine[x]];}
\DoxyCodeLine{00279       regionScanLine[x] = (\textcolor{keywordtype}{unsigned} short)regionIndex;}
\DoxyCodeLine{00280       m\_regions[regionIndex].pixelCount++;}
\DoxyCodeLine{00281     \}}
\DoxyCodeLine{00282   \}}
\DoxyCodeLine{00283 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a8363dc9951f08203745420ef89b65848}\label{class_naa2_tlv_converter_a8363dc9951f08203745420ef89b65848}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!setPalette@{setPalette}}
\index{setPalette@{setPalette}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{setPalette()}{setPalette()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::set\+Palette (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_palette}{TPalette}} $\ast$}]{palette }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00062                                                    \{}
\DoxyCodeLine{00063   \textcolor{keywordflow}{if} (m\_palette != palette) \{}
\DoxyCodeLine{00064     \textcolor{keywordflow}{if} (palette) palette-\/>addRef();}
\DoxyCodeLine{00065     \textcolor{keywordflow}{if} (m\_palette) m\_palette-\/>release();}
\DoxyCodeLine{00066     m\_palette = palette;}
\DoxyCodeLine{00067   \}}
\DoxyCodeLine{00068 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_a132f6dbc74f18919c82e1d09eeda44a0}\label{class_naa2_tlv_converter_a132f6dbc74f18919c82e1d09eeda44a0}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!setSourceImage@{setSourceImage}}
\index{setSourceImage@{setSourceImage}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{setSourceImage()}{setSourceImage()}}
{\footnotesize\ttfamily void Naa2\+Tlv\+Converter\+::set\+Source\+Image (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} \&}]{src\+Ras }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00111                                                               \{}
\DoxyCodeLine{00112   \textcolor{keywordtype}{int} lx = srcRas-\/>getSize().lx;}
\DoxyCodeLine{00113   \textcolor{keywordtype}{int} ly = srcRas-\/>getSize().ly;}
\DoxyCodeLine{00114 }
\DoxyCodeLine{00115   m\_colors.clear();}
\DoxyCodeLine{00116   m\_regions.clear();}
\DoxyCodeLine{00117   \textcolor{keyword}{delete} m\_regionRas;}
\DoxyCodeLine{00118   m\_regionRas = \textcolor{keyword}{new} \mbox{\hyperlink{class_work_raster}{WorkRaster<unsigned short>}}(lx, ly);}
\DoxyCodeLine{00119   \textcolor{keyword}{delete} m\_borderRas;}
\DoxyCodeLine{00120   m\_borderRas = 0;}
\DoxyCodeLine{00121 }
\DoxyCodeLine{00122   \textcolor{keyword}{delete} m\_dotRas;}
\DoxyCodeLine{00123   m\_dotRas = 0;}
\DoxyCodeLine{00124 }
\DoxyCodeLine{00125   \textcolor{keyword}{delete} m\_syntheticInkRas;}
\DoxyCodeLine{00126   m\_syntheticInkRas = 0;}
\DoxyCodeLine{00127 }
\DoxyCodeLine{00128   QMap<TPixel32, int> colorTable;}
\DoxyCodeLine{00129   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < ly; y++) \{}
\DoxyCodeLine{00130     TPixel32 *srcScanLine          = srcRas-\/>pixels(y);}
\DoxyCodeLine{00131     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} *regionScanLine = m\_regionRas-\/>pixels(y);}
\DoxyCodeLine{00132     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < lx; x++) \{}
\DoxyCodeLine{00133       TPixel32 srcPix = overPixOnWhite(srcScanLine[x]);}
\DoxyCodeLine{00134       QMap<TPixel32, int>::ConstIterator it = colorTable.find(srcPix);}
\DoxyCodeLine{00135       \textcolor{keywordflow}{if} (it == colorTable.end()) \{}
\DoxyCodeLine{00136         \textcolor{comment}{// found new color (and therefore new region)}}
\DoxyCodeLine{00137         \mbox{\hyperlink{struct_region_info}{RegionInfo}} r;}
\DoxyCodeLine{00138         \textcolor{comment}{// add new color}}
\DoxyCodeLine{00139         r.colorIndex = m\_colors.count();}
\DoxyCodeLine{00140         m\_colors.append(srcPix);}
\DoxyCodeLine{00141         r.pixelCount = 1;}
\DoxyCodeLine{00142         \textcolor{comment}{// add new region}}
\DoxyCodeLine{00143         \textcolor{keywordtype}{int} regionIndex = m\_regions.count();}
\DoxyCodeLine{00144         m\_regions.append(r);}
\DoxyCodeLine{00145         \textcolor{comment}{// update raster and colorTable}}
\DoxyCodeLine{00146         regionScanLine[x] = regionIndex;}
\DoxyCodeLine{00147         colorTable.insert(srcPix, regionIndex);}
\DoxyCodeLine{00148         \textcolor{keywordflow}{if} (m\_colors.count() > MaxColorCount) \{}
\DoxyCodeLine{00149           \textcolor{keywordflow}{return};}
\DoxyCodeLine{00150         \}}
\DoxyCodeLine{00151       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00152         \textcolor{comment}{// already defined color}}
\DoxyCodeLine{00153         \textcolor{keywordtype}{int} regionIndex   = it.value();}
\DoxyCodeLine{00154         regionScanLine[x] = regionIndex;}
\DoxyCodeLine{00155         m\_regions[regionIndex].pixelCount++;}
\DoxyCodeLine{00156       \}}
\DoxyCodeLine{00157     \}}
\DoxyCodeLine{00158   \}}
\DoxyCodeLine{00159   m\_valid = \textcolor{keyword}{true};}
\DoxyCodeLine{00160 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_naa2_tlv_converter_ab3d734da9514382920e8db48e66179bc}\label{class_naa2_tlv_converter_ab3d734da9514382920e8db48e66179bc}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!vectorize@{vectorize}}
\index{vectorize@{vectorize}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{vectorize()}{vectorize()}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_vector_image_p}{TVector\+ImageP}} Naa2\+Tlv\+Converter\+::vectorize (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_toonz_image_p}{TToonz\+ImageP}} \&}]{ti }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01133                                                                 \{}
\DoxyCodeLine{01134   \mbox{\hyperlink{class_centerline_configuration}{CenterlineConfiguration}} conf;}
\DoxyCodeLine{01135   \textcolor{keywordflow}{if} (!ti) \textcolor{keywordflow}{return} \mbox{\hyperlink{class_t_vector_image_p}{TVectorImageP}}();}
\DoxyCodeLine{01136   \mbox{\hyperlink{class_t_palette}{TPalette}} *palette = ti-\/>getPalette();}
\DoxyCodeLine{01137 }
\DoxyCodeLine{01138   \mbox{\hyperlink{class_vectorizer_core}{VectorizerCore}} vc;}
\DoxyCodeLine{01139 }
\DoxyCodeLine{01140   \mbox{\hyperlink{class_t_affine}{TAffine}} dpiAff;}
\DoxyCodeLine{01141   \textcolor{keywordtype}{double} factor = \mbox{\hyperlink{namespace_stage_ad3e22e31e2bb6fc1d95a572facce2d5b}{Stage::inch}};}
\DoxyCodeLine{01142   \textcolor{keywordtype}{double} dpix = factor / 72, dpiy = factor / 72;}
\DoxyCodeLine{01143 }
\DoxyCodeLine{01144   ti-\/>getDpi(dpix, dpiy);}
\DoxyCodeLine{01145   \mbox{\hyperlink{class_t_point_t}{TPointD}} center = ti-\/>getRaster()-\/>getCenterD();}
\DoxyCodeLine{01146 }
\DoxyCodeLine{01147   \textcolor{keywordflow}{if} (dpix != 0.0 \&\& dpiy != 0.0) dpiAff = \mbox{\hyperlink{class_t_scale}{TScale}}(factor / dpix, factor / dpiy);}
\DoxyCodeLine{01148   factor                                 = norm(dpiAff * \mbox{\hyperlink{class_t_point_t}{TPointD}}(1, 0));}
\DoxyCodeLine{01149 }
\DoxyCodeLine{01150   conf.\mbox{\hyperlink{class_vectorizer_configuration_a35f1f35835fee0dfe6aaf83fa9ea1489}{m\_affine}}         = dpiAff * \mbox{\hyperlink{class_t_translation}{TTranslation}}(-\/center);}
\DoxyCodeLine{01151   conf.\mbox{\hyperlink{class_vectorizer_configuration_a3af044b6f16e74b4b03ce0dccf76b9bc}{m\_thickScale}}     = factor;}
\DoxyCodeLine{01152   conf.\mbox{\hyperlink{class_vectorizer_configuration_a7986237762ccb55c79ce6fd35e879152}{m\_leaveUnpainted}} = \textcolor{keyword}{false};}
\DoxyCodeLine{01153   conf.\mbox{\hyperlink{class_centerline_configuration_a4c4a77c10cb68f8211811946b6e534cd}{m\_makeFrame}}      = \textcolor{keyword}{true};}
\DoxyCodeLine{01154   conf.\mbox{\hyperlink{class_centerline_configuration_aa2a67569aa3e9fb55cf2fb1f3fea7129}{m\_penalty}}        = 0.0;}
\DoxyCodeLine{01155   conf.\mbox{\hyperlink{class_centerline_configuration_a4adf92caa1da18bd842398a86fbfed35}{m\_despeckling}}    = 0;}
\DoxyCodeLine{01156 }
\DoxyCodeLine{01157   \mbox{\hyperlink{class_t_smart_pointer_t}{TImageP}} img(ti.getPointer());}
\DoxyCodeLine{01158   \mbox{\hyperlink{class_t_vector_image_p}{TVectorImageP}} vi = vc.\mbox{\hyperlink{class_vectorizer_core_ac12b78770400b604498680eff445f244}{vectorize}}(img, conf, palette);}
\DoxyCodeLine{01159   vi-\/>setPalette(palette);}
\DoxyCodeLine{01160   \textcolor{keywordflow}{return} vi;}
\DoxyCodeLine{01161 \}}

\end{DoxyCode}


\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{class_naa2_tlv_converter_a0b0daae74da1bd01b9f08c4f3e863793}\label{class_naa2_tlv_converter_a0b0daae74da1bd01b9f08c4f3e863793}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_borderRas@{m\_borderRas}}
\index{m\_borderRas@{m\_borderRas}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_borderRas}{m\_borderRas}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$unsigned char$>$$\ast$ Naa2\+Tlv\+Converter\+::m\+\_\+border\+Ras}

\mbox{\Hypertarget{class_naa2_tlv_converter_ae96dfe88c5c33f6e70270049e1a7de6e}\label{class_naa2_tlv_converter_ae96dfe88c5c33f6e70270049e1a7de6e}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_colors@{m\_colors}}
\index{m\_colors@{m\_colors}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_colors}{m\_colors}}
{\footnotesize\ttfamily QVector$<$TPixel32$>$ Naa2\+Tlv\+Converter\+::m\+\_\+colors}

\mbox{\Hypertarget{class_naa2_tlv_converter_a40cb144beaf2f9ae3762a9be1360783d}\label{class_naa2_tlv_converter_a40cb144beaf2f9ae3762a9be1360783d}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_dotRas@{m\_dotRas}}
\index{m\_dotRas@{m\_dotRas}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_dotRas}{m\_dotRas}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$unsigned char$>$$\ast$ Naa2\+Tlv\+Converter\+::m\+\_\+dot\+Ras}

\mbox{\Hypertarget{class_naa2_tlv_converter_a5ddcaf9de0e08d6aa0e2d48fdfce1ad5}\label{class_naa2_tlv_converter_a5ddcaf9de0e08d6aa0e2d48fdfce1ad5}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_inkThickness@{m\_inkThickness}}
\index{m\_inkThickness@{m\_inkThickness}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_inkThickness}{m\_inkThickness}}
{\footnotesize\ttfamily double Naa2\+Tlv\+Converter\+::m\+\_\+ink\+Thickness}

\mbox{\Hypertarget{class_naa2_tlv_converter_a5be1af2e152f70560a76ada841b7d685}\label{class_naa2_tlv_converter_a5be1af2e152f70560a76ada841b7d685}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_palette@{m\_palette}}
\index{m\_palette@{m\_palette}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_palette}{m\_palette}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_palette}{TPalette}}$\ast$ Naa2\+Tlv\+Converter\+::m\+\_\+palette}

\mbox{\Hypertarget{class_naa2_tlv_converter_a818cf5ab9bec6c237a80d010ba850c82}\label{class_naa2_tlv_converter_a818cf5ab9bec6c237a80d010ba850c82}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_regionRas@{m\_regionRas}}
\index{m\_regionRas@{m\_regionRas}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_regionRas}{m\_regionRas}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$unsigned short$>$$\ast$ Naa2\+Tlv\+Converter\+::m\+\_\+region\+Ras}

\mbox{\Hypertarget{class_naa2_tlv_converter_a1401dcef1312dcd358d1feb1dc42fcaa}\label{class_naa2_tlv_converter_a1401dcef1312dcd358d1feb1dc42fcaa}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_regions@{m\_regions}}
\index{m\_regions@{m\_regions}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_regions}{m\_regions}}
{\footnotesize\ttfamily QVector$<$\mbox{\hyperlink{struct_region_info}{Region\+Info}}$>$ Naa2\+Tlv\+Converter\+::m\+\_\+regions}

\mbox{\Hypertarget{class_naa2_tlv_converter_aca510d1f840fde7592ce170aea57c90f}\label{class_naa2_tlv_converter_aca510d1f840fde7592ce170aea57c90f}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_syntheticInkRas@{m\_syntheticInkRas}}
\index{m\_syntheticInkRas@{m\_syntheticInkRas}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_syntheticInkRas}{m\_syntheticInkRas}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_work_raster}{Work\+Raster}}$<$unsigned char$>$$\ast$ Naa2\+Tlv\+Converter\+::m\+\_\+synthetic\+Ink\+Ras}

\mbox{\Hypertarget{class_naa2_tlv_converter_a8ba425d3324998fa444ba91e5fe68272}\label{class_naa2_tlv_converter_a8ba425d3324998fa444ba91e5fe68272}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!m\_valid@{m\_valid}}
\index{m\_valid@{m\_valid}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{m\_valid}{m\_valid}}
{\footnotesize\ttfamily bool Naa2\+Tlv\+Converter\+::m\+\_\+valid}

\mbox{\Hypertarget{class_naa2_tlv_converter_ad82deae9481139d35a00c97c186396fd}\label{class_naa2_tlv_converter_ad82deae9481139d35a00c97c186396fd}} 
\index{Naa2TlvConverter@{Naa2TlvConverter}!MaxColorCount@{MaxColorCount}}
\index{MaxColorCount@{MaxColorCount}!Naa2TlvConverter@{Naa2TlvConverter}}
\doxysubsubsection{\texorpdfstring{MaxColorCount}{MaxColorCount}}
{\footnotesize\ttfamily const int Naa2\+Tlv\+Converter\+::\+Max\+Color\+Count}



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/include/toonz/Naa2\+Tlv\+Converter.\+h\item 
E\+:/opentoonz/toonz/sources/toonzlib/Naa2\+Tlv\+Converter.\+cpp\end{DoxyCompactItemize}
