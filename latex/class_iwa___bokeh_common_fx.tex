\hypertarget{class_iwa___bokeh_common_fx}{}\doxysection{Iwa\+\_\+\+Bokeh\+Common\+Fx Class Reference}
\label{class_iwa___bokeh_common_fx}\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
Inheritance diagram for Iwa\+\_\+\+Bokeh\+Common\+Fx\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=6.000000cm]{class_iwa___bokeh_common_fx}
\end{center}
\end{figure}
\doxysubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{struct_iwa___bokeh_common_fx_1_1_layer_value}{Layer\+Value}}
\end{DoxyCompactItemize}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_iwa___bokeh_common_fx_abc1e1dcdb18ace6bfecda9b4b4168b92}{do\+Compute}} (\mbox{\hyperlink{class_t_tile}{TTile}} \&tile, double frame, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&settings) override=0
\item 
bool \mbox{\hyperlink{class_iwa___bokeh_common_fx_a57198dc4c03e60e585d5682f94b4d40a}{do\+Get\+BBox}} (double frame, \mbox{\hyperlink{class_t_rect_t}{TRectD}} \&b\+Box, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&info) final override
\item 
bool \mbox{\hyperlink{class_iwa___bokeh_common_fx_ad6fceabfa9c8fcf6efc579afbd04d033}{can\+Handle}} (const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&info, double frame) final override
\end{DoxyCompactItemize}
\doxysubsection*{Protected Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_iwa___bokeh_common_fx_a21f57fb2b8f0a83c943cc31129dbb635}{do\+Fx}} (\mbox{\hyperlink{class_t_tile}{TTile}} \&tile, double frame, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&settings, double bokeh\+Pixel\+Amount, int margin, \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&dim\+Out, \mbox{\hyperlink{class_t_rect_t}{TRectD}} \&iris\+BBox, \mbox{\hyperlink{class_t_tile}{TTile}} \&iris\+Tile, QList$<$ \mbox{\hyperlink{struct_iwa___bokeh_common_fx_1_1_layer_value}{Layer\+Value}} $>$ \&layer\+Values, QMap$<$ int, unsigned char $\ast$ $>$ \&ctrls)
\item 
void \mbox{\hyperlink{class_iwa___bokeh_common_fx_a0ec1505a8a83e6557f17058dbe1eaa39}{do\+Bokeh\+Ref}} (\mbox{\hyperlink{structdouble4}{double4}} $\ast$result, double frame, const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&settings, double bokeh\+Pixel\+Amount, int margin, \mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&dim\+Out, \mbox{\hyperlink{class_t_rect_t}{TRectD}} \&iris\+BBox, \mbox{\hyperlink{class_t_tile}{TTile}} \&iris\+Tile, kiss\+\_\+fft\+\_\+cpx $\ast$kissfft\+\_\+comp\+\_\+iris, \mbox{\hyperlink{struct_iwa___bokeh_common_fx_1_1_layer_value}{Layer\+Value}} layer, unsigned char $\ast$ctrl)
\end{DoxyCompactItemize}
\doxysubsection*{Protected Attributes}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} \mbox{\hyperlink{class_iwa___bokeh_common_fx_a6f2a097b8da4cd2ea796c89237cd0128}{m\+\_\+iris}}
\item 
TDouble\+ParamP \mbox{\hyperlink{class_iwa___bokeh_common_fx_aab8a2f7bfbe8848a25f892640831d635}{m\+\_\+on\+Focus\+Distance}}
\item 
TDouble\+ParamP \mbox{\hyperlink{class_iwa___bokeh_common_fx_aa1b07afe15ac4c4173c2cb24b2f1ab05}{m\+\_\+bokeh\+Amount}}
\item 
TDouble\+ParamP \mbox{\hyperlink{class_iwa___bokeh_common_fx_a0b7fa92ab5c29db26dfffd17dffdf28a}{m\+\_\+hardness}}
\end{DoxyCompactItemize}
\doxysubsection*{Additional Inherited Members}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_iwa___bokeh_common_fx_a4a301ceda9564e5ebc3f08baf42c1308}\label{class_iwa___bokeh_common_fx_a4a301ceda9564e5ebc3f08baf42c1308}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{Iwa\_BokehCommonFx()}{Iwa\_BokehCommonFx()}}
{\footnotesize\ttfamily Iwa\+\_\+\+Bokeh\+Common\+Fx\+::\+Iwa\+\_\+\+Bokeh\+Common\+Fx (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{01323     : m\_onFocusDistance(0.5), m\_bokehAmount(30.0), m\_hardness(0.3) \{}
\DoxyCodeLine{01324   \mbox{\hyperlink{class_t_fx_af0ccf8d65934ed9f7a62d3b45ee5f2b6}{addInputPort}}(\textcolor{stringliteral}{"{}Iris"{}}, m\_iris);}
\DoxyCodeLine{01325 }
\DoxyCodeLine{01326   \textcolor{comment}{// Set the ranges of common parameters}}
\DoxyCodeLine{01327   m\_onFocusDistance-\/>setValueRange(0.0, 10.);}
\DoxyCodeLine{01328   m\_bokehAmount-\/>setValueRange(0.0, 300.0);}
\DoxyCodeLine{01329   m\_bokehAmount-\/>setMeasureName(\textcolor{stringliteral}{"{}fxLength"{}});}
\DoxyCodeLine{01330   m\_hardness-\/>setValueRange(0.05, 3.0);}
\DoxyCodeLine{01331 \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_iwa___bokeh_common_fx_ad6fceabfa9c8fcf6efc579afbd04d033}\label{class_iwa___bokeh_common_fx_ad6fceabfa9c8fcf6efc579afbd04d033}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!canHandle@{canHandle}}
\index{canHandle@{canHandle}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{canHandle()}{canHandle()}}
{\footnotesize\ttfamily bool Iwa\+\_\+\+Bokeh\+Common\+Fx\+::can\+Handle (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{info,  }\item[{double}]{frame }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [final]}, {\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_raster_fx}{TRaster\+Fx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{01341                                                                            \{}
\DoxyCodeLine{01342   \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{01343 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___bokeh_common_fx_a0ec1505a8a83e6557f17058dbe1eaa39}\label{class_iwa___bokeh_common_fx_a0ec1505a8a83e6557f17058dbe1eaa39}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!doBokehRef@{doBokehRef}}
\index{doBokehRef@{doBokehRef}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{doBokehRef()}{doBokehRef()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Bokeh\+Common\+Fx\+::do\+Bokeh\+Ref (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structdouble4}{double4}} $\ast$}]{result,  }\item[{double}]{frame,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{settings,  }\item[{double}]{bokeh\+Pixel\+Amount,  }\item[{int}]{margin,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&}]{dim\+Out,  }\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{iris\+BBox,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} \&}]{iris\+Tile,  }\item[{kiss\+\_\+fft\+\_\+cpx $\ast$}]{kissfft\+\_\+comp\+\_\+iris,  }\item[{\mbox{\hyperlink{struct_iwa___bokeh_common_fx_1_1_layer_value}{Layer\+Value}}}]{layer,  }\item[{unsigned char $\ast$}]{ctrl }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{01624                                                                           \{}
\DoxyCodeLine{01625   QList<TRasterGR8P> rasterList;}
\DoxyCodeLine{01626   QList<kiss\_fftnd\_cfg> planList;}
\DoxyCodeLine{01627   \textcolor{comment}{// source image}}
\DoxyCodeLine{01628   \mbox{\hyperlink{structdouble4}{double4}}* source\_buff;}
\DoxyCodeLine{01629   rasterList.append(allocateRasterAndLock<double4>(\&source\_buff, dimOut));}
\DoxyCodeLine{01630 }
\DoxyCodeLine{01631   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} ras32 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}})layer.sourceTile-\/>getRaster();}
\DoxyCodeLine{01632   \mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} ras64 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}})layer.sourceTile-\/>getRaster();}
\DoxyCodeLine{01633   lock.lockForRead();}
\DoxyCodeLine{01634   \textcolor{keywordflow}{if} (ras32)}
\DoxyCodeLine{01635     BokehUtils::setSourceRaster<TRaster32P, TPixel32>(ras32, source\_buff,}
\DoxyCodeLine{01636                                                       dimOut);}
\DoxyCodeLine{01637   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ras64)}
\DoxyCodeLine{01638     BokehUtils::setSourceRaster<TRaster64P, TPixel64>(ras64, source\_buff,}
\DoxyCodeLine{01639                                                       dimOut);}
\DoxyCodeLine{01640   lock.unlock();}
\DoxyCodeLine{01641 }
\DoxyCodeLine{01642   \textcolor{comment}{// create the index map, which indicates which layer each pixel belongs to}}
\DoxyCodeLine{01643   \textcolor{comment}{// make two separations and interporate the results in order to avoid}}
\DoxyCodeLine{01644   \textcolor{comment}{// artifacts appear at the layer border}}
\DoxyCodeLine{01645   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}* indexMap\_main\_buff;}
\DoxyCodeLine{01646   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}* indexMap\_sub\_buff;}
\DoxyCodeLine{01647   \textcolor{keywordtype}{double}* mainSub\_ratio\_buff;}
\DoxyCodeLine{01648 }
\DoxyCodeLine{01649   rasterList.append(}
\DoxyCodeLine{01650       allocateRasterAndLock<unsigned char>(\&indexMap\_main\_buff, dimOut));}
\DoxyCodeLine{01651   rasterList.append(}
\DoxyCodeLine{01652       allocateRasterAndLock<unsigned char>(\&indexMap\_sub\_buff, dimOut));}
\DoxyCodeLine{01653   rasterList.append(allocateRasterAndLock<double>(\&mainSub\_ratio\_buff, dimOut));}
\DoxyCodeLine{01654 }
\DoxyCodeLine{01655   QVector<double> segmentDepth\_main;}
\DoxyCodeLine{01656   QVector<double> segmentDepth\_sub;}
\DoxyCodeLine{01657 }
\DoxyCodeLine{01658   \textcolor{keywordtype}{double} layerDitance = layer.distance;}
\DoxyCodeLine{01659   \textcolor{keywordtype}{double} nearDepth    = layerDitance -\/ layer.depthRange * layerDitance;}
\DoxyCodeLine{01660   \textcolor{keywordtype}{double} farDepth     = nearDepth + layer.depthRange;}
\DoxyCodeLine{01661 }
\DoxyCodeLine{01662   \textcolor{keywordtype}{int} distancePrecision = layer.distancePrecision;}
\DoxyCodeLine{01663 }
\DoxyCodeLine{01664   \textcolor{comment}{// create the depth index map}}
\DoxyCodeLine{01665   BokehUtils::defineSegemntDepth(}
\DoxyCodeLine{01666       indexMap\_main\_buff, indexMap\_sub\_buff, mainSub\_ratio\_buff, ctrl, dimOut,}
\DoxyCodeLine{01667       segmentDepth\_main, segmentDepth\_sub, m\_onFocusDistance-\/>getValue(frame),}
\DoxyCodeLine{01668       distancePrecision, nearDepth, farDepth);}
\DoxyCodeLine{01669 }
\DoxyCodeLine{01670   \textcolor{keywordtype}{int} size = dimOut.lx * dimOut.ly;}
\DoxyCodeLine{01671 }
\DoxyCodeLine{01672   \mbox{\hyperlink{structdouble4}{double4}}* layer\_buff;}
\DoxyCodeLine{01673   rasterList.append(allocateRasterAndLock<double4>(\&layer\_buff, dimOut));}
\DoxyCodeLine{01674 }
\DoxyCodeLine{01675   kiss\_fft\_cpx* kissfft\_comp\_iris\_before;}
\DoxyCodeLine{01676   rasterList.append(}
\DoxyCodeLine{01677       allocateRasterAndLock<kiss\_fft\_cpx>(\&kissfft\_comp\_iris\_before, dimOut));}
\DoxyCodeLine{01678 }
\DoxyCodeLine{01679   \textcolor{comment}{// alpha channel}}
\DoxyCodeLine{01680   kiss\_fft\_cpx* fftcpx\_alpha\_before;}
\DoxyCodeLine{01681   kiss\_fft\_cpx* fftcpx\_alpha;}
\DoxyCodeLine{01682   rasterList.append(}
\DoxyCodeLine{01683       allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_alpha\_before, dimOut));}
\DoxyCodeLine{01684   rasterList.append(allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_alpha, dimOut));}
\DoxyCodeLine{01685 }
\DoxyCodeLine{01686   \textcolor{comment}{// RGB channels}}
\DoxyCodeLine{01687   kiss\_fft\_cpx* fftcpx\_r\_before;}
\DoxyCodeLine{01688   kiss\_fft\_cpx* fftcpx\_g\_before;}
\DoxyCodeLine{01689   kiss\_fft\_cpx* fftcpx\_b\_before;}
\DoxyCodeLine{01690   kiss\_fft\_cpx* fftcpx\_r;}
\DoxyCodeLine{01691   kiss\_fft\_cpx* fftcpx\_g;}
\DoxyCodeLine{01692   kiss\_fft\_cpx* fftcpx\_b;}
\DoxyCodeLine{01693   rasterList.append(}
\DoxyCodeLine{01694       allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_r\_before, dimOut));}
\DoxyCodeLine{01695   rasterList.append(}
\DoxyCodeLine{01696       allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_g\_before, dimOut));}
\DoxyCodeLine{01697   rasterList.append(}
\DoxyCodeLine{01698       allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_b\_before, dimOut));}
\DoxyCodeLine{01699   rasterList.append(allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_r, dimOut));}
\DoxyCodeLine{01700   rasterList.append(allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_g, dimOut));}
\DoxyCodeLine{01701   rasterList.append(allocateRasterAndLock<kiss\_fft\_cpx>(\&fftcpx\_b, dimOut));}
\DoxyCodeLine{01702 }
\DoxyCodeLine{01703   \textcolor{comment}{// for accumulating result image}}
\DoxyCodeLine{01704   \mbox{\hyperlink{structdouble4}{double4}}* result\_main\_buff;}
\DoxyCodeLine{01705   \mbox{\hyperlink{structdouble4}{double4}}* result\_sub\_buff;}
\DoxyCodeLine{01706   rasterList.append(allocateRasterAndLock<double4>(\&result\_main\_buff, dimOut));}
\DoxyCodeLine{01707   rasterList.append(allocateRasterAndLock<double4>(\&result\_sub\_buff, dimOut));}
\DoxyCodeLine{01708 }
\DoxyCodeLine{01709   \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01710   \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01711     releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01712     \textcolor{keywordflow}{return};}
\DoxyCodeLine{01713   \}}
\DoxyCodeLine{01714 }
\DoxyCodeLine{01715   \textcolor{comment}{// fft plans}}
\DoxyCodeLine{01716   \textcolor{keywordtype}{int} dims[2]                      = \{dimOut.ly, dimOut.lx\};}
\DoxyCodeLine{01717   kiss\_fftnd\_cfg kissfft\_plan\_fwd  = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{false}, 0, 0);}
\DoxyCodeLine{01718   kiss\_fftnd\_cfg kissfft\_plan\_bkwd = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{true}, 0, 0);}
\DoxyCodeLine{01719   planList.append(kissfft\_plan\_fwd);}
\DoxyCodeLine{01720   planList.append(kissfft\_plan\_bkwd);}
\DoxyCodeLine{01721 }
\DoxyCodeLine{01722   kiss\_fftnd\_cfg kissfft\_plan\_r\_fwd  = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{false}, 0, 0);}
\DoxyCodeLine{01723   kiss\_fftnd\_cfg kissfft\_plan\_r\_bkwd = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{true}, 0, 0);}
\DoxyCodeLine{01724   kiss\_fftnd\_cfg kissfft\_plan\_g\_fwd  = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{false}, 0, 0);}
\DoxyCodeLine{01725   kiss\_fftnd\_cfg kissfft\_plan\_g\_bkwd = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{true}, 0, 0);}
\DoxyCodeLine{01726   kiss\_fftnd\_cfg kissfft\_plan\_b\_fwd  = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{false}, 0, 0);}
\DoxyCodeLine{01727   kiss\_fftnd\_cfg kissfft\_plan\_b\_bkwd = kiss\_fftnd\_alloc(dims, 2, \textcolor{keyword}{true}, 0, 0);}
\DoxyCodeLine{01728   planList.append(kissfft\_plan\_r\_fwd);}
\DoxyCodeLine{01729   planList.append(kissfft\_plan\_r\_bkwd);}
\DoxyCodeLine{01730   planList.append(kissfft\_plan\_g\_fwd);}
\DoxyCodeLine{01731   planList.append(kissfft\_plan\_g\_bkwd);}
\DoxyCodeLine{01732   planList.append(kissfft\_plan\_b\_fwd);}
\DoxyCodeLine{01733   planList.append(kissfft\_plan\_b\_bkwd);}
\DoxyCodeLine{01734 }
\DoxyCodeLine{01735   \textcolor{comment}{// initialize result memory}}
\DoxyCodeLine{01736   memset(result\_main\_buff, 0, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structdouble4}{double4}}) * size);}
\DoxyCodeLine{01737   memset(result\_sub\_buff, 0, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structdouble4}{double4}}) * size);}
\DoxyCodeLine{01738 }
\DoxyCodeLine{01739   \textcolor{keywordtype}{double} masterHardness = (double)m\_hardness-\/>getValue(frame);}
\DoxyCodeLine{01740   \textcolor{keywordtype}{double} layerHardness  = layer.layerHardness;}
\DoxyCodeLine{01741 }
\DoxyCodeLine{01742   \textcolor{comment}{// convert source image value rgb -\/> exposure}}
\DoxyCodeLine{01743   \textcolor{comment}{// note that premultiplied source image is already unpremultiplied before this}}
\DoxyCodeLine{01744   \textcolor{comment}{// function}}
\DoxyCodeLine{01745   BokehUtils::convertRGBToExposure(source\_buff, size, layerHardness);}
\DoxyCodeLine{01746 }
\DoxyCodeLine{01747   \textcolor{keywordtype}{double} focus  = m\_onFocusDistance-\/>getValue(frame);}
\DoxyCodeLine{01748   \textcolor{keywordtype}{double} adjust = layer.bokehAdjustment;}
\DoxyCodeLine{01749 }
\DoxyCodeLine{01750   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} mainSub = 0; mainSub < 2; mainSub++) \{}
\DoxyCodeLine{01751     \mbox{\hyperlink{structdouble4}{double4}}* result\_buff\_mainSub;}
\DoxyCodeLine{01752     QVector<double> segmentDepth\_mainSub;}
\DoxyCodeLine{01753     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}* indexMap\_mainSub;}
\DoxyCodeLine{01754     \textcolor{keywordflow}{if} (mainSub == 0) \{}
\DoxyCodeLine{01755       result\_buff\_mainSub  = result\_main\_buff;}
\DoxyCodeLine{01756       segmentDepth\_mainSub = segmentDepth\_main;}
\DoxyCodeLine{01757       indexMap\_mainSub     = indexMap\_main\_buff;}
\DoxyCodeLine{01758     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01759       result\_buff\_mainSub  = result\_sub\_buff;}
\DoxyCodeLine{01760       segmentDepth\_mainSub = segmentDepth\_sub;}
\DoxyCodeLine{01761       indexMap\_mainSub     = indexMap\_sub\_buff;}
\DoxyCodeLine{01762     \}}
\DoxyCodeLine{01763 }
\DoxyCodeLine{01764     \textcolor{comment}{// compute from further to nearer}}
\DoxyCodeLine{01765     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} index = 0; index < segmentDepth\_mainSub.size(); index++) \{}
\DoxyCodeLine{01766       \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01767       \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01768         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01769         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01770       \}}
\DoxyCodeLine{01771 }
\DoxyCodeLine{01772       \textcolor{comment}{// compute iris size}}
\DoxyCodeLine{01773       \textcolor{keywordtype}{double} irisSize = BokehUtils::calcIrisSize(segmentDepth\_mainSub.at(index),}
\DoxyCodeLine{01774                                                  bokehPixelAmount, focus,}
\DoxyCodeLine{01775                                                  adjust, nearDepth, farDepth);}
\DoxyCodeLine{01776 }
\DoxyCodeLine{01777       memset(layer\_buff, 0, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structdouble4}{double4}}) * size);}
\DoxyCodeLine{01778       BokehUtils::retrieveLayer(}
\DoxyCodeLine{01779           source\_buff, layer\_buff, indexMap\_mainSub, index, dimOut.lx,}
\DoxyCodeLine{01780           dimOut.ly, layer.fillGap, layer.doMedian,}
\DoxyCodeLine{01781           (index == segmentDepth\_mainSub.size() -\/ 1) ? 0 : margin);}
\DoxyCodeLine{01782 }
\DoxyCodeLine{01783       \textcolor{comment}{// in case the current segment is at the focus}}
\DoxyCodeLine{01784       \textcolor{keywordflow}{if} (-\/1.0 <= irisSize \&\& 1.0 >= irisSize) \{}
\DoxyCodeLine{01785         BokehUtils::compositeAsIs(layer\_buff, result\_buff\_mainSub, size);}
\DoxyCodeLine{01786         \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01787       \}}
\DoxyCodeLine{01788 }
\DoxyCodeLine{01789       \textcolor{comment}{// Resize / flip the iris image according to the size ratio.}}
\DoxyCodeLine{01790       \textcolor{comment}{// Normalize the brightness of the iris image.}}
\DoxyCodeLine{01791       \textcolor{comment}{// Enlarge the iris to the output size.}}
\DoxyCodeLine{01792       BokehUtils::convertIris(irisSize, kissfft\_comp\_iris\_before, dimOut,}
\DoxyCodeLine{01793                               irisBBox, irisTile);}
\DoxyCodeLine{01794 }
\DoxyCodeLine{01795       \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01796       \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01797         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01798         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01799       \}}
\DoxyCodeLine{01800       \textcolor{comment}{// Do FFT the iris image.}}
\DoxyCodeLine{01801       kiss\_fftnd(kissfft\_plan\_fwd, kissfft\_comp\_iris\_before, kissfft\_comp\_iris);}
\DoxyCodeLine{01802 }
\DoxyCodeLine{01803       \textcolor{comment}{// initialize alpha}}
\DoxyCodeLine{01804       memset(fftcpx\_alpha\_before, 0, \textcolor{keyword}{sizeof}(kiss\_fft\_cpx) * size);}
\DoxyCodeLine{01805       \textcolor{comment}{// initialize channels}}
\DoxyCodeLine{01806       memset(fftcpx\_r\_before, 0, \textcolor{keyword}{sizeof}(kiss\_fft\_cpx) * size);}
\DoxyCodeLine{01807       memset(fftcpx\_g\_before, 0, \textcolor{keyword}{sizeof}(kiss\_fft\_cpx) * size);}
\DoxyCodeLine{01808       memset(fftcpx\_b\_before, 0, \textcolor{keyword}{sizeof}(kiss\_fft\_cpx) * size);}
\DoxyCodeLine{01809 }
\DoxyCodeLine{01810       \textcolor{comment}{// retrieve segment layer image for each channel}}
\DoxyCodeLine{01811       BokehUtils::retrieveChannel(layer\_buff,           \textcolor{comment}{// src}}
\DoxyCodeLine{01812                                   fftcpx\_r\_before,      \textcolor{comment}{// dst}}
\DoxyCodeLine{01813                                   fftcpx\_g\_before,      \textcolor{comment}{// dst}}
\DoxyCodeLine{01814                                   fftcpx\_b\_before,      \textcolor{comment}{// dst}}
\DoxyCodeLine{01815                                   fftcpx\_alpha\_before,  \textcolor{comment}{// dst}}
\DoxyCodeLine{01816                                   size);}
\DoxyCodeLine{01817 }
\DoxyCodeLine{01818       \textcolor{comment}{// forward fft of alpha channel}}
\DoxyCodeLine{01819       kiss\_fftnd(kissfft\_plan\_fwd, fftcpx\_alpha\_before, fftcpx\_alpha);}
\DoxyCodeLine{01820 }
\DoxyCodeLine{01821       \textcolor{comment}{// multiply filter on alpha}}
\DoxyCodeLine{01822       BokehUtils::multiplyFilter(fftcpx\_alpha,       \textcolor{comment}{// dst}}
\DoxyCodeLine{01823                                  kissfft\_comp\_iris,  \textcolor{comment}{// filter}}
\DoxyCodeLine{01824                                  size);}
\DoxyCodeLine{01825 }
\DoxyCodeLine{01826       \textcolor{comment}{// inverse fft the alpha channel}}
\DoxyCodeLine{01827       \textcolor{comment}{// note that the result is multiplied by the image size}}
\DoxyCodeLine{01828       kiss\_fftnd(kissfft\_plan\_bkwd, fftcpx\_alpha, fftcpx\_alpha\_before);}
\DoxyCodeLine{01829 }
\DoxyCodeLine{01830       \textcolor{comment}{// over composite the alpha channel}}
\DoxyCodeLine{01831       BokehUtils::compositeAlpha(result\_buff\_mainSub,  \textcolor{comment}{// dst}}
\DoxyCodeLine{01832                                  fftcpx\_alpha\_before,  \textcolor{comment}{// alpha}}
\DoxyCodeLine{01833                                  dimOut.lx, dimOut.ly);}
\DoxyCodeLine{01834 }
\DoxyCodeLine{01835       \textcolor{comment}{// create worker threads}}
\DoxyCodeLine{01836       \mbox{\hyperlink{class_bokeh_utils_1_1_bokeh_ref_thread}{BokehUtils::BokehRefThread}} threadR(}
\DoxyCodeLine{01837           0, fftcpx\_r\_before, fftcpx\_r, fftcpx\_alpha\_before, kissfft\_comp\_iris,}
\DoxyCodeLine{01838           result\_buff\_mainSub, kissfft\_plan\_r\_fwd, kissfft\_plan\_r\_bkwd, dimOut);}
\DoxyCodeLine{01839       \mbox{\hyperlink{class_bokeh_utils_1_1_bokeh_ref_thread}{BokehUtils::BokehRefThread}} threadG(}
\DoxyCodeLine{01840           1, fftcpx\_g\_before, fftcpx\_g, fftcpx\_alpha\_before, kissfft\_comp\_iris,}
\DoxyCodeLine{01841           result\_buff\_mainSub, kissfft\_plan\_g\_fwd, kissfft\_plan\_g\_bkwd, dimOut);}
\DoxyCodeLine{01842       \mbox{\hyperlink{class_bokeh_utils_1_1_bokeh_ref_thread}{BokehUtils::BokehRefThread}} threadB(}
\DoxyCodeLine{01843           2, fftcpx\_b\_before, fftcpx\_b, fftcpx\_alpha\_before, kissfft\_comp\_iris,}
\DoxyCodeLine{01844           result\_buff\_mainSub, kissfft\_plan\_b\_fwd, kissfft\_plan\_b\_bkwd, dimOut);}
\DoxyCodeLine{01845 }
\DoxyCodeLine{01846       \textcolor{comment}{// If you set this flag to true, the fx will be forced to compute in}}
\DoxyCodeLine{01847       \textcolor{comment}{// single thread.}}
\DoxyCodeLine{01848       \textcolor{comment}{// Under some specific condition (such as calling from single-\/threaded}}
\DoxyCodeLine{01849       \textcolor{comment}{// tcomposer)}}
\DoxyCodeLine{01850       \textcolor{comment}{// we may need to use this flag... For now, I'll keep this option unused.}}
\DoxyCodeLine{01851       \textcolor{comment}{// TODO: investigate this.}}
\DoxyCodeLine{01852       \textcolor{keywordtype}{bool} renderInSingleThread = \textcolor{keyword}{false};}
\DoxyCodeLine{01853 }
\DoxyCodeLine{01854       \textcolor{keywordflow}{if} (renderInSingleThread) \{}
\DoxyCodeLine{01855         threadR.run();}
\DoxyCodeLine{01856         threadG.run();}
\DoxyCodeLine{01857         threadB.run();}
\DoxyCodeLine{01858       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{01859         threadR.start();}
\DoxyCodeLine{01860         threadG.start();}
\DoxyCodeLine{01861         threadB.start();}
\DoxyCodeLine{01862         \textcolor{keywordtype}{int} waitCount = 0;}
\DoxyCodeLine{01863         \textcolor{keywordflow}{while} (1) \{}
\DoxyCodeLine{01864           \textcolor{keywordflow}{if} ((settings.m\_isCanceled \&\& *settings.m\_isCanceled) ||}
\DoxyCodeLine{01865               waitCount >= 2000)  \textcolor{comment}{// 100 second timeout}}
\DoxyCodeLine{01866           \{}
\DoxyCodeLine{01867             \textcolor{keywordflow}{if} (!threadR.isFinished()) threadR.terminateThread();}
\DoxyCodeLine{01868             \textcolor{keywordflow}{if} (!threadG.isFinished()) threadG.terminateThread();}
\DoxyCodeLine{01869             \textcolor{keywordflow}{if} (!threadB.isFinished()) threadB.terminateThread();}
\DoxyCodeLine{01870             \textcolor{keywordflow}{while} (!threadR.isFinished() || !threadG.isFinished() ||}
\DoxyCodeLine{01871                    !threadB.isFinished()) \{}
\DoxyCodeLine{01872             \}}
\DoxyCodeLine{01873             releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01874             \textcolor{keywordflow}{return};}
\DoxyCodeLine{01875           \}}
\DoxyCodeLine{01876           \textcolor{keywordflow}{if} (threadR.isFinished() \&\& threadG.isFinished() \&\&}
\DoxyCodeLine{01877               threadB.isFinished())}
\DoxyCodeLine{01878             \textcolor{keywordflow}{break};}
\DoxyCodeLine{01879           QThread::msleep(50);}
\DoxyCodeLine{01880           waitCount++;}
\DoxyCodeLine{01881         \}}
\DoxyCodeLine{01882       \}}
\DoxyCodeLine{01883 }
\DoxyCodeLine{01884     \}  \textcolor{comment}{// for each segment}}
\DoxyCodeLine{01885   \}    \textcolor{comment}{// main and sub}}
\DoxyCodeLine{01886 }
\DoxyCodeLine{01887   \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01888   \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01889     releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01890     \textcolor{keywordflow}{return};}
\DoxyCodeLine{01891   \}}
\DoxyCodeLine{01892 }
\DoxyCodeLine{01893   BokehUtils::interpolateExposureAndConvertToRGB(}
\DoxyCodeLine{01894       result\_main\_buff,    \textcolor{comment}{// result1}}
\DoxyCodeLine{01895       result\_sub\_buff,     \textcolor{comment}{// result2}}
\DoxyCodeLine{01896       mainSub\_ratio\_buff,  \textcolor{comment}{// ratio}}
\DoxyCodeLine{01897       result,              \textcolor{comment}{// dst}}
\DoxyCodeLine{01898       size, layerHardness / masterHardness);}
\DoxyCodeLine{01899 }
\DoxyCodeLine{01900   \textcolor{comment}{// release rasters and plans}}
\DoxyCodeLine{01901   releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01902 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___bokeh_common_fx_abc1e1dcdb18ace6bfecda9b4b4168b92}\label{class_iwa___bokeh_common_fx_abc1e1dcdb18ace6bfecda9b4b4168b92}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!doCompute@{doCompute}}
\index{doCompute@{doCompute}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{doCompute()}{doCompute()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Bokeh\+Common\+Fx\+::do\+Compute (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} \&}]{tile,  }\item[{double}]{frame,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{settings }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [pure virtual]}}



Implements \mbox{\hyperlink{class_t_raster_fx}{TRaster\+Fx}}.

\mbox{\Hypertarget{class_iwa___bokeh_common_fx_a21f57fb2b8f0a83c943cc31129dbb635}\label{class_iwa___bokeh_common_fx_a21f57fb2b8f0a83c943cc31129dbb635}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!doFx@{doFx}}
\index{doFx@{doFx}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{doFx()}{doFx()}}
{\footnotesize\ttfamily void Iwa\+\_\+\+Bokeh\+Common\+Fx\+::do\+Fx (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{class_t_tile}{TTile}} \&}]{tile,  }\item[{double}]{frame,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{settings,  }\item[{double}]{bokeh\+Pixel\+Amount,  }\item[{int}]{margin,  }\item[{\mbox{\hyperlink{class_t_dimension_t}{TDimensionI}} \&}]{dim\+Out,  }\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{iris\+BBox,  }\item[{\mbox{\hyperlink{class_t_tile}{TTile}} \&}]{iris\+Tile,  }\item[{QList$<$ \mbox{\hyperlink{struct_iwa___bokeh_common_fx_1_1_layer_value}{Layer\+Value}} $>$ \&}]{layer\+Values,  }\item[{QMap$<$ int, unsigned char $\ast$ $>$ \&}]{ctrls }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{01351                                                                \{}
\DoxyCodeLine{01352   \textcolor{comment}{// This fx is relatively heavy so the multi thread computation is introduced.}}
\DoxyCodeLine{01353   \textcolor{comment}{// Lock the mutex here in order to prevent multiple rendering tasks run at the}}
\DoxyCodeLine{01354   \textcolor{comment}{// same time.}}
\DoxyCodeLine{01355   \textcolor{comment}{// QMutexLocker fx\_locker(\&fx\_mutex);}}
\DoxyCodeLine{01356 }
\DoxyCodeLine{01357   QList<TRasterGR8P> rasterList;}
\DoxyCodeLine{01358   QList<kiss\_fftnd\_cfg> planList;}
\DoxyCodeLine{01359 }
\DoxyCodeLine{01360   kiss\_fft\_cpx* kissfft\_comp\_iris;}
\DoxyCodeLine{01361   \textcolor{keywordtype}{double}* alpha\_bokeh = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01362   \mbox{\hyperlink{structdouble4}{double4}}* result     = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01363   rasterList.append(}
\DoxyCodeLine{01364       allocateRasterAndLock<kiss\_fft\_cpx>(\&kissfft\_comp\_iris, dimOut));}
\DoxyCodeLine{01365   rasterList.append(allocateRasterAndLock<double>(\&alpha\_bokeh, dimOut));}
\DoxyCodeLine{01366   rasterList.append(allocateRasterAndLock<double4>(\&result, dimOut));}
\DoxyCodeLine{01367 }
\DoxyCodeLine{01368   \mbox{\hyperlink{structdouble4}{double4}} zero = \{0.0, 0.0, 0.0, 0.0\};}
\DoxyCodeLine{01369   \textcolor{comment}{// initialize}}
\DoxyCodeLine{01370   std::fill\_n(result, dimOut.lx * dimOut.ly, zero);}
\DoxyCodeLine{01371 }
\DoxyCodeLine{01372   \textcolor{keywordtype}{double} masterHardness = m\_hardness-\/>getValue(frame);}
\DoxyCodeLine{01373 }
\DoxyCodeLine{01374   \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01375   \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01376     releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01377     \textcolor{keywordflow}{return};}
\DoxyCodeLine{01378   \}}
\DoxyCodeLine{01379 }
\DoxyCodeLine{01380   \textcolor{comment}{// compute layers from further to nearer}}
\DoxyCodeLine{01381   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < layerValues.size(); i++) \{}
\DoxyCodeLine{01382     \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01383     \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01384       releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01385       \textcolor{keywordflow}{return};}
\DoxyCodeLine{01386     \}}
\DoxyCodeLine{01387 }
\DoxyCodeLine{01388     LayerValue layer = layerValues.at(i);}
\DoxyCodeLine{01389 }
\DoxyCodeLine{01390     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{01391 }
\DoxyCodeLine{01392     \textcolor{comment}{// separate layer by the reference image}}
\DoxyCodeLine{01393     \textcolor{keywordtype}{int} ctrlIndex = layer.depth\_ref;}
\DoxyCodeLine{01394     \textcolor{keywordflow}{if} (ctrlIndex > 0 \&\& ctrls.contains(ctrlIndex) \&\& ctrls[ctrlIndex] != 0) \{}
\DoxyCodeLine{01395       \mbox{\hyperlink{class_t_tile}{TTile}}* layerTile = layer.sourceTile;}
\DoxyCodeLine{01396       \textcolor{keywordflow}{if} (!layer.premultiply) \mbox{\hyperlink{namespace_t_rop_add7d14f883c53c3d68ca0f256c42689f}{TRop::depremultiply}}(layerTile-\/>getRaster());}
\DoxyCodeLine{01397 }
\DoxyCodeLine{01398       doBokehRef(result, frame, settings, bokehPixelAmount, margin, dimOut,}
\DoxyCodeLine{01399                  irisBBox, irisTile, kissfft\_comp\_iris, layer,}
\DoxyCodeLine{01400                  ctrls[ctrlIndex]);}
\DoxyCodeLine{01401 }
\DoxyCodeLine{01402       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01403     \}}
\DoxyCodeLine{01404 }
\DoxyCodeLine{01405     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{01406 }
\DoxyCodeLine{01407     \textcolor{keywordtype}{double} layerHardness = layer.layerHardness;}
\DoxyCodeLine{01408     \textcolor{comment}{// The iris size of the current layer}}
\DoxyCodeLine{01409     \textcolor{keywordtype}{double} irisSize = layer.irisSize;}
\DoxyCodeLine{01410 }
\DoxyCodeLine{01411     \textcolor{comment}{// in case the layer is at the focus}}
\DoxyCodeLine{01412     \textcolor{keywordflow}{if} (-\/1.0 <= irisSize \&\& 1.0 >= irisSize) \{}
\DoxyCodeLine{01413       \mbox{\hyperlink{class_t_tile}{TTile}}* layerTile = layer.sourceTile;}
\DoxyCodeLine{01414       \textcolor{keywordflow}{if} (!layer.premultiply) \mbox{\hyperlink{namespace_t_rop_add7d14f883c53c3d68ca0f256c42689f}{TRop::depremultiply}}(layerTile-\/>getRaster());}
\DoxyCodeLine{01415       BokehUtils::compositLayerAsIs(*layerTile, result, dimOut, masterHardness);}
\DoxyCodeLine{01416       \textcolor{comment}{// Continue to the next layer}}
\DoxyCodeLine{01417       \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01418     \}}
\DoxyCodeLine{01419 }
\DoxyCodeLine{01420     \{}
\DoxyCodeLine{01421       \textcolor{comment}{// prepare for iris FFT}}
\DoxyCodeLine{01422       kiss\_fft\_cpx* kissfft\_comp\_iris\_before;}
\DoxyCodeLine{01423       rasterList.append(allocateRasterAndLock<kiss\_fft\_cpx>(}
\DoxyCodeLine{01424           \&kissfft\_comp\_iris\_before, dimOut));}
\DoxyCodeLine{01425       \textcolor{comment}{// Resize / flip the iris image according to the size ratio.}}
\DoxyCodeLine{01426       \textcolor{comment}{// Normalize the brightness of the iris image.}}
\DoxyCodeLine{01427       \textcolor{comment}{// Enlarge the iris to the output size.}}
\DoxyCodeLine{01428       BokehUtils::convertIris(irisSize, kissfft\_comp\_iris\_before, dimOut,}
\DoxyCodeLine{01429                               irisBBox, irisTile);}
\DoxyCodeLine{01430 }
\DoxyCodeLine{01431       \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01432       \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01433         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01434         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01435       \}}
\DoxyCodeLine{01436 }
\DoxyCodeLine{01437       \textcolor{comment}{// Create the FFT plan for the iris image.}}
\DoxyCodeLine{01438       kiss\_fftnd\_cfg iris\_kissfft\_plan;}
\DoxyCodeLine{01439       \textcolor{keywordflow}{while} (1) \{}
\DoxyCodeLine{01440         \textcolor{keywordtype}{int} dims[2]       = \{dimOut.ly, dimOut.lx\};}
\DoxyCodeLine{01441         \textcolor{keywordtype}{int} ndims         = 2;}
\DoxyCodeLine{01442         iris\_kissfft\_plan = kiss\_fftnd\_alloc(dims, ndims, \textcolor{keyword}{false}, 0, 0);}
\DoxyCodeLine{01443         \textcolor{keywordflow}{if} (iris\_kissfft\_plan != NULL) \textcolor{keywordflow}{break};}
\DoxyCodeLine{01444       \}}
\DoxyCodeLine{01445       \textcolor{comment}{// Do FFT the iris image.}}
\DoxyCodeLine{01446       kiss\_fftnd(iris\_kissfft\_plan, kissfft\_comp\_iris\_before,}
\DoxyCodeLine{01447                  kissfft\_comp\_iris);}
\DoxyCodeLine{01448       kiss\_fft\_free(iris\_kissfft\_plan);}
\DoxyCodeLine{01449       \textcolor{comment}{// release the iris buffer}}
\DoxyCodeLine{01450       rasterList.takeLast()-\/>unlock();}
\DoxyCodeLine{01451     \}}
\DoxyCodeLine{01452 }
\DoxyCodeLine{01453     \textcolor{comment}{// Up to here, FFT-\/ed iris data is stored in kissfft\_comp\_iris}}
\DoxyCodeLine{01454 }
\DoxyCodeLine{01455     \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01456     \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01457       releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01458       \textcolor{keywordflow}{return};}
\DoxyCodeLine{01459     \}}
\DoxyCodeLine{01460 }
\DoxyCodeLine{01461     \textcolor{comment}{//-\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/}}
\DoxyCodeLine{01462     \textcolor{comment}{// Prepare the layer rasters}}
\DoxyCodeLine{01463     \mbox{\hyperlink{class_t_tile}{TTile}}* layerTile = layer.sourceTile;}
\DoxyCodeLine{01464 }
\DoxyCodeLine{01465     \textcolor{keywordflow}{if} (!layer.premultiply) \mbox{\hyperlink{namespace_t_rop_add7d14f883c53c3d68ca0f256c42689f}{TRop::depremultiply}}(layerTile-\/>getRaster());}
\DoxyCodeLine{01466 }
\DoxyCodeLine{01467     \textcolor{comment}{//-\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/ -\/}}
\DoxyCodeLine{01468     \textcolor{comment}{// Do FFT the alpha channel.}}
\DoxyCodeLine{01469     \textcolor{comment}{// Forward FFT -\/> Multiply by the iris data -\/> Backward FFT}}
\DoxyCodeLine{01470     BokehUtils::calcAlfaChannelBokeh(kissfft\_comp\_iris, *layerTile,}
\DoxyCodeLine{01471                                      alpha\_bokeh);}
\DoxyCodeLine{01472 }
\DoxyCodeLine{01473     \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01474     \textcolor{keywordflow}{if} (settings.m\_isCanceled \&\& *settings.m\_isCanceled) \{}
\DoxyCodeLine{01475       releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01476       \textcolor{keywordflow}{return};}
\DoxyCodeLine{01477     \}}
\DoxyCodeLine{01478 }
\DoxyCodeLine{01479     \mbox{\hyperlink{class_bokeh_utils_1_1_my_thread}{BokehUtils::MyThread}} threadR(}
\DoxyCodeLine{01480         BokehUtils::MyThread::Red, layerTile-\/>getRaster(), result, alpha\_bokeh,}
\DoxyCodeLine{01481         kissfft\_comp\_iris, layerHardness, masterHardness);}
\DoxyCodeLine{01482     \mbox{\hyperlink{class_bokeh_utils_1_1_my_thread}{BokehUtils::MyThread}} threadG(}
\DoxyCodeLine{01483         BokehUtils::MyThread::Green, layerTile-\/>getRaster(), result,}
\DoxyCodeLine{01484         alpha\_bokeh, kissfft\_comp\_iris, layerHardness, masterHardness);}
\DoxyCodeLine{01485     \mbox{\hyperlink{class_bokeh_utils_1_1_my_thread}{BokehUtils::MyThread}} threadB(}
\DoxyCodeLine{01486         BokehUtils::MyThread::Blue, layerTile-\/>getRaster(), result, alpha\_bokeh,}
\DoxyCodeLine{01487         kissfft\_comp\_iris, layerHardness, masterHardness);}
\DoxyCodeLine{01488 }
\DoxyCodeLine{01489     \textcolor{comment}{// If you set this flag to true, the fx will be forced to compute in single}}
\DoxyCodeLine{01490     \textcolor{comment}{// thread.}}
\DoxyCodeLine{01491     \textcolor{comment}{// Under some specific condition (such as calling from single-\/threaded}}
\DoxyCodeLine{01492     \textcolor{comment}{// tcomposer)}}
\DoxyCodeLine{01493     \textcolor{comment}{// we may need to use this flag... For now, I'll keep this option unused.}}
\DoxyCodeLine{01494     \textcolor{comment}{// TODO: investigate this.}}
\DoxyCodeLine{01495     \textcolor{keywordtype}{bool} renderInSingleThread = \textcolor{keyword}{false};}
\DoxyCodeLine{01496 }
\DoxyCodeLine{01497     \textcolor{comment}{// Start the thread when the initialization is done.}}
\DoxyCodeLine{01498     \textcolor{comment}{// Red channel}}
\DoxyCodeLine{01499     \textcolor{keywordtype}{int} waitCount = 0;}
\DoxyCodeLine{01500     \textcolor{keywordflow}{while} (1) \{}
\DoxyCodeLine{01501       \textcolor{comment}{// cancel check}}
\DoxyCodeLine{01502       \textcolor{keywordflow}{if} ((settings.m\_isCanceled \&\& *settings.m\_isCanceled) ||}
\DoxyCodeLine{01503           waitCount >= 20) \{}
\DoxyCodeLine{01504         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01505         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01506       \}}
\DoxyCodeLine{01507       \textcolor{keywordflow}{if} (threadR.init()) \{}
\DoxyCodeLine{01508         \textcolor{keywordflow}{if} (renderInSingleThread)}
\DoxyCodeLine{01509           threadR.run();}
\DoxyCodeLine{01510         \textcolor{keywordflow}{else}}
\DoxyCodeLine{01511           threadR.start();}
\DoxyCodeLine{01512         \textcolor{keywordflow}{break};}
\DoxyCodeLine{01513       \}}
\DoxyCodeLine{01514       QThread::msleep(500);}
\DoxyCodeLine{01515       waitCount++;}
\DoxyCodeLine{01516     \}}
\DoxyCodeLine{01517 }
\DoxyCodeLine{01518     waitCount = 0;}
\DoxyCodeLine{01519     \textcolor{keywordflow}{while} (1) \{}
\DoxyCodeLine{01520       \textcolor{keywordflow}{if} ((settings.m\_isCanceled \&\& *settings.m\_isCanceled) ||}
\DoxyCodeLine{01521           waitCount >= 20)  \textcolor{comment}{// 10 seconds}}
\DoxyCodeLine{01522       \{}
\DoxyCodeLine{01523         \textcolor{keywordflow}{if} (!threadR.isFinished()) threadR.terminateThread();}
\DoxyCodeLine{01524         \textcolor{keywordflow}{while} (!threadR.isFinished()) \{}
\DoxyCodeLine{01525         \}}
\DoxyCodeLine{01526         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01527         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01528       \}}
\DoxyCodeLine{01529       \textcolor{keywordflow}{if} (threadG.init()) \{}
\DoxyCodeLine{01530         \textcolor{keywordflow}{if} (renderInSingleThread)}
\DoxyCodeLine{01531           threadG.run();}
\DoxyCodeLine{01532         \textcolor{keywordflow}{else}}
\DoxyCodeLine{01533           threadG.start();}
\DoxyCodeLine{01534         \textcolor{keywordflow}{break};}
\DoxyCodeLine{01535       \}}
\DoxyCodeLine{01536       QThread::msleep(500);}
\DoxyCodeLine{01537       waitCount++;}
\DoxyCodeLine{01538     \}}
\DoxyCodeLine{01539 }
\DoxyCodeLine{01540     waitCount = 0;}
\DoxyCodeLine{01541     \textcolor{keywordflow}{while} (1) \{}
\DoxyCodeLine{01542       \textcolor{keywordflow}{if} ((settings.m\_isCanceled \&\& *settings.m\_isCanceled) ||}
\DoxyCodeLine{01543           waitCount >= 20)  \textcolor{comment}{// 10 seconds}}
\DoxyCodeLine{01544       \{}
\DoxyCodeLine{01545         \textcolor{keywordflow}{if} (!threadR.isFinished()) threadR.terminateThread();}
\DoxyCodeLine{01546         \textcolor{keywordflow}{if} (!threadG.isFinished()) threadG.terminateThread();}
\DoxyCodeLine{01547         \textcolor{keywordflow}{while} (!threadR.isFinished() || !threadG.isFinished()) \{}
\DoxyCodeLine{01548         \}}
\DoxyCodeLine{01549         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01550         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01551       \}}
\DoxyCodeLine{01552       \textcolor{keywordflow}{if} (threadB.init()) \{}
\DoxyCodeLine{01553         \textcolor{keywordflow}{if} (renderInSingleThread)}
\DoxyCodeLine{01554           threadB.run();}
\DoxyCodeLine{01555         \textcolor{keywordflow}{else}}
\DoxyCodeLine{01556           threadB.start();}
\DoxyCodeLine{01557         \textcolor{keywordflow}{break};}
\DoxyCodeLine{01558       \}}
\DoxyCodeLine{01559       QThread::msleep(500);}
\DoxyCodeLine{01560       waitCount++;}
\DoxyCodeLine{01561     \}}
\DoxyCodeLine{01562 }
\DoxyCodeLine{01563     \textcolor{comment}{/*}}
\DoxyCodeLine{01564 \textcolor{comment}{     * What is done in the thread for each RGB channel:}}
\DoxyCodeLine{01565 \textcolor{comment}{     * -\/ Convert channel value -\/> Exposure}}
\DoxyCodeLine{01566 \textcolor{comment}{     * -\/ Multiply by alpha channel}}
\DoxyCodeLine{01567 \textcolor{comment}{     * -\/ Forward FFT}}
\DoxyCodeLine{01568 \textcolor{comment}{     * -\/ Multiply by the iris FFT data}}
\DoxyCodeLine{01569 \textcolor{comment}{     * -\/ Backward FFT}}
\DoxyCodeLine{01570 \textcolor{comment}{     * -\/ Convert Exposure -\/> channel value}}
\DoxyCodeLine{01571 \textcolor{comment}{     */}}
\DoxyCodeLine{01572 }
\DoxyCodeLine{01573     waitCount = 0;}
\DoxyCodeLine{01574     \textcolor{keywordflow}{while} (1) \{}
\DoxyCodeLine{01575       \textcolor{keywordflow}{if} ((settings.m\_isCanceled \&\& *settings.m\_isCanceled) ||}
\DoxyCodeLine{01576           waitCount >= 2000)  \textcolor{comment}{// 100 second timeout}}
\DoxyCodeLine{01577       \{}
\DoxyCodeLine{01578         \textcolor{keywordflow}{if} (!threadR.isFinished()) threadR.terminateThread();}
\DoxyCodeLine{01579         \textcolor{keywordflow}{if} (!threadG.isFinished()) threadG.terminateThread();}
\DoxyCodeLine{01580         \textcolor{keywordflow}{if} (!threadB.isFinished()) threadB.terminateThread();}
\DoxyCodeLine{01581         \textcolor{keywordflow}{while} (!threadR.isFinished() || !threadG.isFinished() ||}
\DoxyCodeLine{01582                !threadB.isFinished()) \{}
\DoxyCodeLine{01583         \}}
\DoxyCodeLine{01584         releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01585         \textcolor{keywordflow}{return};}
\DoxyCodeLine{01586       \}}
\DoxyCodeLine{01587       \textcolor{keywordflow}{if} (threadR.isFinished() \&\& threadG.isFinished() \&\& threadB.isFinished())}
\DoxyCodeLine{01588         \textcolor{keywordflow}{break};}
\DoxyCodeLine{01589       QThread::msleep(50);}
\DoxyCodeLine{01590       waitCount++;}
\DoxyCodeLine{01591     \}}
\DoxyCodeLine{01592   \}}
\DoxyCodeLine{01593 }
\DoxyCodeLine{01594   \textcolor{comment}{// convert result image value exposure -\/> rgb}}
\DoxyCodeLine{01595   BokehUtils::convertExposureToRGB(result, dimOut.lx * dimOut.ly,}
\DoxyCodeLine{01596                                    masterHardness);}
\DoxyCodeLine{01597 }
\DoxyCodeLine{01598   \textcolor{comment}{// clear result raster}}
\DoxyCodeLine{01599   tile.getRaster()-\/>clear();}
\DoxyCodeLine{01600   \mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}} outRas32 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster32P}})tile.getRaster();}
\DoxyCodeLine{01601   \mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}} outRas64 = (\mbox{\hyperlink{class_t_raster_p_t}{TRaster64P}})tile.getRaster();}
\DoxyCodeLine{01602 }
\DoxyCodeLine{01603   \mbox{\hyperlink{structint2}{int2}} outMargin = \{(dimOut.lx -\/ tile.getRaster()-\/>getSize().lx) / 2,}
\DoxyCodeLine{01604                     (dimOut.ly -\/ tile.getRaster()-\/>getSize().ly) / 2\};}
\DoxyCodeLine{01605 }
\DoxyCodeLine{01606   lock.lockForWrite();}
\DoxyCodeLine{01607   \textcolor{keywordflow}{if} (outRas32)}
\DoxyCodeLine{01608     BokehUtils::setOutputRaster<TRaster32P, TPixel32>(result, outRas32, dimOut,}
\DoxyCodeLine{01609                                                       outMargin);}
\DoxyCodeLine{01610   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (outRas64)}
\DoxyCodeLine{01611     BokehUtils::setOutputRaster<TRaster64P, TPixel64>(result, outRas64, dimOut,}
\DoxyCodeLine{01612                                                       outMargin);}
\DoxyCodeLine{01613   lock.unlock();}
\DoxyCodeLine{01614 }
\DoxyCodeLine{01615   releaseAllRastersAndPlans(rasterList, planList);}
\DoxyCodeLine{01616 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_iwa___bokeh_common_fx_a57198dc4c03e60e585d5682f94b4d40a}\label{class_iwa___bokeh_common_fx_a57198dc4c03e60e585d5682f94b4d40a}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!doGetBBox@{doGetBBox}}
\index{doGetBBox@{doGetBBox}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{doGetBBox()}{doGetBBox()}}
{\footnotesize\ttfamily bool Iwa\+\_\+\+Bokeh\+Common\+Fx\+::do\+Get\+BBox (\begin{DoxyParamCaption}\item[{double}]{frame,  }\item[{\mbox{\hyperlink{class_t_rect_t}{TRectD}} \&}]{b\+Box,  }\item[{const \mbox{\hyperlink{class_t_render_settings}{TRender\+Settings}} \&}]{info }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [final]}, {\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_raster_fx}{TRaster\+Fx}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{01335                                                                \{}
\DoxyCodeLine{01336   bBox = TConsts::infiniteRectD;}
\DoxyCodeLine{01337   \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{01338 \}}

\end{DoxyCode}


\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{class_iwa___bokeh_common_fx_aa1b07afe15ac4c4173c2cb24b2f1ab05}\label{class_iwa___bokeh_common_fx_aa1b07afe15ac4c4173c2cb24b2f1ab05}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!m\_bokehAmount@{m\_bokehAmount}}
\index{m\_bokehAmount@{m\_bokehAmount}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{m\_bokehAmount}{m\_bokehAmount}}
{\footnotesize\ttfamily TDouble\+ParamP Iwa\+\_\+\+Bokeh\+Common\+Fx\+::m\+\_\+bokeh\+Amount\hspace{0.3cm}{\ttfamily [protected]}}

\mbox{\Hypertarget{class_iwa___bokeh_common_fx_a0b7fa92ab5c29db26dfffd17dffdf28a}\label{class_iwa___bokeh_common_fx_a0b7fa92ab5c29db26dfffd17dffdf28a}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!m\_hardness@{m\_hardness}}
\index{m\_hardness@{m\_hardness}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{m\_hardness}{m\_hardness}}
{\footnotesize\ttfamily TDouble\+ParamP Iwa\+\_\+\+Bokeh\+Common\+Fx\+::m\+\_\+hardness\hspace{0.3cm}{\ttfamily [protected]}}

\mbox{\Hypertarget{class_iwa___bokeh_common_fx_a6f2a097b8da4cd2ea796c89237cd0128}\label{class_iwa___bokeh_common_fx_a6f2a097b8da4cd2ea796c89237cd0128}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!m\_iris@{m\_iris}}
\index{m\_iris@{m\_iris}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{m\_iris}{m\_iris}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_raster_fx_port}{TRaster\+Fx\+Port}} Iwa\+\_\+\+Bokeh\+Common\+Fx\+::m\+\_\+iris\hspace{0.3cm}{\ttfamily [protected]}}

\mbox{\Hypertarget{class_iwa___bokeh_common_fx_aab8a2f7bfbe8848a25f892640831d635}\label{class_iwa___bokeh_common_fx_aab8a2f7bfbe8848a25f892640831d635}} 
\index{Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}!m\_onFocusDistance@{m\_onFocusDistance}}
\index{m\_onFocusDistance@{m\_onFocusDistance}!Iwa\_BokehCommonFx@{Iwa\_BokehCommonFx}}
\doxysubsubsection{\texorpdfstring{m\_onFocusDistance}{m\_onFocusDistance}}
{\footnotesize\ttfamily TDouble\+ParamP Iwa\+\_\+\+Bokeh\+Common\+Fx\+::m\+\_\+on\+Focus\+Distance\hspace{0.3cm}{\ttfamily [protected]}}



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+bokeh\+\_\+util.\+h\item 
E\+:/opentoonz/toonz/sources/stdfx/iwa\+\_\+bokeh\+\_\+util.\+cpp\end{DoxyCompactItemize}
