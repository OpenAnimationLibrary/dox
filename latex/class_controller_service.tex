\hypertarget{class_controller_service}{}\doxysection{Controller\+Service Class Reference}
\label{class_controller_service}\index{ControllerService@{ControllerService}}
Inheritance diagram for Controller\+Service\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=2.000000cm]{class_controller_service}
\end{center}
\end{figure}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{class_controller_service_a3939fbbb27a06ae49aa5ff46986466a2}{on\+Start}} (int argc, char $\ast$argv\mbox{[}$\,$\mbox{]}) override
\item 
void \mbox{\hyperlink{class_controller_service_a523f2c0d32f269714802d035bb08ada2}{on\+Stop}} () override
\end{DoxyCompactItemize}
\doxysubsection*{Static Public Member Functions}
\begin{DoxyCompactItemize}
\item 
static \mbox{\hyperlink{class_t_file_path}{TFile\+Path}} \mbox{\hyperlink{class_controller_service_a197a97a968e4f71f076928318f04a7e4}{get\+Tasks\+Data\+File}} ()
\end{DoxyCompactItemize}
\doxysubsection*{Public Attributes}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{class_farm_controller}{Farm\+Controller}} $\ast$ \mbox{\hyperlink{class_controller_service_ab6cc5e22f8e03b9852804897989cc365}{m\+\_\+controller}}
\item 
\mbox{\hyperlink{class_t_user_log}{TUser\+Log}} $\ast$ \mbox{\hyperlink{class_controller_service_a5fd721767f010706502765cc47e8a451}{m\+\_\+user\+Log}}
\end{DoxyCompactItemize}
\doxysubsection*{Additional Inherited Members}


\doxysubsection{Detailed Description}


\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{class_controller_service_a0834f9e3a76a93056ced52e0177ed37a}\label{class_controller_service_a0834f9e3a76a93056ced52e0177ed37a}} 
\index{ControllerService@{ControllerService}!ControllerService@{ControllerService}}
\index{ControllerService@{ControllerService}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{ControllerService()}{ControllerService()}}
{\footnotesize\ttfamily Controller\+Service\+::\+Controller\+Service (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{02210       : \mbox{\hyperlink{class_t_service}{TService}}(\textcolor{stringliteral}{"{}ToonzFarmController"{}}, \textcolor{stringliteral}{"{}ToonzFarm Controller"{}})}
\DoxyCodeLine{02211       , m\_controller(0) \{\}}

\end{DoxyCode}
\mbox{\Hypertarget{class_controller_service_a35cf4f93c8556ece2d1176e3ec34a5c3}\label{class_controller_service_a35cf4f93c8556ece2d1176e3ec34a5c3}} 
\index{ControllerService@{ControllerService}!````~ControllerService@{$\sim$ControllerService}}
\index{````~ControllerService@{$\sim$ControllerService}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{$\sim$ControllerService()}{~ControllerService()}}
{\footnotesize\ttfamily Controller\+Service\+::$\sim$\+Controller\+Service (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{02213 \{ \textcolor{keyword}{delete} m\_controller; \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{class_controller_service_a197a97a968e4f71f076928318f04a7e4}\label{class_controller_service_a197a97a968e4f71f076928318f04a7e4}} 
\index{ControllerService@{ControllerService}!getTasksDataFile@{getTasksDataFile}}
\index{getTasksDataFile@{getTasksDataFile}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{getTasksDataFile()}{getTasksDataFile()}}
{\footnotesize\ttfamily static \mbox{\hyperlink{class_t_file_path}{TFile\+Path}} Controller\+Service\+::get\+Tasks\+Data\+File (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}


\begin{DoxyCode}{0}
\DoxyCodeLine{02218                                       \{}
\DoxyCodeLine{02219     \mbox{\hyperlink{class_t_file_path}{TFilePath}} fp = getGlobalRoot() + \textcolor{stringliteral}{"{}data"{}} + \textcolor{stringliteral}{"{}tasks.txt"{}};}
\DoxyCodeLine{02220     \textcolor{keywordflow}{return} fp;}
\DoxyCodeLine{02221   \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_controller_service_a3939fbbb27a06ae49aa5ff46986466a2}\label{class_controller_service_a3939fbbb27a06ae49aa5ff46986466a2}} 
\index{ControllerService@{ControllerService}!onStart@{onStart}}
\index{onStart@{onStart}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{onStart()}{onStart()}}
{\footnotesize\ttfamily void Controller\+Service\+::on\+Start (\begin{DoxyParamCaption}\item[{int}]{argc,  }\item[{char $\ast$}]{argv\mbox{[}$\,$\mbox{]} }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_service}{TService}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{02229                                                       \{}
\DoxyCodeLine{02230   \textcolor{comment}{// Initialize thread components}}
\DoxyCodeLine{02231   TThread::init();}
\DoxyCodeLine{02232   \mbox{\hyperlink{class_t_v_e_r_1_1_toonz_version}{TVER::ToonzVersion}} tver;}
\DoxyCodeLine{02233 }
\DoxyCodeLine{02234   \textcolor{keywordflow}{if} (isRunningAsConsoleApp()) \{}
\DoxyCodeLine{02235     \textcolor{comment}{// i messaggi verranno ridiretti sullo standard output}}
\DoxyCodeLine{02236     m\_userLog = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_user_log}{TUserLog}}();}
\DoxyCodeLine{02237   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{02238     \mbox{\hyperlink{class_t_file_path}{TFilePath}} lRootDir  = getLocalRoot();}
\DoxyCodeLine{02239     \textcolor{keywordtype}{bool} lRootDirExists = dirExists(lRootDir);}
\DoxyCodeLine{02240     \textcolor{keywordflow}{if} (!lRootDirExists) \{}
\DoxyCodeLine{02241       QString errMsg(\textcolor{stringliteral}{"{}Unable to start the Controller"{}});}
\DoxyCodeLine{02242       errMsg += \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02243       errMsg += \textcolor{stringliteral}{"{}The directory "{}} + lRootDir.getQString() +}
\DoxyCodeLine{02244                 \textcolor{stringliteral}{"{} specified as Local Root does not exist"{}};}
\DoxyCodeLine{02245       errMsg += \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02246 }
\DoxyCodeLine{02247       addToMessageLog(errMsg);}
\DoxyCodeLine{02248 }
\DoxyCodeLine{02249       \textcolor{comment}{// exit the program}}
\DoxyCodeLine{02250       setStatus(TService::Stopped, NO\_ERROR, 0);}
\DoxyCodeLine{02251     \}}
\DoxyCodeLine{02252 }
\DoxyCodeLine{02253     \mbox{\hyperlink{class_t_file_path}{TFilePath}} logFilePath = lRootDir + \textcolor{stringliteral}{"{}controller.log"{}};}
\DoxyCodeLine{02254     m\_userLog             = \textcolor{keyword}{new} \mbox{\hyperlink{class_t_user_log}{TUserLog}}(logFilePath);}
\DoxyCodeLine{02255   \}}
\DoxyCodeLine{02256   std::string appverinfo = tver.getAppVersionInfo(\textcolor{stringliteral}{"{}Farm Controller"{}}) + \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)n"{}};}
\DoxyCodeLine{02257   m\_userLog-\/>info(appverinfo.c\_str());}
\DoxyCodeLine{02258 }
\DoxyCodeLine{02259   \mbox{\hyperlink{class_t_file_path}{TFilePath}} globalRoot = getGlobalRoot();}
\DoxyCodeLine{02260   \textcolor{keywordflow}{if} (globalRoot.isEmpty()) \{}
\DoxyCodeLine{02261     QString errMsg(\textcolor{stringliteral}{"{}Unable to get FARMROOT environment variable ("{}} +}
\DoxyCodeLine{02262                    globalRoot.getQString() + \textcolor{stringliteral}{"{})\(\backslash\)n"{}});}
\DoxyCodeLine{02263     addToMessageLog(errMsg);}
\DoxyCodeLine{02264 }
\DoxyCodeLine{02265     \textcolor{comment}{// exit the program}}
\DoxyCodeLine{02266     setStatus(TService::Stopped, NO\_ERROR, 0);}
\DoxyCodeLine{02267   \}}
\DoxyCodeLine{02268 }
\DoxyCodeLine{02269   \textcolor{keywordtype}{bool} globalRootExists = \textcolor{keyword}{true};}
\DoxyCodeLine{02270 }
\DoxyCodeLine{02271   \mbox{\hyperlink{class_t_file_status}{TFileStatus}} fs(globalRoot);}
\DoxyCodeLine{02272   \textcolor{keywordflow}{if} (!fs.isDirectory()) globalRootExists = \textcolor{keyword}{false};}
\DoxyCodeLine{02273 }
\DoxyCodeLine{02274   \textcolor{keywordflow}{if} (!globalRootExists) \{}
\DoxyCodeLine{02275     QString errMsg(\textcolor{stringliteral}{"{}The directory "{}} + globalRoot.getQString() +}
\DoxyCodeLine{02276                    \textcolor{stringliteral}{"{} specified as TFARMGLOBALROOT does not exist\(\backslash\)n"{}});}
\DoxyCodeLine{02277     addToMessageLog(errMsg);}
\DoxyCodeLine{02278 }
\DoxyCodeLine{02279     \textcolor{comment}{// exit the program}}
\DoxyCodeLine{02280     setStatus(TService::Stopped, NO\_ERROR, 0);}
\DoxyCodeLine{02281   \}}
\DoxyCodeLine{02282 }
\DoxyCodeLine{02283   \textcolor{keywordtype}{int} port = 8000;}
\DoxyCodeLine{02284   QString hostName, addr;}
\DoxyCodeLine{02285   \textcolor{keywordtype}{bool} ret = loadControllerData(hostName, addr, port);}
\DoxyCodeLine{02286   \textcolor{keywordflow}{if} (!ret) \{}
\DoxyCodeLine{02287     QString msg(\textcolor{stringliteral}{"{}Unable to get the port number of "{}});}
\DoxyCodeLine{02288     msg += TSystem::getHostName();}
\DoxyCodeLine{02289     msg += \textcolor{stringliteral}{"{} from the Controller config file"{}};}
\DoxyCodeLine{02290     msg += \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02291     msg += \textcolor{stringliteral}{"{}Using the default port number "{}};}
\DoxyCodeLine{02292     msg += QString::number(port);}
\DoxyCodeLine{02293     msg += \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02294     m\_userLog-\/>info(msg);}
\DoxyCodeLine{02295   \}}
\DoxyCodeLine{02296 }
\DoxyCodeLine{02297 \textcolor{preprocessor}{\#ifdef \_\_sgi}}
\DoxyCodeLine{02298   \{}
\DoxyCodeLine{02299     std::ofstream os(\textcolor{stringliteral}{"{}/tmp/.tfarmcontroller.dat"{}});}
\DoxyCodeLine{02300     os << port;}
\DoxyCodeLine{02301   \}}
\DoxyCodeLine{02302 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02303 }
\DoxyCodeLine{02304   m\_controller = \textcolor{keyword}{new} \mbox{\hyperlink{class_farm_controller}{FarmController}}(hostName, addr, port, m\_userLog);}
\DoxyCodeLine{02305 }
\DoxyCodeLine{02306   \textcolor{comment}{// configurazione e inizializzazione dei server lato client}}
\DoxyCodeLine{02307   \textcolor{comment}{// (il controller e' un client dei ToonzFarm server)}}
\DoxyCodeLine{02308   m\_controller-\/>loadServersData(globalRoot);}
\DoxyCodeLine{02309 }
\DoxyCodeLine{02310   \mbox{\hyperlink{class_t_file_path}{TFilePath}} fp = getTasksDataFile();}
\DoxyCodeLine{02311   \textcolor{keywordflow}{if} (myDoesExists(fp)) m\_controller-\/>load(fp);}
\DoxyCodeLine{02312 }
\DoxyCodeLine{02313   \textcolor{comment}{// si avvia uno dei task caricati da disco}}
\DoxyCodeLine{02314   \mbox{\hyperlink{class_ctrl_farm_task}{CtrlFarmTask}} *task = m\_controller-\/>getTaskToStart();}
\DoxyCodeLine{02315   \textcolor{keywordflow}{if} (task) \{}
\DoxyCodeLine{02316     \mbox{\hyperlink{class_t_thread_1_1_executor}{TThread::Executor}} executor;}
\DoxyCodeLine{02317     executor.\mbox{\hyperlink{class_t_thread_1_1_executor_af31c8db8ac72df4c342e7769e95e2135}{addTask}}(\textcolor{keyword}{new} \mbox{\hyperlink{class_task_starter}{TaskStarter}}(m\_controller, task));}
\DoxyCodeLine{02318   \}}
\DoxyCodeLine{02319 }
\DoxyCodeLine{02320   QString msg(\textcolor{stringliteral}{"{}Starting Controller on port "{}});}
\DoxyCodeLine{02321   msg += QString::number(m\_controller-\/>m\_port);}
\DoxyCodeLine{02322   msg += \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)n"{}};}
\DoxyCodeLine{02323   m\_userLog-\/>info(msg);}
\DoxyCodeLine{02324 }
\DoxyCodeLine{02325   \textcolor{comment}{// std::cout << msg;}}
\DoxyCodeLine{02326 }
\DoxyCodeLine{02327   QEventLoop eventLoop;}
\DoxyCodeLine{02328 }
\DoxyCodeLine{02329   \textcolor{comment}{// Connect the server's listening finished signal to main loop quit.}}
\DoxyCodeLine{02330   QObject::connect(m\_controller, SIGNAL(finished()), \&eventLoop, SLOT(quit()));}
\DoxyCodeLine{02331 }
\DoxyCodeLine{02332   \textcolor{comment}{// Start the TcpIp server's listening thread}}
\DoxyCodeLine{02333   m\_controller-\/>start();}
\DoxyCodeLine{02334 }
\DoxyCodeLine{02335   \textcolor{comment}{// Enter main event loop}}
\DoxyCodeLine{02336   eventLoop.exec();}
\DoxyCodeLine{02337 }
\DoxyCodeLine{02338   \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/Farm controller loops here-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{02339 }
\DoxyCodeLine{02340   msg = \textcolor{stringliteral}{"{}Controller exited with exit code "{}};}
\DoxyCodeLine{02341   msg += QString::number(m\_controller-\/>getExitCode());}
\DoxyCodeLine{02342   msg += \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02343   m\_userLog-\/>info(msg);}
\DoxyCodeLine{02344 }
\DoxyCodeLine{02345 \textcolor{comment}{// std::cout << msg;}}
\DoxyCodeLine{02346 }
\DoxyCodeLine{02347 \textcolor{preprocessor}{\#ifdef \_\_sgi}}
\DoxyCodeLine{02348   \{ remove(\textcolor{stringliteral}{"{}/tmp/.tfarmcontroller.dat"{}}); \}}
\DoxyCodeLine{02349 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02350 \}}

\end{DoxyCode}
\mbox{\Hypertarget{class_controller_service_a523f2c0d32f269714802d035bb08ada2}\label{class_controller_service_a523f2c0d32f269714802d035bb08ada2}} 
\index{ControllerService@{ControllerService}!onStop@{onStop}}
\index{onStop@{onStop}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{onStop()}{onStop()}}
{\footnotesize\ttfamily void Controller\+Service\+::on\+Stop (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [override]}, {\ttfamily [virtual]}}



Implements \mbox{\hyperlink{class_t_service}{TService}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{02354                                \{}
\DoxyCodeLine{02355   \textcolor{comment}{// TFilePath fp = getTasksDataFile();}}
\DoxyCodeLine{02356   \textcolor{comment}{// m\_controller-\/>save(fp);}}
\DoxyCodeLine{02357 }
\DoxyCodeLine{02358   \mbox{\hyperlink{class_t_file_path}{TFilePath}} rootDir            = getGlobalRoot();}
\DoxyCodeLine{02359   \mbox{\hyperlink{class_t_file_path}{TFilePath}} lastUsedIdFilePath = rootDir + \textcolor{stringliteral}{"{}config"{}} + \textcolor{stringliteral}{"{}id.txt"{}};}
\DoxyCodeLine{02360   \mbox{\hyperlink{class_tofstream}{Tofstream}} os(lastUsedIdFilePath);}
\DoxyCodeLine{02361   \textcolor{keywordflow}{if} (os.good()) os << FarmController::NextTaskId;}
\DoxyCodeLine{02362 }
\DoxyCodeLine{02363   \mbox{\hyperlink{class_t_tcp_ip_client}{TTcpIpClient}} client;}
\DoxyCodeLine{02364 }
\DoxyCodeLine{02365   \textcolor{keywordtype}{int} socketId;}
\DoxyCodeLine{02366   \textcolor{keywordtype}{int} ret = client.connect(TSystem::getHostName(), \textcolor{stringliteral}{"{}"{}}, m\_controller-\/>getPort(),}
\DoxyCodeLine{02367                            socketId);}
\DoxyCodeLine{02368   \textcolor{keywordflow}{if} (ret == OK) \{}
\DoxyCodeLine{02369     client.send(socketId, \textcolor{stringliteral}{"{}shutdown"{}});}
\DoxyCodeLine{02370   \}}
\DoxyCodeLine{02371 \}}

\end{DoxyCode}


\doxysubsection{Member Data Documentation}
\mbox{\Hypertarget{class_controller_service_ab6cc5e22f8e03b9852804897989cc365}\label{class_controller_service_ab6cc5e22f8e03b9852804897989cc365}} 
\index{ControllerService@{ControllerService}!m\_controller@{m\_controller}}
\index{m\_controller@{m\_controller}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{m\_controller}{m\_controller}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_farm_controller}{Farm\+Controller}}$\ast$ Controller\+Service\+::m\+\_\+controller}

\mbox{\Hypertarget{class_controller_service_a5fd721767f010706502765cc47e8a451}\label{class_controller_service_a5fd721767f010706502765cc47e8a451}} 
\index{ControllerService@{ControllerService}!m\_userLog@{m\_userLog}}
\index{m\_userLog@{m\_userLog}!ControllerService@{ControllerService}}
\doxysubsubsection{\texorpdfstring{m\_userLog}{m\_userLog}}
{\footnotesize\ttfamily \mbox{\hyperlink{class_t_user_log}{TUser\+Log}}$\ast$ Controller\+Service\+::m\+\_\+user\+Log}



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
E\+:/opentoonz/toonz/sources/toonzfarm/tfarmcontroller/tfarmcontroller.\+cpp\end{DoxyCompactItemize}
